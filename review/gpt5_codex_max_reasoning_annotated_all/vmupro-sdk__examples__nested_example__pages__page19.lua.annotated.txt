00001 [GPT-5-CODEX-MAX-REASONING] -- pages/page19.lua
00002 [GPT-5-CODEX-MAX-REASONING] -- Test Page 19: Mosaic Effect (Teleportation)
00003 [GPT-5-CODEX-MAX-REASONING] 
00004 [GPT-5-CODEX-MAX-REASONING] Page19 = {}
00005 [GPT-5-CODEX-MAX-REASONING] 
00006 [GPT-5-CODEX-MAX-REASONING] -- Track double buffer state
00007 [GPT-5-CODEX-MAX-REASONING] local db_running = false
00008 [GPT-5-CODEX-MAX-REASONING] 
00009 [GPT-5-CODEX-MAX-REASONING] -- Sprite handles
00010 [GPT-5-CODEX-MAX-REASONING] local spritesheet_handle = nil
00011 [GPT-5-CODEX-MAX-REASONING] local sprites_loaded = false
00012 [GPT-5-CODEX-MAX-REASONING] local load_error = false
00013 [GPT-5-CODEX-MAX-REASONING] 
00014 [GPT-5-CODEX-MAX-REASONING] -- Animation state
00015 [GPT-5-CODEX-MAX-REASONING] local current_frame = 1
00016 [GPT-5-CODEX-MAX-REASONING] local last_frame_time = 0
00017 [GPT-5-CODEX-MAX-REASONING] local FRAME_DURATION = 100000  -- 100ms per frame
00018 [GPT-5-CODEX-MAX-REASONING] 
00019 [GPT-5-CODEX-MAX-REASONING] -- Character position
00020 [GPT-5-CODEX-MAX-REASONING] local char_x = 104
00021 [GPT-5-CODEX-MAX-REASONING] local char_y = 100
00022 [GPT-5-CODEX-MAX-REASONING] 
00023 [GPT-5-CODEX-MAX-REASONING] -- Teleport state machine
00024 [GPT-5-CODEX-MAX-REASONING] local STATE_IDLE = 1
00025 [GPT-5-CODEX-MAX-REASONING] local STATE_PIXELATING_OUT = 2
00026 [GPT-5-CODEX-MAX-REASONING] local STATE_TELEPORTED = 3
00027 [GPT-5-CODEX-MAX-REASONING] local STATE_PIXELATING_IN = 4
00028 [GPT-5-CODEX-MAX-REASONING] 
00029 [GPT-5-CODEX-MAX-REASONING] local teleport_state = STATE_IDLE
00030 [GPT-5-CODEX-MAX-REASONING] local state_start_time = 0
00031 [GPT-5-CODEX-MAX-REASONING] local mosaic_size = 1
00032 [GPT-5-CODEX-MAX-REASONING] 
00033 [GPT-5-CODEX-MAX-REASONING] -- Timing constants
00034 [GPT-5-CODEX-MAX-REASONING] local IDLE_DURATION = 2000000       -- 2 seconds between teleports
00035 [GPT-5-CODEX-MAX-REASONING] local PIXELATE_OUT_DURATION = 500000  -- 0.5 seconds to pixelate out
00036 [GPT-5-CODEX-MAX-REASONING] local TELEPORTED_DURATION = 200000    -- 0.2 seconds invisible
00037 [GPT-5-CODEX-MAX-REASONING] local PIXELATE_IN_DURATION = 500000   -- 0.5 seconds to pixelate in
00038 [GPT-5-CODEX-MAX-REASONING] local MAX_MOSAIC = 16                  -- Maximum pixelation level
00039 [GPT-5-CODEX-MAX-REASONING] 
00040 [GPT-5-CODEX-MAX-REASONING] --- @brief Load spritesheet
00041 [GPT-5-CODEX-MAX-REASONING] local function loadSprites()
00042 [GPT-5-CODEX-MAX-REASONING]     if sprites_loaded or load_error then
00043 [GPT-5-CODEX-MAX-REASONING]         return
00044 [GPT-5-CODEX-MAX-REASONING]     end
00045 [GPT-5-CODEX-MAX-REASONING] 
00046 [GPT-5-CODEX-MAX-REASONING]     spritesheet_handle = vmupro.sprite.newSheet("assets/mask_guy-table-32-32")
00047 [GPT-5-CODEX-MAX-REASONING]     if not spritesheet_handle then
00048 [GPT-5-CODEX-MAX-REASONING]         vmupro.system.log(vmupro.system.LOG_ERROR, "Page19", "Failed to load spritesheet")
00049 [GPT-5-CODEX-MAX-REASONING]         load_error = true
00050 [GPT-5-CODEX-MAX-REASONING]         return
00051 [GPT-5-CODEX-MAX-REASONING]     end
00052 [GPT-5-CODEX-MAX-REASONING] 
00053 [GPT-5-CODEX-MAX-REASONING]     sprites_loaded = true
00054 [GPT-5-CODEX-MAX-REASONING]     local current_time = vmupro.system.getTimeUs()
00055 [GPT-5-CODEX-MAX-REASONING]     last_frame_time = current_time
00056 [GPT-5-CODEX-MAX-REASONING]     state_start_time = current_time
00057 [GPT-5-CODEX-MAX-REASONING]     vmupro.system.log(vmupro.system.LOG_INFO, "Page19", "Sprites loaded for mosaic test")
00058 [GPT-5-CODEX-MAX-REASONING] end
00059 [GPT-5-CODEX-MAX-REASONING] 
00060 [GPT-5-CODEX-MAX-REASONING] --- @brief Get random position within safe bounds
00061 [GPT-5-CODEX-MAX-REASONING] local function getRandomPosition()
00062 [GPT-5-CODEX-MAX-REASONING]     -- Keep character within screen bounds (240x240 display, 32x32 sprite)
00063 [GPT-5-CODEX-MAX-REASONING]     local min_x = 20
00064 [GPT-5-CODEX-MAX-REASONING]     local max_x = 240 - 32 - 20
00065 [GPT-5-CODEX-MAX-REASONING]     local min_y = 50
00066 [GPT-5-CODEX-MAX-REASONING]     local max_y = 240 - 32 - 40
00067 [GPT-5-CODEX-MAX-REASONING] 
00068 [GPT-5-CODEX-MAX-REASONING]     local new_x = min_x + math.random(max_x - min_x)
00069 [GPT-5-CODEX-MAX-REASONING]     local new_y = min_y + math.random(max_y - min_y)
00070 [GPT-5-CODEX-MAX-REASONING] 
00071 [GPT-5-CODEX-MAX-REASONING]     return new_x, new_y
00072 [GPT-5-CODEX-MAX-REASONING] end
00073 [GPT-5-CODEX-MAX-REASONING] 
00074 [GPT-5-CODEX-MAX-REASONING] --- @brief Update logic
00075 [GPT-5-CODEX-MAX-REASONING] function Page19.update()
00076 [GPT-5-CODEX-MAX-REASONING]     -- No update needed - handled in render
00077 [GPT-5-CODEX-MAX-REASONING] end
00078 [GPT-5-CODEX-MAX-REASONING] 
00079 [GPT-5-CODEX-MAX-REASONING] --- @brief Cleanup when leaving page
00080 [GPT-5-CODEX-MAX-REASONING] function Page19.exit()
00081 [GPT-5-CODEX-MAX-REASONING]     if db_running then
00082 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.stopDoubleBufferRenderer()
00083 [GPT-5-CODEX-MAX-REASONING]         db_running = false
00084 [GPT-5-CODEX-MAX-REASONING]     end
00085 [GPT-5-CODEX-MAX-REASONING] 
00086 [GPT-5-CODEX-MAX-REASONING]     if spritesheet_handle then
00087 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.free(spritesheet_handle)
00088 [GPT-5-CODEX-MAX-REASONING]         spritesheet_handle = nil
00089 [GPT-5-CODEX-MAX-REASONING]     end
00090 [GPT-5-CODEX-MAX-REASONING]     sprites_loaded = false
00091 [GPT-5-CODEX-MAX-REASONING]     current_frame = 1
00092 [GPT-5-CODEX-MAX-REASONING]     teleport_state = STATE_IDLE
00093 [GPT-5-CODEX-MAX-REASONING]     mosaic_size = 1
00094 [GPT-5-CODEX-MAX-REASONING]     vmupro.system.log(vmupro.system.LOG_INFO, "Page19", "Sprites freed")
00095 [GPT-5-CODEX-MAX-REASONING] end
00096 [GPT-5-CODEX-MAX-REASONING] 
00097 [GPT-5-CODEX-MAX-REASONING] --- @brief Render Page 19: Mosaic Teleport Demo
00098 [GPT-5-CODEX-MAX-REASONING] function Page19.render(drawPageCounter)
00099 [GPT-5-CODEX-MAX-REASONING]     -- Start double buffer on first render
00100 [GPT-5-CODEX-MAX-REASONING]     if not db_running then
00101 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.startDoubleBufferRenderer()
00102 [GPT-5-CODEX-MAX-REASONING]         db_running = true
00103 [GPT-5-CODEX-MAX-REASONING]     end
00104 [GPT-5-CODEX-MAX-REASONING] 
00105 [GPT-5-CODEX-MAX-REASONING]     -- Clear screen
00106 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.clear(vmupro.graphics.BLACK)
00107 [GPT-5-CODEX-MAX-REASONING] 
00108 [GPT-5-CODEX-MAX-REASONING]     -- Page title
00109 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_GABARITO_18x18)
00110 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("Mosaic Teleport", 10, 10, vmupro.graphics.WHITE, vmupro.graphics.BLACK)
00111 [GPT-5-CODEX-MAX-REASONING] 
00112 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_SMALL)
00113 [GPT-5-CODEX-MAX-REASONING] 
00114 [GPT-5-CODEX-MAX-REASONING]     -- Load sprites on first render
00115 [GPT-5-CODEX-MAX-REASONING]     loadSprites()
00116 [GPT-5-CODEX-MAX-REASONING] 
00117 [GPT-5-CODEX-MAX-REASONING]     if load_error then
00118 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("ERROR: Failed to load", 10, 60, vmupro.graphics.RED, vmupro.graphics.BLACK)
00119 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("sprites. Check assets.", 10, 75, vmupro.graphics.RED, vmupro.graphics.BLACK)
00120 [GPT-5-CODEX-MAX-REASONING]     elseif not sprites_loaded then
00121 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("Loading sprites...", 10, 60, vmupro.graphics.YELLOW, vmupro.graphics.BLACK)
00122 [GPT-5-CODEX-MAX-REASONING]     elseif spritesheet_handle then
00123 [GPT-5-CODEX-MAX-REASONING]         local current_time = vmupro.system.getTimeUs()
00124 [GPT-5-CODEX-MAX-REASONING] 
00125 [GPT-5-CODEX-MAX-REASONING]         -- Update animation frame
00126 [GPT-5-CODEX-MAX-REASONING]         if (current_time - last_frame_time) >= FRAME_DURATION then
00127 [GPT-5-CODEX-MAX-REASONING]             current_frame = current_frame + 1
00128 [GPT-5-CODEX-MAX-REASONING]             if current_frame > spritesheet_handle.frameCount then
00129 [GPT-5-CODEX-MAX-REASONING]                 current_frame = 1
00130 [GPT-5-CODEX-MAX-REASONING]             end
00131 [GPT-5-CODEX-MAX-REASONING]             last_frame_time = current_time
00132 [GPT-5-CODEX-MAX-REASONING]         end
00133 [GPT-5-CODEX-MAX-REASONING] 
00134 [GPT-5-CODEX-MAX-REASONING]         -- Update teleport state machine
00135 [GPT-5-CODEX-MAX-REASONING]         local elapsed = current_time - state_start_time
00136 [GPT-5-CODEX-MAX-REASONING] 
00137 [GPT-5-CODEX-MAX-REASONING]         if teleport_state == STATE_IDLE then
00138 [GPT-5-CODEX-MAX-REASONING]             mosaic_size = 1
00139 [GPT-5-CODEX-MAX-REASONING]             if elapsed >= IDLE_DURATION then
00140 [GPT-5-CODEX-MAX-REASONING]                 teleport_state = STATE_PIXELATING_OUT
00141 [GPT-5-CODEX-MAX-REASONING]                 state_start_time = current_time
00142 [GPT-5-CODEX-MAX-REASONING]                 vmupro.system.log(vmupro.system.LOG_INFO, "Page19", "Starting teleport...")
00143 [GPT-5-CODEX-MAX-REASONING]             end
00144 [GPT-5-CODEX-MAX-REASONING] 
00145 [GPT-5-CODEX-MAX-REASONING]         elseif teleport_state == STATE_PIXELATING_OUT then
00146 [GPT-5-CODEX-MAX-REASONING]             -- Increase mosaic as we pixelate out
00147 [GPT-5-CODEX-MAX-REASONING]             local progress = elapsed / PIXELATE_OUT_DURATION
00148 [GPT-5-CODEX-MAX-REASONING]             if progress >= 1.0 then
00149 [GPT-5-CODEX-MAX-REASONING]                 progress = 1.0
00150 [GPT-5-CODEX-MAX-REASONING]                 teleport_state = STATE_TELEPORTED
00151 [GPT-5-CODEX-MAX-REASONING]                 state_start_time = current_time
00152 [GPT-5-CODEX-MAX-REASONING]                 -- Move to new position while invisible
00153 [GPT-5-CODEX-MAX-REASONING]                 char_x, char_y = getRandomPosition()
00154 [GPT-5-CODEX-MAX-REASONING]                 vmupro.system.log(vmupro.system.LOG_INFO, "Page19", string.format("Teleported to %d, %d", char_x, char_y))
00155 [GPT-5-CODEX-MAX-REASONING]             end
00156 [GPT-5-CODEX-MAX-REASONING]             mosaic_size = 1 + math.floor(progress * (MAX_MOSAIC - 1))
00157 [GPT-5-CODEX-MAX-REASONING] 
00158 [GPT-5-CODEX-MAX-REASONING]         elseif teleport_state == STATE_TELEPORTED then
00159 [GPT-5-CODEX-MAX-REASONING]             mosaic_size = MAX_MOSAIC
00160 [GPT-5-CODEX-MAX-REASONING]             if elapsed >= TELEPORTED_DURATION then
00161 [GPT-5-CODEX-MAX-REASONING]                 teleport_state = STATE_PIXELATING_IN
00162 [GPT-5-CODEX-MAX-REASONING]                 state_start_time = current_time
00163 [GPT-5-CODEX-MAX-REASONING]             end
00164 [GPT-5-CODEX-MAX-REASONING] 
00165 [GPT-5-CODEX-MAX-REASONING]         elseif teleport_state == STATE_PIXELATING_IN then
00166 [GPT-5-CODEX-MAX-REASONING]             -- Decrease mosaic as we materialize
00167 [GPT-5-CODEX-MAX-REASONING]             local progress = elapsed / PIXELATE_IN_DURATION
00168 [GPT-5-CODEX-MAX-REASONING]             if progress >= 1.0 then
00169 [GPT-5-CODEX-MAX-REASONING]                 progress = 1.0
00170 [GPT-5-CODEX-MAX-REASONING]                 teleport_state = STATE_IDLE
00171 [GPT-5-CODEX-MAX-REASONING]                 state_start_time = current_time
00172 [GPT-5-CODEX-MAX-REASONING]                 vmupro.system.log(vmupro.system.LOG_INFO, "Page19", "Teleport complete")
00173 [GPT-5-CODEX-MAX-REASONING]             end
00174 [GPT-5-CODEX-MAX-REASONING]             mosaic_size = MAX_MOSAIC - math.floor(progress * (MAX_MOSAIC - 1))
00175 [GPT-5-CODEX-MAX-REASONING]         end
00176 [GPT-5-CODEX-MAX-REASONING] 
00177 [GPT-5-CODEX-MAX-REASONING]         -- Draw character with mosaic effect (except when fully teleported)
00178 [GPT-5-CODEX-MAX-REASONING]         if teleport_state ~= STATE_TELEPORTED then
00179 [GPT-5-CODEX-MAX-REASONING]             if mosaic_size <= 1 then
00180 [GPT-5-CODEX-MAX-REASONING]                 -- Normal rendering
00181 [GPT-5-CODEX-MAX-REASONING]                 vmupro.sprite.drawFrame(spritesheet_handle, current_frame, char_x, char_y, vmupro.sprite.kImageUnflipped)
00182 [GPT-5-CODEX-MAX-REASONING]             else
00183 [GPT-5-CODEX-MAX-REASONING]                 -- Mosaic rendering
00184 [GPT-5-CODEX-MAX-REASONING]                 vmupro.sprite.drawFrameMosaic(spritesheet_handle, current_frame, char_x, char_y, mosaic_size, vmupro.sprite.kImageUnflipped)
00185 [GPT-5-CODEX-MAX-REASONING]             end
00186 [GPT-5-CODEX-MAX-REASONING]         end
00187 [GPT-5-CODEX-MAX-REASONING] 
00188 [GPT-5-CODEX-MAX-REASONING]         -- Status info
00189 [GPT-5-CODEX-MAX-REASONING]         local state_text = "IDLE"
00190 [GPT-5-CODEX-MAX-REASONING]         if teleport_state == STATE_PIXELATING_OUT then
00191 [GPT-5-CODEX-MAX-REASONING]             state_text = "PIXELATING OUT"
00192 [GPT-5-CODEX-MAX-REASONING]         elseif teleport_state == STATE_TELEPORTED then
00193 [GPT-5-CODEX-MAX-REASONING]             state_text = "TELEPORTED!"
00194 [GPT-5-CODEX-MAX-REASONING]         elseif teleport_state == STATE_PIXELATING_IN then
00195 [GPT-5-CODEX-MAX-REASONING]             state_text = "MATERIALIZING"
00196 [GPT-5-CODEX-MAX-REASONING]         end
00197 [GPT-5-CODEX-MAX-REASONING] 
00198 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(state_text, 10, 195, vmupro.graphics.YELLOW, vmupro.graphics.BLACK)
00199 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(string.format("Mosaic: %d", mosaic_size), 10, 210, vmupro.graphics.BLUE, vmupro.graphics.BLACK)
00200 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(string.format("Pos: %d,%d", char_x, char_y), 150, 210, vmupro.graphics.GREEN, vmupro.graphics.BLACK)
00201 [GPT-5-CODEX-MAX-REASONING]     end
00202 [GPT-5-CODEX-MAX-REASONING] 
00203 [GPT-5-CODEX-MAX-REASONING]     -- Navigation hint
00204 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("< Prev | Next >", 75, 225, vmupro.graphics.GREY, vmupro.graphics.BLACK)
00205 [GPT-5-CODEX-MAX-REASONING] 
00206 [GPT-5-CODEX-MAX-REASONING]     -- Page counter
00207 [GPT-5-CODEX-MAX-REASONING]     drawPageCounter()
00208 [GPT-5-CODEX-MAX-REASONING] end

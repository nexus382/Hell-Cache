00001 [GPT-5-CODEX-MAX-REASONING] -- VMU Pro Dungeon Raycaster
00002 [GPT-5-CODEX-MAX-REASONING] -- Castle dungeon with detailed sprites
00003 [GPT-5-CODEX-MAX-REASONING] 
00004 [GPT-5-CODEX-MAX-REASONING] import "api/system"
00005 [GPT-5-CODEX-MAX-REASONING] 
00006 [GPT-5-CODEX-MAX-REASONING] enableBootLogs = true
00007 [GPT-5-CODEX-MAX-REASONING] enablePerfLogs = true
00008 [GPT-5-CODEX-MAX-REASONING] showFpsOverlay = true
00009 [GPT-5-CODEX-MAX-REASONING] lastFps = 0
00010 [GPT-5-CODEX-MAX-REASONING] 
00011 [GPT-5-CODEX-MAX-REASONING] local function logBoot(level, message)
00012 [GPT-5-CODEX-MAX-REASONING]     if not enableBootLogs then return end
00013 [GPT-5-CODEX-MAX-REASONING]     if vmupro and vmupro.system and vmupro.system.log then
00014 [GPT-5-CODEX-MAX-REASONING]         vmupro.system.log(level, "BOOT", message)
00015 [GPT-5-CODEX-MAX-REASONING]     end
00016 [GPT-5-CODEX-MAX-REASONING] end
00017 [GPT-5-CODEX-MAX-REASONING] 
00018 [GPT-5-CODEX-MAX-REASONING] local function logPerf(message)
00019 [GPT-5-CODEX-MAX-REASONING]     if not enablePerfLogs then return end
00020 [GPT-5-CODEX-MAX-REASONING]     if vmupro and vmupro.system and vmupro.system.log then
00021 [GPT-5-CODEX-MAX-REASONING]         vmupro.system.log(vmupro.system.LOG_INFO, "PERF", message)
00022 [GPT-5-CODEX-MAX-REASONING]     end
00023 [GPT-5-CODEX-MAX-REASONING] end
00024 [GPT-5-CODEX-MAX-REASONING] 
00025 [GPT-5-CODEX-MAX-REASONING] if enableBootLogs and vmupro and vmupro.system and vmupro.system.log then
00026 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "app.lua loaded")
00027 [GPT-5-CODEX-MAX-REASONING] end
00028 [GPT-5-CODEX-MAX-REASONING] 
00029 [GPT-5-CODEX-MAX-REASONING] local function tryImport(mod)
00030 [GPT-5-CODEX-MAX-REASONING]     local ok, err = pcall(function() import(mod) end)
00031 [GPT-5-CODEX-MAX-REASONING]     if ok then
00032 [GPT-5-CODEX-MAX-REASONING]         logBoot(vmupro.system.LOG_ERROR, "import ok " .. mod)
00033 [GPT-5-CODEX-MAX-REASONING]     else
00034 [GPT-5-CODEX-MAX-REASONING]         logBoot(vmupro.system.LOG_ERROR, "import FAIL " .. mod .. " err=" .. tostring(err))
00035 [GPT-5-CODEX-MAX-REASONING]     end
00036 [GPT-5-CODEX-MAX-REASONING]     return ok
00037 [GPT-5-CODEX-MAX-REASONING] end
00038 [GPT-5-CODEX-MAX-REASONING] 
00039 [GPT-5-CODEX-MAX-REASONING] tryImport("api/display")
00040 [GPT-5-CODEX-MAX-REASONING] tryImport("api/input")
00041 [GPT-5-CODEX-MAX-REASONING] tryImport("api/sprites")
00042 [GPT-5-CODEX-MAX-REASONING] tryImport("api/audio")
00043 [GPT-5-CODEX-MAX-REASONING] tryImport("api/text")
00044 [GPT-5-CODEX-MAX-REASONING] 
00045 [GPT-5-CODEX-MAX-REASONING] logBoot(vmupro.system.LOG_ERROR, "after imports")
00046 [GPT-5-CODEX-MAX-REASONING] 
00047 [GPT-5-CODEX-MAX-REASONING] -- Fallback stub; replaced by drawTitleScreenImpl when defined
00048 [GPT-5-CODEX-MAX-REASONING] function drawTitleScreen()
00049 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen stub")
00050 [GPT-5-CODEX-MAX-REASONING] end
00051 [GPT-5-CODEX-MAX-REASONING] 
00052 [GPT-5-CODEX-MAX-REASONING] -- Safety Check Functions
00053 [GPT-5-CODEX-MAX-REASONING] local function safeLog(level, message)
00054 [GPT-5-CODEX-MAX-REASONING]     if vmupro.system.log then
00055 [GPT-5-CODEX-MAX-REASONING]         local lvl = vmupro.system.LOG_INFO
00056 [GPT-5-CODEX-MAX-REASONING]         if level == "ERROR" then
00057 [GPT-5-CODEX-MAX-REASONING]             lvl = vmupro.system.LOG_ERROR
00058 [GPT-5-CODEX-MAX-REASONING]         elseif level == "WARN" then
00059 [GPT-5-CODEX-MAX-REASONING]             lvl = vmupro.system.LOG_WARN
00060 [GPT-5-CODEX-MAX-REASONING]         elseif level == "DEBUG" then
00061 [GPT-5-CODEX-MAX-REASONING]             lvl = vmupro.system.LOG_DEBUG
00062 [GPT-5-CODEX-MAX-REASONING]         end
00063 [GPT-5-CODEX-MAX-REASONING]         vmupro.system.log(lvl, "SAFETY", message)
00064 [GPT-5-CODEX-MAX-REASONING]     else
00065 [GPT-5-CODEX-MAX-REASONING]         print("[SAFETY " .. level .. "] " .. message)
00066 [GPT-5-CODEX-MAX-REASONING]     end
00067 [GPT-5-CODEX-MAX-REASONING] end
00068 [GPT-5-CODEX-MAX-REASONING] 
00069 [GPT-5-CODEX-MAX-REASONING] local function validateSprite(sprite, context)
00070 [GPT-5-CODEX-MAX-REASONING]     if not sprite then
00071 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Sprite is nil in context: " .. (context or "unknown"))
00072 [GPT-5-CODEX-MAX-REASONING]         return false
00073 [GPT-5-CODEX-MAX-REASONING]     end
00074 [GPT-5-CODEX-MAX-REASONING]     if not sprite.width or not sprite.height then
00075 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Sprite missing width/height in context: " .. (context or "unknown"))
00076 [GPT-5-CODEX-MAX-REASONING]         return false
00077 [GPT-5-CODEX-MAX-REASONING]     end
00078 [GPT-5-CODEX-MAX-REASONING]     if sprite.width <= 0 or sprite.height <= 0 then
00079 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Sprite has invalid dimensions in context: " .. (context or "unknown") ..
00080 [GPT-5-CODEX-MAX-REASONING]                " width=" .. tostring(sprite.width) .. " height=" .. tostring(sprite.height))
00081 [GPT-5-CODEX-MAX-REASONING]         return false
00082 [GPT-5-CODEX-MAX-REASONING]     end
00083 [GPT-5-CODEX-MAX-REASONING]     return true
00084 [GPT-5-CODEX-MAX-REASONING] end
00085 [GPT-5-CODEX-MAX-REASONING] 
00086 [GPT-5-CODEX-MAX-REASONING] local function validateTextureDimensions(sprite, context)
00087 [GPT-5-CODEX-MAX-REASONING]     if not validateSprite(sprite, context) then
00088 [GPT-5-CODEX-MAX-REASONING]         return false
00089 [GPT-5-CODEX-MAX-REASONING]     end
00090 [GPT-5-CODEX-MAX-REASONING]     if sprite.width > 2048 or sprite.height > 2048 then
00091 [GPT-5-CODEX-MAX-REASONING]         safeLog("WARN", "Texture dimensions may be too large in context: " .. (context or "unknown") ..
00092 [GPT-5-CODEX-MAX-REASONING]                " width=" .. tostring(sprite.width) .. " height=" .. tostring(sprite.height))
00093 [GPT-5-CODEX-MAX-REASONING]     end
00094 [GPT-5-CODEX-MAX-REASONING]     return true
00095 [GPT-5-CODEX-MAX-REASONING] end
00096 [GPT-5-CODEX-MAX-REASONING] 
00097 [GPT-5-CODEX-MAX-REASONING] local function safeDivide(value, divisor, context)
00098 [GPT-5-CODEX-MAX-REASONING]     if divisor == 0 then
00099 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Division by zero in context: " .. (context or "unknown") ..
00100 [GPT-5-CODEX-MAX-REASONING]                " value=" .. tostring(value) .. " divisor=0")
00101 [GPT-5-CODEX-MAX-REASONING]         return 0
00102 [GPT-5-CODEX-MAX-REASONING]     end
00103 [GPT-5-CODEX-MAX-REASONING]     return value / divisor
00104 [GPT-5-CODEX-MAX-REASONING] end
00105 [GPT-5-CODEX-MAX-REASONING] 
00106 [GPT-5-CODEX-MAX-REASONING] local function checkArrayBounds(array, index, context)
00107 [GPT-5-CODEX-MAX-REASONING]     if not array then
00108 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Array is nil in context: " .. (context or "unknown"))
00109 [GPT-5-CODEX-MAX-REASONING]         return false
00110 [GPT-5-CODEX-MAX-REASONING]     end
00111 [GPT-5-CODEX-MAX-REASONING]     local length = #array
00112 [GPT-5-CODEX-MAX-REASONING]     if index < 1 or index > length then
00113 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Array index out of bounds in context: " .. (context or "unknown") ..
00114 [GPT-5-CODEX-MAX-REASONING]                " index=" .. tostring(index) .. " length=" .. tostring(length))
00115 [GPT-5-CODEX-MAX-REASONING]         return false
00116 [GPT-5-CODEX-MAX-REASONING]     end
00117 [GPT-5-CODEX-MAX-REASONING]     return true
00118 [GPT-5-CODEX-MAX-REASONING] end
00119 [GPT-5-CODEX-MAX-REASONING] 
00120 [GPT-5-CODEX-MAX-REASONING] local function safeScale(sprite, scaleX, scaleY, context)
00121 [GPT-5-CODEX-MAX-REASONING]     if not validateSprite(sprite, context) then
00122 [GPT-5-CODEX-MAX-REASONING]         return false
00123 [GPT-5-CODEX-MAX-REASONING]     end
00124 [GPT-5-CODEX-MAX-REASONING]     if type(scaleX) ~= "number" or type(scaleY) ~= "number" then
00125 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Scale values are not numbers in context: " .. (context or "unknown") ..
00126 [GPT-5-CODEX-MAX-REASONING]                " scaleX=" .. tostring(scaleX) .. " scaleY=" .. tostring(scaleY))
00127 [GPT-5-CODEX-MAX-REASONING]         return false
00128 [GPT-5-CODEX-MAX-REASONING]     end
00129 [GPT-5-CODEX-MAX-REASONING]     if scaleX < 0 or scaleY < 0 then
00130 [GPT-5-CODEX-MAX-REASONING]         safeLog("WARN", "Negative scale values in context: " .. (context or "unknown") ..
00131 [GPT-5-CODEX-MAX-REASONING]                " scaleX=" .. tostring(scaleX) .. " scaleY=" .. tostring(scaleY))
00132 [GPT-5-CODEX-MAX-REASONING]     end
00133 [GPT-5-CODEX-MAX-REASONING]     return true
00134 [GPT-5-CODEX-MAX-REASONING] end
00135 [GPT-5-CODEX-MAX-REASONING] 
00136 [GPT-5-CODEX-MAX-REASONING] -- Colors (RGB565 little-endian)
00137 [GPT-5-CODEX-MAX-REASONING] COLOR_BLACK = 0x0000
00138 [GPT-5-CODEX-MAX-REASONING] COLOR_WHITE = 0xFFFF
00139 [GPT-5-CODEX-MAX-REASONING] COLOR_RED = 0x00F8
00140 [GPT-5-CODEX-MAX-REASONING] COLOR_YELLOW = 0xE0FF
00141 [GPT-5-CODEX-MAX-REASONING] COLOR_ORANGE = 0x20FC
00142 [GPT-5-CODEX-MAX-REASONING] COLOR_SKIN = 0xB6BD
00143 [GPT-5-CODEX-MAX-REASONING] COLOR_SKIN_DARK = 0x9294
00144 [GPT-5-CODEX-MAX-REASONING] COLOR_BROWN = 0x4051
00145 [GPT-5-CODEX-MAX-REASONING] COLOR_DARK_BROWN = 0x2028
00146 [GPT-5-CODEX-MAX-REASONING] COLOR_LIGHT_BROWN = 0x6079
00147 [GPT-5-CODEX-MAX-REASONING] COLOR_GRAY = 0x8C73
00148 [GPT-5-CODEX-MAX-REASONING] COLOR_DARK_GRAY = 0x4A52
00149 [GPT-5-CODEX-MAX-REASONING] COLOR_LIGHT_GRAY = 0xCE7B
00150 [GPT-5-CODEX-MAX-REASONING] COLOR_BLUE = 0x1F00
00151 [GPT-5-CODEX-MAX-REASONING] COLOR_DARK_BLUE = 0x0E00
00152 [GPT-5-CODEX-MAX-REASONING] COLOR_LIGHT_BLUE = 0x1F42
00153 [GPT-5-CODEX-MAX-REASONING] COLOR_GREEN = 0xE007
00154 [GPT-5-CODEX-MAX-REASONING] COLOR_MAROON = 0x0060
00155 [GPT-5-CODEX-MAX-REASONING] COLOR_DARK_MAROON = 0x0040
00156 [GPT-5-CODEX-MAX-REASONING] COLOR_LIGHT_MAROON = 0x0861
00157 [GPT-5-CODEX-MAX-REASONING] COLOR_SILVER = 0xF7BD
00158 [GPT-5-CODEX-MAX-REASONING] COLOR_DARK_SILVER = 0xCE7B
00159 [GPT-5-CODEX-MAX-REASONING] 
00160 [GPT-5-CODEX-MAX-REASONING] -- Dungeon colors
00161 [GPT-5-CODEX-MAX-REASONING] COLOR_FLOOR = 0x6931
00162 [GPT-5-CODEX-MAX-REASONING] COLOR_CEILING = 0x2821
00163 [GPT-5-CODEX-MAX-REASONING] 
00164 [GPT-5-CODEX-MAX-REASONING] -- Wall colors
00165 [GPT-5-CODEX-MAX-REASONING] COLOR_STONE_L = 0x8C73
00166 [GPT-5-CODEX-MAX-REASONING] COLOR_STONE_D = 0x4A52
00167 [GPT-5-CODEX-MAX-REASONING] COLOR_BRICK_L = 0x4062
00168 [GPT-5-CODEX-MAX-REASONING] COLOR_BRICK_D = 0x0041
00169 [GPT-5-CODEX-MAX-REASONING] COLOR_MOSS_L = 0x4444
00170 [GPT-5-CODEX-MAX-REASONING] COLOR_MOSS_D = 0x2222
00171 [GPT-5-CODEX-MAX-REASONING] COLOR_METAL_L = 0x1084
00172 [GPT-5-CODEX-MAX-REASONING] COLOR_METAL_D = 0x0842
00173 [GPT-5-CODEX-MAX-REASONING] COLOR_WOOD_L = 0x4051
00174 [GPT-5-CODEX-MAX-REASONING] COLOR_WOOD_D = 0x2028
00175 [GPT-5-CODEX-MAX-REASONING] 
00176 [GPT-5-CODEX-MAX-REASONING] logBoot(vmupro.system.LOG_ERROR, "after color constants")
00177 [GPT-5-CODEX-MAX-REASONING] 
00178 [GPT-5-CODEX-MAX-REASONING] -- Base level data (used to build per-level instances)
00179 [GPT-5-CODEX-MAX-REASONING] local BASE_MAP = {
00180 [GPT-5-CODEX-MAX-REASONING]     {1,1,1,1,1,1,1,4,1,1,1,1,1,1,1,1},
00181 [GPT-5-CODEX-MAX-REASONING]     {1,0,0,0,6,0,1,0,0,0,6,0,0,0,0,1},
00182 [GPT-5-CODEX-MAX-REASONING]     {2,0,0,0,0,0,1,0,0,0,0,0,0,0,0,2},
00183 [GPT-5-CODEX-MAX-REASONING]     {1,0,0,0,0,0,3,0,0,0,0,0,0,0,0,1},
00184 [GPT-5-CODEX-MAX-REASONING]     {1,6,0,0,0,0,0,0,0,0,0,0,0,0,6,1},
00185 [GPT-5-CODEX-MAX-REASONING]     {1,0,0,0,0,0,3,0,0,0,0,0,0,0,0,1},
00186 [GPT-5-CODEX-MAX-REASONING]     {1,2,2,0,2,2,1,0,0,5,0,5,0,0,1,1},
00187 [GPT-5-CODEX-MAX-REASONING]     {1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1},
00188 [GPT-5-CODEX-MAX-REASONING]     {3,0,0,6,0,0,0,0,0,0,0,0,0,6,0,3},
00189 [GPT-5-CODEX-MAX-REASONING]     {1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1},
00190 [GPT-5-CODEX-MAX-REASONING]     {1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1},
00191 [GPT-5-CODEX-MAX-REASONING]     {3,0,0,6,0,0,0,0,0,0,0,0,0,6,0,3},
00192 [GPT-5-CODEX-MAX-REASONING]     {1,2,0,0,2,2,5,0,0,0,0,0,2,0,2,1},
00193 [GPT-5-CODEX-MAX-REASONING]     {1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1},
00194 [GPT-5-CODEX-MAX-REASONING]     {1,0,6,0,6,0,1,0,0,0,0,0,0,6,0,1},
00195 [GPT-5-CODEX-MAX-REASONING]     {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
00196 [GPT-5-CODEX-MAX-REASONING] }
00197 [GPT-5-CODEX-MAX-REASONING] 
00198 [GPT-5-CODEX-MAX-REASONING] local function buildSingleRoomMap()
00199 [GPT-5-CODEX-MAX-REASONING]     local mapOut = {}
00200 [GPT-5-CODEX-MAX-REASONING]     for y = 0, 15 do
00201 [GPT-5-CODEX-MAX-REASONING]         local row = {}
00202 [GPT-5-CODEX-MAX-REASONING]         for x = 0, 15 do
00203 [GPT-5-CODEX-MAX-REASONING]             if x == 0 or x == 15 or y == 0 or y == 15 then
00204 [GPT-5-CODEX-MAX-REASONING]                 row[#row + 1] = 1
00205 [GPT-5-CODEX-MAX-REASONING]             else
00206 [GPT-5-CODEX-MAX-REASONING]                 row[#row + 1] = 0
00207 [GPT-5-CODEX-MAX-REASONING]             end
00208 [GPT-5-CODEX-MAX-REASONING]         end
00209 [GPT-5-CODEX-MAX-REASONING]         mapOut[#mapOut + 1] = row
00210 [GPT-5-CODEX-MAX-REASONING]     end
00211 [GPT-5-CODEX-MAX-REASONING]     return mapOut
00212 [GPT-5-CODEX-MAX-REASONING] end
00213 [GPT-5-CODEX-MAX-REASONING] 
00214 [GPT-5-CODEX-MAX-REASONING] -- Sprites: t=1 torch, t=2 barrel, t=3 table, t=4 chest, t=5 warrior, t=6 knight, t=7 health vial
00215 [GPT-5-CODEX-MAX-REASONING] local BASE_SPRITES = {
00216 [GPT-5-CODEX-MAX-REASONING]     {x=1.5, y=1.5, t=1}, {x=6.5, y=1.5, t=1}, {x=8.5, y=1.5, t=1}, {x=14.5, y=1.5, t=1},
00217 [GPT-5-CODEX-MAX-REASONING]     {x=1.5, y=5.5, t=1}, {x=14.5, y=5.5, t=1},
00218 [GPT-5-CODEX-MAX-REASONING]     {x=1.5, y=8.5, t=1}, {x=1.5, y=11.5, t=1},
00219 [GPT-5-CODEX-MAX-REASONING]     {x=14.5, y=8.5, t=1}, {x=14.5, y=11.5, t=1},
00220 [GPT-5-CODEX-MAX-REASONING]     {x=1.3, y=3.5, t=3}, {x=1.3, y=2.5, t=2}, {x=5.7, y=4.5, t=2},
00221 [GPT-5-CODEX-MAX-REASONING]     {x=10.5, y=1.3, t=4}, {x=14.3, y=3.5, t=3}, {x=10.3, y=4.7, t=2},
00222 [GPT-5-CODEX-MAX-REASONING]     {x=1.3, y=13.5, t=2}, {x=3.5, y=14.3, t=4}, {x=5.7, y=12.3, t=3},
00223 [GPT-5-CODEX-MAX-REASONING]     {x=14.3, y=13.5, t=2}, {x=13.5, y=14.3, t=4},
00224 [GPT-5-CODEX-MAX-REASONING]     {x=1.3, y=9.5, t=2}, {x=14.3, y=9.5, t=2},
00225 [GPT-5-CODEX-MAX-REASONING]     -- Warriors (red armor) - moved to open tiles
00226 [GPT-5-CODEX-MAX-REASONING]     {x=4.5, y=8.5, t=5, dir=32, tx=4.5, ty=8.5, anim=0, speed=0.02, hp=100, alive=true, startX=4.5, startY=8.5},
00227 [GPT-5-CODEX-MAX-REASONING]     {x=8.5, y=8.5, t=5, dir=48, tx=8.5, ty=8.5, anim=0, speed=0.02, hp=100, alive=true, startX=8.5, startY=8.5},
00228 [GPT-5-CODEX-MAX-REASONING]     {x=12.5, y=8.5, t=5, dir=0, tx=12.5, ty=8.5, anim=0, speed=0.02, hp=100, alive=true, startX=12.5, startY=8.5},
00229 [GPT-5-CODEX-MAX-REASONING]     {x=6.5, y=11.5, t=5, dir=16, tx=6.5, ty=11.5, anim=0, speed=0.02, hp=100, alive=true, startX=6.5, startY=11.5},
00230 [GPT-5-CODEX-MAX-REASONING]     {x=10.5, y=11.5, t=5, dir=32, tx=10.5, ty=11.5, anim=0, speed=0.02, hp=100, alive=true, startX=10.5, startY=11.5},
00231 [GPT-5-CODEX-MAX-REASONING]     -- Health vials (one per room area)
00232 [GPT-5-CODEX-MAX-REASONING]     {x=5.5, y=2.5, t=7, collected=false},   -- Top-left room
00233 [GPT-5-CODEX-MAX-REASONING]     {x=10.5, y=2.5, t=7, collected=false},  -- Top-right room
00234 [GPT-5-CODEX-MAX-REASONING]     {x=2.5, y=8.5, t=7, collected=false},   -- Left side
00235 [GPT-5-CODEX-MAX-REASONING]     {x=8.5, y=9.5, t=7, collected=false},   -- Central area
00236 [GPT-5-CODEX-MAX-REASONING]     {x=12.5, y=13.5, t=7, collected=false}, -- Bottom-right area
00237 [GPT-5-CODEX-MAX-REASONING] }
00238 [GPT-5-CODEX-MAX-REASONING] 
00239 [GPT-5-CODEX-MAX-REASONING] logBoot(vmupro.system.LOG_ERROR, "after base sprites")
00240 [GPT-5-CODEX-MAX-REASONING] 
00241 [GPT-5-CODEX-MAX-REASONING] local LEVELS = {
00242 [GPT-5-CODEX-MAX-REASONING]     [1] = {
00243 [GPT-5-CODEX-MAX-REASONING]         name = "Inner Sanctum - L1",
00244 [GPT-5-CODEX-MAX-REASONING]         playerStart = {x = 2.5, y = 2.5, dir = 0},
00245 [GPT-5-CODEX-MAX-REASONING]         assetBase = "sprites/level1/",
00246 [GPT-5-CODEX-MAX-REASONING]         map = BASE_MAP,
00247 [GPT-5-CODEX-MAX-REASONING]         sprites = BASE_SPRITES,
00248 [GPT-5-CODEX-MAX-REASONING]         assets = {warrior = true, knight = false, potion = true}
00249 [GPT-5-CODEX-MAX-REASONING]     },
00250 [GPT-5-CODEX-MAX-REASONING]     [2] = {
00251 [GPT-5-CODEX-MAX-REASONING]         name = "Inner Sanctum - L2",
00252 [GPT-5-CODEX-MAX-REASONING]         playerStart = {x = 2.5, y = 2.5, dir = 0},
00253 [GPT-5-CODEX-MAX-REASONING]         assetBase = "sprites/level2/",
00254 [GPT-5-CODEX-MAX-REASONING]         map = {
00255 [GPT-5-CODEX-MAX-REASONING]             {1,1,1,1,1,1,1,4,1,1,1,1,1,1,1,1},
00256 [GPT-5-CODEX-MAX-REASONING]             {1,0,0,0,6,0,1,0,0,0,6,0,0,0,0,1},
00257 [GPT-5-CODEX-MAX-REASONING]             {2,0,0,0,0,0,1,0,0,0,0,0,0,6,0,2},
00258 [GPT-5-CODEX-MAX-REASONING]             {1,0,0,0,0,0,3,0,0,0,0,0,0,6,0,1},
00259 [GPT-5-CODEX-MAX-REASONING]             {1,6,0,0,0,0,0,0,0,0,0,0,0,0,6,1},
00260 [GPT-5-CODEX-MAX-REASONING]             {1,0,0,0,0,0,3,0,0,0,0,0,0,0,0,1},
00261 [GPT-5-CODEX-MAX-REASONING]             {1,2,2,0,2,2,1,0,0,5,0,5,0,0,1,1},
00262 [GPT-5-CODEX-MAX-REASONING]             {1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1},
00263 [GPT-5-CODEX-MAX-REASONING]             {3,0,0,6,0,0,0,1,4,1,0,0,0,6,0,3},
00264 [GPT-5-CODEX-MAX-REASONING]             {1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,1},
00265 [GPT-5-CODEX-MAX-REASONING]             {1,0,0,0,0,0,0,1,5,1,0,0,0,0,0,1},
00266 [GPT-5-CODEX-MAX-REASONING]             {3,0,0,6,0,0,0,0,0,0,0,0,0,6,0,3},
00267 [GPT-5-CODEX-MAX-REASONING]             {1,2,0,0,2,2,5,0,0,0,0,0,2,0,2,1},
00268 [GPT-5-CODEX-MAX-REASONING]             {1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1},
00269 [GPT-5-CODEX-MAX-REASONING]             {1,0,6,0,6,0,1,0,0,0,0,0,0,6,0,1},
00270 [GPT-5-CODEX-MAX-REASONING]             {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
00271 [GPT-5-CODEX-MAX-REASONING]         },
00272 [GPT-5-CODEX-MAX-REASONING]             sprites = {
00273 [GPT-5-CODEX-MAX-REASONING]                 {x=1.5, y=1.5, t=1}, {x=6.5, y=1.5, t=1}, {x=8.5, y=1.5, t=1}, {x=14.5, y=1.5, t=1},
00274 [GPT-5-CODEX-MAX-REASONING]                 {x=1.5, y=5.5, t=1}, {x=14.5, y=5.5, t=1},
00275 [GPT-5-CODEX-MAX-REASONING]                 {x=1.5, y=8.5, t=1}, {x=1.5, y=11.5, t=1},
00276 [GPT-5-CODEX-MAX-REASONING]                 {x=14.5, y=8.5, t=1}, {x=14.5, y=11.5, t=1},
00277 [GPT-5-CODEX-MAX-REASONING]                 {x=1.3, y=3.5, t=3}, {x=1.3, y=2.5, t=2}, {x=5.7, y=4.5, t=2},
00278 [GPT-5-CODEX-MAX-REASONING]                 {x=10.5, y=1.3, t=4}, {x=14.3, y=3.5, t=3}, {x=10.3, y=4.7, t=2},
00279 [GPT-5-CODEX-MAX-REASONING]                 {x=1.3, y=13.5, t=2}, {x=3.5, y=14.3, t=4}, {x=5.7, y=12.3, t=3},
00280 [GPT-5-CODEX-MAX-REASONING]                 {x=14.3, y=13.5, t=2}, {x=13.5, y=14.3, t=4},
00281 [GPT-5-CODEX-MAX-REASONING]                 {x=1.3, y=9.5, t=2}, {x=14.3, y=9.5, t=2},
00282 [GPT-5-CODEX-MAX-REASONING]                 -- Warriors (red armor) - moved to open tiles
00283 [GPT-5-CODEX-MAX-REASONING]                 {x=4.5, y=8.5, t=5, dir=32, tx=4.5, ty=8.5, anim=0, speed=0.025, hp=120, alive=true, startX=4.5, startY=8.5},
00284 [GPT-5-CODEX-MAX-REASONING]                 {x=6.5, y=8.5, t=5, dir=48, tx=6.5, ty=8.5, anim=0, speed=0.025, hp=120, alive=true, startX=6.5, startY=8.5},
00285 [GPT-5-CODEX-MAX-REASONING]                 {x=11.5, y=10.5, t=5, dir=0, tx=11.5, ty=10.5, anim=0, speed=0.025, hp=120, alive=true, startX=11.5, startY=10.5},
00286 [GPT-5-CODEX-MAX-REASONING]             {x=11.5, y=12.5, t=5, dir=16, tx=11.5, ty=12.5, anim=0, speed=0.025, hp=120, alive=true, startX=11.5, startY=12.5},
00287 [GPT-5-CODEX-MAX-REASONING]             {x=8.5, y=13.5, t=5, dir=32, tx=8.5, ty=13.5, anim=0, speed=0.025, hp=120, alive=true, startX=8.5, startY=13.5},
00288 [GPT-5-CODEX-MAX-REASONING]             -- Health vials
00289 [GPT-5-CODEX-MAX-REASONING]             {x=5.5, y=2.5, t=7, collected=false},
00290 [GPT-5-CODEX-MAX-REASONING]             {x=10.5, y=2.5, t=7, collected=false},
00291 [GPT-5-CODEX-MAX-REASONING]             {x=2.5, y=8.5, t=7, collected=false},
00292 [GPT-5-CODEX-MAX-REASONING]             {x=8.5, y=9.5, t=7, collected=false},
00293 [GPT-5-CODEX-MAX-REASONING]             {x=12.5, y=13.5, t=7, collected=false}
00294 [GPT-5-CODEX-MAX-REASONING]         },
00295 [GPT-5-CODEX-MAX-REASONING]         assets = {warrior = true, knight = false, potion = true}
00296 [GPT-5-CODEX-MAX-REASONING]     }
00297 [GPT-5-CODEX-MAX-REASONING] }
00298 [GPT-5-CODEX-MAX-REASONING] 
00299 [GPT-5-CODEX-MAX-REASONING] logBoot(vmupro.system.LOG_ERROR, "after levels")
00300 [GPT-5-CODEX-MAX-REASONING] 
00301 [GPT-5-CODEX-MAX-REASONING] local currentLevel = 1
00302 [GPT-5-CODEX-MAX-REASONING] local selectedLevel = 1
00303 [GPT-5-CODEX-MAX-REASONING] local REAL_LEVEL_COUNT = #LEVELS
00304 [GPT-5-CODEX-MAX-REASONING] local MAX_LEVEL = REAL_LEVEL_COUNT
00305 [GPT-5-CODEX-MAX-REASONING] LEVELS[101] = {
00306 [GPT-5-CODEX-MAX-REASONING]     name = "p-1room0-0",
00307 [GPT-5-CODEX-MAX-REASONING]     playerStart = {x = 2.5, y = 2.5, dir = 0},
00308 [GPT-5-CODEX-MAX-REASONING]     assetBase = "sprites/level1/",
00309 [GPT-5-CODEX-MAX-REASONING]     map = buildSingleRoomMap(),
00310 [GPT-5-CODEX-MAX-REASONING]     sprites = {},
00311 [GPT-5-CODEX-MAX-REASONING]     assets = {warrior = false, knight = false, potion = false},
00312 [GPT-5-CODEX-MAX-REASONING]     perfDisableEnemies = true,
00313 [GPT-5-CODEX-MAX-REASONING]     perfDisableTextures = true,
00314 [GPT-5-CODEX-MAX-REASONING]     perfDisableProps = true
00315 [GPT-5-CODEX-MAX-REASONING] }
00316 [GPT-5-CODEX-MAX-REASONING] LEVELS[102] = {
00317 [GPT-5-CODEX-MAX-REASONING]     name = "p-1room-1-0",
00318 [GPT-5-CODEX-MAX-REASONING]     playerStart = {x = 2.5, y = 2.5, dir = 0},
00319 [GPT-5-CODEX-MAX-REASONING]     assetBase = "sprites/level1/",
00320 [GPT-5-CODEX-MAX-REASONING]     map = buildSingleRoomMap(),
00321 [GPT-5-CODEX-MAX-REASONING]     sprites = {},
00322 [GPT-5-CODEX-MAX-REASONING]     assets = {warrior = false, knight = false, potion = false},
00323 [GPT-5-CODEX-MAX-REASONING]     perfDisableEnemies = false,
00324 [GPT-5-CODEX-MAX-REASONING]     perfDisableTextures = true,
00325 [GPT-5-CODEX-MAX-REASONING]     perfDisableProps = true
00326 [GPT-5-CODEX-MAX-REASONING] }
00327 [GPT-5-CODEX-MAX-REASONING] LEVELS[103] = {
00328 [GPT-5-CODEX-MAX-REASONING]     name = "p-1room-1-1",
00329 [GPT-5-CODEX-MAX-REASONING]     playerStart = {x = 2.5, y = 2.5, dir = 0},
00330 [GPT-5-CODEX-MAX-REASONING]     assetBase = "sprites/level1/",
00331 [GPT-5-CODEX-MAX-REASONING]     map = buildSingleRoomMap(),
00332 [GPT-5-CODEX-MAX-REASONING]     sprites = {},
00333 [GPT-5-CODEX-MAX-REASONING]     assets = {warrior = false, knight = false, potion = false},
00334 [GPT-5-CODEX-MAX-REASONING]     perfDisableEnemies = false,
00335 [GPT-5-CODEX-MAX-REASONING]     perfDisableTextures = false,
00336 [GPT-5-CODEX-MAX-REASONING]     perfDisableProps = true
00337 [GPT-5-CODEX-MAX-REASONING] }
00338 [GPT-5-CODEX-MAX-REASONING] 
00339 [GPT-5-CODEX-MAX-REASONING] LEVEL_SELECT_LIST = {
00340 [GPT-5-CODEX-MAX-REASONING]     {id = 1, label = "1"},
00341 [GPT-5-CODEX-MAX-REASONING]     {id = 2, label = "2"},
00342 [GPT-5-CODEX-MAX-REASONING]     {id = 101, label = "p-1room0-0"},
00343 [GPT-5-CODEX-MAX-REASONING]     {id = 102, label = "p-1room-1-0"},
00344 [GPT-5-CODEX-MAX-REASONING]     {id = 103, label = "p-1room-1-1"}
00345 [GPT-5-CODEX-MAX-REASONING] }
00346 [GPT-5-CODEX-MAX-REASONING] LEVEL_SELECT_COUNT = #LEVEL_SELECT_LIST
00347 [GPT-5-CODEX-MAX-REASONING] function getLevelLabel(levelId)
00348 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #LEVEL_SELECT_LIST do
00349 [GPT-5-CODEX-MAX-REASONING]         local entry = LEVEL_SELECT_LIST[i]
00350 [GPT-5-CODEX-MAX-REASONING]         if entry and entry.id == levelId then
00351 [GPT-5-CODEX-MAX-REASONING]             return entry.label
00352 [GPT-5-CODEX-MAX-REASONING]         end
00353 [GPT-5-CODEX-MAX-REASONING]     end
00354 [GPT-5-CODEX-MAX-REASONING]     return tostring(levelId)
00355 [GPT-5-CODEX-MAX-REASONING] end
00356 [GPT-5-CODEX-MAX-REASONING] map = nil
00357 [GPT-5-CODEX-MAX-REASONING] sprites = nil
00358 [GPT-5-CODEX-MAX-REASONING] wallTiles = nil
00359 [GPT-5-CODEX-MAX-REASONING] 
00360 [GPT-5-CODEX-MAX-REASONING] sinTable = {}
00361 [GPT-5-CODEX-MAX-REASONING] cosTable = {}
00362 [GPT-5-CODEX-MAX-REASONING] for i = 0, 63 do
00363 [GPT-5-CODEX-MAX-REASONING]     local angle = i * 6.28318 / 64
00364 [GPT-5-CODEX-MAX-REASONING]     sinTable[i] = math.sin(angle)
00365 [GPT-5-CODEX-MAX-REASONING]     cosTable[i] = math.cos(angle)
00366 [GPT-5-CODEX-MAX-REASONING] end
00367 [GPT-5-CODEX-MAX-REASONING] 
00368 [GPT-5-CODEX-MAX-REASONING] px = 2.5
00369 [GPT-5-CODEX-MAX-REASONING] py = 2.5
00370 [GPT-5-CODEX-MAX-REASONING] pdir = 0
00371 [GPT-5-CODEX-MAX-REASONING] app_running = true
00372 [GPT-5-CODEX-MAX-REASONING] frameCount = 0
00373 [GPT-5-CODEX-MAX-REASONING] VIEWPORT_H = 240
00374 [GPT-5-CODEX-MAX-REASONING] HORIZON = 120  -- Eye level within viewport
00375 [GPT-5-CODEX-MAX-REASONING] 
00376 [GPT-5-CODEX-MAX-REASONING] -- Game state
00377 [GPT-5-CODEX-MAX-REASONING] isAttacking = 0      -- Attack animation frames remaining
00378 [GPT-5-CODEX-MAX-REASONING] attackTotalFrames = 0 -- Total frames for current attack animation
00379 [GPT-5-CODEX-MAX-REASONING] isBlocking = false   -- Currently blocking
00380 [GPT-5-CODEX-MAX-REASONING] showMenu = false     -- Menu visible
00381 [GPT-5-CODEX-MAX-REASONING] menuSelection = 1    -- Current menu selection
00382 [GPT-5-CODEX-MAX-REASONING] inOptionsMenu = false -- Currently in options submenu
00383 [GPT-5-CODEX-MAX-REASONING] optionsSelection = 1  -- Current options selection
00384 [GPT-5-CODEX-MAX-REASONING] 
00385 [GPT-5-CODEX-MAX-REASONING] -- Options settings
00386 [GPT-5-CODEX-MAX-REASONING] soundEnabled = true   -- Sound on/off
00387 [GPT-5-CODEX-MAX-REASONING] showHealthPercent = true  -- Health % display on/off
00388 [GPT-5-CODEX-MAX-REASONING] 
00389 [GPT-5-CODEX-MAX-REASONING] -- Sound effects
00390 [GPT-5-CODEX-MAX-REASONING]     swordSwooshSynth = nil
00391 [GPT-5-CODEX-MAX-REASONING]     gruntSample = nil
00392 [GPT-5-CODEX-MAX-REASONING]     swordHitSample = nil
00393 [GPT-5-CODEX-MAX-REASONING]     swordMissSample = nil
00394 [GPT-5-CODEX-MAX-REASONING]     yahSample = nil
00395 [GPT-5-CODEX-MAX-REASONING]     winLevelSample = nil
00396 [GPT-5-CODEX-MAX-REASONING]     argDeathSample = nil
00397 [GPT-5-CODEX-MAX-REASONING] audioInitialized = false
00398 [GPT-5-CODEX-MAX-REASONING] audioSystemActive = false
00399 [GPT-5-CODEX-MAX-REASONING] titleSample = nil
00400 [GPT-5-CODEX-MAX-REASONING] titleOverlaySample = nil
00401 [GPT-5-CODEX-MAX-REASONING] titleOverlayPlayed = false
00402 [GPT-5-CODEX-MAX-REASONING] titleMusicStartUs = 0
00403 [GPT-5-CODEX-MAX-REASONING] titleMusicState = "stopped" -- stopped|playing|fading|paused
00404 [GPT-5-CODEX-MAX-REASONING] titleMusicTimer = 0
00405 [GPT-5-CODEX-MAX-REASONING] titleFadeTimer = 0
00406 [GPT-5-CODEX-MAX-REASONING] titlePauseTimer = 0
00407 [GPT-5-CODEX-MAX-REASONING] titlePlayRetryCount = 0
00408 [GPT-5-CODEX-MAX-REASONING] titlePlayRetryTimer = 0
00409 [GPT-5-CODEX-MAX-REASONING] titlePlayConfirmed = false
00410 [GPT-5-CODEX-MAX-REASONING] TITLE_MUSIC_FPS = 60
00411 [GPT-5-CODEX-MAX-REASONING] TITLE_MUSIC_FADE_START_FRAMES = 40 * TITLE_MUSIC_FPS
00412 [GPT-5-CODEX-MAX-REASONING] TITLE_MUSIC_FADE_FRAMES = 5 * TITLE_MUSIC_FPS
00413 [GPT-5-CODEX-MAX-REASONING] TITLE_MUSIC_PAUSE_FRAMES = 2 * TITLE_MUSIC_FPS
00414 [GPT-5-CODEX-MAX-REASONING] TITLE_MUSIC_VOLUME = 1.0
00415 [GPT-5-CODEX-MAX-REASONING] TITLE_OVERLAY_ENABLED = false -- temporary test mode: title music only
00416 [GPT-5-CODEX-MAX-REASONING] TITLE_OVERLAY_DELAY_US = 500000
00417 [GPT-5-CODEX-MAX-REASONING] TITLE_OVERLAY_VOLUME = 1.0
00418 [GPT-5-CODEX-MAX-REASONING] TITLE_PLAY_RETRY_INTERVAL_FRAMES = 30
00419 [GPT-5-CODEX-MAX-REASONING] TITLE_PLAY_MAX_RETRIES = 6
00420 [GPT-5-CODEX-MAX-REASONING] 
00421 [GPT-5-CODEX-MAX-REASONING] -- Enemy attack effects (list of active swipe effects)
00422 [GPT-5-CODEX-MAX-REASONING] swipeEffects = {}  -- {x, y, angle, frame, maxFrames}
00423 [GPT-5-CODEX-MAX-REASONING] 
00424 [GPT-5-CODEX-MAX-REASONING] -- Attack constants
00425 [GPT-5-CODEX-MAX-REASONING] DETECTION_RANGE = 4    -- How far soldier can see player
00426 [GPT-5-CODEX-MAX-REASONING] ATTACK_RANGE = 1.0     -- Distance to attack (about 1 body length)
00427 [GPT-5-CODEX-MAX-REASONING] ATTACK_COOLDOWN = 60   -- Frames between attacks (slowed 2x)
00428 [GPT-5-CODEX-MAX-REASONING] CHASE_SPEED_MULT = 3   -- Speed multiplier when chasing (sprint)
00429 [GPT-5-CODEX-MAX-REASONING] SOLDIER_SPEED_SCALE = 0.125 -- Slow all soldier movement (0.125 = 8x slower)
00430 [GPT-5-CODEX-MAX-REASONING] 
00431 [GPT-5-CODEX-MAX-REASONING] -- Player health system
00432 [GPT-5-CODEX-MAX-REASONING] playerHealth = 100     -- Current health (0-100)
00433 [GPT-5-CODEX-MAX-REASONING] MAX_HEALTH = 100
00434 [GPT-5-CODEX-MAX-REASONING] DAMAGE_PER_HIT = 10
00435 [GPT-5-CODEX-MAX-REASONING] potionSprite = nil
00436 [GPT-5-CODEX-MAX-REASONING] titleSprite = nil
00437 [GPT-5-CODEX-MAX-REASONING] bmpProbeSprite = nil
00438 [GPT-5-CODEX-MAX-REASONING] bmpProbeLoadState = "PENDING"
00439 [GPT-5-CODEX-MAX-REASONING] BMP_PROBE_ENABLED = true
00440 [GPT-5-CODEX-MAX-REASONING] BMP_PROBE_PATH = "sprites/test/mask_guy_idle_old.bmp"
00441 [GPT-5-CODEX-MAX-REASONING] wallStone = nil
00442 [GPT-5-CODEX-MAX-REASONING] wallBrick = nil
00443 [GPT-5-CODEX-MAX-REASONING] wallMoss = nil
00444 [GPT-5-CODEX-MAX-REASONING] wallMetal = nil
00445 [GPT-5-CODEX-MAX-REASONING] wallWood = nil
00446 [GPT-5-CODEX-MAX-REASONING] wallSheets = {}
00447 [GPT-5-CODEX-MAX-REASONING] wallTextureLoadAttempted = false
00448 [GPT-5-CODEX-MAX-REASONING] USE_WALL_QUADS = true
00449 [GPT-5-CODEX-MAX-REASONING] DEBUG_DISABLE_WALL_TEXTURE = false
00450 [GPT-5-CODEX-MAX-REASONING] DEBUG_SKIP_SPRITES = false
00451 [GPT-5-CODEX-MAX-REASONING] WALL_TEXTURE_MODE = "proper" -- proper | lazy_quads | flat
00452 [GPT-5-CODEX-MAX-REASONING] WALL_TEXTURE_PHASE1_STONE_ONLY = true
00453 [GPT-5-CODEX-MAX-REASONING] DEBUG_TEXTURE_LOG = true
00454 [GPT-5-CODEX-MAX-REASONING] renderCfg = {
00455 [GPT-5-CODEX-MAX-REASONING]     rayCols = 60,
00456 [GPT-5-CODEX-MAX-REASONING]     colW = 4,
00457 [GPT-5-CODEX-MAX-REASONING]     fovSteps = 9,
00458 [GPT-5-CODEX-MAX-REASONING]     twoPi = 6.28318,
00459 [GPT-5-CODEX-MAX-REASONING]     skipOddTex = false,
00460 [GPT-5-CODEX-MAX-REASONING] }
00461 [GPT-5-CODEX-MAX-REASONING] DEBUG_WALL_QUADS_LOG = false
00462 [GPT-5-CODEX-MAX-REASONING] wallQuadLogCount = 0
00463 [GPT-5-CODEX-MAX-REASONING] spriteOrderCache = {}
00464 [GPT-5-CODEX-MAX-REASONING] spriteOrderCacheFrame = -1000
00465 [GPT-5-CODEX-MAX-REASONING] PLAYER_RADIUS = 0.50
00466 [GPT-5-CODEX-MAX-REASONING] DEBUG_DISABLE_PROPS = false
00467 [GPT-5-CODEX-MAX-REASONING] WALL_TEX_MAX_DIST = 6.0
00468 [GPT-5-CODEX-MAX-REASONING]   FOG_START = 2.5
00469 [GPT-5-CODEX-MAX-REASONING]   FOG_END = 5.0
00470 [GPT-5-CODEX-MAX-REASONING]   FOG_COLOR = COLOR_DARK_GRAY
00471 [GPT-5-CODEX-MAX-REASONING]   FOG_TEX_CUTOFF = 2.5
00472 [GPT-5-CODEX-MAX-REASONING]   DEBUG_DISABLE_FOG = true
00473 [GPT-5-CODEX-MAX-REASONING] DEBUG_DISABLE_EFFECTS = true
00474 [GPT-5-CODEX-MAX-REASONING] LOW_RES_WALLS = true
00475 [GPT-5-CODEX-MAX-REASONING] LOW_RES_MODE = "quality"
00476 [GPT-5-CODEX-MAX-REASONING] SHOW_MINIMAP = true
00477 [GPT-5-CODEX-MAX-REASONING] RENDERER_MODE = "exp_hybrid" -- classic | exp_hybrid | exp_pure
00478 [GPT-5-CODEX-MAX-REASONING] DEBUG_DISABLE_ENEMIES = false
00479 [GPT-5-CODEX-MAX-REASONING] textureDebugFrame = -1
00480 [GPT-5-CODEX-MAX-REASONING] textureDebugSamples = 0
00481 [GPT-5-CODEX-MAX-REASONING] local function wallQuadLog(msg)
00482 [GPT-5-CODEX-MAX-REASONING]     if enableBootLogs and DEBUG_WALL_QUADS_LOG and wallQuadLogCount < 30 then
00483 [GPT-5-CODEX-MAX-REASONING]         print(msg)
00484 [GPT-5-CODEX-MAX-REASONING]         wallQuadLogCount = wallQuadLogCount + 1
00485 [GPT-5-CODEX-MAX-REASONING]     end
00486 [GPT-5-CODEX-MAX-REASONING] end
00487 [GPT-5-CODEX-MAX-REASONING] local function renderLog(msg)
00488 [GPT-5-CODEX-MAX-REASONING]     if enableBootLogs and DEBUG_WALL_QUADS_LOG then
00489 [GPT-5-CODEX-MAX-REASONING]         print("[RENDER] " .. msg)
00490 [GPT-5-CODEX-MAX-REASONING]     end
00491 [GPT-5-CODEX-MAX-REASONING] end
00492 [GPT-5-CODEX-MAX-REASONING] 
00493 [GPT-5-CODEX-MAX-REASONING] local function textureLog(msg)
00494 [GPT-5-CODEX-MAX-REASONING]     if DEBUG_TEXTURE_LOG and enableBootLogs then
00495 [GPT-5-CODEX-MAX-REASONING]         safeLog("INFO", "[TEX] " .. msg)
00496 [GPT-5-CODEX-MAX-REASONING]     end
00497 [GPT-5-CODEX-MAX-REASONING] end
00498 [GPT-5-CODEX-MAX-REASONING] STATE_TITLE = 0
00499 [GPT-5-CODEX-MAX-REASONING] STATE_PLAYING = 1
00500 [GPT-5-CODEX-MAX-REASONING] STATE_GAME_OVER = 2
00501 [GPT-5-CODEX-MAX-REASONING] STATE_WIN = 3
00502 [GPT-5-CODEX-MAX-REASONING] STATE_LOADING = 4
00503 [GPT-5-CODEX-MAX-REASONING] gameState = STATE_TITLE
00504 [GPT-5-CODEX-MAX-REASONING] titleSelection = 1  -- 1=Start, 2=Options, 3=Exit
00505 [GPT-5-CODEX-MAX-REASONING] titleInOptions = false
00506 [GPT-5-CODEX-MAX-REASONING] titleInDebug = false
00507 [GPT-5-CODEX-MAX-REASONING] titleOptionsSelection = 1
00508 [GPT-5-CODEX-MAX-REASONING] titleDebugSelection = 1
00509 [GPT-5-CODEX-MAX-REASONING] titleNeedsRedraw = true
00510 [GPT-5-CODEX-MAX-REASONING] FPS_TARGET_MODE = "uncapped" -- uncapped | 60 | 30 (gameplay only)
00511 [GPT-5-CODEX-MAX-REASONING] 
00512 [GPT-5-CODEX-MAX-REASONING] local function quitApp(reason)
00513 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "APP EXIT: " .. tostring(reason))
00514 [GPT-5-CODEX-MAX-REASONING]     app_running = false
00515 [GPT-5-CODEX-MAX-REASONING] end
00516 [GPT-5-CODEX-MAX-REASONING] 
00517 [GPT-5-CODEX-MAX-REASONING] local function isExpRenderer()
00518 [GPT-5-CODEX-MAX-REASONING]     return RENDERER_MODE == "exp_hybrid" or RENDERER_MODE == "exp_pure"
00519 [GPT-5-CODEX-MAX-REASONING] end
00520 [GPT-5-CODEX-MAX-REASONING] gameOverSelection = 1  -- 1 = Restart, 2 = Menu, 3 = Quit
00521 [GPT-5-CODEX-MAX-REASONING] winSelection = 1  -- 1 = Menu
00522 [GPT-5-CODEX-MAX-REASONING] winCooldown = 0   -- Delay before accepting win screen input
00523 [GPT-5-CODEX-MAX-REASONING] levelBannerTimer = 0
00524 [GPT-5-CODEX-MAX-REASONING] levelBannerMax = 150
00525 [GPT-5-CODEX-MAX-REASONING] winBannerTimer = 0
00526 [GPT-5-CODEX-MAX-REASONING] winBannerMax = 75
00527 [GPT-5-CODEX-MAX-REASONING] loadingTimer = 0
00528 [GPT-5-CODEX-MAX-REASONING] loadingMax = 45
00529 [GPT-5-CODEX-MAX-REASONING] pendingLevelStart = nil
00530 [GPT-5-CODEX-MAX-REASONING] loadingLogCount = 0
00531 [GPT-5-CODEX-MAX-REASONING] local function loadingLog(msg)
00532 [GPT-5-CODEX-MAX-REASONING]     if loadingLogCount < 20 then
00533 [GPT-5-CODEX-MAX-REASONING]         print(msg)
00534 [GPT-5-CODEX-MAX-REASONING]         loadingLogCount = loadingLogCount + 1
00535 [GPT-5-CODEX-MAX-REASONING]     end
00536 [GPT-5-CODEX-MAX-REASONING] end
00537 [GPT-5-CODEX-MAX-REASONING] 
00538 [GPT-5-CODEX-MAX-REASONING] -- Debug controls (set to true for sprite testing)
00539 [GPT-5-CODEX-MAX-REASONING] DEBUG_DISABLE_ENEMY_AGGRO = false  -- Enemies never chase/attack
00540 [GPT-5-CODEX-MAX-REASONING] DEBUG_WALK_IN_PLACE = false       -- Enemies animate walk without moving
00541 [GPT-5-CODEX-MAX-REASONING] DEBUG_FLIP_WALK_SIDES = false     -- Use left-walk sprites and flip for right side
00542 [GPT-5-CODEX-MAX-REASONING] DEBUG_FORCE_GLOBAL_WALK = false   -- Drive walk frames from global frameCount
00543 [GPT-5-CODEX-MAX-REASONING] DEBUG_FORCE_WALK_FRAMES = nil     -- Force 2-frame cycle while walk3 is under review
00544 [GPT-5-CODEX-MAX-REASONING] DEBUG_FORCE_SIDE_VIEW = false     -- Always show side view (left/right) for testing
00545 [GPT-5-CODEX-MAX-REASONING] DEBUG_FORCE_VIEW = nil            -- Set to 1 (right) or 3 (left) to lock view
00546 [GPT-5-CODEX-MAX-REASONING] DEBUG_SHOW_WALK_INFO = false      -- On-screen walk frame debug
00547 [GPT-5-CODEX-MAX-REASONING] DEBUG_WALK_OFFSET = false         -- Apply visible offset per frame for debugging
00548 [GPT-5-CODEX-MAX-REASONING] DEBUG_CYCLE_VIEW = false          -- Cycle through front/left/back/right for testing
00549 [GPT-5-CODEX-MAX-REASONING] DEBUG_CYCLE_VIEW_FRAMES = 45      -- Frames per view (about 1.5s at 30fps)
00550 [GPT-5-CODEX-MAX-REASONING] 
00551 [GPT-5-CODEX-MAX-REASONING] SPRITE_MAX_DIST = 12
00552 [GPT-5-CODEX-MAX-REASONING] SPRITE_MAX_DIST_SQ = SPRITE_MAX_DIST * SPRITE_MAX_DIST
00553 [GPT-5-CODEX-MAX-REASONING] SPRITE_VIS_DIST = 6
00554 [GPT-5-CODEX-MAX-REASONING] SOLDIER_ACTIVE_DIST = 8
00555 [GPT-5-CODEX-MAX-REASONING] SOLDIER_ACTIVE_DIST_SQ = SOLDIER_ACTIVE_DIST * SOLDIER_ACTIVE_DIST
00556 [GPT-5-CODEX-MAX-REASONING] ENEMY_RENDER_DIST = 7
00557 [GPT-5-CODEX-MAX-REASONING] PROP_RENDER_DIST = 5
00558 [GPT-5-CODEX-MAX-REASONING] ITEM_RENDER_DIST = 5
00559 [GPT-5-CODEX-MAX-REASONING] ENEMY_RENDER_DIST_SQ = ENEMY_RENDER_DIST * ENEMY_RENDER_DIST
00560 [GPT-5-CODEX-MAX-REASONING] PROP_RENDER_DIST_SQ = PROP_RENDER_DIST * PROP_RENDER_DIST
00561 [GPT-5-CODEX-MAX-REASONING] ITEM_RENDER_DIST_SQ = ITEM_RENDER_DIST * ITEM_RENDER_DIST
00562 [GPT-5-CODEX-MAX-REASONING] 
00563 [GPT-5-CODEX-MAX-REASONING] local function isEnemyType(t)
00564 [GPT-5-CODEX-MAX-REASONING]     return t == 5 or t == 6
00565 [GPT-5-CODEX-MAX-REASONING] end
00566 [GPT-5-CODEX-MAX-REASONING] 
00567 [GPT-5-CODEX-MAX-REASONING] local function isPropType(t)
00568 [GPT-5-CODEX-MAX-REASONING]     return (t and t >= 1 and t <= 4) or t == 7
00569 [GPT-5-CODEX-MAX-REASONING] end
00570 [GPT-5-CODEX-MAX-REASONING] 
00571 [GPT-5-CODEX-MAX-REASONING] -- Enemy health system
00572 [GPT-5-CODEX-MAX-REASONING] ENEMY_MAX_HP = 100
00573 [GPT-5-CODEX-MAX-REASONING] PLAYER_DAMAGE = 20
00574 [GPT-5-CODEX-MAX-REASONING] PLAYER_ATTACK_RANGE = 1.0  -- Distance player can hit enemy
00575 [GPT-5-CODEX-MAX-REASONING] soldiersKilled = 0
00576 [GPT-5-CODEX-MAX-REASONING] local totalSoldiers = 5
00577 [GPT-5-CODEX-MAX-REASONING] 
00578 [GPT-5-CODEX-MAX-REASONING] -- Blood particle effects
00579 [GPT-5-CODEX-MAX-REASONING] local bloodEffects = {}  -- {x, y, particles={{dx, dy, life}...}}
00580 [GPT-5-CODEX-MAX-REASONING] 
00581 [GPT-5-CODEX-MAX-REASONING] -- Death sounds
00582 [GPT-5-CODEX-MAX-REASONING] local groanSynth = nil
00583 [GPT-5-CODEX-MAX-REASONING] local squishSynth = nil
00584 [GPT-5-CODEX-MAX-REASONING] 
00585 [GPT-5-CODEX-MAX-REASONING] -- Pickup sounds
00586 [GPT-5-CODEX-MAX-REASONING] local gulpSynth = nil
00587 [GPT-5-CODEX-MAX-REASONING] 
00588 [GPT-5-CODEX-MAX-REASONING] -- Load warrior sprites for 4 directions
00589 [GPT-5-CODEX-MAX-REASONING] local warriorFront = nil
00590 [GPT-5-CODEX-MAX-REASONING] local warriorBack = nil
00591 [GPT-5-CODEX-MAX-REASONING] local warriorLeft = nil
00592 [GPT-5-CODEX-MAX-REASONING] local warriorRight = nil
00593 [GPT-5-CODEX-MAX-REASONING] 
00594 [GPT-5-CODEX-MAX-REASONING] -- Load warrior walking animation sprites (left-facing)
00595 [GPT-5-CODEX-MAX-REASONING] -- Note: walk3 is missing and needs AI generation - using 2-frame cycle for now
00596 [GPT-5-CODEX-MAX-REASONING] local warriorWalk1 = nil
00597 [GPT-5-CODEX-MAX-REASONING] local warriorWalk2 = nil
00598 [GPT-5-CODEX-MAX-REASONING] local warriorWalk3 = nil
00599 [GPT-5-CODEX-MAX-REASONING] local warriorWalk1Front = nil
00600 [GPT-5-CODEX-MAX-REASONING] local warriorWalk2Front = nil
00601 [GPT-5-CODEX-MAX-REASONING] local warriorWalk3Front = nil
00602 [GPT-5-CODEX-MAX-REASONING] local warriorWalk1Back = nil
00603 [GPT-5-CODEX-MAX-REASONING] local warriorWalk2Back = nil
00604 [GPT-5-CODEX-MAX-REASONING] local warriorWalk3Back = nil
00605 [GPT-5-CODEX-MAX-REASONING] -- Load warrior walking animation sprites (right-facing, flipped)
00606 [GPT-5-CODEX-MAX-REASONING] local warriorWalk1R = nil
00607 [GPT-5-CODEX-MAX-REASONING] local warriorWalk2R = nil
00608 [GPT-5-CODEX-MAX-REASONING] local warriorWalk3R = nil
00609 [GPT-5-CODEX-MAX-REASONING] local warriorDeath = {}
00610 [GPT-5-CODEX-MAX-REASONING] local swordAttack = {}
00611 [GPT-5-CODEX-MAX-REASONING] local warriorAttackFront = {}
00612 [GPT-5-CODEX-MAX-REASONING] local warriorAttackBack = {}
00613 [GPT-5-CODEX-MAX-REASONING] local warriorAttackLeft = {}
00614 [GPT-5-CODEX-MAX-REASONING] local warriorAttackRight = {}
00615 [GPT-5-CODEX-MAX-REASONING] 
00616 [GPT-5-CODEX-MAX-REASONING] -- Load knight sprites for 4 directions
00617 [GPT-5-CODEX-MAX-REASONING] local knightFront = nil
00618 [GPT-5-CODEX-MAX-REASONING] local knightBack = nil
00619 [GPT-5-CODEX-MAX-REASONING] local knightLeft = nil
00620 [GPT-5-CODEX-MAX-REASONING] local knightRight = nil
00621 [GPT-5-CODEX-MAX-REASONING] 
00622 [GPT-5-CODEX-MAX-REASONING] local function deepCopy(value)
00623 [GPT-5-CODEX-MAX-REASONING]     if type(value) ~= "table" then
00624 [GPT-5-CODEX-MAX-REASONING]         return value
00625 [GPT-5-CODEX-MAX-REASONING]     end
00626 [GPT-5-CODEX-MAX-REASONING]     local out = {}
00627 [GPT-5-CODEX-MAX-REASONING]     local len = #value
00628 [GPT-5-CODEX-MAX-REASONING]     if len > 0 then
00629 [GPT-5-CODEX-MAX-REASONING]         for i = 1, len do
00630 [GPT-5-CODEX-MAX-REASONING]             out[i] = deepCopy(value[i])
00631 [GPT-5-CODEX-MAX-REASONING]         end
00632 [GPT-5-CODEX-MAX-REASONING]         for k, v in pairs(value) do
00633 [GPT-5-CODEX-MAX-REASONING]             if type(k) ~= "number" then
00634 [GPT-5-CODEX-MAX-REASONING]                 out[k] = deepCopy(v)
00635 [GPT-5-CODEX-MAX-REASONING]             end
00636 [GPT-5-CODEX-MAX-REASONING]         end
00637 [GPT-5-CODEX-MAX-REASONING]     else
00638 [GPT-5-CODEX-MAX-REASONING]         for k, v in pairs(value) do
00639 [GPT-5-CODEX-MAX-REASONING]             out[k] = deepCopy(v)
00640 [GPT-5-CODEX-MAX-REASONING]         end
00641 [GPT-5-CODEX-MAX-REASONING]     end
00642 [GPT-5-CODEX-MAX-REASONING]     return out
00643 [GPT-5-CODEX-MAX-REASONING] end
00644 [GPT-5-CODEX-MAX-REASONING] 
00645 [GPT-5-CODEX-MAX-REASONING] local function countEnemies(spriteList)
00646 [GPT-5-CODEX-MAX-REASONING]     local count = 0
00647 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #spriteList do
00648 [GPT-5-CODEX-MAX-REASONING]         local s = spriteList[i]
00649 [GPT-5-CODEX-MAX-REASONING]         if s.t == 5 or s.t == 6 then
00650 [GPT-5-CODEX-MAX-REASONING]             count = count + 1
00651 [GPT-5-CODEX-MAX-REASONING]         end
00652 [GPT-5-CODEX-MAX-REASONING]     end
00653 [GPT-5-CODEX-MAX-REASONING]     return count
00654 [GPT-5-CODEX-MAX-REASONING] end
00655 [GPT-5-CODEX-MAX-REASONING] 
00656 [GPT-5-CODEX-MAX-REASONING] local function loadLevel(levelId)
00657 [GPT-5-CODEX-MAX-REASONING]     local level = LEVELS[levelId]
00658 [GPT-5-CODEX-MAX-REASONING]     if not level then return end
00659 [GPT-5-CODEX-MAX-REASONING]     currentLevel = levelId
00660 [GPT-5-CODEX-MAX-REASONING]     if level.perfDisableEnemies ~= nil then
00661 [GPT-5-CODEX-MAX-REASONING]         DEBUG_DISABLE_ENEMIES = level.perfDisableEnemies
00662 [GPT-5-CODEX-MAX-REASONING]     end
00663 [GPT-5-CODEX-MAX-REASONING]     if level.perfDisableTextures ~= nil then
00664 [GPT-5-CODEX-MAX-REASONING]         DEBUG_DISABLE_WALL_TEXTURE = level.perfDisableTextures
00665 [GPT-5-CODEX-MAX-REASONING]     end
00666 [GPT-5-CODEX-MAX-REASONING]     if level.perfDisableProps ~= nil then
00667 [GPT-5-CODEX-MAX-REASONING]         DEBUG_DISABLE_PROPS = level.perfDisableProps
00668 [GPT-5-CODEX-MAX-REASONING]     end
00669 [GPT-5-CODEX-MAX-REASONING]     if type(level.name) == "string" and level.name:sub(1, 2) == "p-" then
00670 [GPT-5-CODEX-MAX-REASONING]         enableBootLogs = false
00671 [GPT-5-CODEX-MAX-REASONING]         DEBUG_WALL_QUADS_LOG = false
00672 [GPT-5-CODEX-MAX-REASONING]     end
00673 [GPT-5-CODEX-MAX-REASONING]     map = deepCopy(level.map)
00674 [GPT-5-CODEX-MAX-REASONING]     sprites = deepCopy(level.sprites)
00675 [GPT-5-CODEX-MAX-REASONING]     local function isOpenFloor(mx, my)
00676 [GPT-5-CODEX-MAX-REASONING]         if mx < 1 or mx > 14 or my < 1 or my > 14 then return false end
00677 [GPT-5-CODEX-MAX-REASONING]         if map[my + 1][mx + 1] ~= 0 then return false end
00678 [GPT-5-CODEX-MAX-REASONING]         if map[my + 1][mx] ~= 0 then return false end
00679 [GPT-5-CODEX-MAX-REASONING]         if map[my + 1][mx + 2] ~= 0 then return false end
00680 [GPT-5-CODEX-MAX-REASONING]         if map[my][mx + 1] ~= 0 then return false end
00681 [GPT-5-CODEX-MAX-REASONING]         if map[my + 2][mx + 1] ~= 0 then return false end
00682 [GPT-5-CODEX-MAX-REASONING]         return true
00683 [GPT-5-CODEX-MAX-REASONING]     end
00684 [GPT-5-CODEX-MAX-REASONING]     local function tileAt(mx, my)
00685 [GPT-5-CODEX-MAX-REASONING]         if mx < 0 or mx > 15 or my < 0 or my > 15 then
00686 [GPT-5-CODEX-MAX-REASONING]             return 1
00687 [GPT-5-CODEX-MAX-REASONING]         end
00688 [GPT-5-CODEX-MAX-REASONING]         return map[my + 1][mx + 1] or 1
00689 [GPT-5-CODEX-MAX-REASONING]     end
00690 [GPT-5-CODEX-MAX-REASONING]     local function isDoorwayTile(mx, my)
00691 [GPT-5-CODEX-MAX-REASONING]         local n = tileAt(mx, my - 1) > 0
00692 [GPT-5-CODEX-MAX-REASONING]         local s = tileAt(mx, my + 1) > 0
00693 [GPT-5-CODEX-MAX-REASONING]         local w = tileAt(mx - 1, my) > 0
00694 [GPT-5-CODEX-MAX-REASONING]         local e = tileAt(mx + 1, my) > 0
00695 [GPT-5-CODEX-MAX-REASONING]         return (n and s and not e and not w) or (e and w and not n and not s)
00696 [GPT-5-CODEX-MAX-REASONING]     end
00697 [GPT-5-CODEX-MAX-REASONING]     local function isWallAttached(mx, my)
00698 [GPT-5-CODEX-MAX-REASONING]         if tileAt(mx, my) ~= 0 then return false end
00699 [GPT-5-CODEX-MAX-REASONING]         local n = tileAt(mx, my - 1) > 0
00700 [GPT-5-CODEX-MAX-REASONING]         local s = tileAt(mx, my + 1) > 0
00701 [GPT-5-CODEX-MAX-REASONING]         local w = tileAt(mx - 1, my) > 0
00702 [GPT-5-CODEX-MAX-REASONING]         local e = tileAt(mx + 1, my) > 0
00703 [GPT-5-CODEX-MAX-REASONING]         if isDoorwayTile(mx, my) then return false end
00704 [GPT-5-CODEX-MAX-REASONING]         -- Require a nearby wall, but avoid pure hallway gaps
00705 [GPT-5-CODEX-MAX-REASONING]         if (n and s and not e and not w) or (e and w and not n and not s) then
00706 [GPT-5-CODEX-MAX-REASONING]             return false
00707 [GPT-5-CODEX-MAX-REASONING]         end
00708 [GPT-5-CODEX-MAX-REASONING]         return n or s or w or e
00709 [GPT-5-CODEX-MAX-REASONING]     end
00710 [GPT-5-CODEX-MAX-REASONING]     if sprites then
00711 [GPT-5-CODEX-MAX-REASONING]         local filteredFloor = {}
00712 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #sprites do
00713 [GPT-5-CODEX-MAX-REASONING]             local s = sprites[i]
00714 [GPT-5-CODEX-MAX-REASONING]             if s and (s.t == 1 or s.t == 2 or s.t == 3 or s.t == 4) then
00715 [GPT-5-CODEX-MAX-REASONING]                 local mx = math.floor(s.x)
00716 [GPT-5-CODEX-MAX-REASONING]                 local my = math.floor(s.y)
00717 [GPT-5-CODEX-MAX-REASONING]                 if isWallAttached(mx, my) then
00718 [GPT-5-CODEX-MAX-REASONING]                     filteredFloor[#filteredFloor + 1] = s
00719 [GPT-5-CODEX-MAX-REASONING]                 end
00720 [GPT-5-CODEX-MAX-REASONING]             elseif s and (s.t == 7 or s.t == 8) then
00721 [GPT-5-CODEX-MAX-REASONING]                 local mx = math.floor(s.x)
00722 [GPT-5-CODEX-MAX-REASONING]                 local my = math.floor(s.y)
00723 [GPT-5-CODEX-MAX-REASONING]                 if isOpenFloor(mx, my) then
00724 [GPT-5-CODEX-MAX-REASONING]                     filteredFloor[#filteredFloor + 1] = s
00725 [GPT-5-CODEX-MAX-REASONING]                 end
00726 [GPT-5-CODEX-MAX-REASONING]             else
00727 [GPT-5-CODEX-MAX-REASONING]                 filteredFloor[#filteredFloor + 1] = s
00728 [GPT-5-CODEX-MAX-REASONING]             end
00729 [GPT-5-CODEX-MAX-REASONING]         end
00730 [GPT-5-CODEX-MAX-REASONING]         sprites = filteredFloor
00731 [GPT-5-CODEX-MAX-REASONING]     end
00732 [GPT-5-CODEX-MAX-REASONING]     if DEBUG_DISABLE_PROPS then
00733 [GPT-5-CODEX-MAX-REASONING]         local filtered = {}
00734 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #sprites do
00735 [GPT-5-CODEX-MAX-REASONING]             local s = sprites[i]
00736 [GPT-5-CODEX-MAX-REASONING]             if s.t == 7 or not isPropType(s.t) then
00737 [GPT-5-CODEX-MAX-REASONING]                 filtered[#filtered + 1] = s
00738 [GPT-5-CODEX-MAX-REASONING]             end
00739 [GPT-5-CODEX-MAX-REASONING]         end
00740 [GPT-5-CODEX-MAX-REASONING]         sprites = filtered
00741 [GPT-5-CODEX-MAX-REASONING]     end
00742 [GPT-5-CODEX-MAX-REASONING]     totalSoldiers = countEnemies(sprites)
00743 [GPT-5-CODEX-MAX-REASONING]     px = level.playerStart.x
00744 [GPT-5-CODEX-MAX-REASONING]     py = level.playerStart.y
00745 [GPT-5-CODEX-MAX-REASONING]     pdir = level.playerStart.dir
00746 [GPT-5-CODEX-MAX-REASONING]     wallTiles = {}
00747 [GPT-5-CODEX-MAX-REASONING]     for my = 0, 15 do
00748 [GPT-5-CODEX-MAX-REASONING]         for mx = 0, 15 do
00749 [GPT-5-CODEX-MAX-REASONING]             local wtype = map[my + 1][mx + 1]
00750 [GPT-5-CODEX-MAX-REASONING]             if wtype and wtype > 0 then
00751 [GPT-5-CODEX-MAX-REASONING]                 wallTiles[#wallTiles + 1] = {
00752 [GPT-5-CODEX-MAX-REASONING]                     x = mx + 0.5,
00753 [GPT-5-CODEX-MAX-REASONING]                     y = my + 0.5,
00754 [GPT-5-CODEX-MAX-REASONING]                     t = wtype
00755 [GPT-5-CODEX-MAX-REASONING]                 }
00756 [GPT-5-CODEX-MAX-REASONING]             end
00757 [GPT-5-CODEX-MAX-REASONING]         end
00758 [GPT-5-CODEX-MAX-REASONING]     end
00759 [GPT-5-CODEX-MAX-REASONING]     wallQuadLog("WQ loadLevel " .. tostring(levelId) .. " wallTiles=" .. tostring(#wallTiles))
00760 [GPT-5-CODEX-MAX-REASONING] end
00761 [GPT-5-CODEX-MAX-REASONING] 
00762 [GPT-5-CODEX-MAX-REASONING] local function unloadLevelData()
00763 [GPT-5-CODEX-MAX-REASONING]     map = nil
00764 [GPT-5-CODEX-MAX-REASONING]     sprites = nil
00765 [GPT-5-CODEX-MAX-REASONING]     totalSoldiers = 0
00766 [GPT-5-CODEX-MAX-REASONING] end
00767 [GPT-5-CODEX-MAX-REASONING] 
00768 [GPT-5-CODEX-MAX-REASONING] local function freeSpriteRef(sprite)
00769 [GPT-5-CODEX-MAX-REASONING]     if sprite then
00770 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.free(sprite)
00771 [GPT-5-CODEX-MAX-REASONING]     end
00772 [GPT-5-CODEX-MAX-REASONING] end
00773 [GPT-5-CODEX-MAX-REASONING] 
00774 [GPT-5-CODEX-MAX-REASONING] local function unloadMenuSprites()
00775 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(titleSprite)
00776 [GPT-5-CODEX-MAX-REASONING]     titleSprite = nil
00777 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(bmpProbeSprite)
00778 [GPT-5-CODEX-MAX-REASONING]     bmpProbeSprite = nil
00779 [GPT-5-CODEX-MAX-REASONING]     bmpProbeLoadState = "PENDING"
00780 [GPT-5-CODEX-MAX-REASONING] end
00781 [GPT-5-CODEX-MAX-REASONING] 
00782 [GPT-5-CODEX-MAX-REASONING] local function unloadLevelSprites()
00783 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorFront); warriorFront = nil
00784 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorBack); warriorBack = nil
00785 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorLeft); warriorLeft = nil
00786 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorRight); warriorRight = nil
00787 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk1); warriorWalk1 = nil
00788 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk2); warriorWalk2 = nil
00789 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk3); warriorWalk3 = nil
00790 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk1Front); warriorWalk1Front = nil
00791 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk2Front); warriorWalk2Front = nil
00792 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk3Front); warriorWalk3Front = nil
00793 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk1Back); warriorWalk1Back = nil
00794 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk2Back); warriorWalk2Back = nil
00795 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk3Back); warriorWalk3Back = nil
00796 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk1R); warriorWalk1R = nil
00797 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk2R); warriorWalk2R = nil
00798 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(warriorWalk3R); warriorWalk3R = nil
00799 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #warriorDeath do
00800 [GPT-5-CODEX-MAX-REASONING]         freeSpriteRef(warriorDeath[i])
00801 [GPT-5-CODEX-MAX-REASONING]     end
00802 [GPT-5-CODEX-MAX-REASONING]     warriorDeath = {}
00803 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #swordAttack do
00804 [GPT-5-CODEX-MAX-REASONING]         freeSpriteRef(swordAttack[i])
00805 [GPT-5-CODEX-MAX-REASONING]     end
00806 [GPT-5-CODEX-MAX-REASONING]     swordAttack = {}
00807 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #warriorAttackFront do
00808 [GPT-5-CODEX-MAX-REASONING]         freeSpriteRef(warriorAttackFront[i])
00809 [GPT-5-CODEX-MAX-REASONING]     end
00810 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #warriorAttackBack do
00811 [GPT-5-CODEX-MAX-REASONING]         freeSpriteRef(warriorAttackBack[i])
00812 [GPT-5-CODEX-MAX-REASONING]     end
00813 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #warriorAttackLeft do
00814 [GPT-5-CODEX-MAX-REASONING]         freeSpriteRef(warriorAttackLeft[i])
00815 [GPT-5-CODEX-MAX-REASONING]     end
00816 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #warriorAttackRight do
00817 [GPT-5-CODEX-MAX-REASONING]         freeSpriteRef(warriorAttackRight[i])
00818 [GPT-5-CODEX-MAX-REASONING]     end
00819 [GPT-5-CODEX-MAX-REASONING]     warriorAttackFront = {}
00820 [GPT-5-CODEX-MAX-REASONING]     warriorAttackBack = {}
00821 [GPT-5-CODEX-MAX-REASONING]     warriorAttackLeft = {}
00822 [GPT-5-CODEX-MAX-REASONING]     warriorAttackRight = {}
00823 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(knightFront); knightFront = nil
00824 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(knightBack); knightBack = nil
00825 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(knightLeft); knightLeft = nil
00826 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(knightRight); knightRight = nil
00827 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(potionSprite); potionSprite = nil
00828 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallStone); wallStone = nil
00829 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallBrick); wallBrick = nil
00830 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallMoss); wallMoss = nil
00831 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallMetal); wallMetal = nil
00832 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallWood); wallWood = nil
00833 [GPT-5-CODEX-MAX-REASONING]     for _, sheet in pairs(wallSheets) do
00834 [GPT-5-CODEX-MAX-REASONING]         if sheet then
00835 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.free(sheet)
00836 [GPT-5-CODEX-MAX-REASONING]         end
00837 [GPT-5-CODEX-MAX-REASONING]     end
00838 [GPT-5-CODEX-MAX-REASONING]     wallSheets = {}
00839 [GPT-5-CODEX-MAX-REASONING]     wallTextureLoadAttempted = false
00840 [GPT-5-CODEX-MAX-REASONING] end
00841 [GPT-5-CODEX-MAX-REASONING] 
00842 [GPT-5-CODEX-MAX-REASONING] local function loadMenuSprites()
00843 [GPT-5-CODEX-MAX-REASONING]     if not titleSprite then
00844 [GPT-5-CODEX-MAX-REASONING]         titleSprite = vmupro.sprite.new("sprites/title")
00845 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(titleSprite, "loadMenuSprites") then
00846 [GPT-5-CODEX-MAX-REASONING]             safeLog("ERROR", "Failed to load title sprite")
00847 [GPT-5-CODEX-MAX-REASONING]             titleSprite = nil
00848 [GPT-5-CODEX-MAX-REASONING]         end
00849 [GPT-5-CODEX-MAX-REASONING]     end
00850 [GPT-5-CODEX-MAX-REASONING] 
00851 [GPT-5-CODEX-MAX-REASONING]     if BMP_PROBE_ENABLED and not bmpProbeSprite and bmpProbeLoadState ~= "FAILED" then
00852 [GPT-5-CODEX-MAX-REASONING]         local okBmp, bmp = pcall(vmupro.sprite.new, BMP_PROBE_PATH)
00853 [GPT-5-CODEX-MAX-REASONING]         if not okBmp or not validateSprite(bmp, "bmpProbe:pathWithExt") then
00854 [GPT-5-CODEX-MAX-REASONING]             local fallbackPath = string.gsub(BMP_PROBE_PATH, "%.bmp$", "")
00855 [GPT-5-CODEX-MAX-REASONING]             local okFallback, bmpFallback = pcall(vmupro.sprite.new, fallbackPath)
00856 [GPT-5-CODEX-MAX-REASONING]             if okFallback and validateSprite(bmpFallback, "bmpProbe:pathNoExt") then
00857 [GPT-5-CODEX-MAX-REASONING]                 bmpProbeSprite = bmpFallback
00858 [GPT-5-CODEX-MAX-REASONING]                 bmpProbeLoadState = "OK"
00859 [GPT-5-CODEX-MAX-REASONING]                 safeLog("INFO", "BMP probe loaded from fallback path: " .. tostring(fallbackPath))
00860 [GPT-5-CODEX-MAX-REASONING]             else
00861 [GPT-5-CODEX-MAX-REASONING]                 bmpProbeLoadState = "FAILED"
00862 [GPT-5-CODEX-MAX-REASONING]                 safeLog("ERROR", "BMP probe failed to load from both paths: " .. tostring(BMP_PROBE_PATH))
00863 [GPT-5-CODEX-MAX-REASONING]             end
00864 [GPT-5-CODEX-MAX-REASONING]         else
00865 [GPT-5-CODEX-MAX-REASONING]             bmpProbeSprite = bmp
00866 [GPT-5-CODEX-MAX-REASONING]             bmpProbeLoadState = "OK"
00867 [GPT-5-CODEX-MAX-REASONING]             safeLog("INFO", "BMP probe loaded: " .. tostring(BMP_PROBE_PATH))
00868 [GPT-5-CODEX-MAX-REASONING]         end
00869 [GPT-5-CODEX-MAX-REASONING]     end
00870 [GPT-5-CODEX-MAX-REASONING] end
00871 [GPT-5-CODEX-MAX-REASONING] 
00872 [GPT-5-CODEX-MAX-REASONING] local function drawBmpProbeOverlay()
00873 [GPT-5-CODEX-MAX-REASONING]     if not BMP_PROBE_ENABLED then
00874 [GPT-5-CODEX-MAX-REASONING]         return
00875 [GPT-5-CODEX-MAX-REASONING]     end
00876 [GPT-5-CODEX-MAX-REASONING] 
00877 [GPT-5-CODEX-MAX-REASONING]     local label = "BMP PENDING"
00878 [GPT-5-CODEX-MAX-REASONING]     local color = COLOR_YELLOW
00879 [GPT-5-CODEX-MAX-REASONING]     if bmpProbeSprite and bmpProbeLoadState == "OK" then
00880 [GPT-5-CODEX-MAX-REASONING]         label = "BMP OK"
00881 [GPT-5-CODEX-MAX-REASONING]         color = COLOR_GREEN
00882 [GPT-5-CODEX-MAX-REASONING]     elseif bmpProbeLoadState == "FAILED" then
00883 [GPT-5-CODEX-MAX-REASONING]         label = "BMP FAIL"
00884 [GPT-5-CODEX-MAX-REASONING]         color = COLOR_RED
00885 [GPT-5-CODEX-MAX-REASONING]     end
00886 [GPT-5-CODEX-MAX-REASONING] 
00887 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(2, 2, 110, 50, COLOR_BLACK)
00888 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawLine(2, 2, 110, 2, color)
00889 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawLine(2, 50, 110, 50, color)
00890 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawLine(2, 2, 2, 50, color)
00891 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawLine(110, 2, 110, 50, color)
00892 [GPT-5-CODEX-MAX-REASONING]     if bmpProbeSprite then
00893 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.draw(bmpProbeSprite, 6, 6, vmupro.sprite.kImageUnflipped)
00894 [GPT-5-CODEX-MAX-REASONING]     end
00895 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_SMALL)
00896 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText(label, 42, 8, color, COLOR_BLACK)
00897 [GPT-5-CODEX-MAX-REASONING] end
00898 [GPT-5-CODEX-MAX-REASONING] 
00899 [GPT-5-CODEX-MAX-REASONING] -- Texture metadata and loaders (forward-declared for use in loadLevelSprites)
00900 [GPT-5-CODEX-MAX-REASONING] local textureMetadata = {}
00901 [GPT-5-CODEX-MAX-REASONING] local loadTextureWithValidation
00902 [GPT-5-CODEX-MAX-REASONING] local loadTextureSheetWithValidation
00903 [GPT-5-CODEX-MAX-REASONING] local logTextureMemoryUsage
00904 [GPT-5-CODEX-MAX-REASONING] 
00905 [GPT-5-CODEX-MAX-REASONING] function loadWallTextures()
00906 [GPT-5-CODEX-MAX-REASONING]     if wallTextureLoadAttempted then return end
00907 [GPT-5-CODEX-MAX-REASONING]     wallTextureLoadAttempted = true
00908 [GPT-5-CODEX-MAX-REASONING]     -- Load wall textures with validation
00909 [GPT-5-CODEX-MAX-REASONING]     wallStone = loadTextureWithValidation("sprites/wall_textures/stone", "stone")
00910 [GPT-5-CODEX-MAX-REASONING]     wallBrick = loadTextureWithValidation("sprites/wall_textures/brick", "brick")
00911 [GPT-5-CODEX-MAX-REASONING]     wallMoss = loadTextureWithValidation("sprites/wall_textures/moss", "moss")
00912 [GPT-5-CODEX-MAX-REASONING]     wallMetal = loadTextureWithValidation("sprites/wall_textures/metal", "metal")
00913 [GPT-5-CODEX-MAX-REASONING]     wallWood = loadTextureWithValidation("sprites/wall_textures/wood", "wood")
00914 [GPT-5-CODEX-MAX-REASONING] 
00915 [GPT-5-CODEX-MAX-REASONING]     -- Optional per-column wall texture sheets (filename pattern: <name>-table-1-128)
00916 [GPT-5-CODEX-MAX-REASONING]     wallSheets.stone = loadTextureSheetWithValidation("sprites/wall_textures/stone-table-1-128", "stone_sheet")
00917 [GPT-5-CODEX-MAX-REASONING]     if wallSheets.stone and wallSheets.stone.frameCount == 128 then
00918 [GPT-5-CODEX-MAX-REASONING]         safeLog("INFO", "Stone texture loaded correctly: 128 frames")
00919 [GPT-5-CODEX-MAX-REASONING]     else
00920 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", "Stone texture frameCount mismatch: " ..
00921 [GPT-5-CODEX-MAX-REASONING]             tostring(wallSheets.stone and wallSheets.stone.frameCount or "nil"))
00922 [GPT-5-CODEX-MAX-REASONING]     end
00923 [GPT-5-CODEX-MAX-REASONING] 
00924 [GPT-5-CODEX-MAX-REASONING]     if WALL_TEXTURE_PHASE1_STONE_ONLY then
00925 [GPT-5-CODEX-MAX-REASONING]         wallSheets.brick = nil
00926 [GPT-5-CODEX-MAX-REASONING]         wallSheets.moss = nil
00927 [GPT-5-CODEX-MAX-REASONING]         wallSheets.metal = nil
00928 [GPT-5-CODEX-MAX-REASONING]         wallSheets.wood = nil
00929 [GPT-5-CODEX-MAX-REASONING]         safeLog("INFO", "Wall texture Phase 1 enabled: stone sheet test only, others use fallback")
00930 [GPT-5-CODEX-MAX-REASONING]     else
00931 [GPT-5-CODEX-MAX-REASONING]         wallSheets.brick = loadTextureSheetWithValidation("sprites/wall_textures/brick-table-1-128", "brick_sheet")
00932 [GPT-5-CODEX-MAX-REASONING]         wallSheets.moss = loadTextureSheetWithValidation("sprites/wall_textures/moss-table-1-128", "moss_sheet")
00933 [GPT-5-CODEX-MAX-REASONING]         wallSheets.metal = loadTextureSheetWithValidation("sprites/wall_textures/metal-table-1-128", "metal_sheet")
00934 [GPT-5-CODEX-MAX-REASONING]         wallSheets.wood = loadTextureSheetWithValidation("sprites/wall_textures/wood-table-1-128", "wood_sheet")
00935 [GPT-5-CODEX-MAX-REASONING]     end
00936 [GPT-5-CODEX-MAX-REASONING] 
00937 [GPT-5-CODEX-MAX-REASONING]     -- Log total texture memory usage
00938 [GPT-5-CODEX-MAX-REASONING]     logTextureMemoryUsage()
00939 [GPT-5-CODEX-MAX-REASONING] end
00940 [GPT-5-CODEX-MAX-REASONING] 
00941 [GPT-5-CODEX-MAX-REASONING] function unloadWallTextures()
00942 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallStone); wallStone = nil
00943 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallBrick); wallBrick = nil
00944 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallMoss); wallMoss = nil
00945 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallMetal); wallMetal = nil
00946 [GPT-5-CODEX-MAX-REASONING]     freeSpriteRef(wallWood); wallWood = nil
00947 [GPT-5-CODEX-MAX-REASONING]     for _, sheet in pairs(wallSheets) do
00948 [GPT-5-CODEX-MAX-REASONING]         if sheet then
00949 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.free(sheet)
00950 [GPT-5-CODEX-MAX-REASONING]         end
00951 [GPT-5-CODEX-MAX-REASONING]     end
00952 [GPT-5-CODEX-MAX-REASONING]     wallSheets = {}
00953 [GPT-5-CODEX-MAX-REASONING]     wallTextureLoadAttempted = false
00954 [GPT-5-CODEX-MAX-REASONING] end
00955 [GPT-5-CODEX-MAX-REASONING] 
00956 [GPT-5-CODEX-MAX-REASONING] local function loadLevelSprites(levelId)
00957 [GPT-5-CODEX-MAX-REASONING]     local level = LEVELS[levelId]
00958 [GPT-5-CODEX-MAX-REASONING]     local assets = level and level.assets or {}
00959 [GPT-5-CODEX-MAX-REASONING]     local base = (level and level.assetBase) or "sprites/"
00960 [GPT-5-CODEX-MAX-REASONING] 
00961 [GPT-5-CODEX-MAX-REASONING]     if assets.warrior then
00962 [GPT-5-CODEX-MAX-REASONING]         warriorFront = vmupro.sprite.new(base .. "warrior_front")
00963 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(warriorFront, "warriorFront") then warriorFront = nil end
00964 [GPT-5-CODEX-MAX-REASONING]         warriorBack = vmupro.sprite.new(base .. "warrior_back")
00965 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(warriorBack, "warriorBack") then warriorBack = nil end
00966 [GPT-5-CODEX-MAX-REASONING]         warriorLeft = vmupro.sprite.new(base .. "warrior_left")
00967 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(warriorLeft, "warriorLeft") then warriorLeft = nil end
00968 [GPT-5-CODEX-MAX-REASONING]         warriorRight = vmupro.sprite.new(base .. "warrior_right")
00969 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(warriorRight, "warriorRight") then warriorRight = nil end
00970 [GPT-5-CODEX-MAX-REASONING]         warriorWalk1 = vmupro.sprite.new(base .. "warrior_walk1")
00971 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(warriorWalk1, "warriorWalk1") then warriorWalk1 = nil end
00972 [GPT-5-CODEX-MAX-REASONING]         warriorWalk2 = vmupro.sprite.new(base .. "warrior_walk2")
00973 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(warriorWalk2, "warriorWalk2") then warriorWalk2 = nil end
00974 [GPT-5-CODEX-MAX-REASONING]         local okWalkFront1, spriteWalkFront1 = pcall(vmupro.sprite.new, base .. "warrior_walk1_front")
00975 [GPT-5-CODEX-MAX-REASONING]         if okWalkFront1 then
00976 [GPT-5-CODEX-MAX-REASONING]             warriorWalk1Front = spriteWalkFront1
00977 [GPT-5-CODEX-MAX-REASONING]             if not validateSprite(warriorWalk1Front, "warriorWalk1Front") then warriorWalk1Front = nil end
00978 [GPT-5-CODEX-MAX-REASONING]         end
00979 [GPT-5-CODEX-MAX-REASONING]         local okWalkFront2, spriteWalkFront2 = pcall(vmupro.sprite.new, base .. "warrior_walk2_front")
00980 [GPT-5-CODEX-MAX-REASONING]         if okWalkFront2 then warriorWalk2Front = spriteWalkFront2 end
00981 [GPT-5-CODEX-MAX-REASONING]         local okWalkFront3, spriteWalkFront3 = pcall(vmupro.sprite.new, base .. "warrior_walk3_front")
00982 [GPT-5-CODEX-MAX-REASONING]         if okWalkFront3 then warriorWalk3Front = spriteWalkFront3 end
00983 [GPT-5-CODEX-MAX-REASONING]         local okWalkBack1, spriteWalkBack1 = pcall(vmupro.sprite.new, base .. "warrior_walk1_back")
00984 [GPT-5-CODEX-MAX-REASONING]         if okWalkBack1 then warriorWalk1Back = spriteWalkBack1 end
00985 [GPT-5-CODEX-MAX-REASONING]         local okWalkBack2, spriteWalkBack2 = pcall(vmupro.sprite.new, base .. "warrior_walk2_back")
00986 [GPT-5-CODEX-MAX-REASONING]         if okWalkBack2 then warriorWalk2Back = spriteWalkBack2 end
00987 [GPT-5-CODEX-MAX-REASONING]         local okWalkBack3, spriteWalkBack3 = pcall(vmupro.sprite.new, base .. "warrior_walk3_back")
00988 [GPT-5-CODEX-MAX-REASONING]         if okWalkBack3 then warriorWalk3Back = spriteWalkBack3 end
00989 [GPT-5-CODEX-MAX-REASONING]         -- Optional: walk3 frames (guard against missing assets)
00990 [GPT-5-CODEX-MAX-REASONING]         local okWalk3, spriteWalk3 = pcall(vmupro.sprite.new, base .. "warrior_walk3")
00991 [GPT-5-CODEX-MAX-REASONING]         if okWalk3 then warriorWalk3 = spriteWalk3 end
00992 [GPT-5-CODEX-MAX-REASONING]         warriorWalk1R = vmupro.sprite.new(base .. "warrior_walk1_r")
00993 [GPT-5-CODEX-MAX-REASONING]         warriorWalk2R = vmupro.sprite.new(base .. "warrior_walk2_r")
00994 [GPT-5-CODEX-MAX-REASONING]         local okWalk3R, spriteWalk3R = pcall(vmupro.sprite.new, base .. "warrior_walk3_r")
00995 [GPT-5-CODEX-MAX-REASONING]         if okWalk3R then warriorWalk3R = spriteWalk3R end
00996 [GPT-5-CODEX-MAX-REASONING] 
00997 [GPT-5-CODEX-MAX-REASONING]         warriorDeath = {}
00998 [GPT-5-CODEX-MAX-REASONING]         for i = 1, 7 do
00999 [GPT-5-CODEX-MAX-REASONING]             local okDeath, spriteDeath = pcall(vmupro.sprite.new, base .. "warrior_death" .. tostring(i))
01000 [GPT-5-CODEX-MAX-REASONING]             if okDeath then
01001 [GPT-5-CODEX-MAX-REASONING]                 warriorDeath[i] = spriteDeath
01002 [GPT-5-CODEX-MAX-REASONING]                 if not validateSprite(warriorDeath[i], "warriorDeath" .. tostring(i)) then
01003 [GPT-5-CODEX-MAX-REASONING]                     warriorDeath[i] = nil
01004 [GPT-5-CODEX-MAX-REASONING]                 end
01005 [GPT-5-CODEX-MAX-REASONING]             end
01006 [GPT-5-CODEX-MAX-REASONING]         end
01007 [GPT-5-CODEX-MAX-REASONING] 
01008 [GPT-5-CODEX-MAX-REASONING]         swordAttack = {}
01009 [GPT-5-CODEX-MAX-REASONING]         for i = 1, 9 do
01010 [GPT-5-CODEX-MAX-REASONING]             local okAttack, spriteAttack = pcall(vmupro.sprite.new, base .. "sword_attack" .. tostring(i))
01011 [GPT-5-CODEX-MAX-REASONING]             if okAttack then
01012 [GPT-5-CODEX-MAX-REASONING]                 swordAttack[i] = spriteAttack
01013 [GPT-5-CODEX-MAX-REASONING]                 if not validateSprite(swordAttack[i], "swordAttack" .. tostring(i)) then
01014 [GPT-5-CODEX-MAX-REASONING]                     swordAttack[i] = nil
01015 [GPT-5-CODEX-MAX-REASONING]                 end
01016 [GPT-5-CODEX-MAX-REASONING]             end
01017 [GPT-5-CODEX-MAX-REASONING]         end
01018 [GPT-5-CODEX-MAX-REASONING] 
01019 [GPT-5-CODEX-MAX-REASONING]         warriorAttackFront = {}
01020 [GPT-5-CODEX-MAX-REASONING]         warriorAttackBack = {}
01021 [GPT-5-CODEX-MAX-REASONING]         warriorAttackLeft = {}
01022 [GPT-5-CODEX-MAX-REASONING]         warriorAttackRight = {}
01023 [GPT-5-CODEX-MAX-REASONING]         for i = 1, 2 do
01024 [GPT-5-CODEX-MAX-REASONING]             local okFront, sprFront = pcall(vmupro.sprite.new, base .. "warrior_attack_front" .. tostring(i))
01025 [GPT-5-CODEX-MAX-REASONING]             if okFront then warriorAttackFront[i] = sprFront end
01026 [GPT-5-CODEX-MAX-REASONING]             local okBack, sprBack = pcall(vmupro.sprite.new, base .. "warrior_attack_back" .. tostring(i))
01027 [GPT-5-CODEX-MAX-REASONING]             if okBack then warriorAttackBack[i] = sprBack end
01028 [GPT-5-CODEX-MAX-REASONING]             local okLeft, sprLeft = pcall(vmupro.sprite.new, base .. "warrior_attack_left" .. tostring(i))
01029 [GPT-5-CODEX-MAX-REASONING]             if okLeft then warriorAttackLeft[i] = sprLeft end
01030 [GPT-5-CODEX-MAX-REASONING]             local okRight, sprRight = pcall(vmupro.sprite.new, base .. "warrior_attack_right" .. tostring(i))
01031 [GPT-5-CODEX-MAX-REASONING]             if okRight then warriorAttackRight[i] = sprRight end
01032 [GPT-5-CODEX-MAX-REASONING]         end
01033 [GPT-5-CODEX-MAX-REASONING]     end
01034 [GPT-5-CODEX-MAX-REASONING] 
01035 [GPT-5-CODEX-MAX-REASONING]     if assets.knight then
01036 [GPT-5-CODEX-MAX-REASONING]         knightFront = vmupro.sprite.new(base .. "knight_front")
01037 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(knightFront, "knightFront") then knightFront = nil end
01038 [GPT-5-CODEX-MAX-REASONING]         knightBack = vmupro.sprite.new(base .. "knight_back")
01039 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(knightBack, "knightBack") then knightBack = nil end
01040 [GPT-5-CODEX-MAX-REASONING]         knightLeft = vmupro.sprite.new(base .. "knight_left")
01041 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(knightLeft, "knightLeft") then knightLeft = nil end
01042 [GPT-5-CODEX-MAX-REASONING]         knightRight = vmupro.sprite.new(base .. "knight_right")
01043 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(knightRight, "knightRight") then knightRight = nil end
01044 [GPT-5-CODEX-MAX-REASONING]     end
01045 [GPT-5-CODEX-MAX-REASONING] 
01046 [GPT-5-CODEX-MAX-REASONING]     if assets.potion then
01047 [GPT-5-CODEX-MAX-REASONING]         potionSprite = vmupro.sprite.new(base .. "potion")
01048 [GPT-5-CODEX-MAX-REASONING]         if not validateSprite(potionSprite, "potionSprite") then potionSprite = nil end
01049 [GPT-5-CODEX-MAX-REASONING]     end
01050 [GPT-5-CODEX-MAX-REASONING]     if DEBUG_DISABLE_WALL_TEXTURE then
01051 [GPT-5-CODEX-MAX-REASONING]         unloadWallTextures()
01052 [GPT-5-CODEX-MAX-REASONING]     else
01053 [GPT-5-CODEX-MAX-REASONING]         loadWallTextures()
01054 [GPT-5-CODEX-MAX-REASONING]     end
01055 [GPT-5-CODEX-MAX-REASONING] end
01056 [GPT-5-CODEX-MAX-REASONING] 
01057 [GPT-5-CODEX-MAX-REASONING] -- Load texture with dimension validation and error handling
01058 [GPT-5-CODEX-MAX-REASONING] loadTextureWithValidation = function(path, textureName)
01059 [GPT-5-CODEX-MAX-REASONING]     local success, sprite = pcall(function()
01060 [GPT-5-CODEX-MAX-REASONING]         return vmupro.sprite.new(path)
01061 [GPT-5-CODEX-MAX-REASONING]     end)
01062 [GPT-5-CODEX-MAX-REASONING] 
01063 [GPT-5-CODEX-MAX-REASONING]     if not success then
01064 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", string.format(
01065 [GPT-5-CODEX-MAX-REASONING]             "Failed to load texture '%s' from path: %s. Error: %s",
01066 [GPT-5-CODEX-MAX-REASONING]             textureName, path, tostring(sprite)
01067 [GPT-5-CODEX-MAX-REASONING]         ))
01068 [GPT-5-CODEX-MAX-REASONING]         return nil
01069 [GPT-5-CODEX-MAX-REASONING]     end
01070 [GPT-5-CODEX-MAX-REASONING] 
01071 [GPT-5-CODEX-MAX-REASONING]     if not sprite then
01072 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", string.format(
01073 [GPT-5-CODEX-MAX-REASONING]             "Texture '%s' returned nil from path: %s",
01074 [GPT-5-CODEX-MAX-REASONING]             textureName, path
01075 [GPT-5-CODEX-MAX-REASONING]         ))
01076 [GPT-5-CODEX-MAX-REASONING]         return nil
01077 [GPT-5-CODEX-MAX-REASONING]     end
01078 [GPT-5-CODEX-MAX-REASONING] 
01079 [GPT-5-CODEX-MAX-REASONING]     -- Get texture dimensions
01080 [GPT-5-CODEX-MAX-REASONING]     local width = sprite.width
01081 [GPT-5-CODEX-MAX-REASONING]     local height = sprite.height
01082 [GPT-5-CODEX-MAX-REASONING] 
01083 [GPT-5-CODEX-MAX-REASONING]     if not width or not height or width <= 0 or height <= 0 then
01084 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", string.format(
01085 [GPT-5-CODEX-MAX-REASONING]             "Texture '%s' has invalid dimensions: %dx%d (path: %s)",
01086 [GPT-5-CODEX-MAX-REASONING]             textureName, width or 0, height or 0, path
01087 [GPT-5-CODEX-MAX-REASONING]         ))
01088 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", string.format(
01089 [GPT-5-CODEX-MAX-REASONING]             "Texture '%s' failed validation: width=%s, height=%s, path=%s",
01090 [GPT-5-CODEX-MAX-REASONING]             textureName, tostring(width), tostring(height), path
01091 [GPT-5-CODEX-MAX-REASONING]         ))
01092 [GPT-5-CODEX-MAX-REASONING]         return nil
01093 [GPT-5-CODEX-MAX-REASONING]     end
01094 [GPT-5-CODEX-MAX-REASONING] 
01095 [GPT-5-CODEX-MAX-REASONING]     -- Additional validation with safety function
01096 [GPT-5-CODEX-MAX-REASONING]     if not validateTextureDimensions(sprite, "loadTextureWithValidation:" .. textureName) then
01097 [GPT-5-CODEX-MAX-REASONING]         return nil
01098 [GPT-5-CODEX-MAX-REASONING]     end
01099 [GPT-5-CODEX-MAX-REASONING] 
01100 [GPT-5-CODEX-MAX-REASONING]     -- Store metadata
01101 [GPT-5-CODEX-MAX-REASONING]     textureMetadata[textureName] = {
01102 [GPT-5-CODEX-MAX-REASONING]         path = path,
01103 [GPT-5-CODEX-MAX-REASONING]         width = width,
01104 [GPT-5-CODEX-MAX-REASONING]         height = height,
01105 [GPT-5-CODEX-MAX-REASONING]         pixelCount = width * height,
01106 [GPT-5-CODEX-MAX-REASONING]         loaded = true
01107 [GPT-5-CODEX-MAX-REASONING]     }
01108 [GPT-5-CODEX-MAX-REASONING] 
01109 [GPT-5-CODEX-MAX-REASONING]     -- Log successful load with dimensions
01110 [GPT-5-CODEX-MAX-REASONING]     safeLog("INFO", string.format(
01111 [GPT-5-CODEX-MAX-REASONING]         "Loaded texture '%s': %dx%d (%d pixels) from %s",
01112 [GPT-5-CODEX-MAX-REASONING]         textureName, width, height, width * height, path
01113 [GPT-5-CODEX-MAX-REASONING]     ))
01114 [GPT-5-CODEX-MAX-REASONING] 
01115 [GPT-5-CODEX-MAX-REASONING]     return sprite
01116 [GPT-5-CODEX-MAX-REASONING] end
01117 [GPT-5-CODEX-MAX-REASONING] 
01118 [GPT-5-CODEX-MAX-REASONING] -- Load texture sheet with dimension validation (for per-column wall texturing)
01119 [GPT-5-CODEX-MAX-REASONING] loadTextureSheetWithValidation = function(path, textureName)
01120 [GPT-5-CODEX-MAX-REASONING]     local success, sheet = pcall(function()
01121 [GPT-5-CODEX-MAX-REASONING]         return vmupro.sprite.newSheet(path)
01122 [GPT-5-CODEX-MAX-REASONING]     end)
01123 [GPT-5-CODEX-MAX-REASONING] 
01124 [GPT-5-CODEX-MAX-REASONING]     if not success then
01125 [GPT-5-CODEX-MAX-REASONING]         safeLog("WARN", string.format(
01126 [GPT-5-CODEX-MAX-REASONING]             "Failed to load texture sheet '%s' from path: %s. Error: %s",
01127 [GPT-5-CODEX-MAX-REASONING]             textureName, path, tostring(sheet)
01128 [GPT-5-CODEX-MAX-REASONING]         ))
01129 [GPT-5-CODEX-MAX-REASONING]         return nil
01130 [GPT-5-CODEX-MAX-REASONING]     end
01131 [GPT-5-CODEX-MAX-REASONING] 
01132 [GPT-5-CODEX-MAX-REASONING]     if not sheet then
01133 [GPT-5-CODEX-MAX-REASONING]         safeLog("WARN", string.format(
01134 [GPT-5-CODEX-MAX-REASONING]             "Texture sheet '%s' returned nil from path: %s",
01135 [GPT-5-CODEX-MAX-REASONING]             textureName, path
01136 [GPT-5-CODEX-MAX-REASONING]         ))
01137 [GPT-5-CODEX-MAX-REASONING]         return nil
01138 [GPT-5-CODEX-MAX-REASONING]     end
01139 [GPT-5-CODEX-MAX-REASONING] 
01140 [GPT-5-CODEX-MAX-REASONING]     if not sheet.frameWidth or not sheet.frameHeight or not sheet.frameCount then
01141 [GPT-5-CODEX-MAX-REASONING]         safeLog("WARN", string.format(
01142 [GPT-5-CODEX-MAX-REASONING]             "Texture sheet '%s' missing frame data: frameWidth=%s frameHeight=%s frameCount=%s",
01143 [GPT-5-CODEX-MAX-REASONING]             textureName, tostring(sheet.frameWidth), tostring(sheet.frameHeight), tostring(sheet.frameCount)
01144 [GPT-5-CODEX-MAX-REASONING]         ))
01145 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.free(sheet)
01146 [GPT-5-CODEX-MAX-REASONING]         return nil
01147 [GPT-5-CODEX-MAX-REASONING]     end
01148 [GPT-5-CODEX-MAX-REASONING] 
01149 [GPT-5-CODEX-MAX-REASONING]     if enableBootLogs then
01150 [GPT-5-CODEX-MAX-REASONING]         safeLog("INFO", string.format(
01151 [GPT-5-CODEX-MAX-REASONING]             "Texture sheet '%s' loaded: frame %dx%d, count=%s",
01152 [GPT-5-CODEX-MAX-REASONING]             textureName, sheet.frameWidth, sheet.frameHeight, tostring(sheet.frameCount)
01153 [GPT-5-CODEX-MAX-REASONING]         ))
01154 [GPT-5-CODEX-MAX-REASONING]     end
01155 [GPT-5-CODEX-MAX-REASONING] 
01156 [GPT-5-CODEX-MAX-REASONING]     return sheet
01157 [GPT-5-CODEX-MAX-REASONING] end
01158 [GPT-5-CODEX-MAX-REASONING] 
01159 [GPT-5-CODEX-MAX-REASONING] -- Validate texture dimensions meet minimum requirements (metadata-driven)
01160 [GPT-5-CODEX-MAX-REASONING] local function validateTextureMinimumDimensions(textureName, minWidth, minHeight)
01161 [GPT-5-CODEX-MAX-REASONING]     local metadata = textureMetadata[textureName]
01162 [GPT-5-CODEX-MAX-REASONING] 
01163 [GPT-5-CODEX-MAX-REASONING]     if not metadata then
01164 [GPT-5-CODEX-MAX-REASONING]         safeLog("WARN", string.format(
01165 [GPT-5-CODEX-MAX-REASONING]             "Cannot validate texture '%s': no metadata found",
01166 [GPT-5-CODEX-MAX-REASONING]             textureName
01167 [GPT-5-CODEX-MAX-REASONING]         ))
01168 [GPT-5-CODEX-MAX-REASONING]         return false
01169 [GPT-5-CODEX-MAX-REASONING]     end
01170 [GPT-5-CODEX-MAX-REASONING] 
01171 [GPT-5-CODEX-MAX-REASONING]     if metadata.width < minWidth or metadata.height < minHeight then
01172 [GPT-5-CODEX-MAX-REASONING]         safeLog("ERROR", string.format(
01173 [GPT-5-CODEX-MAX-REASONING]             "Texture '%s' (%dx%d) does not meet minimum size requirements (%dx%d)",
01174 [GPT-5-CODEX-MAX-REASONING]             textureName, metadata.width, metadata.height, minWidth, minHeight
01175 [GPT-5-CODEX-MAX-REASONING]         ))
01176 [GPT-5-CODEX-MAX-REASONING]         return false
01177 [GPT-5-CODEX-MAX-REASONING]     end
01178 [GPT-5-CODEX-MAX-REASONING] 
01179 [GPT-5-CODEX-MAX-REASONING]     safeLog("INFO", string.format(
01180 [GPT-5-CODEX-MAX-REASONING]         "Texture '%s' dimension validation passed: %dx%d >= %dx%d",
01181 [GPT-5-CODEX-MAX-REASONING]         textureName, metadata.width, metadata.height, minWidth, minHeight
01182 [GPT-5-CODEX-MAX-REASONING]     ))
01183 [GPT-5-CODEX-MAX-REASONING] 
01184 [GPT-5-CODEX-MAX-REASONING]     return true
01185 [GPT-5-CODEX-MAX-REASONING] end
01186 [GPT-5-CODEX-MAX-REASONING] 
01187 [GPT-5-CODEX-MAX-REASONING] -- Log total texture memory usage
01188 [GPT-5-CODEX-MAX-REASONING] logTextureMemoryUsage = function()
01189 [GPT-5-CODEX-MAX-REASONING]     local totalPixels = 0
01190 [GPT-5-CODEX-MAX-REASONING]     local textureCount = 0
01191 [GPT-5-CODEX-MAX-REASONING] 
01192 [GPT-5-CODEX-MAX-REASONING]     for name, metadata in pairs(textureMetadata) do
01193 [GPT-5-CODEX-MAX-REASONING]         if metadata.loaded then
01194 [GPT-5-CODEX-MAX-REASONING]             totalPixels = totalPixels + metadata.pixelCount
01195 [GPT-5-CODEX-MAX-REASONING]             textureCount = textureCount + 1
01196 [GPT-5-CODEX-MAX-REASONING]         end
01197 [GPT-5-CODEX-MAX-REASONING]     end
01198 [GPT-5-CODEX-MAX-REASONING] 
01199 [GPT-5-CODEX-MAX-REASONING]     -- Estimate memory (assuming 2 bytes per pixel for RGB565)
01200 [GPT-5-CODEX-MAX-REASONING]     local estimatedBytes = totalPixels * 2
01201 [GPT-5-CODEX-MAX-REASONING]     local estimatedKB = estimatedBytes / 1024
01202 [GPT-5-CODEX-MAX-REASONING] 
01203 [GPT-5-CODEX-MAX-REASONING]     safeLog("INFO", string.format(
01204 [GPT-5-CODEX-MAX-REASONING]         "Texture memory summary: %d textures, %d total pixels, ~%.2f KB",
01205 [GPT-5-CODEX-MAX-REASONING]         textureCount, totalPixels, estimatedKB
01206 [GPT-5-CODEX-MAX-REASONING]     ))
01207 [GPT-5-CODEX-MAX-REASONING] 
01208 [GPT-5-CODEX-MAX-REASONING]     return {
01209 [GPT-5-CODEX-MAX-REASONING]         textureCount = textureCount,
01210 [GPT-5-CODEX-MAX-REASONING]         totalPixels = totalPixels,
01211 [GPT-5-CODEX-MAX-REASONING]         estimatedBytes = estimatedBytes,
01212 [GPT-5-CODEX-MAX-REASONING]         estimatedKB = estimatedKB
01213 [GPT-5-CODEX-MAX-REASONING]     }
01214 [GPT-5-CODEX-MAX-REASONING] end
01215 [GPT-5-CODEX-MAX-REASONING] 
01216 [GPT-5-CODEX-MAX-REASONING] -- Get texture metadata
01217 [GPT-5-CODEX-MAX-REASONING] local function getTextureMetadata(textureName)
01218 [GPT-5-CODEX-MAX-REASONING]     return textureMetadata[textureName]
01219 [GPT-5-CODEX-MAX-REASONING] end
01220 [GPT-5-CODEX-MAX-REASONING] 
01221 [GPT-5-CODEX-MAX-REASONING] local function freeSynthRef(synth)
01222 [GPT-5-CODEX-MAX-REASONING]     if synth then
01223 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.free(synth)
01224 [GPT-5-CODEX-MAX-REASONING]     end
01225 [GPT-5-CODEX-MAX-REASONING] end
01226 [GPT-5-CODEX-MAX-REASONING] 
01227 [GPT-5-CODEX-MAX-REASONING] local function unloadLevelAudio()
01228 [GPT-5-CODEX-MAX-REASONING]     if not audioInitialized then return end
01229 [GPT-5-CODEX-MAX-REASONING]     freeSynthRef(swordSwooshSynth); swordSwooshSynth = nil
01230 [GPT-5-CODEX-MAX-REASONING]     if gruntSample then
01231 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(gruntSample)
01232 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(gruntSample)
01233 [GPT-5-CODEX-MAX-REASONING]         gruntSample = nil
01234 [GPT-5-CODEX-MAX-REASONING]     end
01235 [GPT-5-CODEX-MAX-REASONING]     if swordHitSample then
01236 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(swordHitSample)
01237 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(swordHitSample)
01238 [GPT-5-CODEX-MAX-REASONING]         swordHitSample = nil
01239 [GPT-5-CODEX-MAX-REASONING]     end
01240 [GPT-5-CODEX-MAX-REASONING]     if swordMissSample then
01241 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(swordMissSample)
01242 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(swordMissSample)
01243 [GPT-5-CODEX-MAX-REASONING]         swordMissSample = nil
01244 [GPT-5-CODEX-MAX-REASONING]     end
01245 [GPT-5-CODEX-MAX-REASONING]     if yahSample then
01246 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(yahSample)
01247 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(yahSample)
01248 [GPT-5-CODEX-MAX-REASONING]         yahSample = nil
01249 [GPT-5-CODEX-MAX-REASONING]     end
01250 [GPT-5-CODEX-MAX-REASONING]     if winLevelSample then
01251 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(winLevelSample)
01252 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(winLevelSample)
01253 [GPT-5-CODEX-MAX-REASONING]         winLevelSample = nil
01254 [GPT-5-CODEX-MAX-REASONING]     end
01255 [GPT-5-CODEX-MAX-REASONING]     if argDeathSample then
01256 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(argDeathSample)
01257 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(argDeathSample)
01258 [GPT-5-CODEX-MAX-REASONING]         argDeathSample = nil
01259 [GPT-5-CODEX-MAX-REASONING]     end
01260 [GPT-5-CODEX-MAX-REASONING]     freeSynthRef(groanSynth); groanSynth = nil
01261 [GPT-5-CODEX-MAX-REASONING]     freeSynthRef(squishSynth); squishSynth = nil
01262 [GPT-5-CODEX-MAX-REASONING]     freeSynthRef(gulpSynth); gulpSynth = nil
01263 [GPT-5-CODEX-MAX-REASONING]     audioInitialized = false
01264 [GPT-5-CODEX-MAX-REASONING]     if audioSystemActive and not titleSample then
01265 [GPT-5-CODEX-MAX-REASONING]         vmupro.audio.exitListenMode()
01266 [GPT-5-CODEX-MAX-REASONING]         audioSystemActive = false
01267 [GPT-5-CODEX-MAX-REASONING]     end
01268 [GPT-5-CODEX-MAX-REASONING] end
01269 [GPT-5-CODEX-MAX-REASONING] 
01270 [GPT-5-CODEX-MAX-REASONING] local function loadLevelAudio()
01271 [GPT-5-CODEX-MAX-REASONING]     if audioInitialized then return end
01272 [GPT-5-CODEX-MAX-REASONING]     if not audioSystemActive then
01273 [GPT-5-CODEX-MAX-REASONING]         vmupro.audio.startListenMode()
01274 [GPT-5-CODEX-MAX-REASONING]         audioSystemActive = true
01275 [GPT-5-CODEX-MAX-REASONING]     end
01276 [GPT-5-CODEX-MAX-REASONING] 
01277 [GPT-5-CODEX-MAX-REASONING] 
01278 [GPT-5-CODEX-MAX-REASONING]     gruntSample = vmupro.sound.sample.new("sounds/grunt")
01279 [GPT-5-CODEX-MAX-REASONING]     if gruntSample then
01280 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(gruntSample, 0.7, 0.7)
01281 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("INFO", "Loaded sample: grunt") end
01282 [GPT-5-CODEX-MAX-REASONING]     else
01283 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("WARN", "Failed to load sample: grunt") end
01284 [GPT-5-CODEX-MAX-REASONING]     end
01285 [GPT-5-CODEX-MAX-REASONING] 
01286 [GPT-5-CODEX-MAX-REASONING]     swordHitSample = vmupro.sound.sample.new("sounds/sword_swing_connect")
01287 [GPT-5-CODEX-MAX-REASONING]     if swordHitSample then
01288 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(swordHitSample, 0.7, 0.7)
01289 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("INFO", "Loaded sample: sword_swing_connect") end
01290 [GPT-5-CODEX-MAX-REASONING]     else
01291 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("WARN", "Failed to load sample: sword_swing_connect") end
01292 [GPT-5-CODEX-MAX-REASONING]     end
01293 [GPT-5-CODEX-MAX-REASONING] 
01294 [GPT-5-CODEX-MAX-REASONING]     swordMissSample = vmupro.sound.sample.new("sounds/sword_miss")
01295 [GPT-5-CODEX-MAX-REASONING]     if swordMissSample then
01296 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(swordMissSample, 0.7, 0.7)
01297 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("INFO", "Loaded sample: sword_miss") end
01298 [GPT-5-CODEX-MAX-REASONING]     else
01299 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("WARN", "Failed to load sample: sword_miss") end
01300 [GPT-5-CODEX-MAX-REASONING]     end
01301 [GPT-5-CODEX-MAX-REASONING] 
01302 [GPT-5-CODEX-MAX-REASONING]     yahSample = vmupro.sound.sample.new("sounds/yah")
01303 [GPT-5-CODEX-MAX-REASONING]     if yahSample then
01304 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(yahSample, 0.7, 0.7)
01305 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("INFO", "Loaded sample: yah") end
01306 [GPT-5-CODEX-MAX-REASONING]     else
01307 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("WARN", "Failed to load sample: yah") end
01308 [GPT-5-CODEX-MAX-REASONING]     end
01309 [GPT-5-CODEX-MAX-REASONING] 
01310 [GPT-5-CODEX-MAX-REASONING]     winLevelSample = vmupro.sound.sample.new("sounds/win_level")
01311 [GPT-5-CODEX-MAX-REASONING]     if winLevelSample then
01312 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(winLevelSample, 0.7, 0.7)
01313 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("INFO", "Loaded sample: win_level") end
01314 [GPT-5-CODEX-MAX-REASONING]     else
01315 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("WARN", "Failed to load sample: win_level") end
01316 [GPT-5-CODEX-MAX-REASONING]     end
01317 [GPT-5-CODEX-MAX-REASONING] 
01318 [GPT-5-CODEX-MAX-REASONING]     argDeathSample = vmupro.sound.sample.new("sounds/arg_death1")
01319 [GPT-5-CODEX-MAX-REASONING]     if argDeathSample then
01320 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(argDeathSample, 0.7, 0.7)
01321 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("INFO", "Loaded sample: arg_death1") end
01322 [GPT-5-CODEX-MAX-REASONING]     else
01323 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs then safeLog("WARN", "Failed to load sample: arg_death1") end
01324 [GPT-5-CODEX-MAX-REASONING]     end
01325 [GPT-5-CODEX-MAX-REASONING] 
01326 [GPT-5-CODEX-MAX-REASONING]     -- Create groan synth (low frequency for death groan)
01327 [GPT-5-CODEX-MAX-REASONING]     groanSynth = vmupro.sound.synth.new(vmupro.sound.kWaveSawtooth)
01328 [GPT-5-CODEX-MAX-REASONING]     if groanSynth then
01329 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setAttack(groanSynth, 0.05)
01330 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setDecay(groanSynth, 0.3)
01331 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setSustain(groanSynth, 0.1)
01332 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setRelease(groanSynth, 0.2)
01333 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setVolume(groanSynth, 0.6, 0.6)
01334 [GPT-5-CODEX-MAX-REASONING]     end
01335 [GPT-5-CODEX-MAX-REASONING] 
01336 [GPT-5-CODEX-MAX-REASONING]     -- Create squish synth (noise burst for impact)
01337 [GPT-5-CODEX-MAX-REASONING]     squishSynth = vmupro.sound.synth.new(vmupro.sound.kWaveNoise)
01338 [GPT-5-CODEX-MAX-REASONING]     if squishSynth then
01339 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setAttack(squishSynth, 0.01)
01340 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setDecay(squishSynth, 0.15)
01341 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setSustain(squishSynth, 0.0)
01342 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setRelease(squishSynth, 0.1)
01343 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setVolume(squishSynth, 0.7, 0.7)
01344 [GPT-5-CODEX-MAX-REASONING]     end
01345 [GPT-5-CODEX-MAX-REASONING] 
01346 [GPT-5-CODEX-MAX-REASONING]     -- Create gulp synth (for health pickup)
01347 [GPT-5-CODEX-MAX-REASONING]     gulpSynth = vmupro.sound.synth.new(vmupro.sound.kWaveSine)
01348 [GPT-5-CODEX-MAX-REASONING]     if gulpSynth then
01349 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setAttack(gulpSynth, 0.02)
01350 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setDecay(gulpSynth, 0.1)
01351 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setSustain(gulpSynth, 0.3)
01352 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setRelease(gulpSynth, 0.15)
01353 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.synth.setVolume(gulpSynth, 0.6, 0.6)
01354 [GPT-5-CODEX-MAX-REASONING]     end
01355 [GPT-5-CODEX-MAX-REASONING] 
01356 [GPT-5-CODEX-MAX-REASONING]     audioInitialized = true
01357 [GPT-5-CODEX-MAX-REASONING] end
01358 [GPT-5-CODEX-MAX-REASONING] 
01359 [GPT-5-CODEX-MAX-REASONING] local function loadTitleMusic()
01360 [GPT-5-CODEX-MAX-REASONING]     if titleSample then return end
01361 [GPT-5-CODEX-MAX-REASONING]     if not audioSystemActive then
01362 [GPT-5-CODEX-MAX-REASONING]         vmupro.audio.startListenMode()
01363 [GPT-5-CODEX-MAX-REASONING]         audioSystemActive = true
01364 [GPT-5-CODEX-MAX-REASONING]     end
01365 [GPT-5-CODEX-MAX-REASONING]     vmupro.audio.setGlobalVolume(10)
01366 [GPT-5-CODEX-MAX-REASONING]     titleSample = vmupro.sound.sample.new("sounds/Intro_45sec")
01367 [GPT-5-CODEX-MAX-REASONING]     if TITLE_OVERLAY_ENABLED then
01368 [GPT-5-CODEX-MAX-REASONING]         titleOverlaySample = vmupro.sound.sample.new("sounds/inner_sanctum_44k1_adpcm_stereo")
01369 [GPT-5-CODEX-MAX-REASONING]     else
01370 [GPT-5-CODEX-MAX-REASONING]         titleOverlaySample = nil
01371 [GPT-5-CODEX-MAX-REASONING]     end
01372 [GPT-5-CODEX-MAX-REASONING]     if vmupro.system and vmupro.system.log then
01373 [GPT-5-CODEX-MAX-REASONING]         if titleSample then
01374 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title sample loaded")
01375 [GPT-5-CODEX-MAX-REASONING]         else
01376 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(vmupro.system.LOG_ERROR, "AUDIO", "Title sample load failed")
01377 [GPT-5-CODEX-MAX-REASONING]         end
01378 [GPT-5-CODEX-MAX-REASONING]         if not TITLE_OVERLAY_ENABLED then
01379 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title overlay disabled for test")
01380 [GPT-5-CODEX-MAX-REASONING]         elseif titleOverlaySample then
01381 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title overlay sample loaded")
01382 [GPT-5-CODEX-MAX-REASONING]         else
01383 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(vmupro.system.LOG_ERROR, "AUDIO", "Title overlay sample load failed")
01384 [GPT-5-CODEX-MAX-REASONING]         end
01385 [GPT-5-CODEX-MAX-REASONING]     end
01386 [GPT-5-CODEX-MAX-REASONING]     if titleSample then
01387 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(titleSample, TITLE_MUSIC_VOLUME, TITLE_MUSIC_VOLUME)
01388 [GPT-5-CODEX-MAX-REASONING]     end
01389 [GPT-5-CODEX-MAX-REASONING]     if titleOverlaySample then
01390 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.setVolume(titleOverlaySample, TITLE_OVERLAY_VOLUME, TITLE_OVERLAY_VOLUME)
01391 [GPT-5-CODEX-MAX-REASONING]     end
01392 [GPT-5-CODEX-MAX-REASONING] end
01393 [GPT-5-CODEX-MAX-REASONING] 
01394 [GPT-5-CODEX-MAX-REASONING] local function isTitleSamplePlaying()
01395 [GPT-5-CODEX-MAX-REASONING]     if not titleSample then return false end
01396 [GPT-5-CODEX-MAX-REASONING]     local ok, playing = pcall(vmupro.sound.sample.isPlaying, titleSample)
01397 [GPT-5-CODEX-MAX-REASONING]     if not ok then
01398 [GPT-5-CODEX-MAX-REASONING]         if vmupro.system and vmupro.system.log then
01399 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(vmupro.system.LOG_WARN, "AUDIO", "Title sample isPlaying check failed: " .. tostring(playing))
01400 [GPT-5-CODEX-MAX-REASONING]         end
01401 [GPT-5-CODEX-MAX-REASONING]         return false
01402 [GPT-5-CODEX-MAX-REASONING]     end
01403 [GPT-5-CODEX-MAX-REASONING]     return playing == true
01404 [GPT-5-CODEX-MAX-REASONING] end
01405 [GPT-5-CODEX-MAX-REASONING] 
01406 [GPT-5-CODEX-MAX-REASONING] local function attemptStartTitleSample(reason)
01407 [GPT-5-CODEX-MAX-REASONING]     if not titleSample then return false end
01408 [GPT-5-CODEX-MAX-REASONING]     vmupro.sound.sample.setVolume(titleSample, TITLE_MUSIC_VOLUME, TITLE_MUSIC_VOLUME)
01409 [GPT-5-CODEX-MAX-REASONING]     local ok, err = pcall(vmupro.sound.sample.play, titleSample, 0)
01410 [GPT-5-CODEX-MAX-REASONING]     titlePlayRetryTimer = 0
01411 [GPT-5-CODEX-MAX-REASONING]     titleMusicStartUs = (vmupro.system and vmupro.system.getTimeUs and vmupro.system.getTimeUs()) or 0
01412 [GPT-5-CODEX-MAX-REASONING]     if vmupro.system and vmupro.system.log then
01413 [GPT-5-CODEX-MAX-REASONING]         if ok then
01414 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(
01415 [GPT-5-CODEX-MAX-REASONING]                 vmupro.system.LOG_INFO,
01416 [GPT-5-CODEX-MAX-REASONING]                 "AUDIO",
01417 [GPT-5-CODEX-MAX-REASONING]                 string.format("Title sample play attempt=%d reason=%s", titlePlayRetryCount + 1, tostring(reason))
01418 [GPT-5-CODEX-MAX-REASONING]             )
01419 [GPT-5-CODEX-MAX-REASONING]         else
01420 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(
01421 [GPT-5-CODEX-MAX-REASONING]                 vmupro.system.LOG_ERROR,
01422 [GPT-5-CODEX-MAX-REASONING]                 "AUDIO",
01423 [GPT-5-CODEX-MAX-REASONING]                 string.format("Title sample play failed attempt=%d reason=%s err=%s", titlePlayRetryCount + 1, tostring(reason), tostring(err))
01424 [GPT-5-CODEX-MAX-REASONING]             )
01425 [GPT-5-CODEX-MAX-REASONING]         end
01426 [GPT-5-CODEX-MAX-REASONING]     end
01427 [GPT-5-CODEX-MAX-REASONING]     return ok
01428 [GPT-5-CODEX-MAX-REASONING] end
01429 [GPT-5-CODEX-MAX-REASONING] 
01430 [GPT-5-CODEX-MAX-REASONING] local function stopTitleMusic()
01431 [GPT-5-CODEX-MAX-REASONING]     if titleSample then
01432 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(titleSample)
01433 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(titleSample)
01434 [GPT-5-CODEX-MAX-REASONING]         titleSample = nil
01435 [GPT-5-CODEX-MAX-REASONING]     end
01436 [GPT-5-CODEX-MAX-REASONING]     if titleOverlaySample then
01437 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.stop(titleOverlaySample)
01438 [GPT-5-CODEX-MAX-REASONING]         vmupro.sound.sample.free(titleOverlaySample)
01439 [GPT-5-CODEX-MAX-REASONING]         titleOverlaySample = nil
01440 [GPT-5-CODEX-MAX-REASONING]     end
01441 [GPT-5-CODEX-MAX-REASONING]     titleMusicState = "stopped"
01442 [GPT-5-CODEX-MAX-REASONING]     titleMusicTimer = 0
01443 [GPT-5-CODEX-MAX-REASONING]     titleFadeTimer = 0
01444 [GPT-5-CODEX-MAX-REASONING]     titlePauseTimer = 0
01445 [GPT-5-CODEX-MAX-REASONING]     titlePlayRetryCount = 0
01446 [GPT-5-CODEX-MAX-REASONING]     titlePlayRetryTimer = 0
01447 [GPT-5-CODEX-MAX-REASONING]     titlePlayConfirmed = false
01448 [GPT-5-CODEX-MAX-REASONING]     titleOverlayPlayed = false
01449 [GPT-5-CODEX-MAX-REASONING]     titleMusicStartUs = 0
01450 [GPT-5-CODEX-MAX-REASONING]     if audioSystemActive and not audioInitialized then
01451 [GPT-5-CODEX-MAX-REASONING]         vmupro.audio.exitListenMode()
01452 [GPT-5-CODEX-MAX-REASONING]         audioSystemActive = false
01453 [GPT-5-CODEX-MAX-REASONING]     end
01454 [GPT-5-CODEX-MAX-REASONING] end
01455 [GPT-5-CODEX-MAX-REASONING] 
01456 [GPT-5-CODEX-MAX-REASONING] local function startTitleMusic()
01457 [GPT-5-CODEX-MAX-REASONING]     if not soundEnabled then return end
01458 [GPT-5-CODEX-MAX-REASONING]     loadTitleMusic()
01459 [GPT-5-CODEX-MAX-REASONING]     if titleSample then
01460 [GPT-5-CODEX-MAX-REASONING]         titlePlayRetryCount = 0
01461 [GPT-5-CODEX-MAX-REASONING]         titlePlayRetryTimer = 0
01462 [GPT-5-CODEX-MAX-REASONING]         titlePlayConfirmed = false
01463 [GPT-5-CODEX-MAX-REASONING]         titleMusicTimer = 0
01464 [GPT-5-CODEX-MAX-REASONING]         titleFadeTimer = 0
01465 [GPT-5-CODEX-MAX-REASONING]         titlePauseTimer = 0
01466 [GPT-5-CODEX-MAX-REASONING]         titleOverlayPlayed = false
01467 [GPT-5-CODEX-MAX-REASONING]         local started = attemptStartTitleSample("initial")
01468 [GPT-5-CODEX-MAX-REASONING]         titleMusicState = "playing"
01469 [GPT-5-CODEX-MAX-REASONING]         if started then
01470 [GPT-5-CODEX-MAX-REASONING]             titlePlayConfirmed = isTitleSamplePlaying()
01471 [GPT-5-CODEX-MAX-REASONING]             if vmupro.system and vmupro.system.log then
01472 [GPT-5-CODEX-MAX-REASONING]                 vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title sample immediate state: playing=" .. tostring(titlePlayConfirmed))
01473 [GPT-5-CODEX-MAX-REASONING]             end
01474 [GPT-5-CODEX-MAX-REASONING]         end
01475 [GPT-5-CODEX-MAX-REASONING]     else
01476 [GPT-5-CODEX-MAX-REASONING]         if vmupro.system and vmupro.system.log then
01477 [GPT-5-CODEX-MAX-REASONING]             vmupro.system.log(vmupro.system.LOG_ERROR, "AUDIO", "Title sample missing, cannot start title music")
01478 [GPT-5-CODEX-MAX-REASONING]         end
01479 [GPT-5-CODEX-MAX-REASONING]         titleMusicState = "stopped"
01480 [GPT-5-CODEX-MAX-REASONING]     end
01481 [GPT-5-CODEX-MAX-REASONING] end
01482 [GPT-5-CODEX-MAX-REASONING] 
01483 [GPT-5-CODEX-MAX-REASONING] local function updateTitleMusic()
01484 [GPT-5-CODEX-MAX-REASONING]     if not soundEnabled then
01485 [GPT-5-CODEX-MAX-REASONING]         if titleMusicState ~= "stopped" then
01486 [GPT-5-CODEX-MAX-REASONING]             stopTitleMusic()
01487 [GPT-5-CODEX-MAX-REASONING]         end
01488 [GPT-5-CODEX-MAX-REASONING]         return
01489 [GPT-5-CODEX-MAX-REASONING]     end
01490 [GPT-5-CODEX-MAX-REASONING]     if gameState ~= STATE_TITLE then
01491 [GPT-5-CODEX-MAX-REASONING]         if titleMusicState ~= "stopped" then
01492 [GPT-5-CODEX-MAX-REASONING]             stopTitleMusic()
01493 [GPT-5-CODEX-MAX-REASONING]         end
01494 [GPT-5-CODEX-MAX-REASONING]         return
01495 [GPT-5-CODEX-MAX-REASONING]     end
01496 [GPT-5-CODEX-MAX-REASONING] 
01497 [GPT-5-CODEX-MAX-REASONING]     if titleMusicState == "stopped" then
01498 [GPT-5-CODEX-MAX-REASONING]         startTitleMusic()
01499 [GPT-5-CODEX-MAX-REASONING]         return
01500 [GPT-5-CODEX-MAX-REASONING]     end
01501 [GPT-5-CODEX-MAX-REASONING] 
01502 [GPT-5-CODEX-MAX-REASONING]     if titleMusicState == "playing" then
01503 [GPT-5-CODEX-MAX-REASONING]         titleMusicTimer = titleMusicTimer + 1
01504 [GPT-5-CODEX-MAX-REASONING]         local currentlyPlaying = isTitleSamplePlaying()
01505 [GPT-5-CODEX-MAX-REASONING]         if currentlyPlaying then
01506 [GPT-5-CODEX-MAX-REASONING]             if not titlePlayConfirmed then
01507 [GPT-5-CODEX-MAX-REASONING]                 titlePlayConfirmed = true
01508 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.system and vmupro.system.log then
01509 [GPT-5-CODEX-MAX-REASONING]                     vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title sample playback confirmed")
01510 [GPT-5-CODEX-MAX-REASONING]                 end
01511 [GPT-5-CODEX-MAX-REASONING]             end
01512 [GPT-5-CODEX-MAX-REASONING]         elseif not titlePlayConfirmed then
01513 [GPT-5-CODEX-MAX-REASONING]             titlePlayRetryTimer = titlePlayRetryTimer + 1
01514 [GPT-5-CODEX-MAX-REASONING]             if titlePlayRetryTimer >= TITLE_PLAY_RETRY_INTERVAL_FRAMES then
01515 [GPT-5-CODEX-MAX-REASONING]                 if titlePlayRetryCount < TITLE_PLAY_MAX_RETRIES then
01516 [GPT-5-CODEX-MAX-REASONING]                     titlePlayRetryCount = titlePlayRetryCount + 1
01517 [GPT-5-CODEX-MAX-REASONING]                     local retryStarted = attemptStartTitleSample("watchdog_retry")
01518 [GPT-5-CODEX-MAX-REASONING]                     if retryStarted and isTitleSamplePlaying() then
01519 [GPT-5-CODEX-MAX-REASONING]                         titlePlayConfirmed = true
01520 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.system and vmupro.system.log then
01521 [GPT-5-CODEX-MAX-REASONING]                             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title sample playback confirmed after retry")
01522 [GPT-5-CODEX-MAX-REASONING]                         end
01523 [GPT-5-CODEX-MAX-REASONING]                     end
01524 [GPT-5-CODEX-MAX-REASONING]                 else
01525 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.system and vmupro.system.log then
01526 [GPT-5-CODEX-MAX-REASONING]                         vmupro.system.log(
01527 [GPT-5-CODEX-MAX-REASONING]                             vmupro.system.LOG_ERROR,
01528 [GPT-5-CODEX-MAX-REASONING]                             "AUDIO",
01529 [GPT-5-CODEX-MAX-REASONING]                             "Title sample retries exhausted, forcing restart on next frame"
01530 [GPT-5-CODEX-MAX-REASONING]                         )
01531 [GPT-5-CODEX-MAX-REASONING]                     end
01532 [GPT-5-CODEX-MAX-REASONING]                     titleMusicState = "stopped"
01533 [GPT-5-CODEX-MAX-REASONING]                     return
01534 [GPT-5-CODEX-MAX-REASONING]                 end
01535 [GPT-5-CODEX-MAX-REASONING]             end
01536 [GPT-5-CODEX-MAX-REASONING]         end
01537 [GPT-5-CODEX-MAX-REASONING]         if TITLE_OVERLAY_ENABLED and not titleOverlayPlayed and titleOverlaySample then
01538 [GPT-5-CODEX-MAX-REASONING]             local nowUs = (vmupro.system and vmupro.system.getTimeUs and vmupro.system.getTimeUs()) or 0
01539 [GPT-5-CODEX-MAX-REASONING]             if titleMusicStartUs > 0 and nowUs > titleMusicStartUs
01540 [GPT-5-CODEX-MAX-REASONING]                 and (nowUs - titleMusicStartUs) >= TITLE_OVERLAY_DELAY_US then
01541 [GPT-5-CODEX-MAX-REASONING]                 vmupro.sound.sample.play(titleOverlaySample, 0)
01542 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.system and vmupro.system.log then
01543 [GPT-5-CODEX-MAX-REASONING]                     vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title overlay sample play")
01544 [GPT-5-CODEX-MAX-REASONING]                 end
01545 [GPT-5-CODEX-MAX-REASONING]                 titleOverlayPlayed = true
01546 [GPT-5-CODEX-MAX-REASONING]             end
01547 [GPT-5-CODEX-MAX-REASONING]         end
01548 [GPT-5-CODEX-MAX-REASONING]         if titleMusicTimer >= TITLE_MUSIC_FADE_START_FRAMES then
01549 [GPT-5-CODEX-MAX-REASONING]             titleMusicState = "fading"
01550 [GPT-5-CODEX-MAX-REASONING]             titleFadeTimer = 0
01551 [GPT-5-CODEX-MAX-REASONING]         end
01552 [GPT-5-CODEX-MAX-REASONING]     elseif titleMusicState == "fading" then
01553 [GPT-5-CODEX-MAX-REASONING]         titleFadeTimer = titleFadeTimer + 1
01554 [GPT-5-CODEX-MAX-REASONING]         local t = titleFadeTimer / TITLE_MUSIC_FADE_FRAMES
01555 [GPT-5-CODEX-MAX-REASONING]         if t > 1 then t = 1 end
01556 [GPT-5-CODEX-MAX-REASONING]         local v = TITLE_MUSIC_VOLUME * (1 - t)
01557 [GPT-5-CODEX-MAX-REASONING]         if titleSample then
01558 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.sample.setVolume(titleSample, v, v)
01559 [GPT-5-CODEX-MAX-REASONING]         end
01560 [GPT-5-CODEX-MAX-REASONING]         if titleFadeTimer >= TITLE_MUSIC_FADE_FRAMES then
01561 [GPT-5-CODEX-MAX-REASONING]             if titleSample then
01562 [GPT-5-CODEX-MAX-REASONING]                 vmupro.sound.sample.stop(titleSample)
01563 [GPT-5-CODEX-MAX-REASONING]             end
01564 [GPT-5-CODEX-MAX-REASONING]             titleMusicState = "paused"
01565 [GPT-5-CODEX-MAX-REASONING]             titlePauseTimer = 0
01566 [GPT-5-CODEX-MAX-REASONING]         end
01567 [GPT-5-CODEX-MAX-REASONING]     elseif titleMusicState == "paused" then
01568 [GPT-5-CODEX-MAX-REASONING]         titlePauseTimer = titlePauseTimer + 1
01569 [GPT-5-CODEX-MAX-REASONING]         if titlePauseTimer >= TITLE_MUSIC_PAUSE_FRAMES then
01570 [GPT-5-CODEX-MAX-REASONING]             startTitleMusic()
01571 [GPT-5-CODEX-MAX-REASONING]         end
01572 [GPT-5-CODEX-MAX-REASONING]     end
01573 [GPT-5-CODEX-MAX-REASONING] end
01574 [GPT-5-CODEX-MAX-REASONING] 
01575 [GPT-5-CODEX-MAX-REASONING] local function enterTitle()
01576 [GPT-5-CODEX-MAX-REASONING]     showMenu = false
01577 [GPT-5-CODEX-MAX-REASONING]     gameState = STATE_TITLE
01578 [GPT-5-CODEX-MAX-REASONING]     titleSelection = 1
01579 [GPT-5-CODEX-MAX-REASONING]     titleInOptions = false
01580 [GPT-5-CODEX-MAX-REASONING]     titleNeedsRedraw = true
01581 [GPT-5-CODEX-MAX-REASONING]     unloadLevelAudio()
01582 [GPT-5-CODEX-MAX-REASONING]     unloadLevelSprites()
01583 [GPT-5-CODEX-MAX-REASONING]     unloadLevelData()
01584 [GPT-5-CODEX-MAX-REASONING]     unloadWallTextures()
01585 [GPT-5-CODEX-MAX-REASONING]     loadMenuSprites()
01586 [GPT-5-CODEX-MAX-REASONING]     collectgarbage()
01587 [GPT-5-CODEX-MAX-REASONING]     startTitleMusic()
01588 [GPT-5-CODEX-MAX-REASONING] end
01589 [GPT-5-CODEX-MAX-REASONING] 
01590 [GPT-5-CODEX-MAX-REASONING] local function initializeLevelState(levelId)
01591 [GPT-5-CODEX-MAX-REASONING]     loadLevel(levelId)
01592 [GPT-5-CODEX-MAX-REASONING]     playerHealth = MAX_HEALTH
01593 [GPT-5-CODEX-MAX-REASONING]     soldiersKilled = 0
01594 [GPT-5-CODEX-MAX-REASONING]     isAttacking = 0
01595 [GPT-5-CODEX-MAX-REASONING]     isBlocking = false
01596 [GPT-5-CODEX-MAX-REASONING]     showMenu = false
01597 [GPT-5-CODEX-MAX-REASONING]     swipeEffects = {}
01598 [GPT-5-CODEX-MAX-REASONING]     bloodEffects = {}
01599 [GPT-5-CODEX-MAX-REASONING]     levelBannerTimer = levelBannerMax
01600 [GPT-5-CODEX-MAX-REASONING] end
01601 [GPT-5-CODEX-MAX-REASONING] 
01602 [GPT-5-CODEX-MAX-REASONING] local function startLevel(levelId)
01603 [GPT-5-CODEX-MAX-REASONING]     loadingLog("LOAD startLevel begin " .. tostring(levelId))
01604 [GPT-5-CODEX-MAX-REASONING]     -- Ensure we free previous level assets to avoid sprite slot exhaustion
01605 [GPT-5-CODEX-MAX-REASONING]     unloadLevelData()
01606 [GPT-5-CODEX-MAX-REASONING]     unloadLevelSprites()
01607 [GPT-5-CODEX-MAX-REASONING]     unloadWallTextures()
01608 [GPT-5-CODEX-MAX-REASONING]     collectgarbage()
01609 [GPT-5-CODEX-MAX-REASONING]     stopTitleMusic()
01610 [GPT-5-CODEX-MAX-REASONING]     unloadMenuSprites()
01611 [GPT-5-CODEX-MAX-REASONING]     loadingLog("LOAD after unloadMenuSprites")
01612 [GPT-5-CODEX-MAX-REASONING]     loadLevelSprites(levelId)
01613 [GPT-5-CODEX-MAX-REASONING]     loadingLog("LOAD after loadLevelSprites")
01614 [GPT-5-CODEX-MAX-REASONING]     loadLevelAudio()
01615 [GPT-5-CODEX-MAX-REASONING]     loadingLog("LOAD after loadLevelAudio")
01616 [GPT-5-CODEX-MAX-REASONING]     initializeLevelState(levelId)
01617 [GPT-5-CODEX-MAX-REASONING]     loadingLog("LOAD after initializeLevelState")
01618 [GPT-5-CODEX-MAX-REASONING]     gameState = STATE_PLAYING
01619 [GPT-5-CODEX-MAX-REASONING]     loadingLog("LOAD startLevel done")
01620 [GPT-5-CODEX-MAX-REASONING] end
01621 [GPT-5-CODEX-MAX-REASONING] 
01622 [GPT-5-CODEX-MAX-REASONING] local function restartLevel()
01623 [GPT-5-CODEX-MAX-REASONING]     startLevel(currentLevel)
01624 [GPT-5-CODEX-MAX-REASONING] end
01625 [GPT-5-CODEX-MAX-REASONING] 
01626 [GPT-5-CODEX-MAX-REASONING] local function beginLoadLevel(levelId)
01627 [GPT-5-CODEX-MAX-REASONING]     pendingLevelStart = nil
01628 [GPT-5-CODEX-MAX-REASONING]     loadingTimer = 0
01629 [GPT-5-CODEX-MAX-REASONING]     loadingLogCount = 0
01630 [GPT-5-CODEX-MAX-REASONING]     loadingLog("LOAD beginLoadLevel (loading disabled) " .. tostring(levelId))
01631 [GPT-5-CODEX-MAX-REASONING]     wallQuadLogCount = 0
01632 [GPT-5-CODEX-MAX-REASONING]     wallQuadLog("WQ beginLoadLevel (loading disabled) " .. tostring(levelId))
01633 [GPT-5-CODEX-MAX-REASONING]     startLevel(levelId)
01634 [GPT-5-CODEX-MAX-REASONING] end
01635 [GPT-5-CODEX-MAX-REASONING] 
01636 [GPT-5-CODEX-MAX-REASONING] -- Check if a position is walkable (no wall)
01637 [GPT-5-CODEX-MAX-REASONING] local function isWalkable(x, y)
01638 [GPT-5-CODEX-MAX-REASONING]     local r = (PLAYER_RADIUS or 0.25) * 0.85
01639 [GPT-5-CODEX-MAX-REASONING]     local x1, x2 = x - r, x + r
01640 [GPT-5-CODEX-MAX-REASONING]     local y1, y2 = y - r, y + r
01641 [GPT-5-CODEX-MAX-REASONING]     local mx1, mx2 = math.floor(x1), math.floor(x2)
01642 [GPT-5-CODEX-MAX-REASONING]     local my1, my2 = math.floor(y1), math.floor(y2)
01643 [GPT-5-CODEX-MAX-REASONING]     if mx1 < 0 or mx2 >= 16 or my1 < 0 or my2 >= 16 then return false end
01644 [GPT-5-CODEX-MAX-REASONING]     return map[my1 + 1][mx1 + 1] == 0
01645 [GPT-5-CODEX-MAX-REASONING]         and map[my1 + 1][mx2 + 1] == 0
01646 [GPT-5-CODEX-MAX-REASONING]         and map[my2 + 1][mx1 + 1] == 0
01647 [GPT-5-CODEX-MAX-REASONING]         and map[my2 + 1][mx2 + 1] == 0
01648 [GPT-5-CODEX-MAX-REASONING] end
01649 [GPT-5-CODEX-MAX-REASONING] 
01650 [GPT-5-CODEX-MAX-REASONING] 
01651 [GPT-5-CODEX-MAX-REASONING] -- Safe atan2 implementation
01652 [GPT-5-CODEX-MAX-REASONING] local function safeAtan2(y, x)
01653 [GPT-5-CODEX-MAX-REASONING]     if x == 0 then
01654 [GPT-5-CODEX-MAX-REASONING]         if y > 0 then return 1.5708
01655 [GPT-5-CODEX-MAX-REASONING]         elseif y < 0 then return -1.5708
01656 [GPT-5-CODEX-MAX-REASONING]         else return 0 end
01657 [GPT-5-CODEX-MAX-REASONING]     end
01658 [GPT-5-CODEX-MAX-REASONING]     local angle = math.atan(y / x)
01659 [GPT-5-CODEX-MAX-REASONING]     if x < 0 then angle = angle + 3.14159 end
01660 [GPT-5-CODEX-MAX-REASONING]     return angle
01661 [GPT-5-CODEX-MAX-REASONING] end
01662 [GPT-5-CODEX-MAX-REASONING] 
01663 [GPT-5-CODEX-MAX-REASONING] -- Soldier AI: patrol, chase, and attack
01664 [GPT-5-CODEX-MAX-REASONING] local function updateSoldiers()
01665 [GPT-5-CODEX-MAX-REASONING]     if DEBUG_DISABLE_ENEMIES then
01666 [GPT-5-CODEX-MAX-REASONING]         return
01667 [GPT-5-CODEX-MAX-REASONING]     end
01668 [GPT-5-CODEX-MAX-REASONING]     if checkArrayBounds(sprites, 1, "updateSoldiers") then
01669 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #sprites do
01670 [GPT-5-CODEX-MAX-REASONING]             if checkArrayBounds(sprites, i, "updateSoldiers") then
01671 [GPT-5-CODEX-MAX-REASONING]                 local s = sprites[i]
01672 [GPT-5-CODEX-MAX-REASONING]                 if s.t == 5 and s.speed then  -- Warriors with movement data
01673 [GPT-5-CODEX-MAX-REASONING]                     -- Skip dead soldiers
01674 [GPT-5-CODEX-MAX-REASONING]                     if s.alive == false then
01675 [GPT-5-CODEX-MAX-REASONING]                         goto continue
01676 [GPT-5-CODEX-MAX-REASONING]                     end
01677 [GPT-5-CODEX-MAX-REASONING] 
01678 [GPT-5-CODEX-MAX-REASONING]                     -- Initialize state if not set
01679 [GPT-5-CODEX-MAX-REASONING]                     if not s.state then
01680 [GPT-5-CODEX-MAX-REASONING]                         s.state = "patrol"
01681 [GPT-5-CODEX-MAX-REASONING]                         s.patrolDir = 1
01682 [GPT-5-CODEX-MAX-REASONING]                         s.patrolAxis = (i % 2 == 0) and "x" or "y"
01683 [GPT-5-CODEX-MAX-REASONING]                         s.startX = s.x
01684 [GPT-5-CODEX-MAX-REASONING]                         s.startY = s.y
01685 [GPT-5-CODEX-MAX-REASONING]                         s.attackCooldown = 0
01686 [GPT-5-CODEX-MAX-REASONING]                     end
01687 [GPT-5-CODEX-MAX-REASONING] 
01688 [GPT-5-CODEX-MAX-REASONING]                     -- Calculate distance to player (cheap cull first)
01689 [GPT-5-CODEX-MAX-REASONING]                     local dx = px - s.x
01690 [GPT-5-CODEX-MAX-REASONING]                     local dy = py - s.y
01691 [GPT-5-CODEX-MAX-REASONING]                     local distSq = dx * dx + dy * dy
01692 [GPT-5-CODEX-MAX-REASONING]                     if distSq > SOLDIER_ACTIVE_DIST_SQ and (frameCount % 8) ~= 0 then
01693 [GPT-5-CODEX-MAX-REASONING]                         goto continue
01694 [GPT-5-CODEX-MAX-REASONING]                     end
01695 [GPT-5-CODEX-MAX-REASONING]                     local distToPlayer = math.sqrt(distSq)
01696 [GPT-5-CODEX-MAX-REASONING]                     if distToPlayer < 0.001 then
01697 [GPT-5-CODEX-MAX-REASONING]                         distToPlayer = 0.001
01698 [GPT-5-CODEX-MAX-REASONING]                     end
01699 [GPT-5-CODEX-MAX-REASONING] 
01700 [GPT-5-CODEX-MAX-REASONING]                     if DEBUG_DISABLE_ENEMY_AGGRO then
01701 [GPT-5-CODEX-MAX-REASONING]                         distToPlayer = 999  -- Force patrol state
01702 [GPT-5-CODEX-MAX-REASONING]                         s.attackCooldown = 0
01703 [GPT-5-CODEX-MAX-REASONING]                         -- Face the player for consistent side-view testing
01704 [GPT-5-CODEX-MAX-REASONING]                         local angleToPlayer = safeAtan2(dy, dx)
01705 [GPT-5-CODEX-MAX-REASONING]                         s.dir = math.floor(angleToPlayer * 64 / 6.28318) % 64
01706 [GPT-5-CODEX-MAX-REASONING]                     end
01707 [GPT-5-CODEX-MAX-REASONING] 
01708 [GPT-5-CODEX-MAX-REASONING]                     if DEBUG_WALK_IN_PLACE then
01709 [GPT-5-CODEX-MAX-REASONING]                         s.state = "patrol"
01710 [GPT-5-CODEX-MAX-REASONING]                         if s.patrolAxis == "x" then
01711 [GPT-5-CODEX-MAX-REASONING]                             s.dir = (s.patrolDir > 0) and 0 or 32
01712 [GPT-5-CODEX-MAX-REASONING]                         else
01713 [GPT-5-CODEX-MAX-REASONING]                             s.dir = (s.patrolDir > 0) and 16 or 48
01714 [GPT-5-CODEX-MAX-REASONING]                         end
01715 [GPT-5-CODEX-MAX-REASONING]                         s.anim = ((s.anim or 0) + 1) % 20
01716 [GPT-5-CODEX-MAX-REASONING]                         goto continue
01717 [GPT-5-CODEX-MAX-REASONING]                     end
01718 [GPT-5-CODEX-MAX-REASONING] 
01719 [GPT-5-CODEX-MAX-REASONING]                     -- Decrease attack cooldown
01720 [GPT-5-CODEX-MAX-REASONING]                     if s.attackCooldown > 0 then
01721 [GPT-5-CODEX-MAX-REASONING]                         s.attackCooldown = s.attackCooldown - 1
01722 [GPT-5-CODEX-MAX-REASONING]                     end
01723 [GPT-5-CODEX-MAX-REASONING] 
01724 [GPT-5-CODEX-MAX-REASONING]                     -- State machine
01725 [GPT-5-CODEX-MAX-REASONING]                     if distToPlayer < ATTACK_RANGE then
01726 [GPT-5-CODEX-MAX-REASONING]                         -- Close enough to attack
01727 [GPT-5-CODEX-MAX-REASONING]                         s.state = "attack"
01728 [GPT-5-CODEX-MAX-REASONING] 
01729 [GPT-5-CODEX-MAX-REASONING]                         -- Face the player
01730 [GPT-5-CODEX-MAX-REASONING]                         local angleToPlayer = safeAtan2(dy, dx)
01731 [GPT-5-CODEX-MAX-REASONING]                         s.dir = math.floor(angleToPlayer * 64 / 6.28318) % 64
01732 [GPT-5-CODEX-MAX-REASONING] 
01733 [GPT-5-CODEX-MAX-REASONING]                         -- Attack if cooldown is ready
01734 [GPT-5-CODEX-MAX-REASONING]                         if s.attackCooldown <= 0 then
01735 [GPT-5-CODEX-MAX-REASONING]                             s.attackCooldown = ATTACK_COOLDOWN
01736 [GPT-5-CODEX-MAX-REASONING]                             s.attackAnim = 6
01737 [GPT-5-CODEX-MAX-REASONING]                             s.attackFrame = 1
01738 [GPT-5-CODEX-MAX-REASONING] 
01739 [GPT-5-CODEX-MAX-REASONING]                             -- Soldier attack sound
01740 [GPT-5-CODEX-MAX-REASONING]                             if yahSample and soundEnabled then
01741 [GPT-5-CODEX-MAX-REASONING]                                 vmupro.sound.sample.stop(yahSample)
01742 [GPT-5-CODEX-MAX-REASONING]                                 vmupro.sound.sample.play(yahSample)
01743 [GPT-5-CODEX-MAX-REASONING]                                 if enableBootLogs then safeLog("INFO", "Play sample: yah") end
01744 [GPT-5-CODEX-MAX-REASONING]                             end
01745 [GPT-5-CODEX-MAX-REASONING] 
01746 [GPT-5-CODEX-MAX-REASONING] 
01747 [GPT-5-CODEX-MAX-REASONING]                             -- Apply damage to player
01748 [GPT-5-CODEX-MAX-REASONING]                             playerHealth = playerHealth - DAMAGE_PER_HIT
01749 [GPT-5-CODEX-MAX-REASONING]                             if playerHealth <= 0 then
01750 [GPT-5-CODEX-MAX-REASONING]                                 playerHealth = 0
01751 [GPT-5-CODEX-MAX-REASONING]                                 gameState = STATE_GAME_OVER
01752 [GPT-5-CODEX-MAX-REASONING]                                 gameOverSelection = 1
01753 [GPT-5-CODEX-MAX-REASONING]                             end
01754 [GPT-5-CODEX-MAX-REASONING]                         end
01755 [GPT-5-CODEX-MAX-REASONING] 
01756 [GPT-5-CODEX-MAX-REASONING]                     elseif distToPlayer < DETECTION_RANGE then
01757 [GPT-5-CODEX-MAX-REASONING]                         -- Player detected - chase!
01758 [GPT-5-CODEX-MAX-REASONING]                         if s.state ~= "chase" and not s.aggroed then
01759 [GPT-5-CODEX-MAX-REASONING]                             s.aggroed = true
01760 [GPT-5-CODEX-MAX-REASONING]                             if gruntSample and soundEnabled then
01761 [GPT-5-CODEX-MAX-REASONING]                                 vmupro.sound.sample.stop(gruntSample)
01762 [GPT-5-CODEX-MAX-REASONING]                                 vmupro.sound.sample.play(gruntSample)
01763 [GPT-5-CODEX-MAX-REASONING]                                 if enableBootLogs then safeLog("INFO", "Play sample: grunt") end
01764 [GPT-5-CODEX-MAX-REASONING]                             end
01765 [GPT-5-CODEX-MAX-REASONING]                         end
01766 [GPT-5-CODEX-MAX-REASONING]                         s.state = "chase"
01767 [GPT-5-CODEX-MAX-REASONING] 
01768 [GPT-5-CODEX-MAX-REASONING]                         -- Move towards player (sprint!)
01769 [GPT-5-CODEX-MAX-REASONING]                         local moveSpeed = s.speed * CHASE_SPEED_MULT * SOLDIER_SPEED_SCALE
01770 [GPT-5-CODEX-MAX-REASONING]                         local moveX = (dx / distToPlayer) * moveSpeed
01771 [GPT-5-CODEX-MAX-REASONING]                         local moveY = (dy / distToPlayer) * moveSpeed
01772 [GPT-5-CODEX-MAX-REASONING]                         local newX = s.x + moveX
01773 [GPT-5-CODEX-MAX-REASONING]                         local newY = s.y + moveY
01774 [GPT-5-CODEX-MAX-REASONING] 
01775 [GPT-5-CODEX-MAX-REASONING]                         if isWalkable(newX, newY) then
01776 [GPT-5-CODEX-MAX-REASONING]                             s.x = newX
01777 [GPT-5-CODEX-MAX-REASONING]                             s.y = newY
01778 [GPT-5-CODEX-MAX-REASONING] 
01779 [GPT-5-CODEX-MAX-REASONING]                             -- Update facing direction towards player
01780 [GPT-5-CODEX-MAX-REASONING]                             local angleToPlayer = safeAtan2(dy, dx)
01781 [GPT-5-CODEX-MAX-REASONING]                             s.dir = math.floor(angleToPlayer * 64 / 6.28318) % 64
01782 [GPT-5-CODEX-MAX-REASONING] 
01783 [GPT-5-CODEX-MAX-REASONING]                             -- Update animation frame
01784 [GPT-5-CODEX-MAX-REASONING]                             s.anim = ((s.anim or 0) + 1) % 20
01785 [GPT-5-CODEX-MAX-REASONING]                         end
01786 [GPT-5-CODEX-MAX-REASONING] 
01787 [GPT-5-CODEX-MAX-REASONING]                     else
01788 [GPT-5-CODEX-MAX-REASONING]                         -- Patrol mode
01789 [GPT-5-CODEX-MAX-REASONING]                         s.state = "patrol"
01790 [GPT-5-CODEX-MAX-REASONING] 
01791 [GPT-5-CODEX-MAX-REASONING]                         local moveAmount = s.speed * s.patrolDir * SOLDIER_SPEED_SCALE
01792 [GPT-5-CODEX-MAX-REASONING]                         local newX, newY = s.x, s.y
01793 [GPT-5-CODEX-MAX-REASONING] 
01794 [GPT-5-CODEX-MAX-REASONING]                         if s.patrolAxis == "x" then
01795 [GPT-5-CODEX-MAX-REASONING]                             newX = s.x + moveAmount
01796 [GPT-5-CODEX-MAX-REASONING]                             s.dir = (s.patrolDir > 0) and 0 or 32
01797 [GPT-5-CODEX-MAX-REASONING]                         else
01798 [GPT-5-CODEX-MAX-REASONING]                             newY = s.y + moveAmount
01799 [GPT-5-CODEX-MAX-REASONING]                             s.dir = (s.patrolDir > 0) and 16 or 48
01800 [GPT-5-CODEX-MAX-REASONING]                         end
01801 [GPT-5-CODEX-MAX-REASONING] 
01802 [GPT-5-CODEX-MAX-REASONING]                         local patrolDist = 3
01803 [GPT-5-CODEX-MAX-REASONING]                         local distFromStart
01804 [GPT-5-CODEX-MAX-REASONING]                         if s.patrolAxis == "x" then
01805 [GPT-5-CODEX-MAX-REASONING]                             distFromStart = newX - s.startX
01806 [GPT-5-CODEX-MAX-REASONING]                         else
01807 [GPT-5-CODEX-MAX-REASONING]                             distFromStart = newY - s.startY
01808 [GPT-5-CODEX-MAX-REASONING]                         end
01809 [GPT-5-CODEX-MAX-REASONING] 
01810 [GPT-5-CODEX-MAX-REASONING]                         if math.abs(distFromStart) > patrolDist or not isWalkable(newX, newY) then
01811 [GPT-5-CODEX-MAX-REASONING]                             s.patrolDir = -s.patrolDir
01812 [GPT-5-CODEX-MAX-REASONING]                         else
01813 [GPT-5-CODEX-MAX-REASONING]                             if not DEBUG_WALK_IN_PLACE then
01814 [GPT-5-CODEX-MAX-REASONING]                                 s.x = newX
01815 [GPT-5-CODEX-MAX-REASONING]                                 s.y = newY
01816 [GPT-5-CODEX-MAX-REASONING]                             end
01817 [GPT-5-CODEX-MAX-REASONING]                             s.anim = ((s.anim or 0) + 1) % 20
01818 [GPT-5-CODEX-MAX-REASONING]                         end
01819 [GPT-5-CODEX-MAX-REASONING]                     end
01820 [GPT-5-CODEX-MAX-REASONING] 
01821 [GPT-5-CODEX-MAX-REASONING]                     if s.attackAnim and s.attackAnim > 0 then
01822 [GPT-5-CODEX-MAX-REASONING]                         s.attackAnim = s.attackAnim - 1
01823 [GPT-5-CODEX-MAX-REASONING]                         if s.attackAnim == 3 then
01824 [GPT-5-CODEX-MAX-REASONING]                             s.attackFrame = 2
01825 [GPT-5-CODEX-MAX-REASONING]                         elseif s.attackAnim <= 0 then
01826 [GPT-5-CODEX-MAX-REASONING]                             s.attackAnim = 0
01827 [GPT-5-CODEX-MAX-REASONING]                         end
01828 [GPT-5-CODEX-MAX-REASONING]                     end
01829 [GPT-5-CODEX-MAX-REASONING]                     ::continue::
01830 [GPT-5-CODEX-MAX-REASONING]                 end
01831 [GPT-5-CODEX-MAX-REASONING]             end
01832 [GPT-5-CODEX-MAX-REASONING]         end
01833 [GPT-5-CODEX-MAX-REASONING]     end
01834 [GPT-5-CODEX-MAX-REASONING] end
01835 [GPT-5-CODEX-MAX-REASONING] 
01836 [GPT-5-CODEX-MAX-REASONING] -- Update swipe effects
01837 [GPT-5-CODEX-MAX-REASONING] local function updateSwipeEffects()
01838 [GPT-5-CODEX-MAX-REASONING]     local i = 1
01839 [GPT-5-CODEX-MAX-REASONING]     while i <= #swipeEffects do
01840 [GPT-5-CODEX-MAX-REASONING]         local e = swipeEffects[i]
01841 [GPT-5-CODEX-MAX-REASONING]         e.frame = e.frame + 1
01842 [GPT-5-CODEX-MAX-REASONING]         if e.frame >= e.maxFrames then
01843 [GPT-5-CODEX-MAX-REASONING]             table.remove(swipeEffects, i)
01844 [GPT-5-CODEX-MAX-REASONING]         else
01845 [GPT-5-CODEX-MAX-REASONING]             i = i + 1
01846 [GPT-5-CODEX-MAX-REASONING]         end
01847 [GPT-5-CODEX-MAX-REASONING]     end
01848 [GPT-5-CODEX-MAX-REASONING] end
01849 [GPT-5-CODEX-MAX-REASONING] 
01850 [GPT-5-CODEX-MAX-REASONING] local function updateDeathAnimations()
01851 [GPT-5-CODEX-MAX-REASONING]     if not sprites or #sprites == 0 then return end
01852 [GPT-5-CODEX-MAX-REASONING]     if checkArrayBounds(sprites, 1, "updateDeathAnimations") then
01853 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #sprites do
01854 [GPT-5-CODEX-MAX-REASONING]             if checkArrayBounds(sprites, i, "updateDeathAnimations") then
01855 [GPT-5-CODEX-MAX-REASONING]                 local s = sprites[i]
01856 [GPT-5-CODEX-MAX-REASONING]                 if s.t == 5 and s.dying then
01857 [GPT-5-CODEX-MAX-REASONING]                     if #warriorDeath == 0 then
01858 [GPT-5-CODEX-MAX-REASONING]                         s.dying = false
01859 [GPT-5-CODEX-MAX-REASONING]                         s.dead = true
01860 [GPT-5-CODEX-MAX-REASONING]                         goto continue_death
01861 [GPT-5-CODEX-MAX-REASONING]                     end
01862 [GPT-5-CODEX-MAX-REASONING]                     s.deathTick = (s.deathTick or 0) + 1
01863 [GPT-5-CODEX-MAX-REASONING]                     if s.deathTick % 2 == 0 then
01864 [GPT-5-CODEX-MAX-REASONING]                         s.deathFrame = (s.deathFrame or 1) + 1
01865 [GPT-5-CODEX-MAX-REASONING]                         if s.deathFrame > #warriorDeath then
01866 [GPT-5-CODEX-MAX-REASONING]                             s.dying = false
01867 [GPT-5-CODEX-MAX-REASONING]                             s.dead = true
01868 [GPT-5-CODEX-MAX-REASONING]                         end
01869 [GPT-5-CODEX-MAX-REASONING]                     end
01870 [GPT-5-CODEX-MAX-REASONING]                     ::continue_death::
01871 [GPT-5-CODEX-MAX-REASONING]                 end
01872 [GPT-5-CODEX-MAX-REASONING]             end
01873 [GPT-5-CODEX-MAX-REASONING]         end
01874 [GPT-5-CODEX-MAX-REASONING]     end
01875 [GPT-5-CODEX-MAX-REASONING] end
01876 [GPT-5-CODEX-MAX-REASONING] 
01877 [GPT-5-CODEX-MAX-REASONING] -- Draw swipe effects
01878 [GPT-5-CODEX-MAX-REASONING] local function drawSwipeEffects()
01879 [GPT-5-CODEX-MAX-REASONING]     for _, e in ipairs(swipeEffects) do
01880 [GPT-5-CODEX-MAX-REASONING]         local progress = e.frame / e.maxFrames
01881 [GPT-5-CODEX-MAX-REASONING]         local alpha = 1.0 - progress  -- Fade out
01882 [GPT-5-CODEX-MAX-REASONING]         local radius = 30 + progress * 50  -- Expand outward
01883 [GPT-5-CODEX-MAX-REASONING] 
01884 [GPT-5-CODEX-MAX-REASONING]         -- Draw arc lines for sword swipe effect
01885 [GPT-5-CODEX-MAX-REASONING]         local numLines = 5
01886 [GPT-5-CODEX-MAX-REASONING]         local arcSpan = 1.5  -- Radians of arc
01887 [GPT-5-CODEX-MAX-REASONING]         local startAngle = e.angle - arcSpan / 2
01888 [GPT-5-CODEX-MAX-REASONING] 
01889 [GPT-5-CODEX-MAX-REASONING]         for j = 0, numLines - 1 do
01890 [GPT-5-CODEX-MAX-REASONING]             local lineProgress = j / numLines
01891 [GPT-5-CODEX-MAX-REASONING]             local lineAlpha = alpha * (1 - lineProgress * 0.5)
01892 [GPT-5-CODEX-MAX-REASONING]             local lineRadius = radius * (0.7 + lineProgress * 0.3)
01893 [GPT-5-CODEX-MAX-REASONING] 
01894 [GPT-5-CODEX-MAX-REASONING]             local a1 = startAngle + (arcSpan * lineProgress)
01895 [GPT-5-CODEX-MAX-REASONING]             local a2 = a1 + arcSpan / numLines
01896 [GPT-5-CODEX-MAX-REASONING] 
01897 [GPT-5-CODEX-MAX-REASONING]             local x1 = e.x + math.cos(a1) * lineRadius
01898 [GPT-5-CODEX-MAX-REASONING]             local y1 = e.y + math.sin(a1) * lineRadius
01899 [GPT-5-CODEX-MAX-REASONING]             local x2 = e.x + math.cos(a2) * lineRadius
01900 [GPT-5-CODEX-MAX-REASONING]             local y2 = e.y + math.sin(a2) * lineRadius
01901 [GPT-5-CODEX-MAX-REASONING] 
01902 [GPT-5-CODEX-MAX-REASONING]             -- Use white/silver color for sword swipe
01903 [GPT-5-CODEX-MAX-REASONING]             local color = (lineAlpha > 0.5) and COLOR_WHITE or COLOR_SILVER
01904 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawLine(math.floor(x1), math.floor(y1),
01905 [GPT-5-CODEX-MAX-REASONING]                                      math.floor(x2), math.floor(y2), color)
01906 [GPT-5-CODEX-MAX-REASONING]         end
01907 [GPT-5-CODEX-MAX-REASONING]     end
01908 [GPT-5-CODEX-MAX-REASONING] end
01909 [GPT-5-CODEX-MAX-REASONING] 
01910 [GPT-5-CODEX-MAX-REASONING] -- Create blood burst effect at world position
01911 [GPT-5-CODEX-MAX-REASONING] local function createBloodEffect(worldX, worldY)
01912 [GPT-5-CODEX-MAX-REASONING]     local effect = {
01913 [GPT-5-CODEX-MAX-REASONING]         x = worldX,
01914 [GPT-5-CODEX-MAX-REASONING]         y = worldY,
01915 [GPT-5-CODEX-MAX-REASONING]         particles = {},
01916 [GPT-5-CODEX-MAX-REASONING]         life = 30  -- frames
01917 [GPT-5-CODEX-MAX-REASONING]     }
01918 [GPT-5-CODEX-MAX-REASONING]     -- Create 12 blood particles radiating outward
01919 [GPT-5-CODEX-MAX-REASONING]     for i = 1, 12 do
01920 [GPT-5-CODEX-MAX-REASONING]         local angle = (i / 12) * 6.28318
01921 [GPT-5-CODEX-MAX-REASONING]         local speed = 0.05 + (frameCount % 10) * 0.005
01922 [GPT-5-CODEX-MAX-REASONING]         table.insert(effect.particles, {
01923 [GPT-5-CODEX-MAX-REASONING]             dx = math.cos(angle) * speed,
01924 [GPT-5-CODEX-MAX-REASONING]             dy = math.sin(angle) * speed,
01925 [GPT-5-CODEX-MAX-REASONING]             ox = 0, oy = 0  -- offset from center
01926 [GPT-5-CODEX-MAX-REASONING]         })
01927 [GPT-5-CODEX-MAX-REASONING]     end
01928 [GPT-5-CODEX-MAX-REASONING]     table.insert(bloodEffects, effect)
01929 [GPT-5-CODEX-MAX-REASONING] end
01930 [GPT-5-CODEX-MAX-REASONING] 
01931 [GPT-5-CODEX-MAX-REASONING] -- Update blood effects
01932 [GPT-5-CODEX-MAX-REASONING] local function updateBloodEffects()
01933 [GPT-5-CODEX-MAX-REASONING]     local i = 1
01934 [GPT-5-CODEX-MAX-REASONING]     while i <= #bloodEffects do
01935 [GPT-5-CODEX-MAX-REASONING]         local e = bloodEffects[i]
01936 [GPT-5-CODEX-MAX-REASONING]         e.life = e.life - 1
01937 [GPT-5-CODEX-MAX-REASONING]         -- Move particles outward
01938 [GPT-5-CODEX-MAX-REASONING]         for _, p in ipairs(e.particles) do
01939 [GPT-5-CODEX-MAX-REASONING]             p.ox = p.ox + p.dx
01940 [GPT-5-CODEX-MAX-REASONING]             p.oy = p.oy + p.dy
01941 [GPT-5-CODEX-MAX-REASONING]         end
01942 [GPT-5-CODEX-MAX-REASONING]         if e.life <= 0 then
01943 [GPT-5-CODEX-MAX-REASONING]             table.remove(bloodEffects, i)
01944 [GPT-5-CODEX-MAX-REASONING]         else
01945 [GPT-5-CODEX-MAX-REASONING]             i = i + 1
01946 [GPT-5-CODEX-MAX-REASONING]         end
01947 [GPT-5-CODEX-MAX-REASONING]     end
01948 [GPT-5-CODEX-MAX-REASONING] end
01949 [GPT-5-CODEX-MAX-REASONING] 
01950 [GPT-5-CODEX-MAX-REASONING] -- Draw blood effects (in screen space, needs distance calculation)
01951 [GPT-5-CODEX-MAX-REASONING] local function drawBloodEffectAt(screenX, screenY, dist, life)
01952 [GPT-5-CODEX-MAX-REASONING]     local maxLife = 30
01953 [GPT-5-CODEX-MAX-REASONING]     local alpha = life / maxLife
01954 [GPT-5-CODEX-MAX-REASONING]     local baseSize = math.max(2, math.floor(8 / dist))
01955 [GPT-5-CODEX-MAX-REASONING] 
01956 [GPT-5-CODEX-MAX-REASONING]     -- Draw blood splatter particles
01957 [GPT-5-CODEX-MAX-REASONING]     local numDrops = 8
01958 [GPT-5-CODEX-MAX-REASONING]     for j = 1, numDrops do
01959 [GPT-5-CODEX-MAX-REASONING]         local angle = (j / numDrops) * 6.28318 + (life * 0.1)
01960 [GPT-5-CODEX-MAX-REASONING]         local spread = (maxLife - life) * 2
01961 [GPT-5-CODEX-MAX-REASONING]         local px = screenX + math.cos(angle) * spread
01962 [GPT-5-CODEX-MAX-REASONING]         local py = screenY + math.sin(angle) * spread
01963 [GPT-5-CODEX-MAX-REASONING] 
01964 [GPT-5-CODEX-MAX-REASONING]         if px >= 0 and px < 240 and py >= 0 and py < 240 then
01965 [GPT-5-CODEX-MAX-REASONING]             -- Draw blood drop
01966 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(
01967 [GPT-5-CODEX-MAX-REASONING]                 math.floor(px) - 1, math.floor(py) - 1,
01968 [GPT-5-CODEX-MAX-REASONING]                 math.floor(px) + 1, math.floor(py) + 1,
01969 [GPT-5-CODEX-MAX-REASONING]                 COLOR_RED
01970 [GPT-5-CODEX-MAX-REASONING]             )
01971 [GPT-5-CODEX-MAX-REASONING]         end
01972 [GPT-5-CODEX-MAX-REASONING]     end
01973 [GPT-5-CODEX-MAX-REASONING] end
01974 [GPT-5-CODEX-MAX-REASONING] 
01975 [GPT-5-CODEX-MAX-REASONING] -- Kill a soldier and create death effects
01976 [GPT-5-CODEX-MAX-REASONING] local function killSoldier(soldier)
01977 [GPT-5-CODEX-MAX-REASONING]     soldier.alive = false
01978 [GPT-5-CODEX-MAX-REASONING]     soldier.hp = 0
01979 [GPT-5-CODEX-MAX-REASONING]     soldier.dying = true
01980 [GPT-5-CODEX-MAX-REASONING]     soldier.dead = false
01981 [GPT-5-CODEX-MAX-REASONING]     soldier.deathFrame = 1
01982 [GPT-5-CODEX-MAX-REASONING]     soldier.deathTick = 0
01983 [GPT-5-CODEX-MAX-REASONING]     soldiersKilled = soldiersKilled + 1
01984 [GPT-5-CODEX-MAX-REASONING] 
01985 [GPT-5-CODEX-MAX-REASONING]     -- Create blood effect
01986 [GPT-5-CODEX-MAX-REASONING]     createBloodEffect(soldier.x, soldier.y)
01987 [GPT-5-CODEX-MAX-REASONING] 
01988 [GPT-5-CODEX-MAX-REASONING]     -- Play death sounds
01989 [GPT-5-CODEX-MAX-REASONING]     if soundEnabled then
01990 [GPT-5-CODEX-MAX-REASONING]         if argDeathSample then
01991 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.sample.stop(argDeathSample)
01992 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.sample.play(argDeathSample)
01993 [GPT-5-CODEX-MAX-REASONING]             if enableBootLogs then safeLog("INFO", "Play sample: arg_death1") end
01994 [GPT-5-CODEX-MAX-REASONING]         end
01995 [GPT-5-CODEX-MAX-REASONING]         if groanSynth then
01996 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.synth.playNote(groanSynth, 80, 0.8, 0.4)
01997 [GPT-5-CODEX-MAX-REASONING]         end
01998 [GPT-5-CODEX-MAX-REASONING]         if squishSynth then
01999 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.synth.playNote(squishSynth, 200, 0.9, 0.2)
02000 [GPT-5-CODEX-MAX-REASONING]         end
02001 [GPT-5-CODEX-MAX-REASONING]     end
02002 [GPT-5-CODEX-MAX-REASONING] 
02003 [GPT-5-CODEX-MAX-REASONING]     -- Check win condition
02004 [GPT-5-CODEX-MAX-REASONING]     if soldiersKilled >= totalSoldiers then
02005 [GPT-5-CODEX-MAX-REASONING]         gameState = STATE_WIN
02006 [GPT-5-CODEX-MAX-REASONING]         winSelection = 1
02007 [GPT-5-CODEX-MAX-REASONING]         winCooldown = 30  -- Half second delay before accepting input
02008 [GPT-5-CODEX-MAX-REASONING]         winBannerTimer = winBannerMax
02009 [GPT-5-CODEX-MAX-REASONING]         if soundEnabled and winLevelSample then
02010 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.sample.stop(winLevelSample)
02011 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.sample.play(winLevelSample)
02012 [GPT-5-CODEX-MAX-REASONING]             if enableBootLogs then safeLog("INFO", "Play sample: win_level") end
02013 [GPT-5-CODEX-MAX-REASONING]         end
02014 [GPT-5-CODEX-MAX-REASONING]     end
02015 [GPT-5-CODEX-MAX-REASONING] end
02016 [GPT-5-CODEX-MAX-REASONING] 
02017 [GPT-5-CODEX-MAX-REASONING] -- Check for health vial pickups
02018 [GPT-5-CODEX-MAX-REASONING] local function checkHealthPickups()
02019 [GPT-5-CODEX-MAX-REASONING]     if DEBUG_DISABLE_PROPS then
02020 [GPT-5-CODEX-MAX-REASONING]         return
02021 [GPT-5-CODEX-MAX-REASONING]     end
02022 [GPT-5-CODEX-MAX-REASONING]     local pickupRange = 0.8  -- Distance to pick up vial
02023 [GPT-5-CODEX-MAX-REASONING]     if not sprites or #sprites == 0 then return end
02024 [GPT-5-CODEX-MAX-REASONING]     if checkArrayBounds(sprites, 1, "checkHealthPickups") then
02025 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #sprites do
02026 [GPT-5-CODEX-MAX-REASONING]             if checkArrayBounds(sprites, i, "checkHealthPickups") then
02027 [GPT-5-CODEX-MAX-REASONING]                 local s = sprites[i]
02028 [GPT-5-CODEX-MAX-REASONING]         if s.t == 7 and not s.collected then
02029 [GPT-5-CODEX-MAX-REASONING]             local dx = s.x - px
02030 [GPT-5-CODEX-MAX-REASONING]             local dy = s.y - py
02031 [GPT-5-CODEX-MAX-REASONING]             local dist = math.sqrt(dx * dx + dy * dy)
02032 [GPT-5-CODEX-MAX-REASONING]             if dist < pickupRange then
02033 [GPT-5-CODEX-MAX-REASONING]                 -- Collect the vial
02034 [GPT-5-CODEX-MAX-REASONING]                 s.collected = true
02035 [GPT-5-CODEX-MAX-REASONING]                 playerHealth = MAX_HEALTH
02036 [GPT-5-CODEX-MAX-REASONING] 
02037 [GPT-5-CODEX-MAX-REASONING]                 -- Play gulp sound
02038 [GPT-5-CODEX-MAX-REASONING]                 if soundEnabled and gulpSynth then
02039 [GPT-5-CODEX-MAX-REASONING]                     vmupro.sound.synth.playNote(gulpSynth, 300, 0.8, 0.2)
02040 [GPT-5-CODEX-MAX-REASONING]                     vmupro.sound.synth.playNote(gulpSynth, 250, 0.6, 0.15)
02041 [GPT-5-CODEX-MAX-REASONING]                 end
02042 [GPT-5-CODEX-MAX-REASONING]             end
02043 [GPT-5-CODEX-MAX-REASONING]           end
02044 [GPT-5-CODEX-MAX-REASONING]         end
02045 [GPT-5-CODEX-MAX-REASONING]     end
02046 [GPT-5-CODEX-MAX-REASONING]     end
02047 [GPT-5-CODEX-MAX-REASONING] end
02048 [GPT-5-CODEX-MAX-REASONING] 
02049 [GPT-5-CODEX-MAX-REASONING] -- Draw win screen
02050 [GPT-5-CODEX-MAX-REASONING] local function drawWinScreen()
02051 [GPT-5-CODEX-MAX-REASONING]     -- Darken background (larger)
02052 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(20, 40, 220, 200, COLOR_BLACK)
02053 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(25, 45, 215, 195, COLOR_DARK_GRAY)
02054 [GPT-5-CODEX-MAX-REASONING] 
02055 [GPT-5-CODEX-MAX-REASONING]     -- Title
02056 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(30, 55, 210, 90, COLOR_GREEN)
02057 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_SMALL)
02058 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("VICTORY!", 76, 63, COLOR_WHITE, COLOR_GREEN)
02059 [GPT-5-CODEX-MAX-REASONING] 
02060 [GPT-5-CODEX-MAX-REASONING]     -- Subtitle
02061 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("The King is safe!", 56, 100, COLOR_WHITE, COLOR_DARK_GRAY)
02062 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("You cleared the level!", 44, 122, COLOR_WHITE, COLOR_DARK_GRAY)
02063 [GPT-5-CODEX-MAX-REASONING] 
02064 [GPT-5-CODEX-MAX-REASONING]     if winBannerTimer > 0 then
02065 [GPT-5-CODEX-MAX-REASONING]         local pulse = (frameCount % 20) < 10
02066 [GPT-5-CODEX-MAX-REASONING]         local bannerColor = pulse and COLOR_MAROON or COLOR_DARK_MAROON
02067 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(35, 130, 205, 154, bannerColor)
02068 [GPT-5-CODEX-MAX-REASONING]         vmupro.text.setFont(vmupro.text.FONT_SMALL)
02069 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("LEVEL COMPLETE", 46, 136, COLOR_WHITE, bannerColor)
02070 [GPT-5-CODEX-MAX-REASONING]     end
02071 [GPT-5-CODEX-MAX-REASONING] 
02072 [GPT-5-CODEX-MAX-REASONING]     -- Menu option
02073 [GPT-5-CODEX-MAX-REASONING]     local y = 160
02074 [GPT-5-CODEX-MAX-REASONING]     local bgColor = COLOR_DARK_GRAY
02075 [GPT-5-CODEX-MAX-REASONING]     local textColor = COLOR_GRAY
02076 [GPT-5-CODEX-MAX-REASONING]     if winSelection == 1 then
02077 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(40, y, 200, y + 20, COLOR_MAROON)
02078 [GPT-5-CODEX-MAX-REASONING]         bgColor = COLOR_MAROON
02079 [GPT-5-CODEX-MAX-REASONING]         textColor = COLOR_WHITE
02080 [GPT-5-CODEX-MAX-REASONING]     end
02081 [GPT-5-CODEX-MAX-REASONING]     local winText = "MAIN MENU"
02082 [GPT-5-CODEX-MAX-REASONING]     if currentLevel < MAX_LEVEL then
02083 [GPT-5-CODEX-MAX-REASONING]         winText = "NEXT LEVEL"
02084 [GPT-5-CODEX-MAX-REASONING]     end
02085 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_SMALL)
02086 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText(winText, 74, y + 2, textColor, bgColor)
02087 [GPT-5-CODEX-MAX-REASONING] end
02088 [GPT-5-CODEX-MAX-REASONING] 
02089 [GPT-5-CODEX-MAX-REASONING] -- Draw health UI (potion with red liquid)
02090 [GPT-5-CODEX-MAX-REASONING] local function drawHealthUI()
02091 [GPT-5-CODEX-MAX-REASONING]     -- Position in lower right corner
02092 [GPT-5-CODEX-MAX-REASONING]     local potionX = 175
02093 [GPT-5-CODEX-MAX-REASONING]     local potionY = 175
02094 [GPT-5-CODEX-MAX-REASONING] 
02095 [GPT-5-CODEX-MAX-REASONING]     -- Draw red "liquid" behind the potion
02096 [GPT-5-CODEX-MAX-REASONING]     -- The liquid level drains from top to bottom based on health
02097 [GPT-5-CODEX-MAX-REASONING]     local healthPercent = playerHealth / MAX_HEALTH
02098 [GPT-5-CODEX-MAX-REASONING] 
02099 [GPT-5-CODEX-MAX-REASONING]     -- Liquid area sized to fit inside the vial's transparent area
02100 [GPT-5-CODEX-MAX-REASONING]     -- Potion content is roughly 36x44 pixels, vial interior is smaller
02101 [GPT-5-CODEX-MAX-REASONING]     local liquidRadius = 11  -- Smaller radius to fit inside vial
02102 [GPT-5-CODEX-MAX-REASONING]     local liquidCenterX = potionX + 29  -- Center of vial horizontally
02103 [GPT-5-CODEX-MAX-REASONING]     local liquidCenterY = potionY + 32  -- Center of vial body
02104 [GPT-5-CODEX-MAX-REASONING] 
02105 [GPT-5-CODEX-MAX-REASONING]     -- Calculate liquid top based on health (drains completely from top to bottom)
02106 [GPT-5-CODEX-MAX-REASONING]     -- At 100%: liquidTop = centerY - radius (full circle)
02107 [GPT-5-CODEX-MAX-REASONING]     -- At 0%: liquidTop = centerY + radius (empty, nothing drawn)
02108 [GPT-5-CODEX-MAX-REASONING]     local liquidBottom = liquidCenterY + liquidRadius
02109 [GPT-5-CODEX-MAX-REASONING]     local fullHeight = 2 * liquidRadius
02110 [GPT-5-CODEX-MAX-REASONING]     local liquidTop = liquidBottom - math.floor(fullHeight * healthPercent)
02111 [GPT-5-CODEX-MAX-REASONING] 
02112 [GPT-5-CODEX-MAX-REASONING]     -- Draw red liquid as horizontal lines to simulate filled circle
02113 [GPT-5-CODEX-MAX-REASONING]     for y = liquidTop, liquidBottom do
02114 [GPT-5-CODEX-MAX-REASONING]         local dy = y - liquidCenterY
02115 [GPT-5-CODEX-MAX-REASONING]         local halfWidth = math.sqrt(math.max(0, liquidRadius * liquidRadius - dy * dy))
02116 [GPT-5-CODEX-MAX-REASONING]         if halfWidth > 0 then
02117 [GPT-5-CODEX-MAX-REASONING]             local x1 = math.floor(liquidCenterX - halfWidth)
02118 [GPT-5-CODEX-MAX-REASONING]             local x2 = math.floor(liquidCenterX + halfWidth)
02119 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawLine(x1, y, x2, y, COLOR_RED)
02120 [GPT-5-CODEX-MAX-REASONING]         end
02121 [GPT-5-CODEX-MAX-REASONING]     end
02122 [GPT-5-CODEX-MAX-REASONING] 
02123 [GPT-5-CODEX-MAX-REASONING]     -- Draw the potion sprite on top
02124 [GPT-5-CODEX-MAX-REASONING]     if potionSprite then
02125 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.draw(potionSprite, potionX, potionY, vmupro.sprite.kImageUnflipped)
02126 [GPT-5-CODEX-MAX-REASONING]     end
02127 [GPT-5-CODEX-MAX-REASONING] 
02128 [GPT-5-CODEX-MAX-REASONING]     -- Draw health percentage text (if enabled)
02129 [GPT-5-CODEX-MAX-REASONING]     if showHealthPercent then
02130 [GPT-5-CODEX-MAX-REASONING]         vmupro.text.setFont(vmupro.text.FONT_SMALL)
02131 [GPT-5-CODEX-MAX-REASONING]         local healthText = tostring(math.floor(playerHealth)) .. "%"
02132 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(healthText, potionX + 18, potionY + 50, COLOR_WHITE, COLOR_BLACK)
02133 [GPT-5-CODEX-MAX-REASONING]     end
02134 [GPT-5-CODEX-MAX-REASONING] end
02135 [GPT-5-CODEX-MAX-REASONING] 
02136 [GPT-5-CODEX-MAX-REASONING] -- Draw title screen
02137 [GPT-5-CODEX-MAX-REASONING] local function drawTitleScreenImpl()
02138 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "C drawTitleScreen")
02139 [GPT-5-CODEX-MAX-REASONING]     -- Draw title background image
02140 [GPT-5-CODEX-MAX-REASONING]     if titleSprite then
02141 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.draw(titleSprite, 0, 0, vmupro.sprite.kImageUnflipped)
02142 [GPT-5-CODEX-MAX-REASONING]     else
02143 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.clear(COLOR_BLACK)
02144 [GPT-5-CODEX-MAX-REASONING]     end
02145 [GPT-5-CODEX-MAX-REASONING]     drawBmpProbeOverlay()
02146 [GPT-5-CODEX-MAX-REASONING] 
02147 [GPT-5-CODEX-MAX-REASONING]     if titleInOptions then
02148 [GPT-5-CODEX-MAX-REASONING]         -- Options submenu
02149 [GPT-5-CODEX-MAX-REASONING]         logBoot(vmupro.system.LOG_ERROR, "D title options text")
02150 [GPT-5-CODEX-MAX-REASONING]         -- Large single-column menu box (extend to bottom)
02151 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(20, 50, 220, 239, COLOR_BLACK)
02152 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(25, 55, 215, 237, COLOR_DARK_GRAY)
02153 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(30, 60, 210, 82, COLOR_MAROON)
02154 [GPT-5-CODEX-MAX-REASONING]         vmupro.text.setFont(vmupro.text.FONT_TINY_6x8)
02155 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(titleInDebug and "DEBUG" or "OPTIONS", 92, 65, COLOR_WHITE, COLOR_MAROON)
02156 [GPT-5-CODEX-MAX-REASONING] 
02157 [GPT-5-CODEX-MAX-REASONING]         local items = {}
02158 [GPT-5-CODEX-MAX-REASONING]         if titleInDebug then
02159 [GPT-5-CODEX-MAX-REASONING]             local logsText = "LOGS: " .. (enableBootLogs and "ON" or "OFF")
02160 [GPT-5-CODEX-MAX-REASONING]             local enemiesText = "ENEMIES: " .. (DEBUG_DISABLE_ENEMIES and "OFF" or "ON")
02161 [GPT-5-CODEX-MAX-REASONING]             local propsText = "PROPS: " .. (DEBUG_DISABLE_PROPS and "OFF" or "ON")
02162 [GPT-5-CODEX-MAX-REASONING]             local texturesText = "TEXTURES: " .. (DEBUG_DISABLE_WALL_TEXTURE and "OFF" or "ON")
02163 [GPT-5-CODEX-MAX-REASONING]             local fpsText = "FPS: " .. (showFpsOverlay and "ON" or "OFF")
02164 [GPT-5-CODEX-MAX-REASONING]             local resLabel = (LOW_RES_MODE == "fast") and "FAST" or "QUALITY"
02165 [GPT-5-CODEX-MAX-REASONING]             local resText = "WALL RES: " .. resLabel
02166 [GPT-5-CODEX-MAX-REASONING]             local minimapText = "MINIMAP: " .. (SHOW_MINIMAP and "ON" or "OFF")
02167 [GPT-5-CODEX-MAX-REASONING]             local renderLabel = "CLASSIC"
02168 [GPT-5-CODEX-MAX-REASONING]             if RENDERER_MODE == "exp_hybrid" then
02169 [GPT-5-CODEX-MAX-REASONING]                 renderLabel = "EXP-H"
02170 [GPT-5-CODEX-MAX-REASONING]             elseif RENDERER_MODE == "exp_pure" then
02171 [GPT-5-CODEX-MAX-REASONING]                 renderLabel = "EXP-P"
02172 [GPT-5-CODEX-MAX-REASONING]             end
02173 [GPT-5-CODEX-MAX-REASONING]             local rendererText = "RENDER: " .. renderLabel
02174 [GPT-5-CODEX-MAX-REASONING]             local fpsTargetText = "FPS TARGET: " .. string.upper(FPS_TARGET_MODE)
02175 [GPT-5-CODEX-MAX-REASONING]             items = {logsText, enemiesText, propsText, texturesText, fpsText, resText, minimapText, rendererText, fpsTargetText, "BACK"}
02176 [GPT-5-CODEX-MAX-REASONING]         else
02177 [GPT-5-CODEX-MAX-REASONING]             local levelLabel = LEVEL_SELECT_LIST[selectedLevel] and LEVEL_SELECT_LIST[selectedLevel].label or tostring(selectedLevel)
02178 [GPT-5-CODEX-MAX-REASONING]             local levelText = "LEVEL: " .. levelLabel
02179 [GPT-5-CODEX-MAX-REASONING]             local soundText = "SOUND: " .. (soundEnabled and "ON" or "OFF")
02180 [GPT-5-CODEX-MAX-REASONING]             local healthText = "HEALTH%: " .. (showHealthPercent and "ON" or "OFF")
02181 [GPT-5-CODEX-MAX-REASONING]             local renderLabel = "CLASSIC"
02182 [GPT-5-CODEX-MAX-REASONING]             if RENDERER_MODE == "exp_hybrid" then
02183 [GPT-5-CODEX-MAX-REASONING]                 renderLabel = "EXP-H"
02184 [GPT-5-CODEX-MAX-REASONING]             elseif RENDERER_MODE == "exp_pure" then
02185 [GPT-5-CODEX-MAX-REASONING]                 renderLabel = "EXP-P"
02186 [GPT-5-CODEX-MAX-REASONING]             end
02187 [GPT-5-CODEX-MAX-REASONING]             local rendererText = "RENDER: " .. renderLabel
02188 [GPT-5-CODEX-MAX-REASONING]             items = {levelText, soundText, healthText, rendererText, "DEBUG", "BACK"}
02189 [GPT-5-CODEX-MAX-REASONING]         end
02190 [GPT-5-CODEX-MAX-REASONING]         for i, item in ipairs(items) do
02191 [GPT-5-CODEX-MAX-REASONING]             local x = 34
02192 [GPT-5-CODEX-MAX-REASONING]             local startY = titleInDebug and 80 or 90
02193 [GPT-5-CODEX-MAX-REASONING]             local stepY = titleInDebug and 16 or 18
02194 [GPT-5-CODEX-MAX-REASONING]             local y = startY + (i - 1) * stepY
02195 [GPT-5-CODEX-MAX-REASONING]             local bgColor = COLOR_DARK_GRAY
02196 [GPT-5-CODEX-MAX-REASONING]             local textColor = COLOR_GRAY
02197 [GPT-5-CODEX-MAX-REASONING]             local sel = titleInDebug and titleDebugSelection or titleOptionsSelection
02198 [GPT-5-CODEX-MAX-REASONING]             if i == sel then
02199 [GPT-5-CODEX-MAX-REASONING]                 local boxH = titleInDebug and 16 or 18
02200 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawFillRect(32, y, 208, y + boxH, COLOR_MAROON)
02201 [GPT-5-CODEX-MAX-REASONING]                 bgColor = COLOR_MAROON
02202 [GPT-5-CODEX-MAX-REASONING]                 textColor = COLOR_WHITE
02203 [GPT-5-CODEX-MAX-REASONING]             end
02204 [GPT-5-CODEX-MAX-REASONING]             if titleInDebug then
02205 [GPT-5-CODEX-MAX-REASONING]                 vmupro.text.setFont(vmupro.text.FONT_MONO_7x13)
02206 [GPT-5-CODEX-MAX-REASONING]             else
02207 [GPT-5-CODEX-MAX-REASONING]                 vmupro.text.setFont(vmupro.text.FONT_TINY_6x8)
02208 [GPT-5-CODEX-MAX-REASONING]             end
02209 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawText(item, x, y + 2, textColor, bgColor)
02210 [GPT-5-CODEX-MAX-REASONING]         end
02211 [GPT-5-CODEX-MAX-REASONING]     else
02212 [GPT-5-CODEX-MAX-REASONING]         -- Main title menu
02213 [GPT-5-CODEX-MAX-REASONING]         logBoot(vmupro.system.LOG_ERROR, "D title main text")
02214 [GPT-5-CODEX-MAX-REASONING]         -- Compact menu box for 3 items
02215 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(60, 140, 180, 230, COLOR_BLACK)
02216 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(65, 145, 175, 225, COLOR_DARK_GRAY)
02217 [GPT-5-CODEX-MAX-REASONING]         vmupro.text.setFont(vmupro.text.FONT_SMALL)
02218 [GPT-5-CODEX-MAX-REASONING]         local items = {"START GAME", "OPTIONS", "EXIT"}
02219 [GPT-5-CODEX-MAX-REASONING]         for i, item in ipairs(items) do
02220 [GPT-5-CODEX-MAX-REASONING]             local y = 153 + (i - 1) * 18
02221 [GPT-5-CODEX-MAX-REASONING]             local bgColor = COLOR_DARK_GRAY
02222 [GPT-5-CODEX-MAX-REASONING]             local textColor = COLOR_GRAY
02223 [GPT-5-CODEX-MAX-REASONING]             if i == titleSelection then
02224 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawFillRect(70, y, 170, y + 18, COLOR_MAROON)
02225 [GPT-5-CODEX-MAX-REASONING]                 bgColor = COLOR_MAROON
02226 [GPT-5-CODEX-MAX-REASONING]                 textColor = COLOR_WHITE
02227 [GPT-5-CODEX-MAX-REASONING]             end
02228 [GPT-5-CODEX-MAX-REASONING]             vmupro.text.setFont(vmupro.text.FONT_SMALL)
02229 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawText(item, 78, y + 2, textColor, bgColor)
02230 [GPT-5-CODEX-MAX-REASONING]         end
02231 [GPT-5-CODEX-MAX-REASONING]     end
02232 [GPT-5-CODEX-MAX-REASONING] end
02233 [GPT-5-CODEX-MAX-REASONING] 
02234 [GPT-5-CODEX-MAX-REASONING] drawTitleScreen = drawTitleScreenImpl
02235 [GPT-5-CODEX-MAX-REASONING] logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen bound to impl")
02236 [GPT-5-CODEX-MAX-REASONING] 
02237 [GPT-5-CODEX-MAX-REASONING] -- Draw game over screen
02238 [GPT-5-CODEX-MAX-REASONING] local function drawGameOver()
02239 [GPT-5-CODEX-MAX-REASONING]     -- Darken background
02240 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(40, 70, 200, 195, COLOR_BLACK)
02241 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(45, 75, 195, 190, COLOR_DARK_GRAY)
02242 [GPT-5-CODEX-MAX-REASONING] 
02243 [GPT-5-CODEX-MAX-REASONING]     -- Title
02244 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(50, 80, 190, 102, COLOR_MAROON)
02245 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_SMALL)
02246 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("GAME OVER", 76, 85, COLOR_WHITE, COLOR_MAROON)
02247 [GPT-5-CODEX-MAX-REASONING] 
02248 [GPT-5-CODEX-MAX-REASONING]     -- Menu items
02249 [GPT-5-CODEX-MAX-REASONING]     local items = {"RESTART", "MENU", "QUIT"}
02250 [GPT-5-CODEX-MAX-REASONING]     for i, item in ipairs(items) do
02251 [GPT-5-CODEX-MAX-REASONING]         local y = 110 + (i - 1) * 18
02252 [GPT-5-CODEX-MAX-REASONING]         local bgColor = COLOR_DARK_GRAY
02253 [GPT-5-CODEX-MAX-REASONING]         local textColor = COLOR_GRAY
02254 [GPT-5-CODEX-MAX-REASONING]         if i == gameOverSelection then
02255 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(50, y, 190, y + 18, COLOR_MAROON)
02256 [GPT-5-CODEX-MAX-REASONING]             bgColor = COLOR_MAROON
02257 [GPT-5-CODEX-MAX-REASONING]             textColor = COLOR_WHITE
02258 [GPT-5-CODEX-MAX-REASONING]         end
02259 [GPT-5-CODEX-MAX-REASONING]         vmupro.text.setFont(vmupro.text.FONT_SMALL)
02260 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(item, 86, y + 2, textColor, bgColor)
02261 [GPT-5-CODEX-MAX-REASONING]     end
02262 [GPT-5-CODEX-MAX-REASONING] end
02263 [GPT-5-CODEX-MAX-REASONING] 
02264 [GPT-5-CODEX-MAX-REASONING] -- Reset game state for restart
02265 [GPT-5-CODEX-MAX-REASONING] local function resetGame()
02266 [GPT-5-CODEX-MAX-REASONING]     restartLevel()
02267 [GPT-5-CODEX-MAX-REASONING] end
02268 [GPT-5-CODEX-MAX-REASONING] 
02269 [GPT-5-CODEX-MAX-REASONING] -- Collision detection for sprites
02270 [GPT-5-CODEX-MAX-REASONING] function collidesWithSprite(nx, ny)
02271 [GPT-5-CODEX-MAX-REASONING]     if not sprites or #sprites == 0 then return false end
02272 [GPT-5-CODEX-MAX-REASONING]     if checkArrayBounds(sprites, 1, "collidesWithSprite") then
02273 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #sprites do
02274 [GPT-5-CODEX-MAX-REASONING]             if checkArrayBounds(sprites, i, "collidesWithSprite") then
02275 [GPT-5-CODEX-MAX-REASONING]                 local s = sprites[i]
02276 [GPT-5-CODEX-MAX-REASONING]                 if DEBUG_DISABLE_ENEMIES and isEnemyType(s.t) then
02277 [GPT-5-CODEX-MAX-REASONING]                     goto continue_collide
02278 [GPT-5-CODEX-MAX-REASONING]                 end
02279 [GPT-5-CODEX-MAX-REASONING]                 if DEBUG_DISABLE_PROPS and isPropType(s.t) then
02280 [GPT-5-CODEX-MAX-REASONING]                     goto continue_collide
02281 [GPT-5-CODEX-MAX-REASONING]                 end
02282 [GPT-5-CODEX-MAX-REASONING]                 if s.t == 5 and (s.dying or s.dead) then
02283 [GPT-5-CODEX-MAX-REASONING]                     goto continue_collide
02284 [GPT-5-CODEX-MAX-REASONING]                 end
02285 [GPT-5-CODEX-MAX-REASONING]                 if s.t == 7 then
02286 [GPT-5-CODEX-MAX-REASONING]                     goto continue_collide
02287 [GPT-5-CODEX-MAX-REASONING]                 end
02288 [GPT-5-CODEX-MAX-REASONING]                 local dx, dy = nx - s.x, ny - s.y
02289 [GPT-5-CODEX-MAX-REASONING]                 local dist = math.sqrt(dx * dx + dy * dy)
02290 [GPT-5-CODEX-MAX-REASONING]                 if dist < 0.4 then  -- Collision radius
02291 [GPT-5-CODEX-MAX-REASONING]                     return true
02292 [GPT-5-CODEX-MAX-REASONING]                 end
02293 [GPT-5-CODEX-MAX-REASONING]                 ::continue_collide::
02294 [GPT-5-CODEX-MAX-REASONING]             end
02295 [GPT-5-CODEX-MAX-REASONING]         end
02296 [GPT-5-CODEX-MAX-REASONING]     end
02297 [GPT-5-CODEX-MAX-REASONING]     return false
02298 [GPT-5-CODEX-MAX-REASONING] end
02299 [GPT-5-CODEX-MAX-REASONING] 
02300 [GPT-5-CODEX-MAX-REASONING] local function getWallColor(wtype, side)
02301 [GPT-5-CODEX-MAX-REASONING]     if wtype == 1 then
02302 [GPT-5-CODEX-MAX-REASONING]         if side == 1 then return COLOR_STONE_D else return COLOR_STONE_L end
02303 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 2 then
02304 [GPT-5-CODEX-MAX-REASONING]         if side == 1 then return COLOR_BRICK_D else return COLOR_BRICK_L end
02305 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 3 then
02306 [GPT-5-CODEX-MAX-REASONING]         if side == 1 then return COLOR_MOSS_D else return COLOR_MOSS_L end
02307 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 4 then
02308 [GPT-5-CODEX-MAX-REASONING]         if side == 1 then return COLOR_METAL_D else return COLOR_METAL_L end
02309 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 5 then
02310 [GPT-5-CODEX-MAX-REASONING]         if side == 1 then return COLOR_WOOD_D else return COLOR_WOOD_L end
02311 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 6 then
02312 [GPT-5-CODEX-MAX-REASONING]         if side == 1 then return COLOR_BRICK_D else return COLOR_BRICK_L end
02313 [GPT-5-CODEX-MAX-REASONING]     else
02314 [GPT-5-CODEX-MAX-REASONING]         if side == 1 then return COLOR_STONE_D else return COLOR_STONE_L end
02315 [GPT-5-CODEX-MAX-REASONING]     end
02316 [GPT-5-CODEX-MAX-REASONING] end
02317 [GPT-5-CODEX-MAX-REASONING] 
02318 [GPT-5-CODEX-MAX-REASONING] -- Movement collision helper (walls + sprites)
02319 [GPT-5-CODEX-MAX-REASONING] function canMove(x, y)
02320 [GPT-5-CODEX-MAX-REASONING]     if not isWalkable(x, y) then
02321 [GPT-5-CODEX-MAX-REASONING]         return false
02322 [GPT-5-CODEX-MAX-REASONING]     end
02323 [GPT-5-CODEX-MAX-REASONING]     if collidesWithSprite(x, y) then
02324 [GPT-5-CODEX-MAX-REASONING]         return false
02325 [GPT-5-CODEX-MAX-REASONING]     end
02326 [GPT-5-CODEX-MAX-REASONING]     return true
02327 [GPT-5-CODEX-MAX-REASONING] end
02328 [GPT-5-CODEX-MAX-REASONING] 
02329 [GPT-5-CODEX-MAX-REASONING] local function fogBlend(color, dist)
02330 [GPT-5-CODEX-MAX-REASONING]     if dist <= FOG_START then return color end
02331 [GPT-5-CODEX-MAX-REASONING]     if dist >= FOG_END then return FOG_COLOR end
02332 [GPT-5-CODEX-MAX-REASONING]     local t = (dist - FOG_START) / (FOG_END - FOG_START)
02333 [GPT-5-CODEX-MAX-REASONING]     local r = color & 0x1F
02334 [GPT-5-CODEX-MAX-REASONING]     local g = (color >> 5) & 0x3F
02335 [GPT-5-CODEX-MAX-REASONING]     local b = (color >> 11) & 0x1F
02336 [GPT-5-CODEX-MAX-REASONING]     local fr = FOG_COLOR & 0x1F
02337 [GPT-5-CODEX-MAX-REASONING]     local fg = (FOG_COLOR >> 5) & 0x3F
02338 [GPT-5-CODEX-MAX-REASONING]     local fb = (FOG_COLOR >> 11) & 0x1F
02339 [GPT-5-CODEX-MAX-REASONING]     local nr = math.floor(r + (fr - r) * t + 0.5)
02340 [GPT-5-CODEX-MAX-REASONING]     local ng = math.floor(g + (fg - g) * t + 0.5)
02341 [GPT-5-CODEX-MAX-REASONING]     local nb = math.floor(b + (fb - b) * t + 0.5)
02342 [GPT-5-CODEX-MAX-REASONING]     return (nb << 11) | (ng << 5) | nr
02343 [GPT-5-CODEX-MAX-REASONING] end
02344 [GPT-5-CODEX-MAX-REASONING] 
02345 [GPT-5-CODEX-MAX-REASONING] local function drawWallTexture(wtype, side, sx, y1, y2)
02346 [GPT-5-CODEX-MAX-REASONING]     local sprite = nil
02347 [GPT-5-CODEX-MAX-REASONING]     if wtype == 1 or wtype == 6 then
02348 [GPT-5-CODEX-MAX-REASONING]         sprite = wallStone
02349 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 2 then
02350 [GPT-5-CODEX-MAX-REASONING]         sprite = wallBrick
02351 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 3 then
02352 [GPT-5-CODEX-MAX-REASONING]         sprite = wallMoss
02353 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 4 then
02354 [GPT-5-CODEX-MAX-REASONING]         sprite = wallMetal
02355 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 5 then
02356 [GPT-5-CODEX-MAX-REASONING]         sprite = wallWood
02357 [GPT-5-CODEX-MAX-REASONING]     end
02358 [GPT-5-CODEX-MAX-REASONING] 
02359 [GPT-5-CODEX-MAX-REASONING]     -- Safety check: sprite must exist
02360 [GPT-5-CODEX-MAX-REASONING]     if not sprite then
02361 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: No sprite for wtype=" .. tostring(wtype))
02362 [GPT-5-CODEX-MAX-REASONING]         return
02363 [GPT-5-CODEX-MAX-REASONING]     end
02364 [GPT-5-CODEX-MAX-REASONING] 
02365 [GPT-5-CODEX-MAX-REASONING]     -- Safety check: sprite dimensions must be valid
02366 [GPT-5-CODEX-MAX-REASONING]     if not sprite.width or not sprite.height then
02367 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: Invalid sprite dimensions for wtype=" .. tostring(wtype))
02368 [GPT-5-CODEX-MAX-REASONING]         return
02369 [GPT-5-CODEX-MAX-REASONING]     end
02370 [GPT-5-CODEX-MAX-REASONING] 
02371 [GPT-5-CODEX-MAX-REASONING]     local texW, texH = sprite.width, sprite.height
02372 [GPT-5-CODEX-MAX-REASONING]     renderLog("drawWallTexture: wtype=" .. tostring(wtype) .. " texW=" .. tostring(texW) .. " texH=" .. tostring(texH))
02373 [GPT-5-CODEX-MAX-REASONING] 
02374 [GPT-5-CODEX-MAX-REASONING]     -- Safety check: wall height must be positive
02375 [GPT-5-CODEX-MAX-REASONING]     local wallH = y2 - y1
02376 [GPT-5-CODEX-MAX-REASONING]     if wallH <= 0 then
02377 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: Invalid wall height (y1=" .. tostring(y1) .. " y2=" .. tostring(y2) .. ")")
02378 [GPT-5-CODEX-MAX-REASONING]         return
02379 [GPT-5-CODEX-MAX-REASONING]     end
02380 [GPT-5-CODEX-MAX-REASONING] 
02381 [GPT-5-CODEX-MAX-REASONING]     -- Detect texture size and compute appropriate scale
02382 [GPT-5-CODEX-MAX-REASONING]     local scaleX = 1.0
02383 [GPT-5-CODEX-MAX-REASONING]     local validTexture = false
02384 [GPT-5-CODEX-MAX-REASONING] 
02385 [GPT-5-CODEX-MAX-REASONING]     -- Supported texture sizes with their scale factors
02386 [GPT-5-CODEX-MAX-REASONING]     if texW == 128 and texH == 256 then
02387 [GPT-5-CODEX-MAX-REASONING]         -- Vertical texture (128x256) - standard wall
02388 [GPT-5-CODEX-MAX-REASONING]         scaleX = 4 / texW  -- Scale to 4 pixels wide
02389 [GPT-5-CODEX-MAX-REASONING]         validTexture = true
02390 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: 128x256 texture detected, scaleX=" .. tostring(scaleX))
02391 [GPT-5-CODEX-MAX-REASONING]     elseif texW == 256 and texH == 128 then
02392 [GPT-5-CODEX-MAX-REASONING]         -- Horizontal texture (256x128) - wide wall
02393 [GPT-5-CODEX-MAX-REASONING]         scaleX = 4 / texW  -- Scale to 4 pixels wide
02394 [GPT-5-CODEX-MAX-REASONING]         validTexture = true
02395 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: 256x128 texture detected, scaleX=" .. tostring(scaleX))
02396 [GPT-5-CODEX-MAX-REASONING]     elseif texW == 128 and texH == 128 then
02397 [GPT-5-CODEX-MAX-REASONING]         -- Square texture (128x128)
02398 [GPT-5-CODEX-MAX-REASONING]         scaleX = 4 / texW  -- Scale to 4 pixels wide
02399 [GPT-5-CODEX-MAX-REASONING]         validTexture = true
02400 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: 128x128 texture detected, scaleX=" .. tostring(scaleX))
02401 [GPT-5-CODEX-MAX-REASONING]     else
02402 [GPT-5-CODEX-MAX-REASONING]         -- Unknown texture size - log error
02403 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: ERROR - Unsupported texture size " .. tostring(texW) .. "x" .. tostring(texH))
02404 [GPT-5-CODEX-MAX-REASONING]         return
02405 [GPT-5-CODEX-MAX-REASONING]     end
02406 [GPT-5-CODEX-MAX-REASONING] 
02407 [GPT-5-CODEX-MAX-REASONING]     -- Safety check: validate scaleX value
02408 [GPT-5-CODEX-MAX-REASONING]     if scaleX <= 0 or scaleX ~= scaleX or scaleX == math.huge or scaleX == -math.huge then
02409 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: ERROR - Invalid scaleX value: " .. tostring(scaleX))
02410 [GPT-5-CODEX-MAX-REASONING]         return
02411 [GPT-5-CODEX-MAX-REASONING]     end
02412 [GPT-5-CODEX-MAX-REASONING] 
02413 [GPT-5-CODEX-MAX-REASONING]     -- If wall is extremely tall (very close), draw a single scaled texture to avoid huge tiling
02414 [GPT-5-CODEX-MAX-REASONING]     if wallH > (texH * 4) then
02415 [GPT-5-CODEX-MAX-REASONING]         local scaleY = wallH / texH
02416 [GPT-5-CODEX-MAX-REASONING]         if scaleY > 10 then scaleY = 10 end
02417 [GPT-5-CODEX-MAX-REASONING]         if safeScale(sprite, scaleX, scaleY, "drawWallTexture_tall") then
02418 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.drawScaled(sprite, sx, y1, scaleX, scaleY, vmupro.sprite.kImageUnflipped)
02419 [GPT-5-CODEX-MAX-REASONING]         end
02420 [GPT-5-CODEX-MAX-REASONING]         return
02421 [GPT-5-CODEX-MAX-REASONING]     end
02422 [GPT-5-CODEX-MAX-REASONING] 
02423 [GPT-5-CODEX-MAX-REASONING]     -- Tile vertically
02424 [GPT-5-CODEX-MAX-REASONING]     local tileH = texH
02425 [GPT-5-CODEX-MAX-REASONING]     local fullTiles = math.floor(wallH / tileH)
02426 [GPT-5-CODEX-MAX-REASONING]     local remainder = wallH - (fullTiles * tileH)
02427 [GPT-5-CODEX-MAX-REASONING] 
02428 [GPT-5-CODEX-MAX-REASONING]     renderLog("drawWallTexture: wallH=" .. tostring(wallH) .. " tileH=" .. tostring(tileH) .. " fullTiles=" .. tostring(fullTiles) .. " remainder=" .. tostring(remainder))
02429 [GPT-5-CODEX-MAX-REASONING] 
02430 [GPT-5-CODEX-MAX-REASONING]     -- Safety check: ensure fullTiles is reasonable
02431 [GPT-5-CODEX-MAX-REASONING]     if fullTiles < 0 or fullTiles > 1000 then
02432 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: ERROR - Invalid fullTiles count: " .. tostring(fullTiles))
02433 [GPT-5-CODEX-MAX-REASONING]         return
02434 [GPT-5-CODEX-MAX-REASONING]     end
02435 [GPT-5-CODEX-MAX-REASONING] 
02436 [GPT-5-CODEX-MAX-REASONING]     local drawY = y1
02437 [GPT-5-CODEX-MAX-REASONING]     for i = 1, fullTiles do
02438 [GPT-5-CODEX-MAX-REASONING]         -- Safety check: verify drawY is within screen bounds
02439 [GPT-5-CODEX-MAX-REASONING]         if drawY < 0 or drawY > 240 then
02440 [GPT-5-CODEX-MAX-REASONING]             renderLog("drawWallTexture: WARNING - drawY out of bounds: " .. tostring(drawY))
02441 [GPT-5-CODEX-MAX-REASONING]         end
02442 [GPT-5-CODEX-MAX-REASONING] 
02443 [GPT-5-CODEX-MAX-REASONING]         -- Safety check: verify coordinates are valid
02444 [GPT-5-CODEX-MAX-REASONING]         if sx < 0 or sx > 400 then
02445 [GPT-5-CODEX-MAX-REASONING]             renderLog("drawWallTexture: WARNING - sx out of bounds: " .. tostring(sx))
02446 [GPT-5-CODEX-MAX-REASONING]         end
02447 [GPT-5-CODEX-MAX-REASONING] 
02448 [GPT-5-CODEX-MAX-REASONING]         if safeScale(sprite, scaleX, 1.0, "drawWallTexture") then
02449 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.drawScaled(sprite, sx, drawY, scaleX, 1.0, vmupro.sprite.kImageUnflipped)
02450 [GPT-5-CODEX-MAX-REASONING]         end
02451 [GPT-5-CODEX-MAX-REASONING]         drawY = drawY + tileH
02452 [GPT-5-CODEX-MAX-REASONING]     end
02453 [GPT-5-CODEX-MAX-REASONING] 
02454 [GPT-5-CODEX-MAX-REASONING]     if remainder > 0 then
02455 [GPT-5-CODEX-MAX-REASONING]         local scaleY = remainder / tileH
02456 [GPT-5-CODEX-MAX-REASONING] 
02457 [GPT-5-CODEX-MAX-REASONING]         -- Safety check: validate scaleY value
02458 [GPT-5-CODEX-MAX-REASONING]         if scaleY <= 0 or scaleY > 1.0 or scaleY ~= scaleY or scaleY == math.huge or scaleY == -math.huge then
02459 [GPT-5-CODEX-MAX-REASONING]             renderLog("drawWallTexture: ERROR - Invalid scaleY value: " .. tostring(scaleY))
02460 [GPT-5-CODEX-MAX-REASONING]             return
02461 [GPT-5-CODEX-MAX-REASONING]         end
02462 [GPT-5-CODEX-MAX-REASONING] 
02463 [GPT-5-CODEX-MAX-REASONING]         renderLog("drawWallTexture: Drawing remainder tile with scaleY=" .. tostring(scaleY))
02464 [GPT-5-CODEX-MAX-REASONING] 
02465 [GPT-5-CODEX-MAX-REASONING]         -- Safety check: verify drawY is within screen bounds
02466 [GPT-5-CODEX-MAX-REASONING]         if drawY < 0 or drawY > 240 then
02467 [GPT-5-CODEX-MAX-REASONING]             renderLog("drawWallTexture: WARNING - drawY out of bounds for remainder: " .. tostring(drawY))
02468 [GPT-5-CODEX-MAX-REASONING]         end
02469 [GPT-5-CODEX-MAX-REASONING] 
02470 [GPT-5-CODEX-MAX-REASONING]         if safeScale(sprite, scaleX, scaleY, "drawWallTexture_remainder") then
02471 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.drawScaled(sprite, sx, drawY, scaleX, scaleY, vmupro.sprite.kImageUnflipped)
02472 [GPT-5-CODEX-MAX-REASONING]         end
02473 [GPT-5-CODEX-MAX-REASONING]     end
02474 [GPT-5-CODEX-MAX-REASONING] end
02475 [GPT-5-CODEX-MAX-REASONING] 
02476 [GPT-5-CODEX-MAX-REASONING] local function getWallSheet(wtype)
02477 [GPT-5-CODEX-MAX-REASONING]     if wtype == 1 or wtype == 6 then
02478 [GPT-5-CODEX-MAX-REASONING]         return wallSheets.stone
02479 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 2 then
02480 [GPT-5-CODEX-MAX-REASONING]         return wallSheets.brick
02481 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 3 then
02482 [GPT-5-CODEX-MAX-REASONING]         return wallSheets.moss
02483 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 4 then
02484 [GPT-5-CODEX-MAX-REASONING]         return wallSheets.metal
02485 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 5 then
02486 [GPT-5-CODEX-MAX-REASONING]         return wallSheets.wood
02487 [GPT-5-CODEX-MAX-REASONING]     end
02488 [GPT-5-CODEX-MAX-REASONING]     return nil
02489 [GPT-5-CODEX-MAX-REASONING] end
02490 [GPT-5-CODEX-MAX-REASONING] 
02491 [GPT-5-CODEX-MAX-REASONING] local function drawWallTextureColumn(wtype, side, texCoord, sx, y1, y2, colW)
02492 [GPT-5-CODEX-MAX-REASONING]     local sheet = getWallSheet(wtype)
02493 [GPT-5-CODEX-MAX-REASONING]     if not sheet then
02494 [GPT-5-CODEX-MAX-REASONING]         return false
02495 [GPT-5-CODEX-MAX-REASONING]     end
02496 [GPT-5-CODEX-MAX-REASONING]     if not sheet.frameWidth or not sheet.frameHeight or not sheet.frameCount then
02497 [GPT-5-CODEX-MAX-REASONING]         return false
02498 [GPT-5-CODEX-MAX-REASONING]     end
02499 [GPT-5-CODEX-MAX-REASONING]     local wallH = y2 - y1
02500 [GPT-5-CODEX-MAX-REASONING]     if wallH <= 0 then return false end
02501 [GPT-5-CODEX-MAX-REASONING] 
02502 [GPT-5-CODEX-MAX-REASONING]     local sheetFrameCount = sheet.frameCount
02503 [GPT-5-CODEX-MAX-REASONING]     if sheetFrameCount <= 0 then return false end
02504 [GPT-5-CODEX-MAX-REASONING]     local frameIndex = math.floor(texCoord * sheetFrameCount) + 1
02505 [GPT-5-CODEX-MAX-REASONING]     if frameIndex < 1 then frameIndex = 1 end
02506 [GPT-5-CODEX-MAX-REASONING]     if frameIndex > sheetFrameCount then frameIndex = sheetFrameCount end
02507 [GPT-5-CODEX-MAX-REASONING] 
02508 [GPT-5-CODEX-MAX-REASONING]     if wtype == 1 and sheetFrameCount ~= 128 then
02509 [GPT-5-CODEX-MAX-REASONING]         safeLog("WARN", "Stone texture frameCount is " .. tostring(sheetFrameCount) .. " (expected 128)")
02510 [GPT-5-CODEX-MAX-REASONING]     end
02511 [GPT-5-CODEX-MAX-REASONING] 
02512 [GPT-5-CODEX-MAX-REASONING]     local width = colW or 4
02513 [GPT-5-CODEX-MAX-REASONING]     local scaleX = width / sheet.frameWidth
02514 [GPT-5-CODEX-MAX-REASONING]     local scaleY
02515 [GPT-5-CODEX-MAX-REASONING]     if isExpRenderer() and expScaleYLut and expScaleYLut[wallH] then
02516 [GPT-5-CODEX-MAX-REASONING]         scaleY = expScaleYLut[wallH]
02517 [GPT-5-CODEX-MAX-REASONING]     else
02518 [GPT-5-CODEX-MAX-REASONING]         scaleY = wallH / sheet.frameHeight
02519 [GPT-5-CODEX-MAX-REASONING]     end
02520 [GPT-5-CODEX-MAX-REASONING]     if scaleX <= 0 or scaleY <= 0 then return false end
02521 [GPT-5-CODEX-MAX-REASONING] 
02522 [GPT-5-CODEX-MAX-REASONING]     if DEBUG_TEXTURE_LOG and wtype == 1 then
02523 [GPT-5-CODEX-MAX-REASONING]         if textureDebugFrame ~= frameCount then
02524 [GPT-5-CODEX-MAX-REASONING]             textureDebugFrame = frameCount
02525 [GPT-5-CODEX-MAX-REASONING]             textureDebugSamples = 0
02526 [GPT-5-CODEX-MAX-REASONING]         end
02527 [GPT-5-CODEX-MAX-REASONING]         if textureDebugSamples < 4 then
02528 [GPT-5-CODEX-MAX-REASONING]             textureDebugSamples = textureDebugSamples + 1
02529 [GPT-5-CODEX-MAX-REASONING]             textureLog(string.format("stone texCoord=%.3f -> frame=%d/%d sx=%d", texCoord, frameIndex, sheetFrameCount, sx))
02530 [GPT-5-CODEX-MAX-REASONING]         end
02531 [GPT-5-CODEX-MAX-REASONING]     end
02532 [GPT-5-CODEX-MAX-REASONING] 
02533 [GPT-5-CODEX-MAX-REASONING]     vmupro.sprite.drawFrameScaled(sheet, frameIndex, sx, y1, scaleX, scaleY, vmupro.sprite.kImageUnflipped)
02534 [GPT-5-CODEX-MAX-REASONING]     return true
02535 [GPT-5-CODEX-MAX-REASONING] end
02536 [GPT-5-CODEX-MAX-REASONING] 
02537 [GPT-5-CODEX-MAX-REASONING] expRayOffsets = expRayOffsets or {}
02538 [GPT-5-CODEX-MAX-REASONING] expTablesReady = expTablesReady or false
02539 [GPT-5-CODEX-MAX-REASONING] rayDirXFix = rayDirXFix or {}
02540 [GPT-5-CODEX-MAX-REASONING] rayDirYFix = rayDirYFix or {}
02541 [GPT-5-CODEX-MAX-REASONING] invRayDirXFix = invRayDirXFix or {}
02542 [GPT-5-CODEX-MAX-REASONING] invRayDirYFix = invRayDirYFix or {}
02543 [GPT-5-CODEX-MAX-REASONING] deltaDistXFix = deltaDistXFix or {}
02544 [GPT-5-CODEX-MAX-REASONING] deltaDistYFix = deltaDistYFix or {}
02545 [GPT-5-CODEX-MAX-REASONING] EXP_RAYCOLS = 24
02546 [GPT-5-CODEX-MAX-REASONING] EXP_COLW = 10
02547 [GPT-5-CODEX-MAX-REASONING] EXP_MAX_STEPS = 20
02548 [GPT-5-CODEX-MAX-REASONING] EXP_MAX_DIST = 80
02549 [GPT-5-CODEX-MAX-REASONING] EXP_RADIUS = 20
02550 [GPT-5-CODEX-MAX-REASONING] EXP_BUCKETS = 8
02551 [GPT-5-CODEX-MAX-REASONING] EXP_TEX_MAX_DIST = 90.0
02552 [GPT-5-CODEX-MAX-REASONING] EXP_VIEW_DIST = EXP_TEX_MAX_DIST
02553 [GPT-5-CODEX-MAX-REASONING] HYBRID_BLEND = 4.0
02554 [GPT-5-CODEX-MAX-REASONING] HYBRID_TEX_MAX_H = VIEWPORT_H
02555 [GPT-5-CODEX-MAX-REASONING] EXP_DIST_LUT_SIZE = 256
02556 [GPT-5-CODEX-MAX-REASONING] EXP_NEAR_DIST = EXP_NEAR_DIST or 28.0
02557 [GPT-5-CODEX-MAX-REASONING] expRayCache = expRayCache or {}
02558 [GPT-5-CODEX-MAX-REASONING] expRayCacheValid = expRayCacheValid or false
02559 [GPT-5-CODEX-MAX-REASONING] expRayPrevX = expRayPrevX or 0
02560 [GPT-5-CODEX-MAX-REASONING] expRayPrevY = expRayPrevY or 0
02561 [GPT-5-CODEX-MAX-REASONING] expRayPrevDir = expRayPrevDir or 0
02562 [GPT-5-CODEX-MAX-REASONING] expHeightLut = expHeightLut or {}
02563 [GPT-5-CODEX-MAX-REASONING] expScaleYLut = expScaleYLut or {}
02564 [GPT-5-CODEX-MAX-REASONING] expHeightLutReady = expHeightLutReady or false
02565 [GPT-5-CODEX-MAX-REASONING] 
02566 [GPT-5-CODEX-MAX-REASONING] local function ensureExpTables()
02567 [GPT-5-CODEX-MAX-REASONING]     if expTablesReady then return end
02568 [GPT-5-CODEX-MAX-REASONING]     for i = 0, 63 do
02569 [GPT-5-CODEX-MAX-REASONING]         local cx = cosTable[i] or 0
02570 [GPT-5-CODEX-MAX-REASONING]         local sy = sinTable[i] or 0
02571 [GPT-5-CODEX-MAX-REASONING]         rayDirXFix[i] = math.floor(cx * 256)
02572 [GPT-5-CODEX-MAX-REASONING]         rayDirYFix[i] = math.floor(sy * 256)
02573 [GPT-5-CODEX-MAX-REASONING]         if cx == 0 then
02574 [GPT-5-CODEX-MAX-REASONING]             invRayDirXFix[i] = 0x7FFFFFFF
02575 [GPT-5-CODEX-MAX-REASONING]         else
02576 [GPT-5-CODEX-MAX-REASONING]             invRayDirXFix[i] = math.floor((1 / cx) * 65536)
02577 [GPT-5-CODEX-MAX-REASONING]         end
02578 [GPT-5-CODEX-MAX-REASONING]         if sy == 0 then
02579 [GPT-5-CODEX-MAX-REASONING]             invRayDirYFix[i] = 0x7FFFFFFF
02580 [GPT-5-CODEX-MAX-REASONING]         else
02581 [GPT-5-CODEX-MAX-REASONING]             invRayDirYFix[i] = math.floor((1 / sy) * 65536)
02582 [GPT-5-CODEX-MAX-REASONING]         end
02583 [GPT-5-CODEX-MAX-REASONING]         deltaDistXFix[i] = math.abs(invRayDirXFix[i])
02584 [GPT-5-CODEX-MAX-REASONING]         deltaDistYFix[i] = math.abs(invRayDirYFix[i])
02585 [GPT-5-CODEX-MAX-REASONING]     end
02586 [GPT-5-CODEX-MAX-REASONING]     expTablesReady = true
02587 [GPT-5-CODEX-MAX-REASONING] end
02588 [GPT-5-CODEX-MAX-REASONING] 
02589 [GPT-5-CODEX-MAX-REASONING] local function ensureExpHeightLut()
02590 [GPT-5-CODEX-MAX-REASONING]     if expHeightLutReady then return end
02591 [GPT-5-CODEX-MAX-REASONING]     local wallScale = VIEWPORT_H - 20
02592 [GPT-5-CODEX-MAX-REASONING]     local size = EXP_DIST_LUT_SIZE or 256
02593 [GPT-5-CODEX-MAX-REASONING]     local maxDist = EXP_MAX_DIST or 16
02594 [GPT-5-CODEX-MAX-REASONING]     for i = 1, size do
02595 [GPT-5-CODEX-MAX-REASONING]         local dist = (i / size) * maxDist
02596 [GPT-5-CODEX-MAX-REASONING]         if dist < 0.4 then dist = 0.4 end
02597 [GPT-5-CODEX-MAX-REASONING]         expHeightLut[i] = math.floor(wallScale / dist)
02598 [GPT-5-CODEX-MAX-REASONING]     end
02599 [GPT-5-CODEX-MAX-REASONING]     for h = 0, VIEWPORT_H do
02600 [GPT-5-CODEX-MAX-REASONING]         expScaleYLut[h] = h / 128
02601 [GPT-5-CODEX-MAX-REASONING]     end
02602 [GPT-5-CODEX-MAX-REASONING]     expHeightLutReady = true
02603 [GPT-5-CODEX-MAX-REASONING] end
02604 [GPT-5-CODEX-MAX-REASONING] 
02605 [GPT-5-CODEX-MAX-REASONING] local function getExpRayOffsets(rayCols)
02606 [GPT-5-CODEX-MAX-REASONING]     local key = tostring(rayCols)
02607 [GPT-5-CODEX-MAX-REASONING]     local cached = expRayOffsets[key]
02608 [GPT-5-CODEX-MAX-REASONING]     if cached then return cached end
02609 [GPT-5-CODEX-MAX-REASONING]     local offsets = {}
02610 [GPT-5-CODEX-MAX-REASONING]     if rayCols <= 1 then
02611 [GPT-5-CODEX-MAX-REASONING]         offsets[1] = 0
02612 [GPT-5-CODEX-MAX-REASONING]     else
02613 [GPT-5-CODEX-MAX-REASONING]         local half = renderCfg.fovSteps / 2
02614 [GPT-5-CODEX-MAX-REASONING]         for x = 0, rayCols - 1 do
02615 [GPT-5-CODEX-MAX-REASONING]             local t = x / (rayCols - 1)
02616 [GPT-5-CODEX-MAX-REASONING]             local off = -half + t * renderCfg.fovSteps
02617 [GPT-5-CODEX-MAX-REASONING]             offsets[x + 1] = math.floor(off + 0.5)
02618 [GPT-5-CODEX-MAX-REASONING]         end
02619 [GPT-5-CODEX-MAX-REASONING]     end
02620 [GPT-5-CODEX-MAX-REASONING]     expRayOffsets[key] = offsets
02621 [GPT-5-CODEX-MAX-REASONING]     return offsets
02622 [GPT-5-CODEX-MAX-REASONING] end
02623 [GPT-5-CODEX-MAX-REASONING] 
02624 [GPT-5-CODEX-MAX-REASONING] local function expCastRayFixed(rayDir)
02625 [GPT-5-CODEX-MAX-REASONING]     ensureExpTables()
02626 [GPT-5-CODEX-MAX-REASONING]     local posXFix = math.floor(px * 256)
02627 [GPT-5-CODEX-MAX-REASONING]     local posYFix = math.floor(py * 256)
02628 [GPT-5-CODEX-MAX-REASONING]     local mapX = posXFix >> 8
02629 [GPT-5-CODEX-MAX-REASONING]     local mapY = posYFix >> 8
02630 [GPT-5-CODEX-MAX-REASONING] 
02631 [GPT-5-CODEX-MAX-REASONING]     local dirXFix = rayDirXFix[rayDir] or 0
02632 [GPT-5-CODEX-MAX-REASONING]     local dirYFix = rayDirYFix[rayDir] or 0
02633 [GPT-5-CODEX-MAX-REASONING]     local stepX = (dirXFix < 0) and -1 or 1
02634 [GPT-5-CODEX-MAX-REASONING]     local stepY = (dirYFix < 0) and -1 or 1
02635 [GPT-5-CODEX-MAX-REASONING] 
02636 [GPT-5-CODEX-MAX-REASONING]     local deltaX = deltaDistXFix[rayDir] or 0x7FFFFFFF
02637 [GPT-5-CODEX-MAX-REASONING]     local deltaY = deltaDistYFix[rayDir] or 0x7FFFFFFF
02638 [GPT-5-CODEX-MAX-REASONING] 
02639 [GPT-5-CODEX-MAX-REASONING]     local nextXFix = ((mapX + (stepX > 0 and 1 or 0)) << 8)
02640 [GPT-5-CODEX-MAX-REASONING]     local nextYFix = ((mapY + (stepY > 0 and 1 or 0)) << 8)
02641 [GPT-5-CODEX-MAX-REASONING]     local distToNextX = nextXFix - posXFix
02642 [GPT-5-CODEX-MAX-REASONING]     local distToNextY = nextYFix - posYFix
02643 [GPT-5-CODEX-MAX-REASONING]     if distToNextX < 0 then distToNextX = -distToNextX end
02644 [GPT-5-CODEX-MAX-REASONING]     if distToNextY < 0 then distToNextY = -distToNextY end
02645 [GPT-5-CODEX-MAX-REASONING] 
02646 [GPT-5-CODEX-MAX-REASONING]     local sideDistX = (distToNextX * deltaX) >> 8
02647 [GPT-5-CODEX-MAX-REASONING]     local sideDistY = (distToNextY * deltaY) >> 8
02648 [GPT-5-CODEX-MAX-REASONING] 
02649 [GPT-5-CODEX-MAX-REASONING]     local side = 0
02650 [GPT-5-CODEX-MAX-REASONING]     local wtype = 0
02651 [GPT-5-CODEX-MAX-REASONING]     local maxSteps = EXP_MAX_STEPS or 8
02652 [GPT-5-CODEX-MAX-REASONING]     for _ = 0, maxSteps do
02653 [GPT-5-CODEX-MAX-REASONING]         if sideDistX < sideDistY then
02654 [GPT-5-CODEX-MAX-REASONING]             sideDistX = sideDistX + deltaX
02655 [GPT-5-CODEX-MAX-REASONING]             mapX = mapX + stepX
02656 [GPT-5-CODEX-MAX-REASONING]             side = 0
02657 [GPT-5-CODEX-MAX-REASONING]         else
02658 [GPT-5-CODEX-MAX-REASONING]             sideDistY = sideDistY + deltaY
02659 [GPT-5-CODEX-MAX-REASONING]             mapY = mapY + stepY
02660 [GPT-5-CODEX-MAX-REASONING]             side = 1
02661 [GPT-5-CODEX-MAX-REASONING]         end
02662 [GPT-5-CODEX-MAX-REASONING]         if mapX < 0 or mapX >= 16 or mapY < 0 or mapY >= 16 then
02663 [GPT-5-CODEX-MAX-REASONING]             return 16, 1, 0, 0
02664 [GPT-5-CODEX-MAX-REASONING]         end
02665 [GPT-5-CODEX-MAX-REASONING]         wtype = map[mapY + 1][mapX + 1]
02666 [GPT-5-CODEX-MAX-REASONING]         if wtype > 0 then
02667 [GPT-5-CODEX-MAX-REASONING]             break
02668 [GPT-5-CODEX-MAX-REASONING]         end
02669 [GPT-5-CODEX-MAX-REASONING]     end
02670 [GPT-5-CODEX-MAX-REASONING]     if wtype <= 0 then
02671 [GPT-5-CODEX-MAX-REASONING]         return 16, 1, 0, 0
02672 [GPT-5-CODEX-MAX-REASONING]     end
02673 [GPT-5-CODEX-MAX-REASONING] 
02674 [GPT-5-CODEX-MAX-REASONING]     local perpFix
02675 [GPT-5-CODEX-MAX-REASONING]     if side == 0 then
02676 [GPT-5-CODEX-MAX-REASONING]         local numFix = ((mapX << 8) - posXFix + ((stepX == -1) and 256 or 0))
02677 [GPT-5-CODEX-MAX-REASONING]         perpFix = (numFix * (invRayDirXFix[rayDir] or 0)) >> 8
02678 [GPT-5-CODEX-MAX-REASONING]     else
02679 [GPT-5-CODEX-MAX-REASONING]         local numFix = ((mapY << 8) - posYFix + ((stepY == -1) and 256 or 0))
02680 [GPT-5-CODEX-MAX-REASONING]         perpFix = (numFix * (invRayDirYFix[rayDir] or 0)) >> 8
02681 [GPT-5-CODEX-MAX-REASONING]     end
02682 [GPT-5-CODEX-MAX-REASONING]     if perpFix < 1 then perpFix = 1 end
02683 [GPT-5-CODEX-MAX-REASONING] 
02684 [GPT-5-CODEX-MAX-REASONING]     local texFix
02685 [GPT-5-CODEX-MAX-REASONING]     if side == 0 then
02686 [GPT-5-CODEX-MAX-REASONING]         local texCalc = (posYFix + ((perpFix * dirYFix) >> 16))
02687 [GPT-5-CODEX-MAX-REASONING]         texFix = texCalc & 0xFF
02688 [GPT-5-CODEX-MAX-REASONING]     else
02689 [GPT-5-CODEX-MAX-REASONING]         local texCalc = (posXFix + ((perpFix * dirXFix) >> 16))
02690 [GPT-5-CODEX-MAX-REASONING]         texFix = texCalc & 0xFF
02691 [GPT-5-CODEX-MAX-REASONING]     end
02692 [GPT-5-CODEX-MAX-REASONING]     local texCoord = texFix / 256
02693 [GPT-5-CODEX-MAX-REASONING]     local dist = perpFix / 65536
02694 [GPT-5-CODEX-MAX-REASONING]     return dist, wtype, side, texCoord
02695 [GPT-5-CODEX-MAX-REASONING] end
02696 [GPT-5-CODEX-MAX-REASONING] 
02697 [GPT-5-CODEX-MAX-REASONING] local getWallSprite
02698 [GPT-5-CODEX-MAX-REASONING] local expItems = {}
02699 [GPT-5-CODEX-MAX-REASONING] local expBuckets = {}
02700 [GPT-5-CODEX-MAX-REASONING] local expDepthBuf = {}
02701 [GPT-5-CODEX-MAX-REASONING] for i = 1, (EXP_BUCKETS or 8) do
02702 [GPT-5-CODEX-MAX-REASONING]     expBuckets[i] = {}
02703 [GPT-5-CODEX-MAX-REASONING] end
02704 [GPT-5-CODEX-MAX-REASONING] 
02705 [GPT-5-CODEX-MAX-REASONING] local function renderWallsExperimental(minDist)
02706 [GPT-5-CODEX-MAX-REASONING]     if not map then return end
02707 [GPT-5-CODEX-MAX-REASONING]     if not DEBUG_DISABLE_WALL_TEXTURE and (not wallStone or not wallBrick) and not wallTextureLoadAttempted then
02708 [GPT-5-CODEX-MAX-REASONING]         loadWallTextures()
02709 [GPT-5-CODEX-MAX-REASONING]     end
02710 [GPT-5-CODEX-MAX-REASONING]     local nearMin = minDist or 0
02711 [GPT-5-CODEX-MAX-REASONING]     local maxDist = EXP_MAX_DIST or 16
02712 [GPT-5-CODEX-MAX-REASONING]     local viewDist = EXP_VIEW_DIST or maxDist
02713 [GPT-5-CODEX-MAX-REASONING]     local maxDistSq = maxDist * maxDist
02714 [GPT-5-CODEX-MAX-REASONING]     local radius = EXP_RADIUS or 8
02715 [GPT-5-CODEX-MAX-REASONING]     local radiusSq = radius * radius
02716 [GPT-5-CODEX-MAX-REASONING]     local dir = pdir % 64
02717 [GPT-5-CODEX-MAX-REASONING]     local cosDir = cosTable[dir]
02718 [GPT-5-CODEX-MAX-REASONING]     local sinDir = sinTable[dir]
02719 [GPT-5-CODEX-MAX-REASONING]     local fovRad = renderCfg.fovSteps * (renderCfg.twoPi / 64)
02720 [GPT-5-CODEX-MAX-REASONING]     local maxSx = math.tan(fovRad / 2)
02721 [GPT-5-CODEX-MAX-REASONING]     local wallScale = VIEWPORT_H - 20
02722 [GPT-5-CODEX-MAX-REASONING]     local bucketCount = EXP_BUCKETS or 8
02723 [GPT-5-CODEX-MAX-REASONING]     for i = 1, bucketCount do
02724 [GPT-5-CODEX-MAX-REASONING]         expBuckets[i] = {}
02725 [GPT-5-CODEX-MAX-REASONING]     end
02726 [GPT-5-CODEX-MAX-REASONING]     for x = 0, 239 do
02727 [GPT-5-CODEX-MAX-REASONING]         expDepthBuf[x] = nil
02728 [GPT-5-CODEX-MAX-REASONING]     end
02729 [GPT-5-CODEX-MAX-REASONING]     local bucketSpan = maxDist / bucketCount
02730 [GPT-5-CODEX-MAX-REASONING]     local minX = math.floor(px - radius)
02731 [GPT-5-CODEX-MAX-REASONING]     local maxX = math.floor(px + radius)
02732 [GPT-5-CODEX-MAX-REASONING]     local minY = math.floor(py - radius)
02733 [GPT-5-CODEX-MAX-REASONING]     local maxY = math.floor(py + radius)
02734 [GPT-5-CODEX-MAX-REASONING]     if minX < 0 then minX = 0 end
02735 [GPT-5-CODEX-MAX-REASONING]     if minY < 0 then minY = 0 end
02736 [GPT-5-CODEX-MAX-REASONING]     if maxX > 15 then maxX = 15 end
02737 [GPT-5-CODEX-MAX-REASONING]     if maxY > 15 then maxY = 15 end
02738 [GPT-5-CODEX-MAX-REASONING]     for my = minY, maxY do
02739 [GPT-5-CODEX-MAX-REASONING]         local row = map[my + 1]
02740 [GPT-5-CODEX-MAX-REASONING]         if row then
02741 [GPT-5-CODEX-MAX-REASONING]             for mx = minX, maxX do
02742 [GPT-5-CODEX-MAX-REASONING]                 local wtype = row[mx + 1]
02743 [GPT-5-CODEX-MAX-REASONING]                 if wtype and wtype > 0 then
02744 [GPT-5-CODEX-MAX-REASONING]                     local wx = mx + 0.5
02745 [GPT-5-CODEX-MAX-REASONING]                     local wy = my + 0.5
02746 [GPT-5-CODEX-MAX-REASONING]                     local dx = wx - px
02747 [GPT-5-CODEX-MAX-REASONING]                     local dy = wy - py
02748 [GPT-5-CODEX-MAX-REASONING]                     local distSq = dx * dx + dy * dy
02749 [GPT-5-CODEX-MAX-REASONING]                     if distSq <= radiusSq and distSq <= maxDistSq then
02750 [GPT-5-CODEX-MAX-REASONING]                         local relX = dx * sinDir - dy * cosDir
02751 [GPT-5-CODEX-MAX-REASONING]                         local relY = dx * cosDir + dy * sinDir
02752 [GPT-5-CODEX-MAX-REASONING]                         local projRelY = relY
02753 [GPT-5-CODEX-MAX-REASONING]                         if projRelY < 0.5 then projRelY = 0.5 end
02754 [GPT-5-CODEX-MAX-REASONING]                         if relY > 0.05 and relY >= nearMin and relY <= maxDist and relY <= viewDist then
02755 [GPT-5-CODEX-MAX-REASONING]                             local sx = relX / projRelY
02756 [GPT-5-CODEX-MAX-REASONING]                             if sx >= -maxSx and sx <= maxSx then
02757 [GPT-5-CODEX-MAX-REASONING]                                 local b = math.floor(relY / bucketSpan) + 1
02758 [GPT-5-CODEX-MAX-REASONING]                                 if b < 1 then b = 1 end
02759 [GPT-5-CODEX-MAX-REASONING]                                 if b > bucketCount then b = bucketCount end
02760 [GPT-5-CODEX-MAX-REASONING]                                 local bucket = expBuckets[b]
02761 [GPT-5-CODEX-MAX-REASONING]                                 bucket[#bucket + 1] = {relY = relY, projRelY = projRelY, sx = sx, t = wtype}
02762 [GPT-5-CODEX-MAX-REASONING]                             end
02763 [GPT-5-CODEX-MAX-REASONING]                         end
02764 [GPT-5-CODEX-MAX-REASONING]                     end
02765 [GPT-5-CODEX-MAX-REASONING]                 end
02766 [GPT-5-CODEX-MAX-REASONING]             end
02767 [GPT-5-CODEX-MAX-REASONING]         end
02768 [GPT-5-CODEX-MAX-REASONING]     end
02769 [GPT-5-CODEX-MAX-REASONING]     local tilesDrawn = 0
02770 [GPT-5-CODEX-MAX-REASONING]     local tileBudget = EXP_TILE_BUDGET or 300
02771 [GPT-5-CODEX-MAX-REASONING]     for b = bucketCount, 1, -1 do
02772 [GPT-5-CODEX-MAX-REASONING]         local bucket = expBuckets[b]
02773 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #bucket do
02774 [GPT-5-CODEX-MAX-REASONING]             if tilesDrawn >= tileBudget then
02775 [GPT-5-CODEX-MAX-REASONING]                 break
02776 [GPT-5-CODEX-MAX-REASONING]             end
02777 [GPT-5-CODEX-MAX-REASONING]             local it = bucket[i]
02778 [GPT-5-CODEX-MAX-REASONING]             local projRelY = it.projRelY or it.relY
02779 [GPT-5-CODEX-MAX-REASONING]             if projRelY < 0.5 then projRelY = 0.5 end
02780 [GPT-5-CODEX-MAX-REASONING]             local h = math.floor(wallScale / projRelY)
02781 [GPT-5-CODEX-MAX-REASONING]             if h > VIEWPORT_H then h = VIEWPORT_H end
02782 [GPT-5-CODEX-MAX-REASONING]             if h >= 2 then
02783 [GPT-5-CODEX-MAX-REASONING]                 local y1 = HORIZON - math.floor(h / 2)
02784 [GPT-5-CODEX-MAX-REASONING]                 local y2 = HORIZON + math.floor(h / 2)
02785 [GPT-5-CODEX-MAX-REASONING]                 if y1 < 0 then y1 = 0 end
02786 [GPT-5-CODEX-MAX-REASONING]                 if y2 > VIEWPORT_H then y2 = VIEWPORT_H end
02787 [GPT-5-CODEX-MAX-REASONING]                 local screenX = math.floor(120 + it.sx * 120)
02788 [GPT-5-CODEX-MAX-REASONING]                 if screenX == screenX and screenX >= -10000 and screenX <= 10000 then
02789 [GPT-5-CODEX-MAX-REASONING]                     local baseColor = getWallColor(it.t, 0)
02790 [GPT-5-CODEX-MAX-REASONING]                     local fogStart = FOG_START or (EXP_TEX_MAX_DIST or 5.0) - 1.0
02791 [GPT-5-CODEX-MAX-REASONING]                     local farWall = it.relY > (EXP_TEX_MAX_DIST or 5.0)
02792 [GPT-5-CODEX-MAX-REASONING]                     if farWall and it.relY >= 2.5 then
02793 [GPT-5-CODEX-MAX-REASONING]                         goto continue_exp_tile
02794 [GPT-5-CODEX-MAX-REASONING]                     end
02795 [GPT-5-CODEX-MAX-REASONING]                     tilesDrawn = tilesDrawn + 1
02796 [GPT-5-CODEX-MAX-REASONING]                     local halfW = math.floor(h / 2)
02797 [GPT-5-CODEX-MAX-REASONING]                     local x1 = screenX - halfW
02798 [GPT-5-CODEX-MAX-REASONING]                     local x2 = screenX + halfW
02799 [GPT-5-CODEX-MAX-REASONING]                     if x1 < 0 then x1 = 0 end
02800 [GPT-5-CODEX-MAX-REASONING]                     if x2 > 239 then x2 = 239 end
02801 [GPT-5-CODEX-MAX-REASONING] 
02802 [GPT-5-CODEX-MAX-REASONING]                     local needsDraw = false
02803 [GPT-5-CODEX-MAX-REASONING]                     for x = x1, x2 do
02804 [GPT-5-CODEX-MAX-REASONING]                         local prev = expDepthBuf[x]
02805 [GPT-5-CODEX-MAX-REASONING]                         if not prev or it.relY < prev then
02806 [GPT-5-CODEX-MAX-REASONING]                             needsDraw = true
02807 [GPT-5-CODEX-MAX-REASONING]                             break
02808 [GPT-5-CODEX-MAX-REASONING]                         end
02809 [GPT-5-CODEX-MAX-REASONING]                     end
02810 [GPT-5-CODEX-MAX-REASONING] 
02811 [GPT-5-CODEX-MAX-REASONING]                 if needsDraw then
02812 [GPT-5-CODEX-MAX-REASONING]                     local fogOnly = (not DEBUG_DISABLE_FOG) and (it.relY > fogStart)
02813 [GPT-5-CODEX-MAX-REASONING]                     local nearForceTex = it.relY < 2.5
02814 [GPT-5-CODEX-MAX-REASONING]                     if DEBUG_DISABLE_WALL_TEXTURE or WALL_TEXTURE_MODE == "flat" or (fogOnly and not nearForceTex) then
02815 [GPT-5-CODEX-MAX-REASONING]                             local fogColor = DEBUG_DISABLE_FOG and baseColor or FOG_COLOR
02816 [GPT-5-CODEX-MAX-REASONING]                             for x = x1, x2 do
02817 [GPT-5-CODEX-MAX-REASONING]                                 local prev = expDepthBuf[x]
02818 [GPT-5-CODEX-MAX-REASONING]                                 if not prev or it.relY < prev then
02819 [GPT-5-CODEX-MAX-REASONING]                                     expDepthBuf[x] = it.relY
02820 [GPT-5-CODEX-MAX-REASONING]                                     vmupro.graphics.drawFillRect(x, y1, x, y2, fogColor)
02821 [GPT-5-CODEX-MAX-REASONING]                                 end
02822 [GPT-5-CODEX-MAX-REASONING]                             end
02823 [GPT-5-CODEX-MAX-REASONING]                         else
02824 [GPT-5-CODEX-MAX-REASONING]                             for x = x1, x2 do
02825 [GPT-5-CODEX-MAX-REASONING]                                 local prev = expDepthBuf[x]
02826 [GPT-5-CODEX-MAX-REASONING]                                 if not prev or it.relY < prev then
02827 [GPT-5-CODEX-MAX-REASONING]                                     expDepthBuf[x] = it.relY
02828 [GPT-5-CODEX-MAX-REASONING]                                 end
02829 [GPT-5-CODEX-MAX-REASONING]                             end
02830 [GPT-5-CODEX-MAX-REASONING]                             local sprite = getWallSprite(it.t)
02831 [GPT-5-CODEX-MAX-REASONING]                             if sprite and sprite.height then
02832 [GPT-5-CODEX-MAX-REASONING]                                 local scale = safeDivide(h, sprite.height, "renderTilesExp")
02833 [GPT-5-CODEX-MAX-REASONING]                                 if scale == scale and scale > 0.01 then
02834 [GPT-5-CODEX-MAX-REASONING]                                     if scale > 50 then scale = 50 end
02835 [GPT-5-CODEX-MAX-REASONING]                                     local drawX = math.floor(screenX - (sprite.width * scale) / 2)
02836 [GPT-5-CODEX-MAX-REASONING]                                     if safeScale(sprite, scale, scale, "renderTilesExp") then
02837 [GPT-5-CODEX-MAX-REASONING]                                         vmupro.sprite.drawScaled(sprite, drawX, y1, scale, scale, vmupro.sprite.kImageUnflipped)
02838 [GPT-5-CODEX-MAX-REASONING]                                     end
02839 [GPT-5-CODEX-MAX-REASONING]                                 end
02840 [GPT-5-CODEX-MAX-REASONING]                             end
02841 [GPT-5-CODEX-MAX-REASONING]                         end
02842 [GPT-5-CODEX-MAX-REASONING]                     end
02843 [GPT-5-CODEX-MAX-REASONING]                 end
02844 [GPT-5-CODEX-MAX-REASONING]             end
02845 [GPT-5-CODEX-MAX-REASONING]             ::continue_exp_tile::
02846 [GPT-5-CODEX-MAX-REASONING]         end
02847 [GPT-5-CODEX-MAX-REASONING]     end
02848 [GPT-5-CODEX-MAX-REASONING] end
02849 [GPT-5-CODEX-MAX-REASONING] 
02850 [GPT-5-CODEX-MAX-REASONING] local function renderWallsExperimentalHybrid()
02851 [GPT-5-CODEX-MAX-REASONING]     -- Hybrid: far tiles + near classic rays
02852 [GPT-5-CODEX-MAX-REASONING]     local nearLimit = (EXP_NEAR_DIST or 8.0) + (HYBRID_BLEND or 0)
02853 [GPT-5-CODEX-MAX-REASONING]     renderWallsExperimental(nearLimit)
02854 [GPT-5-CODEX-MAX-REASONING] 
02855 [GPT-5-CODEX-MAX-REASONING]     local fovRad = renderCfg.fovSteps * (renderCfg.twoPi / 64)
02856 [GPT-5-CODEX-MAX-REASONING]     local playerAngle = (pdir % 64) * (renderCfg.twoPi / 64)
02857 [GPT-5-CODEX-MAX-REASONING]     local playerCos = math.cos(playerAngle)
02858 [GPT-5-CODEX-MAX-REASONING]     local playerSin = math.sin(playerAngle)
02859 [GPT-5-CODEX-MAX-REASONING]     local baseAngle = playerAngle - (fovRad / 2)
02860 [GPT-5-CODEX-MAX-REASONING]     local rayCols = 60
02861 [GPT-5-CODEX-MAX-REASONING]     local colW = 4
02862 [GPT-5-CODEX-MAX-REASONING]     local rayStep = fovRad / rayCols
02863 [GPT-5-CODEX-MAX-REASONING]     local stepCos = math.cos(rayStep)
02864 [GPT-5-CODEX-MAX-REASONING]     local stepSin = math.sin(rayStep)
02865 [GPT-5-CODEX-MAX-REASONING]     local rayCos = math.cos(baseAngle)
02866 [GPT-5-CODEX-MAX-REASONING]     local raySin = math.sin(baseAngle)
02867 [GPT-5-CODEX-MAX-REASONING] 
02868 [GPT-5-CODEX-MAX-REASONING]     for x = 0, rayCols - 1 do
02869 [GPT-5-CODEX-MAX-REASONING]         local dist, wtype, side, texCoord = castRay(rayCos, raySin)
02870 [GPT-5-CODEX-MAX-REASONING]         local fixedDist = dist * (rayCos * playerCos + raySin * playerSin)
02871 [GPT-5-CODEX-MAX-REASONING]         if fixedDist < 0.9 then fixedDist = 0.9 end
02872 [GPT-5-CODEX-MAX-REASONING]         if fixedDist <= nearLimit then
02873 [GPT-5-CODEX-MAX-REASONING]             local wallScale = VIEWPORT_H - 20
02874 [GPT-5-CODEX-MAX-REASONING]             local h = math.floor(wallScale / fixedDist)
02875 [GPT-5-CODEX-MAX-REASONING]             if h > VIEWPORT_H then h = VIEWPORT_H end
02876 [GPT-5-CODEX-MAX-REASONING]             local y1 = HORIZON - math.floor(h / 2)
02877 [GPT-5-CODEX-MAX-REASONING]             local y2 = HORIZON + math.floor(h / 2)
02878 [GPT-5-CODEX-MAX-REASONING]             if y1 < 0 then y1 = 0 end
02879 [GPT-5-CODEX-MAX-REASONING]             if y2 > VIEWPORT_H then y2 = VIEWPORT_H end
02880 [GPT-5-CODEX-MAX-REASONING] 
02881 [GPT-5-CODEX-MAX-REASONING]             local farWall = fixedDist > (WALL_TEX_MAX_DIST or 6.0)
02882 [GPT-5-CODEX-MAX-REASONING]             local fogCutoff = FOG_TEX_CUTOFF or 3.5
02883 [GPT-5-CODEX-MAX-REASONING]             local fogTextureSkip = (not DEBUG_DISABLE_FOG) and (fixedDist > fogCutoff)
02884 [GPT-5-CODEX-MAX-REASONING]             local sx = x * colW
02885 [GPT-5-CODEX-MAX-REASONING]             local nearForce = fixedDist < (TEX_NEAR_FORCE_DIST or 1.5)
02886 [GPT-5-CODEX-MAX-REASONING]             local wantTex = (WALL_TEXTURE_MODE == "proper"
02887 [GPT-5-CODEX-MAX-REASONING]                 and not DEBUG_DISABLE_WALL_TEXTURE
02888 [GPT-5-CODEX-MAX-REASONING]                 and (nearForce or (not farWall and not fogTextureSkip and h < (HYBRID_TEX_MAX_H or (VIEWPORT_H - 8)))))
02889 [GPT-5-CODEX-MAX-REASONING]             if not wantTex then
02890 [GPT-5-CODEX-MAX-REASONING]                 if isExpRenderer() then
02891 [GPT-5-CODEX-MAX-REASONING]                     if not DEBUG_DISABLE_FOG and fixedDist > (FOG_START or 2.5) then
02892 [GPT-5-CODEX-MAX-REASONING]                         vmupro.graphics.drawFillRect(sx, y1, sx + colW, y2, FOG_COLOR)
02893 [GPT-5-CODEX-MAX-REASONING]                     end
02894 [GPT-5-CODEX-MAX-REASONING]                 else
02895 [GPT-5-CODEX-MAX-REASONING]                     local baseColor = getWallColor(wtype, side)
02896 [GPT-5-CODEX-MAX-REASONING]                     if not DEBUG_DISABLE_FOG then
02897 [GPT-5-CODEX-MAX-REASONING]                         baseColor = fogBlend(baseColor, fixedDist)
02898 [GPT-5-CODEX-MAX-REASONING]                     end
02899 [GPT-5-CODEX-MAX-REASONING]                     vmupro.graphics.drawFillRect(sx, y1, sx + colW, y2, baseColor)
02900 [GPT-5-CODEX-MAX-REASONING]                 end
02901 [GPT-5-CODEX-MAX-REASONING]             else
02902 [GPT-5-CODEX-MAX-REASONING]                 local baseColor = getWallColor(wtype, side)
02903 [GPT-5-CODEX-MAX-REASONING]                 if not DEBUG_DISABLE_FOG then
02904 [GPT-5-CODEX-MAX-REASONING]                     baseColor = fogBlend(baseColor, fixedDist)
02905 [GPT-5-CODEX-MAX-REASONING]                 end
02906 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawFillRect(sx, y1, sx + colW, y2, baseColor)
02907 [GPT-5-CODEX-MAX-REASONING]                 local useTex = texCoord or 0
02908 [GPT-5-CODEX-MAX-REASONING]                 if useTex < 0 then useTex = 0 end
02909 [GPT-5-CODEX-MAX-REASONING]                 if useTex > 0.999 then useTex = 0.999 end
02910 [GPT-5-CODEX-MAX-REASONING]                 if side == 0 and rayCos > 0 then
02911 [GPT-5-CODEX-MAX-REASONING]                     useTex = 1.0 - useTex
02912 [GPT-5-CODEX-MAX-REASONING]                 elseif side == 1 and raySin < 0 then
02913 [GPT-5-CODEX-MAX-REASONING]                     useTex = 1.0 - useTex
02914 [GPT-5-CODEX-MAX-REASONING]                 end
02915 [GPT-5-CODEX-MAX-REASONING]                 local drew = drawWallTextureColumn(wtype, side, useTex, sx, y1, y2, colW)
02916 [GPT-5-CODEX-MAX-REASONING]                 if not drew then
02917 [GPT-5-CODEX-MAX-REASONING]                     drawWallTexture(wtype, side, sx, y1, y2)
02918 [GPT-5-CODEX-MAX-REASONING]                 end
02919 [GPT-5-CODEX-MAX-REASONING]             end
02920 [GPT-5-CODEX-MAX-REASONING]         end
02921 [GPT-5-CODEX-MAX-REASONING]         local newCos = rayCos * stepCos - raySin * stepSin
02922 [GPT-5-CODEX-MAX-REASONING]         local newSin = raySin * stepCos + rayCos * stepSin
02923 [GPT-5-CODEX-MAX-REASONING]         rayCos, raySin = newCos, newSin
02924 [GPT-5-CODEX-MAX-REASONING]     end
02925 [GPT-5-CODEX-MAX-REASONING] end
02926 [GPT-5-CODEX-MAX-REASONING] 
02927 [GPT-5-CODEX-MAX-REASONING] getWallSprite = function(wtype)
02928 [GPT-5-CODEX-MAX-REASONING]     if wtype == 1 or wtype == 6 then
02929 [GPT-5-CODEX-MAX-REASONING]         return wallStone
02930 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 2 then
02931 [GPT-5-CODEX-MAX-REASONING]         return wallBrick
02932 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 3 then
02933 [GPT-5-CODEX-MAX-REASONING]         return wallMoss
02934 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 4 then
02935 [GPT-5-CODEX-MAX-REASONING]         return wallMetal
02936 [GPT-5-CODEX-MAX-REASONING]     elseif wtype == 5 then
02937 [GPT-5-CODEX-MAX-REASONING]         return wallWood
02938 [GPT-5-CODEX-MAX-REASONING]     end
02939 [GPT-5-CODEX-MAX-REASONING]     return nil
02940 [GPT-5-CODEX-MAX-REASONING] end
02941 [GPT-5-CODEX-MAX-REASONING] 
02942 [GPT-5-CODEX-MAX-REASONING] local function renderWallQuads()
02943 [GPT-5-CODEX-MAX-REASONING]     if not wallTiles then return end
02944 [GPT-5-CODEX-MAX-REASONING]     wallQuadLog("WQ render start tiles=" .. tostring(#wallTiles) .. " px=" .. tostring(px) .. " py=" .. tostring(py))
02945 [GPT-5-CODEX-MAX-REASONING]     if not wallStone or not wallStone.width then
02946 [GPT-5-CODEX-MAX-REASONING]         wallQuadLog("WQ wallStone missing or invalid")
02947 [GPT-5-CODEX-MAX-REASONING]     end
02948 [GPT-5-CODEX-MAX-REASONING]     if not wallBrick or not wallBrick.width then
02949 [GPT-5-CODEX-MAX-REASONING]         wallQuadLog("WQ wallBrick missing or invalid")
02950 [GPT-5-CODEX-MAX-REASONING]     end
02951 [GPT-5-CODEX-MAX-REASONING]     if not wallMoss or not wallMoss.width then
02952 [GPT-5-CODEX-MAX-REASONING]         wallQuadLog("WQ wallMoss missing or invalid")
02953 [GPT-5-CODEX-MAX-REASONING]     end
02954 [GPT-5-CODEX-MAX-REASONING]     if not wallMetal or not wallMetal.width then
02955 [GPT-5-CODEX-MAX-REASONING]         wallQuadLog("WQ wallMetal missing or invalid")
02956 [GPT-5-CODEX-MAX-REASONING]     end
02957 [GPT-5-CODEX-MAX-REASONING]     if not wallWood or not wallWood.width then
02958 [GPT-5-CODEX-MAX-REASONING]         wallQuadLog("WQ wallWood missing or invalid")
02959 [GPT-5-CODEX-MAX-REASONING]     end
02960 [GPT-5-CODEX-MAX-REASONING]     local order = {}
02961 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #wallTiles do
02962 [GPT-5-CODEX-MAX-REASONING]         local w = wallTiles[i]
02963 [GPT-5-CODEX-MAX-REASONING]         local dx = w.x - px
02964 [GPT-5-CODEX-MAX-REASONING]         local dy = w.y - py
02965 [GPT-5-CODEX-MAX-REASONING]         local dist = math.sqrt(dx * dx + dy * dy)
02966 [GPT-5-CODEX-MAX-REASONING]         order[i] = {idx = i, dist = dist, dx = dx, dy = dy}
02967 [GPT-5-CODEX-MAX-REASONING]     end
02968 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #order - 1 do
02969 [GPT-5-CODEX-MAX-REASONING]         for j = 1, #order - i do
02970 [GPT-5-CODEX-MAX-REASONING]             if order[j].dist < order[j + 1].dist then
02971 [GPT-5-CODEX-MAX-REASONING]                 order[j], order[j + 1] = order[j + 1], order[j]
02972 [GPT-5-CODEX-MAX-REASONING]             end
02973 [GPT-5-CODEX-MAX-REASONING]         end
02974 [GPT-5-CODEX-MAX-REASONING]     end
02975 [GPT-5-CODEX-MAX-REASONING] 
02976 [GPT-5-CODEX-MAX-REASONING]     for i = 1, #order do
02977 [GPT-5-CODEX-MAX-REASONING]         local entry = order[i]
02978 [GPT-5-CODEX-MAX-REASONING]         if entry.dist > 0.3 and entry.dist < 12 then
02979 [GPT-5-CODEX-MAX-REASONING]             local angle = safeAtan2(entry.dy, entry.dx)
02980 [GPT-5-CODEX-MAX-REASONING]             local dirIdx = math.floor(angle * 64 / 6.28318) % 64
02981 [GPT-5-CODEX-MAX-REASONING]             local viewDiff = (dirIdx - pdir) % 64
02982 [GPT-5-CODEX-MAX-REASONING]             if viewDiff > 32 then viewDiff = viewDiff - 64 end
02983 [GPT-5-CODEX-MAX-REASONING]             if viewDiff >= -6 and viewDiff <= 6 then
02984 [GPT-5-CODEX-MAX-REASONING]                 local screenX = 120 + viewDiff * 20
02985 [GPT-5-CODEX-MAX-REASONING]                 local h = math.floor(200 / entry.dist)
02986 [GPT-5-CODEX-MAX-REASONING]                 if h > 240 then h = 240 end
02987 [GPT-5-CODEX-MAX-REASONING]                 if h < 6 then goto continue_quad end
02988 [GPT-5-CODEX-MAX-REASONING]                 local y1 = HORIZON - math.floor(h / 2)
02989 [GPT-5-CODEX-MAX-REASONING]                 if y1 < 0 then y1 = 0 end
02990 [GPT-5-CODEX-MAX-REASONING] 
02991 [GPT-5-CODEX-MAX-REASONING]                 local wtile = wallTiles[entry.idx]
02992 [GPT-5-CODEX-MAX-REASONING]                 local sprite = getWallSprite(wtile.t)
02993 [GPT-5-CODEX-MAX-REASONING]                 if not sprite then
02994 [GPT-5-CODEX-MAX-REASONING]                     wallQuadLog("WQ missing sprite for type " .. tostring(wtile.t))
02995 [GPT-5-CODEX-MAX-REASONING]                 end
02996 [GPT-5-CODEX-MAX-REASONING]                 if sprite and sprite.height then
02997 [GPT-5-CODEX-MAX-REASONING]                     local scale = safeDivide(h, sprite.height, "renderWallQuad")
02998 [GPT-5-CODEX-MAX-REASONING]                     local drawX = screenX - math.floor((sprite.width * scale) / 2)
02999 [GPT-5-CODEX-MAX-REASONING]                     if safeScale(sprite, scale, scale, "renderWallQuad") then
03000 [GPT-5-CODEX-MAX-REASONING]                         vmupro.sprite.drawScaled(sprite, drawX, y1, scale, scale, vmupro.sprite.kImageUnflipped)
03001 [GPT-5-CODEX-MAX-REASONING]                     end
03002 [GPT-5-CODEX-MAX-REASONING]                 end
03003 [GPT-5-CODEX-MAX-REASONING]             end
03004 [GPT-5-CODEX-MAX-REASONING]         end
03005 [GPT-5-CODEX-MAX-REASONING]         ::continue_quad::
03006 [GPT-5-CODEX-MAX-REASONING]     end
03007 [GPT-5-CODEX-MAX-REASONING] end
03008 [GPT-5-CODEX-MAX-REASONING] 
03009 [GPT-5-CODEX-MAX-REASONING] function castRay(dx, dy)
03010 [GPT-5-CODEX-MAX-REASONING]     if dx == 0 and dy == 0 then
03011 [GPT-5-CODEX-MAX-REASONING]         return 16, 1, 0, 0
03012 [GPT-5-CODEX-MAX-REASONING]     end
03013 [GPT-5-CODEX-MAX-REASONING] 
03014 [GPT-5-CODEX-MAX-REASONING]     local mapX = math.floor(px)
03015 [GPT-5-CODEX-MAX-REASONING]     local mapY = math.floor(py)
03016 [GPT-5-CODEX-MAX-REASONING] 
03017 [GPT-5-CODEX-MAX-REASONING]     local deltaDistX = (dx == 0) and 1e9 or math.abs(1 / dx)
03018 [GPT-5-CODEX-MAX-REASONING]     local deltaDistY = (dy == 0) and 1e9 or math.abs(1 / dy)
03019 [GPT-5-CODEX-MAX-REASONING] 
03020 [GPT-5-CODEX-MAX-REASONING]     local stepX, stepY
03021 [GPT-5-CODEX-MAX-REASONING]     local sideDistX, sideDistY
03022 [GPT-5-CODEX-MAX-REASONING] 
03023 [GPT-5-CODEX-MAX-REASONING]     if dx < 0 then
03024 [GPT-5-CODEX-MAX-REASONING]         stepX = -1
03025 [GPT-5-CODEX-MAX-REASONING]         sideDistX = (px - mapX) * deltaDistX
03026 [GPT-5-CODEX-MAX-REASONING]     else
03027 [GPT-5-CODEX-MAX-REASONING]         stepX = 1
03028 [GPT-5-CODEX-MAX-REASONING]         sideDistX = (mapX + 1.0 - px) * deltaDistX
03029 [GPT-5-CODEX-MAX-REASONING]     end
03030 [GPT-5-CODEX-MAX-REASONING] 
03031 [GPT-5-CODEX-MAX-REASONING]     if dy < 0 then
03032 [GPT-5-CODEX-MAX-REASONING]         stepY = -1
03033 [GPT-5-CODEX-MAX-REASONING]         sideDistY = (py - mapY) * deltaDistY
03034 [GPT-5-CODEX-MAX-REASONING]     else
03035 [GPT-5-CODEX-MAX-REASONING]         stepY = 1
03036 [GPT-5-CODEX-MAX-REASONING]         sideDistY = (mapY + 1.0 - py) * deltaDistY
03037 [GPT-5-CODEX-MAX-REASONING]     end
03038 [GPT-5-CODEX-MAX-REASONING] 
03039 [GPT-5-CODEX-MAX-REASONING]     local hit = false
03040 [GPT-5-CODEX-MAX-REASONING]     local side = 0
03041 [GPT-5-CODEX-MAX-REASONING]     local maxSteps = 64
03042 [GPT-5-CODEX-MAX-REASONING]     local wtype = 1
03043 [GPT-5-CODEX-MAX-REASONING]     for _ = 1, maxSteps do
03044 [GPT-5-CODEX-MAX-REASONING]         if sideDistX < sideDistY then
03045 [GPT-5-CODEX-MAX-REASONING]             sideDistX = sideDistX + deltaDistX
03046 [GPT-5-CODEX-MAX-REASONING]             mapX = mapX + stepX
03047 [GPT-5-CODEX-MAX-REASONING]             side = 0
03048 [GPT-5-CODEX-MAX-REASONING]         else
03049 [GPT-5-CODEX-MAX-REASONING]             sideDistY = sideDistY + deltaDistY
03050 [GPT-5-CODEX-MAX-REASONING]             mapY = mapY + stepY
03051 [GPT-5-CODEX-MAX-REASONING]             side = 1
03052 [GPT-5-CODEX-MAX-REASONING]         end
03053 [GPT-5-CODEX-MAX-REASONING]         if mapX < 0 or mapX >= 16 or mapY < 0 or mapY >= 16 then
03054 [GPT-5-CODEX-MAX-REASONING]             break
03055 [GPT-5-CODEX-MAX-REASONING]         end
03056 [GPT-5-CODEX-MAX-REASONING]         wtype = map[mapY + 1][mapX + 1]
03057 [GPT-5-CODEX-MAX-REASONING]         if wtype > 0 then
03058 [GPT-5-CODEX-MAX-REASONING]             hit = true
03059 [GPT-5-CODEX-MAX-REASONING]             break
03060 [GPT-5-CODEX-MAX-REASONING]         end
03061 [GPT-5-CODEX-MAX-REASONING]     end
03062 [GPT-5-CODEX-MAX-REASONING] 
03063 [GPT-5-CODEX-MAX-REASONING]     if not hit then
03064 [GPT-5-CODEX-MAX-REASONING]         return 16, 1, 0, 0
03065 [GPT-5-CODEX-MAX-REASONING]     end
03066 [GPT-5-CODEX-MAX-REASONING] 
03067 [GPT-5-CODEX-MAX-REASONING]     local perpWallDist
03068 [GPT-5-CODEX-MAX-REASONING]     if side == 0 then
03069 [GPT-5-CODEX-MAX-REASONING]         perpWallDist = (mapX - px + (1 - stepX) / 2) / (dx == 0 and 1e-6 or dx)
03070 [GPT-5-CODEX-MAX-REASONING]     else
03071 [GPT-5-CODEX-MAX-REASONING]         perpWallDist = (mapY - py + (1 - stepY) / 2) / (dy == 0 and 1e-6 or dy)
03072 [GPT-5-CODEX-MAX-REASONING]     end
03073 [GPT-5-CODEX-MAX-REASONING] 
03074 [GPT-5-CODEX-MAX-REASONING]     local texCoord
03075 [GPT-5-CODEX-MAX-REASONING]     if side == 0 then
03076 [GPT-5-CODEX-MAX-REASONING]         texCoord = py + perpWallDist * dy
03077 [GPT-5-CODEX-MAX-REASONING]     else
03078 [GPT-5-CODEX-MAX-REASONING]         texCoord = px + perpWallDist * dx
03079 [GPT-5-CODEX-MAX-REASONING]     end
03080 [GPT-5-CODEX-MAX-REASONING]     texCoord = texCoord - math.floor(texCoord)
03081 [GPT-5-CODEX-MAX-REASONING]     if texCoord < 0 then texCoord = texCoord + 1 end
03082 [GPT-5-CODEX-MAX-REASONING]     if texCoord > 0.999 then texCoord = 0.999 end
03083 [GPT-5-CODEX-MAX-REASONING] 
03084 [GPT-5-CODEX-MAX-REASONING]     return perpWallDist, wtype, side, texCoord
03085 [GPT-5-CODEX-MAX-REASONING] end
03086 [GPT-5-CODEX-MAX-REASONING] 
03087 [GPT-5-CODEX-MAX-REASONING] local function isVisible(tx, ty, cache)
03088 [GPT-5-CODEX-MAX-REASONING]     local useCache = cache and (not isExpRenderer())
03089 [GPT-5-CODEX-MAX-REASONING]     if useCache then
03090 [GPT-5-CODEX-MAX-REASONING]         local lastFrame = cache._visFrame or -1000
03091 [GPT-5-CODEX-MAX-REASONING]         if frameCount - lastFrame < 14 then
03092 [GPT-5-CODEX-MAX-REASONING]             return cache._visValue == true
03093 [GPT-5-CODEX-MAX-REASONING]         end
03094 [GPT-5-CODEX-MAX-REASONING]     end
03095 [GPT-5-CODEX-MAX-REASONING]     local dx, dy = tx - px, ty - py
03096 [GPT-5-CODEX-MAX-REASONING]     local dist = math.sqrt(dx * dx + dy * dy)
03097 [GPT-5-CODEX-MAX-REASONING]     local maxDist = SPRITE_VIS_DIST or 6
03098 [GPT-5-CODEX-MAX-REASONING]     if isExpRenderer() then
03099 [GPT-5-CODEX-MAX-REASONING]         local viewDist = EXP_VIEW_DIST or maxDist
03100 [GPT-5-CODEX-MAX-REASONING]         if viewDist < maxDist then maxDist = viewDist end
03101 [GPT-5-CODEX-MAX-REASONING]     end
03102 [GPT-5-CODEX-MAX-REASONING]     if dist > maxDist then
03103 [GPT-5-CODEX-MAX-REASONING]         if useCache then
03104 [GPT-5-CODEX-MAX-REASONING]             cache._visFrame = frameCount
03105 [GPT-5-CODEX-MAX-REASONING]             cache._visValue = false
03106 [GPT-5-CODEX-MAX-REASONING]         end
03107 [GPT-5-CODEX-MAX-REASONING]         return false
03108 [GPT-5-CODEX-MAX-REASONING]     end
03109 [GPT-5-CODEX-MAX-REASONING]     if isExpRenderer() then
03110 [GPT-5-CODEX-MAX-REASONING]         local dir = pdir % 64
03111 [GPT-5-CODEX-MAX-REASONING]         local cosDir = cosTable[dir]
03112 [GPT-5-CODEX-MAX-REASONING]         local sinDir = sinTable[dir]
03113 [GPT-5-CODEX-MAX-REASONING]         local relX = dx * sinDir - dy * cosDir
03114 [GPT-5-CODEX-MAX-REASONING]         local relY = dx * cosDir + dy * sinDir
03115 [GPT-5-CODEX-MAX-REASONING]         if relY <= 0.05 then
03116 [GPT-5-CODEX-MAX-REASONING]             if useCache then
03117 [GPT-5-CODEX-MAX-REASONING]                 cache._visFrame = frameCount
03118 [GPT-5-CODEX-MAX-REASONING]                 cache._visValue = false
03119 [GPT-5-CODEX-MAX-REASONING]             end
03120 [GPT-5-CODEX-MAX-REASONING]             return false
03121 [GPT-5-CODEX-MAX-REASONING]         end
03122 [GPT-5-CODEX-MAX-REASONING]         local fovRad = renderCfg.fovSteps * (renderCfg.twoPi / 64)
03123 [GPT-5-CODEX-MAX-REASONING]         local maxSx = math.tan(fovRad / 2)
03124 [GPT-5-CODEX-MAX-REASONING]         local sx = relX / relY
03125 [GPT-5-CODEX-MAX-REASONING]         if sx < -maxSx or sx > maxSx then
03126 [GPT-5-CODEX-MAX-REASONING]             if useCache then
03127 [GPT-5-CODEX-MAX-REASONING]                 cache._visFrame = frameCount
03128 [GPT-5-CODEX-MAX-REASONING]                 cache._visValue = false
03129 [GPT-5-CODEX-MAX-REASONING]             end
03130 [GPT-5-CODEX-MAX-REASONING]             return false
03131 [GPT-5-CODEX-MAX-REASONING]         end
03132 [GPT-5-CODEX-MAX-REASONING]     end
03133 [GPT-5-CODEX-MAX-REASONING]     if dist < 0.1 then
03134 [GPT-5-CODEX-MAX-REASONING]         if useCache then
03135 [GPT-5-CODEX-MAX-REASONING]             cache._visFrame = frameCount
03136 [GPT-5-CODEX-MAX-REASONING]             cache._visValue = true
03137 [GPT-5-CODEX-MAX-REASONING]         end
03138 [GPT-5-CODEX-MAX-REASONING]         return true
03139 [GPT-5-CODEX-MAX-REASONING]     end
03140 [GPT-5-CODEX-MAX-REASONING]     dx, dy = dx / dist, dy / dist
03141 [GPT-5-CODEX-MAX-REASONING]     local rx, ry, traveled = px, py, 0
03142 [GPT-5-CODEX-MAX-REASONING]     local step = isExpRenderer() and 0.1 or 0.25
03143 [GPT-5-CODEX-MAX-REASONING]     while traveled < dist - step do
03144 [GPT-5-CODEX-MAX-REASONING]         rx, ry = rx + dx * step, ry + dy * step
03145 [GPT-5-CODEX-MAX-REASONING]         traveled = traveled + step
03146 [GPT-5-CODEX-MAX-REASONING]         local mx, my = math.floor(rx), math.floor(ry)
03147 [GPT-5-CODEX-MAX-REASONING]         if mx >= 0 and mx < 16 and my >= 0 and my < 16 then
03148 [GPT-5-CODEX-MAX-REASONING]             if map[my + 1][mx + 1] > 0 then
03149 [GPT-5-CODEX-MAX-REASONING]                 if useCache then
03150 [GPT-5-CODEX-MAX-REASONING]                     cache._visFrame = frameCount
03151 [GPT-5-CODEX-MAX-REASONING]                     cache._visValue = false
03152 [GPT-5-CODEX-MAX-REASONING]                 end
03153 [GPT-5-CODEX-MAX-REASONING]                 return false
03154 [GPT-5-CODEX-MAX-REASONING]             end
03155 [GPT-5-CODEX-MAX-REASONING]             -- Thicken the ray to avoid corner peeking
03156 [GPT-5-CODEX-MAX-REASONING]             local r = 0.1
03157 [GPT-5-CODEX-MAX-REASONING]             local mx1, mx2 = math.floor(rx - r), math.floor(rx + r)
03158 [GPT-5-CODEX-MAX-REASONING]             local my1, my2 = math.floor(ry - r), math.floor(ry + r)
03159 [GPT-5-CODEX-MAX-REASONING]             if mx1 < 0 or mx2 >= 16 or my1 < 0 or my2 >= 16 then
03160 [GPT-5-CODEX-MAX-REASONING]                 if useCache then
03161 [GPT-5-CODEX-MAX-REASONING]                     cache._visFrame = frameCount
03162 [GPT-5-CODEX-MAX-REASONING]                     cache._visValue = false
03163 [GPT-5-CODEX-MAX-REASONING]                 end
03164 [GPT-5-CODEX-MAX-REASONING]                 return false
03165 [GPT-5-CODEX-MAX-REASONING]             end
03166 [GPT-5-CODEX-MAX-REASONING]             if map[my1 + 1][mx1 + 1] > 0 or map[my1 + 1][mx2 + 1] > 0
03167 [GPT-5-CODEX-MAX-REASONING]                 or map[my2 + 1][mx1 + 1] > 0 or map[my2 + 1][mx2 + 1] > 0 then
03168 [GPT-5-CODEX-MAX-REASONING]                 if useCache then
03169 [GPT-5-CODEX-MAX-REASONING]                     cache._visFrame = frameCount
03170 [GPT-5-CODEX-MAX-REASONING]                     cache._visValue = false
03171 [GPT-5-CODEX-MAX-REASONING]                 end
03172 [GPT-5-CODEX-MAX-REASONING]                 return false
03173 [GPT-5-CODEX-MAX-REASONING]             end
03174 [GPT-5-CODEX-MAX-REASONING]         end
03175 [GPT-5-CODEX-MAX-REASONING]     end
03176 [GPT-5-CODEX-MAX-REASONING]     if useCache then
03177 [GPT-5-CODEX-MAX-REASONING]         cache._visFrame = frameCount
03178 [GPT-5-CODEX-MAX-REASONING]         cache._visValue = true
03179 [GPT-5-CODEX-MAX-REASONING]     end
03180 [GPT-5-CODEX-MAX-REASONING]     return true
03181 [GPT-5-CODEX-MAX-REASONING] end
03182 [GPT-5-CODEX-MAX-REASONING] 
03183 [GPT-5-CODEX-MAX-REASONING] local function drawSprite(screenX, dist, stype, viewAngle, animFrame, spriteData)
03184 [GPT-5-CODEX-MAX-REASONING]     if dist < 0.3 then return end
03185 [GPT-5-CODEX-MAX-REASONING]     local size = math.floor(100 / dist)
03186 [GPT-5-CODEX-MAX-REASONING]     if size < 6 then return end
03187 [GPT-5-CODEX-MAX-REASONING]     if size > 140 then size = 140 end
03188 [GPT-5-CODEX-MAX-REASONING] 
03189 [GPT-5-CODEX-MAX-REASONING]     local hs = math.floor(size / 2)
03190 [GPT-5-CODEX-MAX-REASONING]     local x1, x2 = screenX - hs, screenX + hs
03191 [GPT-5-CODEX-MAX-REASONING]     -- Ground level matches wall bottom: HORIZON + 100/dist = HORIZON + size
03192 [GPT-5-CODEX-MAX-REASONING]     local groundY = HORIZON + size
03193 [GPT-5-CODEX-MAX-REASONING]     if groundY > VIEWPORT_H then groundY = VIEWPORT_H end
03194 [GPT-5-CODEX-MAX-REASONING]     local y1, y2 = groundY - size, groundY
03195 [GPT-5-CODEX-MAX-REASONING] 
03196 [GPT-5-CODEX-MAX-REASONING]     if x2 < 0 or x1 > 240 then return end
03197 [GPT-5-CODEX-MAX-REASONING] 
03198 [GPT-5-CODEX-MAX-REASONING]     -- Center Y for wall-mounted items (at eye level), ground for floor items
03199 [GPT-5-CODEX-MAX-REASONING]     local centerY = HORIZON  -- Wall-mounted items at eye level
03200 [GPT-5-CODEX-MAX-REASONING] 
03201 [GPT-5-CODEX-MAX-REASONING]     if stype == 1 then
03202 [GPT-5-CODEX-MAX-REASONING]         -- Detailed Torch (wall mounted, at eye level)
03203 [GPT-5-CODEX-MAX-REASONING]         local tw = math.floor(size / 5)
03204 [GPT-5-CODEX-MAX-REASONING]         local th = math.floor(size / 2)
03205 [GPT-5-CODEX-MAX-REASONING]         local tx1, tx2 = screenX - tw, screenX + tw
03206 [GPT-5-CODEX-MAX-REASONING]         -- Handle with wood grain
03207 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx1, centerY, tx2, centerY + th, COLOR_BROWN)
03208 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(tx1 + 2, centerY + 4, tx1 + 2, centerY + th - 4, COLOR_DARK_BROWN)
03209 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(tx2 - 2, centerY + 4, tx2 - 2, centerY + th - 4, COLOR_DARK_BROWN)
03210 [GPT-5-CODEX-MAX-REASONING]         -- Flame base
03211 [GPT-5-CODEX-MAX-REASONING]         local flameH = math.floor(size / 3)
03212 [GPT-5-CODEX-MAX-REASONING]         local flicker = (frameCount % 4) - 2
03213 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx1 - 2, centerY - flameH, tx2 + 2, centerY, COLOR_ORANGE)
03214 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx1, centerY - flameH - 4 + flicker, tx2, centerY - flameH + 4, COLOR_YELLOW)
03215 [GPT-5-CODEX-MAX-REASONING]         -- Inner flame
03216 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(screenX - 2, centerY - flameH + 4, screenX + 2, centerY - 4, COLOR_YELLOW)
03217 [GPT-5-CODEX-MAX-REASONING] 
03218 [GPT-5-CODEX-MAX-REASONING]     elseif stype == 2 then
03219 [GPT-5-CODEX-MAX-REASONING]         -- Detailed Barrel (sits on ground)
03220 [GPT-5-CODEX-MAX-REASONING]         local bw = math.floor(size / 2)
03221 [GPT-5-CODEX-MAX-REASONING]         local bh = math.floor(size * 0.6)
03222 [GPT-5-CODEX-MAX-REASONING]         local bx1, bx2 = screenX - bw, screenX + bw
03223 [GPT-5-CODEX-MAX-REASONING]         local by2 = y2  -- Bottom at ground
03224 [GPT-5-CODEX-MAX-REASONING]         local by1 = by2 - bh  -- Top
03225 [GPT-5-CODEX-MAX-REASONING]         local bCenterY = math.floor((by1 + by2) / 2)
03226 [GPT-5-CODEX-MAX-REASONING]         -- Main barrel body
03227 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bx1 + 2, by1, bx2 - 2, by2, COLOR_BROWN)
03228 [GPT-5-CODEX-MAX-REASONING]         -- Curved sides
03229 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bx1, by1 + 4, bx1 + 4, by2 - 4, COLOR_DARK_BROWN)
03230 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bx2 - 4, by1 + 4, bx2, by2 - 4, COLOR_DARK_BROWN)
03231 [GPT-5-CODEX-MAX-REASONING]         -- Metal bands
03232 [GPT-5-CODEX-MAX-REASONING]         local bandH = 3
03233 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bx1, by1 + 6, bx2, by1 + 6 + bandH, COLOR_GRAY)
03234 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bx1, by2 - 6 - bandH, bx2, by2 - 6, COLOR_GRAY)
03235 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bx1, bCenterY - 1, bx2, bCenterY + 2, COLOR_DARK_GRAY)
03236 [GPT-5-CODEX-MAX-REASONING]         -- Wood grain lines
03237 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(screenX - 4, by1 + 10, screenX - 4, by2 - 10, COLOR_DARK_BROWN)
03238 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(screenX + 4, by1 + 10, screenX + 4, by2 - 10, COLOR_DARK_BROWN)
03239 [GPT-5-CODEX-MAX-REASONING]         -- Top rim
03240 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bx1 + 2, by1, bx2 - 2, by1 + 3, COLOR_LIGHT_BROWN)
03241 [GPT-5-CODEX-MAX-REASONING] 
03242 [GPT-5-CODEX-MAX-REASONING]     elseif stype == 3 then
03243 [GPT-5-CODEX-MAX-REASONING]         -- Detailed Table (sits on ground)
03244 [GPT-5-CODEX-MAX-REASONING]         local tw = math.floor(size * 0.7)
03245 [GPT-5-CODEX-MAX-REASONING]         local th = math.floor(size * 0.15)
03246 [GPT-5-CODEX-MAX-REASONING]         local legH = math.floor(size * 0.4)
03247 [GPT-5-CODEX-MAX-REASONING]         local tx1, tx2 = screenX - tw, screenX + tw
03248 [GPT-5-CODEX-MAX-REASONING]         local ty = y2 - legH - th  -- Table top position (legs touch ground at y2)
03249 [GPT-5-CODEX-MAX-REASONING]         -- Table top with wood grain
03250 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx1, ty, tx2, ty + th, COLOR_BROWN)
03251 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx1, ty, tx2, ty + 2, COLOR_LIGHT_BROWN)
03252 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(tx1 + 8, ty + 2, tx1 + 8, ty + th, COLOR_DARK_BROWN)
03253 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(tx2 - 8, ty + 2, tx2 - 8, ty + th, COLOR_DARK_BROWN)
03254 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(screenX, ty + 2, screenX, ty + th, COLOR_DARK_BROWN)
03255 [GPT-5-CODEX-MAX-REASONING]         -- Legs
03256 [GPT-5-CODEX-MAX-REASONING]         local legW = math.floor(size * 0.08)
03257 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx1 + 4, ty + th, tx1 + 4 + legW, y2, COLOR_DARK_BROWN)
03258 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx2 - 4 - legW, ty + th, tx2 - 4, y2, COLOR_DARK_BROWN)
03259 [GPT-5-CODEX-MAX-REASONING]         -- Cross beam
03260 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(tx1 + 4, y2 - 8, tx2 - 4, y2 - 5, COLOR_BROWN)
03261 [GPT-5-CODEX-MAX-REASONING] 
03262 [GPT-5-CODEX-MAX-REASONING]     elseif stype == 4 then
03263 [GPT-5-CODEX-MAX-REASONING]         -- Detailed Chest (sits on ground)
03264 [GPT-5-CODEX-MAX-REASONING]         local cw = math.floor(size * 0.5)
03265 [GPT-5-CODEX-MAX-REASONING]         local ch = math.floor(size * 0.35)
03266 [GPT-5-CODEX-MAX-REASONING]         local cx1, cx2 = screenX - cw, screenX + cw
03267 [GPT-5-CODEX-MAX-REASONING]         local cy2 = y2  -- Bottom at ground
03268 [GPT-5-CODEX-MAX-REASONING]         local cy1 = cy2 - ch  -- Top of body
03269 [GPT-5-CODEX-MAX-REASONING]         local lidTop = cy1 - math.floor(ch * 0.4)
03270 [GPT-5-CODEX-MAX-REASONING]         -- Main body
03271 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(cx1, cy1, cx2, cy2, COLOR_BROWN)
03272 [GPT-5-CODEX-MAX-REASONING]         -- Lid (slightly raised)
03273 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(cx1 - 2, lidTop, cx2 + 2, cy1, COLOR_LIGHT_BROWN)
03274 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(cx1, lidTop + 2, cx2, cy1 - 2, COLOR_BROWN)
03275 [GPT-5-CODEX-MAX-REASONING]         -- Metal corners
03276 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(cx1, cy1, cx1 + 4, cy2, COLOR_GRAY)
03277 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(cx2 - 4, cy1, cx2, cy2, COLOR_GRAY)
03278 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(cx1, lidTop, cx1 + 4, cy1, COLOR_GRAY)
03279 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(cx2 - 4, lidTop, cx2, cy1, COLOR_GRAY)
03280 [GPT-5-CODEX-MAX-REASONING]         -- Lock
03281 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(screenX - 4, cy1 - 6, screenX + 4, cy1 + 6, COLOR_YELLOW)
03282 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(screenX - 2, cy1 - 3, screenX + 2, cy1 + 3, COLOR_DARK_BROWN)
03283 [GPT-5-CODEX-MAX-REASONING]         -- Keyhole
03284 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(screenX - 1, cy1, screenX + 1, cy1 + 2, COLOR_BLACK)
03285 [GPT-5-CODEX-MAX-REASONING] 
03286 [GPT-5-CODEX-MAX-REASONING]     elseif stype == 5 then
03287 [GPT-5-CODEX-MAX-REASONING]         if spriteData and spriteData.dying and #warriorDeath > 0 then
03288 [GPT-5-CODEX-MAX-REASONING]             local frameIndex = spriteData.deathFrame or 1
03289 [GPT-5-CODEX-MAX-REASONING]             local sprite = warriorDeath[math.min(frameIndex, #warriorDeath)]
03290 [GPT-5-CODEX-MAX-REASONING]             if sprite and sprite.height then
03291 [GPT-5-CODEX-MAX-REASONING]                 local desiredHeight = size
03292 [GPT-5-CODEX-MAX-REASONING]                 local scale = safeDivide(desiredHeight, sprite.height, "renderWarriorDeath")
03293 [GPT-5-CODEX-MAX-REASONING]                 local scaledWidth = sprite.width * scale
03294 [GPT-5-CODEX-MAX-REASONING]                 local scaledHeight = sprite.height * scale
03295 [GPT-5-CODEX-MAX-REASONING]                 local drawX = screenX - math.floor(scaledWidth / 2)
03296 [GPT-5-CODEX-MAX-REASONING]                 local groundY = HORIZON + size
03297 [GPT-5-CODEX-MAX-REASONING]                 if groundY > 240 then groundY = 240 end
03298 [GPT-5-CODEX-MAX-REASONING]                 local drawY = groundY - math.floor(scaledHeight)
03299 [GPT-5-CODEX-MAX-REASONING]                 if safeScale(sprite, scale, scale, "renderWarriorDeath") then
03300 [GPT-5-CODEX-MAX-REASONING]                     vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, vmupro.sprite.kImageUnflipped)
03301 [GPT-5-CODEX-MAX-REASONING]                 end
03302 [GPT-5-CODEX-MAX-REASONING]             end
03303 [GPT-5-CODEX-MAX-REASONING]             return
03304 [GPT-5-CODEX-MAX-REASONING]         end
03305 [GPT-5-CODEX-MAX-REASONING]         -- Warrior Guard using real sprites
03306 [GPT-5-CODEX-MAX-REASONING]         -- Determine view: 0=front, 1=right, 2=back, 3=left
03307 [GPT-5-CODEX-MAX-REASONING]         local view = 0
03308 [GPT-5-CODEX-MAX-REASONING]         if viewAngle then
03309 [GPT-5-CODEX-MAX-REASONING]             if DEBUG_CYCLE_VIEW then
03310 [GPT-5-CODEX-MAX-REASONING]                 view = math.floor(frameCount / DEBUG_CYCLE_VIEW_FRAMES) % 4
03311 [GPT-5-CODEX-MAX-REASONING]             elseif DEBUG_FORCE_VIEW then
03312 [GPT-5-CODEX-MAX-REASONING]                 view = DEBUG_FORCE_VIEW
03313 [GPT-5-CODEX-MAX-REASONING]             elseif DEBUG_FORCE_SIDE_VIEW then
03314 [GPT-5-CODEX-MAX-REASONING]                 view = (viewAngle >= 0) and 3 or 1
03315 [GPT-5-CODEX-MAX-REASONING]             else
03316 [GPT-5-CODEX-MAX-REASONING]                 if viewAngle >= -8 and viewAngle <= 8 then view = 0
03317 [GPT-5-CODEX-MAX-REASONING]                 elseif viewAngle > 8 and viewAngle < 24 then view = 3
03318 [GPT-5-CODEX-MAX-REASONING]                 elseif viewAngle >= 24 or viewAngle <= -24 then view = 2
03319 [GPT-5-CODEX-MAX-REASONING]                 else view = 1 end
03320 [GPT-5-CODEX-MAX-REASONING]             end
03321 [GPT-5-CODEX-MAX-REASONING]         end
03322 [GPT-5-CODEX-MAX-REASONING] 
03323 [GPT-5-CODEX-MAX-REASONING]         -- Attack animation (2-frame) overrides walk/idle
03324 [GPT-5-CODEX-MAX-REASONING]         if spriteData and spriteData.attackAnim and spriteData.attackAnim > 0 then
03325 [GPT-5-CODEX-MAX-REASONING]             local frameIndex = (spriteData.attackFrame or 1)
03326 [GPT-5-CODEX-MAX-REASONING]             local sprite = nil
03327 [GPT-5-CODEX-MAX-REASONING]             if view == 0 then
03328 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorAttackFront[frameIndex]
03329 [GPT-5-CODEX-MAX-REASONING]             elseif view == 2 then
03330 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorAttackBack[frameIndex]
03331 [GPT-5-CODEX-MAX-REASONING]             elseif view == 3 then
03332 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorAttackLeft[frameIndex]
03333 [GPT-5-CODEX-MAX-REASONING]             else
03334 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorAttackRight[frameIndex]
03335 [GPT-5-CODEX-MAX-REASONING]             end
03336 [GPT-5-CODEX-MAX-REASONING] 
03337 [GPT-5-CODEX-MAX-REASONING]             if sprite and sprite.height then
03338 [GPT-5-CODEX-MAX-REASONING]                 local desiredHeight = size
03339 [GPT-5-CODEX-MAX-REASONING]                 local scale = safeDivide(desiredHeight, sprite.height, "renderScale")
03340 [GPT-5-CODEX-MAX-REASONING]                 local scaledWidth = sprite.width * scale
03341 [GPT-5-CODEX-MAX-REASONING]                 local scaledHeight = sprite.height * scale
03342 [GPT-5-CODEX-MAX-REASONING]                 local drawX = screenX - math.floor(scaledWidth / 2)
03343 [GPT-5-CODEX-MAX-REASONING]                 local groundY = HORIZON + size
03344 [GPT-5-CODEX-MAX-REASONING]                 if groundY > 240 then groundY = 240 end
03345 [GPT-5-CODEX-MAX-REASONING]                 local drawY = groundY - math.floor(scaledHeight)
03346 [GPT-5-CODEX-MAX-REASONING]                 vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, vmupro.sprite.kImageUnflipped)
03347 [GPT-5-CODEX-MAX-REASONING]             end
03348 [GPT-5-CODEX-MAX-REASONING]             return
03349 [GPT-5-CODEX-MAX-REASONING]         end
03350 [GPT-5-CODEX-MAX-REASONING] 
03351 [GPT-5-CODEX-MAX-REASONING]         -- Select appropriate sprite based on view and animation state
03352 [GPT-5-CODEX-MAX-REASONING]         local sprite = warriorFront
03353 [GPT-5-CODEX-MAX-REASONING]         local flipFlag = vmupro.sprite.kImageUnflipped
03354 [GPT-5-CODEX-MAX-REASONING]         local isMoving = animFrame ~= nil  -- Has animation = is patrolling
03355 [GPT-5-CODEX-MAX-REASONING]         if DEBUG_WALK_IN_PLACE then
03356 [GPT-5-CODEX-MAX-REASONING]             isMoving = true
03357 [GPT-5-CODEX-MAX-REASONING]         end
03358 [GPT-5-CODEX-MAX-REASONING]         local animTick = animFrame
03359 [GPT-5-CODEX-MAX-REASONING]         if DEBUG_FORCE_GLOBAL_WALK then
03360 [GPT-5-CODEX-MAX-REASONING]             animTick = frameCount
03361 [GPT-5-CODEX-MAX-REASONING]         end
03362 [GPT-5-CODEX-MAX-REASONING]         local debugWalkFrame = nil
03363 [GPT-5-CODEX-MAX-REASONING]         local debugSpriteLabel = "?"
03364 [GPT-5-CODEX-MAX-REASONING] 
03365 [GPT-5-CODEX-MAX-REASONING]         if view == 0 then
03366 [GPT-5-CODEX-MAX-REASONING]             -- Front view - use front sprite (no walking animation for front yet)
03367 [GPT-5-CODEX-MAX-REASONING]             if DEBUG_CYCLE_VIEW then
03368 [GPT-5-CODEX-MAX-REASONING]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Front and 3) or 2)
03369 [GPT-5-CODEX-MAX-REASONING]                 local walkFrame = math.floor(animTick / 7) % frameCount
03370 [GPT-5-CODEX-MAX-REASONING]                 debugWalkFrame = walkFrame
03371 [GPT-5-CODEX-MAX-REASONING]                 if walkFrame == 0 and warriorWalk1Front then
03372 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk1Front
03373 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F1"
03374 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 1 and warriorWalk2Front then
03375 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk2Front
03376 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F2"
03377 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 2 and warriorWalk3Front then
03378 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk3Front
03379 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F3"
03380 [GPT-5-CODEX-MAX-REASONING]                 else
03381 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorFront
03382 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F0"
03383 [GPT-5-CODEX-MAX-REASONING]                 end
03384 [GPT-5-CODEX-MAX-REASONING]             elseif isMoving then
03385 [GPT-5-CODEX-MAX-REASONING]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Front and 3) or 2)
03386 [GPT-5-CODEX-MAX-REASONING]                 local walkFrame = math.floor(animTick / 7) % frameCount
03387 [GPT-5-CODEX-MAX-REASONING]                 debugWalkFrame = walkFrame
03388 [GPT-5-CODEX-MAX-REASONING]                 if walkFrame == 0 and warriorWalk1Front then
03389 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk1Front
03390 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F1"
03391 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 1 and warriorWalk2Front then
03392 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk2Front
03393 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F2"
03394 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 2 and warriorWalk3Front then
03395 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk3Front
03396 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F3"
03397 [GPT-5-CODEX-MAX-REASONING]                 else
03398 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorFront  -- Fallback
03399 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "F0"
03400 [GPT-5-CODEX-MAX-REASONING]                 end
03401 [GPT-5-CODEX-MAX-REASONING]             else
03402 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorFront
03403 [GPT-5-CODEX-MAX-REASONING]                 debugSpriteLabel = "F0"
03404 [GPT-5-CODEX-MAX-REASONING]             end
03405 [GPT-5-CODEX-MAX-REASONING]         elseif view == 2 then
03406 [GPT-5-CODEX-MAX-REASONING]             -- Back view
03407 [GPT-5-CODEX-MAX-REASONING]             if DEBUG_CYCLE_VIEW then
03408 [GPT-5-CODEX-MAX-REASONING]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Back and 3) or 2)
03409 [GPT-5-CODEX-MAX-REASONING]                 local walkFrame = math.floor(animTick / 7) % frameCount
03410 [GPT-5-CODEX-MAX-REASONING]                 debugWalkFrame = walkFrame
03411 [GPT-5-CODEX-MAX-REASONING]                 if walkFrame == 0 and warriorWalk1Back then
03412 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk1Back
03413 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B1"
03414 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 1 and warriorWalk2Back then
03415 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk2Back
03416 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B2"
03417 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 2 and warriorWalk3Back then
03418 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk3Back
03419 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B3"
03420 [GPT-5-CODEX-MAX-REASONING]                 else
03421 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorBack
03422 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B0"
03423 [GPT-5-CODEX-MAX-REASONING]                 end
03424 [GPT-5-CODEX-MAX-REASONING]             elseif isMoving then
03425 [GPT-5-CODEX-MAX-REASONING]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Back and 3) or 2)
03426 [GPT-5-CODEX-MAX-REASONING]                 local walkFrame = math.floor(animTick / 7) % frameCount
03427 [GPT-5-CODEX-MAX-REASONING]                 debugWalkFrame = walkFrame
03428 [GPT-5-CODEX-MAX-REASONING]                 if walkFrame == 0 and warriorWalk1Back then
03429 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk1Back
03430 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B1"
03431 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 1 and warriorWalk2Back then
03432 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk2Back
03433 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B2"
03434 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 2 and warriorWalk3Back then
03435 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk3Back
03436 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B3"
03437 [GPT-5-CODEX-MAX-REASONING]                 else
03438 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorBack  -- Fallback
03439 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "B0"
03440 [GPT-5-CODEX-MAX-REASONING]                 end
03441 [GPT-5-CODEX-MAX-REASONING]             else
03442 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorBack
03443 [GPT-5-CODEX-MAX-REASONING]                 debugSpriteLabel = "B0"
03444 [GPT-5-CODEX-MAX-REASONING]             end
03445 [GPT-5-CODEX-MAX-REASONING]         elseif view == 3 then
03446 [GPT-5-CODEX-MAX-REASONING]             -- Left side view - show LEFT-facing sprites
03447 [GPT-5-CODEX-MAX-REASONING]             if isMoving then
03448 [GPT-5-CODEX-MAX-REASONING]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3 and 3) or 2)
03449 [GPT-5-CODEX-MAX-REASONING]                 local walkFrame = math.floor(animTick / 7) % frameCount
03450 [GPT-5-CODEX-MAX-REASONING]                 debugWalkFrame = walkFrame
03451 [GPT-5-CODEX-MAX-REASONING]                 if walkFrame == 0 and warriorWalk1 then
03452 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk1
03453 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "L1"
03454 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 1 and warriorWalk2 then
03455 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk2
03456 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "L2"
03457 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 2 and warriorWalk3 then
03458 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk3
03459 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "L3"
03460 [GPT-5-CODEX-MAX-REASONING]                 else
03461 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorLeft  -- Fallback
03462 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "L0"
03463 [GPT-5-CODEX-MAX-REASONING]                 end
03464 [GPT-5-CODEX-MAX-REASONING]             else
03465 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorLeft
03466 [GPT-5-CODEX-MAX-REASONING]                 debugSpriteLabel = "L0"
03467 [GPT-5-CODEX-MAX-REASONING]             end
03468 [GPT-5-CODEX-MAX-REASONING]         else
03469 [GPT-5-CODEX-MAX-REASONING]             -- Right side view (view == 1) - show RIGHT-facing sprites
03470 [GPT-5-CODEX-MAX-REASONING]             if isMoving then
03471 [GPT-5-CODEX-MAX-REASONING]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3R and 3) or 2)
03472 [GPT-5-CODEX-MAX-REASONING]                 local walkFrame = math.floor(animTick / 7) % frameCount
03473 [GPT-5-CODEX-MAX-REASONING]                 debugWalkFrame = walkFrame
03474 [GPT-5-CODEX-MAX-REASONING]                 if walkFrame == 0 and warriorWalk1R then
03475 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk1R
03476 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "R1"
03477 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 1 and warriorWalk2R then
03478 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk2R
03479 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "R2"
03480 [GPT-5-CODEX-MAX-REASONING]                 elseif walkFrame == 2 and warriorWalk3R then
03481 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorWalk3R
03482 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "R3"
03483 [GPT-5-CODEX-MAX-REASONING]                 else
03484 [GPT-5-CODEX-MAX-REASONING]                     sprite = warriorRight  -- Fallback
03485 [GPT-5-CODEX-MAX-REASONING]                     debugSpriteLabel = "R0"
03486 [GPT-5-CODEX-MAX-REASONING]                 end
03487 [GPT-5-CODEX-MAX-REASONING]             else
03488 [GPT-5-CODEX-MAX-REASONING]                 sprite = warriorRight
03489 [GPT-5-CODEX-MAX-REASONING]                 debugSpriteLabel = "R0"
03490 [GPT-5-CODEX-MAX-REASONING]             end
03491 [GPT-5-CODEX-MAX-REASONING]         end
03492 [GPT-5-CODEX-MAX-REASONING] 
03493 [GPT-5-CODEX-MAX-REASONING]         -- Draw sprite scaled based on distance
03494 [GPT-5-CODEX-MAX-REASONING]         if sprite and sprite.height then
03495 [GPT-5-CODEX-MAX-REASONING]             -- Calculate scale to fit desired height on screen
03496 [GPT-5-CODEX-MAX-REASONING]             local desiredHeight = size  -- size is based on distance
03497 [GPT-5-CODEX-MAX-REASONING]             local scale = safeDivide(desiredHeight, sprite.height, "renderScale")
03498 [GPT-5-CODEX-MAX-REASONING] 
03499 [GPT-5-CODEX-MAX-REASONING]             -- Calculate draw position (centered horizontally)
03500 [GPT-5-CODEX-MAX-REASONING]             local scaledWidth = sprite.width * scale
03501 [GPT-5-CODEX-MAX-REASONING]             local scaledHeight = sprite.height * scale
03502 [GPT-5-CODEX-MAX-REASONING]             local drawX = screenX - math.floor(scaledWidth / 2)
03503 [GPT-5-CODEX-MAX-REASONING] 
03504 [GPT-5-CODEX-MAX-REASONING]             -- Position sprite with feet on ground level
03505 [GPT-5-CODEX-MAX-REASONING]             -- Ground level = HORIZON + size (matches wall bottoms)
03506 [GPT-5-CODEX-MAX-REASONING]             local groundY = HORIZON + size
03507 [GPT-5-CODEX-MAX-REASONING]             if groundY > 240 then groundY = 240 end
03508 [GPT-5-CODEX-MAX-REASONING]             local drawY = groundY - math.floor(scaledHeight)
03509 [GPT-5-CODEX-MAX-REASONING] 
03510 [GPT-5-CODEX-MAX-REASONING]             if DEBUG_WALK_OFFSET and debugWalkFrame ~= nil then
03511 [GPT-5-CODEX-MAX-REASONING]                 if debugWalkFrame == 1 then
03512 [GPT-5-CODEX-MAX-REASONING]                     drawX = drawX + 6
03513 [GPT-5-CODEX-MAX-REASONING]                     drawY = drawY + 3
03514 [GPT-5-CODEX-MAX-REASONING]                 end
03515 [GPT-5-CODEX-MAX-REASONING]             end
03516 [GPT-5-CODEX-MAX-REASONING] 
03517 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, flipFlag)
03518 [GPT-5-CODEX-MAX-REASONING] 
03519 [GPT-5-CODEX-MAX-REASONING]             if DEBUG_SHOW_WALK_INFO then
03520 [GPT-5-CODEX-MAX-REASONING]                 local info = "V:" .. tostring(view) .. " WF:" .. tostring(debugWalkFrame or -1) .. " S:" .. debugSpriteLabel
03521 [GPT-5-CODEX-MAX-REASONING]                 vmupro.text.setFont(vmupro.text.FONT_TINY_6x8)
03522 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawText(info, 5, 220, COLOR_WHITE, COLOR_BLACK)
03523 [GPT-5-CODEX-MAX-REASONING]             end
03524 [GPT-5-CODEX-MAX-REASONING] 
03525 [GPT-5-CODEX-MAX-REASONING]             -- Draw health bar above soldier if alive and has hp data
03526 [GPT-5-CODEX-MAX-REASONING]             if spriteData and spriteData.hp and spriteData.alive then
03527 [GPT-5-CODEX-MAX-REASONING]                 local barWidth = math.floor(scaledWidth * 0.8)
03528 [GPT-5-CODEX-MAX-REASONING]                 local barHeight = math.max(3, math.floor(4 / dist * 2))
03529 [GPT-5-CODEX-MAX-REASONING]                 local barX = drawX + math.floor((scaledWidth - barWidth) / 2)
03530 [GPT-5-CODEX-MAX-REASONING]                 local barY = drawY - barHeight - 2
03531 [GPT-5-CODEX-MAX-REASONING] 
03532 [GPT-5-CODEX-MAX-REASONING]                 -- Background (dark red)
03533 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawFillRect(barX, barY, barX + barWidth, barY + barHeight, COLOR_MAROON)
03534 [GPT-5-CODEX-MAX-REASONING] 
03535 [GPT-5-CODEX-MAX-REASONING]                 -- Health portion (bright red)
03536 [GPT-5-CODEX-MAX-REASONING]                 local healthWidth = math.floor(barWidth * (spriteData.hp / ENEMY_MAX_HP))
03537 [GPT-5-CODEX-MAX-REASONING]                 if healthWidth > 0 then
03538 [GPT-5-CODEX-MAX-REASONING]                     vmupro.graphics.drawFillRect(barX, barY, barX + healthWidth, barY + barHeight, COLOR_RED)
03539 [GPT-5-CODEX-MAX-REASONING]                 end
03540 [GPT-5-CODEX-MAX-REASONING]             end
03541 [GPT-5-CODEX-MAX-REASONING]         end
03542 [GPT-5-CODEX-MAX-REASONING] 
03543 [GPT-5-CODEX-MAX-REASONING]     elseif stype == 6 then
03544 [GPT-5-CODEX-MAX-REASONING]         -- Knight Guard using real sprites
03545 [GPT-5-CODEX-MAX-REASONING]         -- Determine view: 0=front, 1=right, 2=back, 3=left
03546 [GPT-5-CODEX-MAX-REASONING]         local view = 0
03547 [GPT-5-CODEX-MAX-REASONING]         if viewAngle then
03548 [GPT-5-CODEX-MAX-REASONING]             if viewAngle >= -8 and viewAngle <= 8 then view = 0
03549 [GPT-5-CODEX-MAX-REASONING]             elseif viewAngle > 8 and viewAngle < 24 then view = 3
03550 [GPT-5-CODEX-MAX-REASONING]             elseif viewAngle >= 24 or viewAngle <= -24 then view = 2
03551 [GPT-5-CODEX-MAX-REASONING]             else view = 1 end
03552 [GPT-5-CODEX-MAX-REASONING]         end
03553 [GPT-5-CODEX-MAX-REASONING] 
03554 [GPT-5-CODEX-MAX-REASONING]         -- Select appropriate sprite based on view
03555 [GPT-5-CODEX-MAX-REASONING]         local sprite = knightFront
03556 [GPT-5-CODEX-MAX-REASONING]         local flipFlag = vmupro.sprite.kImageUnflipped
03557 [GPT-5-CODEX-MAX-REASONING]         if view == 0 then
03558 [GPT-5-CODEX-MAX-REASONING]             sprite = knightFront
03559 [GPT-5-CODEX-MAX-REASONING]         elseif view == 2 then
03560 [GPT-5-CODEX-MAX-REASONING]             sprite = knightBack
03561 [GPT-5-CODEX-MAX-REASONING]         elseif view == 3 then
03562 [GPT-5-CODEX-MAX-REASONING]             sprite = knightLeft
03563 [GPT-5-CODEX-MAX-REASONING]         else
03564 [GPT-5-CODEX-MAX-REASONING]             sprite = knightRight
03565 [GPT-5-CODEX-MAX-REASONING]         end
03566 [GPT-5-CODEX-MAX-REASONING] 
03567 [GPT-5-CODEX-MAX-REASONING]         -- Draw sprite scaled based on distance
03568 [GPT-5-CODEX-MAX-REASONING]         if sprite and sprite.height then
03569 [GPT-5-CODEX-MAX-REASONING]             -- Calculate scale to fit desired height on screen
03570 [GPT-5-CODEX-MAX-REASONING]             local desiredHeight = size  -- size is based on distance
03571 [GPT-5-CODEX-MAX-REASONING]             local scale = safeDivide(desiredHeight, sprite.height, "renderScale")
03572 [GPT-5-CODEX-MAX-REASONING] 
03573 [GPT-5-CODEX-MAX-REASONING]             -- Calculate draw position (centered horizontally)
03574 [GPT-5-CODEX-MAX-REASONING]             local scaledWidth = sprite.width * scale
03575 [GPT-5-CODEX-MAX-REASONING]             local scaledHeight = sprite.height * scale
03576 [GPT-5-CODEX-MAX-REASONING]             local drawX = screenX - math.floor(scaledWidth / 2)
03577 [GPT-5-CODEX-MAX-REASONING] 
03578 [GPT-5-CODEX-MAX-REASONING]             -- Position sprite with feet on ground level
03579 [GPT-5-CODEX-MAX-REASONING]             local groundY = HORIZON + size
03580 [GPT-5-CODEX-MAX-REASONING]             if groundY > 240 then groundY = 240 end
03581 [GPT-5-CODEX-MAX-REASONING]             local drawY = groundY - math.floor(scaledHeight)
03582 [GPT-5-CODEX-MAX-REASONING] 
03583 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, flipFlag)
03584 [GPT-5-CODEX-MAX-REASONING]         end
03585 [GPT-5-CODEX-MAX-REASONING] 
03586 [GPT-5-CODEX-MAX-REASONING]     elseif stype == 7 then
03587 [GPT-5-CODEX-MAX-REASONING]         -- Health vial pickup (uses potion sprite)
03588 [GPT-5-CODEX-MAX-REASONING]         if spriteData and spriteData.collected then
03589 [GPT-5-CODEX-MAX-REASONING]             return  -- Don't draw collected vials
03590 [GPT-5-CODEX-MAX-REASONING]         end
03591 [GPT-5-CODEX-MAX-REASONING] 
03592 [GPT-5-CODEX-MAX-REASONING]         if potionSprite and potionSprite.height then
03593 [GPT-5-CODEX-MAX-REASONING]             -- Scale potion to fit on ground
03594 [GPT-5-CODEX-MAX-REASONING]             local desiredHeight = size * 0.6  -- Smaller than characters
03595 [GPT-5-CODEX-MAX-REASONING]             local scale = desiredHeight / potionSprite.height
03596 [GPT-5-CODEX-MAX-REASONING] 
03597 [GPT-5-CODEX-MAX-REASONING]             local scaledWidth = potionSprite.width * scale
03598 [GPT-5-CODEX-MAX-REASONING]             local scaledHeight = potionSprite.height * scale
03599 [GPT-5-CODEX-MAX-REASONING]             local drawX = screenX - math.floor(scaledWidth / 2)
03600 [GPT-5-CODEX-MAX-REASONING] 
03601 [GPT-5-CODEX-MAX-REASONING]             -- Position on ground
03602 [GPT-5-CODEX-MAX-REASONING]             local groundY = HORIZON + size
03603 [GPT-5-CODEX-MAX-REASONING]             if groundY > 240 then groundY = 240 end
03604 [GPT-5-CODEX-MAX-REASONING]             local drawY = groundY - math.floor(scaledHeight)
03605 [GPT-5-CODEX-MAX-REASONING] 
03606 [GPT-5-CODEX-MAX-REASONING]             vmupro.sprite.drawScaled(potionSprite, drawX, drawY, scale, scale, vmupro.sprite.kImageUnflipped)
03607 [GPT-5-CODEX-MAX-REASONING]         end
03608 [GPT-5-CODEX-MAX-REASONING]     end
03609 [GPT-5-CODEX-MAX-REASONING] end
03610 [GPT-5-CODEX-MAX-REASONING] 
03611 [GPT-5-CODEX-MAX-REASONING] local function renderGameFrame()
03612 [GPT-5-CODEX-MAX-REASONING]     -- Game rendering
03613 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.clear(COLOR_CEILING)
03614 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(0, HORIZON, 240, VIEWPORT_H, COLOR_FLOOR)
03615 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(0, VIEWPORT_H, 240, 240, COLOR_BLACK)
03616 [GPT-5-CODEX-MAX-REASONING] 
03617 [GPT-5-CODEX-MAX-REASONING]     -- Cheap horizon dressing: 3 sky bands + horizon line
03618 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(0, 0, 240, 39, COLOR_BLACK)
03619 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(0, 40, 240, 79, COLOR_DARK_GRAY)
03620 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(0, 80, 240, HORIZON - 2, COLOR_GRAY)
03621 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawLine(0, HORIZON - 1, 239, HORIZON - 1, COLOR_BLACK)
03622 [GPT-5-CODEX-MAX-REASONING]     -- Sparse fixed stars (very cheap)
03623 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(18, 10, 18, 10, COLOR_WHITE)
03624 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(92, 22, 92, 22, COLOR_WHITE)
03625 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(140, 14, 140, 14, COLOR_WHITE)
03626 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(210, 30, 210, 30, COLOR_WHITE)
03627 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(60, 48, 60, 48, COLOR_WHITE)
03628 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(170, 52, 170, 52, COLOR_WHITE)
03629 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(24, 66, 24, 66, COLOR_WHITE)
03630 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawFillRect(118, 70, 118, 70, COLOR_WHITE)
03631 [GPT-5-CODEX-MAX-REASONING] 
03632 [GPT-5-CODEX-MAX-REASONING] 
03633 [GPT-5-CODEX-MAX-REASONING]     if WALL_TEXTURE_MODE == "lazy_quads" then
03634 [GPT-5-CODEX-MAX-REASONING]         renderWallQuads()
03635 [GPT-5-CODEX-MAX-REASONING]     else
03636 [GPT-5-CODEX-MAX-REASONING]         if RENDERER_MODE == "exp_pure" then
03637 [GPT-5-CODEX-MAX-REASONING]             renderWallsExperimental()
03638 [GPT-5-CODEX-MAX-REASONING]         elseif RENDERER_MODE == "exp_hybrid" then
03639 [GPT-5-CODEX-MAX-REASONING]             renderWallsExperimentalHybrid()
03640 [GPT-5-CODEX-MAX-REASONING]         else
03641 [GPT-5-CODEX-MAX-REASONING]             local fovRad = renderCfg.fovSteps * (renderCfg.twoPi / 64)
03642 [GPT-5-CODEX-MAX-REASONING]             local playerAngle = (pdir % 64) * (renderCfg.twoPi / 64)
03643 [GPT-5-CODEX-MAX-REASONING]             local playerCos = math.cos(playerAngle)
03644 [GPT-5-CODEX-MAX-REASONING]             local playerSin = math.sin(playerAngle)
03645 [GPT-5-CODEX-MAX-REASONING]             local baseAngle = playerAngle - (fovRad / 2)
03646 [GPT-5-CODEX-MAX-REASONING]             local rayCols = renderCfg.rayCols
03647 [GPT-5-CODEX-MAX-REASONING]             local colW = renderCfg.colW
03648 [GPT-5-CODEX-MAX-REASONING]             if LOW_RES_WALLS then
03649 [GPT-5-CODEX-MAX-REASONING]                 if LOW_RES_MODE == "fast" then
03650 [GPT-5-CODEX-MAX-REASONING]                     rayCols = 32
03651 [GPT-5-CODEX-MAX-REASONING]                     colW = 8
03652 [GPT-5-CODEX-MAX-REASONING]                 else
03653 [GPT-5-CODEX-MAX-REASONING]                     rayCols = 48
03654 [GPT-5-CODEX-MAX-REASONING]                     colW = 5
03655 [GPT-5-CODEX-MAX-REASONING]                 end
03656 [GPT-5-CODEX-MAX-REASONING]             end
03657 [GPT-5-CODEX-MAX-REASONING]             local rayStep = fovRad / rayCols
03658 [GPT-5-CODEX-MAX-REASONING]             local stepCos = math.cos(rayStep)
03659 [GPT-5-CODEX-MAX-REASONING]             local stepSin = math.sin(rayStep)
03660 [GPT-5-CODEX-MAX-REASONING]             local rayCos = math.cos(baseAngle)
03661 [GPT-5-CODEX-MAX-REASONING]             local raySin = math.sin(baseAngle)
03662 [GPT-5-CODEX-MAX-REASONING]             for x = 0, rayCols - 1 do
03663 [GPT-5-CODEX-MAX-REASONING]                 local dist, wtype, side, texCoord = castRay(rayCos, raySin)
03664 [GPT-5-CODEX-MAX-REASONING]                 local fixedDist = dist * (rayCos * playerCos + raySin * playerSin)
03665 [GPT-5-CODEX-MAX-REASONING]                 if fixedDist < 0.4 then fixedDist = 0.4 end
03666 [GPT-5-CODEX-MAX-REASONING]                 local viewDist = EXP_VIEW_DIST or 8.0
03667 [GPT-5-CODEX-MAX-REASONING]                 local texView = EXP_TEX_MAX_DIST or viewDist
03668 [GPT-5-CODEX-MAX-REASONING]                 if RENDERER_MODE == "exp_hybrid" then
03669 [GPT-5-CODEX-MAX-REASONING]                     viewDist = texView
03670 [GPT-5-CODEX-MAX-REASONING]                 end
03671 [GPT-5-CODEX-MAX-REASONING]                 if fixedDist > viewDist then
03672 [GPT-5-CODEX-MAX-REASONING]                     local nextCos = (rayCos * stepCos) - (raySin * stepSin)
03673 [GPT-5-CODEX-MAX-REASONING]                     raySin = (raySin * stepCos) + (rayCos * stepSin)
03674 [GPT-5-CODEX-MAX-REASONING]                     rayCos = nextCos
03675 [GPT-5-CODEX-MAX-REASONING]                     goto continue_ray
03676 [GPT-5-CODEX-MAX-REASONING]                 end
03677 [GPT-5-CODEX-MAX-REASONING]                 local wallScale = VIEWPORT_H - 20
03678 [GPT-5-CODEX-MAX-REASONING]                 local h = math.floor(wallScale / fixedDist)
03679 [GPT-5-CODEX-MAX-REASONING]                 if h > VIEWPORT_H then h = VIEWPORT_H end
03680 [GPT-5-CODEX-MAX-REASONING]                 local y1 = HORIZON - math.floor(h / 2)
03681 [GPT-5-CODEX-MAX-REASONING]                 local y2 = HORIZON + math.floor(h / 2)
03682 [GPT-5-CODEX-MAX-REASONING]                 if y1 < 0 then y1 = 0 end
03683 [GPT-5-CODEX-MAX-REASONING]                 if y2 > VIEWPORT_H then y2 = VIEWPORT_H end
03684 [GPT-5-CODEX-MAX-REASONING] 
03685 [GPT-5-CODEX-MAX-REASONING]                 local baseColor = getWallColor(wtype, side)
03686 [GPT-5-CODEX-MAX-REASONING]                 if not DEBUG_DISABLE_FOG then
03687 [GPT-5-CODEX-MAX-REASONING]                     baseColor = fogBlend(baseColor, fixedDist)
03688 [GPT-5-CODEX-MAX-REASONING]                 end
03689 [GPT-5-CODEX-MAX-REASONING]                 local sx = x * colW
03690 [GPT-5-CODEX-MAX-REASONING] 
03691 [GPT-5-CODEX-MAX-REASONING]                 -- Draw base wall color
03692 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawFillRect(sx, y1, sx + colW, y2, baseColor)
03693 [GPT-5-CODEX-MAX-REASONING]                 if fixedDist < 1.0 and not DEBUG_DISABLE_WALL_TEXTURE then
03694 [GPT-5-CODEX-MAX-REASONING]                     drawWallTexture(wtype, side, sx, y1, y2)
03695 [GPT-5-CODEX-MAX-REASONING]                     goto continue_ray
03696 [GPT-5-CODEX-MAX-REASONING]                 end
03697 [GPT-5-CODEX-MAX-REASONING]                 local skipTex = renderCfg.skipOddTex and ((x % 2) == 1)
03698 [GPT-5-CODEX-MAX-REASONING]                 if LOW_RES_WALLS and LOW_RES_MODE == "fast" and (x % 2) == 1 then
03699 [GPT-5-CODEX-MAX-REASONING]                     skipTex = true
03700 [GPT-5-CODEX-MAX-REASONING]                 end
03701 [GPT-5-CODEX-MAX-REASONING]                 local nearForceTex = fixedDist < 1.0
03702 [GPT-5-CODEX-MAX-REASONING]                 local farWall = fixedDist > texView
03703 [GPT-5-CODEX-MAX-REASONING]                 local fogCutoff = FOG_TEX_CUTOFF or 3.5
03704 [GPT-5-CODEX-MAX-REASONING]                 local fogTextureSkip = (not DEBUG_DISABLE_FOG) and (fixedDist > fogCutoff)
03705 [GPT-5-CODEX-MAX-REASONING]                 if nearForceTex then
03706 [GPT-5-CODEX-MAX-REASONING]                     farWall = false
03707 [GPT-5-CODEX-MAX-REASONING]                     fogTextureSkip = false
03708 [GPT-5-CODEX-MAX-REASONING]                     skipTex = false
03709 [GPT-5-CODEX-MAX-REASONING]                 end
03710 [GPT-5-CODEX-MAX-REASONING]                 if RENDERER_MODE == "exp_hybrid" and viewDist == texView then
03711 [GPT-5-CODEX-MAX-REASONING]                     skipTex = false
03712 [GPT-5-CODEX-MAX-REASONING]                 end
03713 [GPT-5-CODEX-MAX-REASONING]                 if WALL_TEXTURE_MODE == "proper" and not DEBUG_DISABLE_WALL_TEXTURE and not skipTex and not farWall and not fogTextureSkip then
03714 [GPT-5-CODEX-MAX-REASONING]                     local useTex = texCoord or 0
03715 [GPT-5-CODEX-MAX-REASONING]                     if useTex < 0 then useTex = 0 end
03716 [GPT-5-CODEX-MAX-REASONING]                     if useTex > 0.999 then useTex = 0.999 end
03717 [GPT-5-CODEX-MAX-REASONING]                     -- Flip texture coordinate based on ray direction and hit side
03718 [GPT-5-CODEX-MAX-REASONING]                     if side == 0 and rayCos > 0 then
03719 [GPT-5-CODEX-MAX-REASONING]                         useTex = 1.0 - useTex
03720 [GPT-5-CODEX-MAX-REASONING]                     elseif side == 1 and raySin < 0 then
03721 [GPT-5-CODEX-MAX-REASONING]                         useTex = 1.0 - useTex
03722 [GPT-5-CODEX-MAX-REASONING]                     end
03723 [GPT-5-CODEX-MAX-REASONING]                     local drew = drawWallTextureColumn(wtype, side, useTex, sx, y1, y2, colW)
03724 [GPT-5-CODEX-MAX-REASONING]                     if not drew then
03725 [GPT-5-CODEX-MAX-REASONING]                         -- Fallback to legacy overlay if no sheet is available
03726 [GPT-5-CODEX-MAX-REASONING]                         drawWallTexture(wtype, side, sx, y1, y2)
03727 [GPT-5-CODEX-MAX-REASONING]                     end
03728 [GPT-5-CODEX-MAX-REASONING]                 elseif WALL_TEXTURE_MODE == "flat" then
03729 [GPT-5-CODEX-MAX-REASONING]                     -- Flat color only
03730 [GPT-5-CODEX-MAX-REASONING]                 else
03731 [GPT-5-CODEX-MAX-REASONING]                     if not DEBUG_DISABLE_WALL_TEXTURE then
03732 [GPT-5-CODEX-MAX-REASONING]                         -- Legacy (lazy) texture overlay
03733 [GPT-5-CODEX-MAX-REASONING]                         drawWallTexture(wtype, side, sx, y1, y2)
03734 [GPT-5-CODEX-MAX-REASONING]                     end
03735 [GPT-5-CODEX-MAX-REASONING]                 end
03736 [GPT-5-CODEX-MAX-REASONING] 
03737 [GPT-5-CODEX-MAX-REASONING]                 -- Increment ray direction by fixed step (rotation)
03738 [GPT-5-CODEX-MAX-REASONING]                 local nextCos = (rayCos * stepCos) - (raySin * stepSin)
03739 [GPT-5-CODEX-MAX-REASONING]                 raySin = (raySin * stepCos) + (rayCos * stepSin)
03740 [GPT-5-CODEX-MAX-REASONING]                 rayCos = nextCos
03741 [GPT-5-CODEX-MAX-REASONING]                 ::continue_ray::
03742 [GPT-5-CODEX-MAX-REASONING]             end
03743 [GPT-5-CODEX-MAX-REASONING]         end
03744 [GPT-5-CODEX-MAX-REASONING]     end
03745 [GPT-5-CODEX-MAX-REASONING] 
03746 [GPT-5-CODEX-MAX-REASONING]     if not DEBUG_SKIP_SPRITES then
03747 [GPT-5-CODEX-MAX-REASONING]         if frameCount - spriteOrderCacheFrame >= 8 or #spriteOrderCache == 0 then
03748 [GPT-5-CODEX-MAX-REASONING]             local spriteOrder = {}
03749 [GPT-5-CODEX-MAX-REASONING]             local count = 0
03750 [GPT-5-CODEX-MAX-REASONING]             for i = 1, #sprites do
03751 [GPT-5-CODEX-MAX-REASONING]                 local s = sprites[i]
03752 [GPT-5-CODEX-MAX-REASONING]                 if not s then
03753 [GPT-5-CODEX-MAX-REASONING]                     goto continue_sprite_build
03754 [GPT-5-CODEX-MAX-REASONING]                 end
03755 [GPT-5-CODEX-MAX-REASONING]                 local skip = (DEBUG_DISABLE_ENEMIES and isEnemyType(s.t))
03756 [GPT-5-CODEX-MAX-REASONING]                     or (DEBUG_DISABLE_PROPS and isPropType(s.t))
03757 [GPT-5-CODEX-MAX-REASONING]                 if not skip then
03758 [GPT-5-CODEX-MAX-REASONING]                     local sdx, sdy = s.x - px, s.y - py
03759 [GPT-5-CODEX-MAX-REASONING]                     local distSq = sdx * sdx + sdy * sdy
03760 [GPT-5-CODEX-MAX-REASONING]                     local maxSq = SPRITE_MAX_DIST_SQ
03761 [GPT-5-CODEX-MAX-REASONING]                     if isEnemyType(s.t) then
03762 [GPT-5-CODEX-MAX-REASONING]                         maxSq = ENEMY_RENDER_DIST_SQ
03763 [GPT-5-CODEX-MAX-REASONING]                     elseif s.t == 7 then
03764 [GPT-5-CODEX-MAX-REASONING]                         maxSq = ITEM_RENDER_DIST_SQ
03765 [GPT-5-CODEX-MAX-REASONING]                     elseif isPropType(s.t) then
03766 [GPT-5-CODEX-MAX-REASONING]                         maxSq = PROP_RENDER_DIST_SQ
03767 [GPT-5-CODEX-MAX-REASONING]                     end
03768 [GPT-5-CODEX-MAX-REASONING]                     if distSq <= maxSq then
03769 [GPT-5-CODEX-MAX-REASONING]                         count = count + 1
03770 [GPT-5-CODEX-MAX-REASONING]                         spriteOrder[count] = {idx = i, dist = distSq}
03771 [GPT-5-CODEX-MAX-REASONING]                     end
03772 [GPT-5-CODEX-MAX-REASONING]                 end
03773 [GPT-5-CODEX-MAX-REASONING]                 ::continue_sprite_build::
03774 [GPT-5-CODEX-MAX-REASONING]             end
03775 [GPT-5-CODEX-MAX-REASONING]             if count > 1 then
03776 [GPT-5-CODEX-MAX-REASONING]                 table.sort(spriteOrder, function(a, b) return a.dist > b.dist end)
03777 [GPT-5-CODEX-MAX-REASONING]             end
03778 [GPT-5-CODEX-MAX-REASONING]             spriteOrderCache = spriteOrder
03779 [GPT-5-CODEX-MAX-REASONING]             spriteOrderCacheFrame = frameCount
03780 [GPT-5-CODEX-MAX-REASONING]         end
03781 [GPT-5-CODEX-MAX-REASONING] 
03782 [GPT-5-CODEX-MAX-REASONING]         for i = 1, #spriteOrderCache do
03783 [GPT-5-CODEX-MAX-REASONING]             local s = sprites[spriteOrderCache[i].idx]
03784 [GPT-5-CODEX-MAX-REASONING]             if not s then
03785 [GPT-5-CODEX-MAX-REASONING]                 goto continue_sprite
03786 [GPT-5-CODEX-MAX-REASONING]             end
03787 [GPT-5-CODEX-MAX-REASONING]             if DEBUG_DISABLE_ENEMIES and isEnemyType(s.t) then
03788 [GPT-5-CODEX-MAX-REASONING]                 goto continue_sprite
03789 [GPT-5-CODEX-MAX-REASONING]             end
03790 [GPT-5-CODEX-MAX-REASONING]             if DEBUG_DISABLE_PROPS and isPropType(s.t) then
03791 [GPT-5-CODEX-MAX-REASONING]                 goto continue_sprite
03792 [GPT-5-CODEX-MAX-REASONING]             end
03793 [GPT-5-CODEX-MAX-REASONING]             -- Skip dead soldiers
03794 [GPT-5-CODEX-MAX-REASONING]             if s.t == 5 and s.alive == false and not s.dying then
03795 [GPT-5-CODEX-MAX-REASONING]                 goto continue_sprite
03796 [GPT-5-CODEX-MAX-REASONING]             end
03797 [GPT-5-CODEX-MAX-REASONING]             local sdx, sdy = s.x - px, s.y - py
03798 [GPT-5-CODEX-MAX-REASONING]             local distSq = sdx * sdx + sdy * sdy
03799 [GPT-5-CODEX-MAX-REASONING]             local maxSq = SPRITE_MAX_DIST_SQ
03800 [GPT-5-CODEX-MAX-REASONING]             if isEnemyType(s.t) then
03801 [GPT-5-CODEX-MAX-REASONING]                 maxSq = ENEMY_RENDER_DIST_SQ
03802 [GPT-5-CODEX-MAX-REASONING]             elseif s.t == 7 then
03803 [GPT-5-CODEX-MAX-REASONING]                 maxSq = ITEM_RENDER_DIST_SQ
03804 [GPT-5-CODEX-MAX-REASONING]             elseif isPropType(s.t) then
03805 [GPT-5-CODEX-MAX-REASONING]                 maxSq = PROP_RENDER_DIST_SQ
03806 [GPT-5-CODEX-MAX-REASONING]             end
03807 [GPT-5-CODEX-MAX-REASONING]             if distSq <= maxSq then
03808 [GPT-5-CODEX-MAX-REASONING]                 local sdist = math.sqrt(distSq)
03809 [GPT-5-CODEX-MAX-REASONING]                 local visible = true
03810 [GPT-5-CODEX-MAX-REASONING]                 if sdist > SPRITE_VIS_DIST then
03811 [GPT-5-CODEX-MAX-REASONING]                     visible = false
03812 [GPT-5-CODEX-MAX-REASONING]                 else
03813 [GPT-5-CODEX-MAX-REASONING]                     visible = isVisible(s.x, s.y, s)
03814 [GPT-5-CODEX-MAX-REASONING]                 end
03815 [GPT-5-CODEX-MAX-REASONING]                 if sdist > 0.3 and visible then
03816 [GPT-5-CODEX-MAX-REASONING]                 local sAngle = 0
03817 [GPT-5-CODEX-MAX-REASONING]                 if sdx ~= 0 then
03818 [GPT-5-CODEX-MAX-REASONING]                     sAngle = math.atan(sdy / sdx)
03819 [GPT-5-CODEX-MAX-REASONING]                     if sdx < 0 then sAngle = sAngle + 3.14159 end
03820 [GPT-5-CODEX-MAX-REASONING]                 else
03821 [GPT-5-CODEX-MAX-REASONING]                     sAngle = sdy > 0 and 1.5708 or -1.5708
03822 [GPT-5-CODEX-MAX-REASONING]                 end
03823 [GPT-5-CODEX-MAX-REASONING]                 local sDir = math.floor(sAngle * 64 / 6.28318) % 64
03824 [GPT-5-CODEX-MAX-REASONING]                 local viewDiff = (sDir - pdir) % 64
03825 [GPT-5-CODEX-MAX-REASONING]                 if viewDiff > 32 then viewDiff = viewDiff - 64 end
03826 [GPT-5-CODEX-MAX-REASONING]                 if viewDiff >= -6 and viewDiff <= 6 then
03827 [GPT-5-CODEX-MAX-REASONING]                     if isExpRenderer() then
03828 [GPT-5-CODEX-MAX-REASONING]                         local dir = pdir % 64
03829 [GPT-5-CODEX-MAX-REASONING]                         local cosDir = cosTable[dir]
03830 [GPT-5-CODEX-MAX-REASONING]                         local sinDir = sinTable[dir]
03831 [GPT-5-CODEX-MAX-REASONING]                         local relX = (sdx * sinDir - sdy * cosDir)
03832 [GPT-5-CODEX-MAX-REASONING]                         local relY = (sdx * cosDir + sdy * sinDir)
03833 [GPT-5-CODEX-MAX-REASONING]                         if relY > 0.05 then
03834 [GPT-5-CODEX-MAX-REASONING]                             local sx = relX / relY
03835 [GPT-5-CODEX-MAX-REASONING]                             local screenX = math.floor(120 + sx * 120)
03836 [GPT-5-CODEX-MAX-REASONING]                             local occluded = false
03837 [GPT-5-CODEX-MAX-REASONING]                             for ox = -2, 2 do
03838 [GPT-5-CODEX-MAX-REASONING]                                 local cx = screenX + ox
03839 [GPT-5-CODEX-MAX-REASONING]                                 if cx >= 0 and cx <= 239 then
03840 [GPT-5-CODEX-MAX-REASONING]                                     local wallDist = expDepthBuf[cx]
03841 [GPT-5-CODEX-MAX-REASONING]                                     if wallDist and relY > wallDist then
03842 [GPT-5-CODEX-MAX-REASONING]                                         occluded = true
03843 [GPT-5-CODEX-MAX-REASONING]                                         break
03844 [GPT-5-CODEX-MAX-REASONING]                                     end
03845 [GPT-5-CODEX-MAX-REASONING]                                 end
03846 [GPT-5-CODEX-MAX-REASONING]                             end
03847 [GPT-5-CODEX-MAX-REASONING]                             if occluded then
03848 [GPT-5-CODEX-MAX-REASONING]                                 goto continue_sprite
03849 [GPT-5-CODEX-MAX-REASONING]                             end
03850 [GPT-5-CODEX-MAX-REASONING]                         end
03851 [GPT-5-CODEX-MAX-REASONING]                     end
03852 [GPT-5-CODEX-MAX-REASONING]                     -- Calculate view angle for guards (angle from guard's POV)
03853 [GPT-5-CODEX-MAX-REASONING]                     local guardViewAngle = nil
03854 [GPT-5-CODEX-MAX-REASONING]                     if (s.t == 5 or s.t == 6) and s.dir then
03855 [GPT-5-CODEX-MAX-REASONING]                         -- Angle player is approaching from relative to guard's facing
03856 [GPT-5-CODEX-MAX-REASONING]                         local approachDir = (sDir + 32) % 64  -- Opposite of sDir
03857 [GPT-5-CODEX-MAX-REASONING]                         guardViewAngle = (approachDir - s.dir) % 64
03858 [GPT-5-CODEX-MAX-REASONING]                         if guardViewAngle > 32 then guardViewAngle = guardViewAngle - 64 end
03859 [GPT-5-CODEX-MAX-REASONING]                     end
03860 [GPT-5-CODEX-MAX-REASONING]                     drawSprite(120 + viewDiff * 20, sdist, s.t, guardViewAngle, s.anim, s)
03861 [GPT-5-CODEX-MAX-REASONING]                 end
03862 [GPT-5-CODEX-MAX-REASONING]                 end
03863 [GPT-5-CODEX-MAX-REASONING]             end
03864 [GPT-5-CODEX-MAX-REASONING]             ::continue_sprite::
03865 [GPT-5-CODEX-MAX-REASONING]         end
03866 [GPT-5-CODEX-MAX-REASONING]     end
03867 [GPT-5-CODEX-MAX-REASONING] 
03868 [GPT-5-CODEX-MAX-REASONING]     if SHOW_MINIMAP then
03869 [GPT-5-CODEX-MAX-REASONING]         for my = 0, 15 do
03870 [GPT-5-CODEX-MAX-REASONING]             for mx = 0, 15 do
03871 [GPT-5-CODEX-MAX-REASONING]                 if map[my + 1][mx + 1] > 0 then
03872 [GPT-5-CODEX-MAX-REASONING]                     vmupro.graphics.drawFillRect(5 + mx * 4, 5 + my * 4, 8 + mx * 4, 8 + my * 4, COLOR_STONE_D)
03873 [GPT-5-CODEX-MAX-REASONING]                 end
03874 [GPT-5-CODEX-MAX-REASONING]             end
03875 [GPT-5-CODEX-MAX-REASONING]         end
03876 [GPT-5-CODEX-MAX-REASONING]         local ppx = 5 + math.floor(px * 4)
03877 [GPT-5-CODEX-MAX-REASONING]         local ppy = 5 + math.floor(py * 4)
03878 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(ppx - 1, ppy - 1, ppx + 1, ppy + 1, COLOR_RED)
03879 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawLine(ppx, ppy, ppx + math.floor(cosTable[pdir % 64] * 4), ppy + math.floor(sinTable[pdir % 64] * 4), COLOR_YELLOW)
03880 [GPT-5-CODEX-MAX-REASONING]     end
03881 [GPT-5-CODEX-MAX-REASONING] 
03882 [GPT-5-CODEX-MAX-REASONING]     -- Draw attack sword swing (always, even if effects are disabled)
03883 [GPT-5-CODEX-MAX-REASONING]     if isAttacking > 0 then
03884 [GPT-5-CODEX-MAX-REASONING]         if #swordAttack > 0 then
03885 [GPT-5-CODEX-MAX-REASONING]             local total = (attackTotalFrames > 0) and attackTotalFrames or (#swordAttack * 2)
03886 [GPT-5-CODEX-MAX-REASONING]             local frameHold = math.max(1, math.floor(total / #swordAttack))
03887 [GPT-5-CODEX-MAX-REASONING]             local frameIndex = math.floor((total - isAttacking) / frameHold) + 1
03888 [GPT-5-CODEX-MAX-REASONING]             if frameIndex < 1 then frameIndex = 1 end
03889 [GPT-5-CODEX-MAX-REASONING]             if frameIndex > #swordAttack then frameIndex = #swordAttack end
03890 [GPT-5-CODEX-MAX-REASONING]             local sprite = swordAttack[frameIndex]
03891 [GPT-5-CODEX-MAX-REASONING]             if sprite then
03892 [GPT-5-CODEX-MAX-REASONING]                 local drawX = 140
03893 [GPT-5-CODEX-MAX-REASONING]                 local drawY = 240 - sprite.height + 30
03894 [GPT-5-CODEX-MAX-REASONING]                 vmupro.sprite.draw(sprite, drawX, drawY, vmupro.sprite.kImageUnflipped)
03895 [GPT-5-CODEX-MAX-REASONING]             end
03896 [GPT-5-CODEX-MAX-REASONING]         else
03897 [GPT-5-CODEX-MAX-REASONING]             local swingAngle = (10 - isAttacking) * 9  -- 0 to 90 degrees
03898 [GPT-5-CODEX-MAX-REASONING]             local swordLen = 80
03899 [GPT-5-CODEX-MAX-REASONING]             local swordX = 180 + math.floor(math.sin(swingAngle * 0.0174) * 40)
03900 [GPT-5-CODEX-MAX-REASONING]             local swordY = 180 - math.floor(math.cos(swingAngle * 0.0174) * 60)
03901 [GPT-5-CODEX-MAX-REASONING]             -- Sword blade
03902 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(swordX - 4, swordY - swordLen, swordX + 4, swordY, COLOR_LIGHT_GRAY)
03903 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(swordX - 2, swordY - swordLen - 10, swordX + 2, swordY - swordLen, COLOR_LIGHT_GRAY)
03904 [GPT-5-CODEX-MAX-REASONING]             -- Sword hilt
03905 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(swordX - 12, swordY - 4, swordX + 12, swordY + 4, COLOR_BROWN)
03906 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(swordX - 6, swordY, swordX + 6, swordY + 20, COLOR_DARK_BROWN)
03907 [GPT-5-CODEX-MAX-REASONING]         end
03908 [GPT-5-CODEX-MAX-REASONING]     end
03909 [GPT-5-CODEX-MAX-REASONING] 
03910 [GPT-5-CODEX-MAX-REASONING]     -- Draw block shield
03911 [GPT-5-CODEX-MAX-REASONING]     if isBlocking then
03912 [GPT-5-CODEX-MAX-REASONING]         -- Shield in center of screen
03913 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(80, 140, 160, 230, COLOR_BROWN)
03914 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(85, 145, 155, 225, COLOR_DARK_BROWN)
03915 [GPT-5-CODEX-MAX-REASONING]         -- Shield boss (center)
03916 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(110, 175, 130, 195, COLOR_GRAY)
03917 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(115, 180, 125, 190, COLOR_LIGHT_GRAY)
03918 [GPT-5-CODEX-MAX-REASONING]         -- Shield rim
03919 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(80, 140, 160, 145, COLOR_GRAY)
03920 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(80, 225, 160, 230, COLOR_GRAY)
03921 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(80, 140, 85, 230, COLOR_GRAY)
03922 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(155, 140, 160, 230, COLOR_GRAY)
03923 [GPT-5-CODEX-MAX-REASONING]     end
03924 [GPT-5-CODEX-MAX-REASONING] 
03925 [GPT-5-CODEX-MAX-REASONING]     -- Draw menu
03926 [GPT-5-CODEX-MAX-REASONING]     if showMenu then
03927 [GPT-5-CODEX-MAX-REASONING]         if inOptionsMenu then
03928 [GPT-5-CODEX-MAX-REASONING]             -- Options submenu
03929 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(40, 30, 200, 230, COLOR_BLACK)
03930 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(45, 35, 195, 225, COLOR_DARK_GRAY)
03931 [GPT-5-CODEX-MAX-REASONING]             -- Title bar
03932 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(50, 40, 190, 60, COLOR_MAROON)
03933 [GPT-5-CODEX-MAX-REASONING]             vmupro.text.setFont(vmupro.text.FONT_SMALL)
03934 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawText("OPTIONS", 86, 44, COLOR_WHITE, COLOR_MAROON)
03935 [GPT-5-CODEX-MAX-REASONING]             -- Options items
03936 [GPT-5-CODEX-MAX-REASONING]             local soundText = "SOUND: " .. (soundEnabled and "ON" or "OFF")
03937 [GPT-5-CODEX-MAX-REASONING]             local healthText = "HEALTH%: " .. (showHealthPercent and "ON" or "OFF")
03938 [GPT-5-CODEX-MAX-REASONING]             local enemiesText = "ENEMIES: " .. (DEBUG_DISABLE_ENEMIES and "OFF" or "ON")
03939 [GPT-5-CODEX-MAX-REASONING]             local propsText = "PROPS: " .. (DEBUG_DISABLE_PROPS and "OFF" or "ON")
03940 [GPT-5-CODEX-MAX-REASONING]             local texturesText = "TEXTURES: " .. (DEBUG_DISABLE_WALL_TEXTURE and "OFF" or "ON")
03941 [GPT-5-CODEX-MAX-REASONING]             local fpsText = "FPS: " .. (showFpsOverlay and "ON" or "OFF")
03942 [GPT-5-CODEX-MAX-REASONING]             local resText = "RES: " .. (LOW_RES_MODE == "fast" and "FAST" or "QUALITY")
03943 [GPT-5-CODEX-MAX-REASONING]             local minimapText = "MINIMAP: " .. (SHOW_MINIMAP and "ON" or "OFF")
03944 [GPT-5-CODEX-MAX-REASONING]             local renderLabel = "CLASSIC"
03945 [GPT-5-CODEX-MAX-REASONING]             if RENDERER_MODE == "exp_hybrid" then
03946 [GPT-5-CODEX-MAX-REASONING]                 renderLabel = "EXP-H"
03947 [GPT-5-CODEX-MAX-REASONING]             elseif RENDERER_MODE == "exp_pure" then
03948 [GPT-5-CODEX-MAX-REASONING]                 renderLabel = "EXP-P"
03949 [GPT-5-CODEX-MAX-REASONING]             end
03950 [GPT-5-CODEX-MAX-REASONING]             local renderText = "RENDER: " .. renderLabel
03951 [GPT-5-CODEX-MAX-REASONING]             local optItems = {soundText, healthText, enemiesText, propsText, texturesText, fpsText, resText, minimapText, renderText, "BACK"}
03952 [GPT-5-CODEX-MAX-REASONING]             for i, item in ipairs(optItems) do
03953 [GPT-5-CODEX-MAX-REASONING]                 local y = 70 + (i - 1) * 15
03954 [GPT-5-CODEX-MAX-REASONING]                 local bgColor = COLOR_DARK_GRAY
03955 [GPT-5-CODEX-MAX-REASONING]                 local textColor = COLOR_GRAY
03956 [GPT-5-CODEX-MAX-REASONING]                 if i == optionsSelection then
03957 [GPT-5-CODEX-MAX-REASONING]                     vmupro.graphics.drawFillRect(50, y, 190, y + 14, COLOR_MAROON)
03958 [GPT-5-CODEX-MAX-REASONING]                     bgColor = COLOR_MAROON
03959 [GPT-5-CODEX-MAX-REASONING]                     textColor = COLOR_WHITE
03960 [GPT-5-CODEX-MAX-REASONING]                 end
03961 [GPT-5-CODEX-MAX-REASONING]                 vmupro.text.setFont(vmupro.text.FONT_SMALL)
03962 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawText(item, 56, y + 1, textColor, bgColor)
03963 [GPT-5-CODEX-MAX-REASONING]             end
03964 [GPT-5-CODEX-MAX-REASONING]         else
03965 [GPT-5-CODEX-MAX-REASONING]             -- Main pause menu
03966 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(50, 60, 190, 225, COLOR_BLACK)
03967 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(55, 65, 185, 220, COLOR_DARK_GRAY)
03968 [GPT-5-CODEX-MAX-REASONING]             -- Title bar
03969 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(60, 70, 180, 92, COLOR_MAROON)
03970 [GPT-5-CODEX-MAX-REASONING]             vmupro.text.setFont(vmupro.text.FONT_SMALL)
03971 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawText("PAUSED", 88, 75, COLOR_WHITE, COLOR_MAROON)
03972 [GPT-5-CODEX-MAX-REASONING]             -- Menu items
03973 [GPT-5-CODEX-MAX-REASONING]             local items = {"RESUME", "OPTIONS", "RESTART", "MENU", "QUIT"}
03974 [GPT-5-CODEX-MAX-REASONING]             for i, item in ipairs(items) do
03975 [GPT-5-CODEX-MAX-REASONING]                 local y = 95 + (i - 1) * 20
03976 [GPT-5-CODEX-MAX-REASONING]                 local bgColor = COLOR_DARK_GRAY
03977 [GPT-5-CODEX-MAX-REASONING]                 local textColor = COLOR_GRAY
03978 [GPT-5-CODEX-MAX-REASONING]                 if i == menuSelection then
03979 [GPT-5-CODEX-MAX-REASONING]                     vmupro.graphics.drawFillRect(60, y, 180, y + 18, COLOR_MAROON)
03980 [GPT-5-CODEX-MAX-REASONING]                     bgColor = COLOR_MAROON
03981 [GPT-5-CODEX-MAX-REASONING]                     textColor = COLOR_WHITE
03982 [GPT-5-CODEX-MAX-REASONING]                 end
03983 [GPT-5-CODEX-MAX-REASONING]                 vmupro.text.setFont(vmupro.text.FONT_SMALL)
03984 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawText(item, 80, y + 2, textColor, bgColor)
03985 [GPT-5-CODEX-MAX-REASONING]             end
03986 [GPT-5-CODEX-MAX-REASONING]         end
03987 [GPT-5-CODEX-MAX-REASONING]     end
03988 [GPT-5-CODEX-MAX-REASONING] 
03989 [GPT-5-CODEX-MAX-REASONING]     -- Draw health UI (potion with liquid)
03990 [GPT-5-CODEX-MAX-REASONING]     drawHealthUI()
03991 [GPT-5-CODEX-MAX-REASONING] 
03992 [GPT-5-CODEX-MAX-REASONING]     -- Draw current level indicator
03993 [GPT-5-CODEX-MAX-REASONING]                 vmupro.text.setFont(vmupro.text.FONT_SMALL)
03994 [GPT-5-CODEX-MAX-REASONING]                 vmupro.graphics.drawText(getLevelLabel(currentLevel), 6, 228, COLOR_WHITE, COLOR_BLACK)
03995 [GPT-5-CODEX-MAX-REASONING]                 if showFpsOverlay and lastFps and lastFps > 0 then
03996 [GPT-5-CODEX-MAX-REASONING]                     local fpsText = string.format("FPS %.1f", lastFps)
03997 [GPT-5-CODEX-MAX-REASONING]                     vmupro.graphics.drawText(fpsText, 6, 214, COLOR_WHITE, COLOR_BLACK)
03998 [GPT-5-CODEX-MAX-REASONING]                 end
03999 [GPT-5-CODEX-MAX-REASONING] 
04000 [GPT-5-CODEX-MAX-REASONING]     if levelBannerTimer > 0 then
04001 [GPT-5-CODEX-MAX-REASONING]                     local bannerText = "LEVEL " .. getLevelLabel(currentLevel)
04002 [GPT-5-CODEX-MAX-REASONING]         local textColor = COLOR_WHITE
04003 [GPT-5-CODEX-MAX-REASONING]         if levelBannerTimer < 50 then
04004 [GPT-5-CODEX-MAX-REASONING]             textColor = COLOR_DARK_GRAY
04005 [GPT-5-CODEX-MAX-REASONING]         elseif levelBannerTimer < 100 then
04006 [GPT-5-CODEX-MAX-REASONING]             textColor = COLOR_LIGHT_GRAY
04007 [GPT-5-CODEX-MAX-REASONING]         end
04008 [GPT-5-CODEX-MAX-REASONING]         vmupro.text.setFont(vmupro.text.FONT_SMALL)
04009 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(bannerText, 170, 5, textColor, COLOR_BLACK)
04010 [GPT-5-CODEX-MAX-REASONING]     end
04011 [GPT-5-CODEX-MAX-REASONING] 
04012 [GPT-5-CODEX-MAX-REASONING]     -- Draw game over screen if player died
04013 [GPT-5-CODEX-MAX-REASONING]     if gameState == STATE_GAME_OVER then
04014 [GPT-5-CODEX-MAX-REASONING]         drawGameOver()
04015 [GPT-5-CODEX-MAX-REASONING]     end
04016 [GPT-5-CODEX-MAX-REASONING] 
04017 [GPT-5-CODEX-MAX-REASONING]     -- Draw win screen if player won
04018 [GPT-5-CODEX-MAX-REASONING]     if gameState == STATE_WIN then
04019 [GPT-5-CODEX-MAX-REASONING]         drawWinScreen()
04020 [GPT-5-CODEX-MAX-REASONING]     end
04021 [GPT-5-CODEX-MAX-REASONING] 
04022 [GPT-5-CODEX-MAX-REASONING]     drawBmpProbeOverlay()
04023 [GPT-5-CODEX-MAX-REASONING] end
04024 [GPT-5-CODEX-MAX-REASONING] 
04025 [GPT-5-CODEX-MAX-REASONING] 
04026 [GPT-5-CODEX-MAX-REASONING] function AppMain()
04027 [GPT-5-CODEX-MAX-REASONING]     if vmupro.system and vmupro.system.setLogLevel then
04028 [GPT-5-CODEX-MAX-REASONING]         vmupro.system.setLogLevel(vmupro.system.LOG_DEBUG)
04029 [GPT-5-CODEX-MAX-REASONING]     end
04030 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "A AppMain enter")
04031 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen local=" .. tostring(drawTitleScreen))
04032 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen global=" .. tostring(_G and _G.drawTitleScreen))
04033 [GPT-5-CODEX-MAX-REASONING]     if drawTitleScreenImpl then
04034 [GPT-5-CODEX-MAX-REASONING]         drawTitleScreen = drawTitleScreenImpl
04035 [GPT-5-CODEX-MAX-REASONING]         logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen rebound in AppMain")
04036 [GPT-5-CODEX-MAX-REASONING]     end
04037 [GPT-5-CODEX-MAX-REASONING]     enterTitle()
04038 [GPT-5-CODEX-MAX-REASONING]     logBoot(vmupro.system.LOG_ERROR, "B enterTitle done")
04039 [GPT-5-CODEX-MAX-REASONING]     local bootLoopLogged = false
04040 [GPT-5-CODEX-MAX-REASONING]     local bootLogEvery = 300
04041 [GPT-5-CODEX-MAX-REASONING]     local fpsWindowStartUs = (vmupro.system and vmupro.system.getTimeUs and vmupro.system.getTimeUs()) or 0
04042 [GPT-5-CODEX-MAX-REASONING]     local fpsFrames = 0
04043 [GPT-5-CODEX-MAX-REASONING] 
04044 [GPT-5-CODEX-MAX-REASONING]     local targetFrameUs = 33333
04045 [GPT-5-CODEX-MAX-REASONING]     while app_running do
04046 [GPT-5-CODEX-MAX-REASONING]         local frameStartUs = (vmupro.system and vmupro.system.getTimeUs and vmupro.system.getTimeUs()) or 0
04047 [GPT-5-CODEX-MAX-REASONING]         if not bootLoopLogged then
04048 [GPT-5-CODEX-MAX-REASONING]             bootLoopLogged = true
04049 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B1 loop start")
04050 [GPT-5-CODEX-MAX-REASONING]         end
04051 [GPT-5-CODEX-MAX-REASONING]         vmupro.input.read()
04052 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs and gameState == STATE_TITLE and bootLoopLogged and (frameCount % bootLogEvery == 0) then
04053 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B2 after input.read")
04054 [GPT-5-CODEX-MAX-REASONING]         end
04055 [GPT-5-CODEX-MAX-REASONING]         frameCount = frameCount + 1
04056 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
04057 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B2.1 after frameCount")
04058 [GPT-5-CODEX-MAX-REASONING]         end
04059 [GPT-5-CODEX-MAX-REASONING]         fpsFrames = fpsFrames + 1
04060 [GPT-5-CODEX-MAX-REASONING]         if gameState == STATE_PLAYING and (frameCount % 120) == 0 then
04061 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, string.format("LIFE state=%d px=%.2f py=%.2f", gameState, px or -1, py or -1))
04062 [GPT-5-CODEX-MAX-REASONING]         end
04063 [GPT-5-CODEX-MAX-REASONING]         if vmupro.system and vmupro.system.getTimeUs then
04064 [GPT-5-CODEX-MAX-REASONING]             local nowUs = vmupro.system.getTimeUs()
04065 [GPT-5-CODEX-MAX-REASONING]             if fpsWindowStartUs == 0 then
04066 [GPT-5-CODEX-MAX-REASONING]                 fpsWindowStartUs = nowUs
04067 [GPT-5-CODEX-MAX-REASONING]                 fpsFrames = 0
04068 [GPT-5-CODEX-MAX-REASONING]             elseif (nowUs - fpsWindowStartUs) >= 1000000 then
04069 [GPT-5-CODEX-MAX-REASONING]                 local elapsed = nowUs - fpsWindowStartUs
04070 [GPT-5-CODEX-MAX-REASONING]                 local fps = (fpsFrames * 1000000) / elapsed
04071 [GPT-5-CODEX-MAX-REASONING]                 lastFps = fps
04072 [GPT-5-CODEX-MAX-REASONING]                 logPerf(string.format("FPS %.1f", fps))
04073 [GPT-5-CODEX-MAX-REASONING]                 fpsWindowStartUs = nowUs
04074 [GPT-5-CODEX-MAX-REASONING]                 fpsFrames = 0
04075 [GPT-5-CODEX-MAX-REASONING]             end
04076 [GPT-5-CODEX-MAX-REASONING]         end
04077 [GPT-5-CODEX-MAX-REASONING] 
04078 [GPT-5-CODEX-MAX-REASONING] 
04079 [GPT-5-CODEX-MAX-REASONING]         -- Update audio
04080 [GPT-5-CODEX-MAX-REASONING]         if audioSystemActive then
04081 [GPT-5-CODEX-MAX-REASONING]             vmupro.sound.update()
04082 [GPT-5-CODEX-MAX-REASONING]         end
04083 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
04084 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B2.2 after audio update")
04085 [GPT-5-CODEX-MAX-REASONING]         end
04086 [GPT-5-CODEX-MAX-REASONING] 
04087 [GPT-5-CODEX-MAX-REASONING]         if gameState == STATE_TITLE then
04088 [GPT-5-CODEX-MAX-REASONING]             updateTitleMusic()
04089 [GPT-5-CODEX-MAX-REASONING]         end
04090 [GPT-5-CODEX-MAX-REASONING] 
04091 [GPT-5-CODEX-MAX-REASONING]         -- Only run game logic when playing (not on title screen)
04092 [GPT-5-CODEX-MAX-REASONING]             if gameState == STATE_PLAYING then
04093 [GPT-5-CODEX-MAX-REASONING]             if levelBannerTimer > 0 then
04094 [GPT-5-CODEX-MAX-REASONING]                 levelBannerTimer = levelBannerTimer - 1
04095 [GPT-5-CODEX-MAX-REASONING]             end
04096 [GPT-5-CODEX-MAX-REASONING]             -- Decrement attack animation
04097 [GPT-5-CODEX-MAX-REASONING]             if isAttacking > 0 then
04098 [GPT-5-CODEX-MAX-REASONING]                 isAttacking = isAttacking - 1
04099 [GPT-5-CODEX-MAX-REASONING]             end
04100 [GPT-5-CODEX-MAX-REASONING] 
04101 [GPT-5-CODEX-MAX-REASONING]             -- Update soldier positions and animations
04102 [GPT-5-CODEX-MAX-REASONING]             updateSoldiers()
04103 [GPT-5-CODEX-MAX-REASONING] 
04104 [GPT-5-CODEX-MAX-REASONING]             -- Update death animations regardless of effects toggle
04105 [GPT-5-CODEX-MAX-REASONING]             updateDeathAnimations()
04106 [GPT-5-CODEX-MAX-REASONING]             if not DEBUG_DISABLE_EFFECTS then
04107 [GPT-5-CODEX-MAX-REASONING]                 -- Update blood effects
04108 [GPT-5-CODEX-MAX-REASONING]                 updateBloodEffects()
04109 [GPT-5-CODEX-MAX-REASONING]             end
04110 [GPT-5-CODEX-MAX-REASONING] 
04111 [GPT-5-CODEX-MAX-REASONING]             -- Check for health pickups
04112 [GPT-5-CODEX-MAX-REASONING]             checkHealthPickups()
04113 [GPT-5-CODEX-MAX-REASONING]         end
04114 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
04115 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B2.3 after playing block")
04116 [GPT-5-CODEX-MAX-REASONING]         end
04117 [GPT-5-CODEX-MAX-REASONING] 
04118 [GPT-5-CODEX-MAX-REASONING]         if gameState == STATE_LOADING then
04119 [GPT-5-CODEX-MAX-REASONING]             loadingTimer = loadingTimer - 1
04120 [GPT-5-CODEX-MAX-REASONING]             if loadingTimer <= 0 then
04121 [GPT-5-CODEX-MAX-REASONING]                 if pendingLevelStart then
04122 [GPT-5-CODEX-MAX-REASONING]                     startLevel(pendingLevelStart)
04123 [GPT-5-CODEX-MAX-REASONING]                     pendingLevelStart = nil
04124 [GPT-5-CODEX-MAX-REASONING]                 else
04125 [GPT-5-CODEX-MAX-REASONING]                     gameState = STATE_TITLE
04126 [GPT-5-CODEX-MAX-REASONING]                 end
04127 [GPT-5-CODEX-MAX-REASONING]             end
04128 [GPT-5-CODEX-MAX-REASONING]         end
04129 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
04130 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B2.4 after loading block")
04131 [GPT-5-CODEX-MAX-REASONING]         end
04132 [GPT-5-CODEX-MAX-REASONING] 
04133 [GPT-5-CODEX-MAX-REASONING]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
04134 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B2.5 before title/menu pcall")
04135 [GPT-5-CODEX-MAX-REASONING]         end
04136 [GPT-5-CODEX-MAX-REASONING]         local okTitle, errTitle = pcall(function()
04137 [GPT-5-CODEX-MAX-REASONING]             if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
04138 [GPT-5-CODEX-MAX-REASONING]                 logBoot(vmupro.system.LOG_ERROR, "B2.6 inside title/menu pcall")
04139 [GPT-5-CODEX-MAX-REASONING]             end
04140 [GPT-5-CODEX-MAX-REASONING]             -- Title screen handling
04141 [GPT-5-CODEX-MAX-REASONING]             if gameState == STATE_TITLE then
04142 [GPT-5-CODEX-MAX-REASONING]                 local prevTitleSelection = titleSelection
04143 [GPT-5-CODEX-MAX-REASONING]                 local prevTitleInOptions = titleInOptions
04144 [GPT-5-CODEX-MAX-REASONING]                 local prevTitleOptionsSelection = titleOptionsSelection
04145 [GPT-5-CODEX-MAX-REASONING]                 local prevTitleDebugSelection = titleDebugSelection
04146 [GPT-5-CODEX-MAX-REASONING]                 local prevSelectedLevel = selectedLevel
04147 [GPT-5-CODEX-MAX-REASONING]                 local prevSoundEnabled = soundEnabled
04148 [GPT-5-CODEX-MAX-REASONING]                 local prevShowHealthPercent = showHealthPercent
04149 [GPT-5-CODEX-MAX-REASONING]                 local prevEnableBootLogs = enableBootLogs
04150 [GPT-5-CODEX-MAX-REASONING]                 local prevDisableEnemies = DEBUG_DISABLE_ENEMIES
04151 [GPT-5-CODEX-MAX-REASONING]                 local prevDisableTextures = DEBUG_DISABLE_WALL_TEXTURE
04152 [GPT-5-CODEX-MAX-REASONING]                 local prevDisableProps = DEBUG_DISABLE_PROPS
04153 [GPT-5-CODEX-MAX-REASONING]                 local prevShowFpsOverlay = showFpsOverlay
04154 [GPT-5-CODEX-MAX-REASONING]                 local prevLowResMode = LOW_RES_MODE
04155 [GPT-5-CODEX-MAX-REASONING]                 local prevShowMinimap = SHOW_MINIMAP
04156 [GPT-5-CODEX-MAX-REASONING]                 local prevRendererMode = RENDERER_MODE
04157 [GPT-5-CODEX-MAX-REASONING]                 if titleInOptions then
04158 [GPT-5-CODEX-MAX-REASONING]                     if titleInDebug then
04159 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.UP) then
04160 [GPT-5-CODEX-MAX-REASONING]                             titleDebugSelection = titleDebugSelection - 1
04161 [GPT-5-CODEX-MAX-REASONING]                         if titleDebugSelection < 1 then titleDebugSelection = 10 end
04162 [GPT-5-CODEX-MAX-REASONING]                         end
04163 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.DOWN) then
04164 [GPT-5-CODEX-MAX-REASONING]                             titleDebugSelection = titleDebugSelection + 1
04165 [GPT-5-CODEX-MAX-REASONING]                         if titleDebugSelection > 10 then titleDebugSelection = 1 end
04166 [GPT-5-CODEX-MAX-REASONING]                         end
04167 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
04168 [GPT-5-CODEX-MAX-REASONING]                             if titleDebugSelection == 1 then
04169 [GPT-5-CODEX-MAX-REASONING]                                 enableBootLogs = not enableBootLogs
04170 [GPT-5-CODEX-MAX-REASONING]                                 DEBUG_WALL_QUADS_LOG = enableBootLogs
04171 [GPT-5-CODEX-MAX-REASONING]                                 if enableBootLogs then
04172 [GPT-5-CODEX-MAX-REASONING]                                     wallQuadLogCount = 0
04173 [GPT-5-CODEX-MAX-REASONING]                                 end
04174 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 2 then
04175 [GPT-5-CODEX-MAX-REASONING]                                 DEBUG_DISABLE_ENEMIES = not DEBUG_DISABLE_ENEMIES
04176 [GPT-5-CODEX-MAX-REASONING]                                 spriteOrderCache = {}
04177 [GPT-5-CODEX-MAX-REASONING]                                 spriteOrderCacheFrame = -999
04178 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 3 then
04179 [GPT-5-CODEX-MAX-REASONING]                                 DEBUG_DISABLE_PROPS = not DEBUG_DISABLE_PROPS
04180 [GPT-5-CODEX-MAX-REASONING]                                 spriteOrderCache = {}
04181 [GPT-5-CODEX-MAX-REASONING]                                 spriteOrderCacheFrame = -999
04182 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 4 then
04183 [GPT-5-CODEX-MAX-REASONING]                                 DEBUG_DISABLE_WALL_TEXTURE = not DEBUG_DISABLE_WALL_TEXTURE
04184 [GPT-5-CODEX-MAX-REASONING]                                 if DEBUG_DISABLE_WALL_TEXTURE then
04185 [GPT-5-CODEX-MAX-REASONING]                                     unloadWallTextures()
04186 [GPT-5-CODEX-MAX-REASONING]                                 else
04187 [GPT-5-CODEX-MAX-REASONING]                                     loadWallTextures()
04188 [GPT-5-CODEX-MAX-REASONING]                                 end
04189 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 5 then
04190 [GPT-5-CODEX-MAX-REASONING]                                 showFpsOverlay = not showFpsOverlay
04191 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 6 then
04192 [GPT-5-CODEX-MAX-REASONING]                                 if LOW_RES_MODE == "fast" then
04193 [GPT-5-CODEX-MAX-REASONING]                                     LOW_RES_MODE = "quality"
04194 [GPT-5-CODEX-MAX-REASONING]                                 else
04195 [GPT-5-CODEX-MAX-REASONING]                                     LOW_RES_MODE = "fast"
04196 [GPT-5-CODEX-MAX-REASONING]                                 end
04197 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 7 then
04198 [GPT-5-CODEX-MAX-REASONING]                                 SHOW_MINIMAP = not SHOW_MINIMAP
04199 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 8 then
04200 [GPT-5-CODEX-MAX-REASONING]                                 if RENDERER_MODE == "classic" then
04201 [GPT-5-CODEX-MAX-REASONING]                                     RENDERER_MODE = "exp_hybrid"
04202 [GPT-5-CODEX-MAX-REASONING]                                 elseif RENDERER_MODE == "exp_hybrid" then
04203 [GPT-5-CODEX-MAX-REASONING]                                     RENDERER_MODE = "exp_pure"
04204 [GPT-5-CODEX-MAX-REASONING]                                 else
04205 [GPT-5-CODEX-MAX-REASONING]                                     RENDERER_MODE = "classic"
04206 [GPT-5-CODEX-MAX-REASONING]                                 end
04207 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 9 then
04208 [GPT-5-CODEX-MAX-REASONING]                                 if FPS_TARGET_MODE == "uncapped" then
04209 [GPT-5-CODEX-MAX-REASONING]                                     FPS_TARGET_MODE = "60"
04210 [GPT-5-CODEX-MAX-REASONING]                                 elseif FPS_TARGET_MODE == "60" then
04211 [GPT-5-CODEX-MAX-REASONING]                                     FPS_TARGET_MODE = "30"
04212 [GPT-5-CODEX-MAX-REASONING]                                 else
04213 [GPT-5-CODEX-MAX-REASONING]                                     FPS_TARGET_MODE = "uncapped"
04214 [GPT-5-CODEX-MAX-REASONING]                                 end
04215 [GPT-5-CODEX-MAX-REASONING]                             elseif titleDebugSelection == 10 then
04216 [GPT-5-CODEX-MAX-REASONING]                                 titleInDebug = false
04217 [GPT-5-CODEX-MAX-REASONING]                                 titleNeedsRedraw = true
04218 [GPT-5-CODEX-MAX-REASONING]                             end
04219 [GPT-5-CODEX-MAX-REASONING]                         end
04220 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.B) or vmupro.input.pressed(vmupro.input.POWER) then
04221 [GPT-5-CODEX-MAX-REASONING]                             titleInDebug = false
04222 [GPT-5-CODEX-MAX-REASONING]                             titleNeedsRedraw = true
04223 [GPT-5-CODEX-MAX-REASONING]                         end
04224 [GPT-5-CODEX-MAX-REASONING]                     else
04225 [GPT-5-CODEX-MAX-REASONING]                         -- Title options submenu
04226 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.UP) then
04227 [GPT-5-CODEX-MAX-REASONING]                             titleOptionsSelection = titleOptionsSelection - 1
04228 [GPT-5-CODEX-MAX-REASONING]                             if titleOptionsSelection < 1 then titleOptionsSelection = 6 end
04229 [GPT-5-CODEX-MAX-REASONING]                         end
04230 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.DOWN) then
04231 [GPT-5-CODEX-MAX-REASONING]                             titleOptionsSelection = titleOptionsSelection + 1
04232 [GPT-5-CODEX-MAX-REASONING]                             if titleOptionsSelection > 6 then titleOptionsSelection = 1 end
04233 [GPT-5-CODEX-MAX-REASONING]                         end
04234 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
04235 [GPT-5-CODEX-MAX-REASONING]                             if titleOptionsSelection == 1 then
04236 [GPT-5-CODEX-MAX-REASONING]                                 selectedLevel = selectedLevel + 1
04237 [GPT-5-CODEX-MAX-REASONING]                                 if selectedLevel > LEVEL_SELECT_COUNT then selectedLevel = 1 end
04238 [GPT-5-CODEX-MAX-REASONING]                             elseif titleOptionsSelection == 2 then
04239 [GPT-5-CODEX-MAX-REASONING]                                 soundEnabled = not soundEnabled
04240 [GPT-5-CODEX-MAX-REASONING]                                 if soundEnabled then
04241 [GPT-5-CODEX-MAX-REASONING]                                     startTitleMusic()
04242 [GPT-5-CODEX-MAX-REASONING]                                 else
04243 [GPT-5-CODEX-MAX-REASONING]                                     stopTitleMusic()
04244 [GPT-5-CODEX-MAX-REASONING]                                 end
04245 [GPT-5-CODEX-MAX-REASONING]                             elseif titleOptionsSelection == 3 then
04246 [GPT-5-CODEX-MAX-REASONING]                                 showHealthPercent = not showHealthPercent
04247 [GPT-5-CODEX-MAX-REASONING]                             elseif titleOptionsSelection == 4 then
04248 [GPT-5-CODEX-MAX-REASONING]                                 if RENDERER_MODE == "classic" then
04249 [GPT-5-CODEX-MAX-REASONING]                                     RENDERER_MODE = "exp_hybrid"
04250 [GPT-5-CODEX-MAX-REASONING]                                 elseif RENDERER_MODE == "exp_hybrid" then
04251 [GPT-5-CODEX-MAX-REASONING]                                     RENDERER_MODE = "exp_pure"
04252 [GPT-5-CODEX-MAX-REASONING]                                 else
04253 [GPT-5-CODEX-MAX-REASONING]                                     RENDERER_MODE = "classic"
04254 [GPT-5-CODEX-MAX-REASONING]                                 end
04255 [GPT-5-CODEX-MAX-REASONING]                             elseif titleOptionsSelection == 5 then
04256 [GPT-5-CODEX-MAX-REASONING]                                 titleInDebug = true
04257 [GPT-5-CODEX-MAX-REASONING]                                 titleDebugSelection = 1
04258 [GPT-5-CODEX-MAX-REASONING]                                 titleNeedsRedraw = true
04259 [GPT-5-CODEX-MAX-REASONING]                             elseif titleOptionsSelection == 6 then
04260 [GPT-5-CODEX-MAX-REASONING]                                 titleInOptions = false  -- Back
04261 [GPT-5-CODEX-MAX-REASONING]                                 titleNeedsRedraw = true
04262 [GPT-5-CODEX-MAX-REASONING]                             end
04263 [GPT-5-CODEX-MAX-REASONING]                         end
04264 [GPT-5-CODEX-MAX-REASONING]                         if vmupro.input.pressed(vmupro.input.B) or vmupro.input.pressed(vmupro.input.POWER) then
04265 [GPT-5-CODEX-MAX-REASONING]                             titleInOptions = false
04266 [GPT-5-CODEX-MAX-REASONING]                             titleNeedsRedraw = true
04267 [GPT-5-CODEX-MAX-REASONING]                         end
04268 [GPT-5-CODEX-MAX-REASONING]                     end
04269 [GPT-5-CODEX-MAX-REASONING]                 else
04270 [GPT-5-CODEX-MAX-REASONING]                     -- Title main menu
04271 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.UP) then
04272 [GPT-5-CODEX-MAX-REASONING]                         titleSelection = titleSelection - 1
04273 [GPT-5-CODEX-MAX-REASONING]                         if titleSelection < 1 then titleSelection = 3 end
04274 [GPT-5-CODEX-MAX-REASONING]                     end
04275 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.DOWN) then
04276 [GPT-5-CODEX-MAX-REASONING]                         titleSelection = titleSelection + 1
04277 [GPT-5-CODEX-MAX-REASONING]                         if titleSelection > 3 then titleSelection = 1 end
04278 [GPT-5-CODEX-MAX-REASONING]                     end
04279 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
04280 [GPT-5-CODEX-MAX-REASONING]                         if titleSelection == 1 then
04281 [GPT-5-CODEX-MAX-REASONING]                             -- Start game
04282 [GPT-5-CODEX-MAX-REASONING]                             local selectedEntry = LEVEL_SELECT_LIST[selectedLevel]
04283 [GPT-5-CODEX-MAX-REASONING]                             if selectedEntry then
04284 [GPT-5-CODEX-MAX-REASONING]                                 beginLoadLevel(selectedEntry.id)
04285 [GPT-5-CODEX-MAX-REASONING]                             end
04286 [GPT-5-CODEX-MAX-REASONING]                         elseif titleSelection == 2 then
04287 [GPT-5-CODEX-MAX-REASONING]                             -- Options
04288 [GPT-5-CODEX-MAX-REASONING]                             titleInOptions = true
04289 [GPT-5-CODEX-MAX-REASONING]                             titleOptionsSelection = 1
04290 [GPT-5-CODEX-MAX-REASONING]                         elseif titleSelection == 3 then
04291 [GPT-5-CODEX-MAX-REASONING]                             -- Exit
04292 [GPT-5-CODEX-MAX-REASONING]                             quitApp("title exit")
04293 [GPT-5-CODEX-MAX-REASONING]                         end
04294 [GPT-5-CODEX-MAX-REASONING]                     end
04295 [GPT-5-CODEX-MAX-REASONING]                 end
04296 [GPT-5-CODEX-MAX-REASONING]                 if prevTitleSelection ~= titleSelection
04297 [GPT-5-CODEX-MAX-REASONING]                     or prevTitleInOptions ~= titleInOptions
04298 [GPT-5-CODEX-MAX-REASONING]                     or prevTitleOptionsSelection ~= titleOptionsSelection
04299 [GPT-5-CODEX-MAX-REASONING]                     or prevTitleDebugSelection ~= titleDebugSelection
04300 [GPT-5-CODEX-MAX-REASONING]                     or prevSelectedLevel ~= selectedLevel
04301 [GPT-5-CODEX-MAX-REASONING]                     or prevSoundEnabled ~= soundEnabled
04302 [GPT-5-CODEX-MAX-REASONING]                     or prevShowHealthPercent ~= showHealthPercent
04303 [GPT-5-CODEX-MAX-REASONING]                     or prevEnableBootLogs ~= enableBootLogs
04304 [GPT-5-CODEX-MAX-REASONING]                     or prevDisableEnemies ~= DEBUG_DISABLE_ENEMIES
04305 [GPT-5-CODEX-MAX-REASONING]                     or prevDisableTextures ~= DEBUG_DISABLE_WALL_TEXTURE
04306 [GPT-5-CODEX-MAX-REASONING]                     or prevDisableProps ~= DEBUG_DISABLE_PROPS
04307 [GPT-5-CODEX-MAX-REASONING]                     or prevShowFpsOverlay ~= showFpsOverlay
04308 [GPT-5-CODEX-MAX-REASONING]                     or prevLowResMode ~= LOW_RES_MODE
04309 [GPT-5-CODEX-MAX-REASONING]                     or prevShowMinimap ~= SHOW_MINIMAP
04310 [GPT-5-CODEX-MAX-REASONING]                     or prevRendererMode ~= RENDERER_MODE then
04311 [GPT-5-CODEX-MAX-REASONING]                     titleNeedsRedraw = true
04312 [GPT-5-CODEX-MAX-REASONING]                 end
04313 [GPT-5-CODEX-MAX-REASONING]             -- Game over handling
04314 [GPT-5-CODEX-MAX-REASONING]             elseif gameState == STATE_GAME_OVER then
04315 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.input.pressed(vmupro.input.UP) then
04316 [GPT-5-CODEX-MAX-REASONING]                     gameOverSelection = gameOverSelection - 1
04317 [GPT-5-CODEX-MAX-REASONING]                     if gameOverSelection < 1 then gameOverSelection = 3 end
04318 [GPT-5-CODEX-MAX-REASONING]                 end
04319 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.input.pressed(vmupro.input.DOWN) then
04320 [GPT-5-CODEX-MAX-REASONING]                     gameOverSelection = gameOverSelection + 1
04321 [GPT-5-CODEX-MAX-REASONING]                     if gameOverSelection > 3 then gameOverSelection = 1 end
04322 [GPT-5-CODEX-MAX-REASONING]                 end
04323 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.input.pressed(vmupro.input.A) or vmupro.input.pressed(vmupro.input.MODE) then
04324 [GPT-5-CODEX-MAX-REASONING]                     if gameOverSelection == 1 then
04325 [GPT-5-CODEX-MAX-REASONING]                         beginLoadLevel(currentLevel)  -- Restart
04326 [GPT-5-CODEX-MAX-REASONING]                     elseif gameOverSelection == 2 then
04327 [GPT-5-CODEX-MAX-REASONING]                         -- Return to title menu
04328 [GPT-5-CODEX-MAX-REASONING]                         enterTitle()
04329 [GPT-5-CODEX-MAX-REASONING]                         gameOverSelection = 1
04330 [GPT-5-CODEX-MAX-REASONING]                     else
04331 [GPT-5-CODEX-MAX-REASONING]                         quitApp("pause quit")  -- Quit
04332 [GPT-5-CODEX-MAX-REASONING]                     end
04333 [GPT-5-CODEX-MAX-REASONING]                 end
04334 [GPT-5-CODEX-MAX-REASONING]             -- Win screen handling
04335 [GPT-5-CODEX-MAX-REASONING]             elseif gameState == STATE_WIN then
04336 [GPT-5-CODEX-MAX-REASONING]                 if winBannerTimer > 0 then
04337 [GPT-5-CODEX-MAX-REASONING]                     winBannerTimer = winBannerTimer - 1
04338 [GPT-5-CODEX-MAX-REASONING]                 end
04339 [GPT-5-CODEX-MAX-REASONING]                 if winCooldown > 0 then
04340 [GPT-5-CODEX-MAX-REASONING]                     winCooldown = winCooldown - 1
04341 [GPT-5-CODEX-MAX-REASONING]                 elseif vmupro.input.pressed(vmupro.input.A) then
04342 [GPT-5-CODEX-MAX-REASONING]                     -- Advance to next level if available, otherwise return to title menu
04343 [GPT-5-CODEX-MAX-REASONING]                     if currentLevel < MAX_LEVEL then
04344 [GPT-5-CODEX-MAX-REASONING]                         beginLoadLevel(currentLevel + 1)
04345 [GPT-5-CODEX-MAX-REASONING]                     else
04346 [GPT-5-CODEX-MAX-REASONING]                         enterTitle()
04347 [GPT-5-CODEX-MAX-REASONING]                     end
04348 [GPT-5-CODEX-MAX-REASONING]                 end
04349 [GPT-5-CODEX-MAX-REASONING]             -- Menu handling
04350 [GPT-5-CODEX-MAX-REASONING]             elseif showMenu then
04351 [GPT-5-CODEX-MAX-REASONING]                 if inOptionsMenu then
04352 [GPT-5-CODEX-MAX-REASONING]                     -- Options submenu
04353 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.UP) then
04354 [GPT-5-CODEX-MAX-REASONING]                         optionsSelection = optionsSelection - 1
04355 [GPT-5-CODEX-MAX-REASONING]                         if optionsSelection < 1 then optionsSelection = 10 end
04356 [GPT-5-CODEX-MAX-REASONING]                     end
04357 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.DOWN) then
04358 [GPT-5-CODEX-MAX-REASONING]                         optionsSelection = optionsSelection + 1
04359 [GPT-5-CODEX-MAX-REASONING]                         if optionsSelection > 10 then optionsSelection = 1 end
04360 [GPT-5-CODEX-MAX-REASONING]                     end
04361 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
04362 [GPT-5-CODEX-MAX-REASONING]                         if optionsSelection == 1 then
04363 [GPT-5-CODEX-MAX-REASONING]                             soundEnabled = not soundEnabled  -- Toggle sound
04364 [GPT-5-CODEX-MAX-REASONING]                             if soundEnabled then
04365 [GPT-5-CODEX-MAX-REASONING]                                 startTitleMusic()
04366 [GPT-5-CODEX-MAX-REASONING]                             else
04367 [GPT-5-CODEX-MAX-REASONING]                                 stopTitleMusic()
04368 [GPT-5-CODEX-MAX-REASONING]                             end
04369 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 2 then
04370 [GPT-5-CODEX-MAX-REASONING]                             showHealthPercent = not showHealthPercent  -- Toggle health %
04371 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 3 then
04372 [GPT-5-CODEX-MAX-REASONING]                             DEBUG_DISABLE_ENEMIES = not DEBUG_DISABLE_ENEMIES
04373 [GPT-5-CODEX-MAX-REASONING]                             spriteOrderCache = {}
04374 [GPT-5-CODEX-MAX-REASONING]                             spriteOrderCacheFrame = -999
04375 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 4 then
04376 [GPT-5-CODEX-MAX-REASONING]                             DEBUG_DISABLE_PROPS = not DEBUG_DISABLE_PROPS
04377 [GPT-5-CODEX-MAX-REASONING]                             spriteOrderCache = {}
04378 [GPT-5-CODEX-MAX-REASONING]                             spriteOrderCacheFrame = -999
04379 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 5 then
04380 [GPT-5-CODEX-MAX-REASONING]                             DEBUG_DISABLE_WALL_TEXTURE = not DEBUG_DISABLE_WALL_TEXTURE
04381 [GPT-5-CODEX-MAX-REASONING]                             if DEBUG_DISABLE_WALL_TEXTURE then
04382 [GPT-5-CODEX-MAX-REASONING]                                 unloadWallTextures()
04383 [GPT-5-CODEX-MAX-REASONING]                             else
04384 [GPT-5-CODEX-MAX-REASONING]                                 loadWallTextures()
04385 [GPT-5-CODEX-MAX-REASONING]                             end
04386 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 6 then
04387 [GPT-5-CODEX-MAX-REASONING]                             showFpsOverlay = not showFpsOverlay
04388 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 7 then
04389 [GPT-5-CODEX-MAX-REASONING]                             if LOW_RES_MODE == "fast" then
04390 [GPT-5-CODEX-MAX-REASONING]                                 LOW_RES_MODE = "quality"
04391 [GPT-5-CODEX-MAX-REASONING]                             else
04392 [GPT-5-CODEX-MAX-REASONING]                                 LOW_RES_MODE = "fast"
04393 [GPT-5-CODEX-MAX-REASONING]                             end
04394 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 8 then
04395 [GPT-5-CODEX-MAX-REASONING]                             SHOW_MINIMAP = not SHOW_MINIMAP
04396 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 9 then
04397 [GPT-5-CODEX-MAX-REASONING]                             if RENDERER_MODE == "classic" then
04398 [GPT-5-CODEX-MAX-REASONING]                                 RENDERER_MODE = "exp_hybrid"
04399 [GPT-5-CODEX-MAX-REASONING]                             elseif RENDERER_MODE == "exp_hybrid" then
04400 [GPT-5-CODEX-MAX-REASONING]                                 RENDERER_MODE = "exp_pure"
04401 [GPT-5-CODEX-MAX-REASONING]                             else
04402 [GPT-5-CODEX-MAX-REASONING]                                 RENDERER_MODE = "classic"
04403 [GPT-5-CODEX-MAX-REASONING]                             end
04404 [GPT-5-CODEX-MAX-REASONING]                         elseif optionsSelection == 10 then
04405 [GPT-5-CODEX-MAX-REASONING]                             inOptionsMenu = false  -- Back to main menu
04406 [GPT-5-CODEX-MAX-REASONING]                         end
04407 [GPT-5-CODEX-MAX-REASONING]                     end
04408 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.POWER) or vmupro.input.pressed(vmupro.input.B) then
04409 [GPT-5-CODEX-MAX-REASONING]                         inOptionsMenu = false  -- Back to main menu
04410 [GPT-5-CODEX-MAX-REASONING]                     end
04411 [GPT-5-CODEX-MAX-REASONING]                 else
04412 [GPT-5-CODEX-MAX-REASONING]                     -- Main pause menu
04413 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.UP) then
04414 [GPT-5-CODEX-MAX-REASONING]                         menuSelection = menuSelection - 1
04415 [GPT-5-CODEX-MAX-REASONING]                         if menuSelection < 1 then menuSelection = 5 end
04416 [GPT-5-CODEX-MAX-REASONING]                     end
04417 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.DOWN) then
04418 [GPT-5-CODEX-MAX-REASONING]                         menuSelection = menuSelection + 1
04419 [GPT-5-CODEX-MAX-REASONING]                         if menuSelection > 5 then menuSelection = 1 end
04420 [GPT-5-CODEX-MAX-REASONING]                     end
04421 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
04422 [GPT-5-CODEX-MAX-REASONING]                         if menuSelection == 1 then
04423 [GPT-5-CODEX-MAX-REASONING]                             showMenu = false  -- Resume
04424 [GPT-5-CODEX-MAX-REASONING]                         elseif menuSelection == 2 then
04425 [GPT-5-CODEX-MAX-REASONING]                             inOptionsMenu = true  -- Enter options
04426 [GPT-5-CODEX-MAX-REASONING]                             optionsSelection = 1
04427 [GPT-5-CODEX-MAX-REASONING]                         elseif menuSelection == 3 then
04428 [GPT-5-CODEX-MAX-REASONING]                             -- Reset position and health
04429 [GPT-5-CODEX-MAX-REASONING]                             px, py, pdir = 2.5, 2.5, 0
04430 [GPT-5-CODEX-MAX-REASONING]                             playerHealth = MAX_HEALTH
04431 [GPT-5-CODEX-MAX-REASONING]                             showMenu = false
04432 [GPT-5-CODEX-MAX-REASONING]                         elseif menuSelection == 4 then
04433 [GPT-5-CODEX-MAX-REASONING]                             -- Return to title menu
04434 [GPT-5-CODEX-MAX-REASONING]                             showMenu = false
04435 [GPT-5-CODEX-MAX-REASONING]                             enterTitle()
04436 [GPT-5-CODEX-MAX-REASONING]                         elseif menuSelection == 5 then
04437 [GPT-5-CODEX-MAX-REASONING]                             quitApp("game over quit")  -- Quit
04438 [GPT-5-CODEX-MAX-REASONING]                         end
04439 [GPT-5-CODEX-MAX-REASONING]                     end
04440 [GPT-5-CODEX-MAX-REASONING]                     if vmupro.input.pressed(vmupro.input.POWER) then
04441 [GPT-5-CODEX-MAX-REASONING]                         showMenu = false  -- Close menu
04442 [GPT-5-CODEX-MAX-REASONING]                     end
04443 [GPT-5-CODEX-MAX-REASONING]                 end
04444 [GPT-5-CODEX-MAX-REASONING]             else
04445 [GPT-5-CODEX-MAX-REASONING]                 -- Normal gameplay controls
04446 [GPT-5-CODEX-MAX-REASONING] 
04447 [GPT-5-CODEX-MAX-REASONING]             -- LEFT/RIGHT: Turn (held for continuous turning)
04448 [GPT-5-CODEX-MAX-REASONING]             if vmupro.input.held(vmupro.input.LEFT) then
04449 [GPT-5-CODEX-MAX-REASONING]                 pdir = pdir - 1
04450 [GPT-5-CODEX-MAX-REASONING]                 if pdir < 0 then pdir = pdir + 64 end
04451 [GPT-5-CODEX-MAX-REASONING]             end
04452 [GPT-5-CODEX-MAX-REASONING]             if vmupro.input.held(vmupro.input.RIGHT) then
04453 [GPT-5-CODEX-MAX-REASONING]                 pdir = pdir + 1
04454 [GPT-5-CODEX-MAX-REASONING]                 if pdir >= 64 then pdir = pdir - 64 end
04455 [GPT-5-CODEX-MAX-REASONING]             end
04456 [GPT-5-CODEX-MAX-REASONING] 
04457 [GPT-5-CODEX-MAX-REASONING]             local idx = pdir % 64
04458 [GPT-5-CODEX-MAX-REASONING]             local dx = cosTable[idx] * 0.15
04459 [GPT-5-CODEX-MAX-REASONING]             local dy = sinTable[idx] * 0.15
04460 [GPT-5-CODEX-MAX-REASONING]             -- Strafe direction (perpendicular to facing)
04461 [GPT-5-CODEX-MAX-REASONING]             local strafe_idx = (pdir + 16) % 64  -- 90 degrees right
04462 [GPT-5-CODEX-MAX-REASONING]             local sdx = cosTable[strafe_idx] * 0.10
04463 [GPT-5-CODEX-MAX-REASONING]             local sdy = sinTable[strafe_idx] * 0.10
04464 [GPT-5-CODEX-MAX-REASONING] 
04465 [GPT-5-CODEX-MAX-REASONING]             -- Check if MODE is held (modifier key)
04466 [GPT-5-CODEX-MAX-REASONING]             local modeHeld = vmupro.input.held(vmupro.input.MODE)
04467 [GPT-5-CODEX-MAX-REASONING] 
04468 [GPT-5-CODEX-MAX-REASONING]             if modeHeld then
04469 [GPT-5-CODEX-MAX-REASONING]                 -- MODE + UP: Attack
04470 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.input.pressed(vmupro.input.UP) and isAttacking == 0 then
04471 [GPT-5-CODEX-MAX-REASONING]                     local attackFrames = #swordAttack
04472 [GPT-5-CODEX-MAX-REASONING]                     attackTotalFrames = 9
04473 [GPT-5-CODEX-MAX-REASONING]                     if attackFrames == 0 then
04474 [GPT-5-CODEX-MAX-REASONING]                         attackTotalFrames = 10
04475 [GPT-5-CODEX-MAX-REASONING]                     end
04476 [GPT-5-CODEX-MAX-REASONING]                     isAttacking = attackTotalFrames
04477 [GPT-5-CODEX-MAX-REASONING] 
04478 [GPT-5-CODEX-MAX-REASONING]                     -- Check for enemies in attack range and damage them
04479 [GPT-5-CODEX-MAX-REASONING]                     local hitSomething = false
04480 [GPT-5-CODEX-MAX-REASONING]                     for i = 1, #sprites do
04481 [GPT-5-CODEX-MAX-REASONING]                         local s = sprites[i]
04482 [GPT-5-CODEX-MAX-REASONING]                         if s.t == 5 and s.alive then
04483 [GPT-5-CODEX-MAX-REASONING]                             local dx = s.x - px
04484 [GPT-5-CODEX-MAX-REASONING]                             local dy = s.y - py
04485 [GPT-5-CODEX-MAX-REASONING]                             local dist = math.sqrt(dx * dx + dy * dy)
04486 [GPT-5-CODEX-MAX-REASONING]                             if dist < PLAYER_ATTACK_RANGE then
04487 [GPT-5-CODEX-MAX-REASONING]                                 -- Hit the enemy
04488 [GPT-5-CODEX-MAX-REASONING]                                 s.hp = s.hp - PLAYER_DAMAGE
04489 [GPT-5-CODEX-MAX-REASONING]                                 if not hitSomething then
04490 [GPT-5-CODEX-MAX-REASONING]                                     hitSomething = true
04491 [GPT-5-CODEX-MAX-REASONING]                                     if soundEnabled and swordHitSample then
04492 [GPT-5-CODEX-MAX-REASONING]                                         vmupro.sound.sample.stop(swordHitSample)
04493 [GPT-5-CODEX-MAX-REASONING]                                         vmupro.sound.sample.play(swordHitSample)
04494 [GPT-5-CODEX-MAX-REASONING]                                         if enableBootLogs then safeLog("INFO", "Play sample: sword_swing_connect") end
04495 [GPT-5-CODEX-MAX-REASONING]                                     end
04496 [GPT-5-CODEX-MAX-REASONING]                                 end
04497 [GPT-5-CODEX-MAX-REASONING]                                 if s.hp <= 0 then
04498 [GPT-5-CODEX-MAX-REASONING]                                     killSoldier(s)
04499 [GPT-5-CODEX-MAX-REASONING]                                 end
04500 [GPT-5-CODEX-MAX-REASONING]                             end
04501 [GPT-5-CODEX-MAX-REASONING]                         end
04502 [GPT-5-CODEX-MAX-REASONING]                     end
04503 [GPT-5-CODEX-MAX-REASONING]                     if soundEnabled and (not hitSomething) and swordMissSample then
04504 [GPT-5-CODEX-MAX-REASONING]                         vmupro.sound.sample.stop(swordMissSample)
04505 [GPT-5-CODEX-MAX-REASONING]                         vmupro.sound.sample.play(swordMissSample)
04506 [GPT-5-CODEX-MAX-REASONING]                         if enableBootLogs then safeLog("INFO", "Play sample: sword_miss") end
04507 [GPT-5-CODEX-MAX-REASONING]                     end
04508 [GPT-5-CODEX-MAX-REASONING]                 end
04509 [GPT-5-CODEX-MAX-REASONING] 
04510 [GPT-5-CODEX-MAX-REASONING]                 -- MODE + DOWN: Block (hold)
04511 [GPT-5-CODEX-MAX-REASONING]                 isBlocking = vmupro.input.held(vmupro.input.DOWN)
04512 [GPT-5-CODEX-MAX-REASONING]             else
04513 [GPT-5-CODEX-MAX-REASONING]                 -- Normal movement
04514 [GPT-5-CODEX-MAX-REASONING]                 isBlocking = false
04515 [GPT-5-CODEX-MAX-REASONING] 
04516 [GPT-5-CODEX-MAX-REASONING]                 -- UP: Move forward (held for continuous movement)
04517 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.input.held(vmupro.input.UP) then
04518 [GPT-5-CODEX-MAX-REASONING]                     local nx, ny = px + dx, py + dy
04519 [GPT-5-CODEX-MAX-REASONING]                     if canMove(nx, py) then
04520 [GPT-5-CODEX-MAX-REASONING]                         px = nx
04521 [GPT-5-CODEX-MAX-REASONING]                     end
04522 [GPT-5-CODEX-MAX-REASONING]                     if canMove(px, ny) then
04523 [GPT-5-CODEX-MAX-REASONING]                         py = ny
04524 [GPT-5-CODEX-MAX-REASONING]                     end
04525 [GPT-5-CODEX-MAX-REASONING]                 end
04526 [GPT-5-CODEX-MAX-REASONING] 
04527 [GPT-5-CODEX-MAX-REASONING]                 -- DOWN: Move backward (held for continuous movement)
04528 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.input.held(vmupro.input.DOWN) then
04529 [GPT-5-CODEX-MAX-REASONING]                     local nx, ny = px - dx, py - dy
04530 [GPT-5-CODEX-MAX-REASONING]                     if canMove(nx, py) then
04531 [GPT-5-CODEX-MAX-REASONING]                         px = nx
04532 [GPT-5-CODEX-MAX-REASONING]                     end
04533 [GPT-5-CODEX-MAX-REASONING]                     if canMove(px, ny) then
04534 [GPT-5-CODEX-MAX-REASONING]                         py = ny
04535 [GPT-5-CODEX-MAX-REASONING]                     end
04536 [GPT-5-CODEX-MAX-REASONING]                 end
04537 [GPT-5-CODEX-MAX-REASONING] 
04538 [GPT-5-CODEX-MAX-REASONING]                 -- MODE (tap without holding): Interact/Action
04539 [GPT-5-CODEX-MAX-REASONING]                 if vmupro.input.pressed(vmupro.input.MODE) then
04540 [GPT-5-CODEX-MAX-REASONING]                     -- Check for nearby interactable objects (doors, chests, etc.)
04541 [GPT-5-CODEX-MAX-REASONING]                     local checkX = px + dx * 1.5
04542 [GPT-5-CODEX-MAX-REASONING]                     local checkY = py + dy * 1.5
04543 [GPT-5-CODEX-MAX-REASONING]                     local mx, my = math.floor(checkX), math.floor(checkY)
04544 [GPT-5-CODEX-MAX-REASONING]                     if mx >= 0 and mx < 16 and my >= 0 and my < 16 then
04545 [GPT-5-CODEX-MAX-REASONING]                         local tile = map[my + 1][mx + 1]
04546 [GPT-5-CODEX-MAX-REASONING]                         -- Open doors (type 4 = metal door, type 5 = wood door)
04547 [GPT-5-CODEX-MAX-REASONING]                         if tile == 4 or tile == 5 then
04548 [GPT-5-CODEX-MAX-REASONING]                             map[my + 1][mx + 1] = 0  -- Open the door
04549 [GPT-5-CODEX-MAX-REASONING]                         end
04550 [GPT-5-CODEX-MAX-REASONING]                     end
04551 [GPT-5-CODEX-MAX-REASONING]                 end
04552 [GPT-5-CODEX-MAX-REASONING]             end
04553 [GPT-5-CODEX-MAX-REASONING] 
04554 [GPT-5-CODEX-MAX-REASONING]             -- A: Strafe left (held for continuous movement)
04555 [GPT-5-CODEX-MAX-REASONING]             if vmupro.input.held(vmupro.input.A) then
04556 [GPT-5-CODEX-MAX-REASONING]                 local nx, ny = px - sdx, py - sdy
04557 [GPT-5-CODEX-MAX-REASONING]                 if canMove(nx, py) then
04558 [GPT-5-CODEX-MAX-REASONING]                     px = nx
04559 [GPT-5-CODEX-MAX-REASONING]                 end
04560 [GPT-5-CODEX-MAX-REASONING]                 if canMove(px, ny) then
04561 [GPT-5-CODEX-MAX-REASONING]                     py = ny
04562 [GPT-5-CODEX-MAX-REASONING]                 end
04563 [GPT-5-CODEX-MAX-REASONING]             end
04564 [GPT-5-CODEX-MAX-REASONING] 
04565 [GPT-5-CODEX-MAX-REASONING]             -- B: Strafe right (held for continuous movement)
04566 [GPT-5-CODEX-MAX-REASONING]             if vmupro.input.held(vmupro.input.B) then
04567 [GPT-5-CODEX-MAX-REASONING]                 local nx, ny = px + sdx, py + sdy
04568 [GPT-5-CODEX-MAX-REASONING]                 if canMove(nx, py) then
04569 [GPT-5-CODEX-MAX-REASONING]                     px = nx
04570 [GPT-5-CODEX-MAX-REASONING]                 end
04571 [GPT-5-CODEX-MAX-REASONING]                 if canMove(px, ny) then
04572 [GPT-5-CODEX-MAX-REASONING]                     py = ny
04573 [GPT-5-CODEX-MAX-REASONING]                 end
04574 [GPT-5-CODEX-MAX-REASONING]             end
04575 [GPT-5-CODEX-MAX-REASONING] 
04576 [GPT-5-CODEX-MAX-REASONING]             -- POWER: Menu
04577 [GPT-5-CODEX-MAX-REASONING]             if vmupro.input.pressed(vmupro.input.POWER) then
04578 [GPT-5-CODEX-MAX-REASONING]                 showMenu = true
04579 [GPT-5-CODEX-MAX-REASONING]                 menuSelection = 1
04580 [GPT-5-CODEX-MAX-REASONING]             end
04581 [GPT-5-CODEX-MAX-REASONING]             end
04582 [GPT-5-CODEX-MAX-REASONING]         end)
04583 [GPT-5-CODEX-MAX-REASONING]         if (frameCount % bootLogEvery == 0) then
04584 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "B2.7 after title/menu pcall ok=" .. tostring(okTitle))
04585 [GPT-5-CODEX-MAX-REASONING]         end
04586 [GPT-5-CODEX-MAX-REASONING]         if not okTitle then
04587 [GPT-5-CODEX-MAX-REASONING]             logBoot(vmupro.system.LOG_ERROR, "title/menu error: " .. tostring(errTitle))
04588 [GPT-5-CODEX-MAX-REASONING]             quitApp("title/menu error: " .. tostring(errTitle))
04589 [GPT-5-CODEX-MAX-REASONING]         end
04590 [GPT-5-CODEX-MAX-REASONING] 
04591 [GPT-5-CODEX-MAX-REASONING]         -- Render based on game state
04592 [GPT-5-CODEX-MAX-REASONING]         if gameState == STATE_LOADING then
04593 [GPT-5-CODEX-MAX-REASONING]             if loadingTimer == loadingMax then
04594 [GPT-5-CODEX-MAX-REASONING]                 loadingLog("LOAD render loading screen frame1")
04595 [GPT-5-CODEX-MAX-REASONING]             end
04596 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.clear(COLOR_BLACK)
04597 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(40, 105, 200, 135, COLOR_DARK_GRAY)
04598 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(45, 110, 195, 130, COLOR_BLACK)
04599 [GPT-5-CODEX-MAX-REASONING]             local progress = 1.0 - (loadingTimer / loadingMax)
04600 [GPT-5-CODEX-MAX-REASONING]             if progress < 0 then progress = 0 end
04601 [GPT-5-CODEX-MAX-REASONING]             if progress > 1 then progress = 1 end
04602 [GPT-5-CODEX-MAX-REASONING]             local barW = math.floor(146 * progress)
04603 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(48, 113, 48 + barW, 127, COLOR_MAROON)
04604 [GPT-5-CODEX-MAX-REASONING]             vmupro.text.setFont(vmupro.text.FONT_SMALL)
04605 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawText("LOADING", 95, 90, COLOR_WHITE, COLOR_BLACK)
04606 [GPT-5-CODEX-MAX-REASONING]         elseif gameState == STATE_TITLE then
04607 [GPT-5-CODEX-MAX-REASONING]             if titleNeedsRedraw then
04608 [GPT-5-CODEX-MAX-REASONING]                 logBoot(vmupro.system.LOG_ERROR, "B3 before drawTitleScreen")
04609 [GPT-5-CODEX-MAX-REASONING]                 local okTitleDraw, errTitleDraw = pcall(function()
04610 [GPT-5-CODEX-MAX-REASONING]                     if drawTitleScreen then
04611 [GPT-5-CODEX-MAX-REASONING]                         drawTitleScreen()
04612 [GPT-5-CODEX-MAX-REASONING]                     else
04613 [GPT-5-CODEX-MAX-REASONING]                         error("drawTitleScreen missing")
04614 [GPT-5-CODEX-MAX-REASONING]                     end
04615 [GPT-5-CODEX-MAX-REASONING]                 end)
04616 [GPT-5-CODEX-MAX-REASONING]                 if not okTitleDraw then
04617 [GPT-5-CODEX-MAX-REASONING]                     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen error: " .. tostring(errTitleDraw))
04618 [GPT-5-CODEX-MAX-REASONING]                     quitApp("drawTitleScreen error: " .. tostring(errTitleDraw))
04619 [GPT-5-CODEX-MAX-REASONING]                 end
04620 [GPT-5-CODEX-MAX-REASONING]                 titleNeedsRedraw = false
04621 [GPT-5-CODEX-MAX-REASONING]             end
04622 [GPT-5-CODEX-MAX-REASONING]         else
04623 [GPT-5-CODEX-MAX-REASONING]             local okRender, errRender = pcall(renderGameFrame)
04624 [GPT-5-CODEX-MAX-REASONING]             if not okRender then
04625 [GPT-5-CODEX-MAX-REASONING]                 logBoot(vmupro.system.LOG_ERROR, 'render error: ' .. tostring(errRender))
04626 [GPT-5-CODEX-MAX-REASONING]                 quitApp("render error: " .. tostring(errRender))
04627 [GPT-5-CODEX-MAX-REASONING]             end
04628 [GPT-5-CODEX-MAX-REASONING]         end  -- End of game rendering (else branch of title screen check)
04629 [GPT-5-CODEX-MAX-REASONING] 
04630 [GPT-5-CODEX-MAX-REASONING]         ::render_only::
04631 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.refresh()
04632 [GPT-5-CODEX-MAX-REASONING]         if gameState == STATE_TITLE then
04633 [GPT-5-CODEX-MAX-REASONING]             targetFrameUs = 16667
04634 [GPT-5-CODEX-MAX-REASONING]         else
04635 [GPT-5-CODEX-MAX-REASONING]             if FPS_TARGET_MODE == "uncapped" then
04636 [GPT-5-CODEX-MAX-REASONING]                 targetFrameUs = 0
04637 [GPT-5-CODEX-MAX-REASONING]             elseif FPS_TARGET_MODE == "60" then
04638 [GPT-5-CODEX-MAX-REASONING]                 targetFrameUs = 16667
04639 [GPT-5-CODEX-MAX-REASONING]             else
04640 [GPT-5-CODEX-MAX-REASONING]                 targetFrameUs = 33333
04641 [GPT-5-CODEX-MAX-REASONING]             end
04642 [GPT-5-CODEX-MAX-REASONING]         end
04643 [GPT-5-CODEX-MAX-REASONING]         if vmupro.system and vmupro.system.getTimeUs and vmupro.system.delayMs then
04644 [GPT-5-CODEX-MAX-REASONING]             local frameEndUs = vmupro.system.getTimeUs()
04645 [GPT-5-CODEX-MAX-REASONING]             if frameStartUs > 0 and frameEndUs > frameStartUs then
04646 [GPT-5-CODEX-MAX-REASONING]                 local elapsedUs = frameEndUs - frameStartUs
04647 [GPT-5-CODEX-MAX-REASONING]                 local remainingUs = targetFrameUs - elapsedUs
04648 [GPT-5-CODEX-MAX-REASONING]                 if remainingUs > 0 then
04649 [GPT-5-CODEX-MAX-REASONING]                     vmupro.system.delayMs(math.floor(remainingUs / 1000))
04650 [GPT-5-CODEX-MAX-REASONING]                 end
04651 [GPT-5-CODEX-MAX-REASONING]             end
04652 [GPT-5-CODEX-MAX-REASONING]         end
04653 [GPT-5-CODEX-MAX-REASONING]     end
04654 [GPT-5-CODEX-MAX-REASONING] 
04655 [GPT-5-CODEX-MAX-REASONING]     -- Cleanup assets
04656 [GPT-5-CODEX-MAX-REASONING]     unloadLevelAudio()
04657 [GPT-5-CODEX-MAX-REASONING]     unloadLevelSprites()
04658 [GPT-5-CODEX-MAX-REASONING]     unloadMenuSprites()
04659 [GPT-5-CODEX-MAX-REASONING] 
04660 [GPT-5-CODEX-MAX-REASONING]     return 0
04661 [GPT-5-CODEX-MAX-REASONING] end

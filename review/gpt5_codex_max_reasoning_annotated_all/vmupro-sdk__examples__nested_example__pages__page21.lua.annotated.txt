00001 [GPT-5-CODEX-MAX-REASONING] -- pages/page21.lua
00002 [GPT-5-CODEX-MAX-REASONING] -- Test Page 21: Blur Effects (Motion/Depth)
00003 [GPT-5-CODEX-MAX-REASONING] 
00004 [GPT-5-CODEX-MAX-REASONING] Page21 = {}
00005 [GPT-5-CODEX-MAX-REASONING] 
00006 [GPT-5-CODEX-MAX-REASONING] -- Track double buffer state
00007 [GPT-5-CODEX-MAX-REASONING] local db_running = false
00008 [GPT-5-CODEX-MAX-REASONING] 
00009 [GPT-5-CODEX-MAX-REASONING] -- Sprite handles
00010 [GPT-5-CODEX-MAX-REASONING] local spritesheet_handle = nil
00011 [GPT-5-CODEX-MAX-REASONING] local sprites_loaded = false
00012 [GPT-5-CODEX-MAX-REASONING] local load_error = false
00013 [GPT-5-CODEX-MAX-REASONING] 
00014 [GPT-5-CODEX-MAX-REASONING] -- Animation state
00015 [GPT-5-CODEX-MAX-REASONING] local current_frame = 1
00016 [GPT-5-CODEX-MAX-REASONING] local last_frame_time = 0
00017 [GPT-5-CODEX-MAX-REASONING] local FRAME_DURATION = 100000  -- 100ms per frame
00018 [GPT-5-CODEX-MAX-REASONING] 
00019 [GPT-5-CODEX-MAX-REASONING] -- Character position (center)
00020 [GPT-5-CODEX-MAX-REASONING] local char_x = 104
00021 [GPT-5-CODEX-MAX-REASONING] local char_y = 100
00022 [GPT-5-CODEX-MAX-REASONING] 
00023 [GPT-5-CODEX-MAX-REASONING] -- Blur animation state
00024 [GPT-5-CODEX-MAX-REASONING] local STATE_INCREASING = 1
00025 [GPT-5-CODEX-MAX-REASONING] local STATE_DECREASING = 2
00026 [GPT-5-CODEX-MAX-REASONING] 
00027 [GPT-5-CODEX-MAX-REASONING] local blur_state = STATE_INCREASING
00028 [GPT-5-CODEX-MAX-REASONING] local blur_radius = 0
00029 [GPT-5-CODEX-MAX-REASONING] local last_blur_update = 0
00030 [GPT-5-CODEX-MAX-REASONING] local BLUR_UPDATE_INTERVAL = 50000  -- Update blur every 50ms
00031 [GPT-5-CODEX-MAX-REASONING] 
00032 [GPT-5-CODEX-MAX-REASONING] --- @brief Load spritesheet
00033 [GPT-5-CODEX-MAX-REASONING] local function loadSprites()
00034 [GPT-5-CODEX-MAX-REASONING]     if sprites_loaded or load_error then
00035 [GPT-5-CODEX-MAX-REASONING]         return
00036 [GPT-5-CODEX-MAX-REASONING]     end
00037 [GPT-5-CODEX-MAX-REASONING] 
00038 [GPT-5-CODEX-MAX-REASONING]     spritesheet_handle = vmupro.sprite.newSheet("assets/mask_guy-table-32-32")
00039 [GPT-5-CODEX-MAX-REASONING]     if not spritesheet_handle then
00040 [GPT-5-CODEX-MAX-REASONING]         vmupro.system.log(vmupro.system.LOG_ERROR, "Page21", "Failed to load spritesheet")
00041 [GPT-5-CODEX-MAX-REASONING]         load_error = true
00042 [GPT-5-CODEX-MAX-REASONING]         return
00043 [GPT-5-CODEX-MAX-REASONING]     end
00044 [GPT-5-CODEX-MAX-REASONING] 
00045 [GPT-5-CODEX-MAX-REASONING]     sprites_loaded = true
00046 [GPT-5-CODEX-MAX-REASONING]     local current_time = vmupro.system.getTimeUs()
00047 [GPT-5-CODEX-MAX-REASONING]     last_frame_time = current_time
00048 [GPT-5-CODEX-MAX-REASONING]     last_blur_update = current_time
00049 [GPT-5-CODEX-MAX-REASONING]     vmupro.system.log(vmupro.system.LOG_INFO, "Page21", "Sprites loaded for blur test")
00050 [GPT-5-CODEX-MAX-REASONING] end
00051 [GPT-5-CODEX-MAX-REASONING] 
00052 [GPT-5-CODEX-MAX-REASONING] --- @brief Update logic
00053 [GPT-5-CODEX-MAX-REASONING] function Page21.update()
00054 [GPT-5-CODEX-MAX-REASONING]     -- No update needed - handled in render
00055 [GPT-5-CODEX-MAX-REASONING] end
00056 [GPT-5-CODEX-MAX-REASONING] 
00057 [GPT-5-CODEX-MAX-REASONING] --- @brief Cleanup when leaving page
00058 [GPT-5-CODEX-MAX-REASONING] function Page21.exit()
00059 [GPT-5-CODEX-MAX-REASONING]     if db_running then
00060 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.stopDoubleBufferRenderer()
00061 [GPT-5-CODEX-MAX-REASONING]         db_running = false
00062 [GPT-5-CODEX-MAX-REASONING]     end
00063 [GPT-5-CODEX-MAX-REASONING] 
00064 [GPT-5-CODEX-MAX-REASONING]     if spritesheet_handle then
00065 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.free(spritesheet_handle)
00066 [GPT-5-CODEX-MAX-REASONING]         spritesheet_handle = nil
00067 [GPT-5-CODEX-MAX-REASONING]     end
00068 [GPT-5-CODEX-MAX-REASONING]     sprites_loaded = false
00069 [GPT-5-CODEX-MAX-REASONING]     current_frame = 1
00070 [GPT-5-CODEX-MAX-REASONING]     blur_radius = 0
00071 [GPT-5-CODEX-MAX-REASONING]     blur_state = STATE_INCREASING
00072 [GPT-5-CODEX-MAX-REASONING]     vmupro.system.log(vmupro.system.LOG_INFO, "Page21", "Sprites freed")
00073 [GPT-5-CODEX-MAX-REASONING] end
00074 [GPT-5-CODEX-MAX-REASONING] 
00075 [GPT-5-CODEX-MAX-REASONING] --- @brief Render Page 21: Blur Effect Demo
00076 [GPT-5-CODEX-MAX-REASONING] function Page21.render(drawPageCounter)
00077 [GPT-5-CODEX-MAX-REASONING]     -- Start double buffer on first render
00078 [GPT-5-CODEX-MAX-REASONING]     if not db_running then
00079 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.startDoubleBufferRenderer()
00080 [GPT-5-CODEX-MAX-REASONING]         db_running = true
00081 [GPT-5-CODEX-MAX-REASONING]     end
00082 [GPT-5-CODEX-MAX-REASONING] 
00083 [GPT-5-CODEX-MAX-REASONING]     -- Clear screen
00084 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.clear(vmupro.graphics.BLACK)
00085 [GPT-5-CODEX-MAX-REASONING] 
00086 [GPT-5-CODEX-MAX-REASONING]     -- Page title
00087 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_GABARITO_18x18)
00088 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("Blur Effect", 10, 10, vmupro.graphics.WHITE, vmupro.graphics.BLACK)
00089 [GPT-5-CODEX-MAX-REASONING] 
00090 [GPT-5-CODEX-MAX-REASONING]     vmupro.text.setFont(vmupro.text.FONT_SMALL)
00091 [GPT-5-CODEX-MAX-REASONING] 
00092 [GPT-5-CODEX-MAX-REASONING]     -- Load sprites on first render
00093 [GPT-5-CODEX-MAX-REASONING]     loadSprites()
00094 [GPT-5-CODEX-MAX-REASONING] 
00095 [GPT-5-CODEX-MAX-REASONING]     if load_error then
00096 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("ERROR: Failed to load", 10, 60, vmupro.graphics.RED, vmupro.graphics.BLACK)
00097 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("sprites. Check assets.", 10, 75, vmupro.graphics.RED, vmupro.graphics.BLACK)
00098 [GPT-5-CODEX-MAX-REASONING]     elseif not sprites_loaded then
00099 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("Loading sprites...", 10, 60, vmupro.graphics.YELLOW, vmupro.graphics.BLACK)
00100 [GPT-5-CODEX-MAX-REASONING]     elseif spritesheet_handle then
00101 [GPT-5-CODEX-MAX-REASONING]         local current_time = vmupro.system.getTimeUs()
00102 [GPT-5-CODEX-MAX-REASONING] 
00103 [GPT-5-CODEX-MAX-REASONING]         -- Update animation frame
00104 [GPT-5-CODEX-MAX-REASONING]         if (current_time - last_frame_time) >= FRAME_DURATION then
00105 [GPT-5-CODEX-MAX-REASONING]             current_frame = current_frame + 1
00106 [GPT-5-CODEX-MAX-REASONING]             if current_frame > spritesheet_handle.frameCount then
00107 [GPT-5-CODEX-MAX-REASONING]                 current_frame = 1
00108 [GPT-5-CODEX-MAX-REASONING]             end
00109 [GPT-5-CODEX-MAX-REASONING]             last_frame_time = current_time
00110 [GPT-5-CODEX-MAX-REASONING]         end
00111 [GPT-5-CODEX-MAX-REASONING] 
00112 [GPT-5-CODEX-MAX-REASONING]         -- Update blur radius
00113 [GPT-5-CODEX-MAX-REASONING]         if (current_time - last_blur_update) >= BLUR_UPDATE_INTERVAL then
00114 [GPT-5-CODEX-MAX-REASONING]             if blur_state == STATE_INCREASING then
00115 [GPT-5-CODEX-MAX-REASONING]                 blur_radius = blur_radius + 1
00116 [GPT-5-CODEX-MAX-REASONING]                 if blur_radius >= 10 then
00117 [GPT-5-CODEX-MAX-REASONING]                     blur_radius = 10
00118 [GPT-5-CODEX-MAX-REASONING]                     blur_state = STATE_DECREASING
00119 [GPT-5-CODEX-MAX-REASONING]                     vmupro.system.log(vmupro.system.LOG_INFO, "Page21", "Max blur reached")
00120 [GPT-5-CODEX-MAX-REASONING]                 end
00121 [GPT-5-CODEX-MAX-REASONING]             elseif blur_state == STATE_DECREASING then
00122 [GPT-5-CODEX-MAX-REASONING]                 blur_radius = blur_radius - 1
00123 [GPT-5-CODEX-MAX-REASONING]                 if blur_radius <= 0 then
00124 [GPT-5-CODEX-MAX-REASONING]                     blur_radius = 0
00125 [GPT-5-CODEX-MAX-REASONING]                     blur_state = STATE_INCREASING
00126 [GPT-5-CODEX-MAX-REASONING]                     vmupro.system.log(vmupro.system.LOG_INFO, "Page21", "Min blur reached")
00127 [GPT-5-CODEX-MAX-REASONING]                 end
00128 [GPT-5-CODEX-MAX-REASONING]             end
00129 [GPT-5-CODEX-MAX-REASONING]             last_blur_update = current_time
00130 [GPT-5-CODEX-MAX-REASONING]         end
00131 [GPT-5-CODEX-MAX-REASONING] 
00132 [GPT-5-CODEX-MAX-REASONING]         -- Draw character with current blur
00133 [GPT-5-CODEX-MAX-REASONING]         vmupro.sprite.drawFrameBlurred(spritesheet_handle, current_frame, char_x, char_y, blur_radius, vmupro.sprite.kImageUnflipped)
00134 [GPT-5-CODEX-MAX-REASONING] 
00135 [GPT-5-CODEX-MAX-REASONING]         -- Status info
00136 [GPT-5-CODEX-MAX-REASONING]         local blur_desc = "CLEAR"
00137 [GPT-5-CODEX-MAX-REASONING]         local blur_color = vmupro.graphics.GREEN
00138 [GPT-5-CODEX-MAX-REASONING] 
00139 [GPT-5-CODEX-MAX-REASONING]         if blur_radius >= 1 and blur_radius <= 3 then
00140 [GPT-5-CODEX-MAX-REASONING]             blur_desc = "LIGHT BLUR"
00141 [GPT-5-CODEX-MAX-REASONING]             blur_color = vmupro.graphics.YELLOW
00142 [GPT-5-CODEX-MAX-REASONING]         elseif blur_radius >= 4 and blur_radius <= 6 then
00143 [GPT-5-CODEX-MAX-REASONING]             blur_desc = "MEDIUM BLUR"
00144 [GPT-5-CODEX-MAX-REASONING]             blur_color = vmupro.graphics.ORANGE
00145 [GPT-5-CODEX-MAX-REASONING]         elseif blur_radius >= 7 and blur_radius <= 10 then
00146 [GPT-5-CODEX-MAX-REASONING]             blur_desc = "HEAVY BLUR"
00147 [GPT-5-CODEX-MAX-REASONING]             blur_color = vmupro.graphics.RED
00148 [GPT-5-CODEX-MAX-REASONING]         end
00149 [GPT-5-CODEX-MAX-REASONING] 
00150 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(blur_desc, 10, 195, blur_color, vmupro.graphics.BLACK)
00151 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText(string.format("Radius: %d/10", blur_radius), 10, 210, vmupro.graphics.BLUE, vmupro.graphics.BLACK)
00152 [GPT-5-CODEX-MAX-REASONING] 
00153 [GPT-5-CODEX-MAX-REASONING]         -- Draw blur bar visualization
00154 [GPT-5-CODEX-MAX-REASONING]         local bar_x = 10
00155 [GPT-5-CODEX-MAX-REASONING]         local bar_y = 180
00156 [GPT-5-CODEX-MAX-REASONING]         local bar_width = 220
00157 [GPT-5-CODEX-MAX-REASONING]         local bar_height = 8
00158 [GPT-5-CODEX-MAX-REASONING] 
00159 [GPT-5-CODEX-MAX-REASONING]         -- Background
00160 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawFillRect(bar_x, bar_y, bar_x + bar_width, bar_y + bar_height, vmupro.graphics.GREY)
00161 [GPT-5-CODEX-MAX-REASONING] 
00162 [GPT-5-CODEX-MAX-REASONING]         -- Blur fill
00163 [GPT-5-CODEX-MAX-REASONING]         local fill_width = math.floor((blur_radius / 10) * bar_width)
00164 [GPT-5-CODEX-MAX-REASONING]         if fill_width > 0 then
00165 [GPT-5-CODEX-MAX-REASONING]             vmupro.graphics.drawFillRect(bar_x, bar_y, bar_x + fill_width, bar_y + bar_height, blur_color)
00166 [GPT-5-CODEX-MAX-REASONING]         end
00167 [GPT-5-CODEX-MAX-REASONING] 
00168 [GPT-5-CODEX-MAX-REASONING]         -- Border
00169 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawRect(bar_x, bar_y, bar_x + bar_width, bar_y + bar_height, vmupro.graphics.WHITE)
00170 [GPT-5-CODEX-MAX-REASONING] 
00171 [GPT-5-CODEX-MAX-REASONING]         -- Use case hints
00172 [GPT-5-CODEX-MAX-REASONING]         vmupro.text.setFont(vmupro.text.FONT_SMALL)
00173 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("Use: Speed, Dazed,", 10, 40, vmupro.graphics.GREY, vmupro.graphics.BLACK)
00174 [GPT-5-CODEX-MAX-REASONING]         vmupro.graphics.drawText("Depth of Field", 10, 55, vmupro.graphics.GREY, vmupro.graphics.BLACK)
00175 [GPT-5-CODEX-MAX-REASONING]     end
00176 [GPT-5-CODEX-MAX-REASONING] 
00177 [GPT-5-CODEX-MAX-REASONING]     -- Navigation hint
00178 [GPT-5-CODEX-MAX-REASONING]     vmupro.graphics.drawText("< Prev | Next >", 75, 225, vmupro.graphics.GREY, vmupro.graphics.BLACK)
00179 [GPT-5-CODEX-MAX-REASONING] 
00180 [GPT-5-CODEX-MAX-REASONING]     -- Page counter
00181 [GPT-5-CODEX-MAX-REASONING]     drawPageCounter()
00182 [GPT-5-CODEX-MAX-REASONING] end

00001 [GPT-5-Codex] -- VMU Pro Dungeon Raycaster
00002 [GPT-5-Codex] -- Castle dungeon with detailed sprites
00003 [GPT-5-Codex] 
00004 [GPT-5-Codex] import "api/system"
00005 [GPT-5-Codex] 
00006 [GPT-5-Codex] enableBootLogs = false
00007 [GPT-5-Codex] enablePerfLogs = false
00008 [GPT-5-Codex] showFpsOverlay = true
00009 [GPT-5-Codex] lastFps = 0
00010 [GPT-5-Codex] 
00011 [GPT-5-Codex] DEBUG_PERF_MONITOR = false
00012 [GPT-5-Codex] PERF_MONITOR_SAMPLE_EVERY = 12
00013 [GPT-5-Codex] PERF_MONITOR_LOG_INTERVAL_US = 1000000
00014 [GPT-5-Codex] PERF_MONITOR_ALPHA = 0.25
00015 [GPT-5-Codex] PERF_MONITOR_ACTIVE_SAMPLE = false
00016 [GPT-5-Codex] PERF_MONITOR_LAST_FRAME_US = 0
00017 [GPT-5-Codex] PERF_MONITOR_LAST_LOG_US = 0
00018 [GPT-5-Codex] PERF_MONITOR_EMA_FRAME_US = 0
00019 [GPT-5-Codex] PERF_MONITOR_EMA_RAYCAST_US = 0
00020 [GPT-5-Codex] PERF_MONITOR_EMA_WALL_US = 0
00021 [GPT-5-Codex] PERF_MONITOR_EMA_FOG_US = 0
00022 [GPT-5-Codex] PERF_MONITOR_EMA_INPUT_US = 0
00023 [GPT-5-Codex] PERF_MONITOR_EMA_AUDIO_US = 0
00024 [GPT-5-Codex] PERF_MONITOR_EMA_SIM_US = 0
00025 [GPT-5-Codex] PERF_MONITOR_EMA_LOGIC_US = 0
00026 [GPT-5-Codex] PERF_MONITOR_EMA_RENDER_US = 0
00027 [GPT-5-Codex] PERF_MONITOR_EMA_PRESENT_US = 0
00028 [GPT-5-Codex] PERF_MONITOR_EMA_SLEEP_US = 0
00029 [GPT-5-Codex] PERF_MONITOR_SAMPLE_RAYCAST_US = 0
00030 [GPT-5-Codex] PERF_MONITOR_SAMPLE_WALL_US = 0
00031 [GPT-5-Codex] PERF_MONITOR_SAMPLE_FOG_US = 0
00032 [GPT-5-Codex] PERF_MONITOR_SAMPLE_INPUT_US = 0
00033 [GPT-5-Codex] PERF_MONITOR_SAMPLE_AUDIO_US = 0
00034 [GPT-5-Codex] PERF_MONITOR_SAMPLE_SIM_US = 0
00035 [GPT-5-Codex] PERF_MONITOR_SAMPLE_LOGIC_US = 0
00036 [GPT-5-Codex] PERF_MONITOR_SAMPLE_RENDER_US = 0
00037 [GPT-5-Codex] PERF_MONITOR_SAMPLE_PRESENT_US = 0
00038 [GPT-5-Codex] PERF_MONITOR_SAMPLE_SLEEP_US = 0
00039 [GPT-5-Codex] PERF_MONITOR_WALL_COLS_TOTAL = 0
00040 [GPT-5-Codex] PERF_MONITOR_WALL_COLS_TEXTURED = 0
00041 [GPT-5-Codex] PERF_MONITOR_WALL_COLS_FALLBACK = 0
00042 [GPT-5-Codex] PERF_MONITOR_FOG_COLS = 0
00043 [GPT-5-Codex] PERF_MONITOR_MIP_COLS_0 = 0
00044 [GPT-5-Codex] PERF_MONITOR_MIP_COLS_1 = 0
00045 [GPT-5-Codex] PERF_MONITOR_MIP_COLS_2 = 0
00046 [GPT-5-Codex] PERF_MONITOR_MIP_COLS_3 = 0
00047 [GPT-5-Codex] PERF_MONITOR_MIP_COLS_4 = 0
00048 [GPT-5-Codex] PERF_MONITOR_MOVE_BLOCKED = 0
00049 [GPT-5-Codex] PERF_MONITOR_WALL_RECOVERIES = 0
00050 [GPT-5-Codex] PERF_MONITOR_RAY_START_SOLID = 0
00051 [GPT-5-Codex] PERF_MONITOR_LAST_BASE_RAY_LABEL = "-"
00052 [GPT-5-Codex] PERF_MONITOR_LAST_EFFECTIVE_RAY_LABEL = "-"
00053 [GPT-5-Codex] PERF_MONITOR_LAST_RAYCAST_MODE = "FLOAT"
00054 [GPT-5-Codex] 
00055 [GPT-5-Codex] DEBUG_DOUBLE_BUFFER = true
00056 [GPT-5-Codex] DOUBLE_BUFFER_ACTIVE = false
00057 [GPT-5-Codex] DOUBLE_BUFFER_DELTA_USAGE_BYTES = 0
00058 [GPT-5-Codex] DOUBLE_BUFFER_DELTA_LARGEST_BYTES = 0
00059 [GPT-5-Codex] DOUBLE_BUFFER_OFF_USAGE_BYTES = nil
00060 [GPT-5-Codex] DOUBLE_BUFFER_OFF_LARGEST_BYTES = nil
00061 [GPT-5-Codex] DOUBLE_BUFFER_ON_USAGE_BYTES = nil
00062 [GPT-5-Codex] DOUBLE_BUFFER_ON_LARGEST_BYTES = nil
00063 [GPT-5-Codex] DOUBLE_BUFFER_PRESENT_ERROR_COUNT = 0
00064 [GPT-5-Codex] DOUBLE_BUFFER_FORCED_TITLE_OFF = false
00065 [GPT-5-Codex] 
00066 [GPT-5-Codex] local function getDoubleBufferPrefLabel()
00067 [GPT-5-Codex]     return DEBUG_DOUBLE_BUFFER and "ON" or "OFF"
00068 [GPT-5-Codex] end
00069 [GPT-5-Codex] 
00070 [GPT-5-Codex] local function getDoubleBufferActiveLabel()
00071 [GPT-5-Codex]     return DOUBLE_BUFFER_ACTIVE and "ON" or "OFF"
00072 [GPT-5-Codex] end
00073 [GPT-5-Codex] 
00074 [GPT-5-Codex] local function getDoubleBufferStatusLabel()
00075 [GPT-5-Codex]     local suffix = ""
00076 [GPT-5-Codex]     if DOUBLE_BUFFER_FORCED_TITLE_OFF then
00077 [GPT-5-Codex]         suffix = " T"
00078 [GPT-5-Codex]     end
00079 [GPT-5-Codex]     return "P" .. getDoubleBufferPrefLabel() .. " A" .. getDoubleBufferActiveLabel() .. suffix
00080 [GPT-5-Codex] end
00081 [GPT-5-Codex] 
00082 [GPT-5-Codex] local function applyRuntimeLogLevel()
00083 [GPT-5-Codex]     if vmupro and vmupro.system and vmupro.system.setLogLevel then
00084 [GPT-5-Codex]         local level = vmupro.system.LOG_DEBUG
00085 [GPT-5-Codex]         if not enableBootLogs and not enablePerfLogs then
00086 [GPT-5-Codex]             level = vmupro.system.LOG_ERROR
00087 [GPT-5-Codex]         end
00088 [GPT-5-Codex]         vmupro.system.setLogLevel(level)
00089 [GPT-5-Codex]     end
00090 [GPT-5-Codex] end
00091 [GPT-5-Codex] 
00092 [GPT-5-Codex] local function logBoot(level, message)
00093 [GPT-5-Codex]     if not enableBootLogs then return end
00094 [GPT-5-Codex]     if vmupro and vmupro.system and vmupro.system.log then
00095 [GPT-5-Codex]         vmupro.system.log(level, "BOOT", message)
00096 [GPT-5-Codex]     end
00097 [GPT-5-Codex] end
00098 [GPT-5-Codex] 
00099 [GPT-5-Codex] local function logPerf(message)
00100 [GPT-5-Codex]     if not enablePerfLogs then return end
00101 [GPT-5-Codex]     if vmupro and vmupro.system and vmupro.system.log then
00102 [GPT-5-Codex]         vmupro.system.log(vmupro.system.LOG_INFO, "PERF", message)
00103 [GPT-5-Codex]     end
00104 [GPT-5-Codex] end
00105 [GPT-5-Codex] 
00106 [GPT-5-Codex] local function perfNowUs()
00107 [GPT-5-Codex]     if vmupro and vmupro.system and vmupro.system.getTimeUs then
00108 [GPT-5-Codex]         return vmupro.system.getTimeUs()
00109 [GPT-5-Codex]     end
00110 [GPT-5-Codex]     return nil
00111 [GPT-5-Codex] end
00112 [GPT-5-Codex] 
00113 [GPT-5-Codex] local function perfEma(prev, sample)
00114 [GPT-5-Codex]     if not sample or sample <= 0 then
00115 [GPT-5-Codex]         return prev or 0
00116 [GPT-5-Codex]     end
00117 [GPT-5-Codex]     if not prev or prev <= 0 then
00118 [GPT-5-Codex]         return sample
00119 [GPT-5-Codex]     end
00120 [GPT-5-Codex]     local alpha = PERF_MONITOR_ALPHA or 0.25
00121 [GPT-5-Codex]     return prev + (sample - prev) * alpha
00122 [GPT-5-Codex] end
00123 [GPT-5-Codex] 
00124 [GPT-5-Codex] local function perfMonitorBeginFrame()
00125 [GPT-5-Codex]     local sampleEvery = PERF_MONITOR_SAMPLE_EVERY or 12
00126 [GPT-5-Codex]     if sampleEvery < 1 then sampleEvery = 1 end
00127 [GPT-5-Codex]     PERF_MONITOR_ACTIVE_SAMPLE = (DEBUG_PERF_MONITOR == true) and ((frameCount % sampleEvery) == 0)
00128 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_RAYCAST_US = 0
00129 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_WALL_US = 0
00130 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_FOG_US = 0
00131 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_INPUT_US = 0
00132 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_AUDIO_US = 0
00133 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_SIM_US = 0
00134 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_LOGIC_US = 0
00135 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_RENDER_US = 0
00136 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_PRESENT_US = 0
00137 [GPT-5-Codex]     PERF_MONITOR_SAMPLE_SLEEP_US = 0
00138 [GPT-5-Codex]     PERF_MONITOR_WALL_COLS_TOTAL = 0
00139 [GPT-5-Codex]     PERF_MONITOR_WALL_COLS_TEXTURED = 0
00140 [GPT-5-Codex]     PERF_MONITOR_WALL_COLS_FALLBACK = 0
00141 [GPT-5-Codex]     PERF_MONITOR_FOG_COLS = 0
00142 [GPT-5-Codex]     PERF_MONITOR_MIP_COLS_0 = 0
00143 [GPT-5-Codex]     PERF_MONITOR_MIP_COLS_1 = 0
00144 [GPT-5-Codex]     PERF_MONITOR_MIP_COLS_2 = 0
00145 [GPT-5-Codex]     PERF_MONITOR_MIP_COLS_3 = 0
00146 [GPT-5-Codex]     PERF_MONITOR_MIP_COLS_4 = 0
00147 [GPT-5-Codex]     PERF_MONITOR_MOVE_BLOCKED = 0
00148 [GPT-5-Codex]     PERF_MONITOR_WALL_RECOVERIES = 0
00149 [GPT-5-Codex]     PERF_MONITOR_RAY_START_SOLID = 0
00150 [GPT-5-Codex] end
00151 [GPT-5-Codex] 
00152 [GPT-5-Codex] local function perfMonitorSetRayInfo(baseIdx, effIdx, useFixed)
00153 [GPT-5-Codex]     local baseLabel = "-"
00154 [GPT-5-Codex]     local effLabel = "-"
00155 [GPT-5-Codex]     if RAY_PRESETS and #RAY_PRESETS > 0 then
00156 [GPT-5-Codex]         local n = #RAY_PRESETS
00157 [GPT-5-Codex]         local b = baseIdx or RAY_PRESET_INDEX or 1
00158 [GPT-5-Codex]         local e = effIdx or b
00159 [GPT-5-Codex]         if b < 1 then b = 1 elseif b > n then b = n end
00160 [GPT-5-Codex]         if e < 1 then e = 1 elseif e > n then e = n end
00161 [GPT-5-Codex]         baseLabel = (RAY_PRESETS[b] and RAY_PRESETS[b].label) or tostring(b)
00162 [GPT-5-Codex]         effLabel = (RAY_PRESETS[e] and RAY_PRESETS[e].label) or tostring(e)
00163 [GPT-5-Codex]     end
00164 [GPT-5-Codex]     PERF_MONITOR_LAST_BASE_RAY_LABEL = baseLabel
00165 [GPT-5-Codex]     PERF_MONITOR_LAST_EFFECTIVE_RAY_LABEL = effLabel
00166 [GPT-5-Codex]     PERF_MONITOR_LAST_RAYCAST_MODE = useFixed and "FIXED" or "FLOAT"
00167 [GPT-5-Codex] end
00168 [GPT-5-Codex] 
00169 [GPT-5-Codex] local function perfMonitorEndFrame(frameUs, frameNowUs)
00170 [GPT-5-Codex]     local frame = frameUs or 0
00171 [GPT-5-Codex]     if frame < 0 then frame = 0 end
00172 [GPT-5-Codex]     PERF_MONITOR_LAST_FRAME_US = frame
00173 [GPT-5-Codex]     PERF_MONITOR_EMA_FRAME_US = perfEma(PERF_MONITOR_EMA_FRAME_US, frame)
00174 [GPT-5-Codex] 
00175 [GPT-5-Codex]     if PERF_MONITOR_ACTIVE_SAMPLE then
00176 [GPT-5-Codex]         PERF_MONITOR_EMA_RAYCAST_US = perfEma(PERF_MONITOR_EMA_RAYCAST_US, PERF_MONITOR_SAMPLE_RAYCAST_US)
00177 [GPT-5-Codex]         PERF_MONITOR_EMA_WALL_US = perfEma(PERF_MONITOR_EMA_WALL_US, PERF_MONITOR_SAMPLE_WALL_US)
00178 [GPT-5-Codex]         PERF_MONITOR_EMA_FOG_US = perfEma(PERF_MONITOR_EMA_FOG_US, PERF_MONITOR_SAMPLE_FOG_US)
00179 [GPT-5-Codex]         PERF_MONITOR_EMA_INPUT_US = perfEma(PERF_MONITOR_EMA_INPUT_US, PERF_MONITOR_SAMPLE_INPUT_US)
00180 [GPT-5-Codex]         PERF_MONITOR_EMA_AUDIO_US = perfEma(PERF_MONITOR_EMA_AUDIO_US, PERF_MONITOR_SAMPLE_AUDIO_US)
00181 [GPT-5-Codex]         PERF_MONITOR_EMA_SIM_US = perfEma(PERF_MONITOR_EMA_SIM_US, PERF_MONITOR_SAMPLE_SIM_US)
00182 [GPT-5-Codex]         PERF_MONITOR_EMA_LOGIC_US = perfEma(PERF_MONITOR_EMA_LOGIC_US, PERF_MONITOR_SAMPLE_LOGIC_US)
00183 [GPT-5-Codex]         PERF_MONITOR_EMA_RENDER_US = perfEma(PERF_MONITOR_EMA_RENDER_US, PERF_MONITOR_SAMPLE_RENDER_US)
00184 [GPT-5-Codex]         PERF_MONITOR_EMA_PRESENT_US = perfEma(PERF_MONITOR_EMA_PRESENT_US, PERF_MONITOR_SAMPLE_PRESENT_US)
00185 [GPT-5-Codex]         PERF_MONITOR_EMA_SLEEP_US = perfEma(PERF_MONITOR_EMA_SLEEP_US, PERF_MONITOR_SAMPLE_SLEEP_US)
00186 [GPT-5-Codex]     end
00187 [GPT-5-Codex] 
00188 [GPT-5-Codex]     local nowUs = frameNowUs or perfNowUs()
00189 [GPT-5-Codex]     if not DEBUG_PERF_MONITOR or not enablePerfLogs or not nowUs then
00190 [GPT-5-Codex]         return
00191 [GPT-5-Codex]     end
00192 [GPT-5-Codex]     if PERF_MONITOR_LAST_LOG_US == 0 then
00193 [GPT-5-Codex]         PERF_MONITOR_LAST_LOG_US = nowUs
00194 [GPT-5-Codex]     end
00195 [GPT-5-Codex]     if (nowUs - PERF_MONITOR_LAST_LOG_US) >= (PERF_MONITOR_LOG_INTERVAL_US or 1000000) then
00196 [GPT-5-Codex]         local dbufStatus = getDoubleBufferStatusLabel()
00197 [GPT-5-Codex]         logPerf(string.format(
00198 [GPT-5-Codex]             "MON frame=%.2fms ray=%.2fms wall=%.2fms fog=%.2fms sec(i/a/s/l/r/p/z)=%.2f/%.2f/%.2f/%.2f/%.2f/%.2f/%.2fms rays=%s->%s mode=%s dbuf=%s dU=%dB dL=%dB cols=%d tex=%d fb=%d fogCols=%d mblk=%d rec=%d rsolid=%d",
00199 [GPT-5-Codex]             (PERF_MONITOR_EMA_FRAME_US or 0) / 1000.0,
00200 [GPT-5-Codex]             (PERF_MONITOR_EMA_RAYCAST_US or 0) / 1000.0,
00201 [GPT-5-Codex]             (PERF_MONITOR_EMA_WALL_US or 0) / 1000.0,
00202 [GPT-5-Codex]             (PERF_MONITOR_EMA_FOG_US or 0) / 1000.0,
00203 [GPT-5-Codex]             (PERF_MONITOR_EMA_INPUT_US or 0) / 1000.0,
00204 [GPT-5-Codex]             (PERF_MONITOR_EMA_AUDIO_US or 0) / 1000.0,
00205 [GPT-5-Codex]             (PERF_MONITOR_EMA_SIM_US or 0) / 1000.0,
00206 [GPT-5-Codex]             (PERF_MONITOR_EMA_LOGIC_US or 0) / 1000.0,
00207 [GPT-5-Codex]             (PERF_MONITOR_EMA_RENDER_US or 0) / 1000.0,
00208 [GPT-5-Codex]             (PERF_MONITOR_EMA_PRESENT_US or 0) / 1000.0,
00209 [GPT-5-Codex]             (PERF_MONITOR_EMA_SLEEP_US or 0) / 1000.0,
00210 [GPT-5-Codex]             tostring(PERF_MONITOR_LAST_BASE_RAY_LABEL or "-"),
00211 [GPT-5-Codex]             tostring(PERF_MONITOR_LAST_EFFECTIVE_RAY_LABEL or "-"),
00212 [GPT-5-Codex]             tostring(PERF_MONITOR_LAST_RAYCAST_MODE or "FLOAT"),
00213 [GPT-5-Codex]             dbufStatus,
00214 [GPT-5-Codex]             DOUBLE_BUFFER_DELTA_USAGE_BYTES or 0,
00215 [GPT-5-Codex]             DOUBLE_BUFFER_DELTA_LARGEST_BYTES or 0,
00216 [GPT-5-Codex]             PERF_MONITOR_WALL_COLS_TOTAL or 0,
00217 [GPT-5-Codex]             PERF_MONITOR_WALL_COLS_TEXTURED or 0,
00218 [GPT-5-Codex]             PERF_MONITOR_WALL_COLS_FALLBACK or 0,
00219 [GPT-5-Codex]             PERF_MONITOR_FOG_COLS or 0,
00220 [GPT-5-Codex]             PERF_MONITOR_MOVE_BLOCKED or 0,
00221 [GPT-5-Codex]             PERF_MONITOR_WALL_RECOVERIES or 0,
00222 [GPT-5-Codex]             PERF_MONITOR_RAY_START_SOLID or 0
00223 [GPT-5-Codex]         ))
00224 [GPT-5-Codex]         PERF_MONITOR_LAST_LOG_US = nowUs
00225 [GPT-5-Codex]     end
00226 [GPT-5-Codex] end
00227 [GPT-5-Codex] 
00228 [GPT-5-Codex] local function readMemoryStats()
00229 [GPT-5-Codex]     local stats = {}
00230 [GPT-5-Codex]     if not vmupro or not vmupro.system then
00231 [GPT-5-Codex]         return stats
00232 [GPT-5-Codex]     end
00233 [GPT-5-Codex]     if vmupro.system.getMemoryUsage then
00234 [GPT-5-Codex]         local ok, value = pcall(vmupro.system.getMemoryUsage)
00235 [GPT-5-Codex]         if ok and value then
00236 [GPT-5-Codex]             stats.usage = value
00237 [GPT-5-Codex]         end
00238 [GPT-5-Codex]     end
00239 [GPT-5-Codex]     if vmupro.system.getLargestFreeBlock then
00240 [GPT-5-Codex]         local ok, value = pcall(vmupro.system.getLargestFreeBlock)
00241 [GPT-5-Codex]         if ok and value then
00242 [GPT-5-Codex]             stats.largest = value
00243 [GPT-5-Codex]         end
00244 [GPT-5-Codex]     end
00245 [GPT-5-Codex]     if vmupro.system.getMemoryLimit then
00246 [GPT-5-Codex]         local ok, value = pcall(vmupro.system.getMemoryLimit)
00247 [GPT-5-Codex]         if ok and value then
00248 [GPT-5-Codex]             stats.limit = value
00249 [GPT-5-Codex]         end
00250 [GPT-5-Codex]     end
00251 [GPT-5-Codex]     return stats
00252 [GPT-5-Codex] end
00253 [GPT-5-Codex] 
00254 [GPT-5-Codex] local function updateDoubleBufferDeltas()
00255 [GPT-5-Codex]     if DOUBLE_BUFFER_ON_USAGE_BYTES and DOUBLE_BUFFER_OFF_USAGE_BYTES then
00256 [GPT-5-Codex]         DOUBLE_BUFFER_DELTA_USAGE_BYTES = DOUBLE_BUFFER_ON_USAGE_BYTES - DOUBLE_BUFFER_OFF_USAGE_BYTES
00257 [GPT-5-Codex]     else
00258 [GPT-5-Codex]         DOUBLE_BUFFER_DELTA_USAGE_BYTES = 0
00259 [GPT-5-Codex]     end
00260 [GPT-5-Codex]     if DOUBLE_BUFFER_ON_LARGEST_BYTES and DOUBLE_BUFFER_OFF_LARGEST_BYTES then
00261 [GPT-5-Codex]         DOUBLE_BUFFER_DELTA_LARGEST_BYTES = DOUBLE_BUFFER_OFF_LARGEST_BYTES - DOUBLE_BUFFER_ON_LARGEST_BYTES
00262 [GPT-5-Codex]     else
00263 [GPT-5-Codex]         DOUBLE_BUFFER_DELTA_LARGEST_BYTES = 0
00264 [GPT-5-Codex]     end
00265 [GPT-5-Codex] end
00266 [GPT-5-Codex] 
00267 [GPT-5-Codex] local function applyDoubleBufferMode(enable)
00268 [GPT-5-Codex]     local wantEnable = enable == true
00269 [GPT-5-Codex]     if wantEnable then
00270 [GPT-5-Codex]         if DOUBLE_BUFFER_ACTIVE then return true end
00271 [GPT-5-Codex]         if not vmupro or not vmupro.graphics or not vmupro.graphics.startDoubleBufferRenderer then
00272 [GPT-5-Codex]             DOUBLE_BUFFER_ACTIVE = false
00273 [GPT-5-Codex]             return false
00274 [GPT-5-Codex]         end
00275 [GPT-5-Codex]         local offStats = readMemoryStats()
00276 [GPT-5-Codex]         if offStats.usage then DOUBLE_BUFFER_OFF_USAGE_BYTES = offStats.usage end
00277 [GPT-5-Codex]         if offStats.largest then DOUBLE_BUFFER_OFF_LARGEST_BYTES = offStats.largest end
00278 [GPT-5-Codex]         local okStart, errStart = pcall(vmupro.graphics.startDoubleBufferRenderer)
00279 [GPT-5-Codex]         if not okStart then
00280 [GPT-5-Codex]             DOUBLE_BUFFER_ACTIVE = false
00281 [GPT-5-Codex]             local warnLevel = (vmupro and vmupro.system and vmupro.system.LOG_WARN) or 1
00282 [GPT-5-Codex]             logBoot(warnLevel, "startDoubleBufferRenderer failed: " .. tostring(errStart))
00283 [GPT-5-Codex]             return false
00284 [GPT-5-Codex]         end
00285 [GPT-5-Codex]         DOUBLE_BUFFER_ACTIVE = true
00286 [GPT-5-Codex]         local onStats = readMemoryStats()
00287 [GPT-5-Codex]         if onStats.usage then DOUBLE_BUFFER_ON_USAGE_BYTES = onStats.usage end
00288 [GPT-5-Codex]         if onStats.largest then DOUBLE_BUFFER_ON_LARGEST_BYTES = onStats.largest end
00289 [GPT-5-Codex]         updateDoubleBufferDeltas()
00290 [GPT-5-Codex]         if enablePerfLogs then
00291 [GPT-5-Codex]             logPerf(string.format(
00292 [GPT-5-Codex]                 "DBUF ON deltaUsage=%dB deltaLargest=%dB",
00293 [GPT-5-Codex]                 DOUBLE_BUFFER_DELTA_USAGE_BYTES or 0,
00294 [GPT-5-Codex]                 DOUBLE_BUFFER_DELTA_LARGEST_BYTES or 0
00295 [GPT-5-Codex]             ))
00296 [GPT-5-Codex]         end
00297 [GPT-5-Codex]         return true
00298 [GPT-5-Codex]     end
00299 [GPT-5-Codex] 
00300 [GPT-5-Codex]     if DOUBLE_BUFFER_ACTIVE and vmupro and vmupro.graphics and vmupro.graphics.stopDoubleBufferRenderer then
00301 [GPT-5-Codex]         local okStop, errStop = pcall(vmupro.graphics.stopDoubleBufferRenderer)
00302 [GPT-5-Codex]         if not okStop then
00303 [GPT-5-Codex]             local warnLevel = (vmupro and vmupro.system and vmupro.system.LOG_WARN) or 1
00304 [GPT-5-Codex]             logBoot(warnLevel, "stopDoubleBufferRenderer failed: " .. tostring(errStop))
00305 [GPT-5-Codex]         end
00306 [GPT-5-Codex]     end
00307 [GPT-5-Codex]     DOUBLE_BUFFER_ACTIVE = false
00308 [GPT-5-Codex]     local offStats = readMemoryStats()
00309 [GPT-5-Codex]     if offStats.usage then DOUBLE_BUFFER_OFF_USAGE_BYTES = offStats.usage end
00310 [GPT-5-Codex]     if offStats.largest then DOUBLE_BUFFER_OFF_LARGEST_BYTES = offStats.largest end
00311 [GPT-5-Codex]     updateDoubleBufferDeltas()
00312 [GPT-5-Codex]     if enablePerfLogs then
00313 [GPT-5-Codex]         logPerf(string.format(
00314 [GPT-5-Codex]             "DBUF OFF deltaUsage=%dB deltaLargest=%dB",
00315 [GPT-5-Codex]             DOUBLE_BUFFER_DELTA_USAGE_BYTES or 0,
00316 [GPT-5-Codex]             DOUBLE_BUFFER_DELTA_LARGEST_BYTES or 0
00317 [GPT-5-Codex]         ))
00318 [GPT-5-Codex]     end
00319 [GPT-5-Codex]     return true
00320 [GPT-5-Codex] end
00321 [GPT-5-Codex] 
00322 [GPT-5-Codex] local function syncDoubleBufferForState()
00323 [GPT-5-Codex]     local wantActive = (DEBUG_DOUBLE_BUFFER == true)
00324 [GPT-5-Codex]     if gameState == STATE_TITLE then
00325 [GPT-5-Codex]         wantActive = false
00326 [GPT-5-Codex]         DOUBLE_BUFFER_FORCED_TITLE_OFF = (DEBUG_DOUBLE_BUFFER == true)
00327 [GPT-5-Codex]     else
00328 [GPT-5-Codex]         DOUBLE_BUFFER_FORCED_TITLE_OFF = false
00329 [GPT-5-Codex]     end
00330 [GPT-5-Codex]     if wantActive ~= DOUBLE_BUFFER_ACTIVE then
00331 [GPT-5-Codex]         applyDoubleBufferMode(wantActive)
00332 [GPT-5-Codex]     end
00333 [GPT-5-Codex] end
00334 [GPT-5-Codex] 
00335 [GPT-5-Codex] local function presentFrame()
00336 [GPT-5-Codex]     if DOUBLE_BUFFER_ACTIVE and vmupro and vmupro.graphics and vmupro.graphics.pushDoubleBufferFrame then
00337 [GPT-5-Codex]         local okPush, errPush = pcall(vmupro.graphics.pushDoubleBufferFrame)
00338 [GPT-5-Codex]         if okPush then
00339 [GPT-5-Codex]             return
00340 [GPT-5-Codex]         end
00341 [GPT-5-Codex]         DOUBLE_BUFFER_PRESENT_ERROR_COUNT = (DOUBLE_BUFFER_PRESENT_ERROR_COUNT or 0) + 1
00342 [GPT-5-Codex]         local warnLevel = (vmupro and vmupro.system and vmupro.system.LOG_WARN) or 1
00343 [GPT-5-Codex]         logBoot(warnLevel, "pushDoubleBufferFrame failed: " .. tostring(errPush))
00344 [GPT-5-Codex]         applyDoubleBufferMode(false)
00345 [GPT-5-Codex]     end
00346 [GPT-5-Codex]     vmupro.graphics.refresh()
00347 [GPT-5-Codex] end
00348 [GPT-5-Codex] 
00349 [GPT-5-Codex] if enableBootLogs and vmupro and vmupro.system and vmupro.system.log then
00350 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "app.lua loaded")
00351 [GPT-5-Codex] end
00352 [GPT-5-Codex] 
00353 [GPT-5-Codex] local function tryImport(mod)
00354 [GPT-5-Codex]     local ok, err = pcall(function() import(mod) end)
00355 [GPT-5-Codex]     if ok then
00356 [GPT-5-Codex]         logBoot(vmupro.system.LOG_ERROR, "import ok " .. mod)
00357 [GPT-5-Codex]     else
00358 [GPT-5-Codex]         logBoot(vmupro.system.LOG_ERROR, "import FAIL " .. mod .. " err=" .. tostring(err))
00359 [GPT-5-Codex]     end
00360 [GPT-5-Codex]     return ok
00361 [GPT-5-Codex] end
00362 [GPT-5-Codex] 
00363 [GPT-5-Codex] tryImport("api/display")
00364 [GPT-5-Codex] tryImport("api/input")
00365 [GPT-5-Codex] tryImport("api/sprites")
00366 [GPT-5-Codex] tryImport("api/audio")
00367 [GPT-5-Codex] tryImport("api/file")
00368 [GPT-5-Codex] tryImport("api/text")
00369 [GPT-5-Codex] tryImport("data/classes")
00370 [GPT-5-Codex] tryImport("data/items")
00371 [GPT-5-Codex] tryImport("data/loot_tables")
00372 [GPT-5-Codex] tryImport("data/achievements")
00373 [GPT-5-Codex] tryImport("data/score_model")
00374 [GPT-5-Codex] tryImport("data/trader_tiers")
00375 [GPT-5-Codex] tryImport("data/persistence")
00376 [GPT-5-Codex] tryImport("data/runtime_state")
00377 [GPT-5-Codex] 
00378 [GPT-5-Codex] logBoot(vmupro.system.LOG_ERROR, "after imports")
00379 [GPT-5-Codex] 
00380 [GPT-5-Codex] -- Fallback stub; replaced by drawTitleScreenImpl when defined
00381 [GPT-5-Codex] function drawTitleScreen()
00382 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen stub")
00383 [GPT-5-Codex] end
00384 [GPT-5-Codex] 
00385 [GPT-5-Codex] -- Safety Check Functions
00386 [GPT-5-Codex] local function safeLog(level, message)
00387 [GPT-5-Codex]     if not enableBootLogs then return end
00388 [GPT-5-Codex]     if vmupro.system.log then
00389 [GPT-5-Codex]         local lvl = vmupro.system.LOG_INFO
00390 [GPT-5-Codex]         if level == "ERROR" then
00391 [GPT-5-Codex]             lvl = vmupro.system.LOG_ERROR
00392 [GPT-5-Codex]         elseif level == "WARN" then
00393 [GPT-5-Codex]             lvl = vmupro.system.LOG_WARN
00394 [GPT-5-Codex]         elseif level == "DEBUG" then
00395 [GPT-5-Codex]             lvl = vmupro.system.LOG_DEBUG
00396 [GPT-5-Codex]         end
00397 [GPT-5-Codex]         vmupro.system.log(lvl, "SAFETY", message)
00398 [GPT-5-Codex]     else
00399 [GPT-5-Codex]         print("[SAFETY " .. level .. "] " .. message)
00400 [GPT-5-Codex]     end
00401 [GPT-5-Codex] end
00402 [GPT-5-Codex] 
00403 [GPT-5-Codex] local function validateSprite(sprite, context)
00404 [GPT-5-Codex]     if not sprite then
00405 [GPT-5-Codex]         safeLog("ERROR", "Sprite is nil in context: " .. (context or "unknown"))
00406 [GPT-5-Codex]         return false
00407 [GPT-5-Codex]     end
00408 [GPT-5-Codex]     if not sprite.width or not sprite.height then
00409 [GPT-5-Codex]         safeLog("ERROR", "Sprite missing width/height in context: " .. (context or "unknown"))
00410 [GPT-5-Codex]         return false
00411 [GPT-5-Codex]     end
00412 [GPT-5-Codex]     if sprite.width <= 0 or sprite.height <= 0 then
00413 [GPT-5-Codex]         safeLog("ERROR", "Sprite has invalid dimensions in context: " .. (context or "unknown") ..
00414 [GPT-5-Codex]                " width=" .. tostring(sprite.width) .. " height=" .. tostring(sprite.height))
00415 [GPT-5-Codex]         return false
00416 [GPT-5-Codex]     end
00417 [GPT-5-Codex]     return true
00418 [GPT-5-Codex] end
00419 [GPT-5-Codex] 
00420 [GPT-5-Codex] local function validateTextureDimensions(sprite, context)
00421 [GPT-5-Codex]     if not validateSprite(sprite, context) then
00422 [GPT-5-Codex]         return false
00423 [GPT-5-Codex]     end
00424 [GPT-5-Codex]     if sprite.width > 2048 or sprite.height > 2048 then
00425 [GPT-5-Codex]         safeLog("WARN", "Texture dimensions may be too large in context: " .. (context or "unknown") ..
00426 [GPT-5-Codex]                " width=" .. tostring(sprite.width) .. " height=" .. tostring(sprite.height))
00427 [GPT-5-Codex]     end
00428 [GPT-5-Codex]     return true
00429 [GPT-5-Codex] end
00430 [GPT-5-Codex] 
00431 [GPT-5-Codex] local function safeDivide(value, divisor, context)
00432 [GPT-5-Codex]     if divisor == 0 then
00433 [GPT-5-Codex]         safeLog("ERROR", "Division by zero in context: " .. (context or "unknown") ..
00434 [GPT-5-Codex]                " value=" .. tostring(value) .. " divisor=0")
00435 [GPT-5-Codex]         return 0
00436 [GPT-5-Codex]     end
00437 [GPT-5-Codex]     return value / divisor
00438 [GPT-5-Codex] end
00439 [GPT-5-Codex] 
00440 [GPT-5-Codex] local function checkArrayBounds(array, index, context)
00441 [GPT-5-Codex]     if not array then
00442 [GPT-5-Codex]         safeLog("ERROR", "Array is nil in context: " .. (context or "unknown"))
00443 [GPT-5-Codex]         return false
00444 [GPT-5-Codex]     end
00445 [GPT-5-Codex]     local length = #array
00446 [GPT-5-Codex]     if index < 1 or index > length then
00447 [GPT-5-Codex]         safeLog("ERROR", "Array index out of bounds in context: " .. (context or "unknown") ..
00448 [GPT-5-Codex]                " index=" .. tostring(index) .. " length=" .. tostring(length))
00449 [GPT-5-Codex]         return false
00450 [GPT-5-Codex]     end
00451 [GPT-5-Codex]     return true
00452 [GPT-5-Codex] end
00453 [GPT-5-Codex] 
00454 [GPT-5-Codex] local function safeScale(sprite, scaleX, scaleY, context)
00455 [GPT-5-Codex]     if not validateSprite(sprite, context) then
00456 [GPT-5-Codex]         return false
00457 [GPT-5-Codex]     end
00458 [GPT-5-Codex]     if type(scaleX) ~= "number" or type(scaleY) ~= "number" then
00459 [GPT-5-Codex]         safeLog("ERROR", "Scale values are not numbers in context: " .. (context or "unknown") ..
00460 [GPT-5-Codex]                " scaleX=" .. tostring(scaleX) .. " scaleY=" .. tostring(scaleY))
00461 [GPT-5-Codex]         return false
00462 [GPT-5-Codex]     end
00463 [GPT-5-Codex]     if scaleX < 0 or scaleY < 0 then
00464 [GPT-5-Codex]         safeLog("WARN", "Negative scale values in context: " .. (context or "unknown") ..
00465 [GPT-5-Codex]                " scaleX=" .. tostring(scaleX) .. " scaleY=" .. tostring(scaleY))
00466 [GPT-5-Codex]     end
00467 [GPT-5-Codex]     return true
00468 [GPT-5-Codex] end
00469 [GPT-5-Codex] 
00470 [GPT-5-Codex] -- Cache font state to avoid redundant VMU API calls in hot UI paths.
00471 [GPT-5-Codex] local lastFontId = nil
00472 [GPT-5-Codex] local function setFontCached(fontId)
00473 [GPT-5-Codex]     if lastFontId ~= fontId then
00474 [GPT-5-Codex]         vmupro.text.setFont(fontId)
00475 [GPT-5-Codex]         lastFontId = fontId
00476 [GPT-5-Codex]     end
00477 [GPT-5-Codex] end
00478 [GPT-5-Codex] 
00479 [GPT-5-Codex] -- Colors (RGB565 little-endian)
00480 [GPT-5-Codex] COLOR_BLACK = 0x0000
00481 [GPT-5-Codex] COLOR_WHITE = 0xFFFF
00482 [GPT-5-Codex] COLOR_RED = 0x00F8
00483 [GPT-5-Codex] COLOR_YELLOW = 0xE0FF
00484 [GPT-5-Codex] COLOR_ORANGE = 0x20FC
00485 [GPT-5-Codex] COLOR_BROWN = 0x4051
00486 [GPT-5-Codex] COLOR_DARK_BROWN = 0x2028
00487 [GPT-5-Codex] COLOR_LIGHT_BROWN = 0x6079
00488 [GPT-5-Codex] COLOR_GRAY = 0x8C73
00489 [GPT-5-Codex] COLOR_DARK_GRAY = 0x4A52
00490 [GPT-5-Codex] COLOR_LIGHT_GRAY = 0xCE7B
00491 [GPT-5-Codex] COLOR_BLUE = 0x1F00
00492 [GPT-5-Codex] COLOR_DARK_BLUE = 0x0E00
00493 [GPT-5-Codex] COLOR_LIGHT_BLUE = 0x1F42
00494 [GPT-5-Codex] COLOR_GREEN = 0xE007
00495 [GPT-5-Codex] COLOR_MAROON = 0x0060
00496 [GPT-5-Codex] COLOR_DARK_MAROON = 0x0040
00497 [GPT-5-Codex] COLOR_SILVER = 0xF7BD
00498 [GPT-5-Codex] 
00499 [GPT-5-Codex] -- Dungeon colors
00500 [GPT-5-Codex] COLOR_FLOOR = 0x6931
00501 [GPT-5-Codex] COLOR_CEILING = 0x2821
00502 [GPT-5-Codex] 
00503 [GPT-5-Codex] -- Wall colors
00504 [GPT-5-Codex] COLOR_STONE_L = 0x8C73
00505 [GPT-5-Codex] COLOR_STONE_D = 0x4A52
00506 [GPT-5-Codex] COLOR_BRICK_L = 0x4062
00507 [GPT-5-Codex] COLOR_BRICK_D = 0x0041
00508 [GPT-5-Codex] COLOR_MOSS_L = 0x4444
00509 [GPT-5-Codex] COLOR_MOSS_D = 0x2222
00510 [GPT-5-Codex] COLOR_METAL_L = 0x1084
00511 [GPT-5-Codex] COLOR_METAL_D = 0x0842
00512 [GPT-5-Codex] COLOR_WOOD_L = 0x4051
00513 [GPT-5-Codex] COLOR_WOOD_D = 0x2028
00514 [GPT-5-Codex] 
00515 [GPT-5-Codex] logBoot(vmupro.system.LOG_ERROR, "after color constants")
00516 [GPT-5-Codex] 
00517 [GPT-5-Codex] -- Base level data (used to build per-level instances)
00518 [GPT-5-Codex] local BASE_MAP = {
00519 [GPT-5-Codex]     {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
00520 [GPT-5-Codex]     {1,0,0,0,2,0,0,0,0,0,3,0,0,0,0,1},
00521 [GPT-5-Codex]     {1,0,0,0,1,0,1,1,1,0,0,0,1,1,0,1},
00522 [GPT-5-Codex]     {1,0,1,0,0,0,1,0,0,0,1,0,0,1,0,1},
00523 [GPT-5-Codex]     {1,0,1,1,1,0,1,0,1,1,1,1,0,1,0,1},
00524 [GPT-5-Codex]     {1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1},
00525 [GPT-5-Codex]     {1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1},
00526 [GPT-5-Codex]     {1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,1},
00527 [GPT-5-Codex]     {1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,1},
00528 [GPT-5-Codex]     {1,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1},
00529 [GPT-5-Codex]     {1,0,1,0,1,1,1,0,1,1,1,0,1,0,0,1},
00530 [GPT-5-Codex]     {1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,1},
00531 [GPT-5-Codex]     {1,0,1,1,1,1,1,0,1,1,1,0,1,1,0,1},
00532 [GPT-5-Codex]     {1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1},
00533 [GPT-5-Codex]     {1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,1},
00534 [GPT-5-Codex]     {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
00535 [GPT-5-Codex] }
00536 [GPT-5-Codex] 
00537 [GPT-5-Codex] local function buildSingleRoomMap()
00538 [GPT-5-Codex]     local mapOut = {}
00539 [GPT-5-Codex]     for y = 0, 15 do
00540 [GPT-5-Codex]         local row = {}
00541 [GPT-5-Codex]         for x = 0, 15 do
00542 [GPT-5-Codex]             if x == 0 or x == 15 or y == 0 or y == 15 then
00543 [GPT-5-Codex]                 row[#row + 1] = 1
00544 [GPT-5-Codex]             else
00545 [GPT-5-Codex]                 row[#row + 1] = 0
00546 [GPT-5-Codex]             end
00547 [GPT-5-Codex]         end
00548 [GPT-5-Codex]         mapOut[#mapOut + 1] = row
00549 [GPT-5-Codex]     end
00550 [GPT-5-Codex]     return mapOut
00551 [GPT-5-Codex] end
00552 [GPT-5-Codex] 
00553 [GPT-5-Codex] -- Sprites: t=1 torch, t=2 barrel, t=3 table, t=4 chest, t=5 warrior, t=6 knight, t=7 health vial
00554 [GPT-5-Codex] local BASE_SPRITES = {
00555 [GPT-5-Codex]     {x=1.5, y=1.5, t=1}, {x=6.5, y=1.5, t=1}, {x=8.5, y=1.5, t=1}, {x=14.5, y=1.5, t=1},
00556 [GPT-5-Codex]     {x=1.5, y=5.5, t=1}, {x=14.5, y=5.5, t=1},
00557 [GPT-5-Codex]     {x=1.5, y=8.5, t=1}, {x=1.5, y=11.5, t=1},
00558 [GPT-5-Codex]     {x=14.5, y=8.5, t=1}, {x=14.5, y=11.5, t=1},
00559 [GPT-5-Codex]     {x=1.3, y=3.5, t=3}, {x=1.3, y=2.5, t=2}, {x=5.7, y=4.5, t=2},
00560 [GPT-5-Codex]     {x=10.5, y=1.3, t=4}, {x=14.3, y=3.5, t=3}, {x=10.3, y=4.7, t=2},
00561 [GPT-5-Codex]     {x=1.3, y=13.5, t=2}, {x=3.5, y=14.3, t=4}, {x=5.7, y=12.3, t=3},
00562 [GPT-5-Codex]     {x=14.3, y=13.5, t=2}, {x=13.5, y=14.3, t=4},
00563 [GPT-5-Codex]     {x=1.3, y=9.5, t=2}, {x=14.3, y=9.5, t=2},
00564 [GPT-5-Codex]     -- Warriors (red armor) - moved to open tiles
00565 [GPT-5-Codex]     {x=4.5, y=8.5, t=5, dir=32, tx=4.5, ty=8.5, anim=0, speed=0.02, hp=100, alive=true, startX=4.5, startY=8.5},
00566 [GPT-5-Codex]     {x=8.5, y=8.5, t=5, dir=48, tx=8.5, ty=8.5, anim=0, speed=0.02, hp=100, alive=true, startX=8.5, startY=8.5},
00567 [GPT-5-Codex]     {x=12.5, y=8.5, t=5, dir=0, tx=12.5, ty=8.5, anim=0, speed=0.02, hp=100, alive=true, startX=12.5, startY=8.5},
00568 [GPT-5-Codex]     {x=6.5, y=11.5, t=5, dir=16, tx=6.5, ty=11.5, anim=0, speed=0.02, hp=100, alive=true, startX=6.5, startY=11.5},
00569 [GPT-5-Codex]     {x=10.5, y=11.5, t=5, dir=32, tx=10.5, ty=11.5, anim=0, speed=0.02, hp=100, alive=true, startX=10.5, startY=11.5},
00570 [GPT-5-Codex]     -- Health vials (one per room area)
00571 [GPT-5-Codex]     {x=5.5, y=2.5, t=7, collected=false},   -- Top-left room
00572 [GPT-5-Codex]     {x=10.5, y=2.5, t=7, collected=false},  -- Top-right room
00573 [GPT-5-Codex]     {x=2.5, y=8.5, t=7, collected=false},   -- Left side
00574 [GPT-5-Codex]     {x=8.5, y=9.5, t=7, collected=false},   -- Central area
00575 [GPT-5-Codex]     {x=12.5, y=13.5, t=7, collected=false}, -- Bottom-right area
00576 [GPT-5-Codex] }
00577 [GPT-5-Codex] 
00578 [GPT-5-Codex] logBoot(vmupro.system.LOG_ERROR, "after base sprites")
00579 [GPT-5-Codex] 
00580 [GPT-5-Codex] local LEVELS = {
00581 [GPT-5-Codex]     [1] = {
00582 [GPT-5-Codex]         name = "Inner Sanctum - L1",
00583 [GPT-5-Codex]         playerStart = {x = 2.5, y = 2.5, dir = 0},
00584 [GPT-5-Codex]         assetBase = "sprites/level1/",
00585 [GPT-5-Codex]         map = BASE_MAP,
00586 [GPT-5-Codex]         sprites = BASE_SPRITES,
00587 [GPT-5-Codex]         assets = {warrior = true, knight = false, potion = true}
00588 [GPT-5-Codex]     },
00589 [GPT-5-Codex]     [2] = {
00590 [GPT-5-Codex]         name = "Inner Sanctum - L2",
00591 [GPT-5-Codex]         playerStart = {x = 2.5, y = 2.5, dir = 0},
00592 [GPT-5-Codex]         assetBase = "sprites/level2/",
00593 [GPT-5-Codex]         map = {
00594 [GPT-5-Codex]             {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
00595 [GPT-5-Codex]             {1,0,0,0,2,0,0,0,0,0,3,0,0,0,0,1},
00596 [GPT-5-Codex]             {1,0,0,0,1,0,1,1,1,0,0,0,1,1,0,1},
00597 [GPT-5-Codex]             {1,0,1,0,0,0,1,0,0,0,1,0,0,1,0,1},
00598 [GPT-5-Codex]             {1,0,1,1,1,0,1,0,1,1,1,1,0,1,0,1},
00599 [GPT-5-Codex]             {1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1},
00600 [GPT-5-Codex]             {1,1,1,0,1,1,1,0,1,0,1,1,0,1,0,1},
00601 [GPT-5-Codex]             {1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,1},
00602 [GPT-5-Codex]             {1,0,0,1,0,0,0,1,1,0,1,0,0,1,0,1},
00603 [GPT-5-Codex]             {1,0,1,0,1,0,0,0,0,0,1,0,0,0,0,1},
00604 [GPT-5-Codex]             {1,0,1,0,1,1,1,0,1,1,0,0,1,0,0,1},
00605 [GPT-5-Codex]             {1,0,1,0,0,0,0,0,0,0,1,0,1,0,0,1},
00606 [GPT-5-Codex]             {1,0,1,1,1,1,1,0,1,1,0,0,1,1,0,1},
00607 [GPT-5-Codex]             {1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1},
00608 [GPT-5-Codex]             {1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,1},
00609 [GPT-5-Codex]             {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
00610 [GPT-5-Codex]         },
00611 [GPT-5-Codex]             sprites = {
00612 [GPT-5-Codex]                 {x=1.5, y=1.5, t=1}, {x=6.5, y=1.5, t=1}, {x=8.5, y=1.5, t=1}, {x=14.5, y=1.5, t=1},
00613 [GPT-5-Codex]                 {x=1.5, y=5.5, t=1}, {x=14.5, y=5.5, t=1},
00614 [GPT-5-Codex]                 {x=1.5, y=8.5, t=1}, {x=1.5, y=11.5, t=1},
00615 [GPT-5-Codex]                 {x=14.5, y=8.5, t=1}, {x=14.5, y=11.5, t=1},
00616 [GPT-5-Codex]                 {x=1.3, y=3.5, t=3}, {x=1.3, y=2.5, t=2}, {x=5.7, y=4.5, t=2},
00617 [GPT-5-Codex]                 {x=10.5, y=1.3, t=4}, {x=14.3, y=3.5, t=3}, {x=10.3, y=4.7, t=2},
00618 [GPT-5-Codex]                 {x=1.3, y=13.5, t=2}, {x=3.5, y=14.3, t=4}, {x=5.7, y=12.3, t=3},
00619 [GPT-5-Codex]                 {x=14.3, y=13.5, t=2}, {x=13.5, y=14.3, t=4},
00620 [GPT-5-Codex]                 {x=1.3, y=9.5, t=2}, {x=14.3, y=9.5, t=2},
00621 [GPT-5-Codex]                 -- Warriors (red armor) - moved to open tiles
00622 [GPT-5-Codex]                 {x=4.5, y=8.5, t=5, dir=32, tx=4.5, ty=8.5, anim=0, speed=0.025, hp=120, alive=true, startX=4.5, startY=8.5},
00623 [GPT-5-Codex]                 {x=6.5, y=8.5, t=5, dir=48, tx=6.5, ty=8.5, anim=0, speed=0.025, hp=120, alive=true, startX=6.5, startY=8.5},
00624 [GPT-5-Codex]                 {x=11.5, y=10.5, t=5, dir=0, tx=11.5, ty=10.5, anim=0, speed=0.025, hp=120, alive=true, startX=11.5, startY=10.5},
00625 [GPT-5-Codex]             {x=11.5, y=12.5, t=5, dir=16, tx=11.5, ty=12.5, anim=0, speed=0.025, hp=120, alive=true, startX=11.5, startY=12.5},
00626 [GPT-5-Codex]             {x=8.5, y=13.5, t=5, dir=32, tx=8.5, ty=13.5, anim=0, speed=0.025, hp=120, alive=true, startX=8.5, startY=13.5},
00627 [GPT-5-Codex]             -- Health vials
00628 [GPT-5-Codex]             {x=5.5, y=2.5, t=7, collected=false},
00629 [GPT-5-Codex]             {x=10.5, y=2.5, t=7, collected=false},
00630 [GPT-5-Codex]             {x=2.5, y=8.5, t=7, collected=false},
00631 [GPT-5-Codex]             {x=8.5, y=9.5, t=7, collected=false},
00632 [GPT-5-Codex]             {x=12.5, y=13.5, t=7, collected=false}
00633 [GPT-5-Codex]         },
00634 [GPT-5-Codex]         assets = {warrior = true, knight = false, potion = true}
00635 [GPT-5-Codex]     }
00636 [GPT-5-Codex] }
00637 [GPT-5-Codex] 
00638 [GPT-5-Codex] logBoot(vmupro.system.LOG_ERROR, "after levels")
00639 [GPT-5-Codex] 
00640 [GPT-5-Codex] local currentLevel = 1
00641 [GPT-5-Codex] local selectedLevel = 1
00642 [GPT-5-Codex] local REAL_LEVEL_COUNT = #LEVELS
00643 [GPT-5-Codex] local MAX_LEVEL = REAL_LEVEL_COUNT
00644 [GPT-5-Codex] LEVELS[101] = {
00645 [GPT-5-Codex]     name = "p-1room0-0",
00646 [GPT-5-Codex]     playerStart = {x = 2.5, y = 2.5, dir = 0},
00647 [GPT-5-Codex]     assetBase = "sprites/level1/",
00648 [GPT-5-Codex]     map = buildSingleRoomMap(),
00649 [GPT-5-Codex]     sprites = {},
00650 [GPT-5-Codex]     assets = {warrior = false, knight = false, potion = false},
00651 [GPT-5-Codex]     perfDisableEnemies = true,
00652 [GPT-5-Codex]     perfDisableTextures = true,
00653 [GPT-5-Codex]     perfDisableProps = true
00654 [GPT-5-Codex] }
00655 [GPT-5-Codex] LEVELS[102] = {
00656 [GPT-5-Codex]     name = "p-1room-1-0",
00657 [GPT-5-Codex]     playerStart = {x = 2.5, y = 2.5, dir = 0},
00658 [GPT-5-Codex]     assetBase = "sprites/level1/",
00659 [GPT-5-Codex]     map = buildSingleRoomMap(),
00660 [GPT-5-Codex]     sprites = {},
00661 [GPT-5-Codex]     assets = {warrior = false, knight = false, potion = false},
00662 [GPT-5-Codex]     perfDisableEnemies = false,
00663 [GPT-5-Codex]     perfDisableTextures = true,
00664 [GPT-5-Codex]     perfDisableProps = true
00665 [GPT-5-Codex] }
00666 [GPT-5-Codex] LEVELS[103] = {
00667 [GPT-5-Codex]     name = "p-1room-1-1",
00668 [GPT-5-Codex]     playerStart = {x = 2.5, y = 2.5, dir = 0},
00669 [GPT-5-Codex]     assetBase = "sprites/level1/",
00670 [GPT-5-Codex]     map = buildSingleRoomMap(),
00671 [GPT-5-Codex]     sprites = {},
00672 [GPT-5-Codex]     assets = {warrior = false, knight = false, potion = false},
00673 [GPT-5-Codex]     perfDisableEnemies = false,
00674 [GPT-5-Codex]     perfDisableTextures = false,
00675 [GPT-5-Codex]     perfDisableProps = true
00676 [GPT-5-Codex] }
00677 [GPT-5-Codex] 
00678 [GPT-5-Codex] LEVEL_SELECT_LIST = {
00679 [GPT-5-Codex]     {id = 1, label = "1"},
00680 [GPT-5-Codex]     {id = 2, label = "2"},
00681 [GPT-5-Codex]     {id = 101, label = "p-1room0-0"},
00682 [GPT-5-Codex]     {id = 102, label = "p-1room-1-0"},
00683 [GPT-5-Codex]     {id = 103, label = "p-1room-1-1"}
00684 [GPT-5-Codex] }
00685 [GPT-5-Codex] LEVEL_SELECT_COUNT = #LEVEL_SELECT_LIST
00686 [GPT-5-Codex] function getLevelLabel(levelId)
00687 [GPT-5-Codex]     for i = 1, #LEVEL_SELECT_LIST do
00688 [GPT-5-Codex]         local entry = LEVEL_SELECT_LIST[i]
00689 [GPT-5-Codex]         if entry and entry.id == levelId then
00690 [GPT-5-Codex]             return entry.label
00691 [GPT-5-Codex]         end
00692 [GPT-5-Codex]     end
00693 [GPT-5-Codex]     return tostring(levelId)
00694 [GPT-5-Codex] end
00695 [GPT-5-Codex] map = nil
00696 [GPT-5-Codex] sprites = nil
00697 [GPT-5-Codex] 
00698 [GPT-5-Codex] sinTable = {}
00699 [GPT-5-Codex] cosTable = {}
00700 [GPT-5-Codex] for i = 0, 63 do
00701 [GPT-5-Codex]     local angle = i * 6.28318 / 64
00702 [GPT-5-Codex]     sinTable[i] = math.sin(angle)
00703 [GPT-5-Codex]     cosTable[i] = math.cos(angle)
00704 [GPT-5-Codex] end
00705 [GPT-5-Codex] 
00706 [GPT-5-Codex] px = 2.5
00707 [GPT-5-Codex] py = 2.5
00708 [GPT-5-Codex] pdir = 0
00709 [GPT-5-Codex] lastSafeWallX = px
00710 [GPT-5-Codex] lastSafeWallY = py
00711 [GPT-5-Codex] app_running = true
00712 [GPT-5-Codex] frameCount = 0
00713 [GPT-5-Codex] simTickCount = 0
00714 [GPT-5-Codex] VIEWPORT_H = 240
00715 [GPT-5-Codex] HORIZON = 120  -- Eye level within viewport
00716 [GPT-5-Codex] 
00717 [GPT-5-Codex] -- Fixed simulation clock: gameplay speed is tied to this, not render FPS.
00718 [GPT-5-Codex] SIM_TARGET_HZ = 24
00719 [GPT-5-Codex] SIM_STEP_US = math.floor(1000000 / SIM_TARGET_HZ)
00720 [GPT-5-Codex] SIM_MAX_STEPS_PER_FRAME = 4
00721 [GPT-5-Codex] SIM_MAX_BACKLOG_STEPS = 4
00722 [GPT-5-Codex] 
00723 [GPT-5-Codex] -- Preserve approximate legacy 30-FPS movement feel at fixed 24-Hz simulation.
00724 [GPT-5-Codex] PLAYER_MOVE_SPEED_PER_SEC = 4.5
00725 [GPT-5-Codex] PLAYER_STRAFE_SPEED_PER_SEC = 3.0
00726 [GPT-5-Codex] PLAYER_TURN_STEPS_PER_SEC = 30.0
00727 [GPT-5-Codex] turnStepAccumulator = 0.0
00728 [GPT-5-Codex] 
00729 [GPT-5-Codex] -- Game state
00730 [GPT-5-Codex] isAttacking = 0      -- Attack animation frames remaining
00731 [GPT-5-Codex] attackTotalFrames = 0 -- Total frames for current attack animation
00732 [GPT-5-Codex] isBlocking = false   -- Currently blocking
00733 [GPT-5-Codex] blockStartFrame = -1000 -- Simulation tick when block was raised
00734 [GPT-5-Codex] blockAnim = 0        -- Shield raise animation frame (0 = hidden)
00735 [GPT-5-Codex] BLOCK_ANIM_FRAMES = 4
00736 [GPT-5-Codex] lastBlockEvent = nil  -- {amount, pct, prime, frame}
00737 [GPT-5-Codex] showMenu = false     -- Menu visible
00738 [GPT-5-Codex] menuSelection = 1    -- Current menu selection
00739 [GPT-5-Codex] inOptionsMenu = false -- Currently in options submenu
00740 [GPT-5-Codex] optionsSelection = 1  -- Current options selection
00741 [GPT-5-Codex] inGameDebugMenu = false -- In-game options: debug submenu
00742 [GPT-5-Codex] inSaveMenu = false    -- In-game save submenu
00743 [GPT-5-Codex] saveMenuSelection = 1
00744 [GPT-5-Codex] saveMenuMessage = ""
00745 [GPT-5-Codex] saveMenuMessageTimer = 0
00746 [GPT-5-Codex] 
00747 [GPT-5-Codex] -- Options settings
00748 [GPT-5-Codex] soundEnabled = true   -- Sound on/off
00749 [GPT-5-Codex] bgmEnabled = true     -- In-game background music on/off
00750 [GPT-5-Codex] bgmVolumeLevel = 3    -- 1-11
00751 [GPT-5-Codex] gameBgmSample = nil
00752 [GPT-5-Codex] showHealthPercent = true  -- Health % display on/off
00753 [GPT-5-Codex] 
00754 [GPT-5-Codex] -- Sound effects
00755 [GPT-5-Codex]     gruntSample = nil
00756 [GPT-5-Codex]     swordHitSample = nil
00757 [GPT-5-Codex]     swordMissSample = nil
00758 [GPT-5-Codex]     yahSample = nil
00759 [GPT-5-Codex]     winLevelSample = nil
00760 [GPT-5-Codex]     argDeathSample = nil
00761 [GPT-5-Codex] audioInitialized = false
00762 [GPT-5-Codex] audioSystemActive = false
00763 [GPT-5-Codex] titleSample = nil            -- Title music sample
00764 [GPT-5-Codex] titleOverlaySample = nil     -- Title voice-over sample
00765 [GPT-5-Codex] titleMusicState = "stopped" -- stopped|voice_playing|music_playing
00766 [GPT-5-Codex] titleMusicTimer = 0
00767 [GPT-5-Codex] titleMusicStartUs = 0
00768 [GPT-5-Codex] titleVoiceStarted = false
00769 [GPT-5-Codex] titleMusicStarted = false
00770 [GPT-5-Codex] TITLE_MUSIC_VOLUME = 1.0
00771 [GPT-5-Codex] TITLE_VOICE_VOLUME = 1.0
00772 [GPT-5-Codex] TITLE_MUSIC_REPEAT_COUNT = 99
00773 [GPT-5-Codex] TITLE_VOICE_REPEAT_COUNT = 0
00774 [GPT-5-Codex] -- Attack constants
00775 [GPT-5-Codex] DETECTION_RANGE = 4    -- How far soldier can see player
00776 [GPT-5-Codex] ATTACK_RANGE = 1.0     -- Distance to attack (about 1 body length)
00777 [GPT-5-Codex] ATTACK_COOLDOWN = math.max(1, math.floor(2.4 * SIM_TARGET_HZ + 0.5)) -- ~2.4s between attacks
00778 [GPT-5-Codex] CHASE_SPEED_MULT = 3   -- Speed multiplier when chasing (sprint)
00779 [GPT-5-Codex] SOLDIER_SPEED_SCALE = 0.15625 -- Adjusted for 24Hz simulation (legacy 30fps tuning)
00780 [GPT-5-Codex] 
00781 [GPT-5-Codex] -- Player health system
00782 [GPT-5-Codex] playerHealth = 100     -- Current health (0-100)
00783 [GPT-5-Codex] MAX_HEALTH = 100
00784 [GPT-5-Codex] DAMAGE_PER_HIT = 10
00785 [GPT-5-Codex] player_build_state = nil
00786 [GPT-5-Codex] inventory_state = nil
00787 [GPT-5-Codex] stash_state = nil
00788 [GPT-5-Codex] achievement_state = nil
00789 [GPT-5-Codex] high_score_state = nil
00790 [GPT-5-Codex] score_state = nil
00791 [GPT-5-Codex] potionSprite = nil
00792 [GPT-5-Codex] titleSprite = nil
00793 [GPT-5-Codex] classPortraitSprite = nil
00794 [GPT-5-Codex] classPortraitSprites = {}
00795 [GPT-5-Codex] wallStone = nil
00796 [GPT-5-Codex] wallBrick = nil
00797 [GPT-5-Codex] wallMoss = nil
00798 [GPT-5-Codex] wallMetal = nil
00799 [GPT-5-Codex] wallWood = nil
00800 [GPT-5-Codex] wallWindow = nil
00801 [GPT-5-Codex] wallRoof = nil
00802 [GPT-5-Codex] wallSheetStone = nil
00803 [GPT-5-Codex] wallSheetBrick = nil
00804 [GPT-5-Codex] wallSheetMoss = nil
00805 [GPT-5-Codex] wallSheetMetal = nil
00806 [GPT-5-Codex] wallSheetWood = nil
00807 [GPT-5-Codex] wallSheetWindow = nil
00808 [GPT-5-Codex] wallTextureLoadAttempted = false
00809 [GPT-5-Codex] DEBUG_DISABLE_WALL_TEXTURE = false
00810 [GPT-5-Codex] DEBUG_DISABLE_ROOF_TEXTURE = true
00811 [GPT-5-Codex] DEBUG_SKIP_SPRITES = false
00812 [GPT-5-Codex] WALL_TEXTURE_MODE = "proper" -- locked to proper (single renderer pipeline)
00813 [GPT-5-Codex] WALL_MIPMAP_ENABLED = true
00814 [GPT-5-Codex] DEBUG_TEXTURE_LOG = false
00815 [GPT-5-Codex] TEX_SAMPLER_PRESETS = {"classic_ref", "current_dx"}
00816 [GPT-5-Codex] TEX_SAMPLER_INDEX = 1
00817 [GPT-5-Codex] TEX_FORCE_COLORKEY = 0xF81F -- unlikely to exist in dungeon walls
00818 [GPT-5-Codex] WALL_FORCE_COLORKEY_OVERRIDE = true -- force non-black color key so dark wall texels stay opaque
00819 [GPT-5-Codex] MIP_NEAR_FORCE_DIST = 1.35
00820 [GPT-5-Codex] WALL1_FORMAT_VARIANTS = {
00821 [GPT-5-Codex]     {label = "PNG16", base = "sprites/wall_textures/wall-1-tile", sheet = "sprites/wall_textures/wall-1-tile-table-1-128"},
00822 [GPT-5-Codex] }
00823 [GPT-5-Codex] WALL1_FORMAT_INDEX = 1
00824 [GPT-5-Codex] -- Temporary diagnostic mode: bypass sheet sampling and draw full wall sprite.
00825 [GPT-5-Codex] WALL_TEXTURE_TEST_FULLSPRITE = false
00826 [GPT-5-Codex] texDiagColumnsAttempted = 0
00827 [GPT-5-Codex] texDiagColumnsDrawn = 0
00828 [GPT-5-Codex] texDiagFallbackEvents = 0
00829 [GPT-5-Codex] texDiagDrawWallFallbackEvents = 0
00830 [GPT-5-Codex] DEBUG_SHOW_BLOCK = false
00831 [GPT-5-Codex] RAY_PRESETS = {
00832 [GPT-5-Codex]     {label = "12x20", rays = 12, colW = 20},
00833 [GPT-5-Codex]     {label = "15x16", rays = 15, colW = 16},
00834 [GPT-5-Codex]     {label = "16x15", rays = 16, colW = 15},
00835 [GPT-5-Codex]     {label = "20x12", rays = 20, colW = 12},
00836 [GPT-5-Codex]     {label = "24x10", rays = 24, colW = 10},
00837 [GPT-5-Codex]     {label = "30x8", rays = 30, colW = 8},
00838 [GPT-5-Codex]     {label = "40x6", rays = 40, colW = 6},
00839 [GPT-5-Codex]     {label = "48x5", rays = 48, colW = 5},
00840 [GPT-5-Codex]     {label = "60x4", rays = 60, colW = 4},
00841 [GPT-5-Codex]     {label = "80x3", rays = 80, colW = 3},
00842 [GPT-5-Codex]     {label = "120x2", rays = 120, colW = 2},
00843 [GPT-5-Codex]     {label = "240x1", rays = 240, colW = 1},
00844 [GPT-5-Codex] }
00845 [GPT-5-Codex] RAY_PRESET_INDEX = 10
00846 [GPT-5-Codex] DRAW_DIST_PRESETS = {3, 4, 5, 6, 8, 10, 12, 14, 16, 20, 24}
00847 [GPT-5-Codex] DRAW_DIST_INDEX = 7
00848 [GPT-5-Codex] MIPMAP_DIST_PRESETS = {1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 6, 7, 8, 9, 10, 12, 14, 16, 18, 20, 24}
00849 [GPT-5-Codex] MIPMAP1_DIST_INDEX = 6
00850 [GPT-5-Codex] MIPMAP2_DIST_INDEX = 8
00851 [GPT-5-Codex] MIPMAP3_DIST_INDEX = 11
00852 [GPT-5-Codex] MIPMAP4_DIST_INDEX = 12
00853 [GPT-5-Codex] EXP_TEX_MAX_DIST = DRAW_DIST_PRESETS[DRAW_DIST_INDEX]
00854 [GPT-5-Codex] EXP_VIEW_DIST = EXP_TEX_MAX_DIST
00855 [GPT-5-Codex] WALL_MIPMAP_DIST1 = MIPMAP_DIST_PRESETS[MIPMAP1_DIST_INDEX]
00856 [GPT-5-Codex] WALL_MIPMAP_DIST2 = MIPMAP_DIST_PRESETS[MIPMAP2_DIST_INDEX]
00857 [GPT-5-Codex] WALL_MIPMAP_DIST3 = MIPMAP_DIST_PRESETS[MIPMAP3_DIST_INDEX]
00858 [GPT-5-Codex] WALL_MIPMAP_DIST4 = MIPMAP_DIST_PRESETS[MIPMAP4_DIST_INDEX]
00859 [GPT-5-Codex] renderCfg = {
00860 [GPT-5-Codex]     rayCols = 60,
00861 [GPT-5-Codex]     colW = 4,
00862 [GPT-5-Codex]     fovSteps = 9,
00863 [GPT-5-Codex]     twoPi = 6.28318,
00864 [GPT-5-Codex]     skipOddTex = false,
00865 [GPT-5-Codex] }
00866 [GPT-5-Codex] DEBUG_WALL_QUADS_LOG = false
00867 [GPT-5-Codex] wallQuadLogCount = 0
00868 [GPT-5-Codex] spriteOrderCache = {}
00869 [GPT-5-Codex] spriteOrderCacheFrame = -1000
00870 [GPT-5-Codex] PLAYER_RADIUS = 0.50
00871 [GPT-5-Codex] -- Slightly slimmer than visual body width to reduce "invisible corner snag" feeling.
00872 [GPT-5-Codex] PLAYER_COLLISION_RADIUS = 0.27
00873 [GPT-5-Codex] PLAYER_MOVE_SUBSTEP = 0.08
00874 [GPT-5-Codex] PLAYER_MOVE_SUBSTEP_STRICT = 0.04
00875 [GPT-5-Codex] -- Keep full collision radius at walls; avoids micro-creep when holding forward into a wall.
00876 [GPT-5-Codex] PLAYER_WALL_COLLISION_INSET = 0.0
00877 [GPT-5-Codex] PLAYER_WALL_CLEARANCE_EPSILON = 0.004
00878 [GPT-5-Codex] -- Prevent near-contact projection blowup when player is pressed against walls.
00879 [GPT-5-Codex] PLAYER_RENDER_NEAR_CLIP_DIST = 0.38
00880 [GPT-5-Codex] PLAYER_WALL_CONTACT_FRAMES = 0
00881 [GPT-5-Codex] PLAYER_WALL_CONTACT_HOLD_FRAMES = 4
00882 [GPT-5-Codex] WALL_NEAR_STABILITY_DIST = 1.85
00883 [GPT-5-Codex] WALL_SEAM_DISABLE_NEAR_DIST = 1.35
00884 [GPT-5-Codex] WALL_TEX_SEAM_OVERDRAW = true
00885 [GPT-5-Codex] WALL_TEX_SEAM_PIXELS = 1
00886 [GPT-5-Codex] DEBUG_DISABLE_PROPS = false
00887 [GPT-5-Codex] FOG_DISTANCE_PRESETS = {
00888 [GPT-5-Codex]     2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 6.5,
00889 [GPT-5-Codex]     7.0, 7.5, 8.0, 8.5, 9.0, 9.5, 10.0, 10.5, 11.0, 11.5,
00890 [GPT-5-Codex]     12.0, 13.0, 14.0, 15.0, 16.0, 18.0, 20.0, 24.0, 28.0
00891 [GPT-5-Codex] }
00892 [GPT-5-Codex] -- Start and full-fog use the same preset list for predictable tuning.
00893 [GPT-5-Codex] FOG_START_PRESETS = FOG_DISTANCE_PRESETS
00894 [GPT-5-Codex] FOG_END_PRESETS = FOG_DISTANCE_PRESETS
00895 [GPT-5-Codex] -- Legacy cutoff retained for compatibility; EXP-H now uses start/end fade range.
00896 [GPT-5-Codex] FOG_CUTOFF_PRESETS = FOG_DISTANCE_PRESETS
00897 [GPT-5-Codex] FOG_COLOR_PRESETS = {COLOR_DARK_GRAY, COLOR_GRAY, COLOR_LIGHT_GRAY, COLOR_WHITE, COLOR_BLACK, COLOR_MAROON}
00898 [GPT-5-Codex] FOG_COLOR_LABELS = {"DARK", "GRAY", "LGRAY", "WHITE", "BLACK", "MAROON"}
00899 [GPT-5-Codex] FOG_START_INDEX = 16
00900 [GPT-5-Codex] FOG_END_INDEX = 23
00901 [GPT-5-Codex] FOG_CUTOFF_INDEX = 17
00902 [GPT-5-Codex] FOG_COLOR_INDEX = 5
00903 [GPT-5-Codex] FOG_START = FOG_START_PRESETS[FOG_START_INDEX]
00904 [GPT-5-Codex] FOG_END = FOG_END_PRESETS[FOG_END_INDEX]
00905 [GPT-5-Codex] FOG_TEX_CUTOFF = FOG_CUTOFF_PRESETS[FOG_CUTOFF_INDEX]
00906 [GPT-5-Codex] FOG_COLOR = FOG_COLOR_PRESETS[FOG_COLOR_INDEX]
00907 [GPT-5-Codex] FOG_DITHER_SIZE_PRESETS = {1, 2, 3, 4, 5, 6}
00908 [GPT-5-Codex] FOG_DITHER_SIZE_INDEX = 1
00909 [GPT-5-Codex] FOG_DITHER_SIZE = FOG_DITHER_SIZE_PRESETS[FOG_DITHER_SIZE_INDEX]
00910 [GPT-5-Codex] FAR_TEX_OFF_PRESETS = {3, 4, 5, 6, 7, 8, 9, 10, 12, 14, 16, 20, 24, 999}
00911 [GPT-5-Codex] FAR_TEX_OFF_INDEX = 8
00912 [GPT-5-Codex] FAR_TEX_OFF_DIST = FAR_TEX_OFF_PRESETS[FAR_TEX_OFF_INDEX]
00913 [GPT-5-Codex] MIP_LOD_ENABLED = true
00914 [GPT-5-Codex] WALL_PROJECTION_MODE = "adaptive" -- adaptive | stable
00915 [GPT-5-Codex] DEBUG_DISABLE_FOG = false
00916 [GPT-5-Codex] DEBUG_DISABLE_EFFECTS = true
00917 [GPT-5-Codex] LOW_RES_WALLS = true
00918 [GPT-5-Codex] LOW_RES_MODE = "quality"
00919 [GPT-5-Codex] SHOW_MINIMAP = false
00920 [GPT-5-Codex] RENDERER_MODE = "exp_hybrid" -- locked single renderer
00921 [GPT-5-Codex] DEBUG_DISABLE_ENEMIES = false
00922 [GPT-5-Codex] textureDebugFrame = -1
00923 [GPT-5-Codex] textureDebugSamples = 0
00924 [GPT-5-Codex] 
00925 [GPT-5-Codex] local function bootstrapExpansionDataLayer()
00926 [GPT-5-Codex]     if not ExpansionRuntimeState or not ExpansionRuntimeState.bootstrap then
00927 [GPT-5-Codex]         return
00928 [GPT-5-Codex]     end
00929 [GPT-5-Codex]     local state = ExpansionRuntimeState.bootstrap()
00930 [GPT-5-Codex]     if not state then
00931 [GPT-5-Codex]         return
00932 [GPT-5-Codex]     end
00933 [GPT-5-Codex]     player_build_state = state.player_build_state or player_build_state
00934 [GPT-5-Codex]     inventory_state = state.inventory_state or inventory_state
00935 [GPT-5-Codex]     stash_state = state.stash_state or stash_state
00936 [GPT-5-Codex]     achievement_state = state.achievement_state or achievement_state
00937 [GPT-5-Codex]     high_score_state = state.high_score_state or high_score_state
00938 [GPT-5-Codex]     score_state = state.score_state or score_state
00939 [GPT-5-Codex] end
00940 [GPT-5-Codex] 
00941 [GPT-5-Codex] local function beginExpansionRun(levelId)
00942 [GPT-5-Codex]     if not ExpansionRuntimeState or not ExpansionRuntimeState.beginRun then
00943 [GPT-5-Codex]         return
00944 [GPT-5-Codex]     end
00945 [GPT-5-Codex]     local state = ExpansionRuntimeState.beginRun(levelId, currentLevel)
00946 [GPT-5-Codex]     if not state then
00947 [GPT-5-Codex]         return
00948 [GPT-5-Codex]     end
00949 [GPT-5-Codex]     player_build_state = state.player_build_state or player_build_state
00950 [GPT-5-Codex]     inventory_state = state.inventory_state or inventory_state
00951 [GPT-5-Codex]     stash_state = state.stash_state or stash_state
00952 [GPT-5-Codex]     achievement_state = state.achievement_state or achievement_state
00953 [GPT-5-Codex]     high_score_state = state.high_score_state or high_score_state
00954 [GPT-5-Codex]     score_state = state.score_state or score_state
00955 [GPT-5-Codex] end
00956 [GPT-5-Codex] local function wallQuadLog(msg)
00957 [GPT-5-Codex]     if enableBootLogs and DEBUG_WALL_QUADS_LOG and wallQuadLogCount < 30 then
00958 [GPT-5-Codex]         print(msg)
00959 [GPT-5-Codex]         wallQuadLogCount = wallQuadLogCount + 1
00960 [GPT-5-Codex]     end
00961 [GPT-5-Codex] end
00962 [GPT-5-Codex] 
00963 [GPT-5-Codex] local function forceSpriteColorKey(sprite, label)
00964 [GPT-5-Codex]     if not sprite then
00965 [GPT-5-Codex]         return
00966 [GPT-5-Codex]     end
00967 [GPT-5-Codex]     if sprite.transparentColor == nil then
00968 [GPT-5-Codex]         return
00969 [GPT-5-Codex]     end
00970 [GPT-5-Codex]     local before = sprite.transparentColor
00971 [GPT-5-Codex]     sprite.transparentColor = TEX_FORCE_COLORKEY
00972 [GPT-5-Codex]     local after = sprite.transparentColor or TEX_FORCE_COLORKEY
00973 [GPT-5-Codex]     safeLog("INFO", string.format(
00974 [GPT-5-Codex]         "[SAFETY] [TEX] %s colorKey=0x%04X -> 0x%04X",
00975 [GPT-5-Codex]         tostring(label or "sprite"), before, after
00976 [GPT-5-Codex]     ))
00977 [GPT-5-Codex] end
00978 [GPT-5-Codex] STATE_TITLE = 0
00979 [GPT-5-Codex] STATE_PLAYING = 1
00980 [GPT-5-Codex] STATE_GAME_OVER = 2
00981 [GPT-5-Codex] STATE_WIN = 3
00982 [GPT-5-Codex] STATE_LOADING = 4
00983 [GPT-5-Codex] gameState = STATE_TITLE
00984 [GPT-5-Codex] titleSelection = 1  -- 1=New Game, 2=Load Game, 3=Options, 4=Exit
00985 [GPT-5-Codex] titleInClassSelect = false
00986 [GPT-5-Codex] titleClassSelection = 1
00987 [GPT-5-Codex] titleInLoadMenu = false
00988 [GPT-5-Codex] titleLoadSelection = 1
00989 [GPT-5-Codex] titleInOptions = false
00990 [GPT-5-Codex] titleInDebug = false
00991 [GPT-5-Codex] titleOptionsSelection = 1
00992 [GPT-5-Codex] titleDebugSelection = 1
00993 [GPT-5-Codex] DEBUG_PAGE_CORE = 1
00994 [GPT-5-Codex] DEBUG_PAGE_VIDEO = 2
00995 [GPT-5-Codex] DEBUG_PAGE_PERF = 3
00996 [GPT-5-Codex] titleDebugPage = DEBUG_PAGE_CORE
00997 [GPT-5-Codex] titleNeedsRedraw = true
00998 [GPT-5-Codex] FPS_TARGET_MODE = "uncapped" -- uncapped | 60 | 45 | 30 | 24 (render pacing only)
00999 [GPT-5-Codex] AUDIO_MIX_HZ_PRESETS = {20, 25, 30, 35, 40, 45, 50, 55, 60}
01000 [GPT-5-Codex] AUDIO_MIX_HZ_INDEX = #AUDIO_MIX_HZ_PRESETS
01001 [GPT-5-Codex] AUDIO_UPDATE_TARGET_HZ = AUDIO_MIX_HZ_PRESETS[AUDIO_MIX_HZ_INDEX]
01002 [GPT-5-Codex] AUDIO_UPDATE_STEP_US = math.floor(1000000 / AUDIO_UPDATE_TARGET_HZ)
01003 [GPT-5-Codex] AUDIO_UPDATE_MAX_STEPS = 3
01004 [GPT-5-Codex] AUDIO_UPDATE_MAX_BACKLOG_STEPS = 3
01005 [GPT-5-Codex] 
01006 [GPT-5-Codex] PERF_QUALITY_PRESETS = {"QUALITY", "BALANCED", "PERFORMANCE"}
01007 [GPT-5-Codex] PERF_QUALITY_INDEX = 0
01008 [GPT-5-Codex] UI_TEXT_SOLID_BG = COLOR_DARK_GRAY
01009 [GPT-5-Codex] 
01010 [GPT-5-Codex] local function setAudioMixHz(hz)
01011 [GPT-5-Codex]     local target = hz or 60
01012 [GPT-5-Codex]     local idx = 1
01013 [GPT-5-Codex]     local bestDelta = math.abs((AUDIO_MIX_HZ_PRESETS[1] or target) - target)
01014 [GPT-5-Codex]     for i = 2, #AUDIO_MIX_HZ_PRESETS do
01015 [GPT-5-Codex]         local delta = math.abs((AUDIO_MIX_HZ_PRESETS[i] or target) - target)
01016 [GPT-5-Codex]         if delta < bestDelta then
01017 [GPT-5-Codex]             bestDelta = delta
01018 [GPT-5-Codex]             idx = i
01019 [GPT-5-Codex]         end
01020 [GPT-5-Codex]     end
01021 [GPT-5-Codex]     AUDIO_MIX_HZ_INDEX = idx
01022 [GPT-5-Codex]     AUDIO_UPDATE_TARGET_HZ = AUDIO_MIX_HZ_PRESETS[idx]
01023 [GPT-5-Codex]     AUDIO_UPDATE_STEP_US = math.floor(1000000 / AUDIO_UPDATE_TARGET_HZ)
01024 [GPT-5-Codex] end
01025 [GPT-5-Codex] 
01026 [GPT-5-Codex] local function quitApp(reason)
01027 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "APP EXIT: " .. tostring(reason))
01028 [GPT-5-Codex]     app_running = false
01029 [GPT-5-Codex] end
01030 [GPT-5-Codex] 
01031 [GPT-5-Codex] local function getDebugPageName(pageId)
01032 [GPT-5-Codex]     if pageId == DEBUG_PAGE_VIDEO then
01033 [GPT-5-Codex]         return "VIDEO"
01034 [GPT-5-Codex]     elseif pageId == DEBUG_PAGE_PERF then
01035 [GPT-5-Codex]         return "PERF/Q"
01036 [GPT-5-Codex]     end
01037 [GPT-5-Codex]     return "DEBUG"
01038 [GPT-5-Codex] end
01039 [GPT-5-Codex] 
01040 [GPT-5-Codex] local function stepDebugPage(delta)
01041 [GPT-5-Codex]     local pages = {DEBUG_PAGE_CORE, DEBUG_PAGE_VIDEO, DEBUG_PAGE_PERF}
01042 [GPT-5-Codex]     local current = 1
01043 [GPT-5-Codex]     for i = 1, #pages do
01044 [GPT-5-Codex]         if pages[i] == titleDebugPage then
01045 [GPT-5-Codex]             current = i
01046 [GPT-5-Codex]             break
01047 [GPT-5-Codex]         end
01048 [GPT-5-Codex]     end
01049 [GPT-5-Codex]     local nextIdx = current + (delta or 1)
01050 [GPT-5-Codex]     if nextIdx < 1 then nextIdx = #pages end
01051 [GPT-5-Codex]     if nextIdx > #pages then nextIdx = 1 end
01052 [GPT-5-Codex]     titleDebugPage = pages[nextIdx]
01053 [GPT-5-Codex]     titleDebugSelection = 1
01054 [GPT-5-Codex] end
01055 [GPT-5-Codex] 
01056 [GPT-5-Codex] local function lockRendererMode()
01057 [GPT-5-Codex]     -- Single supported renderer path: EXP-H with proper column textures.
01058 [GPT-5-Codex]     if RENDERER_MODE ~= "exp_hybrid" then
01059 [GPT-5-Codex]         RENDERER_MODE = "exp_hybrid"
01060 [GPT-5-Codex]     end
01061 [GPT-5-Codex]     if WALL_TEXTURE_MODE ~= "proper" then
01062 [GPT-5-Codex]         WALL_TEXTURE_MODE = "proper"
01063 [GPT-5-Codex]     end
01064 [GPT-5-Codex] end
01065 [GPT-5-Codex] 
01066 [GPT-5-Codex] local function nearestPresetIndex(list, target)
01067 [GPT-5-Codex]     if not list or #list == 0 then return 1 end
01068 [GPT-5-Codex]     local bestIdx = 1
01069 [GPT-5-Codex]     local bestDelta = math.abs((list[1] or target) - target)
01070 [GPT-5-Codex]     for i = 2, #list do
01071 [GPT-5-Codex]         local delta = math.abs((list[i] or target) - target)
01072 [GPT-5-Codex]         if delta < bestDelta then
01073 [GPT-5-Codex]             bestDelta = delta
01074 [GPT-5-Codex]             bestIdx = i
01075 [GPT-5-Codex]         end
01076 [GPT-5-Codex]     end
01077 [GPT-5-Codex]     return bestIdx
01078 [GPT-5-Codex] end
01079 [GPT-5-Codex] 
01080 [GPT-5-Codex] local function nearestRayPresetIndex(targetRays)
01081 [GPT-5-Codex]     if not RAY_PRESETS or #RAY_PRESETS == 0 then
01082 [GPT-5-Codex]         return 1
01083 [GPT-5-Codex]     end
01084 [GPT-5-Codex]     local bestIdx = 1
01085 [GPT-5-Codex]     local bestDelta = math.abs((RAY_PRESETS[1].rays or targetRays) - targetRays)
01086 [GPT-5-Codex]     for i = 2, #RAY_PRESETS do
01087 [GPT-5-Codex]         local delta = math.abs((RAY_PRESETS[i].rays or targetRays) - targetRays)
01088 [GPT-5-Codex]         if delta < bestDelta then
01089 [GPT-5-Codex]             bestDelta = delta
01090 [GPT-5-Codex]             bestIdx = i
01091 [GPT-5-Codex]         end
01092 [GPT-5-Codex]     end
01093 [GPT-5-Codex]     return bestIdx
01094 [GPT-5-Codex] end
01095 [GPT-5-Codex] 
01096 [GPT-5-Codex] local function clampInt(v, minV, maxV)
01097 [GPT-5-Codex]     if v < minV then return minV end
01098 [GPT-5-Codex]     if v > maxV then return maxV end
01099 [GPT-5-Codex]     return v
01100 [GPT-5-Codex] end
01101 [GPT-5-Codex] 
01102 [GPT-5-Codex] local function refreshExpViewDistance()
01103 [GPT-5-Codex]     local texDist = EXP_TEX_MAX_DIST or DRAW_DIST_PRESETS[DRAW_DIST_INDEX] or 8.0
01104 [GPT-5-Codex]     local viewDist = texDist
01105 [GPT-5-Codex]     if not DEBUG_DISABLE_FOG then
01106 [GPT-5-Codex]         local fogEnd = FOG_END or texDist
01107 [GPT-5-Codex]         local fogView = fogEnd + 0.5
01108 [GPT-5-Codex]         if fogView > viewDist then
01109 [GPT-5-Codex]             viewDist = fogView
01110 [GPT-5-Codex]         end
01111 [GPT-5-Codex]     end
01112 [GPT-5-Codex]     local maxFogPreset = (FOG_DISTANCE_PRESETS and FOG_DISTANCE_PRESETS[#FOG_DISTANCE_PRESETS]) or 28.0
01113 [GPT-5-Codex]     if viewDist > maxFogPreset then
01114 [GPT-5-Codex]         viewDist = maxFogPreset
01115 [GPT-5-Codex]     end
01116 [GPT-5-Codex]     EXP_VIEW_DIST = viewDist
01117 [GPT-5-Codex] end
01118 [GPT-5-Codex] 
01119 [GPT-5-Codex] local function normalizeFogRange()
01120 [GPT-5-Codex]     if not FOG_START_PRESETS or not FOG_END_PRESETS then return end
01121 [GPT-5-Codex]     if not FOG_START_INDEX then FOG_START_INDEX = 1 end
01122 [GPT-5-Codex]     if not FOG_END_INDEX then FOG_END_INDEX = 1 end
01123 [GPT-5-Codex]     if FOG_START_INDEX < 1 then FOG_START_INDEX = 1 end
01124 [GPT-5-Codex]     if FOG_END_INDEX < 1 then FOG_END_INDEX = 1 end
01125 [GPT-5-Codex]     if FOG_START_INDEX > #FOG_START_PRESETS then FOG_START_INDEX = #FOG_START_PRESETS end
01126 [GPT-5-Codex]     if FOG_END_INDEX > #FOG_END_PRESETS then FOG_END_INDEX = #FOG_END_PRESETS end
01127 [GPT-5-Codex] 
01128 [GPT-5-Codex]     if FOG_END_INDEX <= FOG_START_INDEX then
01129 [GPT-5-Codex]         FOG_END_INDEX = FOG_START_INDEX + 1
01130 [GPT-5-Codex]         if FOG_END_INDEX > #FOG_END_PRESETS then
01131 [GPT-5-Codex]             FOG_END_INDEX = #FOG_END_PRESETS
01132 [GPT-5-Codex]             FOG_START_INDEX = math.max(1, FOG_END_INDEX - 1)
01133 [GPT-5-Codex]         end
01134 [GPT-5-Codex]     end
01135 [GPT-5-Codex] 
01136 [GPT-5-Codex]     FOG_START = FOG_START_PRESETS[FOG_START_INDEX]
01137 [GPT-5-Codex]     FOG_END = FOG_END_PRESETS[FOG_END_INDEX]
01138 [GPT-5-Codex]     if FOG_END <= FOG_START then
01139 [GPT-5-Codex]         FOG_END = FOG_START + 0.5
01140 [GPT-5-Codex]     end
01141 [GPT-5-Codex]     refreshExpViewDistance()
01142 [GPT-5-Codex] end
01143 [GPT-5-Codex] 
01144 [GPT-5-Codex] local function normalizeMipmapRanges()
01145 [GPT-5-Codex]     if not MIPMAP_DIST_PRESETS or #MIPMAP_DIST_PRESETS == 0 then return end
01146 [GPT-5-Codex]     local n = #MIPMAP_DIST_PRESETS
01147 [GPT-5-Codex]     if not MIPMAP1_DIST_INDEX then MIPMAP1_DIST_INDEX = 1 end
01148 [GPT-5-Codex]     if not MIPMAP2_DIST_INDEX then MIPMAP2_DIST_INDEX = math.min(n, 2) end
01149 [GPT-5-Codex]     if not MIPMAP3_DIST_INDEX then MIPMAP3_DIST_INDEX = math.min(n, 3) end
01150 [GPT-5-Codex]     if not MIPMAP4_DIST_INDEX then MIPMAP4_DIST_INDEX = math.min(n, 4) end
01151 [GPT-5-Codex] 
01152 [GPT-5-Codex]     if n == 1 then
01153 [GPT-5-Codex]         MIPMAP1_DIST_INDEX = 1
01154 [GPT-5-Codex]         MIPMAP2_DIST_INDEX = 1
01155 [GPT-5-Codex]         MIPMAP3_DIST_INDEX = 1
01156 [GPT-5-Codex]         MIPMAP4_DIST_INDEX = 1
01157 [GPT-5-Codex]     elseif n == 2 then
01158 [GPT-5-Codex]         MIPMAP1_DIST_INDEX = clampInt(MIPMAP1_DIST_INDEX, 1, 1)
01159 [GPT-5-Codex]         MIPMAP2_DIST_INDEX = clampInt(MIPMAP2_DIST_INDEX, 2, 2)
01160 [GPT-5-Codex]         MIPMAP3_DIST_INDEX = clampInt(MIPMAP3_DIST_INDEX, 2, 2)
01161 [GPT-5-Codex]         MIPMAP4_DIST_INDEX = clampInt(MIPMAP4_DIST_INDEX, 2, 2)
01162 [GPT-5-Codex]     elseif n == 3 then
01163 [GPT-5-Codex]         MIPMAP1_DIST_INDEX = clampInt(MIPMAP1_DIST_INDEX, 1, 1)
01164 [GPT-5-Codex]         MIPMAP2_DIST_INDEX = clampInt(MIPMAP2_DIST_INDEX, 2, 2)
01165 [GPT-5-Codex]         MIPMAP3_DIST_INDEX = clampInt(MIPMAP3_DIST_INDEX, 3, 3)
01166 [GPT-5-Codex]         MIPMAP4_DIST_INDEX = clampInt(MIPMAP4_DIST_INDEX, 3, 3)
01167 [GPT-5-Codex]     else
01168 [GPT-5-Codex]         -- Keep strict ordering without pushing unrelated levels to max.
01169 [GPT-5-Codex]         MIPMAP1_DIST_INDEX = clampInt(MIPMAP1_DIST_INDEX, 1, n - 3)
01170 [GPT-5-Codex]         MIPMAP2_DIST_INDEX = clampInt(MIPMAP2_DIST_INDEX, MIPMAP1_DIST_INDEX + 1, n - 2)
01171 [GPT-5-Codex]         MIPMAP3_DIST_INDEX = clampInt(MIPMAP3_DIST_INDEX, MIPMAP2_DIST_INDEX + 1, n - 1)
01172 [GPT-5-Codex]         MIPMAP4_DIST_INDEX = clampInt(MIPMAP4_DIST_INDEX, MIPMAP3_DIST_INDEX + 1, n)
01173 [GPT-5-Codex]     end
01174 [GPT-5-Codex] 
01175 [GPT-5-Codex]     WALL_MIPMAP_DIST1 = MIPMAP_DIST_PRESETS[MIPMAP1_DIST_INDEX]
01176 [GPT-5-Codex]     WALL_MIPMAP_DIST2 = MIPMAP_DIST_PRESETS[MIPMAP2_DIST_INDEX]
01177 [GPT-5-Codex]     WALL_MIPMAP_DIST3 = MIPMAP_DIST_PRESETS[MIPMAP3_DIST_INDEX]
01178 [GPT-5-Codex]     WALL_MIPMAP_DIST4 = MIPMAP_DIST_PRESETS[MIPMAP4_DIST_INDEX]
01179 [GPT-5-Codex] end
01180 [GPT-5-Codex] 
01181 [GPT-5-Codex] local function normalizeFarTextureCutoff()
01182 [GPT-5-Codex]     if not FAR_TEX_OFF_PRESETS or #FAR_TEX_OFF_PRESETS == 0 then
01183 [GPT-5-Codex]         FAR_TEX_OFF_INDEX = 1
01184 [GPT-5-Codex]         FAR_TEX_OFF_DIST = 999
01185 [GPT-5-Codex]         return
01186 [GPT-5-Codex]     end
01187 [GPT-5-Codex]     FAR_TEX_OFF_INDEX = clampInt(FAR_TEX_OFF_INDEX or #FAR_TEX_OFF_PRESETS, 1, #FAR_TEX_OFF_PRESETS)
01188 [GPT-5-Codex]     FAR_TEX_OFF_DIST = FAR_TEX_OFF_PRESETS[FAR_TEX_OFF_INDEX]
01189 [GPT-5-Codex] end
01190 [GPT-5-Codex] 
01191 [GPT-5-Codex] local function markPerfQualityCustom()
01192 [GPT-5-Codex]     PERF_QUALITY_INDEX = 0
01193 [GPT-5-Codex] end
01194 [GPT-5-Codex] 
01195 [GPT-5-Codex] local function applyPerfQualityPreset(newIndex)
01196 [GPT-5-Codex]     if not PERF_QUALITY_PRESETS or #PERF_QUALITY_PRESETS == 0 then
01197 [GPT-5-Codex]         return
01198 [GPT-5-Codex]     end
01199 [GPT-5-Codex]     PERF_QUALITY_INDEX = clampInt(newIndex or PERF_QUALITY_INDEX or 1, 1, #PERF_QUALITY_PRESETS)
01200 [GPT-5-Codex]     local preset = PERF_QUALITY_PRESETS[PERF_QUALITY_INDEX]
01201 [GPT-5-Codex] 
01202 [GPT-5-Codex]     if preset == "QUALITY" then
01203 [GPT-5-Codex]         LOW_RES_MODE = "quality"
01204 [GPT-5-Codex]         RAY_PRESET_INDEX = nearestRayPresetIndex(120)
01205 [GPT-5-Codex]         DRAW_DIST_INDEX = nearestPresetIndex(DRAW_DIST_PRESETS, 16)
01206 [GPT-5-Codex]         FAR_TEX_OFF_INDEX = nearestPresetIndex(FAR_TEX_OFF_PRESETS, 999)
01207 [GPT-5-Codex]         WALL_MIPMAP_ENABLED = true
01208 [GPT-5-Codex]         MIP_LOD_ENABLED = true
01209 [GPT-5-Codex]         FOG_DITHER_SIZE_INDEX = nearestPresetIndex(FOG_DITHER_SIZE_PRESETS, 2)
01210 [GPT-5-Codex]     elseif preset == "PERFORMANCE" then
01211 [GPT-5-Codex]         LOW_RES_MODE = "fast"
01212 [GPT-5-Codex]         RAY_PRESET_INDEX = nearestRayPresetIndex(48)
01213 [GPT-5-Codex]         DRAW_DIST_INDEX = nearestPresetIndex(DRAW_DIST_PRESETS, 8)
01214 [GPT-5-Codex]         FAR_TEX_OFF_INDEX = nearestPresetIndex(FAR_TEX_OFF_PRESETS, 10)
01215 [GPT-5-Codex]         WALL_MIPMAP_ENABLED = true
01216 [GPT-5-Codex]         MIP_LOD_ENABLED = true
01217 [GPT-5-Codex]         FOG_DITHER_SIZE_INDEX = nearestPresetIndex(FOG_DITHER_SIZE_PRESETS, 4)
01218 [GPT-5-Codex]     else
01219 [GPT-5-Codex]         -- BALANCED default
01220 [GPT-5-Codex]         LOW_RES_MODE = "quality"
01221 [GPT-5-Codex]         RAY_PRESET_INDEX = nearestRayPresetIndex(80)
01222 [GPT-5-Codex]         DRAW_DIST_INDEX = nearestPresetIndex(DRAW_DIST_PRESETS, 12)
01223 [GPT-5-Codex]         FAR_TEX_OFF_INDEX = nearestPresetIndex(FAR_TEX_OFF_PRESETS, 10)
01224 [GPT-5-Codex]         WALL_MIPMAP_ENABLED = true
01225 [GPT-5-Codex]         MIP_LOD_ENABLED = true
01226 [GPT-5-Codex]         FOG_DITHER_SIZE_INDEX = nearestPresetIndex(FOG_DITHER_SIZE_PRESETS, 1)
01227 [GPT-5-Codex]     end
01228 [GPT-5-Codex] 
01229 [GPT-5-Codex]     EXP_TEX_MAX_DIST = DRAW_DIST_PRESETS[DRAW_DIST_INDEX]
01230 [GPT-5-Codex]     if FOG_DITHER_SIZE_PRESETS and #FOG_DITHER_SIZE_PRESETS > 0 then
01231 [GPT-5-Codex]         FOG_DITHER_SIZE_INDEX = clampInt(FOG_DITHER_SIZE_INDEX or 1, 1, #FOG_DITHER_SIZE_PRESETS)
01232 [GPT-5-Codex]         FOG_DITHER_SIZE = FOG_DITHER_SIZE_PRESETS[FOG_DITHER_SIZE_INDEX]
01233 [GPT-5-Codex]     end
01234 [GPT-5-Codex]     normalizeFarTextureCutoff()
01235 [GPT-5-Codex]     normalizeMipmapRanges()
01236 [GPT-5-Codex]     refreshExpViewDistance()
01237 [GPT-5-Codex] end
01238 [GPT-5-Codex] 
01239 [GPT-5-Codex] local function getBaseEffectiveRayPresetIndex(baseIdx)
01240 [GPT-5-Codex]     local n = (RAY_PRESETS and #RAY_PRESETS) or 0
01241 [GPT-5-Codex]     if n <= 0 then return 1 end
01242 [GPT-5-Codex]     local idx = clampInt(baseIdx or (RAY_PRESET_INDEX or 1), 1, n)
01243 [GPT-5-Codex]     -- WALL RES mode should always impact rendering quality/perf.
01244 [GPT-5-Codex]     -- FAST mode biases one preset step lower (fewer rays / wider columns).
01245 [GPT-5-Codex]     if LOW_RES_WALLS and LOW_RES_MODE == "fast" and idx > 1 then
01246 [GPT-5-Codex]         idx = idx - 1
01247 [GPT-5-Codex]     end
01248 [GPT-5-Codex]     return idx
01249 [GPT-5-Codex] end
01250 [GPT-5-Codex] 
01251 [GPT-5-Codex] local function getEffectiveRayPresetIndex(baseIdx)
01252 [GPT-5-Codex]     return getBaseEffectiveRayPresetIndex(baseIdx)
01253 [GPT-5-Codex] end
01254 [GPT-5-Codex] 
01255 [GPT-5-Codex] normalizeFogRange()
01256 [GPT-5-Codex] normalizeMipmapRanges()
01257 [GPT-5-Codex] normalizeFarTextureCutoff()
01258 [GPT-5-Codex] refreshExpViewDistance()
01259 [GPT-5-Codex] bootstrapExpansionDataLayer()
01260 [GPT-5-Codex] 
01261 [GPT-5-Codex] local function isExpRenderer()
01262 [GPT-5-Codex]     return true
01263 [GPT-5-Codex] end
01264 [GPT-5-Codex] gameOverSelection = 1  -- 1 = Restart, 2 = Menu, 3 = Quit
01265 [GPT-5-Codex] winSelection = 1  -- 1 = Menu
01266 [GPT-5-Codex] winCooldown = 0   -- Delay before accepting win screen input
01267 [GPT-5-Codex] levelBannerTimer = 0
01268 [GPT-5-Codex] levelBannerMax = 150
01269 [GPT-5-Codex] winBannerTimer = 0
01270 [GPT-5-Codex] winBannerMax = 75
01271 [GPT-5-Codex] loadingTimer = 0
01272 [GPT-5-Codex] loadingMax = 45
01273 [GPT-5-Codex] pendingLevelStart = nil
01274 [GPT-5-Codex] loadingLogCount = 0
01275 [GPT-5-Codex] local function loadingLog(msg)
01276 [GPT-5-Codex]     if not enableBootLogs then return end
01277 [GPT-5-Codex]     if loadingLogCount < 20 then
01278 [GPT-5-Codex]         print(msg)
01279 [GPT-5-Codex]         loadingLogCount = loadingLogCount + 1
01280 [GPT-5-Codex]     end
01281 [GPT-5-Codex] end
01282 [GPT-5-Codex] 
01283 [GPT-5-Codex] -- Debug controls (set to true for sprite testing)
01284 [GPT-5-Codex] DEBUG_DISABLE_ENEMY_AGGRO = false  -- Enemies never chase/attack
01285 [GPT-5-Codex] DEBUG_WALK_IN_PLACE = false       -- Enemies animate walk without moving
01286 [GPT-5-Codex] DEBUG_FORCE_GLOBAL_WALK = false   -- Drive walk frames from global frameCount
01287 [GPT-5-Codex] DEBUG_FORCE_WALK_FRAMES = nil     -- Force 2-frame cycle while walk3 is under review
01288 [GPT-5-Codex] DEBUG_FORCE_SIDE_VIEW = false     -- Always show side view (left/right) for testing
01289 [GPT-5-Codex] DEBUG_FORCE_VIEW = nil            -- Set to 1 (right) or 3 (left) to lock view
01290 [GPT-5-Codex] DEBUG_SHOW_WALK_INFO = false      -- On-screen walk frame debug
01291 [GPT-5-Codex] DEBUG_WALK_OFFSET = false         -- Apply visible offset per frame for debugging
01292 [GPT-5-Codex] DEBUG_CYCLE_VIEW = false          -- Cycle through front/left/back/right for testing
01293 [GPT-5-Codex] DEBUG_CYCLE_VIEW_FRAMES = 45      -- Frames per view (about 1.5s at 30fps)
01294 [GPT-5-Codex] 
01295 [GPT-5-Codex] SPRITE_MAX_DIST = 12
01296 [GPT-5-Codex] SPRITE_MAX_DIST_SQ = SPRITE_MAX_DIST * SPRITE_MAX_DIST
01297 [GPT-5-Codex] SPRITE_VIS_DIST = 6
01298 [GPT-5-Codex] SOLDIER_ACTIVE_DIST = 8
01299 [GPT-5-Codex] SOLDIER_ACTIVE_DIST_SQ = SOLDIER_ACTIVE_DIST * SOLDIER_ACTIVE_DIST
01300 [GPT-5-Codex] ENEMY_RENDER_DIST = 7
01301 [GPT-5-Codex] PROP_RENDER_DIST = 5
01302 [GPT-5-Codex] ITEM_RENDER_DIST = 5
01303 [GPT-5-Codex] ENEMY_RENDER_DIST_SQ = ENEMY_RENDER_DIST * ENEMY_RENDER_DIST
01304 [GPT-5-Codex] PROP_RENDER_DIST_SQ = PROP_RENDER_DIST * PROP_RENDER_DIST
01305 [GPT-5-Codex] ITEM_RENDER_DIST_SQ = ITEM_RENDER_DIST * ITEM_RENDER_DIST
01306 [GPT-5-Codex] 
01307 [GPT-5-Codex] local function isEnemyType(t)
01308 [GPT-5-Codex]     return t == 5 or t == 6
01309 [GPT-5-Codex] end
01310 [GPT-5-Codex] 
01311 [GPT-5-Codex] local function isPropType(t)
01312 [GPT-5-Codex]     return (t and t >= 1 and t <= 4) or t == 7
01313 [GPT-5-Codex] end
01314 [GPT-5-Codex] 
01315 [GPT-5-Codex] -- Enemy health system
01316 [GPT-5-Codex] ENEMY_MAX_HP = 100
01317 [GPT-5-Codex] PLAYER_DAMAGE = 20
01318 [GPT-5-Codex] PLAYER_ATTACK_RANGE = 1.0  -- Distance player can hit enemy
01319 [GPT-5-Codex] soldiersKilled = 0
01320 [GPT-5-Codex] local totalSoldiers = 5
01321 [GPT-5-Codex] 
01322 [GPT-5-Codex] SAVE_SLOT_COUNT = 3
01323 [GPT-5-Codex] SAVE_FILE_PATH = "/sdcard/inner_sanctum/saves.dat"
01324 [GPT-5-Codex] SAVE_FILE_HEADER = "INNER_SANCTUM_SAVE_V1"
01325 [GPT-5-Codex] saveSlots = {}
01326 [GPT-5-Codex] CLASS_FALLBACK_ORDER = {"warrior", "archer", "mage"}
01327 [GPT-5-Codex] CLASS_SELECT_PORTRAIT_PATHS = {
01328 [GPT-5-Codex]     warrior = "sprites/WAARRIOR-CHAR-SELECT-sized",
01329 [GPT-5-Codex]     archer = "sprites/ARCH-CHAR-SELECT-sized",
01330 [GPT-5-Codex]     mage = "sprites/WIZ-CHAR-SELECT-sized",
01331 [GPT-5-Codex] }
01332 [GPT-5-Codex] CLASS_FALLBACKS = {
01333 [GPT-5-Codex]     warrior = {
01334 [GPT-5-Codex]         id = "warrior",
01335 [GPT-5-Codex]         name = "Warrior",
01336 [GPT-5-Codex]         base_hp = 120,
01337 [GPT-5-Codex]         base_damage = 20,
01338 [GPT-5-Codex]         base_speed = 1.0,
01339 [GPT-5-Codex]         primary = "melee",
01340 [GPT-5-Codex]         base_defense = 4.00,
01341 [GPT-5-Codex]         template_stats = {
01342 [GPT-5-Codex]             agility = 4.00,
01343 [GPT-5-Codex]             power = 4.00,
01344 [GPT-5-Codex]             defense = 4.00,
01345 [GPT-5-Codex]             dodge = 4.00,
01346 [GPT-5-Codex]             regen = 4.00,
01347 [GPT-5-Codex]             crit = 4.00,
01348 [GPT-5-Codex]             atk_speed = 4.00,
01349 [GPT-5-Codex]             shield_bonus = 4.00,
01350 [GPT-5-Codex]         },
01351 [GPT-5-Codex]         growth = {hp = 8, damage = 2, speed = 0.0},
01352 [GPT-5-Codex]     },
01353 [GPT-5-Codex]     archer = {
01354 [GPT-5-Codex]         id = "archer",
01355 [GPT-5-Codex]         name = "Archer",
01356 [GPT-5-Codex]         base_hp = 90,
01357 [GPT-5-Codex]         base_damage = 14,
01358 [GPT-5-Codex]         base_speed = 1.15,
01359 [GPT-5-Codex]         primary = "ranged",
01360 [GPT-5-Codex]         base_defense = 2.50,
01361 [GPT-5-Codex]         template_stats = {
01362 [GPT-5-Codex]             agility = 5.50,
01363 [GPT-5-Codex]             power = 3.75,
01364 [GPT-5-Codex]             defense = 2.50,
01365 [GPT-5-Codex]             dodge = 5.00,
01366 [GPT-5-Codex]             regen = 2.50,
01367 [GPT-5-Codex]             crit = 3.50,
01368 [GPT-5-Codex]             atk_speed = 5.50,
01369 [GPT-5-Codex]             shield_bonus = 2.00,
01370 [GPT-5-Codex]         },
01371 [GPT-5-Codex]         growth = {hp = 5, damage = 2, speed = 0.01},
01372 [GPT-5-Codex]     },
01373 [GPT-5-Codex]     mage = {
01374 [GPT-5-Codex]         id = "mage",
01375 [GPT-5-Codex]         name = "Mage",
01376 [GPT-5-Codex]         base_hp = 80,
01377 [GPT-5-Codex]         base_damage = 18,
01378 [GPT-5-Codex]         base_speed = 1.05,
01379 [GPT-5-Codex]         primary = "magic",
01380 [GPT-5-Codex]         base_defense = 2.25,
01381 [GPT-5-Codex]         template_stats = {
01382 [GPT-5-Codex]             agility = 2.75,
01383 [GPT-5-Codex]             power = 5.75,
01384 [GPT-5-Codex]             defense = 2.25,
01385 [GPT-5-Codex]             dodge = 2.50,
01386 [GPT-5-Codex]             regen = 2.25,
01387 [GPT-5-Codex]             crit = 5.25,
01388 [GPT-5-Codex]             atk_speed = 2.75,
01389 [GPT-5-Codex]             shield_bonus = 1.75,
01390 [GPT-5-Codex]         },
01391 [GPT-5-Codex]         growth = {hp = 4, damage = 3, speed = 0.0},
01392 [GPT-5-Codex]     },
01393 [GPT-5-Codex] }
01394 [GPT-5-Codex] 
01395 [GPT-5-Codex] function getClassDefById(classId)
01396 [GPT-5-Codex]     local fallbackId = CLASS_FALLBACK_ORDER[1] or "warrior"
01397 [GPT-5-Codex]     if getGameClass then
01398 [GPT-5-Codex]         local classDef = getGameClass(classId or fallbackId)
01399 [GPT-5-Codex]         if classDef and classDef.id then
01400 [GPT-5-Codex]             return classDef
01401 [GPT-5-Codex]         end
01402 [GPT-5-Codex]     end
01403 [GPT-5-Codex]     local id = classId or fallbackId
01404 [GPT-5-Codex]     if not CLASS_FALLBACKS[id] then
01405 [GPT-5-Codex]         id = fallbackId
01406 [GPT-5-Codex]     end
01407 [GPT-5-Codex]     return CLASS_FALLBACKS[id]
01408 [GPT-5-Codex] end
01409 [GPT-5-Codex] 
01410 [GPT-5-Codex] function getClassOrder()
01411 [GPT-5-Codex]     if GameClassOrder and #GameClassOrder > 1 then
01412 [GPT-5-Codex]         return GameClassOrder
01413 [GPT-5-Codex]     end
01414 [GPT-5-Codex]     return CLASS_FALLBACK_ORDER
01415 [GPT-5-Codex] end
01416 [GPT-5-Codex] 
01417 [GPT-5-Codex] function sanitizeClassId(classId)
01418 [GPT-5-Codex]     local classDef = getClassDefById(classId)
01419 [GPT-5-Codex]     if classDef and classDef.id then
01420 [GPT-5-Codex]         return classDef.id
01421 [GPT-5-Codex]     end
01422 [GPT-5-Codex]     return CLASS_FALLBACK_ORDER[1] or "warrior"
01423 [GPT-5-Codex] end
01424 [GPT-5-Codex] 
01425 [GPT-5-Codex] function getCurrentClassId()
01426 [GPT-5-Codex]     if player_build_state and player_build_state.class_id then
01427 [GPT-5-Codex]         return sanitizeClassId(player_build_state.class_id)
01428 [GPT-5-Codex]     end
01429 [GPT-5-Codex]     return sanitizeClassId(nil)
01430 [GPT-5-Codex] end
01431 [GPT-5-Codex] 
01432 [GPT-5-Codex] function setCurrentClassId(classId)
01433 [GPT-5-Codex]     local normalized = sanitizeClassId(classId)
01434 [GPT-5-Codex]     if not player_build_state then
01435 [GPT-5-Codex]         player_build_state = {}
01436 [GPT-5-Codex]     end
01437 [GPT-5-Codex]     player_build_state.class_id = normalized
01438 [GPT-5-Codex]     return normalized
01439 [GPT-5-Codex] end
01440 [GPT-5-Codex] 
01441 [GPT-5-Codex] function getClassName(classId)
01442 [GPT-5-Codex]     local classDef = getClassDefById(classId)
01443 [GPT-5-Codex]     if classDef and classDef.name then
01444 [GPT-5-Codex]         return classDef.name
01445 [GPT-5-Codex]     end
01446 [GPT-5-Codex]     return "Warrior"
01447 [GPT-5-Codex] end
01448 [GPT-5-Codex] 
01449 [GPT-5-Codex] function getClassTemplateStats(classId, classDef)
01450 [GPT-5-Codex]     local source = classDef or getClassDefById(classId)
01451 [GPT-5-Codex]     if source and source.template_stats then
01452 [GPT-5-Codex]         return source.template_stats
01453 [GPT-5-Codex]     end
01454 [GPT-5-Codex]     local fallbackId = sanitizeClassId(classId)
01455 [GPT-5-Codex]     local fallbackDef = CLASS_FALLBACKS[fallbackId] or CLASS_FALLBACKS[CLASS_FALLBACK_ORDER[1] or "warrior"]
01456 [GPT-5-Codex]     if fallbackDef and fallbackDef.template_stats then
01457 [GPT-5-Codex]         return fallbackDef.template_stats
01458 [GPT-5-Codex]     end
01459 [GPT-5-Codex]     return {
01460 [GPT-5-Codex]         agility = 4.00,
01461 [GPT-5-Codex]         power = 4.00,
01462 [GPT-5-Codex]         defense = 4.00,
01463 [GPT-5-Codex]         dodge = 4.00,
01464 [GPT-5-Codex]         regen = 4.00,
01465 [GPT-5-Codex]         crit = 4.00,
01466 [GPT-5-Codex]         atk_speed = 4.00,
01467 [GPT-5-Codex]         shield_bonus = 4.00,
01468 [GPT-5-Codex]     }
01469 [GPT-5-Codex] end
01470 [GPT-5-Codex] 
01471 [GPT-5-Codex] function getClassSelectionIndexForId(classId)
01472 [GPT-5-Codex]     local order = getClassOrder()
01473 [GPT-5-Codex]     local normalized = sanitizeClassId(classId)
01474 [GPT-5-Codex]     for i = 1, #order do
01475 [GPT-5-Codex]         if order[i] == normalized then
01476 [GPT-5-Codex]             return i
01477 [GPT-5-Codex]         end
01478 [GPT-5-Codex]     end
01479 [GPT-5-Codex]     return 1
01480 [GPT-5-Codex] end
01481 [GPT-5-Codex] 
01482 [GPT-5-Codex] function getClassIdForSelection(index)
01483 [GPT-5-Codex]     local order = getClassOrder()
01484 [GPT-5-Codex]     local count = #order
01485 [GPT-5-Codex]     if count <= 0 then
01486 [GPT-5-Codex]         return "warrior", 1, 1
01487 [GPT-5-Codex]     end
01488 [GPT-5-Codex]     local idx = math.floor(index or 1)
01489 [GPT-5-Codex]     if idx < 1 then idx = count end
01490 [GPT-5-Codex]     if idx > count then idx = 1 end
01491 [GPT-5-Codex]     return order[idx], idx, count
01492 [GPT-5-Codex] end
01493 [GPT-5-Codex] 
01494 [GPT-5-Codex] function toNumber(value, fallback)
01495 [GPT-5-Codex]     local n = tonumber(value)
01496 [GPT-5-Codex]     if n == nil then
01497 [GPT-5-Codex]         return fallback
01498 [GPT-5-Codex]     end
01499 [GPT-5-Codex]     return n
01500 [GPT-5-Codex] end
01501 [GPT-5-Codex] 
01502 [GPT-5-Codex] function splitByPlain(input, separator)
01503 [GPT-5-Codex]     local out = {}
01504 [GPT-5-Codex]     if input == nil then
01505 [GPT-5-Codex]         return out
01506 [GPT-5-Codex]     end
01507 [GPT-5-Codex]     local text = tostring(input)
01508 [GPT-5-Codex]     local sep = separator or ","
01509 [GPT-5-Codex]     if sep == "" then
01510 [GPT-5-Codex]         out[1] = text
01511 [GPT-5-Codex]         return out
01512 [GPT-5-Codex]     end
01513 [GPT-5-Codex]     local start = 1
01514 [GPT-5-Codex]     while true do
01515 [GPT-5-Codex]         local idx = string.find(text, sep, start, true)
01516 [GPT-5-Codex]         if not idx then
01517 [GPT-5-Codex]             out[#out + 1] = string.sub(text, start)
01518 [GPT-5-Codex]             break
01519 [GPT-5-Codex]         end
01520 [GPT-5-Codex]         out[#out + 1] = string.sub(text, start, idx - 1)
01521 [GPT-5-Codex]         start = idx + #sep
01522 [GPT-5-Codex]     end
01523 [GPT-5-Codex]     return out
01524 [GPT-5-Codex] end
01525 [GPT-5-Codex] 
01526 [GPT-5-Codex] function sanitizeSaveToken(value)
01527 [GPT-5-Codex]     local text = tostring(value or "")
01528 [GPT-5-Codex]     text = string.gsub(text, "\r", "")
01529 [GPT-5-Codex]     text = string.gsub(text, "\n", "")
01530 [GPT-5-Codex]     text = string.gsub(text, "|", "")
01531 [GPT-5-Codex]     return text
01532 [GPT-5-Codex] end
01533 [GPT-5-Codex] 
01534 [GPT-5-Codex] function makeEmptySaveSlot(slotIndex)
01535 [GPT-5-Codex]     return {
01536 [GPT-5-Codex]         slot = slotIndex or 1,
01537 [GPT-5-Codex]         used = false,
01538 [GPT-5-Codex]         level_id = 1,
01539 [GPT-5-Codex]         class_id = sanitizeClassId(nil),
01540 [GPT-5-Codex]         player_x = 2.5,
01541 [GPT-5-Codex]         player_y = 2.5,
01542 [GPT-5-Codex]         player_dir = 0,
01543 [GPT-5-Codex]         player_health = MAX_HEALTH or 100,
01544 [GPT-5-Codex]         soldiers_killed = 0,
01545 [GPT-5-Codex]         total_soldiers = 0,
01546 [GPT-5-Codex]         enemy_state = "",
01547 [GPT-5-Codex]         potion_state = "",
01548 [GPT-5-Codex]     }
01549 [GPT-5-Codex] end
01550 [GPT-5-Codex] 
01551 [GPT-5-Codex] function copySaveSlot(slot)
01552 [GPT-5-Codex]     local src = slot or makeEmptySaveSlot(1)
01553 [GPT-5-Codex]     return {
01554 [GPT-5-Codex]         slot = src.slot,
01555 [GPT-5-Codex]         used = src.used and true or false,
01556 [GPT-5-Codex]         level_id = src.level_id,
01557 [GPT-5-Codex]         class_id = src.class_id,
01558 [GPT-5-Codex]         player_x = src.player_x,
01559 [GPT-5-Codex]         player_y = src.player_y,
01560 [GPT-5-Codex]         player_dir = src.player_dir,
01561 [GPT-5-Codex]         player_health = src.player_health,
01562 [GPT-5-Codex]         soldiers_killed = src.soldiers_killed,
01563 [GPT-5-Codex]         total_soldiers = src.total_soldiers,
01564 [GPT-5-Codex]         enemy_state = src.enemy_state,
01565 [GPT-5-Codex]         potion_state = src.potion_state,
01566 [GPT-5-Codex]     }
01567 [GPT-5-Codex] end
01568 [GPT-5-Codex] 
01569 [GPT-5-Codex] function normalizeSaveSlots()
01570 [GPT-5-Codex]     for i = 1, SAVE_SLOT_COUNT do
01571 [GPT-5-Codex]         local slot = saveSlots[i]
01572 [GPT-5-Codex]         if not slot then
01573 [GPT-5-Codex]             slot = makeEmptySaveSlot(i)
01574 [GPT-5-Codex]         else
01575 [GPT-5-Codex]             slot = copySaveSlot(slot)
01576 [GPT-5-Codex]             slot.slot = i
01577 [GPT-5-Codex]             slot.used = slot.used and true or false
01578 [GPT-5-Codex]             slot.level_id = math.floor(toNumber(slot.level_id, 1))
01579 [GPT-5-Codex]             if not LEVELS[slot.level_id] then
01580 [GPT-5-Codex]                 slot.level_id = 1
01581 [GPT-5-Codex]             end
01582 [GPT-5-Codex]             slot.class_id = sanitizeClassId(slot.class_id)
01583 [GPT-5-Codex]             slot.player_x = toNumber(slot.player_x, 2.5)
01584 [GPT-5-Codex]             slot.player_y = toNumber(slot.player_y, 2.5)
01585 [GPT-5-Codex]             slot.player_dir = math.floor(toNumber(slot.player_dir, 0)) % 64
01586 [GPT-5-Codex]             slot.player_health = math.floor(toNumber(slot.player_health, MAX_HEALTH or 100))
01587 [GPT-5-Codex]             if slot.player_health < 1 then slot.player_health = 1 end
01588 [GPT-5-Codex]             if slot.player_health > (MAX_HEALTH or 100) then slot.player_health = (MAX_HEALTH or 100) end
01589 [GPT-5-Codex]             slot.soldiers_killed = math.floor(toNumber(slot.soldiers_killed, 0))
01590 [GPT-5-Codex]             if slot.soldiers_killed < 0 then slot.soldiers_killed = 0 end
01591 [GPT-5-Codex]             slot.total_soldiers = math.floor(toNumber(slot.total_soldiers, 0))
01592 [GPT-5-Codex]             if slot.total_soldiers < 0 then slot.total_soldiers = 0 end
01593 [GPT-5-Codex]             slot.enemy_state = tostring(slot.enemy_state or "")
01594 [GPT-5-Codex]             slot.potion_state = tostring(slot.potion_state or "")
01595 [GPT-5-Codex]         end
01596 [GPT-5-Codex]         saveSlots[i] = slot
01597 [GPT-5-Codex]     end
01598 [GPT-5-Codex] end
01599 [GPT-5-Codex] 
01600 [GPT-5-Codex] function serializeSaveSlots()
01601 [GPT-5-Codex]     normalizeSaveSlots()
01602 [GPT-5-Codex]     local lines = {SAVE_FILE_HEADER}
01603 [GPT-5-Codex]     for i = 1, SAVE_SLOT_COUNT do
01604 [GPT-5-Codex]         local slot = saveSlots[i] or makeEmptySaveSlot(i)
01605 [GPT-5-Codex]         lines[#lines + 1] = table.concat({
01606 [GPT-5-Codex]             tostring(i),
01607 [GPT-5-Codex]             slot.used and "1" or "0",
01608 [GPT-5-Codex]             tostring(slot.level_id or 1),
01609 [GPT-5-Codex]             sanitizeSaveToken(slot.class_id or "warrior"),
01610 [GPT-5-Codex]             string.format("%.4f", toNumber(slot.player_x, 2.5)),
01611 [GPT-5-Codex]             string.format("%.4f", toNumber(slot.player_y, 2.5)),
01612 [GPT-5-Codex]             tostring(math.floor(toNumber(slot.player_dir, 0)) % 64),
01613 [GPT-5-Codex]             tostring(math.floor(toNumber(slot.player_health, MAX_HEALTH or 100))),
01614 [GPT-5-Codex]             tostring(math.floor(toNumber(slot.soldiers_killed, 0))),
01615 [GPT-5-Codex]             tostring(math.floor(toNumber(slot.total_soldiers, 0))),
01616 [GPT-5-Codex]             sanitizeSaveToken(slot.enemy_state or ""),
01617 [GPT-5-Codex]             sanitizeSaveToken(slot.potion_state or ""),
01618 [GPT-5-Codex]         }, "|")
01619 [GPT-5-Codex]     end
01620 [GPT-5-Codex]     return table.concat(lines, "\n")
01621 [GPT-5-Codex] end
01622 [GPT-5-Codex] 
01623 [GPT-5-Codex] function deserializeSaveSlots(payload)
01624 [GPT-5-Codex]     if not payload or payload == "" then
01625 [GPT-5-Codex]         return false, "empty_payload"
01626 [GPT-5-Codex]     end
01627 [GPT-5-Codex] 
01628 [GPT-5-Codex]     local normalized = string.gsub(tostring(payload), "\r", "")
01629 [GPT-5-Codex]     local lines = {}
01630 [GPT-5-Codex]     for line in string.gmatch(normalized, "([^\n]+)") do
01631 [GPT-5-Codex]         if line and line ~= "" then
01632 [GPT-5-Codex]             lines[#lines + 1] = line
01633 [GPT-5-Codex]         end
01634 [GPT-5-Codex]     end
01635 [GPT-5-Codex]     if #lines == 0 then
01636 [GPT-5-Codex]         return false, "empty_lines"
01637 [GPT-5-Codex]     end
01638 [GPT-5-Codex]     if lines[1] ~= SAVE_FILE_HEADER then
01639 [GPT-5-Codex]         return false, "invalid_header"
01640 [GPT-5-Codex]     end
01641 [GPT-5-Codex] 
01642 [GPT-5-Codex]     saveSlots = {}
01643 [GPT-5-Codex]     for i = 2, #lines do
01644 [GPT-5-Codex]         local parts = splitByPlain(lines[i], "|")
01645 [GPT-5-Codex]         if #parts >= 12 then
01646 [GPT-5-Codex]             local slotIndex = math.floor(toNumber(parts[1], 0))
01647 [GPT-5-Codex]             if slotIndex >= 1 and slotIndex <= SAVE_SLOT_COUNT then
01648 [GPT-5-Codex]                 saveSlots[slotIndex] = {
01649 [GPT-5-Codex]                     slot = slotIndex,
01650 [GPT-5-Codex]                     used = (toNumber(parts[2], 0) ~= 0),
01651 [GPT-5-Codex]                     level_id = math.floor(toNumber(parts[3], 1)),
01652 [GPT-5-Codex]                     class_id = sanitizeClassId(parts[4]),
01653 [GPT-5-Codex]                     player_x = toNumber(parts[5], 2.5),
01654 [GPT-5-Codex]                     player_y = toNumber(parts[6], 2.5),
01655 [GPT-5-Codex]                     player_dir = math.floor(toNumber(parts[7], 0)) % 64,
01656 [GPT-5-Codex]                     player_health = math.floor(toNumber(parts[8], MAX_HEALTH or 100)),
01657 [GPT-5-Codex]                     soldiers_killed = math.floor(toNumber(parts[9], 0)),
01658 [GPT-5-Codex]                     total_soldiers = math.floor(toNumber(parts[10], 0)),
01659 [GPT-5-Codex]                     enemy_state = parts[11] or "",
01660 [GPT-5-Codex]                     potion_state = parts[12] or "",
01661 [GPT-5-Codex]                 }
01662 [GPT-5-Codex]             end
01663 [GPT-5-Codex]         end
01664 [GPT-5-Codex]     end
01665 [GPT-5-Codex] 
01666 [GPT-5-Codex]     normalizeSaveSlots()
01667 [GPT-5-Codex]     return true, nil
01668 [GPT-5-Codex] end
01669 [GPT-5-Codex] 
01670 [GPT-5-Codex] function hasFileApi()
01671 [GPT-5-Codex]     return vmupro and vmupro.file and vmupro.file.read and vmupro.file.write
01672 [GPT-5-Codex] end
01673 [GPT-5-Codex] 
01674 [GPT-5-Codex] function writeSaveSlotsToDisk()
01675 [GPT-5-Codex]     normalizeSaveSlots()
01676 [GPT-5-Codex]     if not hasFileApi() then
01677 [GPT-5-Codex]         return false, "file_api_unavailable"
01678 [GPT-5-Codex]     end
01679 [GPT-5-Codex] 
01680 [GPT-5-Codex]     if vmupro.file.folderExists and vmupro.file.createFolder then
01681 [GPT-5-Codex]         if not vmupro.file.folderExists("/sdcard/inner_sanctum") then
01682 [GPT-5-Codex]             local created = vmupro.file.createFolder("/sdcard/inner_sanctum")
01683 [GPT-5-Codex]             if not created then
01684 [GPT-5-Codex]                 return false, "create_folder_failed"
01685 [GPT-5-Codex]             end
01686 [GPT-5-Codex]         end
01687 [GPT-5-Codex]     end
01688 [GPT-5-Codex] 
01689 [GPT-5-Codex]     if vmupro.file.exists and vmupro.file.createFile and (not vmupro.file.exists(SAVE_FILE_PATH)) then
01690 [GPT-5-Codex]         vmupro.file.createFile(SAVE_FILE_PATH)
01691 [GPT-5-Codex]     end
01692 [GPT-5-Codex] 
01693 [GPT-5-Codex]     local encoded = serializeSaveSlots()
01694 [GPT-5-Codex]     local okWrite = vmupro.file.write(SAVE_FILE_PATH, encoded)
01695 [GPT-5-Codex]     if not okWrite then
01696 [GPT-5-Codex]         return false, "write_failed"
01697 [GPT-5-Codex]     end
01698 [GPT-5-Codex]     return true, nil
01699 [GPT-5-Codex] end
01700 [GPT-5-Codex] 
01701 [GPT-5-Codex] function loadSaveSlotsFromDisk()
01702 [GPT-5-Codex]     normalizeSaveSlots()
01703 [GPT-5-Codex]     if not hasFileApi() then
01704 [GPT-5-Codex]         return false, "file_api_unavailable"
01705 [GPT-5-Codex]     end
01706 [GPT-5-Codex]     if vmupro.file.exists and (not vmupro.file.exists(SAVE_FILE_PATH)) then
01707 [GPT-5-Codex]         return false, "missing_file"
01708 [GPT-5-Codex]     end
01709 [GPT-5-Codex]     local payload = vmupro.file.read(SAVE_FILE_PATH)
01710 [GPT-5-Codex]     if not payload or payload == "" then
01711 [GPT-5-Codex]         return false, "read_failed"
01712 [GPT-5-Codex]     end
01713 [GPT-5-Codex]     return deserializeSaveSlots(payload)
01714 [GPT-5-Codex] end
01715 [GPT-5-Codex] 
01716 [GPT-5-Codex] function getSaveSlotSummary(slotIndex)
01717 [GPT-5-Codex]     normalizeSaveSlots()
01718 [GPT-5-Codex]     local idx = math.floor(toNumber(slotIndex, 1))
01719 [GPT-5-Codex]     if idx < 1 then idx = 1 end
01720 [GPT-5-Codex]     if idx > SAVE_SLOT_COUNT then idx = SAVE_SLOT_COUNT end
01721 [GPT-5-Codex]     local slot = saveSlots[idx] or makeEmptySaveSlot(idx)
01722 [GPT-5-Codex]     if not slot.used then
01723 [GPT-5-Codex]         return "SLOT " .. tostring(idx), "EMPTY"
01724 [GPT-5-Codex]     end
01725 [GPT-5-Codex]     local levelLabel = getLevelLabel(slot.level_id or 1)
01726 [GPT-5-Codex]     local classLabel = string.upper(getClassName(slot.class_id))
01727 [GPT-5-Codex]     return "SLOT " .. tostring(idx), "LEVEL " .. tostring(levelLabel) .. "  " .. classLabel
01728 [GPT-5-Codex] end
01729 [GPT-5-Codex] 
01730 [GPT-5-Codex] function countEnemiesInSprites()
01731 [GPT-5-Codex]     if not sprites then return 0 end
01732 [GPT-5-Codex]     local total = 0
01733 [GPT-5-Codex]     for i = 1, #sprites do
01734 [GPT-5-Codex]         local s = sprites[i]
01735 [GPT-5-Codex]         if s and isEnemyType(s.t) then
01736 [GPT-5-Codex]             total = total + 1
01737 [GPT-5-Codex]         end
01738 [GPT-5-Codex]     end
01739 [GPT-5-Codex]     return total
01740 [GPT-5-Codex] end
01741 [GPT-5-Codex] 
01742 [GPT-5-Codex] function countDeadEnemiesInSprites()
01743 [GPT-5-Codex]     if not sprites then return 0 end
01744 [GPT-5-Codex]     local total = 0
01745 [GPT-5-Codex]     for i = 1, #sprites do
01746 [GPT-5-Codex]         local s = sprites[i]
01747 [GPT-5-Codex]         if s and isEnemyType(s.t) and (s.alive == false or s.dead == true) then
01748 [GPT-5-Codex]             total = total + 1
01749 [GPT-5-Codex]         end
01750 [GPT-5-Codex]     end
01751 [GPT-5-Codex]     return total
01752 [GPT-5-Codex] end
01753 [GPT-5-Codex] 
01754 [GPT-5-Codex] function buildEnemyStateSnapshot()
01755 [GPT-5-Codex]     if not sprites then
01756 [GPT-5-Codex]         return ""
01757 [GPT-5-Codex]     end
01758 [GPT-5-Codex]     local entries = {}
01759 [GPT-5-Codex]     for i = 1, #sprites do
01760 [GPT-5-Codex]         local s = sprites[i]
01761 [GPT-5-Codex]         if s and isEnemyType(s.t) then
01762 [GPT-5-Codex]             local alive = 1
01763 [GPT-5-Codex]             if s.alive == false or s.dead == true then
01764 [GPT-5-Codex]                 alive = 0
01765 [GPT-5-Codex]             end
01766 [GPT-5-Codex]             local hp = math.floor(toNumber(s.hp, ENEMY_MAX_HP))
01767 [GPT-5-Codex]             if hp < 0 then hp = 0 end
01768 [GPT-5-Codex]             entries[#entries + 1] = tostring(alive) .. ":" .. tostring(hp)
01769 [GPT-5-Codex]         end
01770 [GPT-5-Codex]     end
01771 [GPT-5-Codex]     return table.concat(entries, ";")
01772 [GPT-5-Codex] end
01773 [GPT-5-Codex] 
01774 [GPT-5-Codex] function buildPotionStateSnapshot()
01775 [GPT-5-Codex]     if not sprites then
01776 [GPT-5-Codex]         return ""
01777 [GPT-5-Codex]     end
01778 [GPT-5-Codex]     local entries = {}
01779 [GPT-5-Codex]     for i = 1, #sprites do
01780 [GPT-5-Codex]         local s = sprites[i]
01781 [GPT-5-Codex]         if s and s.t == 7 then
01782 [GPT-5-Codex]             entries[#entries + 1] = s.collected and "1" or "0"
01783 [GPT-5-Codex]         end
01784 [GPT-5-Codex]     end
01785 [GPT-5-Codex]     return table.concat(entries, ";")
01786 [GPT-5-Codex] end
01787 [GPT-5-Codex] 
01788 [GPT-5-Codex] function applyEnemyStateSnapshot(snapshot)
01789 [GPT-5-Codex]     if not sprites then
01790 [GPT-5-Codex]         return 0
01791 [GPT-5-Codex]     end
01792 [GPT-5-Codex]     local entries = splitByPlain(snapshot or "", ";")
01793 [GPT-5-Codex]     local enemyIdx = 1
01794 [GPT-5-Codex]     local deadCount = 0
01795 [GPT-5-Codex]     for i = 1, #sprites do
01796 [GPT-5-Codex]         local s = sprites[i]
01797 [GPT-5-Codex]         if s and isEnemyType(s.t) then
01798 [GPT-5-Codex]             local entry = entries[enemyIdx] or ""
01799 [GPT-5-Codex]             if entry ~= "" then
01800 [GPT-5-Codex]                 local pair = splitByPlain(entry, ":")
01801 [GPT-5-Codex]                 local aliveFlag = toNumber(pair[1], 1)
01802 [GPT-5-Codex]                 local hpValue = math.floor(toNumber(pair[2], s.hp or ENEMY_MAX_HP))
01803 [GPT-5-Codex]                 if hpValue < 0 then hpValue = 0 end
01804 [GPT-5-Codex]                 if hpValue > 300 then hpValue = 300 end
01805 [GPT-5-Codex]                 if aliveFlag ~= 0 and hpValue > 0 then
01806 [GPT-5-Codex]                     s.alive = true
01807 [GPT-5-Codex]                     s.dead = false
01808 [GPT-5-Codex]                     s.dying = false
01809 [GPT-5-Codex]                     s.hp = hpValue
01810 [GPT-5-Codex]                 else
01811 [GPT-5-Codex]                     s.alive = false
01812 [GPT-5-Codex]                     s.dead = true
01813 [GPT-5-Codex]                     s.dying = false
01814 [GPT-5-Codex]                     s.hp = 0
01815 [GPT-5-Codex]                     deadCount = deadCount + 1
01816 [GPT-5-Codex]                 end
01817 [GPT-5-Codex]                 s.attackAnim = 0
01818 [GPT-5-Codex]                 s.attackFrame = 1
01819 [GPT-5-Codex]                 s.attackDidHit = false
01820 [GPT-5-Codex]                 s.state = nil
01821 [GPT-5-Codex]                 s.deathFrame = nil
01822 [GPT-5-Codex]                 s.deathTick = nil
01823 [GPT-5-Codex]             elseif s.alive == false or s.dead == true then
01824 [GPT-5-Codex]                 deadCount = deadCount + 1
01825 [GPT-5-Codex]             end
01826 [GPT-5-Codex]             enemyIdx = enemyIdx + 1
01827 [GPT-5-Codex]         end
01828 [GPT-5-Codex]     end
01829 [GPT-5-Codex]     return deadCount
01830 [GPT-5-Codex] end
01831 [GPT-5-Codex] 
01832 [GPT-5-Codex] function applyPotionStateSnapshot(snapshot)
01833 [GPT-5-Codex]     if not sprites then
01834 [GPT-5-Codex]         return
01835 [GPT-5-Codex]     end
01836 [GPT-5-Codex]     local entries = splitByPlain(snapshot or "", ";")
01837 [GPT-5-Codex]     local potionIdx = 1
01838 [GPT-5-Codex]     for i = 1, #sprites do
01839 [GPT-5-Codex]         local s = sprites[i]
01840 [GPT-5-Codex]         if s and s.t == 7 then
01841 [GPT-5-Codex]             local entry = entries[potionIdx] or ""
01842 [GPT-5-Codex]             if entry ~= "" then
01843 [GPT-5-Codex]                 s.collected = (toNumber(entry, 0) ~= 0)
01844 [GPT-5-Codex]             end
01845 [GPT-5-Codex]             potionIdx = potionIdx + 1
01846 [GPT-5-Codex]         end
01847 [GPT-5-Codex]     end
01848 [GPT-5-Codex] end
01849 [GPT-5-Codex] 
01850 [GPT-5-Codex] function captureCurrentSaveSlot(slotIndex)
01851 [GPT-5-Codex]     local slot = makeEmptySaveSlot(slotIndex)
01852 [GPT-5-Codex]     slot.used = true
01853 [GPT-5-Codex]     slot.level_id = currentLevel or 1
01854 [GPT-5-Codex]     if not LEVELS[slot.level_id] then
01855 [GPT-5-Codex]         slot.level_id = 1
01856 [GPT-5-Codex]     end
01857 [GPT-5-Codex]     slot.class_id = getCurrentClassId()
01858 [GPT-5-Codex]     slot.player_x = toNumber(px, 2.5)
01859 [GPT-5-Codex]     slot.player_y = toNumber(py, 2.5)
01860 [GPT-5-Codex]     slot.player_dir = math.floor(toNumber(pdir, 0)) % 64
01861 [GPT-5-Codex]     slot.player_health = math.floor(toNumber(playerHealth, MAX_HEALTH or 100))
01862 [GPT-5-Codex]     if slot.player_health < 1 then slot.player_health = 1 end
01863 [GPT-5-Codex]     if slot.player_health > (MAX_HEALTH or 100) then slot.player_health = (MAX_HEALTH or 100) end
01864 [GPT-5-Codex]     slot.enemy_state = buildEnemyStateSnapshot()
01865 [GPT-5-Codex]     slot.potion_state = buildPotionStateSnapshot()
01866 [GPT-5-Codex]     slot.total_soldiers = countEnemiesInSprites()
01867 [GPT-5-Codex]     local observedKilled = countDeadEnemiesInSprites()
01868 [GPT-5-Codex]     local trackedKilled = math.floor(toNumber(soldiersKilled, 0))
01869 [GPT-5-Codex]     if trackedKilled < observedKilled then
01870 [GPT-5-Codex]         trackedKilled = observedKilled
01871 [GPT-5-Codex]     end
01872 [GPT-5-Codex]     if trackedKilled < 0 then trackedKilled = 0 end
01873 [GPT-5-Codex]     if trackedKilled > slot.total_soldiers then trackedKilled = slot.total_soldiers end
01874 [GPT-5-Codex]     slot.soldiers_killed = trackedKilled
01875 [GPT-5-Codex]     return slot
01876 [GPT-5-Codex] end
01877 [GPT-5-Codex] 
01878 [GPT-5-Codex] function saveGameToSlot(slotIndex)
01879 [GPT-5-Codex]     local idx = math.floor(toNumber(slotIndex, 1))
01880 [GPT-5-Codex]     if idx < 1 or idx > SAVE_SLOT_COUNT then
01881 [GPT-5-Codex]         return false, "invalid_slot"
01882 [GPT-5-Codex]     end
01883 [GPT-5-Codex]     normalizeSaveSlots()
01884 [GPT-5-Codex]     saveSlots[idx] = captureCurrentSaveSlot(idx)
01885 [GPT-5-Codex]     local okWrite, errWrite = writeSaveSlotsToDisk()
01886 [GPT-5-Codex]     if not okWrite and errWrite ~= "file_api_unavailable" then
01887 [GPT-5-Codex]         return false, errWrite
01888 [GPT-5-Codex]     end
01889 [GPT-5-Codex]     return true, nil
01890 [GPT-5-Codex] end
01891 [GPT-5-Codex] 
01892 [GPT-5-Codex] function loadGameFromSlot(slotIndex)
01893 [GPT-5-Codex]     local idx = math.floor(toNumber(slotIndex, 1))
01894 [GPT-5-Codex]     if idx < 1 or idx > SAVE_SLOT_COUNT then
01895 [GPT-5-Codex]         return false, "invalid_slot"
01896 [GPT-5-Codex]     end
01897 [GPT-5-Codex]     normalizeSaveSlots()
01898 [GPT-5-Codex]     local slot = saveSlots[idx]
01899 [GPT-5-Codex]     if not slot or not slot.used then
01900 [GPT-5-Codex]         return false, "empty_slot"
01901 [GPT-5-Codex]     end
01902 [GPT-5-Codex]     local levelId = math.floor(toNumber(slot.level_id, 1))
01903 [GPT-5-Codex]     if not LEVELS[levelId] then
01904 [GPT-5-Codex]         return false, "invalid_level"
01905 [GPT-5-Codex]     end
01906 [GPT-5-Codex] 
01907 [GPT-5-Codex]     beginLoadLevel(levelId)
01908 [GPT-5-Codex]     setCurrentClassId(slot.class_id)
01909 [GPT-5-Codex] 
01910 [GPT-5-Codex]     px = toNumber(slot.player_x, px or 2.5)
01911 [GPT-5-Codex]     py = toNumber(slot.player_y, py or 2.5)
01912 [GPT-5-Codex]     pdir = math.floor(toNumber(slot.player_dir, pdir or 0)) % 64
01913 [GPT-5-Codex]     lastSafeWallX = px
01914 [GPT-5-Codex]     lastSafeWallY = py
01915 [GPT-5-Codex] 
01916 [GPT-5-Codex]     playerHealth = math.floor(toNumber(slot.player_health, MAX_HEALTH or 100))
01917 [GPT-5-Codex]     if playerHealth < 1 then playerHealth = 1 end
01918 [GPT-5-Codex]     if playerHealth > (MAX_HEALTH or 100) then playerHealth = (MAX_HEALTH or 100) end
01919 [GPT-5-Codex] 
01920 [GPT-5-Codex]     local restoredDead = applyEnemyStateSnapshot(slot.enemy_state)
01921 [GPT-5-Codex]     applyPotionStateSnapshot(slot.potion_state)
01922 [GPT-5-Codex]     totalSoldiers = countEnemiesInSprites()
01923 [GPT-5-Codex]     local savedKilled = math.floor(toNumber(slot.soldiers_killed, restoredDead))
01924 [GPT-5-Codex]     if savedKilled < restoredDead then savedKilled = restoredDead end
01925 [GPT-5-Codex]     if savedKilled < 0 then savedKilled = 0 end
01926 [GPT-5-Codex]     if savedKilled > totalSoldiers then savedKilled = totalSoldiers end
01927 [GPT-5-Codex]     soldiersKilled = savedKilled
01928 [GPT-5-Codex] 
01929 [GPT-5-Codex]     showMenu = false
01930 [GPT-5-Codex]     inOptionsMenu = false
01931 [GPT-5-Codex]     inSaveMenu = false
01932 [GPT-5-Codex]     saveMenuSelection = 1
01933 [GPT-5-Codex]     saveMenuMessage = ""
01934 [GPT-5-Codex]     saveMenuMessageTimer = 0
01935 [GPT-5-Codex] 
01936 [GPT-5-Codex]     if totalSoldiers > 0 and soldiersKilled >= totalSoldiers then
01937 [GPT-5-Codex]         gameState = STATE_WIN
01938 [GPT-5-Codex]         winSelection = 1
01939 [GPT-5-Codex]         winCooldown = 0
01940 [GPT-5-Codex]         winBannerTimer = winBannerMax
01941 [GPT-5-Codex]     end
01942 [GPT-5-Codex] 
01943 [GPT-5-Codex]     return true, nil
01944 [GPT-5-Codex] end
01945 [GPT-5-Codex] 
01946 [GPT-5-Codex] normalizeSaveSlots()
01947 [GPT-5-Codex] loadSaveSlotsFromDisk()
01948 [GPT-5-Codex] titleClassSelection = getClassSelectionIndexForId(getCurrentClassId())
01949 [GPT-5-Codex] 
01950 [GPT-5-Codex] -- Blood particle effects
01951 [GPT-5-Codex] local bloodEffects = {}  -- {x, y, particles={{dx, dy, life}...}}
01952 [GPT-5-Codex] 
01953 [GPT-5-Codex] -- Load warrior sprites for 4 directions
01954 [GPT-5-Codex] local warriorFront = nil
01955 [GPT-5-Codex] local warriorBack = nil
01956 [GPT-5-Codex] local warriorLeft = nil
01957 [GPT-5-Codex] local warriorRight = nil
01958 [GPT-5-Codex] 
01959 [GPT-5-Codex] -- Load warrior walking animation sprites (left-facing)
01960 [GPT-5-Codex] -- Note: walk3 is missing and needs AI generation - using 2-frame cycle for now
01961 [GPT-5-Codex] local warriorWalk1 = nil
01962 [GPT-5-Codex] local warriorWalk2 = nil
01963 [GPT-5-Codex] local warriorWalk3 = nil
01964 [GPT-5-Codex] local warriorWalk1Front = nil
01965 [GPT-5-Codex] local warriorWalk2Front = nil
01966 [GPT-5-Codex] local warriorWalk3Front = nil
01967 [GPT-5-Codex] local warriorWalk1Back = nil
01968 [GPT-5-Codex] local warriorWalk2Back = nil
01969 [GPT-5-Codex] local warriorWalk3Back = nil
01970 [GPT-5-Codex] -- Load warrior walking animation sprites (right-facing, flipped)
01971 [GPT-5-Codex] local warriorWalk1R = nil
01972 [GPT-5-Codex] local warriorWalk2R = nil
01973 [GPT-5-Codex] local warriorWalk3R = nil
01974 [GPT-5-Codex] local warriorDeath = {}
01975 [GPT-5-Codex] local swordAttack = {}
01976 [GPT-5-Codex] local shieldRaise = {}
01977 [GPT-5-Codex] local warriorAttackFront = {}
01978 [GPT-5-Codex] local warriorAttackBack = {}
01979 [GPT-5-Codex] local warriorAttackLeft = {}
01980 [GPT-5-Codex] local warriorAttackRight = {}
01981 [GPT-5-Codex] 
01982 [GPT-5-Codex] -- Load knight sprites for 4 directions
01983 [GPT-5-Codex] local knightFront = nil
01984 [GPT-5-Codex] local knightBack = nil
01985 [GPT-5-Codex] local knightLeft = nil
01986 [GPT-5-Codex] local knightRight = nil
01987 [GPT-5-Codex] 
01988 [GPT-5-Codex] local function deepCopy(value)
01989 [GPT-5-Codex]     if type(value) ~= "table" then
01990 [GPT-5-Codex]         return value
01991 [GPT-5-Codex]     end
01992 [GPT-5-Codex]     local out = {}
01993 [GPT-5-Codex]     local len = #value
01994 [GPT-5-Codex]     if len > 0 then
01995 [GPT-5-Codex]         for i = 1, len do
01996 [GPT-5-Codex]             out[i] = deepCopy(value[i])
01997 [GPT-5-Codex]         end
01998 [GPT-5-Codex]         for k, v in pairs(value) do
01999 [GPT-5-Codex]             if type(k) ~= "number" then
02000 [GPT-5-Codex]                 out[k] = deepCopy(v)
02001 [GPT-5-Codex]             end
02002 [GPT-5-Codex]         end
02003 [GPT-5-Codex]     else
02004 [GPT-5-Codex]         for k, v in pairs(value) do
02005 [GPT-5-Codex]             out[k] = deepCopy(v)
02006 [GPT-5-Codex]         end
02007 [GPT-5-Codex]     end
02008 [GPT-5-Codex]     return out
02009 [GPT-5-Codex] end
02010 [GPT-5-Codex] 
02011 [GPT-5-Codex] local function countEnemies(spriteList)
02012 [GPT-5-Codex]     local count = 0
02013 [GPT-5-Codex]     for i = 1, #spriteList do
02014 [GPT-5-Codex]         local s = spriteList[i]
02015 [GPT-5-Codex]         if s.t == 5 or s.t == 6 then
02016 [GPT-5-Codex]             count = count + 1
02017 [GPT-5-Codex]         end
02018 [GPT-5-Codex]     end
02019 [GPT-5-Codex]     return count
02020 [GPT-5-Codex] end
02021 [GPT-5-Codex] 
02022 [GPT-5-Codex] local function countAdjacentOpenTiles(sourceMap, mx, my)
02023 [GPT-5-Codex]     local function tileAt(tx, ty)
02024 [GPT-5-Codex]         if tx < 0 or tx > 15 or ty < 0 or ty > 15 then
02025 [GPT-5-Codex]             return 1
02026 [GPT-5-Codex]         end
02027 [GPT-5-Codex]         local row = sourceMap[ty + 1]
02028 [GPT-5-Codex]         if not row then return 1 end
02029 [GPT-5-Codex]         return row[tx + 1] or 1
02030 [GPT-5-Codex]     end
02031 [GPT-5-Codex]     local openCount = 0
02032 [GPT-5-Codex]     if tileAt(mx, my - 1) == 0 then openCount = openCount + 1 end
02033 [GPT-5-Codex]     if tileAt(mx, my + 1) == 0 then openCount = openCount + 1 end
02034 [GPT-5-Codex]     if tileAt(mx - 1, my) == 0 then openCount = openCount + 1 end
02035 [GPT-5-Codex]     if tileAt(mx + 1, my) == 0 then openCount = openCount + 1 end
02036 [GPT-5-Codex]     return openCount
02037 [GPT-5-Codex] end
02038 [GPT-5-Codex] 
02039 [GPT-5-Codex] local function wallVariantHash(mx, my, levelId, salt)
02040 [GPT-5-Codex]     local v = (((mx + 1) * 1973) + ((my + 1) * 9277) + ((levelId or 1) * 2663) + ((salt or 0) * 811)) % 104729
02041 [GPT-5-Codex]     v = ((v * 131) + 907) % 104729
02042 [GPT-5-Codex]     return v
02043 [GPT-5-Codex] end
02044 [GPT-5-Codex] 
02045 [GPT-5-Codex] local function chooseWallVariant(mx, my, levelId, sourceMap)
02046 [GPT-5-Codex]     -- Deterministic wall variety (no math.random crash risk).
02047 [GPT-5-Codex]     local openCount = countAdjacentOpenTiles(sourceMap, mx, my)
02048 [GPT-5-Codex]     local isDeadEndCap = (openCount == 1)
02049 [GPT-5-Codex] 
02050 [GPT-5-Codex]     -- Keep decorative types 5/6 rare so they don't feel deceptive in navigation.
02051 [GPT-5-Codex]     local accentRatePerThousand = isDeadEndCap and 55 or 12 -- 5.5% dead-ends, 1.2% elsewhere
02052 [GPT-5-Codex]     local accentRoll = wallVariantHash(mx, my, levelId, 1) % 1000
02053 [GPT-5-Codex]     if accentRoll < accentRatePerThousand then
02054 [GPT-5-Codex]         local accentPick = wallVariantHash(mx, my, levelId, 2) % 100
02055 [GPT-5-Codex]         if accentPick < 72 then
02056 [GPT-5-Codex]             return 5 -- diamond accent
02057 [GPT-5-Codex]         end
02058 [GPT-5-Codex]         return 6 -- window accent (rarer)
02059 [GPT-5-Codex]     end
02060 [GPT-5-Codex] 
02061 [GPT-5-Codex]     -- Primary walls (1-4) get broad, deterministic variety for immersion.
02062 [GPT-5-Codex]     local bucket = wallVariantHash(mx, my, levelId, 3) % 100
02063 [GPT-5-Codex]     if bucket < 30 then return 1 end
02064 [GPT-5-Codex]     if bucket < 57 then return 2 end
02065 [GPT-5-Codex]     if bucket < 80 then return 3 end
02066 [GPT-5-Codex]     return 4
02067 [GPT-5-Codex] end
02068 [GPT-5-Codex] 
02069 [GPT-5-Codex] local function loadLevel(levelId)
02070 [GPT-5-Codex]     local level = LEVELS[levelId]
02071 [GPT-5-Codex]     if not level then return end
02072 [GPT-5-Codex]     currentLevel = levelId
02073 [GPT-5-Codex]     if level.perfDisableEnemies ~= nil then
02074 [GPT-5-Codex]         DEBUG_DISABLE_ENEMIES = level.perfDisableEnemies
02075 [GPT-5-Codex]     end
02076 [GPT-5-Codex]     if level.perfDisableTextures ~= nil then
02077 [GPT-5-Codex]         DEBUG_DISABLE_WALL_TEXTURE = level.perfDisableTextures
02078 [GPT-5-Codex]     end
02079 [GPT-5-Codex]     if level.perfDisableProps ~= nil then
02080 [GPT-5-Codex]         DEBUG_DISABLE_PROPS = level.perfDisableProps
02081 [GPT-5-Codex]     end
02082 [GPT-5-Codex]     if type(level.name) == "string" and level.name:sub(1, 2) == "p-" then
02083 [GPT-5-Codex]         enableBootLogs = false
02084 [GPT-5-Codex]         DEBUG_WALL_QUADS_LOG = false
02085 [GPT-5-Codex]     end
02086 [GPT-5-Codex]     map = deepCopy(level.map)
02087 [GPT-5-Codex]     for my = 0, 15 do
02088 [GPT-5-Codex]         local row = map[my + 1]
02089 [GPT-5-Codex]         if row then
02090 [GPT-5-Codex]             for mx = 0, 15 do
02091 [GPT-5-Codex]                 if row[mx + 1] and row[mx + 1] > 0 then
02092 [GPT-5-Codex]                     row[mx + 1] = chooseWallVariant(mx, my, levelId, map)
02093 [GPT-5-Codex]                 end
02094 [GPT-5-Codex]             end
02095 [GPT-5-Codex]         end
02096 [GPT-5-Codex]     end
02097 [GPT-5-Codex]     sprites = deepCopy(level.sprites)
02098 [GPT-5-Codex]     local function isOpenFloor(mx, my)
02099 [GPT-5-Codex]         if mx < 1 or mx > 14 or my < 1 or my > 14 then return false end
02100 [GPT-5-Codex]         if map[my + 1][mx + 1] ~= 0 then return false end
02101 [GPT-5-Codex]         if map[my + 1][mx] ~= 0 then return false end
02102 [GPT-5-Codex]         if map[my + 1][mx + 2] ~= 0 then return false end
02103 [GPT-5-Codex]         if map[my][mx + 1] ~= 0 then return false end
02104 [GPT-5-Codex]         if map[my + 2][mx + 1] ~= 0 then return false end
02105 [GPT-5-Codex]         return true
02106 [GPT-5-Codex]     end
02107 [GPT-5-Codex]     local function tileAt(mx, my)
02108 [GPT-5-Codex]         if mx < 0 or mx > 15 or my < 0 or my > 15 then
02109 [GPT-5-Codex]             return 1
02110 [GPT-5-Codex]         end
02111 [GPT-5-Codex]         return map[my + 1][mx + 1] or 1
02112 [GPT-5-Codex]     end
02113 [GPT-5-Codex]     local function isDoorwayTile(mx, my)
02114 [GPT-5-Codex]         local n = tileAt(mx, my - 1) > 0
02115 [GPT-5-Codex]         local s = tileAt(mx, my + 1) > 0
02116 [GPT-5-Codex]         local w = tileAt(mx - 1, my) > 0
02117 [GPT-5-Codex]         local e = tileAt(mx + 1, my) > 0
02118 [GPT-5-Codex]         return (n and s and not e and not w) or (e and w and not n and not s)
02119 [GPT-5-Codex]     end
02120 [GPT-5-Codex]     local function isWallAttached(mx, my)
02121 [GPT-5-Codex]         if tileAt(mx, my) ~= 0 then return false end
02122 [GPT-5-Codex]         local n = tileAt(mx, my - 1) > 0
02123 [GPT-5-Codex]         local s = tileAt(mx, my + 1) > 0
02124 [GPT-5-Codex]         local w = tileAt(mx - 1, my) > 0
02125 [GPT-5-Codex]         local e = tileAt(mx + 1, my) > 0
02126 [GPT-5-Codex]         if isDoorwayTile(mx, my) then return false end
02127 [GPT-5-Codex]         -- Require a nearby wall, but avoid pure hallway gaps
02128 [GPT-5-Codex]         if (n and s and not e and not w) or (e and w and not n and not s) then
02129 [GPT-5-Codex]             return false
02130 [GPT-5-Codex]         end
02131 [GPT-5-Codex]         return n or s or w or e
02132 [GPT-5-Codex]     end
02133 [GPT-5-Codex]     if sprites then
02134 [GPT-5-Codex]         local filteredFloor = {}
02135 [GPT-5-Codex]         for i = 1, #sprites do
02136 [GPT-5-Codex]             local s = sprites[i]
02137 [GPT-5-Codex]             if s and (s.t == 1 or s.t == 2 or s.t == 3 or s.t == 4) then
02138 [GPT-5-Codex]                 local mx = math.floor(s.x)
02139 [GPT-5-Codex]                 local my = math.floor(s.y)
02140 [GPT-5-Codex]                 if isWallAttached(mx, my) then
02141 [GPT-5-Codex]                     filteredFloor[#filteredFloor + 1] = s
02142 [GPT-5-Codex]                 end
02143 [GPT-5-Codex]             elseif s and (s.t == 7 or s.t == 8) then
02144 [GPT-5-Codex]                 local mx = math.floor(s.x)
02145 [GPT-5-Codex]                 local my = math.floor(s.y)
02146 [GPT-5-Codex]                 if isOpenFloor(mx, my) then
02147 [GPT-5-Codex]                     filteredFloor[#filteredFloor + 1] = s
02148 [GPT-5-Codex]                 end
02149 [GPT-5-Codex]             else
02150 [GPT-5-Codex]                 filteredFloor[#filteredFloor + 1] = s
02151 [GPT-5-Codex]             end
02152 [GPT-5-Codex]         end
02153 [GPT-5-Codex]         sprites = filteredFloor
02154 [GPT-5-Codex]     end
02155 [GPT-5-Codex]     if DEBUG_DISABLE_PROPS then
02156 [GPT-5-Codex]         local filtered = {}
02157 [GPT-5-Codex]         for i = 1, #sprites do
02158 [GPT-5-Codex]             local s = sprites[i]
02159 [GPT-5-Codex]             if s.t == 7 or not isPropType(s.t) then
02160 [GPT-5-Codex]                 filtered[#filtered + 1] = s
02161 [GPT-5-Codex]             end
02162 [GPT-5-Codex]         end
02163 [GPT-5-Codex]         sprites = filtered
02164 [GPT-5-Codex]     end
02165 [GPT-5-Codex]     totalSoldiers = countEnemies(sprites)
02166 [GPT-5-Codex]     px = level.playerStart.x
02167 [GPT-5-Codex]     py = level.playerStart.y
02168 [GPT-5-Codex]     pdir = level.playerStart.dir
02169 [GPT-5-Codex]     lastSafeWallX = px
02170 [GPT-5-Codex]     lastSafeWallY = py
02171 [GPT-5-Codex] end
02172 [GPT-5-Codex] 
02173 [GPT-5-Codex] local function unloadLevelData()
02174 [GPT-5-Codex]     map = nil
02175 [GPT-5-Codex]     sprites = nil
02176 [GPT-5-Codex]     totalSoldiers = 0
02177 [GPT-5-Codex] end
02178 [GPT-5-Codex] 
02179 [GPT-5-Codex] local function freeSpriteRef(sprite)
02180 [GPT-5-Codex]     if sprite then
02181 [GPT-5-Codex]         vmupro.sprite.free(sprite)
02182 [GPT-5-Codex]     end
02183 [GPT-5-Codex] end
02184 [GPT-5-Codex] 
02185 [GPT-5-Codex] local function unloadMenuSprites()
02186 [GPT-5-Codex]     freeSpriteRef(titleSprite)
02187 [GPT-5-Codex]     titleSprite = nil
02188 [GPT-5-Codex]     if classPortraitSprites then
02189 [GPT-5-Codex]         for _, spriteRef in pairs(classPortraitSprites) do
02190 [GPT-5-Codex]             freeSpriteRef(spriteRef)
02191 [GPT-5-Codex]         end
02192 [GPT-5-Codex]     end
02193 [GPT-5-Codex]     classPortraitSprites = {}
02194 [GPT-5-Codex]     freeSpriteRef(classPortraitSprite)
02195 [GPT-5-Codex]     classPortraitSprite = nil
02196 [GPT-5-Codex] end
02197 [GPT-5-Codex] 
02198 [GPT-5-Codex] local function unloadLevelSprites()
02199 [GPT-5-Codex]     freeSpriteRef(warriorFront); warriorFront = nil
02200 [GPT-5-Codex]     freeSpriteRef(warriorBack); warriorBack = nil
02201 [GPT-5-Codex]     freeSpriteRef(warriorLeft); warriorLeft = nil
02202 [GPT-5-Codex]     freeSpriteRef(warriorRight); warriorRight = nil
02203 [GPT-5-Codex]     freeSpriteRef(warriorWalk1); warriorWalk1 = nil
02204 [GPT-5-Codex]     freeSpriteRef(warriorWalk2); warriorWalk2 = nil
02205 [GPT-5-Codex]     freeSpriteRef(warriorWalk3); warriorWalk3 = nil
02206 [GPT-5-Codex]     freeSpriteRef(warriorWalk1Front); warriorWalk1Front = nil
02207 [GPT-5-Codex]     freeSpriteRef(warriorWalk2Front); warriorWalk2Front = nil
02208 [GPT-5-Codex]     freeSpriteRef(warriorWalk3Front); warriorWalk3Front = nil
02209 [GPT-5-Codex]     freeSpriteRef(warriorWalk1Back); warriorWalk1Back = nil
02210 [GPT-5-Codex]     freeSpriteRef(warriorWalk2Back); warriorWalk2Back = nil
02211 [GPT-5-Codex]     freeSpriteRef(warriorWalk3Back); warriorWalk3Back = nil
02212 [GPT-5-Codex]     freeSpriteRef(warriorWalk1R); warriorWalk1R = nil
02213 [GPT-5-Codex]     freeSpriteRef(warriorWalk2R); warriorWalk2R = nil
02214 [GPT-5-Codex]     freeSpriteRef(warriorWalk3R); warriorWalk3R = nil
02215 [GPT-5-Codex]     for i = 1, #warriorDeath do
02216 [GPT-5-Codex]         freeSpriteRef(warriorDeath[i])
02217 [GPT-5-Codex]     end
02218 [GPT-5-Codex]     warriorDeath = {}
02219 [GPT-5-Codex]     for i = 1, #swordAttack do
02220 [GPT-5-Codex]         freeSpriteRef(swordAttack[i])
02221 [GPT-5-Codex]     end
02222 [GPT-5-Codex]     swordAttack = {}
02223 [GPT-5-Codex]     for i = 1, #shieldRaise do
02224 [GPT-5-Codex]         freeSpriteRef(shieldRaise[i])
02225 [GPT-5-Codex]     end
02226 [GPT-5-Codex]     shieldRaise = {}
02227 [GPT-5-Codex]     for i = 1, #warriorAttackFront do
02228 [GPT-5-Codex]         freeSpriteRef(warriorAttackFront[i])
02229 [GPT-5-Codex]     end
02230 [GPT-5-Codex]     for i = 1, #warriorAttackBack do
02231 [GPT-5-Codex]         freeSpriteRef(warriorAttackBack[i])
02232 [GPT-5-Codex]     end
02233 [GPT-5-Codex]     for i = 1, #warriorAttackLeft do
02234 [GPT-5-Codex]         freeSpriteRef(warriorAttackLeft[i])
02235 [GPT-5-Codex]     end
02236 [GPT-5-Codex]     for i = 1, #warriorAttackRight do
02237 [GPT-5-Codex]         freeSpriteRef(warriorAttackRight[i])
02238 [GPT-5-Codex]     end
02239 [GPT-5-Codex]     warriorAttackFront = {}
02240 [GPT-5-Codex]     warriorAttackBack = {}
02241 [GPT-5-Codex]     warriorAttackLeft = {}
02242 [GPT-5-Codex]     warriorAttackRight = {}
02243 [GPT-5-Codex]     freeSpriteRef(knightFront); knightFront = nil
02244 [GPT-5-Codex]     freeSpriteRef(knightBack); knightBack = nil
02245 [GPT-5-Codex]     freeSpriteRef(knightLeft); knightLeft = nil
02246 [GPT-5-Codex]     freeSpriteRef(knightRight); knightRight = nil
02247 [GPT-5-Codex]     freeSpriteRef(potionSprite); potionSprite = nil
02248 [GPT-5-Codex]     freeSpriteRef(wallStone); wallStone = nil
02249 [GPT-5-Codex]     freeSpriteRef(wallBrick); wallBrick = nil
02250 [GPT-5-Codex]     freeSpriteRef(wallMoss); wallMoss = nil
02251 [GPT-5-Codex]     freeSpriteRef(wallMetal); wallMetal = nil
02252 [GPT-5-Codex]     freeSpriteRef(wallWood); wallWood = nil
02253 [GPT-5-Codex]     freeSpriteRef(wallWindow); wallWindow = nil
02254 [GPT-5-Codex]     freeSpriteRef(wallRoof); wallRoof = nil
02255 [GPT-5-Codex]     freeSpriteRef(wallSheetStone); wallSheetStone = nil
02256 [GPT-5-Codex]     freeSpriteRef(wallSheetBrick); wallSheetBrick = nil
02257 [GPT-5-Codex]     freeSpriteRef(wallSheetMoss); wallSheetMoss = nil
02258 [GPT-5-Codex]     freeSpriteRef(wallSheetMetal); wallSheetMetal = nil
02259 [GPT-5-Codex]     freeSpriteRef(wallSheetWood); wallSheetWood = nil
02260 [GPT-5-Codex]     freeSpriteRef(wallSheetWindow); wallSheetWindow = nil
02261 [GPT-5-Codex]     wallTextureLoadAttempted = false
02262 [GPT-5-Codex] end
02263 [GPT-5-Codex] 
02264 [GPT-5-Codex] local function loadMenuSprites()
02265 [GPT-5-Codex]     if not titleSprite then
02266 [GPT-5-Codex]         titleSprite = vmupro.sprite.new("sprites/title")
02267 [GPT-5-Codex]         if not validateSprite(titleSprite, "loadMenuSprites") then
02268 [GPT-5-Codex]             safeLog("ERROR", "Failed to load title sprite")
02269 [GPT-5-Codex]             titleSprite = nil
02270 [GPT-5-Codex]         end
02271 [GPT-5-Codex]     end
02272 [GPT-5-Codex]     if not classPortraitSprite then
02273 [GPT-5-Codex]         classPortraitSprite = vmupro.sprite.new("sprites/level1/warrior_front")
02274 [GPT-5-Codex]         if not validateSprite(classPortraitSprite, "classPortraitSprite") then
02275 [GPT-5-Codex]             classPortraitSprite = nil
02276 [GPT-5-Codex]         end
02277 [GPT-5-Codex]     end
02278 [GPT-5-Codex]     if not classPortraitSprites then
02279 [GPT-5-Codex]         classPortraitSprites = {}
02280 [GPT-5-Codex]     end
02281 [GPT-5-Codex]     if CLASS_SELECT_PORTRAIT_PATHS then
02282 [GPT-5-Codex]         for classId, spritePath in pairs(CLASS_SELECT_PORTRAIT_PATHS) do
02283 [GPT-5-Codex]             if spritePath and (not classPortraitSprites[classId]) then
02284 [GPT-5-Codex]                 local okPortrait, spriteRef = pcall(vmupro.sprite.new, spritePath)
02285 [GPT-5-Codex]                 if okPortrait and validateSprite(spriteRef, "classPortrait:" .. tostring(classId)) then
02286 [GPT-5-Codex]                     classPortraitSprites[classId] = spriteRef
02287 [GPT-5-Codex]                 else
02288 [GPT-5-Codex]                     classPortraitSprites[classId] = nil
02289 [GPT-5-Codex]                 end
02290 [GPT-5-Codex]             end
02291 [GPT-5-Codex]         end
02292 [GPT-5-Codex]     end
02293 [GPT-5-Codex] end
02294 [GPT-5-Codex] 
02295 [GPT-5-Codex] -- Texture metadata and loaders (forward-declared for use in loadLevelSprites)
02296 [GPT-5-Codex] local textureMetadata = {}
02297 [GPT-5-Codex] local loadTextureWithValidation
02298 [GPT-5-Codex] local logTextureMemoryUsage
02299 [GPT-5-Codex] 
02300 [GPT-5-Codex] local function loadTextureSheetWithValidation(path, textureName)
02301 [GPT-5-Codex]     local success, sheet = pcall(function()
02302 [GPT-5-Codex]         return vmupro.sprite.newSheet(path)
02303 [GPT-5-Codex]     end)
02304 [GPT-5-Codex] 
02305 [GPT-5-Codex]     if not success then
02306 [GPT-5-Codex]         safeLog("ERROR", string.format(
02307 [GPT-5-Codex]             "Failed to load texture sheet '%s' from path: %s. Error: %s",
02308 [GPT-5-Codex]             textureName, path, tostring(sheet)
02309 [GPT-5-Codex]         ))
02310 [GPT-5-Codex]         return nil
02311 [GPT-5-Codex]     end
02312 [GPT-5-Codex] 
02313 [GPT-5-Codex]     if not sheet then
02314 [GPT-5-Codex]         safeLog("ERROR", string.format(
02315 [GPT-5-Codex]             "Texture sheet '%s' returned nil from path: %s",
02316 [GPT-5-Codex]             textureName, path
02317 [GPT-5-Codex]         ))
02318 [GPT-5-Codex]         return nil
02319 [GPT-5-Codex]     end
02320 [GPT-5-Codex] 
02321 [GPT-5-Codex]     local frameCount = sheet.frameCount or 0
02322 [GPT-5-Codex]     local frameWidth = sheet.frameWidth or 0
02323 [GPT-5-Codex]     local frameHeight = sheet.frameHeight or 0
02324 [GPT-5-Codex]     if frameCount <= 0 or frameWidth <= 0 or frameHeight <= 0 then
02325 [GPT-5-Codex]         safeLog("ERROR", string.format(
02326 [GPT-5-Codex]             "Texture sheet '%s' has invalid frame metadata: count=%s frame=%sx%s path=%s",
02327 [GPT-5-Codex]             textureName, tostring(frameCount), tostring(frameWidth), tostring(frameHeight), path
02328 [GPT-5-Codex]         ))
02329 [GPT-5-Codex]         return nil
02330 [GPT-5-Codex]     end
02331 [GPT-5-Codex] 
02332 [GPT-5-Codex]     if frameWidth ~= 1 or frameHeight ~= 128 then
02333 [GPT-5-Codex]         safeLog("ERROR", string.format(
02334 [GPT-5-Codex]             "Texture sheet '%s' has unexpected frame size %dx%d (expected 1x128): %s",
02335 [GPT-5-Codex]             textureName, frameWidth, frameHeight, path
02336 [GPT-5-Codex]         ))
02337 [GPT-5-Codex]         return nil
02338 [GPT-5-Codex]     end
02339 [GPT-5-Codex] 
02340 [GPT-5-Codex]     if frameCount < 64 then
02341 [GPT-5-Codex]         safeLog("ERROR", string.format(
02342 [GPT-5-Codex]             "Texture sheet '%s' has too few frames: count=%d path=%s",
02343 [GPT-5-Codex]             textureName, frameCount, path
02344 [GPT-5-Codex]         ))
02345 [GPT-5-Codex]         return nil
02346 [GPT-5-Codex]     end
02347 [GPT-5-Codex] 
02348 [GPT-5-Codex]     safeLog("INFO", string.format(
02349 [GPT-5-Codex]         "Texture sheet '%s' loaded: frame %dx%d, count=%d, transparentColor=0x%04X (column path)",
02350 [GPT-5-Codex]         textureName, frameWidth, frameHeight, frameCount, sheet.transparentColor or 0
02351 [GPT-5-Codex]     ))
02352 [GPT-5-Codex]     return sheet
02353 [GPT-5-Codex] end
02354 [GPT-5-Codex] 
02355 [GPT-5-Codex] local function getWall1VariantConfig()
02356 [GPT-5-Codex]     local variants = WALL1_FORMAT_VARIANTS or {}
02357 [GPT-5-Codex]     local n = #variants
02358 [GPT-5-Codex]     if n <= 0 then
02359 [GPT-5-Codex]         return {label = "PNG16", base = "sprites/wall_textures/wall-1-tile", sheet = "sprites/wall_textures/wall-1-tile-table-1-128"}
02360 [GPT-5-Codex]     end
02361 [GPT-5-Codex]     WALL1_FORMAT_INDEX = clampInt(WALL1_FORMAT_INDEX or 1, 1, n)
02362 [GPT-5-Codex]     return variants[WALL1_FORMAT_INDEX] or variants[1]
02363 [GPT-5-Codex] end
02364 [GPT-5-Codex] 
02365 [GPT-5-Codex] local function getWallKeyModeLabel()
02366 [GPT-5-Codex]     return WALL_FORCE_COLORKEY_OVERRIDE and "FORCED" or "RAW"
02367 [GPT-5-Codex] end
02368 [GPT-5-Codex] 
02369 [GPT-5-Codex] local function getWallProjectionModeLabel()
02370 [GPT-5-Codex]     if WALL_PROJECTION_MODE == "stable" then
02371 [GPT-5-Codex]         return "STABLE"
02372 [GPT-5-Codex]     end
02373 [GPT-5-Codex]     return "ADAPTIVE"
02374 [GPT-5-Codex] end
02375 [GPT-5-Codex] 
02376 [GPT-5-Codex] local function forceWallTextureColorKeys()
02377 [GPT-5-Codex]     if not WALL_FORCE_COLORKEY_OVERRIDE then
02378 [GPT-5-Codex]         return
02379 [GPT-5-Codex]     end
02380 [GPT-5-Codex]     forceSpriteColorKey(wallStone, "wall_1")
02381 [GPT-5-Codex]     forceSpriteColorKey(wallBrick, "wall_2")
02382 [GPT-5-Codex]     forceSpriteColorKey(wallMoss, "wall_3")
02383 [GPT-5-Codex]     forceSpriteColorKey(wallMetal, "wall_4")
02384 [GPT-5-Codex]     forceSpriteColorKey(wallWood, "wall_diamond")
02385 [GPT-5-Codex]     forceSpriteColorKey(wallWindow, "wall_window")
02386 [GPT-5-Codex]     forceSpriteColorKey(wallSheetStone, "wall_1_sheet")
02387 [GPT-5-Codex]     forceSpriteColorKey(wallSheetBrick, "wall_2_sheet")
02388 [GPT-5-Codex]     forceSpriteColorKey(wallSheetMoss, "wall_3_sheet")
02389 [GPT-5-Codex]     forceSpriteColorKey(wallSheetMetal, "wall_4_sheet")
02390 [GPT-5-Codex]     forceSpriteColorKey(wallSheetWood, "wall_diamond_sheet")
02391 [GPT-5-Codex]     forceSpriteColorKey(wallSheetWindow, "wall_window_sheet")
02392 [GPT-5-Codex] end
02393 [GPT-5-Codex] 
02394 [GPT-5-Codex] function loadWallTextures()
02395 [GPT-5-Codex]     if wallTextureLoadAttempted then return end
02396 [GPT-5-Codex]     wallTextureLoadAttempted = true
02397 [GPT-5-Codex]     local wall1Cfg = getWall1VariantConfig()
02398 [GPT-5-Codex]     local wall1BasePath = wall1Cfg.base or "sprites/wall_textures/wall-1-tile"
02399 [GPT-5-Codex]     local wall1SheetPath = wall1Cfg.sheet or "sprites/wall_textures/wall-1-tile-table-1-128"
02400 [GPT-5-Codex]     safeLog("INFO", string.format(
02401 [GPT-5-Codex]         "[TEX] wall1 variant=%s base=%s sheet=%s wallKey=%s colorKeyOverride=%s",
02402 [GPT-5-Codex]         tostring(wall1Cfg.label or "?"),
02403 [GPT-5-Codex]         tostring(wall1BasePath),
02404 [GPT-5-Codex]         tostring(wall1SheetPath),
02405 [GPT-5-Codex]         getWallKeyModeLabel(),
02406 [GPT-5-Codex]         WALL_FORCE_COLORKEY_OVERRIDE and "ON" or "OFF"
02407 [GPT-5-Codex]     ))
02408 [GPT-5-Codex]     -- Base textures (your selected names).
02409 [GPT-5-Codex]     wallStone = loadTextureWithValidation(wall1BasePath, "wall_1")
02410 [GPT-5-Codex]     wallBrick = loadTextureWithValidation("sprites/wall_textures/wall-2-tile", "wall_2")
02411 [GPT-5-Codex]     wallMoss = loadTextureWithValidation("sprites/wall_textures/wall-3-tile", "wall_3")
02412 [GPT-5-Codex]     wallMetal = loadTextureWithValidation("sprites/wall_textures/wall-4-tile", "wall_4")
02413 [GPT-5-Codex]     wallWood = loadTextureWithValidation("sprites/wall_textures/Wall-Diamond-Tile", "wall_diamond")
02414 [GPT-5-Codex]     wallWindow = loadTextureWithValidation("sprites/wall_textures/Wall-Window-Tile", "wall_window")
02415 [GPT-5-Codex] 
02416 [GPT-5-Codex]     -- Column-sheet path (same logic as prior PNG-working implementation).
02417 [GPT-5-Codex]     wallSheetStone = loadTextureSheetWithValidation(wall1SheetPath, "wall_1_sheet")
02418 [GPT-5-Codex]     wallSheetBrick = loadTextureSheetWithValidation("sprites/wall_textures/wall-2-tile-table-1-128", "wall_2_sheet")
02419 [GPT-5-Codex]     wallSheetMoss = loadTextureSheetWithValidation("sprites/wall_textures/wall-3-tile-table-1-128", "wall_3_sheet")
02420 [GPT-5-Codex]     wallSheetMetal = loadTextureSheetWithValidation("sprites/wall_textures/wall-4-tile-table-1-128", "wall_4_sheet")
02421 [GPT-5-Codex]     wallSheetWood = loadTextureSheetWithValidation("sprites/wall_textures/Wall-Diamond-Tile-table-1-128", "wall_diamond_sheet")
02422 [GPT-5-Codex]     wallSheetWindow = loadTextureSheetWithValidation("sprites/wall_textures/Wall-Window-Tile-table-1-128", "wall_window_sheet")
02423 [GPT-5-Codex]     forceWallTextureColorKeys()
02424 [GPT-5-Codex] 
02425 [GPT-5-Codex]     wallRoof = loadTextureWithValidation("sprites/wall_textures/roof_dirt_splatter_64", "roof")
02426 [GPT-5-Codex] 
02427 [GPT-5-Codex]     -- Log total texture memory usage
02428 [GPT-5-Codex]     logTextureMemoryUsage()
02429 [GPT-5-Codex] end
02430 [GPT-5-Codex] 
02431 [GPT-5-Codex] function unloadWallTextures()
02432 [GPT-5-Codex]     freeSpriteRef(wallStone); wallStone = nil
02433 [GPT-5-Codex]     freeSpriteRef(wallBrick); wallBrick = nil
02434 [GPT-5-Codex]     freeSpriteRef(wallMoss); wallMoss = nil
02435 [GPT-5-Codex]     freeSpriteRef(wallMetal); wallMetal = nil
02436 [GPT-5-Codex]     freeSpriteRef(wallWood); wallWood = nil
02437 [GPT-5-Codex]     freeSpriteRef(wallWindow); wallWindow = nil
02438 [GPT-5-Codex]     freeSpriteRef(wallRoof); wallRoof = nil
02439 [GPT-5-Codex]     freeSpriteRef(wallSheetStone); wallSheetStone = nil
02440 [GPT-5-Codex]     freeSpriteRef(wallSheetBrick); wallSheetBrick = nil
02441 [GPT-5-Codex]     freeSpriteRef(wallSheetMoss); wallSheetMoss = nil
02442 [GPT-5-Codex]     freeSpriteRef(wallSheetMetal); wallSheetMetal = nil
02443 [GPT-5-Codex]     freeSpriteRef(wallSheetWood); wallSheetWood = nil
02444 [GPT-5-Codex]     freeSpriteRef(wallSheetWindow); wallSheetWindow = nil
02445 [GPT-5-Codex]     wallTextureLoadAttempted = false
02446 [GPT-5-Codex] end
02447 [GPT-5-Codex] 
02448 [GPT-5-Codex] local function loadLevelSprites(levelId)
02449 [GPT-5-Codex]     local level = LEVELS[levelId]
02450 [GPT-5-Codex]     local assets = level and level.assets or {}
02451 [GPT-5-Codex]     local base = (level and level.assetBase) or "sprites/"
02452 [GPT-5-Codex] 
02453 [GPT-5-Codex]     if assets.warrior then
02454 [GPT-5-Codex]         warriorFront = vmupro.sprite.new(base .. "warrior_front")
02455 [GPT-5-Codex]         if not validateSprite(warriorFront, "warriorFront") then warriorFront = nil end
02456 [GPT-5-Codex]         warriorBack = vmupro.sprite.new(base .. "warrior_back")
02457 [GPT-5-Codex]         if not validateSprite(warriorBack, "warriorBack") then warriorBack = nil end
02458 [GPT-5-Codex]         warriorLeft = vmupro.sprite.new(base .. "warrior_left")
02459 [GPT-5-Codex]         if not validateSprite(warriorLeft, "warriorLeft") then warriorLeft = nil end
02460 [GPT-5-Codex]         warriorRight = vmupro.sprite.new(base .. "warrior_right")
02461 [GPT-5-Codex]         if not validateSprite(warriorRight, "warriorRight") then warriorRight = nil end
02462 [GPT-5-Codex]         warriorWalk1 = vmupro.sprite.new(base .. "warrior_walk1")
02463 [GPT-5-Codex]         if not validateSprite(warriorWalk1, "warriorWalk1") then warriorWalk1 = nil end
02464 [GPT-5-Codex]         warriorWalk2 = vmupro.sprite.new(base .. "warrior_walk2")
02465 [GPT-5-Codex]         if not validateSprite(warriorWalk2, "warriorWalk2") then warriorWalk2 = nil end
02466 [GPT-5-Codex]         local okWalkFront1, spriteWalkFront1 = pcall(vmupro.sprite.new, base .. "warrior_walk1_front")
02467 [GPT-5-Codex]         if okWalkFront1 then
02468 [GPT-5-Codex]             warriorWalk1Front = spriteWalkFront1
02469 [GPT-5-Codex]             if not validateSprite(warriorWalk1Front, "warriorWalk1Front") then warriorWalk1Front = nil end
02470 [GPT-5-Codex]         end
02471 [GPT-5-Codex]         local okWalkFront2, spriteWalkFront2 = pcall(vmupro.sprite.new, base .. "warrior_walk2_front")
02472 [GPT-5-Codex]         if okWalkFront2 then warriorWalk2Front = spriteWalkFront2 end
02473 [GPT-5-Codex]         local okWalkFront3, spriteWalkFront3 = pcall(vmupro.sprite.new, base .. "warrior_walk3_front")
02474 [GPT-5-Codex]         if okWalkFront3 then warriorWalk3Front = spriteWalkFront3 end
02475 [GPT-5-Codex]         local okWalkBack1, spriteWalkBack1 = pcall(vmupro.sprite.new, base .. "warrior_walk1_back")
02476 [GPT-5-Codex]         if okWalkBack1 then warriorWalk1Back = spriteWalkBack1 end
02477 [GPT-5-Codex]         local okWalkBack2, spriteWalkBack2 = pcall(vmupro.sprite.new, base .. "warrior_walk2_back")
02478 [GPT-5-Codex]         if okWalkBack2 then warriorWalk2Back = spriteWalkBack2 end
02479 [GPT-5-Codex]         local okWalkBack3, spriteWalkBack3 = pcall(vmupro.sprite.new, base .. "warrior_walk3_back")
02480 [GPT-5-Codex]         if okWalkBack3 then warriorWalk3Back = spriteWalkBack3 end
02481 [GPT-5-Codex]         -- Optional: walk3 frames (guard against missing assets)
02482 [GPT-5-Codex]         local okWalk3, spriteWalk3 = pcall(vmupro.sprite.new, base .. "warrior_walk3")
02483 [GPT-5-Codex]         if okWalk3 then warriorWalk3 = spriteWalk3 end
02484 [GPT-5-Codex]         warriorWalk1R = vmupro.sprite.new(base .. "warrior_walk1_r")
02485 [GPT-5-Codex]         warriorWalk2R = vmupro.sprite.new(base .. "warrior_walk2_r")
02486 [GPT-5-Codex]         local okWalk3R, spriteWalk3R = pcall(vmupro.sprite.new, base .. "warrior_walk3_r")
02487 [GPT-5-Codex]         if okWalk3R then warriorWalk3R = spriteWalk3R end
02488 [GPT-5-Codex] 
02489 [GPT-5-Codex]         warriorDeath = {}
02490 [GPT-5-Codex]         for i = 1, 7 do
02491 [GPT-5-Codex]             local okDeath, spriteDeath = pcall(vmupro.sprite.new, base .. "warrior_death" .. tostring(i))
02492 [GPT-5-Codex]             if okDeath then
02493 [GPT-5-Codex]                 warriorDeath[i] = spriteDeath
02494 [GPT-5-Codex]                 if not validateSprite(warriorDeath[i], "warriorDeath" .. tostring(i)) then
02495 [GPT-5-Codex]                     warriorDeath[i] = nil
02496 [GPT-5-Codex]                 end
02497 [GPT-5-Codex]             end
02498 [GPT-5-Codex]         end
02499 [GPT-5-Codex] 
02500 [GPT-5-Codex]         swordAttack = {}
02501 [GPT-5-Codex]         for i = 1, 9 do
02502 [GPT-5-Codex]             local okAttack, spriteAttack = pcall(vmupro.sprite.new, base .. "sword_attack" .. tostring(i))
02503 [GPT-5-Codex]             if okAttack then
02504 [GPT-5-Codex]                 swordAttack[i] = spriteAttack
02505 [GPT-5-Codex]                 if not validateSprite(swordAttack[i], "swordAttack" .. tostring(i)) then
02506 [GPT-5-Codex]                     swordAttack[i] = nil
02507 [GPT-5-Codex]                 end
02508 [GPT-5-Codex]             end
02509 [GPT-5-Codex]         end
02510 [GPT-5-Codex] 
02511 [GPT-5-Codex]         shieldRaise = {}
02512 [GPT-5-Codex]         for i = 1, (BLOCK_ANIM_FRAMES or 8) do
02513 [GPT-5-Codex]             local okShield, sprShield = pcall(vmupro.sprite.new, "sprites/shield_raise" .. tostring(i))
02514 [GPT-5-Codex]             if okShield then
02515 [GPT-5-Codex]                 shieldRaise[i] = sprShield
02516 [GPT-5-Codex]                 if not validateSprite(shieldRaise[i], "shield_raise" .. tostring(i)) then
02517 [GPT-5-Codex]                     shieldRaise[i] = nil
02518 [GPT-5-Codex]                 end
02519 [GPT-5-Codex]             end
02520 [GPT-5-Codex]         end
02521 [GPT-5-Codex] 
02522 [GPT-5-Codex]         warriorAttackFront = {}
02523 [GPT-5-Codex]         warriorAttackBack = {}
02524 [GPT-5-Codex]         warriorAttackLeft = {}
02525 [GPT-5-Codex]         warriorAttackRight = {}
02526 [GPT-5-Codex]         for i = 1, 2 do
02527 [GPT-5-Codex]             local okFront, sprFront = pcall(vmupro.sprite.new, base .. "warrior_attack_front" .. tostring(i))
02528 [GPT-5-Codex]             if okFront then warriorAttackFront[i] = sprFront end
02529 [GPT-5-Codex]             local okBack, sprBack = pcall(vmupro.sprite.new, base .. "warrior_attack_back" .. tostring(i))
02530 [GPT-5-Codex]             if okBack then warriorAttackBack[i] = sprBack end
02531 [GPT-5-Codex]             local okLeft, sprLeft = pcall(vmupro.sprite.new, base .. "warrior_attack_left" .. tostring(i))
02532 [GPT-5-Codex]             if okLeft then warriorAttackLeft[i] = sprLeft end
02533 [GPT-5-Codex]             local okRight, sprRight = pcall(vmupro.sprite.new, base .. "warrior_attack_right" .. tostring(i))
02534 [GPT-5-Codex]             if okRight then warriorAttackRight[i] = sprRight end
02535 [GPT-5-Codex]         end
02536 [GPT-5-Codex]     end
02537 [GPT-5-Codex] 
02538 [GPT-5-Codex]     if assets.knight then
02539 [GPT-5-Codex]         knightFront = vmupro.sprite.new(base .. "knight_front")
02540 [GPT-5-Codex]         if not validateSprite(knightFront, "knightFront") then knightFront = nil end
02541 [GPT-5-Codex]         knightBack = vmupro.sprite.new(base .. "knight_back")
02542 [GPT-5-Codex]         if not validateSprite(knightBack, "knightBack") then knightBack = nil end
02543 [GPT-5-Codex]         knightLeft = vmupro.sprite.new(base .. "knight_left")
02544 [GPT-5-Codex]         if not validateSprite(knightLeft, "knightLeft") then knightLeft = nil end
02545 [GPT-5-Codex]         knightRight = vmupro.sprite.new(base .. "knight_right")
02546 [GPT-5-Codex]         if not validateSprite(knightRight, "knightRight") then knightRight = nil end
02547 [GPT-5-Codex]     end
02548 [GPT-5-Codex] 
02549 [GPT-5-Codex]     if assets.potion then
02550 [GPT-5-Codex]         potionSprite = vmupro.sprite.new(base .. "potion")
02551 [GPT-5-Codex]         if not validateSprite(potionSprite, "potionSprite") then potionSprite = nil end
02552 [GPT-5-Codex]     end
02553 [GPT-5-Codex]     if DEBUG_DISABLE_WALL_TEXTURE then
02554 [GPT-5-Codex]         unloadWallTextures()
02555 [GPT-5-Codex]     else
02556 [GPT-5-Codex]         loadWallTextures()
02557 [GPT-5-Codex]     end
02558 [GPT-5-Codex] end
02559 [GPT-5-Codex] 
02560 [GPT-5-Codex] -- Load texture with dimension validation and error handling
02561 [GPT-5-Codex] loadTextureWithValidation = function(path, textureName)
02562 [GPT-5-Codex]     local success, sprite = pcall(function()
02563 [GPT-5-Codex]         return vmupro.sprite.new(path)
02564 [GPT-5-Codex]     end)
02565 [GPT-5-Codex] 
02566 [GPT-5-Codex]     if not success then
02567 [GPT-5-Codex]         safeLog("ERROR", string.format(
02568 [GPT-5-Codex]             "Failed to load texture '%s' from path: %s. Error: %s",
02569 [GPT-5-Codex]             textureName, path, tostring(sprite)
02570 [GPT-5-Codex]         ))
02571 [GPT-5-Codex]         return nil
02572 [GPT-5-Codex]     end
02573 [GPT-5-Codex] 
02574 [GPT-5-Codex]     if not sprite then
02575 [GPT-5-Codex]         safeLog("ERROR", string.format(
02576 [GPT-5-Codex]             "Texture '%s' returned nil from path: %s",
02577 [GPT-5-Codex]             textureName, path
02578 [GPT-5-Codex]         ))
02579 [GPT-5-Codex]         return nil
02580 [GPT-5-Codex]     end
02581 [GPT-5-Codex] 
02582 [GPT-5-Codex]     -- Get texture dimensions
02583 [GPT-5-Codex]     local width = sprite.width
02584 [GPT-5-Codex]     local height = sprite.height
02585 [GPT-5-Codex] 
02586 [GPT-5-Codex]     if not width or not height or width <= 0 or height <= 0 then
02587 [GPT-5-Codex]         safeLog("ERROR", string.format(
02588 [GPT-5-Codex]             "Texture '%s' has invalid dimensions: %dx%d (path: %s)",
02589 [GPT-5-Codex]             textureName, width or 0, height or 0, path
02590 [GPT-5-Codex]         ))
02591 [GPT-5-Codex]         safeLog("ERROR", string.format(
02592 [GPT-5-Codex]             "Texture '%s' failed validation: width=%s, height=%s, path=%s",
02593 [GPT-5-Codex]             textureName, tostring(width), tostring(height), path
02594 [GPT-5-Codex]         ))
02595 [GPT-5-Codex]         return nil
02596 [GPT-5-Codex]     end
02597 [GPT-5-Codex] 
02598 [GPT-5-Codex]     -- Additional validation with safety function
02599 [GPT-5-Codex]     if not validateTextureDimensions(sprite, "loadTextureWithValidation:" .. textureName) then
02600 [GPT-5-Codex]         return nil
02601 [GPT-5-Codex]     end
02602 [GPT-5-Codex] 
02603 [GPT-5-Codex]     -- Store metadata
02604 [GPT-5-Codex]     textureMetadata[textureName] = {
02605 [GPT-5-Codex]         path = path,
02606 [GPT-5-Codex]         width = width,
02607 [GPT-5-Codex]         height = height,
02608 [GPT-5-Codex]         pixelCount = width * height,
02609 [GPT-5-Codex]         loaded = true
02610 [GPT-5-Codex]     }
02611 [GPT-5-Codex] 
02612 [GPT-5-Codex]     -- Log successful load with dimensions
02613 [GPT-5-Codex]     safeLog("INFO", string.format(
02614 [GPT-5-Codex]         "Loaded texture '%s': %dx%d (%d pixels) from %s transparentColor=0x%04X",
02615 [GPT-5-Codex]         textureName, width, height, width * height, path, sprite.transparentColor or 0
02616 [GPT-5-Codex]     ))
02617 [GPT-5-Codex] 
02618 [GPT-5-Codex]     return sprite
02619 [GPT-5-Codex] end
02620 [GPT-5-Codex] 
02621 [GPT-5-Codex] -- Log total texture memory usage
02622 [GPT-5-Codex] logTextureMemoryUsage = function()
02623 [GPT-5-Codex]     local totalPixels = 0
02624 [GPT-5-Codex]     local textureCount = 0
02625 [GPT-5-Codex] 
02626 [GPT-5-Codex]     for name, metadata in pairs(textureMetadata) do
02627 [GPT-5-Codex]         if metadata.loaded then
02628 [GPT-5-Codex]             totalPixels = totalPixels + metadata.pixelCount
02629 [GPT-5-Codex]             textureCount = textureCount + 1
02630 [GPT-5-Codex]         end
02631 [GPT-5-Codex]     end
02632 [GPT-5-Codex] 
02633 [GPT-5-Codex]     -- Estimate memory (assuming 2 bytes per pixel for RGB565)
02634 [GPT-5-Codex]     local estimatedBytes = totalPixels * 2
02635 [GPT-5-Codex]     local estimatedKB = estimatedBytes / 1024
02636 [GPT-5-Codex] 
02637 [GPT-5-Codex]     safeLog("INFO", string.format(
02638 [GPT-5-Codex]         "Texture memory summary: %d textures, %d total pixels, ~%.2f KB",
02639 [GPT-5-Codex]         textureCount, totalPixels, estimatedKB
02640 [GPT-5-Codex]     ))
02641 [GPT-5-Codex] 
02642 [GPT-5-Codex]     return {
02643 [GPT-5-Codex]         textureCount = textureCount,
02644 [GPT-5-Codex]         totalPixels = totalPixels,
02645 [GPT-5-Codex]         estimatedBytes = estimatedBytes,
02646 [GPT-5-Codex]         estimatedKB = estimatedKB
02647 [GPT-5-Codex]     }
02648 [GPT-5-Codex] end
02649 [GPT-5-Codex] 
02650 [GPT-5-Codex] local function unloadLevelAudio()
02651 [GPT-5-Codex]     if not audioInitialized then return end
02652 [GPT-5-Codex]     if gruntSample then
02653 [GPT-5-Codex]         vmupro.sound.sample.stop(gruntSample)
02654 [GPT-5-Codex]         vmupro.sound.sample.free(gruntSample)
02655 [GPT-5-Codex]         gruntSample = nil
02656 [GPT-5-Codex]     end
02657 [GPT-5-Codex]     if swordHitSample then
02658 [GPT-5-Codex]         vmupro.sound.sample.stop(swordHitSample)
02659 [GPT-5-Codex]         vmupro.sound.sample.free(swordHitSample)
02660 [GPT-5-Codex]         swordHitSample = nil
02661 [GPT-5-Codex]     end
02662 [GPT-5-Codex]     if swordMissSample then
02663 [GPT-5-Codex]         vmupro.sound.sample.stop(swordMissSample)
02664 [GPT-5-Codex]         vmupro.sound.sample.free(swordMissSample)
02665 [GPT-5-Codex]         swordMissSample = nil
02666 [GPT-5-Codex]     end
02667 [GPT-5-Codex]     if yahSample then
02668 [GPT-5-Codex]         vmupro.sound.sample.stop(yahSample)
02669 [GPT-5-Codex]         vmupro.sound.sample.free(yahSample)
02670 [GPT-5-Codex]         yahSample = nil
02671 [GPT-5-Codex]     end
02672 [GPT-5-Codex]     if winLevelSample then
02673 [GPT-5-Codex]         vmupro.sound.sample.stop(winLevelSample)
02674 [GPT-5-Codex]         vmupro.sound.sample.free(winLevelSample)
02675 [GPT-5-Codex]         winLevelSample = nil
02676 [GPT-5-Codex]     end
02677 [GPT-5-Codex]     if argDeathSample then
02678 [GPT-5-Codex]         vmupro.sound.sample.stop(argDeathSample)
02679 [GPT-5-Codex]         vmupro.sound.sample.free(argDeathSample)
02680 [GPT-5-Codex]         argDeathSample = nil
02681 [GPT-5-Codex]     end
02682 [GPT-5-Codex]     audioInitialized = false
02683 [GPT-5-Codex]     if audioSystemActive and not titleSample then
02684 [GPT-5-Codex]         vmupro.audio.exitListenMode()
02685 [GPT-5-Codex]         audioSystemActive = false
02686 [GPT-5-Codex]     end
02687 [GPT-5-Codex] end
02688 [GPT-5-Codex] 
02689 [GPT-5-Codex] local function loadLevelAudio()
02690 [GPT-5-Codex]     if audioInitialized then return end
02691 [GPT-5-Codex]     if not audioSystemActive then
02692 [GPT-5-Codex]         vmupro.audio.startListenMode()
02693 [GPT-5-Codex]         audioSystemActive = true
02694 [GPT-5-Codex]     end
02695 [GPT-5-Codex] 
02696 [GPT-5-Codex] 
02697 [GPT-5-Codex]     gruntSample = vmupro.sound.sample.new("sounds/grunt")
02698 [GPT-5-Codex]     if gruntSample then
02699 [GPT-5-Codex]         vmupro.sound.sample.setVolume(gruntSample, 0.7, 0.7)
02700 [GPT-5-Codex]         if enableBootLogs then safeLog("INFO", "Loaded sample: grunt") end
02701 [GPT-5-Codex]     else
02702 [GPT-5-Codex]         if enableBootLogs then safeLog("WARN", "Failed to load sample: grunt") end
02703 [GPT-5-Codex]     end
02704 [GPT-5-Codex] 
02705 [GPT-5-Codex]     swordHitSample = vmupro.sound.sample.new("sounds/sword_swing_connect")
02706 [GPT-5-Codex]     if swordHitSample then
02707 [GPT-5-Codex]         vmupro.sound.sample.setVolume(swordHitSample, 0.7, 0.7)
02708 [GPT-5-Codex]         if enableBootLogs then safeLog("INFO", "Loaded sample: sword_swing_connect") end
02709 [GPT-5-Codex]     else
02710 [GPT-5-Codex]         if enableBootLogs then safeLog("WARN", "Failed to load sample: sword_swing_connect") end
02711 [GPT-5-Codex]     end
02712 [GPT-5-Codex] 
02713 [GPT-5-Codex]     swordMissSample = vmupro.sound.sample.new("sounds/sword_miss")
02714 [GPT-5-Codex]     if swordMissSample then
02715 [GPT-5-Codex]         vmupro.sound.sample.setVolume(swordMissSample, 0.7, 0.7)
02716 [GPT-5-Codex]         if enableBootLogs then safeLog("INFO", "Loaded sample: sword_miss") end
02717 [GPT-5-Codex]     else
02718 [GPT-5-Codex]         if enableBootLogs then safeLog("WARN", "Failed to load sample: sword_miss") end
02719 [GPT-5-Codex]     end
02720 [GPT-5-Codex] 
02721 [GPT-5-Codex]     yahSample = vmupro.sound.sample.new("sounds/yah")
02722 [GPT-5-Codex]     if yahSample then
02723 [GPT-5-Codex]         vmupro.sound.sample.setVolume(yahSample, 0.7, 0.7)
02724 [GPT-5-Codex]         if enableBootLogs then safeLog("INFO", "Loaded sample: yah") end
02725 [GPT-5-Codex]     else
02726 [GPT-5-Codex]         if enableBootLogs then safeLog("WARN", "Failed to load sample: yah") end
02727 [GPT-5-Codex]     end
02728 [GPT-5-Codex] 
02729 [GPT-5-Codex]     winLevelSample = vmupro.sound.sample.new("sounds/win_level")
02730 [GPT-5-Codex]     if winLevelSample then
02731 [GPT-5-Codex]         vmupro.sound.sample.setVolume(winLevelSample, 0.7, 0.7)
02732 [GPT-5-Codex]         if enableBootLogs then safeLog("INFO", "Loaded sample: win_level") end
02733 [GPT-5-Codex]     else
02734 [GPT-5-Codex]         if enableBootLogs then safeLog("WARN", "Failed to load sample: win_level") end
02735 [GPT-5-Codex]     end
02736 [GPT-5-Codex] 
02737 [GPT-5-Codex]     argDeathSample = vmupro.sound.sample.new("sounds/arg_death1")
02738 [GPT-5-Codex]     if argDeathSample then
02739 [GPT-5-Codex]         vmupro.sound.sample.setVolume(argDeathSample, 0.7, 0.7)
02740 [GPT-5-Codex]         if enableBootLogs then safeLog("INFO", "Loaded sample: arg_death1") end
02741 [GPT-5-Codex]     else
02742 [GPT-5-Codex]         if enableBootLogs then safeLog("WARN", "Failed to load sample: arg_death1") end
02743 [GPT-5-Codex]     end
02744 [GPT-5-Codex] 
02745 [GPT-5-Codex]     audioInitialized = true
02746 [GPT-5-Codex] end
02747 [GPT-5-Codex] 
02748 [GPT-5-Codex] local function stopGameplaySamples()
02749 [GPT-5-Codex]     if gruntSample then vmupro.sound.sample.stop(gruntSample) end
02750 [GPT-5-Codex]     if swordHitSample then vmupro.sound.sample.stop(swordHitSample) end
02751 [GPT-5-Codex]     if swordMissSample then vmupro.sound.sample.stop(swordMissSample) end
02752 [GPT-5-Codex]     if yahSample then vmupro.sound.sample.stop(yahSample) end
02753 [GPT-5-Codex]     if winLevelSample then vmupro.sound.sample.stop(winLevelSample) end
02754 [GPT-5-Codex]     if argDeathSample then vmupro.sound.sample.stop(argDeathSample) end
02755 [GPT-5-Codex] end
02756 [GPT-5-Codex] 
02757 [GPT-5-Codex] local function loadTitleMusic()
02758 [GPT-5-Codex]     if titleSample and titleOverlaySample then return end
02759 [GPT-5-Codex]     if not audioSystemActive then
02760 [GPT-5-Codex]         vmupro.audio.startListenMode()
02761 [GPT-5-Codex]         audioSystemActive = true
02762 [GPT-5-Codex]     end
02763 [GPT-5-Codex]     vmupro.audio.setGlobalVolume(10)
02764 [GPT-5-Codex] 
02765 [GPT-5-Codex]     if not titleOverlaySample then
02766 [GPT-5-Codex]         titleOverlaySample = vmupro.sound.sample.new("sounds/inner_sanctum_44k1_adpcm_stereo")
02767 [GPT-5-Codex]     end
02768 [GPT-5-Codex]     if not titleSample then
02769 [GPT-5-Codex]         titleSample = vmupro.sound.sample.new("sounds/Intro_45sec")
02770 [GPT-5-Codex]     end
02771 [GPT-5-Codex] 
02772 [GPT-5-Codex]     if enableBootLogs and vmupro.system and vmupro.system.log then
02773 [GPT-5-Codex]         if titleOverlaySample then
02774 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title voice sample loaded")
02775 [GPT-5-Codex]         else
02776 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_ERROR, "AUDIO", "Title voice sample load failed")
02777 [GPT-5-Codex]         end
02778 [GPT-5-Codex]         if titleSample then
02779 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title music sample loaded")
02780 [GPT-5-Codex]         else
02781 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_ERROR, "AUDIO", "Title music sample load failed")
02782 [GPT-5-Codex]         end
02783 [GPT-5-Codex]     end
02784 [GPT-5-Codex] 
02785 [GPT-5-Codex]     if titleOverlaySample then
02786 [GPT-5-Codex]         vmupro.sound.sample.setVolume(titleOverlaySample, TITLE_VOICE_VOLUME, TITLE_VOICE_VOLUME)
02787 [GPT-5-Codex]     end
02788 [GPT-5-Codex]     if titleSample then
02789 [GPT-5-Codex]         vmupro.sound.sample.setVolume(titleSample, TITLE_MUSIC_VOLUME, TITLE_MUSIC_VOLUME)
02790 [GPT-5-Codex]     end
02791 [GPT-5-Codex] end
02792 [GPT-5-Codex] 
02793 [GPT-5-Codex] local function isSamplePlayingSafe(sample, context)
02794 [GPT-5-Codex]     if not sample then return false end
02795 [GPT-5-Codex]     local ok, playing = pcall(vmupro.sound.sample.isPlaying, sample)
02796 [GPT-5-Codex]     if not ok then
02797 [GPT-5-Codex]         if enableBootLogs and vmupro.system and vmupro.system.log then
02798 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_WARN, "AUDIO", tostring(context) .. " isPlaying check failed: " .. tostring(playing))
02799 [GPT-5-Codex]         end
02800 [GPT-5-Codex]         return false
02801 [GPT-5-Codex]     end
02802 [GPT-5-Codex]     return playing == true
02803 [GPT-5-Codex] end
02804 [GPT-5-Codex] 
02805 [GPT-5-Codex] local function playTitleVoice()
02806 [GPT-5-Codex]     if not titleOverlaySample then return false end
02807 [GPT-5-Codex]     vmupro.sound.sample.setVolume(titleOverlaySample, TITLE_VOICE_VOLUME, TITLE_VOICE_VOLUME)
02808 [GPT-5-Codex]     local ok, err = pcall(vmupro.sound.sample.play, titleOverlaySample, TITLE_VOICE_REPEAT_COUNT)
02809 [GPT-5-Codex]     if enableBootLogs and vmupro.system and vmupro.system.log then
02810 [GPT-5-Codex]         if ok then
02811 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title voice play")
02812 [GPT-5-Codex]         else
02813 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_ERROR, "AUDIO", "Title voice play failed: " .. tostring(err))
02814 [GPT-5-Codex]         end
02815 [GPT-5-Codex]     end
02816 [GPT-5-Codex]     if ok then titleVoiceStarted = true end
02817 [GPT-5-Codex]     return ok
02818 [GPT-5-Codex] end
02819 [GPT-5-Codex] 
02820 [GPT-5-Codex] local function playTitleMusic(reason)
02821 [GPT-5-Codex]     if not titleSample then return false end
02822 [GPT-5-Codex]     vmupro.sound.sample.setVolume(titleSample, TITLE_MUSIC_VOLUME, TITLE_MUSIC_VOLUME)
02823 [GPT-5-Codex]     local ok, err = pcall(vmupro.sound.sample.play, titleSample, TITLE_MUSIC_REPEAT_COUNT)
02824 [GPT-5-Codex]     if enableBootLogs and vmupro.system and vmupro.system.log then
02825 [GPT-5-Codex]         if ok then
02826 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_INFO, "AUDIO", "Title music play loops=" .. tostring(TITLE_MUSIC_REPEAT_COUNT) .. " reason=" .. tostring(reason))
02827 [GPT-5-Codex]         else
02828 [GPT-5-Codex]             vmupro.system.log(vmupro.system.LOG_ERROR, "AUDIO", "Title music play failed reason=" .. tostring(reason) .. " err=" .. tostring(err))
02829 [GPT-5-Codex]         end
02830 [GPT-5-Codex]     end
02831 [GPT-5-Codex]     if ok then
02832 [GPT-5-Codex]         titleMusicStarted = true
02833 [GPT-5-Codex]         titleMusicStartUs = (vmupro.system and vmupro.system.getTimeUs and vmupro.system.getTimeUs()) or 0
02834 [GPT-5-Codex]     end
02835 [GPT-5-Codex]     return ok
02836 [GPT-5-Codex] end
02837 [GPT-5-Codex] 
02838 [GPT-5-Codex] local function stopTitleMusic()
02839 [GPT-5-Codex]     if titleSample then
02840 [GPT-5-Codex]         vmupro.sound.sample.stop(titleSample)
02841 [GPT-5-Codex]         vmupro.sound.sample.free(titleSample)
02842 [GPT-5-Codex]         titleSample = nil
02843 [GPT-5-Codex]     end
02844 [GPT-5-Codex]     if titleOverlaySample then
02845 [GPT-5-Codex]         vmupro.sound.sample.stop(titleOverlaySample)
02846 [GPT-5-Codex]         vmupro.sound.sample.free(titleOverlaySample)
02847 [GPT-5-Codex]         titleOverlaySample = nil
02848 [GPT-5-Codex]     end
02849 [GPT-5-Codex]     titleMusicState = "stopped"
02850 [GPT-5-Codex]     titleMusicTimer = 0
02851 [GPT-5-Codex]     titleMusicStartUs = 0
02852 [GPT-5-Codex]     titleVoiceStarted = false
02853 [GPT-5-Codex]     titleMusicStarted = false
02854 [GPT-5-Codex]     if audioSystemActive and not audioInitialized then
02855 [GPT-5-Codex]         vmupro.audio.exitListenMode()
02856 [GPT-5-Codex]         audioSystemActive = false
02857 [GPT-5-Codex]     end
02858 [GPT-5-Codex] end
02859 [GPT-5-Codex] 
02860 [GPT-5-Codex] local function startTitleMusic()
02861 [GPT-5-Codex]     if not soundEnabled then return end
02862 [GPT-5-Codex]     loadTitleMusic()
02863 [GPT-5-Codex]     titleMusicTimer = 0
02864 [GPT-5-Codex]     titleMusicStartUs = 0
02865 [GPT-5-Codex]     titleVoiceStarted = false
02866 [GPT-5-Codex]     titleMusicStarted = false
02867 [GPT-5-Codex] 
02868 [GPT-5-Codex]     if playTitleVoice() then
02869 [GPT-5-Codex]         titleMusicState = "voice_playing"
02870 [GPT-5-Codex]         return
02871 [GPT-5-Codex]     end
02872 [GPT-5-Codex] 
02873 [GPT-5-Codex]     if playTitleMusic("voice_missing_or_failed") then
02874 [GPT-5-Codex]         titleMusicState = "music_playing"
02875 [GPT-5-Codex]     else
02876 [GPT-5-Codex]         titleMusicState = "stopped"
02877 [GPT-5-Codex]     end
02878 [GPT-5-Codex] end
02879 [GPT-5-Codex] 
02880 [GPT-5-Codex] local function updateTitleMusic()
02881 [GPT-5-Codex]     if not soundEnabled then
02882 [GPT-5-Codex]         if titleMusicState ~= "stopped" then
02883 [GPT-5-Codex]             stopTitleMusic()
02884 [GPT-5-Codex]         end
02885 [GPT-5-Codex]         return
02886 [GPT-5-Codex]     end
02887 [GPT-5-Codex]     if gameState ~= STATE_TITLE then
02888 [GPT-5-Codex]         if titleMusicState ~= "stopped" then
02889 [GPT-5-Codex]             stopTitleMusic()
02890 [GPT-5-Codex]         end
02891 [GPT-5-Codex]         return
02892 [GPT-5-Codex]     end
02893 [GPT-5-Codex] 
02894 [GPT-5-Codex]     if titleMusicState == "stopped" then
02895 [GPT-5-Codex]         startTitleMusic()
02896 [GPT-5-Codex]         return
02897 [GPT-5-Codex]     end
02898 [GPT-5-Codex] 
02899 [GPT-5-Codex]     if titleMusicState == "voice_playing" then
02900 [GPT-5-Codex]         if not isSamplePlayingSafe(titleOverlaySample, "Title voice") then
02901 [GPT-5-Codex]             if playTitleMusic("voice_finished") then
02902 [GPT-5-Codex]                 titleMusicState = "music_playing"
02903 [GPT-5-Codex]             else
02904 [GPT-5-Codex]                 titleMusicState = "stopped"
02905 [GPT-5-Codex]             end
02906 [GPT-5-Codex]         end
02907 [GPT-5-Codex]         return
02908 [GPT-5-Codex]     end
02909 [GPT-5-Codex] 
02910 [GPT-5-Codex]     if titleMusicState == "music_playing" then
02911 [GPT-5-Codex]         titleMusicTimer = titleMusicTimer + 1
02912 [GPT-5-Codex]         if titleMusicStarted and not isSamplePlayingSafe(titleSample, "Title music") then
02913 [GPT-5-Codex]             playTitleMusic("music_stopped_early")
02914 [GPT-5-Codex]         end
02915 [GPT-5-Codex]         return
02916 [GPT-5-Codex]     end
02917 [GPT-5-Codex] 
02918 [GPT-5-Codex]     titleMusicState = "stopped"
02919 [GPT-5-Codex] end
02920 [GPT-5-Codex] 
02921 [GPT-5-Codex] local function enterTitle()
02922 [GPT-5-Codex]     showMenu = false
02923 [GPT-5-Codex]     inOptionsMenu = false
02924 [GPT-5-Codex]     inGameDebugMenu = false
02925 [GPT-5-Codex]     inSaveMenu = false
02926 [GPT-5-Codex]     saveMenuSelection = 1
02927 [GPT-5-Codex]     saveMenuMessage = ""
02928 [GPT-5-Codex]     saveMenuMessageTimer = 0
02929 [GPT-5-Codex]     gameState = STATE_TITLE
02930 [GPT-5-Codex]     titleSelection = 1
02931 [GPT-5-Codex]     titleInClassSelect = false
02932 [GPT-5-Codex]     titleClassSelection = getClassSelectionIndexForId(getCurrentClassId())
02933 [GPT-5-Codex]     titleInLoadMenu = false
02934 [GPT-5-Codex]     titleLoadSelection = 1
02935 [GPT-5-Codex]     titleInOptions = false
02936 [GPT-5-Codex]     titleInDebug = false
02937 [GPT-5-Codex]     loadSaveSlotsFromDisk()
02938 [GPT-5-Codex]     titleNeedsRedraw = true
02939 [GPT-5-Codex]     unloadLevelAudio()
02940 [GPT-5-Codex]     unloadLevelSprites()
02941 [GPT-5-Codex]     unloadLevelData()
02942 [GPT-5-Codex]     unloadWallTextures()
02943 [GPT-5-Codex]     loadMenuSprites()
02944 [GPT-5-Codex]     collectgarbage()
02945 [GPT-5-Codex]     startTitleMusic()
02946 [GPT-5-Codex] end
02947 [GPT-5-Codex] 
02948 [GPT-5-Codex] local function initializeLevelState(levelId)
02949 [GPT-5-Codex]     loadLevel(levelId)
02950 [GPT-5-Codex]     playerHealth = MAX_HEALTH
02951 [GPT-5-Codex]     beginExpansionRun(levelId)
02952 [GPT-5-Codex]     soldiersKilled = 0
02953 [GPT-5-Codex]     isAttacking = 0
02954 [GPT-5-Codex]     isBlocking = false
02955 [GPT-5-Codex]     blockAnim = 0
02956 [GPT-5-Codex]     showMenu = false
02957 [GPT-5-Codex]     inOptionsMenu = false
02958 [GPT-5-Codex]     inGameDebugMenu = false
02959 [GPT-5-Codex]     inSaveMenu = false
02960 [GPT-5-Codex]     saveMenuSelection = 1
02961 [GPT-5-Codex]     saveMenuMessage = ""
02962 [GPT-5-Codex]     saveMenuMessageTimer = 0
02963 [GPT-5-Codex]     bloodEffects = {}
02964 [GPT-5-Codex]     levelBannerTimer = levelBannerMax
02965 [GPT-5-Codex] end
02966 [GPT-5-Codex] 
02967 [GPT-5-Codex] local function startLevel(levelId)
02968 [GPT-5-Codex]     loadingLog("LOAD startLevel begin " .. tostring(levelId))
02969 [GPT-5-Codex]     -- Ensure we free previous level assets to avoid sprite slot exhaustion
02970 [GPT-5-Codex]     unloadLevelData()
02971 [GPT-5-Codex]     unloadLevelSprites()
02972 [GPT-5-Codex]     unloadWallTextures()
02973 [GPT-5-Codex]     collectgarbage()
02974 [GPT-5-Codex]     stopTitleMusic()
02975 [GPT-5-Codex]     unloadMenuSprites()
02976 [GPT-5-Codex]     loadingLog("LOAD after unloadMenuSprites")
02977 [GPT-5-Codex]     loadLevelSprites(levelId)
02978 [GPT-5-Codex]     loadingLog("LOAD after loadLevelSprites")
02979 [GPT-5-Codex]     loadLevelAudio()
02980 [GPT-5-Codex]     loadingLog("LOAD after loadLevelAudio")
02981 [GPT-5-Codex]     initializeLevelState(levelId)
02982 [GPT-5-Codex]     loadingLog("LOAD after initializeLevelState")
02983 [GPT-5-Codex]     gameState = STATE_PLAYING
02984 [GPT-5-Codex]     loadingLog("LOAD startLevel done")
02985 [GPT-5-Codex] end
02986 [GPT-5-Codex] 
02987 [GPT-5-Codex] local function restartLevel()
02988 [GPT-5-Codex]     startLevel(currentLevel)
02989 [GPT-5-Codex] end
02990 [GPT-5-Codex] 
02991 [GPT-5-Codex] beginLoadLevel = function(levelId)
02992 [GPT-5-Codex]     pendingLevelStart = nil
02993 [GPT-5-Codex]     loadingTimer = 0
02994 [GPT-5-Codex]     loadingLogCount = 0
02995 [GPT-5-Codex]     loadingLog("LOAD beginLoadLevel (loading disabled) " .. tostring(levelId))
02996 [GPT-5-Codex]     wallQuadLogCount = 0
02997 [GPT-5-Codex]     wallQuadLog("WQ beginLoadLevel (loading disabled) " .. tostring(levelId))
02998 [GPT-5-Codex]     startLevel(levelId)
02999 [GPT-5-Codex] end
03000 [GPT-5-Codex] 
03001 [GPT-5-Codex] -- Check if a position is walkable (no wall)
03002 [GPT-5-Codex] local function isWalkable(x, y)
03003 [GPT-5-Codex]     local r = (PLAYER_RADIUS or 0.25) * 0.85
03004 [GPT-5-Codex]     local x1, x2 = x - r, x + r
03005 [GPT-5-Codex]     local y1, y2 = y - r, y + r
03006 [GPT-5-Codex]     local mx1, mx2 = math.floor(x1), math.floor(x2)
03007 [GPT-5-Codex]     local my1, my2 = math.floor(y1), math.floor(y2)
03008 [GPT-5-Codex]     if mx1 < 0 or mx2 >= 16 or my1 < 0 or my2 >= 16 then return false end
03009 [GPT-5-Codex]     return map[my1 + 1][mx1 + 1] == 0
03010 [GPT-5-Codex]         and map[my1 + 1][mx2 + 1] == 0
03011 [GPT-5-Codex]         and map[my2 + 1][mx1 + 1] == 0
03012 [GPT-5-Codex]         and map[my2 + 1][mx2 + 1] == 0
03013 [GPT-5-Codex] end
03014 [GPT-5-Codex] 
03015 [GPT-5-Codex] 
03016 [GPT-5-Codex] -- Safe atan2 implementation
03017 [GPT-5-Codex] local function safeAtan2(y, x)
03018 [GPT-5-Codex]     if x == 0 then
03019 [GPT-5-Codex]         if y > 0 then return 1.5708
03020 [GPT-5-Codex]         elseif y < 0 then return -1.5708
03021 [GPT-5-Codex]         else return 0 end
03022 [GPT-5-Codex]     end
03023 [GPT-5-Codex]     local angle = math.atan(y / x)
03024 [GPT-5-Codex]     if x < 0 then angle = angle + 3.14159 end
03025 [GPT-5-Codex]     return angle
03026 [GPT-5-Codex] end
03027 [GPT-5-Codex] 
03028 [GPT-5-Codex] -- Soldier AI: patrol, chase, and attack
03029 [GPT-5-Codex] local function updateSoldiers()
03030 [GPT-5-Codex]     if DEBUG_DISABLE_ENEMIES then
03031 [GPT-5-Codex]         return
03032 [GPT-5-Codex]     end
03033 [GPT-5-Codex]     if not sprites or #sprites == 0 then
03034 [GPT-5-Codex]         return
03035 [GPT-5-Codex]     end
03036 [GPT-5-Codex]     for i = 1, #sprites do
03037 [GPT-5-Codex]         local s = sprites[i]
03038 [GPT-5-Codex]         if s and s.t == 5 and s.speed then  -- Warriors with movement data
03039 [GPT-5-Codex]             -- Skip dead soldiers
03040 [GPT-5-Codex]             if s.alive == false then
03041 [GPT-5-Codex]                 goto continue
03042 [GPT-5-Codex]             end
03043 [GPT-5-Codex] 
03044 [GPT-5-Codex]             -- Initialize state if not set
03045 [GPT-5-Codex]             if not s.state then
03046 [GPT-5-Codex]                 s.state = "patrol"
03047 [GPT-5-Codex]                 s.patrolDir = 1
03048 [GPT-5-Codex]                 s.patrolAxis = (i % 2 == 0) and "x" or "y"
03049 [GPT-5-Codex]                 s.startX = s.x
03050 [GPT-5-Codex]                 s.startY = s.y
03051 [GPT-5-Codex]                 s.attackCooldown = 0
03052 [GPT-5-Codex]             end
03053 [GPT-5-Codex] 
03054 [GPT-5-Codex]             -- Calculate distance to player (cheap cull first)
03055 [GPT-5-Codex]             local dx = px - s.x
03056 [GPT-5-Codex]             local dy = py - s.y
03057 [GPT-5-Codex]             local distSq = dx * dx + dy * dy
03058 [GPT-5-Codex]             if distSq > SOLDIER_ACTIVE_DIST_SQ and (simTickCount % 8) ~= 0 then
03059 [GPT-5-Codex]                 goto continue
03060 [GPT-5-Codex]             end
03061 [GPT-5-Codex]             local distToPlayer = math.sqrt(distSq)
03062 [GPT-5-Codex]             if distToPlayer < 0.001 then
03063 [GPT-5-Codex]                 distToPlayer = 0.001
03064 [GPT-5-Codex]             end
03065 [GPT-5-Codex] 
03066 [GPT-5-Codex]             if DEBUG_DISABLE_ENEMY_AGGRO then
03067 [GPT-5-Codex]                 distToPlayer = 999  -- Force patrol state
03068 [GPT-5-Codex]                 s.attackCooldown = 0
03069 [GPT-5-Codex]                 -- Face the player for consistent side-view testing
03070 [GPT-5-Codex]                 local angleToPlayer = safeAtan2(dy, dx)
03071 [GPT-5-Codex]                 s.dir = math.floor(angleToPlayer * 64 / 6.28318) % 64
03072 [GPT-5-Codex]             end
03073 [GPT-5-Codex] 
03074 [GPT-5-Codex]             if DEBUG_WALK_IN_PLACE then
03075 [GPT-5-Codex]                 s.state = "patrol"
03076 [GPT-5-Codex]                 if s.patrolAxis == "x" then
03077 [GPT-5-Codex]                     s.dir = (s.patrolDir > 0) and 0 or 32
03078 [GPT-5-Codex]                 else
03079 [GPT-5-Codex]                     s.dir = (s.patrolDir > 0) and 16 or 48
03080 [GPT-5-Codex]                 end
03081 [GPT-5-Codex]                 s.anim = ((s.anim or 0) + 1) % 20
03082 [GPT-5-Codex]                 goto continue
03083 [GPT-5-Codex]             end
03084 [GPT-5-Codex] 
03085 [GPT-5-Codex]             -- Decrease attack cooldown
03086 [GPT-5-Codex]             if s.attackCooldown > 0 then
03087 [GPT-5-Codex]                 s.attackCooldown = s.attackCooldown - 1
03088 [GPT-5-Codex]             end
03089 [GPT-5-Codex] 
03090 [GPT-5-Codex]             -- State machine
03091 [GPT-5-Codex]             if distToPlayer < ATTACK_RANGE then
03092 [GPT-5-Codex]                 -- Close enough to attack
03093 [GPT-5-Codex]                 s.state = "attack"
03094 [GPT-5-Codex] 
03095 [GPT-5-Codex]                 -- Face the player
03096 [GPT-5-Codex]                 local angleToPlayer = safeAtan2(dy, dx)
03097 [GPT-5-Codex]                 s.dir = math.floor(angleToPlayer * 64 / 6.28318) % 64
03098 [GPT-5-Codex] 
03099 [GPT-5-Codex]                 -- Attack if cooldown is ready
03100 [GPT-5-Codex]                 if s.attackCooldown <= 0 then
03101 [GPT-5-Codex]                     s.attackCooldown = ATTACK_COOLDOWN
03102 [GPT-5-Codex]                     s.attackAnim = 7
03103 [GPT-5-Codex]                     s.attackFrame = 1
03104 [GPT-5-Codex]                     s.attackStartTick = simTickCount
03105 [GPT-5-Codex]                     s.attackDidHit = false
03106 [GPT-5-Codex] 
03107 [GPT-5-Codex]                     -- Soldier attack sound
03108 [GPT-5-Codex]                     if yahSample and soundEnabled then
03109 [GPT-5-Codex]                         vmupro.sound.sample.stop(yahSample)
03110 [GPT-5-Codex]                         vmupro.sound.sample.play(yahSample)
03111 [GPT-5-Codex]                         if enableBootLogs then safeLog("INFO", "Play sample: yah") end
03112 [GPT-5-Codex]                     end
03113 [GPT-5-Codex] 
03114 [GPT-5-Codex] 
03115 [GPT-5-Codex]                 end
03116 [GPT-5-Codex] 
03117 [GPT-5-Codex]             elseif distToPlayer < DETECTION_RANGE then
03118 [GPT-5-Codex]                 -- Player detected - chase!
03119 [GPT-5-Codex]                 if s.state ~= "chase" and not s.aggroed then
03120 [GPT-5-Codex]                     s.aggroed = true
03121 [GPT-5-Codex]                     if gruntSample and soundEnabled then
03122 [GPT-5-Codex]                         vmupro.sound.sample.stop(gruntSample)
03123 [GPT-5-Codex]                         vmupro.sound.sample.play(gruntSample)
03124 [GPT-5-Codex]                         if enableBootLogs then safeLog("INFO", "Play sample: grunt") end
03125 [GPT-5-Codex]                     end
03126 [GPT-5-Codex]                 end
03127 [GPT-5-Codex]                 s.state = "chase"
03128 [GPT-5-Codex] 
03129 [GPT-5-Codex]                 -- Move towards player (sprint!)
03130 [GPT-5-Codex]                 local moveSpeed = s.speed * CHASE_SPEED_MULT * SOLDIER_SPEED_SCALE
03131 [GPT-5-Codex]                 local moveX = (dx / distToPlayer) * moveSpeed
03132 [GPT-5-Codex]                 local moveY = (dy / distToPlayer) * moveSpeed
03133 [GPT-5-Codex]                 local newX = s.x + moveX
03134 [GPT-5-Codex]                 local newY = s.y + moveY
03135 [GPT-5-Codex] 
03136 [GPT-5-Codex]                 if isWalkable(newX, newY) then
03137 [GPT-5-Codex]                     s.x = newX
03138 [GPT-5-Codex]                     s.y = newY
03139 [GPT-5-Codex] 
03140 [GPT-5-Codex]                     -- Update facing direction towards player
03141 [GPT-5-Codex]                     local angleToPlayer = safeAtan2(dy, dx)
03142 [GPT-5-Codex]                     s.dir = math.floor(angleToPlayer * 64 / 6.28318) % 64
03143 [GPT-5-Codex] 
03144 [GPT-5-Codex]                     -- Update animation frame
03145 [GPT-5-Codex]                     s.anim = ((s.anim or 0) + 1) % 20
03146 [GPT-5-Codex]                 end
03147 [GPT-5-Codex] 
03148 [GPT-5-Codex]             else
03149 [GPT-5-Codex]                 -- Patrol mode
03150 [GPT-5-Codex]                 s.state = "patrol"
03151 [GPT-5-Codex] 
03152 [GPT-5-Codex]                 local moveAmount = s.speed * s.patrolDir * SOLDIER_SPEED_SCALE
03153 [GPT-5-Codex]                 local newX, newY = s.x, s.y
03154 [GPT-5-Codex] 
03155 [GPT-5-Codex]                 if s.patrolAxis == "x" then
03156 [GPT-5-Codex]                     newX = s.x + moveAmount
03157 [GPT-5-Codex]                     s.dir = (s.patrolDir > 0) and 0 or 32
03158 [GPT-5-Codex]                 else
03159 [GPT-5-Codex]                     newY = s.y + moveAmount
03160 [GPT-5-Codex]                     s.dir = (s.patrolDir > 0) and 16 or 48
03161 [GPT-5-Codex]                 end
03162 [GPT-5-Codex] 
03163 [GPT-5-Codex]                 local patrolDist = 3
03164 [GPT-5-Codex]                 local distFromStart
03165 [GPT-5-Codex]                 if s.patrolAxis == "x" then
03166 [GPT-5-Codex]                     distFromStart = newX - s.startX
03167 [GPT-5-Codex]                 else
03168 [GPT-5-Codex]                     distFromStart = newY - s.startY
03169 [GPT-5-Codex]                 end
03170 [GPT-5-Codex] 
03171 [GPT-5-Codex]                 if math.abs(distFromStart) > patrolDist or not isWalkable(newX, newY) then
03172 [GPT-5-Codex]                     s.patrolDir = -s.patrolDir
03173 [GPT-5-Codex]                 else
03174 [GPT-5-Codex]                     if not DEBUG_WALK_IN_PLACE then
03175 [GPT-5-Codex]                         s.x = newX
03176 [GPT-5-Codex]                         s.y = newY
03177 [GPT-5-Codex]                     end
03178 [GPT-5-Codex]                     s.anim = ((s.anim or 0) + 1) % 20
03179 [GPT-5-Codex]                 end
03180 [GPT-5-Codex]             end
03181 [GPT-5-Codex] 
03182 [GPT-5-Codex]             if s.attackAnim and s.attackAnim > 0 then
03183 [GPT-5-Codex]                 s.attackAnim = s.attackAnim - 1
03184 [GPT-5-Codex]                 if s.attackAnim == 3 then
03185 [GPT-5-Codex]                     s.attackFrame = 2
03186 [GPT-5-Codex]                     if not s.attackDidHit and distToPlayer <= ATTACK_RANGE then
03187 [GPT-5-Codex]                         local damage = DAMAGE_PER_HIT
03188 [GPT-5-Codex]                         local primeBlock = false
03189 [GPT-5-Codex]                         if isBlocking and blockAnim > 0 then
03190 [GPT-5-Codex]                             -- Prime block: raised at/after enemy attack start and before hit connect.
03191 [GPT-5-Codex]                             if blockStartFrame
03192 [GPT-5-Codex]                                 and blockStartFrame >= (s.attackStartTick or -1000)
03193 [GPT-5-Codex]                                 and blockStartFrame <= simTickCount then
03194 [GPT-5-Codex]                                 primeBlock = true
03195 [GPT-5-Codex]                                 damage = 0
03196 [GPT-5-Codex]                             else
03197 [GPT-5-Codex]                                 damage = math.floor(DAMAGE_PER_HIT * 0.5 + 0.5)
03198 [GPT-5-Codex]                             end
03199 [GPT-5-Codex]                         end
03200 [GPT-5-Codex]                         if damage > 0 then
03201 [GPT-5-Codex]                             playerHealth = playerHealth - damage
03202 [GPT-5-Codex]                             if playerHealth <= 0 then
03203 [GPT-5-Codex]                                 playerHealth = 0
03204 [GPT-5-Codex]                                 gameState = STATE_GAME_OVER
03205 [GPT-5-Codex]                                 gameOverSelection = 1
03206 [GPT-5-Codex]                             end
03207 [GPT-5-Codex]                         end
03208 [GPT-5-Codex]                         if isBlocking and blockAnim > 0 then
03209 [GPT-5-Codex]                             local pct = primeBlock and 1.0 or 0.5
03210 [GPT-5-Codex]                             lastBlockEvent = {
03211 [GPT-5-Codex]                                 amount = DAMAGE_PER_HIT - damage,
03212 [GPT-5-Codex]                                 pct = pct,
03213 [GPT-5-Codex]                                 prime = primeBlock,
03214 [GPT-5-Codex]                                 frame = frameCount
03215 [GPT-5-Codex]                             }
03216 [GPT-5-Codex]                         end
03217 [GPT-5-Codex]                         s.attackDidHit = true
03218 [GPT-5-Codex]                     end
03219 [GPT-5-Codex]                 elseif s.attackAnim <= 0 then
03220 [GPT-5-Codex]                     s.attackAnim = 0
03221 [GPT-5-Codex]                 end
03222 [GPT-5-Codex]             end
03223 [GPT-5-Codex]             ::continue::
03224 [GPT-5-Codex]         end
03225 [GPT-5-Codex]     end
03226 [GPT-5-Codex] end
03227 [GPT-5-Codex] 
03228 [GPT-5-Codex] local function updateDeathAnimations()
03229 [GPT-5-Codex]     if not sprites or #sprites == 0 then return end
03230 [GPT-5-Codex]     for i = 1, #sprites do
03231 [GPT-5-Codex]         local s = sprites[i]
03232 [GPT-5-Codex]         if s and s.t == 5 and s.dying then
03233 [GPT-5-Codex]             if #warriorDeath == 0 then
03234 [GPT-5-Codex]                 s.dying = false
03235 [GPT-5-Codex]                 s.dead = true
03236 [GPT-5-Codex]             else
03237 [GPT-5-Codex]                 s.deathTick = (s.deathTick or 0) + 1
03238 [GPT-5-Codex]                 if s.deathTick % 2 == 0 then
03239 [GPT-5-Codex]                     s.deathFrame = (s.deathFrame or 1) + 1
03240 [GPT-5-Codex]                     if s.deathFrame > #warriorDeath then
03241 [GPT-5-Codex]                         s.dying = false
03242 [GPT-5-Codex]                         s.dead = true
03243 [GPT-5-Codex]                     end
03244 [GPT-5-Codex]                 end
03245 [GPT-5-Codex]             end
03246 [GPT-5-Codex]         end
03247 [GPT-5-Codex]     end
03248 [GPT-5-Codex] end
03249 [GPT-5-Codex] 
03250 [GPT-5-Codex] -- Create blood burst effect at world position
03251 [GPT-5-Codex] local function createBloodEffect(worldX, worldY)
03252 [GPT-5-Codex]     local effect = {
03253 [GPT-5-Codex]         x = worldX,
03254 [GPT-5-Codex]         y = worldY,
03255 [GPT-5-Codex]         particles = {},
03256 [GPT-5-Codex]         life = 30  -- frames
03257 [GPT-5-Codex]     }
03258 [GPT-5-Codex]     -- Create 12 blood particles radiating outward
03259 [GPT-5-Codex]     for i = 1, 12 do
03260 [GPT-5-Codex]         local angle = (i / 12) * 6.28318
03261 [GPT-5-Codex]         local speed = 0.05 + (frameCount % 10) * 0.005
03262 [GPT-5-Codex]         table.insert(effect.particles, {
03263 [GPT-5-Codex]             dx = math.cos(angle) * speed,
03264 [GPT-5-Codex]             dy = math.sin(angle) * speed,
03265 [GPT-5-Codex]             ox = 0, oy = 0  -- offset from center
03266 [GPT-5-Codex]         })
03267 [GPT-5-Codex]     end
03268 [GPT-5-Codex]     table.insert(bloodEffects, effect)
03269 [GPT-5-Codex] end
03270 [GPT-5-Codex] 
03271 [GPT-5-Codex] -- Update blood effects
03272 [GPT-5-Codex] local function updateBloodEffects()
03273 [GPT-5-Codex]     local i = 1
03274 [GPT-5-Codex]     while i <= #bloodEffects do
03275 [GPT-5-Codex]         local e = bloodEffects[i]
03276 [GPT-5-Codex]         e.life = e.life - 1
03277 [GPT-5-Codex]         -- Move particles outward
03278 [GPT-5-Codex]         for _, p in ipairs(e.particles) do
03279 [GPT-5-Codex]             p.ox = p.ox + p.dx
03280 [GPT-5-Codex]             p.oy = p.oy + p.dy
03281 [GPT-5-Codex]         end
03282 [GPT-5-Codex]         if e.life <= 0 then
03283 [GPT-5-Codex]             -- PERFORMANCE: swap-and-pop for O(1) removal instead of O(n)
03284 [GPT-5-Codex]             local lastIdx = #bloodEffects
03285 [GPT-5-Codex]             bloodEffects[i] = bloodEffects[lastIdx]
03286 [GPT-5-Codex]             bloodEffects[lastIdx] = nil
03287 [GPT-5-Codex]             -- Don't increment i since we swapped in a new element to check
03288 [GPT-5-Codex]         else
03289 [GPT-5-Codex]             i = i + 1
03290 [GPT-5-Codex]         end
03291 [GPT-5-Codex]     end
03292 [GPT-5-Codex] end
03293 [GPT-5-Codex] 
03294 [GPT-5-Codex] -- Kill a soldier and create death effects
03295 [GPT-5-Codex] local function killSoldier(soldier)
03296 [GPT-5-Codex]     soldier.alive = false
03297 [GPT-5-Codex]     soldier.hp = 0
03298 [GPT-5-Codex]     soldier.dying = true
03299 [GPT-5-Codex]     soldier.dead = false
03300 [GPT-5-Codex]     soldier.deathFrame = 1
03301 [GPT-5-Codex]     soldier.deathTick = 0
03302 [GPT-5-Codex]     soldiersKilled = soldiersKilled + 1
03303 [GPT-5-Codex] 
03304 [GPT-5-Codex]     -- Create blood effect
03305 [GPT-5-Codex]     createBloodEffect(soldier.x, soldier.y)
03306 [GPT-5-Codex] 
03307 [GPT-5-Codex]     -- Play death sounds
03308 [GPT-5-Codex]     if soundEnabled then
03309 [GPT-5-Codex]         if argDeathSample then
03310 [GPT-5-Codex]             vmupro.sound.sample.stop(argDeathSample)
03311 [GPT-5-Codex]             vmupro.sound.sample.play(argDeathSample)
03312 [GPT-5-Codex]             if enableBootLogs then safeLog("INFO", "Play sample: arg_death1") end
03313 [GPT-5-Codex]         end
03314 [GPT-5-Codex]     end
03315 [GPT-5-Codex] 
03316 [GPT-5-Codex]     -- Check win condition
03317 [GPT-5-Codex]     if soldiersKilled >= totalSoldiers then
03318 [GPT-5-Codex]         gameState = STATE_WIN
03319 [GPT-5-Codex]         winSelection = 1
03320 [GPT-5-Codex]         winCooldown = 30  -- Half second delay before accepting input
03321 [GPT-5-Codex]         winBannerTimer = winBannerMax
03322 [GPT-5-Codex]         if soundEnabled and winLevelSample then
03323 [GPT-5-Codex]             vmupro.sound.sample.stop(winLevelSample)
03324 [GPT-5-Codex]             vmupro.sound.sample.play(winLevelSample)
03325 [GPT-5-Codex]             if enableBootLogs then safeLog("INFO", "Play sample: win_level") end
03326 [GPT-5-Codex]         end
03327 [GPT-5-Codex]     end
03328 [GPT-5-Codex] end
03329 [GPT-5-Codex] 
03330 [GPT-5-Codex] -- Check for health vial pickups
03331 [GPT-5-Codex] local function checkHealthPickups()
03332 [GPT-5-Codex]     if DEBUG_DISABLE_PROPS then
03333 [GPT-5-Codex]         return
03334 [GPT-5-Codex]     end
03335 [GPT-5-Codex]     local pickupRange = 0.8  -- Distance to pick up vial
03336 [GPT-5-Codex]     local pickupRangeSq = pickupRange * pickupRange
03337 [GPT-5-Codex]     if not sprites or #sprites == 0 then return end
03338 [GPT-5-Codex]     for i = 1, #sprites do
03339 [GPT-5-Codex]         local s = sprites[i]
03340 [GPT-5-Codex]         if s and s.t == 7 and not s.collected then
03341 [GPT-5-Codex]             local dx = s.x - px
03342 [GPT-5-Codex]             local dy = s.y - py
03343 [GPT-5-Codex]             local distSq = dx * dx + dy * dy
03344 [GPT-5-Codex]             if distSq < pickupRangeSq then
03345 [GPT-5-Codex]                 -- Collect the vial
03346 [GPT-5-Codex]                 s.collected = true
03347 [GPT-5-Codex]                 playerHealth = MAX_HEALTH
03348 [GPT-5-Codex]             end
03349 [GPT-5-Codex]         end
03350 [GPT-5-Codex]     end
03351 [GPT-5-Codex] end
03352 [GPT-5-Codex] 
03353 [GPT-5-Codex] local drawUiText
03354 [GPT-5-Codex] local drawUiPanel
03355 [GPT-5-Codex] 
03356 [GPT-5-Codex] -- Draw win screen
03357 [GPT-5-Codex] local function drawWinScreen()
03358 [GPT-5-Codex]     -- Darken background (larger)
03359 [GPT-5-Codex]     drawUiPanel(20, 40, 220, 200, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
03360 [GPT-5-Codex] 
03361 [GPT-5-Codex]     -- Title
03362 [GPT-5-Codex]     drawUiPanel(30, 55, 210, 90, COLOR_GREEN, COLOR_WHITE)
03363 [GPT-5-Codex]     setFontCached(vmupro.text.FONT_SMALL)
03364 [GPT-5-Codex]     drawUiText("VICTORY!", 76, 63, COLOR_WHITE, COLOR_GREEN)
03365 [GPT-5-Codex] 
03366 [GPT-5-Codex]     -- Subtitle
03367 [GPT-5-Codex]     drawUiText("The King is safe!", 56, 100, COLOR_WHITE, COLOR_DARK_GRAY)
03368 [GPT-5-Codex]     drawUiText("You cleared the level!", 44, 122, COLOR_WHITE, COLOR_DARK_GRAY)
03369 [GPT-5-Codex] 
03370 [GPT-5-Codex]     if winBannerTimer > 0 then
03371 [GPT-5-Codex]         local pulse = (frameCount % 20) < 10
03372 [GPT-5-Codex]         local bannerColor = pulse and COLOR_MAROON or COLOR_DARK_MAROON
03373 [GPT-5-Codex]         drawUiPanel(35, 130, 205, 154, bannerColor, COLOR_WHITE)
03374 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
03375 [GPT-5-Codex]         drawUiText("LEVEL COMPLETE", 46, 136, COLOR_WHITE, bannerColor)
03376 [GPT-5-Codex]     end
03377 [GPT-5-Codex] 
03378 [GPT-5-Codex]     -- Menu option
03379 [GPT-5-Codex]     local y = 160
03380 [GPT-5-Codex]     local bgColor = COLOR_DARK_GRAY
03381 [GPT-5-Codex]     local textColor = COLOR_GRAY
03382 [GPT-5-Codex]     if winSelection == 1 then
03383 [GPT-5-Codex]         drawUiPanel(40, y, 200, y + 20, COLOR_MAROON, COLOR_WHITE)
03384 [GPT-5-Codex]         bgColor = COLOR_MAROON
03385 [GPT-5-Codex]         textColor = COLOR_WHITE
03386 [GPT-5-Codex]     end
03387 [GPT-5-Codex]     local winText = "MAIN MENU"
03388 [GPT-5-Codex]     if currentLevel < MAX_LEVEL then
03389 [GPT-5-Codex]         winText = "NEXT LEVEL"
03390 [GPT-5-Codex]     end
03391 [GPT-5-Codex]     setFontCached(vmupro.text.FONT_SMALL)
03392 [GPT-5-Codex]     drawUiText(winText, 74, y + 2, textColor, bgColor)
03393 [GPT-5-Codex] end
03394 [GPT-5-Codex] 
03395 [GPT-5-Codex] -- Draw health UI (potion with red liquid)
03396 [GPT-5-Codex] local function drawHealthUI()
03397 [GPT-5-Codex]     -- Position in lower right corner
03398 [GPT-5-Codex]     local potionX = 175
03399 [GPT-5-Codex]     local potionY = 175
03400 [GPT-5-Codex] 
03401 [GPT-5-Codex]     -- Draw red "liquid" behind the potion
03402 [GPT-5-Codex]     -- The liquid level drains from top to bottom based on health
03403 [GPT-5-Codex]     local healthPercent = playerHealth / MAX_HEALTH
03404 [GPT-5-Codex] 
03405 [GPT-5-Codex]     -- Liquid area sized to fit inside the vial's transparent area
03406 [GPT-5-Codex]     -- Potion content is roughly 36x44 pixels, vial interior is smaller
03407 [GPT-5-Codex]     local liquidRadius = 11  -- Smaller radius to fit inside vial
03408 [GPT-5-Codex]     local liquidCenterX = potionX + 29  -- Center of vial horizontally
03409 [GPT-5-Codex]     local liquidCenterY = potionY + 32  -- Center of vial body
03410 [GPT-5-Codex] 
03411 [GPT-5-Codex]     -- Calculate liquid top based on health (drains completely from top to bottom)
03412 [GPT-5-Codex]     -- At 100%: liquidTop = centerY - radius (full circle)
03413 [GPT-5-Codex]     -- At 0%: liquidTop = centerY + radius (empty, nothing drawn)
03414 [GPT-5-Codex]     local liquidBottom = liquidCenterY + liquidRadius
03415 [GPT-5-Codex]     local fullHeight = 2 * liquidRadius
03416 [GPT-5-Codex]     local liquidTop = liquidBottom - math.floor(fullHeight * healthPercent)
03417 [GPT-5-Codex] 
03418 [GPT-5-Codex]     -- Draw red liquid as horizontal lines to simulate filled circle
03419 [GPT-5-Codex]     for y = liquidTop, liquidBottom do
03420 [GPT-5-Codex]         local dy = y - liquidCenterY
03421 [GPT-5-Codex]         local halfWidth = math.sqrt(math.max(0, liquidRadius * liquidRadius - dy * dy))
03422 [GPT-5-Codex]         if halfWidth > 0 then
03423 [GPT-5-Codex]             local x1 = math.floor(liquidCenterX - halfWidth)
03424 [GPT-5-Codex]             local x2 = math.floor(liquidCenterX + halfWidth)
03425 [GPT-5-Codex]             vmupro.graphics.drawLine(x1, y, x2, y, COLOR_RED)
03426 [GPT-5-Codex]         end
03427 [GPT-5-Codex]     end
03428 [GPT-5-Codex] 
03429 [GPT-5-Codex]     -- Draw the potion sprite on top
03430 [GPT-5-Codex]     if potionSprite then
03431 [GPT-5-Codex]         vmupro.sprite.draw(potionSprite, potionX, potionY, vmupro.sprite.kImageUnflipped)
03432 [GPT-5-Codex]     end
03433 [GPT-5-Codex] 
03434 [GPT-5-Codex]     -- Draw health percentage text (if enabled)
03435 [GPT-5-Codex]     if showHealthPercent then
03436 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
03437 [GPT-5-Codex]         local healthText = tostring(math.floor(playerHealth)) .. "%"
03438 [GPT-5-Codex]         drawUiText(healthText, potionX + 18, potionY + 50, COLOR_WHITE, COLOR_BLACK)
03439 [GPT-5-Codex]     end
03440 [GPT-5-Codex] end
03441 [GPT-5-Codex] 
03442 [GPT-5-Codex] local function drawEnemiesRemainingUI()
03443 [GPT-5-Codex]     local remaining = (totalSoldiers or 0) - (soldiersKilled or 0)
03444 [GPT-5-Codex]     if remaining < 0 then remaining = 0 end
03445 [GPT-5-Codex]     setFontCached(vmupro.text.FONT_SMALL)
03446 [GPT-5-Codex]     drawUiText("ENEMIES LEFT: " .. tostring(remaining), 104, 228, COLOR_WHITE, COLOR_BLACK)
03447 [GPT-5-Codex] end
03448 [GPT-5-Codex] 
03449 [GPT-5-Codex] local drawRectOutline
03450 [GPT-5-Codex] 
03451 [GPT-5-Codex] drawUiText = function(text, x, y, textColor, bgColor)
03452 [GPT-5-Codex]     local fg = textColor or COLOR_WHITE
03453 [GPT-5-Codex]     local bg = bgColor
03454 [GPT-5-Codex]     -- Keep solid text backgrounds for non-menu UI labels.
03455 [GPT-5-Codex]     if bg == nil or bg == COLOR_BLACK then
03456 [GPT-5-Codex]         bg = UI_TEXT_SOLID_BG or COLOR_DARK_GRAY
03457 [GPT-5-Codex]     end
03458 [GPT-5-Codex]     vmupro.graphics.drawText(text, x, y, fg, bg)
03459 [GPT-5-Codex] end
03460 [GPT-5-Codex] 
03461 [GPT-5-Codex] local function drawMenuText(text, x, y, textColor)
03462 [GPT-5-Codex]     local fg = textColor or COLOR_WHITE
03463 [GPT-5-Codex]     vmupro.graphics.drawTextTransparent(text, x, y, fg)
03464 [GPT-5-Codex] end
03465 [GPT-5-Codex] 
03466 [GPT-5-Codex] drawUiPanel = function(x1, y1, x2, y2, fillColor, borderColor)
03467 [GPT-5-Codex]     -- Keep menu overlays lightweight: outline only, no stipple fill.
03468 [GPT-5-Codex]     drawRectOutline(x1, y1, x2, y2, borderColor or COLOR_GRAY)
03469 [GPT-5-Codex] end
03470 [GPT-5-Codex] 
03471 [GPT-5-Codex] local function drawPerfMonitorOverlay()
03472 [GPT-5-Codex]     if not DEBUG_PERF_MONITOR then return end
03473 [GPT-5-Codex]     local frameMs = (PERF_MONITOR_EMA_FRAME_US or 0) / 1000.0
03474 [GPT-5-Codex]     local rayMs = (PERF_MONITOR_EMA_RAYCAST_US or 0) / 1000.0
03475 [GPT-5-Codex]     local wallMs = (PERF_MONITOR_EMA_WALL_US or 0) / 1000.0
03476 [GPT-5-Codex]     local fogMs = (PERF_MONITOR_EMA_FOG_US or 0) / 1000.0
03477 [GPT-5-Codex]     local inputMs = (PERF_MONITOR_EMA_INPUT_US or 0) / 1000.0
03478 [GPT-5-Codex]     local audioMs = (PERF_MONITOR_EMA_AUDIO_US or 0) / 1000.0
03479 [GPT-5-Codex]     local simMs = (PERF_MONITOR_EMA_SIM_US or 0) / 1000.0
03480 [GPT-5-Codex]     local logicMs = (PERF_MONITOR_EMA_LOGIC_US or 0) / 1000.0
03481 [GPT-5-Codex]     local renderMs = (PERF_MONITOR_EMA_RENDER_US or 0) / 1000.0
03482 [GPT-5-Codex]     local presentMs = (PERF_MONITOR_EMA_PRESENT_US or 0) / 1000.0
03483 [GPT-5-Codex]     local sleepMs = (PERF_MONITOR_EMA_SLEEP_US or 0) / 1000.0
03484 [GPT-5-Codex]     local raysLabel = tostring(PERF_MONITOR_LAST_BASE_RAY_LABEL or "-")
03485 [GPT-5-Codex]     local effLabel = tostring(PERF_MONITOR_LAST_EFFECTIVE_RAY_LABEL or "-")
03486 [GPT-5-Codex]     local modeLabel = tostring(PERF_MONITOR_LAST_RAYCAST_MODE or "FLOAT")
03487 [GPT-5-Codex]     local dbLabel = getDoubleBufferStatusLabel()
03488 [GPT-5-Codex]     local deltaUsageKB = (DOUBLE_BUFFER_DELTA_USAGE_BYTES or 0) / 1024.0
03489 [GPT-5-Codex]     local deltaLargestKB = (DOUBLE_BUFFER_DELTA_LARGEST_BYTES or 0) / 1024.0
03490 [GPT-5-Codex]     local moveBlocked = PERF_MONITOR_MOVE_BLOCKED or 0
03491 [GPT-5-Codex]     local wallRecoveries = PERF_MONITOR_WALL_RECOVERIES or 0
03492 [GPT-5-Codex]     local rayStartSolid = PERF_MONITOR_RAY_START_SOLID or 0
03493 [GPT-5-Codex]     local wallFmt = getWall1VariantConfig()
03494 [GPT-5-Codex]     local wallFmtLabel = tostring((wallFmt and wallFmt.label) or "?")
03495 [GPT-5-Codex]     local wallKeyLabel = getWallKeyModeLabel()
03496 [GPT-5-Codex]     local wallProjLabel = getWallProjectionModeLabel()
03497 [GPT-5-Codex]     local baseX = 6
03498 [GPT-5-Codex]     -- Leave extra vertical room because some firmware builds render this font taller than 8px.
03499 [GPT-5-Codex]     -- This avoids line-on-line overlap regardless of FONT_TINY fallback behavior.
03500 [GPT-5-Codex]     local baseY = 104
03501 [GPT-5-Codex]     local rowStep = 16
03502 [GPT-5-Codex]     drawUiPanel(2, 100, 238, 236, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
03503 [GPT-5-Codex]     setFontCached(vmupro.text.FONT_TINY_6x8)
03504 [GPT-5-Codex]     drawMenuText(string.format("PF F%.2f R%.2f W%.2f G%.2f", frameMs, rayMs, wallMs, fogMs), baseX, baseY + (rowStep * 0), COLOR_WHITE)
03505 [GPT-5-Codex]     drawMenuText(string.format("PF C%d T%d FB%d FG%d", PERF_MONITOR_WALL_COLS_TOTAL or 0, PERF_MONITOR_WALL_COLS_TEXTURED or 0, PERF_MONITOR_WALL_COLS_FALLBACK or 0, PERF_MONITOR_FOG_COLS or 0), baseX, baseY + (rowStep * 1), COLOR_WHITE)
03506 [GPT-5-Codex]     drawMenuText("PF " .. raysLabel .. "->" .. effLabel .. " " .. modeLabel .. string.format(" B%d R%d S%d", moveBlocked, wallRecoveries, rayStartSolid), baseX, baseY + (rowStep * 2), COLOR_WHITE)
03507 [GPT-5-Codex]     drawMenuText(string.format("DB %s DU%.1fK DL%.1fK", dbLabel, deltaUsageKB, deltaLargestKB), baseX, baseY + (rowStep * 3), COLOR_WHITE)
03508 [GPT-5-Codex]     drawMenuText(string.format("W1=%s K=%s P=%s", wallFmtLabel, wallKeyLabel, wallProjLabel), baseX, baseY + (rowStep * 4), COLOR_WHITE)
03509 [GPT-5-Codex]     drawMenuText(string.format("MP %d/%d/%d/%d/%d", PERF_MONITOR_MIP_COLS_0 or 0, PERF_MONITOR_MIP_COLS_1 or 0, PERF_MONITOR_MIP_COLS_2 or 0, PERF_MONITOR_MIP_COLS_3 or 0, PERF_MONITOR_MIP_COLS_4 or 0), baseX, baseY + (rowStep * 5), COLOR_WHITE)
03510 [GPT-5-Codex]     drawMenuText(string.format("SC I%.2f A%.2f S%.2f L%.2f", inputMs, audioMs, simMs, logicMs), baseX, baseY + (rowStep * 6), COLOR_WHITE)
03511 [GPT-5-Codex]     drawMenuText(string.format("SC R%.2f P%.2f Z%.2f", renderMs, presentMs, sleepMs), baseX, baseY + (rowStep * 7), COLOR_WHITE)
03512 [GPT-5-Codex] end
03513 [GPT-5-Codex] 
03514 [GPT-5-Codex] local function buildDebugMenuItems()
03515 [GPT-5-Codex]     local pageName = getDebugPageName(titleDebugPage)
03516 [GPT-5-Codex]     local pageText = "PAGE: " .. pageName
03517 [GPT-5-Codex] 
03518 [GPT-5-Codex]     if titleDebugPage == DEBUG_PAGE_VIDEO then
03519 [GPT-5-Codex]         local texturesText = "TEXTURES: " .. (DEBUG_DISABLE_WALL_TEXTURE and "OFF" or "ON")
03520 [GPT-5-Codex]         local roofText = "ROOF TEX: " .. (DEBUG_DISABLE_ROOF_TEXTURE and "OFF" or "ON")
03521 [GPT-5-Codex]         local mipmapText = "MIPMAP: " .. (WALL_MIPMAP_ENABLED and "ON" or "OFF")
03522 [GPT-5-Codex]         local mipLodText = "MIP LOD: " .. (MIP_LOD_ENABLED and "ON" or "OFF")
03523 [GPT-5-Codex]         local rayPreset = "?"
03524 [GPT-5-Codex]         if RAY_PRESETS and #RAY_PRESETS > 0 then
03525 [GPT-5-Codex]             local baseIdx = clampInt(RAY_PRESET_INDEX or 1, 1, #RAY_PRESETS)
03526 [GPT-5-Codex]             rayPreset = (RAY_PRESETS[baseIdx] and RAY_PRESETS[baseIdx].label) or "?"
03527 [GPT-5-Codex]         end
03528 [GPT-5-Codex]         local raysText = "RAYS: " .. rayPreset
03529 [GPT-5-Codex]         local drawDistText = "DRAW DIST: " .. tostring(EXP_TEX_MAX_DIST or "?")
03530 [GPT-5-Codex]         local farTexOffText
03531 [GPT-5-Codex]         if (FAR_TEX_OFF_DIST or 999) >= 900 then
03532 [GPT-5-Codex]             farTexOffText = "FAR TEX OFF: OFF"
03533 [GPT-5-Codex]         else
03534 [GPT-5-Codex]             farTexOffText = "FAR TEX OFF: " .. tostring(FAR_TEX_OFF_DIST or "?")
03535 [GPT-5-Codex]         end
03536 [GPT-5-Codex]         local mip1DistText = "MIP1 DIST: " .. tostring(WALL_MIPMAP_DIST1 or "?")
03537 [GPT-5-Codex]         local mip2DistText = "MIP2 DIST: " .. tostring(WALL_MIPMAP_DIST2 or "?")
03538 [GPT-5-Codex]         local mip3DistText = "MIP3 DIST: " .. tostring(WALL_MIPMAP_DIST3 or "?")
03539 [GPT-5-Codex]         local mip4DistText = "MIP4 DIST: " .. tostring(WALL_MIPMAP_DIST4 or "?")
03540 [GPT-5-Codex]         local fogStartText = "FOG START: " .. tostring(FOG_START or "?")
03541 [GPT-5-Codex]         local fogEndText = "FOG FULL: " .. tostring(FOG_END or "?")
03542 [GPT-5-Codex]         local fogCutText = "FOG CUT L: " .. tostring(FOG_TEX_CUTOFF or "?")
03543 [GPT-5-Codex]         local fogColorLabel = (FOG_COLOR_LABELS and FOG_COLOR_LABELS[FOG_COLOR_INDEX or 1]) or tostring(FOG_COLOR_INDEX or 1)
03544 [GPT-5-Codex]         local fogColorText = "FOG COLOR: " .. tostring(fogColorLabel)
03545 [GPT-5-Codex]         local fogDitherText = "FOG DTHR: " .. tostring(FOG_DITHER_SIZE or 3)
03546 [GPT-5-Codex]         local resLabel = (LOW_RES_MODE == "fast") and "FAST" or "QUALITY"
03547 [GPT-5-Codex]         local resText = "WALL RES: " .. resLabel
03548 [GPT-5-Codex]         local fpsText = "FPS OVL: " .. (showFpsOverlay and "ON" or "OFF")
03549 [GPT-5-Codex]         local minimapText = "MINIMAP: " .. (SHOW_MINIMAP and "ON" or "OFF")
03550 [GPT-5-Codex]         local wallFmt = getWall1VariantConfig()
03551 [GPT-5-Codex]         local wallFmtText = "WALL1 FMT: " .. tostring(wallFmt.label or "?")
03552 [GPT-5-Codex]         local wallKeyText = "WALL KEY: " .. getWallKeyModeLabel()
03553 [GPT-5-Codex]         local wallProjText = "WALL PROJ: " .. getWallProjectionModeLabel()
03554 [GPT-5-Codex]         return {
03555 [GPT-5-Codex]             pageText,
03556 [GPT-5-Codex]             texturesText, roofText, mipmapText, mipLodText, raysText, drawDistText, farTexOffText,
03557 [GPT-5-Codex]             mip1DistText, mip2DistText, mip3DistText, mip4DistText,
03558 [GPT-5-Codex]             fogStartText, fogEndText, fogCutText, fogColorText, fogDitherText,
03559 [GPT-5-Codex]             resText, fpsText, minimapText, wallFmtText, wallKeyText, wallProjText,
03560 [GPT-5-Codex]             "BACK"
03561 [GPT-5-Codex]         }
03562 [GPT-5-Codex]     end
03563 [GPT-5-Codex] 
03564 [GPT-5-Codex]     if titleDebugPage == DEBUG_PAGE_PERF then
03565 [GPT-5-Codex]         local presetLabel = "CUSTOM"
03566 [GPT-5-Codex]         if PERF_QUALITY_INDEX and PERF_QUALITY_INDEX > 0 and PERF_QUALITY_PRESETS[PERF_QUALITY_INDEX] then
03567 [GPT-5-Codex]             presetLabel = PERF_QUALITY_PRESETS[PERF_QUALITY_INDEX]
03568 [GPT-5-Codex]         end
03569 [GPT-5-Codex]         local rayLabel = "?"
03570 [GPT-5-Codex]         if RAY_PRESETS and #RAY_PRESETS > 0 then
03571 [GPT-5-Codex]             local idx = clampInt(RAY_PRESET_INDEX or 1, 1, #RAY_PRESETS)
03572 [GPT-5-Codex]             rayLabel = (RAY_PRESETS[idx] and RAY_PRESETS[idx].label) or tostring(idx)
03573 [GPT-5-Codex]         end
03574 [GPT-5-Codex]         local presetText = "P/Q PRESET: " .. presetLabel
03575 [GPT-5-Codex]         local wallResText = "WALL RES: " .. ((LOW_RES_MODE == "fast") and "FAST" or "QUALITY")
03576 [GPT-5-Codex]         local raysText = "RAYS: " .. rayLabel
03577 [GPT-5-Codex]         local drawDistText = "DRAW DIST: " .. tostring(EXP_TEX_MAX_DIST or "?")
03578 [GPT-5-Codex]         local farTexText = ((FAR_TEX_OFF_DIST or 999) >= 900) and "FAR TEX OFF: OFF" or ("FAR TEX OFF: " .. tostring(FAR_TEX_OFF_DIST or "?"))
03579 [GPT-5-Codex]         local mipmapText = "MIPMAP: " .. (WALL_MIPMAP_ENABLED and "ON" or "OFF")
03580 [GPT-5-Codex]         local mipLodText = "MIP LOD: " .. (MIP_LOD_ENABLED and "ON" or "OFF")
03581 [GPT-5-Codex]         local fogStartText = "FOG START: " .. tostring(FOG_START or "?")
03582 [GPT-5-Codex]         local fogEndText = "FOG FULL: " .. tostring(FOG_END or "?")
03583 [GPT-5-Codex]         local fogDitherText = "FOG DTHR: " .. tostring(FOG_DITHER_SIZE or 3)
03584 [GPT-5-Codex]         local fpsTargetText = "FPS TARGET: " .. string.upper(FPS_TARGET_MODE)
03585 [GPT-5-Codex]         local perfMonText = "PERF MON: " .. (DEBUG_PERF_MONITOR and "ON" or "OFF")
03586 [GPT-5-Codex]         local dBufText = "DBUF: " .. getDoubleBufferStatusLabel()
03587 [GPT-5-Codex]         return {
03588 [GPT-5-Codex]             pageText,
03589 [GPT-5-Codex]             presetText, wallResText, raysText, drawDistText, farTexText,
03590 [GPT-5-Codex]             mipmapText, mipLodText, fogStartText, fogEndText, fogDitherText,
03591 [GPT-5-Codex]             fpsTargetText, perfMonText, dBufText,
03592 [GPT-5-Codex]             "BACK"
03593 [GPT-5-Codex]         }
03594 [GPT-5-Codex]     end
03595 [GPT-5-Codex] 
03596 [GPT-5-Codex]     local logsText = "LOGS: " .. (enableBootLogs and "ON" or "OFF")
03597 [GPT-5-Codex]     local enemiesText = "ENEMIES: " .. (DEBUG_DISABLE_ENEMIES and "OFF" or "ON")
03598 [GPT-5-Codex]     local propsText = "PROPS: " .. (DEBUG_DISABLE_PROPS and "OFF" or "ON")
03599 [GPT-5-Codex]     local blockDbgText = "BLOCK DBG: " .. (DEBUG_SHOW_BLOCK and "ON" or "OFF")
03600 [GPT-5-Codex]     local fpsTargetText = "FPS TARGET: " .. string.upper(FPS_TARGET_MODE)
03601 [GPT-5-Codex]     local audioMixText = "AUDIO MIX: " .. tostring(AUDIO_UPDATE_TARGET_HZ or 60) .. "HZ"
03602 [GPT-5-Codex]     local rendererText = "RENDER: EXP-H LOCK"
03603 [GPT-5-Codex]     local useFixed = (USE_FIXED_RAYCAST == true) and (DEBUG_FORCE_FLOAT_RAYCAST ~= true)
03604 [GPT-5-Codex]     local raycastText = "RAYCAST: " .. (useFixed and "FIXED" or "FLOAT")
03605 [GPT-5-Codex]     local perfMonText = "PERF MON: " .. (DEBUG_PERF_MONITOR and "ON" or "OFF")
03606 [GPT-5-Codex]     local dBufText = "DBUF: " .. getDoubleBufferStatusLabel()
03607 [GPT-5-Codex]     return {pageText, logsText, enemiesText, propsText, blockDbgText, fpsTargetText, audioMixText, rendererText, raycastText, perfMonText, dBufText, "BACK"}
03608 [GPT-5-Codex] end
03609 [GPT-5-Codex] 
03610 [GPT-5-Codex] -- Keep in sync with buildDebugMenuItems() to avoid per-frame table builds in input handlers.
03611 [GPT-5-Codex] local function getDebugMenuItemCount()
03612 [GPT-5-Codex]     if titleDebugPage == DEBUG_PAGE_VIDEO then
03613 [GPT-5-Codex]         return 24
03614 [GPT-5-Codex]     end
03615 [GPT-5-Codex]     if titleDebugPage == DEBUG_PAGE_PERF then
03616 [GPT-5-Codex]         return 15
03617 [GPT-5-Codex]     end
03618 [GPT-5-Codex]     return 12
03619 [GPT-5-Codex] end
03620 [GPT-5-Codex] 
03621 [GPT-5-Codex] local function stepListIndex(idx, delta, count, wrap)
03622 [GPT-5-Codex]     local n = count or 0
03623 [GPT-5-Codex]     if n <= 0 then return 1 end
03624 [GPT-5-Codex]     local cur = idx or 1
03625 [GPT-5-Codex]     local nextIdx = cur + delta
03626 [GPT-5-Codex]     if wrap then
03627 [GPT-5-Codex]         if nextIdx < 1 then nextIdx = n end
03628 [GPT-5-Codex]         if nextIdx > n then nextIdx = 1 end
03629 [GPT-5-Codex]     else
03630 [GPT-5-Codex]         if nextIdx < 1 then nextIdx = 1 end
03631 [GPT-5-Codex]         if nextIdx > n then nextIdx = n end
03632 [GPT-5-Codex]     end
03633 [GPT-5-Codex]     return nextIdx
03634 [GPT-5-Codex] end
03635 [GPT-5-Codex] 
03636 [GPT-5-Codex] local debugAdjustHoldDir = 0
03637 [GPT-5-Codex] local debugAdjustHoldFrames = 0
03638 [GPT-5-Codex] local DEBUG_ADJUST_REPEAT_FRAMES = 6
03639 [GPT-5-Codex] 
03640 [GPT-5-Codex] local function getDebugAdjustDelta()
03641 [GPT-5-Codex]     if vmupro.input.pressed(vmupro.input.LEFT) then
03642 [GPT-5-Codex]         debugAdjustHoldDir = -1
03643 [GPT-5-Codex]         debugAdjustHoldFrames = 0
03644 [GPT-5-Codex]         return -1
03645 [GPT-5-Codex]     end
03646 [GPT-5-Codex]     if vmupro.input.pressed(vmupro.input.RIGHT) then
03647 [GPT-5-Codex]         debugAdjustHoldDir = 1
03648 [GPT-5-Codex]         debugAdjustHoldFrames = 0
03649 [GPT-5-Codex]         return 1
03650 [GPT-5-Codex]     end
03651 [GPT-5-Codex] 
03652 [GPT-5-Codex]     local dir = 0
03653 [GPT-5-Codex]     if vmupro.input.held(vmupro.input.LEFT) then
03654 [GPT-5-Codex]         dir = -1
03655 [GPT-5-Codex]     elseif vmupro.input.held(vmupro.input.RIGHT) then
03656 [GPT-5-Codex]         dir = 1
03657 [GPT-5-Codex]     end
03658 [GPT-5-Codex] 
03659 [GPT-5-Codex]     if dir == 0 then
03660 [GPT-5-Codex]         debugAdjustHoldDir = 0
03661 [GPT-5-Codex]         debugAdjustHoldFrames = 0
03662 [GPT-5-Codex]         return 0
03663 [GPT-5-Codex]     end
03664 [GPT-5-Codex] 
03665 [GPT-5-Codex]     if debugAdjustHoldDir ~= dir then
03666 [GPT-5-Codex]         debugAdjustHoldDir = dir
03667 [GPT-5-Codex]         debugAdjustHoldFrames = 0
03668 [GPT-5-Codex]         return dir
03669 [GPT-5-Codex]     end
03670 [GPT-5-Codex] 
03671 [GPT-5-Codex]     debugAdjustHoldFrames = debugAdjustHoldFrames + 1
03672 [GPT-5-Codex]     if debugAdjustHoldFrames >= DEBUG_ADJUST_REPEAT_FRAMES then
03673 [GPT-5-Codex]         debugAdjustHoldFrames = 0
03674 [GPT-5-Codex]         return dir
03675 [GPT-5-Codex]     end
03676 [GPT-5-Codex] 
03677 [GPT-5-Codex]     return 0
03678 [GPT-5-Codex] end
03679 [GPT-5-Codex] 
03680 [GPT-5-Codex] local function stepFpsTarget(delta, wrap)
03681 [GPT-5-Codex]     local modes = {"uncapped", "60", "45", "30", "24"}
03682 [GPT-5-Codex]     local cur = 1
03683 [GPT-5-Codex]     for i = 1, #modes do
03684 [GPT-5-Codex]         if modes[i] == FPS_TARGET_MODE then
03685 [GPT-5-Codex]             cur = i
03686 [GPT-5-Codex]             break
03687 [GPT-5-Codex]         end
03688 [GPT-5-Codex]     end
03689 [GPT-5-Codex]     local nextIdx = stepListIndex(cur, delta, #modes, wrap)
03690 [GPT-5-Codex]     FPS_TARGET_MODE = modes[nextIdx]
03691 [GPT-5-Codex] end
03692 [GPT-5-Codex] 
03693 [GPT-5-Codex] local function stepAudioMixTarget(delta, wrap)
03694 [GPT-5-Codex]     if not AUDIO_MIX_HZ_PRESETS or #AUDIO_MIX_HZ_PRESETS == 0 then
03695 [GPT-5-Codex]         return
03696 [GPT-5-Codex]     end
03697 [GPT-5-Codex]     AUDIO_MIX_HZ_INDEX = stepListIndex(AUDIO_MIX_HZ_INDEX or #AUDIO_MIX_HZ_PRESETS, delta, #AUDIO_MIX_HZ_PRESETS, wrap == true)
03698 [GPT-5-Codex]     setAudioMixHz(AUDIO_MIX_HZ_PRESETS[AUDIO_MIX_HZ_INDEX])
03699 [GPT-5-Codex] end
03700 [GPT-5-Codex] 
03701 [GPT-5-Codex] local function stepWall1FormatVariant(delta, wrap)
03702 [GPT-5-Codex]     if not WALL1_FORMAT_VARIANTS or #WALL1_FORMAT_VARIANTS == 0 then
03703 [GPT-5-Codex]         return
03704 [GPT-5-Codex]     end
03705 [GPT-5-Codex]     WALL1_FORMAT_INDEX = stepListIndex(WALL1_FORMAT_INDEX or 1, delta, #WALL1_FORMAT_VARIANTS, wrap == true)
03706 [GPT-5-Codex]     if not DEBUG_DISABLE_WALL_TEXTURE then
03707 [GPT-5-Codex]         unloadWallTextures()
03708 [GPT-5-Codex]         loadWallTextures()
03709 [GPT-5-Codex]     end
03710 [GPT-5-Codex] end
03711 [GPT-5-Codex] 
03712 [GPT-5-Codex] local function adjustDebugMenuSelection(sel, delta, wrap)
03713 [GPT-5-Codex]     local step = delta or 0
03714 [GPT-5-Codex]     if step == 0 then return false end
03715 [GPT-5-Codex]     local doWrap = (wrap == true)
03716 [GPT-5-Codex] 
03717 [GPT-5-Codex]     if sel == 1 then
03718 [GPT-5-Codex]         stepDebugPage(step)
03719 [GPT-5-Codex]         return true
03720 [GPT-5-Codex]     end
03721 [GPT-5-Codex] 
03722 [GPT-5-Codex]     if titleDebugPage == DEBUG_PAGE_VIDEO then
03723 [GPT-5-Codex]         if sel >= 2 then
03724 [GPT-5-Codex]             markPerfQualityCustom()
03725 [GPT-5-Codex]         end
03726 [GPT-5-Codex]         if sel == 2 then
03727 [GPT-5-Codex]             -- TEXTURES label is inverse of DEBUG_DISABLE_WALL_TEXTURE.
03728 [GPT-5-Codex]             local disableTextures = (step < 0)
03729 [GPT-5-Codex]             if disableTextures ~= DEBUG_DISABLE_WALL_TEXTURE then
03730 [GPT-5-Codex]                 DEBUG_DISABLE_WALL_TEXTURE = disableTextures
03731 [GPT-5-Codex]                 if DEBUG_DISABLE_WALL_TEXTURE then
03732 [GPT-5-Codex]                     unloadWallTextures()
03733 [GPT-5-Codex]                 else
03734 [GPT-5-Codex]                     loadWallTextures()
03735 [GPT-5-Codex]                 end
03736 [GPT-5-Codex]             end
03737 [GPT-5-Codex]             return true
03738 [GPT-5-Codex]         elseif sel == 3 then
03739 [GPT-5-Codex]             DEBUG_DISABLE_ROOF_TEXTURE = (step < 0)
03740 [GPT-5-Codex]             return true
03741 [GPT-5-Codex]         elseif sel == 4 then
03742 [GPT-5-Codex]             WALL_MIPMAP_ENABLED = (step > 0)
03743 [GPT-5-Codex]             return true
03744 [GPT-5-Codex]         elseif sel == 5 then
03745 [GPT-5-Codex]             MIP_LOD_ENABLED = (step > 0)
03746 [GPT-5-Codex]             return true
03747 [GPT-5-Codex]         elseif sel == 6 then
03748 [GPT-5-Codex]             if RAY_PRESETS and #RAY_PRESETS > 0 then
03749 [GPT-5-Codex]                 RAY_PRESET_INDEX = stepListIndex(RAY_PRESET_INDEX or 1, step, #RAY_PRESETS, doWrap)
03750 [GPT-5-Codex]             end
03751 [GPT-5-Codex]             return true
03752 [GPT-5-Codex]         elseif sel == 7 then
03753 [GPT-5-Codex]             if DRAW_DIST_PRESETS and #DRAW_DIST_PRESETS > 0 then
03754 [GPT-5-Codex]                 DRAW_DIST_INDEX = stepListIndex(DRAW_DIST_INDEX or 1, step, #DRAW_DIST_PRESETS, doWrap)
03755 [GPT-5-Codex]                 EXP_TEX_MAX_DIST = DRAW_DIST_PRESETS[DRAW_DIST_INDEX]
03756 [GPT-5-Codex]                 refreshExpViewDistance()
03757 [GPT-5-Codex]             end
03758 [GPT-5-Codex]             return true
03759 [GPT-5-Codex]         elseif sel == 8 then
03760 [GPT-5-Codex]             if FAR_TEX_OFF_PRESETS and #FAR_TEX_OFF_PRESETS > 0 then
03761 [GPT-5-Codex]                 FAR_TEX_OFF_INDEX = stepListIndex(FAR_TEX_OFF_INDEX or #FAR_TEX_OFF_PRESETS, step, #FAR_TEX_OFF_PRESETS, doWrap)
03762 [GPT-5-Codex]                 FAR_TEX_OFF_DIST = FAR_TEX_OFF_PRESETS[FAR_TEX_OFF_INDEX]
03763 [GPT-5-Codex]             end
03764 [GPT-5-Codex]             return true
03765 [GPT-5-Codex]         elseif sel == 9 then
03766 [GPT-5-Codex]             if MIPMAP_DIST_PRESETS and #MIPMAP_DIST_PRESETS > 0 then
03767 [GPT-5-Codex]                 normalizeMipmapRanges()
03768 [GPT-5-Codex]                 local max1 = math.max(1, (MIPMAP2_DIST_INDEX or 2) - 1)
03769 [GPT-5-Codex]                 MIPMAP1_DIST_INDEX = clampInt((MIPMAP1_DIST_INDEX or 1) + step, 1, max1)
03770 [GPT-5-Codex]                 normalizeMipmapRanges()
03771 [GPT-5-Codex]             end
03772 [GPT-5-Codex]             return true
03773 [GPT-5-Codex]         elseif sel == 10 then
03774 [GPT-5-Codex]             if MIPMAP_DIST_PRESETS and #MIPMAP_DIST_PRESETS > 0 then
03775 [GPT-5-Codex]                 normalizeMipmapRanges()
03776 [GPT-5-Codex]                 local n = #MIPMAP_DIST_PRESETS
03777 [GPT-5-Codex]                 local min2 = math.min(n, (MIPMAP1_DIST_INDEX or 1) + 1)
03778 [GPT-5-Codex]                 local max2 = math.max(min2, (MIPMAP3_DIST_INDEX or n) - 1)
03779 [GPT-5-Codex]                 MIPMAP2_DIST_INDEX = clampInt((MIPMAP2_DIST_INDEX or min2) + step, min2, max2)
03780 [GPT-5-Codex]                 normalizeMipmapRanges()
03781 [GPT-5-Codex]             end
03782 [GPT-5-Codex]             return true
03783 [GPT-5-Codex]         elseif sel == 11 then
03784 [GPT-5-Codex]             if MIPMAP_DIST_PRESETS and #MIPMAP_DIST_PRESETS > 0 then
03785 [GPT-5-Codex]                 normalizeMipmapRanges()
03786 [GPT-5-Codex]                 local n = #MIPMAP_DIST_PRESETS
03787 [GPT-5-Codex]                 local min3 = math.min(n, (MIPMAP2_DIST_INDEX or 1) + 1)
03788 [GPT-5-Codex]                 local max3 = math.max(min3, (MIPMAP4_DIST_INDEX or n) - 1)
03789 [GPT-5-Codex]                 MIPMAP3_DIST_INDEX = clampInt((MIPMAP3_DIST_INDEX or min3) + step, min3, max3)
03790 [GPT-5-Codex]                 normalizeMipmapRanges()
03791 [GPT-5-Codex]             end
03792 [GPT-5-Codex]             return true
03793 [GPT-5-Codex]         elseif sel == 12 then
03794 [GPT-5-Codex]             if MIPMAP_DIST_PRESETS and #MIPMAP_DIST_PRESETS > 0 then
03795 [GPT-5-Codex]                 normalizeMipmapRanges()
03796 [GPT-5-Codex]                 local n = #MIPMAP_DIST_PRESETS
03797 [GPT-5-Codex]                 local min4 = math.min(n, (MIPMAP3_DIST_INDEX or 1) + 1)
03798 [GPT-5-Codex]                 MIPMAP4_DIST_INDEX = clampInt((MIPMAP4_DIST_INDEX or min4) + step, min4, n)
03799 [GPT-5-Codex]                 normalizeMipmapRanges()
03800 [GPT-5-Codex]             end
03801 [GPT-5-Codex]             return true
03802 [GPT-5-Codex]         elseif sel == 13 then
03803 [GPT-5-Codex]             if FOG_START_PRESETS and #FOG_START_PRESETS > 0 then
03804 [GPT-5-Codex]                 normalizeFogRange()
03805 [GPT-5-Codex]                 local maxStart = math.max(1, (FOG_END_INDEX or 2) - 1)
03806 [GPT-5-Codex]                 FOG_START_INDEX = clampInt((FOG_START_INDEX or 1) + step, 1, maxStart)
03807 [GPT-5-Codex]                 normalizeFogRange()
03808 [GPT-5-Codex]             end
03809 [GPT-5-Codex]             return true
03810 [GPT-5-Codex]         elseif sel == 14 then
03811 [GPT-5-Codex]             if FOG_END_PRESETS and #FOG_END_PRESETS > 0 then
03812 [GPT-5-Codex]                 normalizeFogRange()
03813 [GPT-5-Codex]                 local n = #FOG_END_PRESETS
03814 [GPT-5-Codex]                 local minEnd = math.min(n, (FOG_START_INDEX or 1) + 1)
03815 [GPT-5-Codex]                 FOG_END_INDEX = clampInt((FOG_END_INDEX or minEnd) + step, minEnd, n)
03816 [GPT-5-Codex]                 normalizeFogRange()
03817 [GPT-5-Codex]             end
03818 [GPT-5-Codex]             return true
03819 [GPT-5-Codex]         elseif sel == 15 then
03820 [GPT-5-Codex]             if FOG_CUTOFF_PRESETS and #FOG_CUTOFF_PRESETS > 0 then
03821 [GPT-5-Codex]                 FOG_CUTOFF_INDEX = stepListIndex(FOG_CUTOFF_INDEX or 1, step, #FOG_CUTOFF_PRESETS, doWrap)
03822 [GPT-5-Codex]                 FOG_TEX_CUTOFF = FOG_CUTOFF_PRESETS[FOG_CUTOFF_INDEX]
03823 [GPT-5-Codex]             end
03824 [GPT-5-Codex]             return true
03825 [GPT-5-Codex]         elseif sel == 16 then
03826 [GPT-5-Codex]             if FOG_COLOR_PRESETS and #FOG_COLOR_PRESETS > 0 then
03827 [GPT-5-Codex]                 FOG_COLOR_INDEX = stepListIndex(FOG_COLOR_INDEX or 1, step, #FOG_COLOR_PRESETS, doWrap)
03828 [GPT-5-Codex]                 FOG_COLOR = FOG_COLOR_PRESETS[FOG_COLOR_INDEX]
03829 [GPT-5-Codex]             end
03830 [GPT-5-Codex]             return true
03831 [GPT-5-Codex]         elseif sel == 17 then
03832 [GPT-5-Codex]             if FOG_DITHER_SIZE_PRESETS and #FOG_DITHER_SIZE_PRESETS > 0 then
03833 [GPT-5-Codex]                 FOG_DITHER_SIZE_INDEX = stepListIndex(FOG_DITHER_SIZE_INDEX or 3, step, #FOG_DITHER_SIZE_PRESETS, doWrap)
03834 [GPT-5-Codex]                 FOG_DITHER_SIZE = FOG_DITHER_SIZE_PRESETS[FOG_DITHER_SIZE_INDEX]
03835 [GPT-5-Codex]             end
03836 [GPT-5-Codex]             return true
03837 [GPT-5-Codex]         elseif sel == 18 then
03838 [GPT-5-Codex]             if step > 0 then
03839 [GPT-5-Codex]                 LOW_RES_MODE = "quality"
03840 [GPT-5-Codex]             else
03841 [GPT-5-Codex]                 LOW_RES_MODE = "fast"
03842 [GPT-5-Codex]             end
03843 [GPT-5-Codex]             return true
03844 [GPT-5-Codex]         elseif sel == 19 then
03845 [GPT-5-Codex]             showFpsOverlay = (step > 0)
03846 [GPT-5-Codex]             return true
03847 [GPT-5-Codex]         elseif sel == 20 then
03848 [GPT-5-Codex]             SHOW_MINIMAP = (step > 0)
03849 [GPT-5-Codex]             return true
03850 [GPT-5-Codex]         elseif sel == 21 then
03851 [GPT-5-Codex]             stepWall1FormatVariant(step, doWrap)
03852 [GPT-5-Codex]             return true
03853 [GPT-5-Codex]         elseif sel == 22 then
03854 [GPT-5-Codex]             local nextOverride = (step > 0)
03855 [GPT-5-Codex]             if nextOverride ~= WALL_FORCE_COLORKEY_OVERRIDE then
03856 [GPT-5-Codex]                 WALL_FORCE_COLORKEY_OVERRIDE = nextOverride
03857 [GPT-5-Codex]                 if not DEBUG_DISABLE_WALL_TEXTURE then
03858 [GPT-5-Codex]                     unloadWallTextures()
03859 [GPT-5-Codex]                     loadWallTextures()
03860 [GPT-5-Codex]                 end
03861 [GPT-5-Codex]             end
03862 [GPT-5-Codex]             return true
03863 [GPT-5-Codex]         elseif sel == 23 then
03864 [GPT-5-Codex]             if step > 0 then
03865 [GPT-5-Codex]                 WALL_PROJECTION_MODE = "adaptive"
03866 [GPT-5-Codex]             else
03867 [GPT-5-Codex]                 WALL_PROJECTION_MODE = "stable"
03868 [GPT-5-Codex]             end
03869 [GPT-5-Codex]             return true
03870 [GPT-5-Codex]         end
03871 [GPT-5-Codex]         return false
03872 [GPT-5-Codex]     end
03873 [GPT-5-Codex] 
03874 [GPT-5-Codex]     if titleDebugPage == DEBUG_PAGE_PERF then
03875 [GPT-5-Codex]         if sel == 2 then
03876 [GPT-5-Codex]             local count = #PERF_QUALITY_PRESETS
03877 [GPT-5-Codex]             if count > 0 then
03878 [GPT-5-Codex]                 local idx = PERF_QUALITY_INDEX
03879 [GPT-5-Codex]                 if not idx or idx < 1 or idx > count then idx = 2 end
03880 [GPT-5-Codex]                 idx = stepListIndex(idx, step, count, doWrap)
03881 [GPT-5-Codex]                 applyPerfQualityPreset(idx)
03882 [GPT-5-Codex]             end
03883 [GPT-5-Codex]             return true
03884 [GPT-5-Codex]         elseif sel == 3 then
03885 [GPT-5-Codex]             markPerfQualityCustom()
03886 [GPT-5-Codex]             LOW_RES_MODE = (step > 0) and "quality" or "fast"
03887 [GPT-5-Codex]             return true
03888 [GPT-5-Codex]         elseif sel == 4 then
03889 [GPT-5-Codex]             markPerfQualityCustom()
03890 [GPT-5-Codex]             if RAY_PRESETS and #RAY_PRESETS > 0 then
03891 [GPT-5-Codex]                 RAY_PRESET_INDEX = stepListIndex(RAY_PRESET_INDEX or 1, step, #RAY_PRESETS, doWrap)
03892 [GPT-5-Codex]             end
03893 [GPT-5-Codex]             return true
03894 [GPT-5-Codex]         elseif sel == 5 then
03895 [GPT-5-Codex]             markPerfQualityCustom()
03896 [GPT-5-Codex]             if DRAW_DIST_PRESETS and #DRAW_DIST_PRESETS > 0 then
03897 [GPT-5-Codex]                 DRAW_DIST_INDEX = stepListIndex(DRAW_DIST_INDEX or 1, step, #DRAW_DIST_PRESETS, doWrap)
03898 [GPT-5-Codex]                 EXP_TEX_MAX_DIST = DRAW_DIST_PRESETS[DRAW_DIST_INDEX]
03899 [GPT-5-Codex]                 refreshExpViewDistance()
03900 [GPT-5-Codex]             end
03901 [GPT-5-Codex]             return true
03902 [GPT-5-Codex]         elseif sel == 6 then
03903 [GPT-5-Codex]             markPerfQualityCustom()
03904 [GPT-5-Codex]             if FAR_TEX_OFF_PRESETS and #FAR_TEX_OFF_PRESETS > 0 then
03905 [GPT-5-Codex]                 FAR_TEX_OFF_INDEX = stepListIndex(FAR_TEX_OFF_INDEX or #FAR_TEX_OFF_PRESETS, step, #FAR_TEX_OFF_PRESETS, doWrap)
03906 [GPT-5-Codex]                 FAR_TEX_OFF_DIST = FAR_TEX_OFF_PRESETS[FAR_TEX_OFF_INDEX]
03907 [GPT-5-Codex]             end
03908 [GPT-5-Codex]             return true
03909 [GPT-5-Codex]         elseif sel == 7 then
03910 [GPT-5-Codex]             markPerfQualityCustom()
03911 [GPT-5-Codex]             WALL_MIPMAP_ENABLED = (step > 0)
03912 [GPT-5-Codex]             return true
03913 [GPT-5-Codex]         elseif sel == 8 then
03914 [GPT-5-Codex]             markPerfQualityCustom()
03915 [GPT-5-Codex]             MIP_LOD_ENABLED = (step > 0)
03916 [GPT-5-Codex]             return true
03917 [GPT-5-Codex]         elseif sel == 9 then
03918 [GPT-5-Codex]             markPerfQualityCustom()
03919 [GPT-5-Codex]             if FOG_START_PRESETS and #FOG_START_PRESETS > 0 then
03920 [GPT-5-Codex]                 normalizeFogRange()
03921 [GPT-5-Codex]                 local maxStart = math.max(1, (FOG_END_INDEX or 2) - 1)
03922 [GPT-5-Codex]                 FOG_START_INDEX = clampInt((FOG_START_INDEX or 1) + step, 1, maxStart)
03923 [GPT-5-Codex]                 normalizeFogRange()
03924 [GPT-5-Codex]             end
03925 [GPT-5-Codex]             return true
03926 [GPT-5-Codex]         elseif sel == 10 then
03927 [GPT-5-Codex]             markPerfQualityCustom()
03928 [GPT-5-Codex]             if FOG_END_PRESETS and #FOG_END_PRESETS > 0 then
03929 [GPT-5-Codex]                 normalizeFogRange()
03930 [GPT-5-Codex]                 local n = #FOG_END_PRESETS
03931 [GPT-5-Codex]                 local minEnd = math.min(n, (FOG_START_INDEX or 1) + 1)
03932 [GPT-5-Codex]                 FOG_END_INDEX = clampInt((FOG_END_INDEX or minEnd) + step, minEnd, n)
03933 [GPT-5-Codex]                 normalizeFogRange()
03934 [GPT-5-Codex]             end
03935 [GPT-5-Codex]             return true
03936 [GPT-5-Codex]         elseif sel == 11 then
03937 [GPT-5-Codex]             markPerfQualityCustom()
03938 [GPT-5-Codex]             if FOG_DITHER_SIZE_PRESETS and #FOG_DITHER_SIZE_PRESETS > 0 then
03939 [GPT-5-Codex]                 FOG_DITHER_SIZE_INDEX = stepListIndex(FOG_DITHER_SIZE_INDEX or 3, step, #FOG_DITHER_SIZE_PRESETS, doWrap)
03940 [GPT-5-Codex]                 FOG_DITHER_SIZE = FOG_DITHER_SIZE_PRESETS[FOG_DITHER_SIZE_INDEX]
03941 [GPT-5-Codex]             end
03942 [GPT-5-Codex]             return true
03943 [GPT-5-Codex]         elseif sel == 12 then
03944 [GPT-5-Codex]             stepFpsTarget(step, doWrap)
03945 [GPT-5-Codex]             return true
03946 [GPT-5-Codex]         elseif sel == 13 then
03947 [GPT-5-Codex]             DEBUG_PERF_MONITOR = (step > 0)
03948 [GPT-5-Codex]             return true
03949 [GPT-5-Codex]         elseif sel == 14 then
03950 [GPT-5-Codex]             DEBUG_DOUBLE_BUFFER = (step > 0)
03951 [GPT-5-Codex]             return true
03952 [GPT-5-Codex]         end
03953 [GPT-5-Codex]         return false
03954 [GPT-5-Codex]     end
03955 [GPT-5-Codex] 
03956 [GPT-5-Codex]     if sel == 2 then
03957 [GPT-5-Codex]         local enable = step > 0
03958 [GPT-5-Codex]         enableBootLogs = enable
03959 [GPT-5-Codex]         enablePerfLogs = enable
03960 [GPT-5-Codex]         DEBUG_WALL_QUADS_LOG = enable
03961 [GPT-5-Codex]         if enable then
03962 [GPT-5-Codex]             wallQuadLogCount = 0
03963 [GPT-5-Codex]         end
03964 [GPT-5-Codex]         applyRuntimeLogLevel()
03965 [GPT-5-Codex]         return true
03966 [GPT-5-Codex]     elseif sel == 3 then
03967 [GPT-5-Codex]         -- ENEMIES label is inverse of DEBUG_DISABLE_ENEMIES.
03968 [GPT-5-Codex]         DEBUG_DISABLE_ENEMIES = (step < 0)
03969 [GPT-5-Codex]         spriteOrderCache = {}
03970 [GPT-5-Codex]         spriteOrderCacheFrame = -999
03971 [GPT-5-Codex]         return true
03972 [GPT-5-Codex]     elseif sel == 4 then
03973 [GPT-5-Codex]         -- PROPS label is inverse of DEBUG_DISABLE_PROPS.
03974 [GPT-5-Codex]         DEBUG_DISABLE_PROPS = (step < 0)
03975 [GPT-5-Codex]         spriteOrderCache = {}
03976 [GPT-5-Codex]         spriteOrderCacheFrame = -999
03977 [GPT-5-Codex]         return true
03978 [GPT-5-Codex]     elseif sel == 5 then
03979 [GPT-5-Codex]         DEBUG_SHOW_BLOCK = (step > 0)
03980 [GPT-5-Codex]         return true
03981 [GPT-5-Codex]     elseif sel == 6 then
03982 [GPT-5-Codex]         stepFpsTarget(step, doWrap)
03983 [GPT-5-Codex]         return true
03984 [GPT-5-Codex]     elseif sel == 7 then
03985 [GPT-5-Codex]         stepAudioMixTarget(step, doWrap)
03986 [GPT-5-Codex]         return true
03987 [GPT-5-Codex]     elseif sel == 8 then
03988 [GPT-5-Codex]         -- Renderer is locked; keep lock routine for safety.
03989 [GPT-5-Codex]         lockRendererMode()
03990 [GPT-5-Codex]         return true
03991 [GPT-5-Codex]     elseif sel == 9 then
03992 [GPT-5-Codex]         USE_FIXED_RAYCAST = (step > 0)
03993 [GPT-5-Codex]         DEBUG_FORCE_FLOAT_RAYCAST = false
03994 [GPT-5-Codex]         return true
03995 [GPT-5-Codex]     elseif sel == 10 then
03996 [GPT-5-Codex]         DEBUG_PERF_MONITOR = (step > 0)
03997 [GPT-5-Codex]         return true
03998 [GPT-5-Codex]     elseif sel == 11 then
03999 [GPT-5-Codex]         DEBUG_DOUBLE_BUFFER = (step > 0)
04000 [GPT-5-Codex]         return true
04001 [GPT-5-Codex]     end
04002 [GPT-5-Codex] 
04003 [GPT-5-Codex]     return false
04004 [GPT-5-Codex] end
04005 [GPT-5-Codex] 
04006 [GPT-5-Codex] local function applyDebugMenuSelection(sel)
04007 [GPT-5-Codex]     return sel == getDebugMenuItemCount()
04008 [GPT-5-Codex] end
04009 [GPT-5-Codex] 
04010 [GPT-5-Codex] drawRectOutline = function(x1, y1, x2, y2, color)
04011 [GPT-5-Codex]     vmupro.graphics.drawLine(x1, y1, x2, y1, color)
04012 [GPT-5-Codex]     vmupro.graphics.drawLine(x1, y2, x2, y2, color)
04013 [GPT-5-Codex]     vmupro.graphics.drawLine(x1, y1, x1, y2, color)
04014 [GPT-5-Codex]     vmupro.graphics.drawLine(x2, y1, x2, y2, color)
04015 [GPT-5-Codex] end
04016 [GPT-5-Codex] 
04017 [GPT-5-Codex] -- Draw title screen
04018 [GPT-5-Codex] local function drawTitleScreenImpl()
04019 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "C drawTitleScreen")
04020 [GPT-5-Codex]     -- Draw title background image
04021 [GPT-5-Codex]     if titleSprite then
04022 [GPT-5-Codex]         vmupro.sprite.draw(titleSprite, 0, 0, vmupro.sprite.kImageUnflipped)
04023 [GPT-5-Codex]     else
04024 [GPT-5-Codex]         vmupro.graphics.clear(COLOR_BLACK)
04025 [GPT-5-Codex]     end
04026 [GPT-5-Codex] 
04027 [GPT-5-Codex]     if titleInClassSelect then
04028 [GPT-5-Codex]         vmupro.graphics.clear(COLOR_DARK_GRAY)
04029 [GPT-5-Codex] 
04030 [GPT-5-Codex]         local classId = getClassIdForSelection(titleClassSelection)
04031 [GPT-5-Codex]         local classDef = getClassDefById(classId)
04032 [GPT-5-Codex]         local className = string.upper(getClassName(classId))
04033 [GPT-5-Codex] 
04034 [GPT-5-Codex]         vmupro.graphics.drawFillRect(8, 8, 232, 32, COLOR_GRAY)
04035 [GPT-5-Codex]         drawRectOutline(8, 8, 232, 32, COLOR_LIGHT_GRAY)
04036 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
04037 [GPT-5-Codex]         local titleText = "< " .. className .. " >"
04038 [GPT-5-Codex]         local titleX = 120 - math.floor((#titleText * 8) / 2)
04039 [GPT-5-Codex]         if titleX < 12 then titleX = 12 end
04040 [GPT-5-Codex]         drawMenuText(titleText, titleX, 14, COLOR_BLACK)
04041 [GPT-5-Codex] 
04042 [GPT-5-Codex]         vmupro.graphics.drawFillRect(8, 40, 116, 232, COLOR_GRAY)
04043 [GPT-5-Codex]         drawRectOutline(8, 40, 116, 232, COLOR_LIGHT_GRAY)
04044 [GPT-5-Codex]         vmupro.graphics.drawFillRect(124, 40, 232, 232, COLOR_GRAY)
04045 [GPT-5-Codex]         drawRectOutline(124, 40, 232, 232, COLOR_LIGHT_GRAY)
04046 [GPT-5-Codex] 
04047 [GPT-5-Codex]         local classPortrait = nil
04048 [GPT-5-Codex]         if classPortraitSprites and classPortraitSprites[classId] then
04049 [GPT-5-Codex]             classPortrait = classPortraitSprites[classId]
04050 [GPT-5-Codex]         else
04051 [GPT-5-Codex]             classPortrait = classPortraitSprite
04052 [GPT-5-Codex]         end
04053 [GPT-5-Codex]         if classPortrait and classPortrait.width and classPortrait.height then
04054 [GPT-5-Codex]             local desiredHeight = 187 -- 15% larger than previous 163px target
04055 [GPT-5-Codex]             local scaleY = safeDivide(desiredHeight, classPortrait.height, "titleClassPortraitSingle")
04056 [GPT-5-Codex]             local scaleX = scaleY
04057 [GPT-5-Codex]             if classId == "archer" then
04058 [GPT-5-Codex]                 scaleY = scaleY * 1.10 -- Increase Archer height by 10%
04059 [GPT-5-Codex]                 scaleX = scaleX * 0.92 -- Reduce Archer width by an additional 3% (total 8%)
04060 [GPT-5-Codex]             end
04061 [GPT-5-Codex]             local scaledW = classPortrait.width * scaleX
04062 [GPT-5-Codex]             local scaledH = classPortrait.height * scaleY
04063 [GPT-5-Codex]             local drawX = 178 - math.floor(scaledW / 2)
04064 [GPT-5-Codex]             local drawY = 224 - math.floor(scaledH)
04065 [GPT-5-Codex]             if drawY < 40 then drawY = 40 end
04066 [GPT-5-Codex]             vmupro.sprite.drawScaled(classPortrait, drawX, drawY, scaleX, scaleY, vmupro.sprite.kImageUnflipped)
04067 [GPT-5-Codex]         end
04068 [GPT-5-Codex] 
04069 [GPT-5-Codex]         local stats = getClassTemplateStats(classId, classDef)
04070 [GPT-5-Codex]         local statAgi = toNumber(stats.agility, 0.0)
04071 [GPT-5-Codex]         local statPow = toNumber(stats.power, 0.0)
04072 [GPT-5-Codex]         local statDef = toNumber(stats.defense, 0.0)
04073 [GPT-5-Codex]         local statDod = toNumber(stats.dodge, 0.0)
04074 [GPT-5-Codex]         local statReg = toNumber(stats.regen, 0.0)
04075 [GPT-5-Codex]         local statCrit = toNumber(stats.crit, 0.0)
04076 [GPT-5-Codex]         local statAtkSpd = toNumber(stats.atk_speed, 0.0)
04077 [GPT-5-Codex]         local statShield = toNumber(stats.shield_bonus, 0.0)
04078 [GPT-5-Codex]         local statStartY = 62
04079 [GPT-5-Codex]         local statStepY = 14 -- Extra spacing so rows do not visually touch
04080 [GPT-5-Codex] 
04081 [GPT-5-Codex]         -- Styled header: larger font, faux-bold pass, and underline
04082 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
04083 [GPT-5-Codex]         drawMenuText("[STATS]", 30, 45, COLOR_BLACK)
04084 [GPT-5-Codex]         drawMenuText("[STATS]", 31, 45, COLOR_BLACK)
04085 [GPT-5-Codex]         vmupro.graphics.drawFillRect(30, 59, 90, 60, COLOR_BLACK)
04086 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_TINY_6x8)
04087 [GPT-5-Codex]         drawMenuText("AGILITY", 12, statStartY + (statStepY * 0), COLOR_BLACK)
04088 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statAgi), 76, statStartY + (statStepY * 0), COLOR_BLACK)
04089 [GPT-5-Codex]         drawMenuText("POWER", 12, statStartY + (statStepY * 1), COLOR_BLACK)
04090 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statPow), 76, statStartY + (statStepY * 1), COLOR_BLACK)
04091 [GPT-5-Codex]         drawMenuText("DEF", 12, statStartY + (statStepY * 2), COLOR_BLACK)
04092 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statDef), 76, statStartY + (statStepY * 2), COLOR_BLACK)
04093 [GPT-5-Codex]         drawMenuText("DODGE", 12, statStartY + (statStepY * 3), COLOR_BLACK)
04094 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statDod), 76, statStartY + (statStepY * 3), COLOR_BLACK)
04095 [GPT-5-Codex]         drawMenuText("REGEN", 12, statStartY + (statStepY * 4), COLOR_BLACK)
04096 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statReg), 76, statStartY + (statStepY * 4), COLOR_BLACK)
04097 [GPT-5-Codex]         drawMenuText("CRIT", 12, statStartY + (statStepY * 5), COLOR_BLACK)
04098 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statCrit), 76, statStartY + (statStepY * 5), COLOR_BLACK)
04099 [GPT-5-Codex]         drawMenuText("ATK SP", 12, statStartY + (statStepY * 6), COLOR_BLACK)
04100 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statAtkSpd), 76, statStartY + (statStepY * 6), COLOR_BLACK)
04101 [GPT-5-Codex]         drawMenuText("SHIELD", 12, statStartY + (statStepY * 7), COLOR_BLACK)
04102 [GPT-5-Codex]         drawMenuText(string.format("%.2f", statShield), 76, statStartY + (statStepY * 7), COLOR_BLACK)
04103 [GPT-5-Codex] 
04104 [GPT-5-Codex]         vmupro.graphics.drawFillRect(0, 220, 239, 239, COLOR_GRAY)
04105 [GPT-5-Codex]         drawRectOutline(0, 220, 239, 239, COLOR_LIGHT_GRAY)
04106 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_TINY_6x8)
04107 [GPT-5-Codex]         drawUiText("LEFT/RIGHT CHANGE   A CONTINUE   B BACK", 3, 227, COLOR_BLACK, COLOR_GRAY)
04108 [GPT-5-Codex]     elseif titleInLoadMenu then
04109 [GPT-5-Codex]         drawUiPanel(16, 44, 224, 239, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
04110 [GPT-5-Codex]         drawUiPanel(26, 54, 214, 76, COLOR_MAROON, COLOR_WHITE)
04111 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
04112 [GPT-5-Codex]         drawMenuText("LOAD GAME", 74, 59, COLOR_WHITE)
04113 [GPT-5-Codex]         for i = 1, SAVE_SLOT_COUNT do
04114 [GPT-5-Codex]             local y = 86 + (i - 1) * 48
04115 [GPT-5-Codex]             local textColor = COLOR_LIGHT_GRAY
04116 [GPT-5-Codex]             if i == titleLoadSelection then
04117 [GPT-5-Codex]                 drawUiPanel(26, y, 214, y + 38, COLOR_MAROON, COLOR_WHITE)
04118 [GPT-5-Codex]                 textColor = COLOR_WHITE
04119 [GPT-5-Codex]             end
04120 [GPT-5-Codex]             local line1, line2 = getSaveSlotSummary(i)
04121 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_SMALL)
04122 [GPT-5-Codex]             drawMenuText(line1, 34, y + 4, textColor)
04123 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_TINY_6x8)
04124 [GPT-5-Codex]             drawMenuText(line2, 34, y + 22, textColor)
04125 [GPT-5-Codex]         end
04126 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_TINY_6x8)
04127 [GPT-5-Codex]         drawMenuText("A/MODE LOAD  B BACK", 56, 228, COLOR_WHITE)
04128 [GPT-5-Codex]     elseif titleInOptions then
04129 [GPT-5-Codex]         -- Options submenu
04130 [GPT-5-Codex]         logBoot(vmupro.system.LOG_ERROR, "D title options text")
04131 [GPT-5-Codex]         -- Large single-column menu box (extend to bottom)
04132 [GPT-5-Codex]         drawUiPanel(20, 50, 220, 239, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
04133 [GPT-5-Codex]         drawUiPanel(30, 60, 210, 82, COLOR_MAROON, COLOR_WHITE)
04134 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_TINY_6x8)
04135 [GPT-5-Codex]         drawMenuText(titleInDebug and "DEBUG" or "OPTIONS", 92, 65, COLOR_WHITE)
04136 [GPT-5-Codex] 
04137 [GPT-5-Codex]         local items = {}
04138 [GPT-5-Codex]         if titleInDebug then
04139 [GPT-5-Codex]             items = buildDebugMenuItems()
04140 [GPT-5-Codex]         else
04141 [GPT-5-Codex]             local levelLabel = LEVEL_SELECT_LIST[selectedLevel] and LEVEL_SELECT_LIST[selectedLevel].label or tostring(selectedLevel)
04142 [GPT-5-Codex]             local levelText = "LEVEL: " .. levelLabel
04143 [GPT-5-Codex]             local soundText = "SOUND: " .. (soundEnabled and "ON" or "OFF")
04144 [GPT-5-Codex]             local healthText = "HEALTH%: " .. (showHealthPercent and "ON" or "OFF")
04145 [GPT-5-Codex]             local rendererText = "RENDER: EXP-H LOCK"
04146 [GPT-5-Codex]             items = {levelText, soundText, healthText, rendererText, "DEBUG", "BACK"}
04147 [GPT-5-Codex]         end
04148 [GPT-5-Codex]         local visibleCount = titleInDebug and 10 or #items
04149 [GPT-5-Codex]         if titleInDebug and visibleCount > #items then
04150 [GPT-5-Codex]             visibleCount = #items
04151 [GPT-5-Codex]         end
04152 [GPT-5-Codex]         local sel = titleInDebug and titleDebugSelection or titleOptionsSelection
04153 [GPT-5-Codex]         local startIndex = 1
04154 [GPT-5-Codex]         if titleInDebug and #items > visibleCount then
04155 [GPT-5-Codex]             local half = math.floor(visibleCount / 2)
04156 [GPT-5-Codex]             startIndex = sel - half
04157 [GPT-5-Codex]             if startIndex < 1 then startIndex = 1 end
04158 [GPT-5-Codex]             local maxStart = #items - visibleCount + 1
04159 [GPT-5-Codex]             if startIndex > maxStart then startIndex = maxStart end
04160 [GPT-5-Codex]         end
04161 [GPT-5-Codex]         local endIndex = math.min(#items, startIndex + visibleCount - 1)
04162 [GPT-5-Codex] 
04163 [GPT-5-Codex]         local drawRow = 0
04164 [GPT-5-Codex]         for i = startIndex, endIndex do
04165 [GPT-5-Codex]             local item = items[i]
04166 [GPT-5-Codex]             local x = 34
04167 [GPT-5-Codex]             local startY = titleInDebug and 74 or 90
04168 [GPT-5-Codex]             local stepY = titleInDebug and 16 or 18
04169 [GPT-5-Codex]             local y = startY + drawRow * stepY
04170 [GPT-5-Codex]             local textColor = COLOR_GRAY
04171 [GPT-5-Codex]             if i == sel then
04172 [GPT-5-Codex]                 local boxH = titleInDebug and 12 or 18
04173 [GPT-5-Codex]                 drawUiPanel(32, y, 208, y + boxH, COLOR_MAROON, COLOR_WHITE)
04174 [GPT-5-Codex]                 textColor = COLOR_WHITE
04175 [GPT-5-Codex]             end
04176 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_TINY_6x8)
04177 [GPT-5-Codex]             drawMenuText(item, x, y + 2, textColor)
04178 [GPT-5-Codex]             drawRow = drawRow + 1
04179 [GPT-5-Codex]         end
04180 [GPT-5-Codex]         if titleInDebug then
04181 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_TINY_6x8)
04182 [GPT-5-Codex]             drawMenuText("L/R ADJUST", 34, 226, COLOR_WHITE)
04183 [GPT-5-Codex]         end
04184 [GPT-5-Codex]     else
04185 [GPT-5-Codex]         -- Main title menu
04186 [GPT-5-Codex]         logBoot(vmupro.system.LOG_ERROR, "D title main text")
04187 [GPT-5-Codex]         -- Compact menu box for 4 items
04188 [GPT-5-Codex]         drawUiPanel(52, 132, 188, 232, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
04189 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
04190 [GPT-5-Codex]         local items = {"NEW GAME", "LOAD GAME", "OPTIONS", "EXIT"}
04191 [GPT-5-Codex]         for i, item in ipairs(items) do
04192 [GPT-5-Codex]             local y = 142 + (i - 1) * 22
04193 [GPT-5-Codex]             local textColor = COLOR_GRAY
04194 [GPT-5-Codex]             if i == titleSelection then
04195 [GPT-5-Codex]                 drawUiPanel(62, y, 178, y + 20, COLOR_MAROON, COLOR_WHITE)
04196 [GPT-5-Codex]                 textColor = COLOR_WHITE
04197 [GPT-5-Codex]             end
04198 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_SMALL)
04199 [GPT-5-Codex]             drawMenuText(item, 72, y + 3, textColor)
04200 [GPT-5-Codex]         end
04201 [GPT-5-Codex]     end
04202 [GPT-5-Codex] end
04203 [GPT-5-Codex] 
04204 [GPT-5-Codex] drawTitleScreen = drawTitleScreenImpl
04205 [GPT-5-Codex] logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen bound to impl")
04206 [GPT-5-Codex] 
04207 [GPT-5-Codex] -- Draw game over screen
04208 [GPT-5-Codex] local function drawGameOver()
04209 [GPT-5-Codex]     -- Darken background
04210 [GPT-5-Codex]     drawUiPanel(40, 70, 200, 195, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
04211 [GPT-5-Codex] 
04212 [GPT-5-Codex]     -- Title
04213 [GPT-5-Codex]     drawUiPanel(50, 80, 190, 102, COLOR_MAROON, COLOR_WHITE)
04214 [GPT-5-Codex]     setFontCached(vmupro.text.FONT_SMALL)
04215 [GPT-5-Codex]     drawMenuText("GAME OVER", 76, 85, COLOR_WHITE)
04216 [GPT-5-Codex] 
04217 [GPT-5-Codex]     -- Menu items
04218 [GPT-5-Codex]     local items = {"RESTART", "MENU", "QUIT"}
04219 [GPT-5-Codex]     for i, item in ipairs(items) do
04220 [GPT-5-Codex]         local y = 110 + (i - 1) * 18
04221 [GPT-5-Codex]         local textColor = COLOR_GRAY
04222 [GPT-5-Codex]         if i == gameOverSelection then
04223 [GPT-5-Codex]             drawUiPanel(50, y, 190, y + 18, COLOR_MAROON, COLOR_WHITE)
04224 [GPT-5-Codex]             textColor = COLOR_WHITE
04225 [GPT-5-Codex]         end
04226 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
04227 [GPT-5-Codex]         drawMenuText(item, 86, y + 2, textColor)
04228 [GPT-5-Codex]     end
04229 [GPT-5-Codex] end
04230 [GPT-5-Codex] 
04231 [GPT-5-Codex] -- Reset game state for restart
04232 [GPT-5-Codex] local function resetGame()
04233 [GPT-5-Codex]     restartLevel()
04234 [GPT-5-Codex] end
04235 [GPT-5-Codex] 
04236 [GPT-5-Codex] -- Collision detection for sprites
04237 [GPT-5-Codex] function collidesWithSprite(nx, ny, playerRadius)
04238 [GPT-5-Codex]     if not sprites or #sprites == 0 then return false end
04239 [GPT-5-Codex]     local pr = playerRadius or PLAYER_COLLISION_RADIUS or 0.27
04240 [GPT-5-Codex]     if pr < 0.1 then pr = 0.1 end
04241 [GPT-5-Codex]     if DEBUG_DISABLE_ENEMIES then
04242 [GPT-5-Codex]         return false
04243 [GPT-5-Codex]     end
04244 [GPT-5-Codex]     for i = 1, #sprites do
04245 [GPT-5-Codex]         local s = sprites[i]
04246 [GPT-5-Codex]         if s and isEnemyType(s.t) then
04247 [GPT-5-Codex]             local inactiveEnemy = (s.t == 5 or s.t == 6) and (s.dying or s.dead or s.alive == false)
04248 [GPT-5-Codex]             if not inactiveEnemy then
04249 [GPT-5-Codex]                 local dx, dy = nx - s.x, ny - s.y
04250 [GPT-5-Codex]                 local sr = 0.34
04251 [GPT-5-Codex]                 local minDist = pr + sr
04252 [GPT-5-Codex]                 if (dx * dx + dy * dy) < (minDist * minDist) then
04253 [GPT-5-Codex]                     return true
04254 [GPT-5-Codex]                 end
04255 [GPT-5-Codex]             end
04256 [GPT-5-Codex]         end
04257 [GPT-5-Codex]     end
04258 [GPT-5-Codex]     return false
04259 [GPT-5-Codex] end
04260 [GPT-5-Codex] 
04261 [GPT-5-Codex] local function getWallColor(wtype, side)
04262 [GPT-5-Codex]     if wtype == 1 then
04263 [GPT-5-Codex]         if side == 1 then return COLOR_STONE_D else return COLOR_STONE_L end
04264 [GPT-5-Codex]     elseif wtype == 2 then
04265 [GPT-5-Codex]         if side == 1 then return COLOR_BRICK_D else return COLOR_BRICK_L end
04266 [GPT-5-Codex]     elseif wtype == 3 then
04267 [GPT-5-Codex]         if side == 1 then return COLOR_MOSS_D else return COLOR_MOSS_L end
04268 [GPT-5-Codex]     elseif wtype == 4 then
04269 [GPT-5-Codex]         if side == 1 then return COLOR_METAL_D else return COLOR_METAL_L end
04270 [GPT-5-Codex]     elseif wtype == 5 then
04271 [GPT-5-Codex]         if side == 1 then return COLOR_WOOD_D else return COLOR_WOOD_L end
04272 [GPT-5-Codex]     elseif wtype == 6 then
04273 [GPT-5-Codex]         if side == 1 then return COLOR_DARK_BLUE else return COLOR_LIGHT_BLUE end
04274 [GPT-5-Codex]     else
04275 [GPT-5-Codex]         if side == 1 then return COLOR_STONE_D else return COLOR_STONE_L end
04276 [GPT-5-Codex]     end
04277 [GPT-5-Codex] end
04278 [GPT-5-Codex] 
04279 [GPT-5-Codex] local function getPlayerCollisionRadius()
04280 [GPT-5-Codex]     local r = PLAYER_COLLISION_RADIUS or 0.27
04281 [GPT-5-Codex]     if r < 0.1 then r = 0.1 end
04282 [GPT-5-Codex]     return r
04283 [GPT-5-Codex] end
04284 [GPT-5-Codex] 
04285 [GPT-5-Codex] local function isWalkableWithRadius(x, y, radius)
04286 [GPT-5-Codex]     local r = radius
04287 [GPT-5-Codex]     if not r or r <= 0 then
04288 [GPT-5-Codex]         r = getPlayerCollisionRadius()
04289 [GPT-5-Codex]     end
04290 [GPT-5-Codex]     if r < 0.05 then r = 0.05 end
04291 [GPT-5-Codex] 
04292 [GPT-5-Codex]     local function solidAt(mx, my)
04293 [GPT-5-Codex]         if mx < 0 or mx >= 16 or my < 0 or my >= 16 then
04294 [GPT-5-Codex]             return true
04295 [GPT-5-Codex]         end
04296 [GPT-5-Codex]         local row = map and map[my + 1]
04297 [GPT-5-Codex]         if not row then
04298 [GPT-5-Codex]             return true
04299 [GPT-5-Codex]         end
04300 [GPT-5-Codex]         return (row[mx + 1] or 1) ~= 0
04301 [GPT-5-Codex]     end
04302 [GPT-5-Codex] 
04303 [GPT-5-Codex]     local minMx = math.floor(x - r)
04304 [GPT-5-Codex]     local maxMx = math.floor(x + r)
04305 [GPT-5-Codex]     local minMy = math.floor(y - r)
04306 [GPT-5-Codex]     local maxMy = math.floor(y + r)
04307 [GPT-5-Codex]     local clearance = PLAYER_WALL_CLEARANCE_EPSILON or 0.004
04308 [GPT-5-Codex]     if clearance < 0 then clearance = 0 end
04309 [GPT-5-Codex]     local collisionR = r - (PLAYER_WALL_COLLISION_INSET or 0.005) + clearance
04310 [GPT-5-Codex]     if collisionR < 0.05 then collisionR = 0.05 end
04311 [GPT-5-Codex]     local rr = collisionR * collisionR
04312 [GPT-5-Codex] 
04313 [GPT-5-Codex]     for my = minMy, maxMy do
04314 [GPT-5-Codex]         for mx = minMx, maxMx do
04315 [GPT-5-Codex]             if solidAt(mx, my) then
04316 [GPT-5-Codex]                 local nearestX = x
04317 [GPT-5-Codex]                 local nearestY = y
04318 [GPT-5-Codex]                 local tileMinX = mx
04319 [GPT-5-Codex]                 local tileMaxX = mx + 1
04320 [GPT-5-Codex]                 local tileMinY = my
04321 [GPT-5-Codex]                 local tileMaxY = my + 1
04322 [GPT-5-Codex]                 if nearestX < tileMinX then nearestX = tileMinX end
04323 [GPT-5-Codex]                 if nearestX > tileMaxX then nearestX = tileMaxX end
04324 [GPT-5-Codex]                 if nearestY < tileMinY then nearestY = tileMinY end
04325 [GPT-5-Codex]                 if nearestY > tileMaxY then nearestY = tileMaxY end
04326 [GPT-5-Codex]                 local dx = x - nearestX
04327 [GPT-5-Codex]                 local dy = y - nearestY
04328 [GPT-5-Codex]                 if (dx * dx + dy * dy) <= rr then
04329 [GPT-5-Codex]                     return false
04330 [GPT-5-Codex]                 end
04331 [GPT-5-Codex]             end
04332 [GPT-5-Codex]         end
04333 [GPT-5-Codex]     end
04334 [GPT-5-Codex] 
04335 [GPT-5-Codex]     return true
04336 [GPT-5-Codex] end
04337 [GPT-5-Codex] 
04338 [GPT-5-Codex] local function updatePlayerSafetyAnchor()
04339 [GPT-5-Codex]     local radius = getPlayerCollisionRadius()
04340 [GPT-5-Codex]     if isWalkableWithRadius(px, py, radius) then
04341 [GPT-5-Codex]         lastSafeWallX = px
04342 [GPT-5-Codex]         lastSafeWallY = py
04343 [GPT-5-Codex]         return true
04344 [GPT-5-Codex]     end
04345 [GPT-5-Codex]     return false
04346 [GPT-5-Codex] end
04347 [GPT-5-Codex] 
04348 [GPT-5-Codex] local RECOVER_DIRS = {
04349 [GPT-5-Codex]     { 1.0,  0.0}, {-1.0,  0.0}, { 0.0,  1.0}, { 0.0, -1.0},
04350 [GPT-5-Codex]     { 0.7071,  0.7071}, { 0.7071, -0.7071}, {-0.7071,  0.7071}, {-0.7071, -0.7071},
04351 [GPT-5-Codex] }
04352 [GPT-5-Codex] 
04353 [GPT-5-Codex] local function recoverPlayerFromWallPenetration()
04354 [GPT-5-Codex]     local radius = getPlayerCollisionRadius()
04355 [GPT-5-Codex]     if isWalkableWithRadius(px, py, radius) then
04356 [GPT-5-Codex]         lastSafeWallX = px
04357 [GPT-5-Codex]         lastSafeWallY = py
04358 [GPT-5-Codex]         return false
04359 [GPT-5-Codex]     end
04360 [GPT-5-Codex] 
04361 [GPT-5-Codex]     if lastSafeWallX and lastSafeWallY and isWalkableWithRadius(lastSafeWallX, lastSafeWallY, radius) then
04362 [GPT-5-Codex]         px = lastSafeWallX
04363 [GPT-5-Codex]         py = lastSafeWallY
04364 [GPT-5-Codex]         PERF_MONITOR_WALL_RECOVERIES = (PERF_MONITOR_WALL_RECOVERIES or 0) + 1
04365 [GPT-5-Codex]         return true
04366 [GPT-5-Codex]     end
04367 [GPT-5-Codex] 
04368 [GPT-5-Codex]     local baseX = px
04369 [GPT-5-Codex]     local baseY = py
04370 [GPT-5-Codex]     local step = PLAYER_MOVE_SUBSTEP or 0.08
04371 [GPT-5-Codex]     if step < 0.01 then step = 0.01 end
04372 [GPT-5-Codex]     if step > 0.05 then step = 0.05 end
04373 [GPT-5-Codex]     local maxRadius = (PLAYER_COLLISION_RADIUS or 0.27) + 0.30
04374 [GPT-5-Codex]     local r = step
04375 [GPT-5-Codex]     while r <= maxRadius do
04376 [GPT-5-Codex]         for i = 1, #RECOVER_DIRS do
04377 [GPT-5-Codex]             local dir = RECOVER_DIRS[i]
04378 [GPT-5-Codex]             local tx = baseX + dir[1] * r
04379 [GPT-5-Codex]             local ty = baseY + dir[2] * r
04380 [GPT-5-Codex]             if isWalkableWithRadius(tx, ty, radius) then
04381 [GPT-5-Codex]                 px = tx
04382 [GPT-5-Codex]                 py = ty
04383 [GPT-5-Codex]                 lastSafeWallX = tx
04384 [GPT-5-Codex]                 lastSafeWallY = ty
04385 [GPT-5-Codex]                 PERF_MONITOR_WALL_RECOVERIES = (PERF_MONITOR_WALL_RECOVERIES or 0) + 1
04386 [GPT-5-Codex]                 return true
04387 [GPT-5-Codex]             end
04388 [GPT-5-Codex]         end
04389 [GPT-5-Codex]         r = r + step
04390 [GPT-5-Codex]     end
04391 [GPT-5-Codex] 
04392 [GPT-5-Codex]     local level = LEVELS and LEVELS[currentLevel]
04393 [GPT-5-Codex]     if level and level.playerStart then
04394 [GPT-5-Codex]         local sx = level.playerStart.x
04395 [GPT-5-Codex]         local sy = level.playerStart.y
04396 [GPT-5-Codex]         if isWalkableWithRadius(sx, sy, radius) then
04397 [GPT-5-Codex]             px = sx
04398 [GPT-5-Codex]             py = sy
04399 [GPT-5-Codex]             lastSafeWallX = sx
04400 [GPT-5-Codex]             lastSafeWallY = sy
04401 [GPT-5-Codex]             PERF_MONITOR_WALL_RECOVERIES = (PERF_MONITOR_WALL_RECOVERIES or 0) + 1
04402 [GPT-5-Codex]             return true
04403 [GPT-5-Codex]         end
04404 [GPT-5-Codex]     end
04405 [GPT-5-Codex] 
04406 [GPT-5-Codex]     return false
04407 [GPT-5-Codex] end
04408 [GPT-5-Codex] 
04409 [GPT-5-Codex] -- Movement collision helper (walls + sprites)
04410 [GPT-5-Codex] function canMove(x, y, radius)
04411 [GPT-5-Codex]     if not isWalkableWithRadius(x, y, radius) then
04412 [GPT-5-Codex]         return false
04413 [GPT-5-Codex]     end
04414 [GPT-5-Codex]     if collidesWithSprite(x, y, radius) then
04415 [GPT-5-Codex]         return false
04416 [GPT-5-Codex]     end
04417 [GPT-5-Codex]     return true
04418 [GPT-5-Codex] end
04419 [GPT-5-Codex] 
04420 [GPT-5-Codex] local function movePlayerStrict(deltaX, deltaY)
04421 [GPT-5-Codex]     recoverPlayerFromWallPenetration()
04422 [GPT-5-Codex]     local maxDelta = math.max(math.abs(deltaX or 0), math.abs(deltaY or 0))
04423 [GPT-5-Codex]     if maxDelta <= 0 then
04424 [GPT-5-Codex]         updatePlayerSafetyAnchor()
04425 [GPT-5-Codex]         return
04426 [GPT-5-Codex]     end
04427 [GPT-5-Codex]     local subStep = PLAYER_MOVE_SUBSTEP_STRICT or PLAYER_MOVE_SUBSTEP or 0.04
04428 [GPT-5-Codex]     if subStep <= 0 then subStep = 0.04 end
04429 [GPT-5-Codex]     if subStep > 0.04 then subStep = 0.04 end
04430 [GPT-5-Codex]     local subCount = math.ceil(maxDelta / subStep)
04431 [GPT-5-Codex]     if subCount < 1 then subCount = 1 end
04432 [GPT-5-Codex]     local stepX = (deltaX or 0) / subCount
04433 [GPT-5-Codex]     local stepY = (deltaY or 0) / subCount
04434 [GPT-5-Codex]     local radius = getPlayerCollisionRadius()
04435 [GPT-5-Codex]     local lastGoodX = px
04436 [GPT-5-Codex]     local lastGoodY = py
04437 [GPT-5-Codex]     local holdWallContact = PLAYER_WALL_CONTACT_HOLD_FRAMES or 4
04438 [GPT-5-Codex]     if holdWallContact < 1 then holdWallContact = 1 end
04439 [GPT-5-Codex] 
04440 [GPT-5-Codex]     local function isInsideSolidTile(x, y)
04441 [GPT-5-Codex]         local mx = math.floor(x)
04442 [GPT-5-Codex]         local my = math.floor(y)
04443 [GPT-5-Codex]         if mx < 0 or mx >= 16 or my < 0 or my >= 16 then
04444 [GPT-5-Codex]             return true
04445 [GPT-5-Codex]         end
04446 [GPT-5-Codex]         local row = map and map[my + 1]
04447 [GPT-5-Codex]         if not row then
04448 [GPT-5-Codex]             return true
04449 [GPT-5-Codex]         end
04450 [GPT-5-Codex]         local tile = row[mx + 1] or 1
04451 [GPT-5-Codex]         return tile > 0
04452 [GPT-5-Codex]     end
04453 [GPT-5-Codex] 
04454 [GPT-5-Codex]     local function tryStrictStep(moveX, moveY)
04455 [GPT-5-Codex]         local nx = px + moveX
04456 [GPT-5-Codex]         local ny = py + moveY
04457 [GPT-5-Codex]         if canMove(nx, ny, radius) then
04458 [GPT-5-Codex]             px = nx
04459 [GPT-5-Codex]             py = ny
04460 [GPT-5-Codex]             return true
04461 [GPT-5-Codex]         end
04462 [GPT-5-Codex] 
04463 [GPT-5-Codex]         PERF_MONITOR_MOVE_BLOCKED = (PERF_MONITOR_MOVE_BLOCKED or 0) + 1
04464 [GPT-5-Codex] 
04465 [GPT-5-Codex]         local moved = false
04466 [GPT-5-Codex]         if moveX ~= 0 then
04467 [GPT-5-Codex]             local slideX = px + moveX
04468 [GPT-5-Codex]             if canMove(slideX, py, radius) then
04469 [GPT-5-Codex]                 px = slideX
04470 [GPT-5-Codex]                 moved = true
04471 [GPT-5-Codex]             end
04472 [GPT-5-Codex]         end
04473 [GPT-5-Codex]         if moveY ~= 0 then
04474 [GPT-5-Codex]             local slideY = py + moveY
04475 [GPT-5-Codex]             if canMove(px, slideY, radius) then
04476 [GPT-5-Codex]                 py = slideY
04477 [GPT-5-Codex]                 moved = true
04478 [GPT-5-Codex]             end
04479 [GPT-5-Codex]         end
04480 [GPT-5-Codex]         if not moved then
04481 [GPT-5-Codex]             if (PLAYER_WALL_CONTACT_FRAMES or 0) < holdWallContact then
04482 [GPT-5-Codex]                 PLAYER_WALL_CONTACT_FRAMES = holdWallContact
04483 [GPT-5-Codex]             end
04484 [GPT-5-Codex]         end
04485 [GPT-5-Codex]         return moved
04486 [GPT-5-Codex]     end
04487 [GPT-5-Codex] 
04488 [GPT-5-Codex]     for _ = 1, subCount do
04489 [GPT-5-Codex]         local stepMoved = tryStrictStep(stepX, stepY)
04490 [GPT-5-Codex]         if isInsideSolidTile(px, py) then
04491 [GPT-5-Codex]             -- Safety: never remain inside a wall cell; restore last valid position.
04492 [GPT-5-Codex]             px = lastGoodX
04493 [GPT-5-Codex]             py = lastGoodY
04494 [GPT-5-Codex]             break
04495 [GPT-5-Codex]         end
04496 [GPT-5-Codex]         if not isWalkableWithRadius(px, py, radius) then
04497 [GPT-5-Codex]             if not recoverPlayerFromWallPenetration() then
04498 [GPT-5-Codex]                 px = lastGoodX
04499 [GPT-5-Codex]                 py = lastGoodY
04500 [GPT-5-Codex]                 break
04501 [GPT-5-Codex]             end
04502 [GPT-5-Codex]         end
04503 [GPT-5-Codex]         if stepMoved then
04504 [GPT-5-Codex]             lastGoodX = px
04505 [GPT-5-Codex]             lastGoodY = py
04506 [GPT-5-Codex]         else
04507 [GPT-5-Codex]             -- Nothing moved for this substep; avoid re-testing the same blocked step repeatedly.
04508 [GPT-5-Codex]             break
04509 [GPT-5-Codex]         end
04510 [GPT-5-Codex]     end
04511 [GPT-5-Codex]     updatePlayerSafetyAnchor()
04512 [GPT-5-Codex] end
04513 [GPT-5-Codex] 
04514 [GPT-5-Codex] local function movePlayerWithSlide(deltaX, deltaY)
04515 [GPT-5-Codex]     movePlayerStrict(deltaX, deltaY)
04516 [GPT-5-Codex] end
04517 [GPT-5-Codex] 
04518 [GPT-5-Codex] local function getPlayerRenderNearClipDist()
04519 [GPT-5-Codex]     local nearClip = PLAYER_RENDER_NEAR_CLIP_DIST or 0.38
04520 [GPT-5-Codex]     if nearClip < 0.20 then nearClip = 0.20 end
04521 [GPT-5-Codex]     return nearClip
04522 [GPT-5-Codex] end
04523 [GPT-5-Codex] 
04524 [GPT-5-Codex] local function getFogFactor(dist)
04525 [GPT-5-Codex]     if DEBUG_DISABLE_FOG then
04526 [GPT-5-Codex]         return 0.0
04527 [GPT-5-Codex]     end
04528 [GPT-5-Codex]     local startDist = FOG_START or 0.0
04529 [GPT-5-Codex]     local endDist = FOG_END or (startDist + 1.0)
04530 [GPT-5-Codex]     if endDist <= startDist then
04531 [GPT-5-Codex]         endDist = startDist + 0.001
04532 [GPT-5-Codex]     end
04533 [GPT-5-Codex]     if dist <= startDist then return 0.0 end
04534 [GPT-5-Codex]     if dist >= endDist then return 1.0 end
04535 [GPT-5-Codex]     return (dist - startDist) / (endDist - startDist)
04536 [GPT-5-Codex] end
04537 [GPT-5-Codex] 
04538 [GPT-5-Codex] local function getFogQuantizedFactor(dist)
04539 [GPT-5-Codex]     if DEBUG_DISABLE_FOG then
04540 [GPT-5-Codex]         return 0.0
04541 [GPT-5-Codex]     end
04542 [GPT-5-Codex]     local startDist = FOG_START or 0.0
04543 [GPT-5-Codex]     local endDist = FOG_END or (startDist + 0.5)
04544 [GPT-5-Codex]     if endDist <= startDist then
04545 [GPT-5-Codex]         endDist = startDist + 0.5
04546 [GPT-5-Codex]     end
04547 [GPT-5-Codex]     if dist <= startDist then
04548 [GPT-5-Codex]         return 0.0
04549 [GPT-5-Codex]     end
04550 [GPT-5-Codex]     if dist >= endDist then
04551 [GPT-5-Codex]         return 1.0
04552 [GPT-5-Codex]     end
04553 [GPT-5-Codex] 
04554 [GPT-5-Codex]     local span = endDist - startDist
04555 [GPT-5-Codex]     if span < 0.5 then span = 0.5 end
04556 [GPT-5-Codex]     local stepCount = math.max(1, math.floor((span / 0.5) + 0.5))
04557 [GPT-5-Codex]     local raw = (dist - startDist) / span
04558 [GPT-5-Codex]     if raw < 0 then raw = 0 end
04559 [GPT-5-Codex]     if raw > 1 then raw = 1 end
04560 [GPT-5-Codex]     local k = math.ceil(raw * stepCount)
04561 [GPT-5-Codex]     if k < 0 then k = 0 end
04562 [GPT-5-Codex]     if k > stepCount then k = stepCount end
04563 [GPT-5-Codex]     return k / (stepCount + 1)
04564 [GPT-5-Codex] end
04565 [GPT-5-Codex] 
04566 [GPT-5-Codex] local function fogBlend(color, dist)
04567 [GPT-5-Codex]     local t = getFogQuantizedFactor(dist)
04568 [GPT-5-Codex]     if t <= 0 then return color end
04569 [GPT-5-Codex]     if t >= 1 then return FOG_COLOR end
04570 [GPT-5-Codex]     local r = color & 0x1F
04571 [GPT-5-Codex]     local g = (color >> 5) & 0x3F
04572 [GPT-5-Codex]     local b = (color >> 11) & 0x1F
04573 [GPT-5-Codex]     local fr = FOG_COLOR & 0x1F
04574 [GPT-5-Codex]     local fg = (FOG_COLOR >> 5) & 0x3F
04575 [GPT-5-Codex]     local fb = (FOG_COLOR >> 11) & 0x1F
04576 [GPT-5-Codex]     local nr = math.floor(r + (fr - r) * t + 0.5)
04577 [GPT-5-Codex]     local ng = math.floor(g + (fg - g) * t + 0.5)
04578 [GPT-5-Codex]     local nb = math.floor(b + (fb - b) * t + 0.5)
04579 [GPT-5-Codex]     return (nb << 11) | (ng << 5) | nr
04580 [GPT-5-Codex] end
04581 [GPT-5-Codex] 
04582 [GPT-5-Codex] local function getFogAccentColor(baseColor)
04583 [GPT-5-Codex]     local c = baseColor or COLOR_GRAY
04584 [GPT-5-Codex]     if c == COLOR_WHITE then return COLOR_LIGHT_GRAY end
04585 [GPT-5-Codex]     if c == COLOR_LIGHT_GRAY then return COLOR_WHITE end
04586 [GPT-5-Codex]     if c == COLOR_GRAY then return COLOR_LIGHT_GRAY end
04587 [GPT-5-Codex]     if c == COLOR_DARK_GRAY then return COLOR_GRAY end
04588 [GPT-5-Codex]     if c == COLOR_BLACK then return COLOR_DARK_GRAY end
04589 [GPT-5-Codex]     if c == COLOR_MAROON then return COLOR_DARK_GRAY end
04590 [GPT-5-Codex]     return COLOR_LIGHT_GRAY
04591 [GPT-5-Codex] end
04592 [GPT-5-Codex] 
04593 [GPT-5-Codex] local FOG_HATCH_PROFILES = {
04594 [GPT-5-Codex]     -- 1 = finest/thickest, 6 = ultra-light/cheapest
04595 [GPT-5-Codex]     [1] = {band_h = 1, fill_gate = 1, diag_a_step = 4,  diag_b_step = 6,  cross_enable_threshold = 2},
04596 [GPT-5-Codex]     [2] = {band_h = 2, fill_gate = 1, diag_a_step = 5,  diag_b_step = 7,  cross_enable_threshold = 3},
04597 [GPT-5-Codex]     [3] = {band_h = 3, fill_gate = 1, diag_a_step = 7,  diag_b_step = 10, cross_enable_threshold = 4},
04598 [GPT-5-Codex]     [4] = {band_h = 4, fill_gate = 2, diag_a_step = 9,  diag_b_step = 13, cross_enable_threshold = 5},
04599 [GPT-5-Codex]     [5] = {band_h = 5, fill_gate = 2, diag_a_step = 12, diag_b_step = 16, cross_enable_threshold = 6},
04600 [GPT-5-Codex]     [6] = {band_h = 6, fill_gate = 3, diag_a_step = 15, diag_b_step = 20, cross_enable_threshold = 7},
04601 [GPT-5-Codex] }
04602 [GPT-5-Codex] 
04603 [GPT-5-Codex] local function drawFogOverlayArea(x1, y1, x2, y2, fogAlpha)
04604 [GPT-5-Codex]     if fogAlpha <= 0 then
04605 [GPT-5-Codex]         return
04606 [GPT-5-Codex]     end
04607 [GPT-5-Codex]     if y2 < y1 then
04608 [GPT-5-Codex]         return
04609 [GPT-5-Codex]     end
04610 [GPT-5-Codex]     local fogPrimary = FOG_COLOR or COLOR_GRAY
04611 [GPT-5-Codex]     local fogAccent = getFogAccentColor(fogPrimary)
04612 [GPT-5-Codex]     local fogAccentCross = getFogAccentColor(fogAccent)
04613 [GPT-5-Codex]     if fogPrimary == COLOR_BLACK or fogPrimary == COLOR_DARK_GRAY then
04614 [GPT-5-Codex]         -- Keep dark fog subtle: avoid bright cross-hatch lines.
04615 [GPT-5-Codex]         fogAccentCross = fogAccent
04616 [GPT-5-Codex]     end
04617 [GPT-5-Codex]     local ditherSize = FOG_DITHER_SIZE or 3
04618 [GPT-5-Codex]     if ditherSize < 1 then ditherSize = 1 end
04619 [GPT-5-Codex]     if ditherSize > 6 then ditherSize = 6 end
04620 [GPT-5-Codex]     local profile = FOG_HATCH_PROFILES[ditherSize] or FOG_HATCH_PROFILES[3]
04621 [GPT-5-Codex]     local bandH = profile.band_h or 3
04622 [GPT-5-Codex]     local fillGate = profile.fill_gate or 1
04623 [GPT-5-Codex]     local diagStepA = profile.diag_a_step or 7
04624 [GPT-5-Codex]     local diagStepB = profile.diag_b_step or 10
04625 [GPT-5-Codex]     local crossThresh = profile.cross_enable_threshold or 4
04626 [GPT-5-Codex]     if bandH < 1 then bandH = 1 end
04627 [GPT-5-Codex]     if fillGate < 1 then fillGate = 1 end
04628 [GPT-5-Codex]     if diagStepA < 2 then diagStepA = 2 end
04629 [GPT-5-Codex]     if diagStepB < 3 then diagStepB = 3 end
04630 [GPT-5-Codex] 
04631 [GPT-5-Codex]     if fogAlpha >= 1.0 then
04632 [GPT-5-Codex]         -- Full fog path must stay cheap: single fill call.
04633 [GPT-5-Codex]         vmupro.graphics.drawFillRect(x1, y1, x2, y2, fogPrimary)
04634 [GPT-5-Codex]         return
04635 [GPT-5-Codex]     end
04636 [GPT-5-Codex] 
04637 [GPT-5-Codex]     -- Quality ladder:
04638 [GPT-5-Codex]     -- lower dither profile = denser/thicker hatch
04639 [GPT-5-Codex]     -- higher dither profile = sparser/cheaper hatch
04640 [GPT-5-Codex]     local levels = 12
04641 [GPT-5-Codex]     local coverage = math.floor((fogAlpha * levels) + 0.5)
04642 [GPT-5-Codex]     if coverage < 1 then return end
04643 [GPT-5-Codex]     if coverage > levels then coverage = levels end
04644 [GPT-5-Codex]     local xCell = math.floor(x1 / bandH)
04645 [GPT-5-Codex]     local threshold = coverage / levels
04646 [GPT-5-Codex]     for y = y1, y2, bandH do
04647 [GPT-5-Codex]         local yb = y + bandH - 1
04648 [GPT-5-Codex]         if yb > y2 then yb = y2 end
04649 [GPT-5-Codex]         local rowIdx = math.floor(y / bandH)
04650 [GPT-5-Codex]         local bandMix = ((rowIdx * 3 + xCell) % levels) / levels
04651 [GPT-5-Codex]         local passFillGate = (fillGate <= 1) or (((rowIdx + xCell) % fillGate) == 0)
04652 [GPT-5-Codex]         if passFillGate and bandMix < threshold then
04653 [GPT-5-Codex]             vmupro.graphics.drawFillRect(x1, y, x2, yb, fogPrimary)
04654 [GPT-5-Codex]             if coverage >= 3 then
04655 [GPT-5-Codex]                 local startA = x1 + ((rowIdx * bandH + x1) % diagStepA)
04656 [GPT-5-Codex]                 if startA <= x2 then
04657 [GPT-5-Codex]                     vmupro.graphics.drawFillRect(startA, y, startA, yb, fogAccent)
04658 [GPT-5-Codex]                 end
04659 [GPT-5-Codex]             end
04660 [GPT-5-Codex]             if coverage >= crossThresh then
04661 [GPT-5-Codex]                 local rowPhase = (rowIdx * (bandH + 1) + x1) % diagStepB
04662 [GPT-5-Codex]                 local startB = x1 + ((diagStepB - rowPhase) % diagStepB)
04663 [GPT-5-Codex]                 if startB <= x2 then
04664 [GPT-5-Codex]                     vmupro.graphics.drawFillRect(startB, y, startB, yb, fogAccentCross)
04665 [GPT-5-Codex]                 end
04666 [GPT-5-Codex]             end
04667 [GPT-5-Codex]         end
04668 [GPT-5-Codex]     end
04669 [GPT-5-Codex] end
04670 [GPT-5-Codex] 
04671 [GPT-5-Codex] local function drawFogCurtainColumn(sx, ex, dist)
04672 [GPT-5-Codex]     if DEBUG_DISABLE_FOG then
04673 [GPT-5-Codex]         return
04674 [GPT-5-Codex]     end
04675 [GPT-5-Codex]     local d = dist or (FOG_END or EXP_TEX_MAX_DIST or 8.0)
04676 [GPT-5-Codex]     if d < 0.4 then d = 0.4 end
04677 [GPT-5-Codex]     local wallScale = VIEWPORT_H - 20
04678 [GPT-5-Codex]     local h = math.floor(wallScale / d)
04679 [GPT-5-Codex]     if h < 2 then
04680 [GPT-5-Codex]         return
04681 [GPT-5-Codex]     end
04682 [GPT-5-Codex]     if h > VIEWPORT_H then h = VIEWPORT_H end
04683 [GPT-5-Codex]     local y1 = HORIZON - math.floor(h / 2)
04684 [GPT-5-Codex]     local y2 = HORIZON + math.floor(h / 2)
04685 [GPT-5-Codex]     if y1 < 0 then y1 = 0 end
04686 [GPT-5-Codex]     if y2 > (VIEWPORT_H - 1) then y2 = VIEWPORT_H - 1 end
04687 [GPT-5-Codex]     vmupro.graphics.drawFillRect(sx, y1, ex, y2, FOG_COLOR or COLOR_GRAY)
04688 [GPT-5-Codex] end
04689 [GPT-5-Codex] 
04690 [GPT-5-Codex] local function getWallSheetForType(wtype)
04691 [GPT-5-Codex]     if wtype == 1 then return wallSheetStone end
04692 [GPT-5-Codex]     if wtype == 2 then return wallSheetBrick end
04693 [GPT-5-Codex]     if wtype == 3 then return wallSheetMoss end
04694 [GPT-5-Codex]     if wtype == 4 then return wallSheetMetal end
04695 [GPT-5-Codex]     if wtype == 5 then return wallSheetWood end
04696 [GPT-5-Codex]     if wtype == 6 then return wallSheetWindow end
04697 [GPT-5-Codex]     return wallSheetStone
04698 [GPT-5-Codex] end
04699 [GPT-5-Codex] 
04700 [GPT-5-Codex] local function drawWallTextureColumn(wtype, side, texCoord, sx, y1, y2, colW, distToWall, mipLevel)
04701 [GPT-5-Codex]     local wallH = y2 - y1
04702 [GPT-5-Codex]     if wallH <= 0 then return false end
04703 [GPT-5-Codex] 
04704 [GPT-5-Codex]     local width = colW or 4
04705 [GPT-5-Codex]     if width < 1 then width = 1 end
04706 [GPT-5-Codex]     local drawWidth = width
04707 [GPT-5-Codex]     if sx < 0 then
04708 [GPT-5-Codex]         drawWidth = drawWidth + sx
04709 [GPT-5-Codex]         sx = 0
04710 [GPT-5-Codex]     end
04711 [GPT-5-Codex]     if sx > 239 then
04712 [GPT-5-Codex]         return false
04713 [GPT-5-Codex]     end
04714 [GPT-5-Codex]     if (sx + drawWidth - 1) > 239 then
04715 [GPT-5-Codex]         drawWidth = 240 - sx
04716 [GPT-5-Codex]     end
04717 [GPT-5-Codex]     if drawWidth < 1 then
04718 [GPT-5-Codex]         return false
04719 [GPT-5-Codex]     end
04720 [GPT-5-Codex] 
04721 [GPT-5-Codex]     -- Sheet-column path: sample from 1x128 frame columns.
04722 [GPT-5-Codex]     local sheet = getWallSheetForType(wtype)
04723 [GPT-5-Codex]     if not sheet or not sheet.frameWidth or not sheet.frameHeight or not sheet.frameCount then
04724 [GPT-5-Codex]         return false
04725 [GPT-5-Codex]     end
04726 [GPT-5-Codex]     local frameW = sheet.frameWidth or 0
04727 [GPT-5-Codex]     local frameH = sheet.frameHeight or 0
04728 [GPT-5-Codex]     local frameCount = sheet.frameCount or 0
04729 [GPT-5-Codex]     if frameW <= 0 or frameH <= 0 or frameCount <= 0 then
04730 [GPT-5-Codex]         return false
04731 [GPT-5-Codex]     end
04732 [GPT-5-Codex] 
04733 [GPT-5-Codex]     local u = texCoord or 0
04734 [GPT-5-Codex]     if u ~= u or u == math.huge or u == -math.huge then
04735 [GPT-5-Codex]         return false
04736 [GPT-5-Codex]     end
04737 [GPT-5-Codex]     if u < 0 then u = 0 end
04738 [GPT-5-Codex]     if u > 0.999 then u = 0.999 end
04739 [GPT-5-Codex]     local frameIndex = math.floor(u * frameCount) + 1
04740 [GPT-5-Codex]     if frameIndex ~= frameIndex or frameIndex == math.huge or frameIndex == -math.huge then
04741 [GPT-5-Codex]         frameIndex = 1
04742 [GPT-5-Codex]     end
04743 [GPT-5-Codex]     if frameIndex < 1 then frameIndex = 1 end
04744 [GPT-5-Codex]     if frameIndex > frameCount then frameIndex = frameCount end
04745 [GPT-5-Codex] 
04746 [GPT-5-Codex]     -- Mip tiers quantize texture-column selection for stable far detail and lower aliasing.
04747 [GPT-5-Codex]     -- MIP1 uses stride-only LOD (no texel quantization) to avoid near-distance angle shimmer.
04748 [GPT-5-Codex]     local mip = mipLevel or 0
04749 [GPT-5-Codex]     if mip > 1 then
04750 [GPT-5-Codex]         local groupSize = 1
04751 [GPT-5-Codex]         if mip >= 4 then
04752 [GPT-5-Codex]             groupSize = 6
04753 [GPT-5-Codex]         elseif mip == 3 then
04754 [GPT-5-Codex]             groupSize = 4
04755 [GPT-5-Codex]         elseif mip == 2 then
04756 [GPT-5-Codex]             groupSize = 3
04757 [GPT-5-Codex]         end
04758 [GPT-5-Codex]         if groupSize > 1 and frameCount > groupSize then
04759 [GPT-5-Codex]             frameIndex = (math.floor((frameIndex - 1) / groupSize) * groupSize) + 1
04760 [GPT-5-Codex]             if frameIndex ~= frameIndex or frameIndex == math.huge or frameIndex == -math.huge then
04761 [GPT-5-Codex]                 frameIndex = 1
04762 [GPT-5-Codex]             end
04763 [GPT-5-Codex]             if frameIndex > frameCount then frameIndex = frameCount end
04764 [GPT-5-Codex]         end
04765 [GPT-5-Codex]     end
04766 [GPT-5-Codex] 
04767 [GPT-5-Codex]     local texDrawWidth = drawWidth
04768 [GPT-5-Codex]     local seamNearDist = WALL_SEAM_DISABLE_NEAR_DIST or 1.35
04769 [GPT-5-Codex]     local allowSeamOverdraw = WALL_TEX_SEAM_OVERDRAW
04770 [GPT-5-Codex]     if distToWall and distToWall <= seamNearDist then
04771 [GPT-5-Codex]         allowSeamOverdraw = false
04772 [GPT-5-Codex]     end
04773 [GPT-5-Codex]     if allowSeamOverdraw and drawWidth <= 4 then
04774 [GPT-5-Codex]         local seamPx = WALL_TEX_SEAM_PIXELS or 1
04775 [GPT-5-Codex]         if seamPx < 0 then seamPx = 0 end
04776 [GPT-5-Codex]         if seamPx > 2 then seamPx = 2 end
04777 [GPT-5-Codex]         local roomRight = 240 - (sx + texDrawWidth)
04778 [GPT-5-Codex]         if roomRight > 0 and seamPx > 0 then
04779 [GPT-5-Codex]             if seamPx > roomRight then seamPx = roomRight end
04780 [GPT-5-Codex]             texDrawWidth = texDrawWidth + seamPx
04781 [GPT-5-Codex]         end
04782 [GPT-5-Codex]     end
04783 [GPT-5-Codex] 
04784 [GPT-5-Codex]     local scaleX = texDrawWidth / frameW
04785 [GPT-5-Codex]     local scaleY = (expScaleYLut and expScaleYLut[wallH]) or (wallH / frameH)
04786 [GPT-5-Codex]     if scaleX <= 0 or scaleY <= 0 or scaleY ~= scaleY or scaleY == math.huge or scaleY == -math.huge then
04787 [GPT-5-Codex]         return false
04788 [GPT-5-Codex]     end
04789 [GPT-5-Codex]     local perfSample = (DEBUG_PERF_MONITOR == true) and (PERF_MONITOR_ACTIVE_SAMPLE == true)
04790 [GPT-5-Codex]     local trackCounters = (DEBUG_PERF_MONITOR == true)
04791 [GPT-5-Codex]     local canTime = perfSample and vmupro and vmupro.system and vmupro.system.getTimeUs
04792 [GPT-5-Codex]     local t0
04793 [GPT-5-Codex]     if canTime then
04794 [GPT-5-Codex]         t0 = vmupro.system.getTimeUs()
04795 [GPT-5-Codex]     end
04796 [GPT-5-Codex]     vmupro.sprite.drawFrameScaled(sheet, frameIndex, sx, y1, scaleX, scaleY, vmupro.sprite.kImageUnflipped)
04797 [GPT-5-Codex]     if canTime and t0 then
04798 [GPT-5-Codex]         local t1 = vmupro.system.getTimeUs()
04799 [GPT-5-Codex]         PERF_MONITOR_SAMPLE_WALL_US = (PERF_MONITOR_SAMPLE_WALL_US or 0) + (t1 - t0)
04800 [GPT-5-Codex]     end
04801 [GPT-5-Codex] 
04802 [GPT-5-Codex]     if not DEBUG_DISABLE_FOG and distToWall then
04803 [GPT-5-Codex]         local x2 = sx + texDrawWidth - 1
04804 [GPT-5-Codex]         if x2 > 239 then x2 = 239 end
04805 [GPT-5-Codex]         if y1 < 0 then y1 = 0 end
04806 [GPT-5-Codex]         if y2 > 239 then y2 = 239 end
04807 [GPT-5-Codex]         local fogAlpha = getFogQuantizedFactor(distToWall)
04808 [GPT-5-Codex]         if fogAlpha > 0 then
04809 [GPT-5-Codex]             if trackCounters then
04810 [GPT-5-Codex]                 PERF_MONITOR_FOG_COLS = (PERF_MONITOR_FOG_COLS or 0) + drawWidth
04811 [GPT-5-Codex]             end
04812 [GPT-5-Codex]             if canTime then
04813 [GPT-5-Codex]                 t0 = vmupro.system.getTimeUs()
04814 [GPT-5-Codex]             end
04815 [GPT-5-Codex]             drawFogOverlayArea(sx, y1, x2, y2, fogAlpha)
04816 [GPT-5-Codex]             if canTime and t0 then
04817 [GPT-5-Codex]                 local t1 = vmupro.system.getTimeUs()
04818 [GPT-5-Codex]                 PERF_MONITOR_SAMPLE_FOG_US = (PERF_MONITOR_SAMPLE_FOG_US or 0) + (t1 - t0)
04819 [GPT-5-Codex]             end
04820 [GPT-5-Codex]         end
04821 [GPT-5-Codex]     end
04822 [GPT-5-Codex]     return true
04823 [GPT-5-Codex] end
04824 [GPT-5-Codex] 
04825 [GPT-5-Codex] expRayOffsets = expRayOffsets or {}
04826 [GPT-5-Codex] expTablesReady = expTablesReady or false
04827 [GPT-5-Codex] rayDirXFix = rayDirXFix or {}
04828 [GPT-5-Codex] rayDirYFix = rayDirYFix or {}
04829 [GPT-5-Codex] rayDirCos = rayDirCos or {}
04830 [GPT-5-Codex] rayDirSin = rayDirSin or {}
04831 [GPT-5-Codex] invRayDirXFix = invRayDirXFix or {}
04832 [GPT-5-Codex] invRayDirYFix = invRayDirYFix or {}
04833 [GPT-5-Codex] deltaDistXFix = deltaDistXFix or {}
04834 [GPT-5-Codex] deltaDistYFix = deltaDistYFix or {}
04835 [GPT-5-Codex] EXP_FIXED_DIR_SUBDIV = 32
04836 [GPT-5-Codex] EXP_FIXED_DIR_STEPS = 64 * EXP_FIXED_DIR_SUBDIV
04837 [GPT-5-Codex] local EXP_FIX_TILE = 256
04838 [GPT-5-Codex] local EXP_FIX_DIST = 65536
04839 [GPT-5-Codex] EXP_RAYCOLS = 24
04840 [GPT-5-Codex] EXP_COLW = 10
04841 [GPT-5-Codex] EXP_MAX_STEPS = 32
04842 [GPT-5-Codex] EXP_MAX_DIST = 80
04843 [GPT-5-Codex] EXP_RADIUS = 20
04844 [GPT-5-Codex] EXP_BUCKETS = 8
04845 [GPT-5-Codex] EXP_TEX_MAX_DIST = EXP_TEX_MAX_DIST or DRAW_DIST_PRESETS[DRAW_DIST_INDEX]
04846 [GPT-5-Codex] EXP_VIEW_DIST = EXP_VIEW_DIST or EXP_TEX_MAX_DIST
04847 [GPT-5-Codex] HYBRID_TEX_MAX_H = VIEWPORT_H
04848 [GPT-5-Codex] USE_FIXED_RAYCAST = false
04849 [GPT-5-Codex] DEBUG_FORCE_FLOAT_RAYCAST = false
04850 [GPT-5-Codex] EXP_DIST_LUT_SIZE = 256
04851 [GPT-5-Codex] expHeightLut = expHeightLut or {}
04852 [GPT-5-Codex] expScaleYLut = expScaleYLut or {}
04853 [GPT-5-Codex] expHeightLutReady = expHeightLutReady or false
04854 [GPT-5-Codex] 
04855 [GPT-5-Codex] local function ensureExpTables()
04856 [GPT-5-Codex]     if expTablesReady then return end
04857 [GPT-5-Codex]     local dirSteps = EXP_FIXED_DIR_STEPS or 2048
04858 [GPT-5-Codex]     local twoPi = (renderCfg and renderCfg.twoPi) or 6.28318
04859 [GPT-5-Codex]     for i = 0, dirSteps - 1 do
04860 [GPT-5-Codex]         local angle = (i * twoPi) / dirSteps
04861 [GPT-5-Codex]         local cx = math.cos(angle)
04862 [GPT-5-Codex]         local sy = math.sin(angle)
04863 [GPT-5-Codex]         rayDirCos[i] = cx
04864 [GPT-5-Codex]         rayDirSin[i] = sy
04865 [GPT-5-Codex]         rayDirXFix[i] = math.floor(cx * 256)
04866 [GPT-5-Codex]         rayDirYFix[i] = math.floor(sy * 256)
04867 [GPT-5-Codex]         if math.abs(cx) < 0.0000001 then
04868 [GPT-5-Codex]             invRayDirXFix[i] = 0x7FFFFFFF
04869 [GPT-5-Codex]         else
04870 [GPT-5-Codex]             invRayDirXFix[i] = math.floor((1 / cx) * 65536)
04871 [GPT-5-Codex]         end
04872 [GPT-5-Codex]         if math.abs(sy) < 0.0000001 then
04873 [GPT-5-Codex]             invRayDirYFix[i] = 0x7FFFFFFF
04874 [GPT-5-Codex]         else
04875 [GPT-5-Codex]             invRayDirYFix[i] = math.floor((1 / sy) * 65536)
04876 [GPT-5-Codex]         end
04877 [GPT-5-Codex]         deltaDistXFix[i] = math.abs(invRayDirXFix[i])
04878 [GPT-5-Codex]         deltaDistYFix[i] = math.abs(invRayDirYFix[i])
04879 [GPT-5-Codex]     end
04880 [GPT-5-Codex]     expTablesReady = true
04881 [GPT-5-Codex] end
04882 [GPT-5-Codex] 
04883 [GPT-5-Codex] local function ensureExpHeightLut()
04884 [GPT-5-Codex]     if expHeightLutReady then return end
04885 [GPT-5-Codex]     local wallScale = VIEWPORT_H - 20
04886 [GPT-5-Codex]     local size = EXP_DIST_LUT_SIZE or 256
04887 [GPT-5-Codex]     local maxDist = EXP_MAX_DIST or 16
04888 [GPT-5-Codex]     for i = 1, size do
04889 [GPT-5-Codex]         local dist = (i / size) * maxDist
04890 [GPT-5-Codex]         if dist < 0.4 then dist = 0.4 end
04891 [GPT-5-Codex]         expHeightLut[i] = math.floor(wallScale / dist)
04892 [GPT-5-Codex]     end
04893 [GPT-5-Codex]     for h = 0, VIEWPORT_H do
04894 [GPT-5-Codex]         expScaleYLut[h] = h / 128
04895 [GPT-5-Codex]     end
04896 [GPT-5-Codex]     expHeightLutReady = true
04897 [GPT-5-Codex] end
04898 [GPT-5-Codex] 
04899 [GPT-5-Codex] local function getExpRayOffsets(rayCols)
04900 [GPT-5-Codex]     local key = tostring(rayCols)
04901 [GPT-5-Codex]     local cached = expRayOffsets[key]
04902 [GPT-5-Codex]     if cached then return cached end
04903 [GPT-5-Codex]     local offsets = {}
04904 [GPT-5-Codex]     if rayCols <= 1 then
04905 [GPT-5-Codex]         offsets[1] = 0
04906 [GPT-5-Codex]     else
04907 [GPT-5-Codex]         local subdiv = EXP_FIXED_DIR_SUBDIV or 32
04908 [GPT-5-Codex]         local fovUnits = (renderCfg.fovSteps or 9) * subdiv
04909 [GPT-5-Codex]         local half = fovUnits / 2
04910 [GPT-5-Codex]         for x = 0, rayCols - 1 do
04911 [GPT-5-Codex]             local t = x / (rayCols - 1)
04912 [GPT-5-Codex]             local off = -half + t * fovUnits
04913 [GPT-5-Codex]             if off >= 0 then
04914 [GPT-5-Codex]                 offsets[x + 1] = math.floor(off + 0.5)
04915 [GPT-5-Codex]             else
04916 [GPT-5-Codex]                 offsets[x + 1] = math.ceil(off - 0.5)
04917 [GPT-5-Codex]             end
04918 [GPT-5-Codex]         end
04919 [GPT-5-Codex]     end
04920 [GPT-5-Codex]     expRayOffsets[key] = offsets
04921 [GPT-5-Codex]     return offsets
04922 [GPT-5-Codex] end
04923 [GPT-5-Codex] 
04924 [GPT-5-Codex] local function getStartSolidRayFallback(pxVal, pyVal, mapX, mapY, startTile)
04925 [GPT-5-Codex]     local fx = pxVal - mapX
04926 [GPT-5-Codex]     local fy = pyVal - mapY
04927 [GPT-5-Codex]     if fx < 0 then fx = 0 elseif fx > 0.999 then fx = 0.999 end
04928 [GPT-5-Codex]     if fy < 0 then fy = 0 elseif fy > 0.999 then fy = 0.999 end
04929 [GPT-5-Codex] 
04930 [GPT-5-Codex]     local best = fx
04931 [GPT-5-Codex]     local side = 0
04932 [GPT-5-Codex]     local texCoord = fy
04933 [GPT-5-Codex] 
04934 [GPT-5-Codex]     local rightDist = 1.0 - fx
04935 [GPT-5-Codex]     if rightDist < best then
04936 [GPT-5-Codex]         best = rightDist
04937 [GPT-5-Codex]         side = 0
04938 [GPT-5-Codex]         texCoord = fy
04939 [GPT-5-Codex]     end
04940 [GPT-5-Codex] 
04941 [GPT-5-Codex]     local topDist = fy
04942 [GPT-5-Codex]     if topDist < best then
04943 [GPT-5-Codex]         best = topDist
04944 [GPT-5-Codex]         side = 1
04945 [GPT-5-Codex]         texCoord = fx
04946 [GPT-5-Codex]     end
04947 [GPT-5-Codex] 
04948 [GPT-5-Codex]     local bottomDist = 1.0 - fy
04949 [GPT-5-Codex]     if bottomDist < best then
04950 [GPT-5-Codex]         side = 1
04951 [GPT-5-Codex]         texCoord = fx
04952 [GPT-5-Codex]     end
04953 [GPT-5-Codex] 
04954 [GPT-5-Codex]     if texCoord < 0.001 then texCoord = 0.001 end
04955 [GPT-5-Codex]     if texCoord > 0.998 then texCoord = 0.998 end
04956 [GPT-5-Codex]     PERF_MONITOR_RAY_START_SOLID = (PERF_MONITOR_RAY_START_SOLID or 0) + 1
04957 [GPT-5-Codex]     return getPlayerRenderNearClipDist(), startTile, side, texCoord, true
04958 [GPT-5-Codex] end
04959 [GPT-5-Codex] 
04960 [GPT-5-Codex] local function expCastRayFixed(rayDir, maxDist)
04961 [GPT-5-Codex]     ensureExpTables()
04962 [GPT-5-Codex]     local posXFix = math.floor(px * EXP_FIX_TILE)
04963 [GPT-5-Codex]     local posYFix = math.floor(py * EXP_FIX_TILE)
04964 [GPT-5-Codex]     local mapX = math.floor(posXFix / EXP_FIX_TILE)
04965 [GPT-5-Codex]     local mapY = math.floor(posYFix / EXP_FIX_TILE)
04966 [GPT-5-Codex]     local rayMaxDist = maxDist or 16
04967 [GPT-5-Codex]     if rayMaxDist < 0.25 then
04968 [GPT-5-Codex]         rayMaxDist = 0.25
04969 [GPT-5-Codex]     end
04970 [GPT-5-Codex]     local rayMaxDistFix = math.floor(rayMaxDist * EXP_FIX_DIST)
04971 [GPT-5-Codex] 
04972 [GPT-5-Codex]     -- Guard against rare movement penetration: stabilize rendering when inside a wall cell.
04973 [GPT-5-Codex]     if mapX >= 0 and mapX < 16 and mapY >= 0 and mapY < 16 then
04974 [GPT-5-Codex]         local startTile = map and map[mapY + 1] and map[mapY + 1][mapX + 1] or 0
04975 [GPT-5-Codex]         if startTile and startTile > 0 then
04976 [GPT-5-Codex]             return getStartSolidRayFallback(px, py, mapX, mapY, startTile)
04977 [GPT-5-Codex]         end
04978 [GPT-5-Codex]     end
04979 [GPT-5-Codex] 
04980 [GPT-5-Codex]     local dirXFix = rayDirXFix[rayDir] or 0
04981 [GPT-5-Codex]     local dirYFix = rayDirYFix[rayDir] or 0
04982 [GPT-5-Codex]     local stepX = (dirXFix < 0) and -1 or 1
04983 [GPT-5-Codex]     local stepY = (dirYFix < 0) and -1 or 1
04984 [GPT-5-Codex] 
04985 [GPT-5-Codex]     local deltaX = deltaDistXFix[rayDir] or 0x7FFFFFFF
04986 [GPT-5-Codex]     local deltaY = deltaDistYFix[rayDir] or 0x7FFFFFFF
04987 [GPT-5-Codex] 
04988 [GPT-5-Codex]     local nextXFix = (mapX + (stepX > 0 and 1 or 0)) * EXP_FIX_TILE
04989 [GPT-5-Codex]     local nextYFix = (mapY + (stepY > 0 and 1 or 0)) * EXP_FIX_TILE
04990 [GPT-5-Codex]     local distToNextX = nextXFix - posXFix
04991 [GPT-5-Codex]     local distToNextY = nextYFix - posYFix
04992 [GPT-5-Codex]     if distToNextX < 0 then distToNextX = -distToNextX end
04993 [GPT-5-Codex]     if distToNextY < 0 then distToNextY = -distToNextY end
04994 [GPT-5-Codex] 
04995 [GPT-5-Codex]     local sideDistX = math.floor((distToNextX * deltaX) / EXP_FIX_TILE)
04996 [GPT-5-Codex]     local sideDistY = math.floor((distToNextY * deltaY) / EXP_FIX_TILE)
04997 [GPT-5-Codex] 
04998 [GPT-5-Codex]     local side = 0
04999 [GPT-5-Codex]     local wtype = 1
05000 [GPT-5-Codex]     local hit = false
05001 [GPT-5-Codex]     local maxSteps = EXP_MAX_STEPS or 8
05002 [GPT-5-Codex]     for _ = 1, maxSteps do
05003 [GPT-5-Codex]         local nextDist = sideDistX
05004 [GPT-5-Codex]         if sideDistY < nextDist then nextDist = sideDistY end
05005 [GPT-5-Codex]         if nextDist > rayMaxDistFix then
05006 [GPT-5-Codex]             break
05007 [GPT-5-Codex]         end
05008 [GPT-5-Codex]         if sideDistX < sideDistY then
05009 [GPT-5-Codex]             sideDistX = sideDistX + deltaX
05010 [GPT-5-Codex]             mapX = mapX + stepX
05011 [GPT-5-Codex]             side = 0
05012 [GPT-5-Codex]         else
05013 [GPT-5-Codex]             sideDistY = sideDistY + deltaY
05014 [GPT-5-Codex]             mapY = mapY + stepY
05015 [GPT-5-Codex]             side = 1
05016 [GPT-5-Codex]         end
05017 [GPT-5-Codex]         if mapX < 0 or mapX >= 16 or mapY < 0 or mapY >= 16 then
05018 [GPT-5-Codex]             break
05019 [GPT-5-Codex]         end
05020 [GPT-5-Codex]         wtype = map[mapY + 1][mapX + 1]
05021 [GPT-5-Codex]         if wtype > 0 then
05022 [GPT-5-Codex]             hit = true
05023 [GPT-5-Codex]             break
05024 [GPT-5-Codex]         end
05025 [GPT-5-Codex]     end
05026 [GPT-5-Codex]     if not hit then
05027 [GPT-5-Codex]         return rayMaxDist, 1, 0, 0, false
05028 [GPT-5-Codex]     end
05029 [GPT-5-Codex] 
05030 [GPT-5-Codex]     local perpFix
05031 [GPT-5-Codex]     if side == 0 then
05032 [GPT-5-Codex]         local numFix = ((mapX * EXP_FIX_TILE) - posXFix + ((stepX == -1) and EXP_FIX_TILE or 0))
05033 [GPT-5-Codex]         perpFix = math.floor((numFix * (invRayDirXFix[rayDir] or 0)) / EXP_FIX_TILE)
05034 [GPT-5-Codex]     else
05035 [GPT-5-Codex]         local numFix = ((mapY * EXP_FIX_TILE) - posYFix + ((stepY == -1) and EXP_FIX_TILE or 0))
05036 [GPT-5-Codex]         perpFix = math.floor((numFix * (invRayDirYFix[rayDir] or 0)) / EXP_FIX_TILE)
05037 [GPT-5-Codex]     end
05038 [GPT-5-Codex]     if perpFix < 1 then perpFix = 1 end
05039 [GPT-5-Codex] 
05040 [GPT-5-Codex]     local texFix
05041 [GPT-5-Codex]     if side == 0 then
05042 [GPT-5-Codex]         local texCalc = posYFix + math.floor((perpFix * dirYFix) / EXP_FIX_DIST)
05043 [GPT-5-Codex]         texFix = texCalc % EXP_FIX_TILE
05044 [GPT-5-Codex]     else
05045 [GPT-5-Codex]         local texCalc = posXFix + math.floor((perpFix * dirXFix) / EXP_FIX_DIST)
05046 [GPT-5-Codex]         texFix = texCalc % EXP_FIX_TILE
05047 [GPT-5-Codex]     end
05048 [GPT-5-Codex]     local texCoord = texFix / EXP_FIX_TILE
05049 [GPT-5-Codex]     local dist = perpFix / EXP_FIX_DIST
05050 [GPT-5-Codex]     if dist > rayMaxDist then
05051 [GPT-5-Codex]         return rayMaxDist, 1, 0, 0, false
05052 [GPT-5-Codex]     end
05053 [GPT-5-Codex]     return dist, wtype, side, texCoord, true
05054 [GPT-5-Codex] end
05055 [GPT-5-Codex] 
05056 [GPT-5-Codex] local expDepthBuf = {}
05057 [GPT-5-Codex] local function renderWallsExperimentalHybrid()
05058 [GPT-5-Codex]     -- Stability-first EXP-H: use one raycast projection model at all distances.
05059 [GPT-5-Codex]     -- This prevents wall seams/shape shifts when draw distance changes.
05060 [GPT-5-Codex]     local hybridViewDist = EXP_VIEW_DIST or (EXP_TEX_MAX_DIST or 8.0)
05061 [GPT-5-Codex]     local texView = EXP_TEX_MAX_DIST or hybridViewDist
05062 [GPT-5-Codex]     local fogView = FOG_END or texView
05063 [GPT-5-Codex]     if fogView < 0.5 then fogView = 0.5 end
05064 [GPT-5-Codex]     local rayTraceDist = texView
05065 [GPT-5-Codex]     if rayTraceDist < 0.5 then rayTraceDist = 0.5 end
05066 [GPT-5-Codex] 
05067 [GPT-5-Codex]     local fovRad = renderCfg.fovSteps * (renderCfg.twoPi / 64)
05068 [GPT-5-Codex]     local playerDir = pdir % 64
05069 [GPT-5-Codex]     local playerAngle = playerDir * (renderCfg.twoPi / 64)
05070 [GPT-5-Codex]     local playerCos = math.cos(playerAngle)
05071 [GPT-5-Codex]     local playerSin = math.sin(playerAngle)
05072 [GPT-5-Codex]     local rayCols = 60
05073 [GPT-5-Codex]     local colW = 4
05074 [GPT-5-Codex]     local basePresetIdx = RAY_PRESET_INDEX or 1
05075 [GPT-5-Codex]     local effectivePresetIdx = getEffectiveRayPresetIndex(basePresetIdx)
05076 [GPT-5-Codex]     local preset = RAY_PRESETS and RAY_PRESETS[effectivePresetIdx] or nil
05077 [GPT-5-Codex]     if preset then
05078 [GPT-5-Codex]         rayCols = preset.rays or rayCols
05079 [GPT-5-Codex]         colW = preset.colW or colW
05080 [GPT-5-Codex]     elseif LOW_RES_WALLS then
05081 [GPT-5-Codex]         if LOW_RES_MODE == "fast" then
05082 [GPT-5-Codex]             rayCols = 40
05083 [GPT-5-Codex]             colW = 6
05084 [GPT-5-Codex]         else
05085 [GPT-5-Codex]             rayCols = 60
05086 [GPT-5-Codex]             colW = 4
05087 [GPT-5-Codex]         end
05088 [GPT-5-Codex]     end
05089 [GPT-5-Codex]     local useFixedRaycast = (USE_FIXED_RAYCAST == true) and (DEBUG_FORCE_FLOAT_RAYCAST ~= true)
05090 [GPT-5-Codex]     local perfSample = (DEBUG_PERF_MONITOR == true) and (PERF_MONITOR_ACTIVE_SAMPLE == true)
05091 [GPT-5-Codex]     local trackCounters = (DEBUG_PERF_MONITOR == true)
05092 [GPT-5-Codex]     local canTime = perfSample and vmupro and vmupro.system and vmupro.system.getTimeUs
05093 [GPT-5-Codex]     local rayOffsets = nil
05094 [GPT-5-Codex]     local playerDirFix = 0
05095 [GPT-5-Codex]     local rayStep = 0
05096 [GPT-5-Codex]     local stepCos1, stepCos2, stepCos3, stepCos4
05097 [GPT-5-Codex]     local stepSin1, stepSin2, stepSin3, stepSin4
05098 [GPT-5-Codex]     local rayCos = 0
05099 [GPT-5-Codex]     local raySin = 0
05100 [GPT-5-Codex]     if useFixedRaycast then
05101 [GPT-5-Codex]         ensureExpTables()
05102 [GPT-5-Codex]         playerDirFix = (playerDir % 64) * (EXP_FIXED_DIR_SUBDIV or 32)
05103 [GPT-5-Codex]         rayOffsets = getExpRayOffsets(rayCols)
05104 [GPT-5-Codex]     else
05105 [GPT-5-Codex]         local baseAngle = playerAngle - (fovRad / 2)
05106 [GPT-5-Codex]         rayStep = fovRad / rayCols
05107 [GPT-5-Codex]         stepCos1 = math.cos(rayStep)
05108 [GPT-5-Codex]         stepCos2 = math.cos(rayStep * 2)
05109 [GPT-5-Codex]         stepCos3 = math.cos(rayStep * 3)
05110 [GPT-5-Codex]         stepCos4 = math.cos(rayStep * 4)
05111 [GPT-5-Codex]         stepSin1 = math.sin(rayStep)
05112 [GPT-5-Codex]         stepSin2 = math.sin(rayStep * 2)
05113 [GPT-5-Codex]         stepSin3 = math.sin(rayStep * 3)
05114 [GPT-5-Codex]         stepSin4 = math.sin(rayStep * 4)
05115 [GPT-5-Codex]         rayCos = math.cos(baseAngle)
05116 [GPT-5-Codex]         raySin = math.sin(baseAngle)
05117 [GPT-5-Codex]     end
05118 [GPT-5-Codex]     perfMonitorSetRayInfo(basePresetIdx, effectivePresetIdx, useFixedRaycast)
05119 [GPT-5-Codex]     local wallContactActive = (PLAYER_WALL_CONTACT_FRAMES or 0) > 0
05120 [GPT-5-Codex]     if wallContactActive then
05121 [GPT-5-Codex]         PLAYER_WALL_CONTACT_FRAMES = (PLAYER_WALL_CONTACT_FRAMES or 0) - 1
05122 [GPT-5-Codex]     end
05123 [GPT-5-Codex]     local stableProjection = (WALL_PROJECTION_MODE == "stable") or wallContactActive
05124 [GPT-5-Codex]     local nearStabilityDist = WALL_NEAR_STABILITY_DIST or 1.85
05125 [GPT-5-Codex] 
05126 [GPT-5-Codex]     -- Ray-LOD derives from preset steps and keeps mip tiers independent where possible.
05127 [GPT-5-Codex]     local lodStride1, lodStride2, lodStride3, lodStride4 = 1, 2, 3, 4
05128 [GPT-5-Codex]     if preset and RAY_PRESETS and #RAY_PRESETS > 0 then
05129 [GPT-5-Codex]         local baseIdx = effectivePresetIdx
05130 [GPT-5-Codex]         local baseRays = preset.rays or rayCols
05131 [GPT-5-Codex]         local function strideFromPresetStep(stepDown)
05132 [GPT-5-Codex]             local targetIdx = baseIdx - stepDown
05133 [GPT-5-Codex]             if targetIdx < 1 then targetIdx = 1 end
05134 [GPT-5-Codex]             local target = RAY_PRESETS[targetIdx]
05135 [GPT-5-Codex]             local targetRays = target and target.rays or baseRays
05136 [GPT-5-Codex]             if not targetRays or targetRays < 1 then
05137 [GPT-5-Codex]                 return 1
05138 [GPT-5-Codex]             end
05139 [GPT-5-Codex]             local s = math.ceil(baseRays / targetRays)
05140 [GPT-5-Codex]             if s < 1 then s = 1 end
05141 [GPT-5-Codex]             return s
05142 [GPT-5-Codex]         end
05143 [GPT-5-Codex]         local maxStride = 6
05144 [GPT-5-Codex]         local minFarRays = 3
05145 [GPT-5-Codex]         if baseRays and baseRays > 0 then
05146 [GPT-5-Codex]             maxStride = math.floor(baseRays / minFarRays)
05147 [GPT-5-Codex]             if maxStride < 1 then maxStride = 1 end
05148 [GPT-5-Codex]             if maxStride > 6 then maxStride = 6 end
05149 [GPT-5-Codex]         end
05150 [GPT-5-Codex]         lodStride1 = strideFromPresetStep(1)
05151 [GPT-5-Codex]         lodStride2 = math.max(strideFromPresetStep(2), lodStride1 + 1)
05152 [GPT-5-Codex]         lodStride3 = math.max(strideFromPresetStep(3), lodStride2 + 1)
05153 [GPT-5-Codex]         lodStride4 = math.max(strideFromPresetStep(4), lodStride3 + 1)
05154 [GPT-5-Codex] 
05155 [GPT-5-Codex]         -- Keep tiers independent and progressively more aggressive.
05156 [GPT-5-Codex]         if maxStride >= 2 and lodStride1 < 2 then lodStride1 = 2 end
05157 [GPT-5-Codex]         if maxStride >= 3 and lodStride2 < 3 then lodStride2 = 3 end
05158 [GPT-5-Codex]         if maxStride >= 4 and lodStride3 < 4 then lodStride3 = 4 end
05159 [GPT-5-Codex]         if maxStride >= 5 and lodStride4 < 5 then lodStride4 = 5 end
05160 [GPT-5-Codex] 
05161 [GPT-5-Codex]         if lodStride1 > maxStride then lodStride1 = maxStride end
05162 [GPT-5-Codex]         if lodStride2 > maxStride then lodStride2 = maxStride end
05163 [GPT-5-Codex]         if lodStride3 > maxStride then lodStride3 = maxStride end
05164 [GPT-5-Codex]         if lodStride4 > maxStride then lodStride4 = maxStride end
05165 [GPT-5-Codex]         if lodStride2 < lodStride1 then lodStride2 = lodStride1 end
05166 [GPT-5-Codex]         if lodStride3 < lodStride2 then lodStride3 = lodStride2 end
05167 [GPT-5-Codex]         if lodStride4 < lodStride3 then lodStride4 = lodStride3 end
05168 [GPT-5-Codex]     end
05169 [GPT-5-Codex] 
05170 [GPT-5-Codex]     -- Mip thresholds are evaluated once per frame so each tier is independent and cheap in the hot ray loop.
05171 [GPT-5-Codex]     -- Order is still strictly monotonic for deterministic tier transitions.
05172 [GPT-5-Codex]     local mip1Thresh = WALL_MIPMAP_DIST1 or 4.0
05173 [GPT-5-Codex]     local mip2Thresh = WALL_MIPMAP_DIST2 or (mip1Thresh + 2.0)
05174 [GPT-5-Codex]     local mip3Thresh = WALL_MIPMAP_DIST3 or (mip2Thresh + 2.0)
05175 [GPT-5-Codex]     local mip4Thresh = WALL_MIPMAP_DIST4 or (mip3Thresh + 2.0)
05176 [GPT-5-Codex]     if mip2Thresh <= mip1Thresh then mip2Thresh = mip1Thresh + 0.1 end
05177 [GPT-5-Codex]     if mip3Thresh <= mip2Thresh then mip3Thresh = mip2Thresh + 0.1 end
05178 [GPT-5-Codex]     if mip4Thresh <= mip3Thresh then mip4Thresh = mip3Thresh + 0.1 end
05179 [GPT-5-Codex] 
05180 [GPT-5-Codex]     local x = 0
05181 [GPT-5-Codex]     while x < rayCols do
05182 [GPT-5-Codex]         local rayStride = 1
05183 [GPT-5-Codex]         local mipLevel = 0
05184 [GPT-5-Codex]         local castCos, castSin
05185 [GPT-5-Codex]         local dist, wtype, side, texCoord, rayHit
05186 [GPT-5-Codex]         local castT0
05187 [GPT-5-Codex]         if canTime then
05188 [GPT-5-Codex]             castT0 = vmupro.system.getTimeUs()
05189 [GPT-5-Codex]         end
05190 [GPT-5-Codex]         if useFixedRaycast then
05191 [GPT-5-Codex]             local rayOff = (rayOffsets and rayOffsets[x + 1]) or 0
05192 [GPT-5-Codex]             local rayDir = (playerDirFix + rayOff) % (EXP_FIXED_DIR_STEPS or 2048)
05193 [GPT-5-Codex]             castCos = rayDirCos[rayDir] or playerCos
05194 [GPT-5-Codex]             castSin = rayDirSin[rayDir] or playerSin
05195 [GPT-5-Codex]             dist, wtype, side, texCoord, rayHit = expCastRayFixed(rayDir, rayTraceDist)
05196 [GPT-5-Codex]         else
05197 [GPT-5-Codex]             castCos = rayCos
05198 [GPT-5-Codex]             castSin = raySin
05199 [GPT-5-Codex]             dist, wtype, side, texCoord, rayHit = castRay(castCos, castSin, rayTraceDist)
05200 [GPT-5-Codex]         end
05201 [GPT-5-Codex]         if canTime and castT0 then
05202 [GPT-5-Codex]             local castT1 = vmupro.system.getTimeUs()
05203 [GPT-5-Codex]             PERF_MONITOR_SAMPLE_RAYCAST_US = (PERF_MONITOR_SAMPLE_RAYCAST_US or 0) + (castT1 - castT0)
05204 [GPT-5-Codex]         end
05205 [GPT-5-Codex]         local fixedDist = dist * (castCos * playerCos + castSin * playerSin)
05206 [GPT-5-Codex]         local nearClipDist = getPlayerRenderNearClipDist()
05207 [GPT-5-Codex]         if fixedDist < nearClipDist then fixedDist = nearClipDist end
05208 [GPT-5-Codex]         if not rayHit then
05209 [GPT-5-Codex]             fixedDist = fogView
05210 [GPT-5-Codex]             if fixedDist < texView then fixedDist = texView end
05211 [GPT-5-Codex]             if fixedDist > hybridViewDist then fixedDist = hybridViewDist end
05212 [GPT-5-Codex]         end
05213 [GPT-5-Codex] 
05214 [GPT-5-Codex]         local nearForce = rayHit and (
05215 [GPT-5-Codex]             fixedDist < (MIP_NEAR_FORCE_DIST or 1.35)
05216 [GPT-5-Codex]             or (wallContactActive and fixedDist < nearStabilityDist)
05217 [GPT-5-Codex]         )
05218 [GPT-5-Codex]         if WALL_MIPMAP_ENABLED and MIP_LOD_ENABLED and not nearForce then
05219 [GPT-5-Codex]             if fixedDist >= mip4Thresh then
05220 [GPT-5-Codex]                 mipLevel = 4
05221 [GPT-5-Codex]             elseif fixedDist >= mip3Thresh then
05222 [GPT-5-Codex]                 mipLevel = 3
05223 [GPT-5-Codex]             elseif fixedDist >= mip2Thresh then
05224 [GPT-5-Codex]                 mipLevel = 2
05225 [GPT-5-Codex]             elseif fixedDist >= mip1Thresh then
05226 [GPT-5-Codex]                 mipLevel = 1
05227 [GPT-5-Codex]             end
05228 [GPT-5-Codex]         end
05229 [GPT-5-Codex]         if WALL_MIPMAP_ENABLED and MIP_LOD_ENABLED and not nearForce and not stableProjection then
05230 [GPT-5-Codex]             if mipLevel >= 4 then
05231 [GPT-5-Codex]                 rayStride = lodStride4
05232 [GPT-5-Codex]             elseif mipLevel == 3 then
05233 [GPT-5-Codex]                 rayStride = lodStride3
05234 [GPT-5-Codex]             elseif mipLevel == 2 then
05235 [GPT-5-Codex]                 rayStride = lodStride2
05236 [GPT-5-Codex]             elseif mipLevel == 1 then
05237 [GPT-5-Codex]                 rayStride = lodStride1
05238 [GPT-5-Codex]             end
05239 [GPT-5-Codex]         end
05240 [GPT-5-Codex] 
05241 [GPT-5-Codex]         local remaining = rayCols - x
05242 [GPT-5-Codex]         if rayStride > remaining then
05243 [GPT-5-Codex]             rayStride = remaining
05244 [GPT-5-Codex]         end
05245 [GPT-5-Codex]         if rayStride < 1 then
05246 [GPT-5-Codex]             rayStride = 1
05247 [GPT-5-Codex]         end
05248 [GPT-5-Codex] 
05249 [GPT-5-Codex]         local drawColW = colW
05250 [GPT-5-Codex]         if not stableProjection then
05251 [GPT-5-Codex]             drawColW = colW * rayStride
05252 [GPT-5-Codex]         end
05253 [GPT-5-Codex]         local sx = x * colW
05254 [GPT-5-Codex]         if sx <= 239 then
05255 [GPT-5-Codex]             local ex = sx + drawColW - 1
05256 [GPT-5-Codex]             if ex > 239 then ex = 239 end
05257 [GPT-5-Codex]             local spanW = (ex - sx) + 1
05258 [GPT-5-Codex] 
05259 [GPT-5-Codex]             if rayHit and fixedDist <= hybridViewDist then
05260 [GPT-5-Codex]                 if trackCounters then
05261 [GPT-5-Codex]                     PERF_MONITOR_WALL_COLS_TOTAL = (PERF_MONITOR_WALL_COLS_TOTAL or 0) + spanW
05262 [GPT-5-Codex]                     if mipLevel <= 0 then
05263 [GPT-5-Codex]                         PERF_MONITOR_MIP_COLS_0 = (PERF_MONITOR_MIP_COLS_0 or 0) + spanW
05264 [GPT-5-Codex]                     elseif mipLevel == 1 then
05265 [GPT-5-Codex]                         PERF_MONITOR_MIP_COLS_1 = (PERF_MONITOR_MIP_COLS_1 or 0) + spanW
05266 [GPT-5-Codex]                     elseif mipLevel == 2 then
05267 [GPT-5-Codex]                         PERF_MONITOR_MIP_COLS_2 = (PERF_MONITOR_MIP_COLS_2 or 0) + spanW
05268 [GPT-5-Codex]                     elseif mipLevel == 3 then
05269 [GPT-5-Codex]                         PERF_MONITOR_MIP_COLS_3 = (PERF_MONITOR_MIP_COLS_3 or 0) + spanW
05270 [GPT-5-Codex]                     else
05271 [GPT-5-Codex]                         PERF_MONITOR_MIP_COLS_4 = (PERF_MONITOR_MIP_COLS_4 or 0) + spanW
05272 [GPT-5-Codex]                     end
05273 [GPT-5-Codex]                 end
05274 [GPT-5-Codex]                 local wallScale = VIEWPORT_H - 20
05275 [GPT-5-Codex]                 local h = math.floor(wallScale / fixedDist)
05276 [GPT-5-Codex]                 if h > VIEWPORT_H then h = VIEWPORT_H end
05277 [GPT-5-Codex]                 local y1 = HORIZON - math.floor(h / 2)
05278 [GPT-5-Codex]                 local y2 = HORIZON + math.floor(h / 2)
05279 [GPT-5-Codex]                 if y1 < 0 then y1 = 0 end
05280 [GPT-5-Codex]                 if y2 > (VIEWPORT_H - 1) then y2 = VIEWPORT_H - 1 end
05281 [GPT-5-Codex] 
05282 [GPT-5-Codex]                 local fogAlpha = 0
05283 [GPT-5-Codex]                 if not DEBUG_DISABLE_FOG then
05284 [GPT-5-Codex]                     fogAlpha = getFogQuantizedFactor(fixedDist)
05285 [GPT-5-Codex]                 end
05286 [GPT-5-Codex]                 local fogCut = FOG_TEX_CUTOFF or FOG_END or texView
05287 [GPT-5-Codex]                 local farWall = (fixedDist > texView) or (fixedDist >= fogCut) or (fogAlpha >= 1.0)
05288 [GPT-5-Codex]                 local farTexOff = FAR_TEX_OFF_DIST or 999
05289 [GPT-5-Codex]                 local forceNoTexByDist = (farTexOff < 900) and (fixedDist >= farTexOff)
05290 [GPT-5-Codex] 
05291 [GPT-5-Codex]                 local wantTex = (WALL_TEXTURE_MODE == "proper"
05292 [GPT-5-Codex]                     and not DEBUG_DISABLE_WALL_TEXTURE
05293 [GPT-5-Codex]                     and (nearForce or (not farWall and h < (HYBRID_TEX_MAX_H or (VIEWPORT_H - 8))))
05294 [GPT-5-Codex]                     and not forceNoTexByDist)
05295 [GPT-5-Codex]                 if not wantTex then
05296 [GPT-5-Codex]                     local baseColor = getWallColor(wtype, side)
05297 [GPT-5-Codex]                     local drawT0
05298 [GPT-5-Codex]                     if canTime then drawT0 = vmupro.system.getTimeUs() end
05299 [GPT-5-Codex]                     vmupro.graphics.drawFillRect(sx, y1, ex, y2, baseColor)
05300 [GPT-5-Codex]                     if canTime and drawT0 then
05301 [GPT-5-Codex]                         local drawT1 = vmupro.system.getTimeUs()
05302 [GPT-5-Codex]                         PERF_MONITOR_SAMPLE_WALL_US = (PERF_MONITOR_SAMPLE_WALL_US or 0) + (drawT1 - drawT0)
05303 [GPT-5-Codex]                     end
05304 [GPT-5-Codex]                     if fogAlpha > 0 then
05305 [GPT-5-Codex]                         if trackCounters then
05306 [GPT-5-Codex]                             PERF_MONITOR_FOG_COLS = (PERF_MONITOR_FOG_COLS or 0) + spanW
05307 [GPT-5-Codex]                         end
05308 [GPT-5-Codex]                         if canTime then drawT0 = vmupro.system.getTimeUs() end
05309 [GPT-5-Codex]                         drawFogOverlayArea(sx, y1, ex, y2, fogAlpha)
05310 [GPT-5-Codex]                         if canTime and drawT0 then
05311 [GPT-5-Codex]                             local fogT1 = vmupro.system.getTimeUs()
05312 [GPT-5-Codex]                             PERF_MONITOR_SAMPLE_FOG_US = (PERF_MONITOR_SAMPLE_FOG_US or 0) + (fogT1 - drawT0)
05313 [GPT-5-Codex]                         end
05314 [GPT-5-Codex]                     end
05315 [GPT-5-Codex]                 else
05316 [GPT-5-Codex]                     local useTex = texCoord or 0
05317 [GPT-5-Codex]                     if useTex < 0 then useTex = 0 end
05318 [GPT-5-Codex]                     if useTex > 0.999 then useTex = 0.999 end
05319 [GPT-5-Codex]                     local flipEps = 0.0008
05320 [GPT-5-Codex]                     if side == 0 and castCos > flipEps then
05321 [GPT-5-Codex]                         useTex = 1.0 - useTex
05322 [GPT-5-Codex]                     elseif side == 1 and castSin < -flipEps then
05323 [GPT-5-Codex]                         useTex = 1.0 - useTex
05324 [GPT-5-Codex]                     end
05325 [GPT-5-Codex]                     if useTex < 0.001 then useTex = 0.001 end
05326 [GPT-5-Codex]                     if useTex > 0.998 then useTex = 0.998 end
05327 [GPT-5-Codex]                     local drewTex = drawWallTextureColumn(wtype, side, useTex, sx, y1, y2, drawColW, fixedDist, mipLevel)
05328 [GPT-5-Codex]                     if not drewTex then
05329 [GPT-5-Codex]                         if trackCounters then
05330 [GPT-5-Codex]                             PERF_MONITOR_WALL_COLS_FALLBACK = (PERF_MONITOR_WALL_COLS_FALLBACK or 0) + spanW
05331 [GPT-5-Codex]                         end
05332 [GPT-5-Codex]                         local baseColor = getWallColor(wtype, side)
05333 [GPT-5-Codex]                         local drawT0
05334 [GPT-5-Codex]                         if canTime then drawT0 = vmupro.system.getTimeUs() end
05335 [GPT-5-Codex]                         vmupro.graphics.drawFillRect(sx, y1, ex, y2, baseColor)
05336 [GPT-5-Codex]                         if canTime and drawT0 then
05337 [GPT-5-Codex]                             local drawT1 = vmupro.system.getTimeUs()
05338 [GPT-5-Codex]                             PERF_MONITOR_SAMPLE_WALL_US = (PERF_MONITOR_SAMPLE_WALL_US or 0) + (drawT1 - drawT0)
05339 [GPT-5-Codex]                         end
05340 [GPT-5-Codex]                         if fogAlpha > 0 then
05341 [GPT-5-Codex]                             if trackCounters then
05342 [GPT-5-Codex]                                 PERF_MONITOR_FOG_COLS = (PERF_MONITOR_FOG_COLS or 0) + spanW
05343 [GPT-5-Codex]                             end
05344 [GPT-5-Codex]                             if canTime then drawT0 = vmupro.system.getTimeUs() end
05345 [GPT-5-Codex]                             drawFogOverlayArea(sx, y1, ex, y2, fogAlpha)
05346 [GPT-5-Codex]                             if canTime and drawT0 then
05347 [GPT-5-Codex]                                 local fogT1 = vmupro.system.getTimeUs()
05348 [GPT-5-Codex]                                 PERF_MONITOR_SAMPLE_FOG_US = (PERF_MONITOR_SAMPLE_FOG_US or 0) + (fogT1 - drawT0)
05349 [GPT-5-Codex]                             end
05350 [GPT-5-Codex]                         end
05351 [GPT-5-Codex]                     else
05352 [GPT-5-Codex]                         if trackCounters then
05353 [GPT-5-Codex]                             PERF_MONITOR_WALL_COLS_TEXTURED = (PERF_MONITOR_WALL_COLS_TEXTURED or 0) + spanW
05354 [GPT-5-Codex]                         end
05355 [GPT-5-Codex]                     end
05356 [GPT-5-Codex]                 end
05357 [GPT-5-Codex]             elseif not rayHit and not DEBUG_DISABLE_FOG then
05358 [GPT-5-Codex]                 -- Draw a fog curtain when no wall was traced inside draw distance.
05359 [GPT-5-Codex]                 -- This keeps fog coverage independent from draw-distance cutoff.
05360 [GPT-5-Codex]                 if trackCounters then
05361 [GPT-5-Codex]                     PERF_MONITOR_FOG_COLS = (PERF_MONITOR_FOG_COLS or 0) + spanW
05362 [GPT-5-Codex]                 end
05363 [GPT-5-Codex]                 local fogT0
05364 [GPT-5-Codex]                 if canTime then fogT0 = vmupro.system.getTimeUs() end
05365 [GPT-5-Codex]                 drawFogCurtainColumn(sx, ex, fogView)
05366 [GPT-5-Codex]                 if canTime and fogT0 then
05367 [GPT-5-Codex]                     local fogT1 = vmupro.system.getTimeUs()
05368 [GPT-5-Codex]                     PERF_MONITOR_SAMPLE_FOG_US = (PERF_MONITOR_SAMPLE_FOG_US or 0) + (fogT1 - fogT0)
05369 [GPT-5-Codex]                 end
05370 [GPT-5-Codex]             end
05371 [GPT-5-Codex]         end
05372 [GPT-5-Codex] 
05373 [GPT-5-Codex]         if not useFixedRaycast then
05374 [GPT-5-Codex]             local sc, ss
05375 [GPT-5-Codex]             if rayStride == 1 then
05376 [GPT-5-Codex]                 sc, ss = stepCos1, stepSin1
05377 [GPT-5-Codex]             elseif rayStride == 2 then
05378 [GPT-5-Codex]                 sc, ss = stepCos2, stepSin2
05379 [GPT-5-Codex]             elseif rayStride == 3 then
05380 [GPT-5-Codex]                 sc, ss = stepCos3, stepSin3
05381 [GPT-5-Codex]             elseif rayStride == 4 then
05382 [GPT-5-Codex]                 sc, ss = stepCos4, stepSin4
05383 [GPT-5-Codex]             else
05384 [GPT-5-Codex]                 sc = math.cos(rayStep * rayStride)
05385 [GPT-5-Codex]                 ss = math.sin(rayStep * rayStride)
05386 [GPT-5-Codex]             end
05387 [GPT-5-Codex]             local newCos = rayCos * sc - raySin * ss
05388 [GPT-5-Codex]             local newSin = raySin * sc + rayCos * ss
05389 [GPT-5-Codex]             rayCos, raySin = newCos, newSin
05390 [GPT-5-Codex]         end
05391 [GPT-5-Codex]         x = x + rayStride
05392 [GPT-5-Codex]     end
05393 [GPT-5-Codex] end
05394 [GPT-5-Codex] 
05395 [GPT-5-Codex] function castRay(dx, dy, maxDist)
05396 [GPT-5-Codex]     if dx == 0 and dy == 0 then
05397 [GPT-5-Codex]         return 16, 1, 0, 0, false
05398 [GPT-5-Codex]     end
05399 [GPT-5-Codex] 
05400 [GPT-5-Codex]     local mapX = math.floor(px)
05401 [GPT-5-Codex]     local mapY = math.floor(py)
05402 [GPT-5-Codex]     local rayMaxDist = maxDist or 16
05403 [GPT-5-Codex]     if rayMaxDist < 0.25 then
05404 [GPT-5-Codex]         rayMaxDist = 0.25
05405 [GPT-5-Codex]     end
05406 [GPT-5-Codex] 
05407 [GPT-5-Codex]     -- Guard against rare movement penetration: stabilize rendering when inside a wall cell.
05408 [GPT-5-Codex]     if mapX >= 0 and mapX < 16 and mapY >= 0 and mapY < 16 then
05409 [GPT-5-Codex]         local startTile = map and map[mapY + 1] and map[mapY + 1][mapX + 1] or 0
05410 [GPT-5-Codex]         if startTile and startTile > 0 then
05411 [GPT-5-Codex]             return getStartSolidRayFallback(px, py, mapX, mapY, startTile)
05412 [GPT-5-Codex]         end
05413 [GPT-5-Codex]     end
05414 [GPT-5-Codex] 
05415 [GPT-5-Codex]     local deltaDistX = (dx == 0) and 1e9 or math.abs(1 / dx)
05416 [GPT-5-Codex]     local deltaDistY = (dy == 0) and 1e9 or math.abs(1 / dy)
05417 [GPT-5-Codex] 
05418 [GPT-5-Codex]     local stepX, stepY
05419 [GPT-5-Codex]     local sideDistX, sideDistY
05420 [GPT-5-Codex] 
05421 [GPT-5-Codex]     if dx < 0 then
05422 [GPT-5-Codex]         stepX = -1
05423 [GPT-5-Codex]         sideDistX = (px - mapX) * deltaDistX
05424 [GPT-5-Codex]     else
05425 [GPT-5-Codex]         stepX = 1
05426 [GPT-5-Codex]         sideDistX = (mapX + 1.0 - px) * deltaDistX
05427 [GPT-5-Codex]     end
05428 [GPT-5-Codex] 
05429 [GPT-5-Codex]     if dy < 0 then
05430 [GPT-5-Codex]         stepY = -1
05431 [GPT-5-Codex]         sideDistY = (py - mapY) * deltaDistY
05432 [GPT-5-Codex]     else
05433 [GPT-5-Codex]         stepY = 1
05434 [GPT-5-Codex]         sideDistY = (mapY + 1.0 - py) * deltaDistY
05435 [GPT-5-Codex]     end
05436 [GPT-5-Codex] 
05437 [GPT-5-Codex]     local hit = false
05438 [GPT-5-Codex]     local side = 0
05439 [GPT-5-Codex]     -- PERFORMANCE: Reduced from 64 to 32
05440 [GPT-5-Codex]     -- Map is only 16x16, and most rays hit walls well before this limit
05441 [GPT-5-Codex]     -- Cuts worst-case raycast iterations by 50% (240 rays  32 = 7,680 vs 15,360)
05442 [GPT-5-Codex]     local maxSteps = 32
05443 [GPT-5-Codex]     local wtype = 1
05444 [GPT-5-Codex]     for _ = 1, maxSteps do
05445 [GPT-5-Codex]         local nextDist = sideDistX
05446 [GPT-5-Codex]         if sideDistY < nextDist then nextDist = sideDistY end
05447 [GPT-5-Codex]         if nextDist > rayMaxDist then
05448 [GPT-5-Codex]             break
05449 [GPT-5-Codex]         end
05450 [GPT-5-Codex]         if sideDistX < sideDistY then
05451 [GPT-5-Codex]             sideDistX = sideDistX + deltaDistX
05452 [GPT-5-Codex]             mapX = mapX + stepX
05453 [GPT-5-Codex]             side = 0
05454 [GPT-5-Codex]         else
05455 [GPT-5-Codex]             sideDistY = sideDistY + deltaDistY
05456 [GPT-5-Codex]             mapY = mapY + stepY
05457 [GPT-5-Codex]             side = 1
05458 [GPT-5-Codex]         end
05459 [GPT-5-Codex]         if mapX < 0 or mapX >= 16 or mapY < 0 or mapY >= 16 then
05460 [GPT-5-Codex]             break
05461 [GPT-5-Codex]         end
05462 [GPT-5-Codex]         wtype = map[mapY + 1][mapX + 1]
05463 [GPT-5-Codex]         if wtype > 0 then
05464 [GPT-5-Codex]             hit = true
05465 [GPT-5-Codex]             break
05466 [GPT-5-Codex]         end
05467 [GPT-5-Codex]     end
05468 [GPT-5-Codex] 
05469 [GPT-5-Codex]     if not hit then
05470 [GPT-5-Codex]         return rayMaxDist, 1, 0, 0, false
05471 [GPT-5-Codex]     end
05472 [GPT-5-Codex] 
05473 [GPT-5-Codex]     local perpWallDist
05474 [GPT-5-Codex]     if side == 0 then
05475 [GPT-5-Codex]         perpWallDist = (mapX - px + (1 - stepX) / 2) / (dx == 0 and 1e-6 or dx)
05476 [GPT-5-Codex]     else
05477 [GPT-5-Codex]         perpWallDist = (mapY - py + (1 - stepY) / 2) / (dy == 0 and 1e-6 or dy)
05478 [GPT-5-Codex]     end
05479 [GPT-5-Codex] 
05480 [GPT-5-Codex]     local texCoord
05481 [GPT-5-Codex]     if side == 0 then
05482 [GPT-5-Codex]         texCoord = py + perpWallDist * dy
05483 [GPT-5-Codex]     else
05484 [GPT-5-Codex]         texCoord = px + perpWallDist * dx
05485 [GPT-5-Codex]     end
05486 [GPT-5-Codex]     texCoord = texCoord - math.floor(texCoord)
05487 [GPT-5-Codex]     if texCoord < 0 then texCoord = texCoord + 1 end
05488 [GPT-5-Codex]     if texCoord > 0.999 then texCoord = 0.999 end
05489 [GPT-5-Codex] 
05490 [GPT-5-Codex]     return perpWallDist, wtype, side, texCoord, true
05491 [GPT-5-Codex] end
05492 [GPT-5-Codex] 
05493 [GPT-5-Codex] local function isVisible(tx, ty, cache)
05494 [GPT-5-Codex]     local expRenderer = isExpRenderer()
05495 [GPT-5-Codex]     local useCache = cache and (not expRenderer)
05496 [GPT-5-Codex]     if useCache then
05497 [GPT-5-Codex]         local lastFrame = cache._visFrame or -1000
05498 [GPT-5-Codex]         if frameCount - lastFrame < 14 then
05499 [GPT-5-Codex]             return cache._visValue == true
05500 [GPT-5-Codex]         end
05501 [GPT-5-Codex]     end
05502 [GPT-5-Codex]     local dx, dy = tx - px, ty - py
05503 [GPT-5-Codex]     local dist = math.sqrt(dx * dx + dy * dy)
05504 [GPT-5-Codex]     local maxDist = SPRITE_VIS_DIST or 6
05505 [GPT-5-Codex]     if expRenderer then
05506 [GPT-5-Codex]         local viewDist = EXP_VIEW_DIST or maxDist
05507 [GPT-5-Codex]         if viewDist < maxDist then maxDist = viewDist end
05508 [GPT-5-Codex]     end
05509 [GPT-5-Codex]     if dist > maxDist then
05510 [GPT-5-Codex]         if useCache then
05511 [GPT-5-Codex]             cache._visFrame = frameCount
05512 [GPT-5-Codex]             cache._visValue = false
05513 [GPT-5-Codex]         end
05514 [GPT-5-Codex]         return false
05515 [GPT-5-Codex]     end
05516 [GPT-5-Codex]     if expRenderer then
05517 [GPT-5-Codex]         local dir = pdir % 64
05518 [GPT-5-Codex]         local cosDir = cosTable[dir]
05519 [GPT-5-Codex]         local sinDir = sinTable[dir]
05520 [GPT-5-Codex]         local relX = dx * sinDir - dy * cosDir
05521 [GPT-5-Codex]         local relY = dx * cosDir + dy * sinDir
05522 [GPT-5-Codex]         if relY <= 0.05 then
05523 [GPT-5-Codex]             if useCache then
05524 [GPT-5-Codex]                 cache._visFrame = frameCount
05525 [GPT-5-Codex]                 cache._visValue = false
05526 [GPT-5-Codex]             end
05527 [GPT-5-Codex]             return false
05528 [GPT-5-Codex]         end
05529 [GPT-5-Codex]         local fovRad = renderCfg.fovSteps * (renderCfg.twoPi / 64)
05530 [GPT-5-Codex]         local maxSx = math.tan(fovRad / 2)
05531 [GPT-5-Codex]         local sx = relX / relY
05532 [GPT-5-Codex]         if sx < -maxSx or sx > maxSx then
05533 [GPT-5-Codex]             if useCache then
05534 [GPT-5-Codex]                 cache._visFrame = frameCount
05535 [GPT-5-Codex]                 cache._visValue = false
05536 [GPT-5-Codex]             end
05537 [GPT-5-Codex]             return false
05538 [GPT-5-Codex]         end
05539 [GPT-5-Codex]     end
05540 [GPT-5-Codex]     if dist < 0.1 then
05541 [GPT-5-Codex]         if useCache then
05542 [GPT-5-Codex]             cache._visFrame = frameCount
05543 [GPT-5-Codex]             cache._visValue = true
05544 [GPT-5-Codex]         end
05545 [GPT-5-Codex]         return true
05546 [GPT-5-Codex]     end
05547 [GPT-5-Codex]     dx, dy = dx / dist, dy / dist
05548 [GPT-5-Codex]     local rx, ry, traveled = px, py, 0
05549 [GPT-5-Codex]     local step = expRenderer and 0.1 or 0.25
05550 [GPT-5-Codex]     while traveled < dist - step do
05551 [GPT-5-Codex]         rx, ry = rx + dx * step, ry + dy * step
05552 [GPT-5-Codex]         traveled = traveled + step
05553 [GPT-5-Codex]         local mx, my = math.floor(rx), math.floor(ry)
05554 [GPT-5-Codex]         if mx >= 0 and mx < 16 and my >= 0 and my < 16 then
05555 [GPT-5-Codex]             if map[my + 1][mx + 1] > 0 then
05556 [GPT-5-Codex]                 if useCache then
05557 [GPT-5-Codex]                     cache._visFrame = frameCount
05558 [GPT-5-Codex]                     cache._visValue = false
05559 [GPT-5-Codex]                 end
05560 [GPT-5-Codex]                 return false
05561 [GPT-5-Codex]             end
05562 [GPT-5-Codex]             -- Thicken the ray to avoid corner peeking
05563 [GPT-5-Codex]             local r = 0.1
05564 [GPT-5-Codex]             local mx1, mx2 = math.floor(rx - r), math.floor(rx + r)
05565 [GPT-5-Codex]             local my1, my2 = math.floor(ry - r), math.floor(ry + r)
05566 [GPT-5-Codex]             if mx1 < 0 or mx2 >= 16 or my1 < 0 or my2 >= 16 then
05567 [GPT-5-Codex]                 if useCache then
05568 [GPT-5-Codex]                     cache._visFrame = frameCount
05569 [GPT-5-Codex]                     cache._visValue = false
05570 [GPT-5-Codex]                 end
05571 [GPT-5-Codex]                 return false
05572 [GPT-5-Codex]             end
05573 [GPT-5-Codex]             if map[my1 + 1][mx1 + 1] > 0 or map[my1 + 1][mx2 + 1] > 0
05574 [GPT-5-Codex]                 or map[my2 + 1][mx1 + 1] > 0 or map[my2 + 1][mx2 + 1] > 0 then
05575 [GPT-5-Codex]                 if useCache then
05576 [GPT-5-Codex]                     cache._visFrame = frameCount
05577 [GPT-5-Codex]                     cache._visValue = false
05578 [GPT-5-Codex]                 end
05579 [GPT-5-Codex]                 return false
05580 [GPT-5-Codex]             end
05581 [GPT-5-Codex]         end
05582 [GPT-5-Codex]     end
05583 [GPT-5-Codex]     if useCache then
05584 [GPT-5-Codex]         cache._visFrame = frameCount
05585 [GPT-5-Codex]         cache._visValue = true
05586 [GPT-5-Codex]     end
05587 [GPT-5-Codex]     return true
05588 [GPT-5-Codex] end
05589 [GPT-5-Codex] 
05590 [GPT-5-Codex] local function drawSprite(screenX, dist, stype, viewAngle, animFrame, spriteData)
05591 [GPT-5-Codex]     if dist < 0.3 then return end
05592 [GPT-5-Codex]     local size = math.floor(100 / dist)
05593 [GPT-5-Codex]     if size < 6 then return end
05594 [GPT-5-Codex]     if size > 140 then size = 140 end
05595 [GPT-5-Codex] 
05596 [GPT-5-Codex]     local hs = math.floor(size / 2)
05597 [GPT-5-Codex]     local x1, x2 = screenX - hs, screenX + hs
05598 [GPT-5-Codex]     -- Ground level matches wall bottom: HORIZON + 100/dist = HORIZON + size
05599 [GPT-5-Codex]     local groundY = HORIZON + size
05600 [GPT-5-Codex]     if groundY > VIEWPORT_H then groundY = VIEWPORT_H end
05601 [GPT-5-Codex]     local y1, y2 = groundY - size, groundY
05602 [GPT-5-Codex] 
05603 [GPT-5-Codex]     if x2 < 0 or x1 > 240 then return end
05604 [GPT-5-Codex] 
05605 [GPT-5-Codex]     -- Center Y for wall-mounted items (at eye level), ground for floor items
05606 [GPT-5-Codex]     local centerY = HORIZON  -- Wall-mounted items at eye level
05607 [GPT-5-Codex] 
05608 [GPT-5-Codex]     if stype == 1 then
05609 [GPT-5-Codex]         -- Detailed Torch (wall mounted, at eye level)
05610 [GPT-5-Codex]         local tw = math.floor(size / 5)
05611 [GPT-5-Codex]         local th = math.floor(size / 2)
05612 [GPT-5-Codex]         local tx1, tx2 = screenX - tw, screenX + tw
05613 [GPT-5-Codex]         -- Handle with wood grain
05614 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx1, centerY, tx2, centerY + th, COLOR_BROWN)
05615 [GPT-5-Codex]         vmupro.graphics.drawLine(tx1 + 2, centerY + 4, tx1 + 2, centerY + th - 4, COLOR_DARK_BROWN)
05616 [GPT-5-Codex]         vmupro.graphics.drawLine(tx2 - 2, centerY + 4, tx2 - 2, centerY + th - 4, COLOR_DARK_BROWN)
05617 [GPT-5-Codex]         -- Flame base
05618 [GPT-5-Codex]         local flameH = math.floor(size / 3)
05619 [GPT-5-Codex]         local flicker = (frameCount % 4) - 2
05620 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx1 - 2, centerY - flameH, tx2 + 2, centerY, COLOR_ORANGE)
05621 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx1, centerY - flameH - 4 + flicker, tx2, centerY - flameH + 4, COLOR_YELLOW)
05622 [GPT-5-Codex]         -- Inner flame
05623 [GPT-5-Codex]         vmupro.graphics.drawFillRect(screenX - 2, centerY - flameH + 4, screenX + 2, centerY - 4, COLOR_YELLOW)
05624 [GPT-5-Codex] 
05625 [GPT-5-Codex]     elseif stype == 2 then
05626 [GPT-5-Codex]         -- Detailed Barrel (sits on ground)
05627 [GPT-5-Codex]         local bw = math.floor(size / 2)
05628 [GPT-5-Codex]         local bh = math.floor(size * 0.6)
05629 [GPT-5-Codex]         local bx1, bx2 = screenX - bw, screenX + bw
05630 [GPT-5-Codex]         local by2 = y2  -- Bottom at ground
05631 [GPT-5-Codex]         local by1 = by2 - bh  -- Top
05632 [GPT-5-Codex]         local bCenterY = math.floor((by1 + by2) / 2)
05633 [GPT-5-Codex]         -- Main barrel body
05634 [GPT-5-Codex]         vmupro.graphics.drawFillRect(bx1 + 2, by1, bx2 - 2, by2, COLOR_BROWN)
05635 [GPT-5-Codex]         -- Curved sides
05636 [GPT-5-Codex]         vmupro.graphics.drawFillRect(bx1, by1 + 4, bx1 + 4, by2 - 4, COLOR_DARK_BROWN)
05637 [GPT-5-Codex]         vmupro.graphics.drawFillRect(bx2 - 4, by1 + 4, bx2, by2 - 4, COLOR_DARK_BROWN)
05638 [GPT-5-Codex]         -- Metal bands
05639 [GPT-5-Codex]         local bandH = 3
05640 [GPT-5-Codex]         vmupro.graphics.drawFillRect(bx1, by1 + 6, bx2, by1 + 6 + bandH, COLOR_GRAY)
05641 [GPT-5-Codex]         vmupro.graphics.drawFillRect(bx1, by2 - 6 - bandH, bx2, by2 - 6, COLOR_GRAY)
05642 [GPT-5-Codex]         vmupro.graphics.drawFillRect(bx1, bCenterY - 1, bx2, bCenterY + 2, COLOR_DARK_GRAY)
05643 [GPT-5-Codex]         -- Wood grain lines
05644 [GPT-5-Codex]         vmupro.graphics.drawLine(screenX - 4, by1 + 10, screenX - 4, by2 - 10, COLOR_DARK_BROWN)
05645 [GPT-5-Codex]         vmupro.graphics.drawLine(screenX + 4, by1 + 10, screenX + 4, by2 - 10, COLOR_DARK_BROWN)
05646 [GPT-5-Codex]         -- Top rim
05647 [GPT-5-Codex]         vmupro.graphics.drawFillRect(bx1 + 2, by1, bx2 - 2, by1 + 3, COLOR_LIGHT_BROWN)
05648 [GPT-5-Codex] 
05649 [GPT-5-Codex]     elseif stype == 3 then
05650 [GPT-5-Codex]         -- Detailed Table (sits on ground)
05651 [GPT-5-Codex]         local tw = math.floor(size * 0.7)
05652 [GPT-5-Codex]         local th = math.floor(size * 0.15)
05653 [GPT-5-Codex]         local legH = math.floor(size * 0.4)
05654 [GPT-5-Codex]         local tx1, tx2 = screenX - tw, screenX + tw
05655 [GPT-5-Codex]         local ty = y2 - legH - th  -- Table top position (legs touch ground at y2)
05656 [GPT-5-Codex]         -- Table top with wood grain
05657 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx1, ty, tx2, ty + th, COLOR_BROWN)
05658 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx1, ty, tx2, ty + 2, COLOR_LIGHT_BROWN)
05659 [GPT-5-Codex]         vmupro.graphics.drawLine(tx1 + 8, ty + 2, tx1 + 8, ty + th, COLOR_DARK_BROWN)
05660 [GPT-5-Codex]         vmupro.graphics.drawLine(tx2 - 8, ty + 2, tx2 - 8, ty + th, COLOR_DARK_BROWN)
05661 [GPT-5-Codex]         vmupro.graphics.drawLine(screenX, ty + 2, screenX, ty + th, COLOR_DARK_BROWN)
05662 [GPT-5-Codex]         -- Legs
05663 [GPT-5-Codex]         local legW = math.floor(size * 0.08)
05664 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx1 + 4, ty + th, tx1 + 4 + legW, y2, COLOR_DARK_BROWN)
05665 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx2 - 4 - legW, ty + th, tx2 - 4, y2, COLOR_DARK_BROWN)
05666 [GPT-5-Codex]         -- Cross beam
05667 [GPT-5-Codex]         vmupro.graphics.drawFillRect(tx1 + 4, y2 - 8, tx2 - 4, y2 - 5, COLOR_BROWN)
05668 [GPT-5-Codex] 
05669 [GPT-5-Codex]     elseif stype == 4 then
05670 [GPT-5-Codex]         -- Detailed Chest (sits on ground)
05671 [GPT-5-Codex]         local cw = math.floor(size * 0.5)
05672 [GPT-5-Codex]         local ch = math.floor(size * 0.35)
05673 [GPT-5-Codex]         local cx1, cx2 = screenX - cw, screenX + cw
05674 [GPT-5-Codex]         local cy2 = y2  -- Bottom at ground
05675 [GPT-5-Codex]         local cy1 = cy2 - ch  -- Top of body
05676 [GPT-5-Codex]         local lidTop = cy1 - math.floor(ch * 0.4)
05677 [GPT-5-Codex]         -- Main body
05678 [GPT-5-Codex]         vmupro.graphics.drawFillRect(cx1, cy1, cx2, cy2, COLOR_BROWN)
05679 [GPT-5-Codex]         -- Lid (slightly raised)
05680 [GPT-5-Codex]         vmupro.graphics.drawFillRect(cx1 - 2, lidTop, cx2 + 2, cy1, COLOR_LIGHT_BROWN)
05681 [GPT-5-Codex]         vmupro.graphics.drawFillRect(cx1, lidTop + 2, cx2, cy1 - 2, COLOR_BROWN)
05682 [GPT-5-Codex]         -- Metal corners
05683 [GPT-5-Codex]         vmupro.graphics.drawFillRect(cx1, cy1, cx1 + 4, cy2, COLOR_GRAY)
05684 [GPT-5-Codex]         vmupro.graphics.drawFillRect(cx2 - 4, cy1, cx2, cy2, COLOR_GRAY)
05685 [GPT-5-Codex]         vmupro.graphics.drawFillRect(cx1, lidTop, cx1 + 4, cy1, COLOR_GRAY)
05686 [GPT-5-Codex]         vmupro.graphics.drawFillRect(cx2 - 4, lidTop, cx2, cy1, COLOR_GRAY)
05687 [GPT-5-Codex]         -- Lock
05688 [GPT-5-Codex]         vmupro.graphics.drawFillRect(screenX - 4, cy1 - 6, screenX + 4, cy1 + 6, COLOR_YELLOW)
05689 [GPT-5-Codex]         vmupro.graphics.drawFillRect(screenX - 2, cy1 - 3, screenX + 2, cy1 + 3, COLOR_DARK_BROWN)
05690 [GPT-5-Codex]         -- Keyhole
05691 [GPT-5-Codex]         vmupro.graphics.drawFillRect(screenX - 1, cy1, screenX + 1, cy1 + 2, COLOR_BLACK)
05692 [GPT-5-Codex] 
05693 [GPT-5-Codex]     elseif stype == 5 then
05694 [GPT-5-Codex]         if spriteData and spriteData.dying and #warriorDeath > 0 then
05695 [GPT-5-Codex]             local frameIndex = spriteData.deathFrame or 1
05696 [GPT-5-Codex]             local sprite = warriorDeath[math.min(frameIndex, #warriorDeath)]
05697 [GPT-5-Codex]             if sprite and sprite.height then
05698 [GPT-5-Codex]                 local desiredHeight = size
05699 [GPT-5-Codex]                 local scale = safeDivide(desiredHeight, sprite.height, "renderWarriorDeath")
05700 [GPT-5-Codex]                 local scaledWidth = sprite.width * scale
05701 [GPT-5-Codex]                 local scaledHeight = sprite.height * scale
05702 [GPT-5-Codex]                 local drawX = screenX - math.floor(scaledWidth / 2)
05703 [GPT-5-Codex]                 local groundY = HORIZON + size
05704 [GPT-5-Codex]                 if groundY > 240 then groundY = 240 end
05705 [GPT-5-Codex]                 local drawY = groundY - math.floor(scaledHeight)
05706 [GPT-5-Codex]                 if safeScale(sprite, scale, scale, "renderWarriorDeath") then
05707 [GPT-5-Codex]                     vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, vmupro.sprite.kImageUnflipped)
05708 [GPT-5-Codex]                 end
05709 [GPT-5-Codex]             end
05710 [GPT-5-Codex]             return
05711 [GPT-5-Codex]         end
05712 [GPT-5-Codex]         -- Warrior Guard using real sprites
05713 [GPT-5-Codex]         -- Determine view: 0=front, 1=right, 2=back, 3=left
05714 [GPT-5-Codex]         local view = 0
05715 [GPT-5-Codex]         if viewAngle then
05716 [GPT-5-Codex]             if DEBUG_CYCLE_VIEW then
05717 [GPT-5-Codex]                 view = math.floor(frameCount / DEBUG_CYCLE_VIEW_FRAMES) % 4
05718 [GPT-5-Codex]             elseif DEBUG_FORCE_VIEW then
05719 [GPT-5-Codex]                 view = DEBUG_FORCE_VIEW
05720 [GPT-5-Codex]             elseif DEBUG_FORCE_SIDE_VIEW then
05721 [GPT-5-Codex]                 view = (viewAngle >= 0) and 3 or 1
05722 [GPT-5-Codex]             else
05723 [GPT-5-Codex]                 if viewAngle >= -8 and viewAngle <= 8 then view = 0
05724 [GPT-5-Codex]                 elseif viewAngle > 8 and viewAngle < 24 then view = 3
05725 [GPT-5-Codex]                 elseif viewAngle >= 24 or viewAngle <= -24 then view = 2
05726 [GPT-5-Codex]                 else view = 1 end
05727 [GPT-5-Codex]             end
05728 [GPT-5-Codex]         end
05729 [GPT-5-Codex] 
05730 [GPT-5-Codex]         -- Attack animation (2-frame) overrides walk/idle
05731 [GPT-5-Codex]         if spriteData and spriteData.attackAnim and spriteData.attackAnim > 0 then
05732 [GPT-5-Codex]             local frameIndex = (spriteData.attackFrame or 1)
05733 [GPT-5-Codex]             local sprite = nil
05734 [GPT-5-Codex]             if view == 0 then
05735 [GPT-5-Codex]                 sprite = warriorAttackFront[frameIndex]
05736 [GPT-5-Codex]             elseif view == 2 then
05737 [GPT-5-Codex]                 sprite = warriorAttackBack[frameIndex]
05738 [GPT-5-Codex]             elseif view == 3 then
05739 [GPT-5-Codex]                 sprite = warriorAttackLeft[frameIndex]
05740 [GPT-5-Codex]             else
05741 [GPT-5-Codex]                 sprite = warriorAttackRight[frameIndex]
05742 [GPT-5-Codex]             end
05743 [GPT-5-Codex] 
05744 [GPT-5-Codex]             if sprite and sprite.height then
05745 [GPT-5-Codex]                 local desiredHeight = size
05746 [GPT-5-Codex]                 local scale = safeDivide(desiredHeight, sprite.height, "renderScale")
05747 [GPT-5-Codex]                 local scaledWidth = sprite.width * scale
05748 [GPT-5-Codex]                 local scaledHeight = sprite.height * scale
05749 [GPT-5-Codex]                 local drawX = screenX - math.floor(scaledWidth / 2)
05750 [GPT-5-Codex]                 local groundY = HORIZON + size
05751 [GPT-5-Codex]                 if groundY > 240 then groundY = 240 end
05752 [GPT-5-Codex]                 local drawY = groundY - math.floor(scaledHeight)
05753 [GPT-5-Codex]                 vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, vmupro.sprite.kImageUnflipped)
05754 [GPT-5-Codex]             end
05755 [GPT-5-Codex]             return
05756 [GPT-5-Codex]         end
05757 [GPT-5-Codex] 
05758 [GPT-5-Codex]         -- Select appropriate sprite based on view and animation state
05759 [GPT-5-Codex]         local sprite = warriorFront
05760 [GPT-5-Codex]         local flipFlag = vmupro.sprite.kImageUnflipped
05761 [GPT-5-Codex]         local isMoving = animFrame ~= nil  -- Has animation = is patrolling
05762 [GPT-5-Codex]         if DEBUG_WALK_IN_PLACE then
05763 [GPT-5-Codex]             isMoving = true
05764 [GPT-5-Codex]         end
05765 [GPT-5-Codex]         local animTick = animFrame
05766 [GPT-5-Codex]         if DEBUG_FORCE_GLOBAL_WALK then
05767 [GPT-5-Codex]             animTick = frameCount
05768 [GPT-5-Codex]         end
05769 [GPT-5-Codex]         local debugWalkFrame = nil
05770 [GPT-5-Codex]         local debugSpriteLabel = "?"
05771 [GPT-5-Codex] 
05772 [GPT-5-Codex]         if view == 0 then
05773 [GPT-5-Codex]             -- Front view - use front sprite (no walking animation for front yet)
05774 [GPT-5-Codex]             if DEBUG_CYCLE_VIEW then
05775 [GPT-5-Codex]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Front and 3) or 2)
05776 [GPT-5-Codex]                 local walkFrame = math.floor(animTick / 7) % frameCount
05777 [GPT-5-Codex]                 debugWalkFrame = walkFrame
05778 [GPT-5-Codex]                 if walkFrame == 0 and warriorWalk1Front then
05779 [GPT-5-Codex]                     sprite = warriorWalk1Front
05780 [GPT-5-Codex]                     debugSpriteLabel = "F1"
05781 [GPT-5-Codex]                 elseif walkFrame == 1 and warriorWalk2Front then
05782 [GPT-5-Codex]                     sprite = warriorWalk2Front
05783 [GPT-5-Codex]                     debugSpriteLabel = "F2"
05784 [GPT-5-Codex]                 elseif walkFrame == 2 and warriorWalk3Front then
05785 [GPT-5-Codex]                     sprite = warriorWalk3Front
05786 [GPT-5-Codex]                     debugSpriteLabel = "F3"
05787 [GPT-5-Codex]                 else
05788 [GPT-5-Codex]                     sprite = warriorFront
05789 [GPT-5-Codex]                     debugSpriteLabel = "F0"
05790 [GPT-5-Codex]                 end
05791 [GPT-5-Codex]             elseif isMoving then
05792 [GPT-5-Codex]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Front and 3) or 2)
05793 [GPT-5-Codex]                 local walkFrame = math.floor(animTick / 7) % frameCount
05794 [GPT-5-Codex]                 debugWalkFrame = walkFrame
05795 [GPT-5-Codex]                 if walkFrame == 0 and warriorWalk1Front then
05796 [GPT-5-Codex]                     sprite = warriorWalk1Front
05797 [GPT-5-Codex]                     debugSpriteLabel = "F1"
05798 [GPT-5-Codex]                 elseif walkFrame == 1 and warriorWalk2Front then
05799 [GPT-5-Codex]                     sprite = warriorWalk2Front
05800 [GPT-5-Codex]                     debugSpriteLabel = "F2"
05801 [GPT-5-Codex]                 elseif walkFrame == 2 and warriorWalk3Front then
05802 [GPT-5-Codex]                     sprite = warriorWalk3Front
05803 [GPT-5-Codex]                     debugSpriteLabel = "F3"
05804 [GPT-5-Codex]                 else
05805 [GPT-5-Codex]                     sprite = warriorFront  -- Fallback
05806 [GPT-5-Codex]                     debugSpriteLabel = "F0"
05807 [GPT-5-Codex]                 end
05808 [GPT-5-Codex]             else
05809 [GPT-5-Codex]                 sprite = warriorFront
05810 [GPT-5-Codex]                 debugSpriteLabel = "F0"
05811 [GPT-5-Codex]             end
05812 [GPT-5-Codex]         elseif view == 2 then
05813 [GPT-5-Codex]             -- Back view
05814 [GPT-5-Codex]             if DEBUG_CYCLE_VIEW then
05815 [GPT-5-Codex]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Back and 3) or 2)
05816 [GPT-5-Codex]                 local walkFrame = math.floor(animTick / 7) % frameCount
05817 [GPT-5-Codex]                 debugWalkFrame = walkFrame
05818 [GPT-5-Codex]                 if walkFrame == 0 and warriorWalk1Back then
05819 [GPT-5-Codex]                     sprite = warriorWalk1Back
05820 [GPT-5-Codex]                     debugSpriteLabel = "B1"
05821 [GPT-5-Codex]                 elseif walkFrame == 1 and warriorWalk2Back then
05822 [GPT-5-Codex]                     sprite = warriorWalk2Back
05823 [GPT-5-Codex]                     debugSpriteLabel = "B2"
05824 [GPT-5-Codex]                 elseif walkFrame == 2 and warriorWalk3Back then
05825 [GPT-5-Codex]                     sprite = warriorWalk3Back
05826 [GPT-5-Codex]                     debugSpriteLabel = "B3"
05827 [GPT-5-Codex]                 else
05828 [GPT-5-Codex]                     sprite = warriorBack
05829 [GPT-5-Codex]                     debugSpriteLabel = "B0"
05830 [GPT-5-Codex]                 end
05831 [GPT-5-Codex]             elseif isMoving then
05832 [GPT-5-Codex]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3Back and 3) or 2)
05833 [GPT-5-Codex]                 local walkFrame = math.floor(animTick / 7) % frameCount
05834 [GPT-5-Codex]                 debugWalkFrame = walkFrame
05835 [GPT-5-Codex]                 if walkFrame == 0 and warriorWalk1Back then
05836 [GPT-5-Codex]                     sprite = warriorWalk1Back
05837 [GPT-5-Codex]                     debugSpriteLabel = "B1"
05838 [GPT-5-Codex]                 elseif walkFrame == 1 and warriorWalk2Back then
05839 [GPT-5-Codex]                     sprite = warriorWalk2Back
05840 [GPT-5-Codex]                     debugSpriteLabel = "B2"
05841 [GPT-5-Codex]                 elseif walkFrame == 2 and warriorWalk3Back then
05842 [GPT-5-Codex]                     sprite = warriorWalk3Back
05843 [GPT-5-Codex]                     debugSpriteLabel = "B3"
05844 [GPT-5-Codex]                 else
05845 [GPT-5-Codex]                     sprite = warriorBack  -- Fallback
05846 [GPT-5-Codex]                     debugSpriteLabel = "B0"
05847 [GPT-5-Codex]                 end
05848 [GPT-5-Codex]             else
05849 [GPT-5-Codex]                 sprite = warriorBack
05850 [GPT-5-Codex]                 debugSpriteLabel = "B0"
05851 [GPT-5-Codex]             end
05852 [GPT-5-Codex]         elseif view == 3 then
05853 [GPT-5-Codex]             -- Left side view - show LEFT-facing sprites
05854 [GPT-5-Codex]             if isMoving then
05855 [GPT-5-Codex]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3 and 3) or 2)
05856 [GPT-5-Codex]                 local walkFrame = math.floor(animTick / 7) % frameCount
05857 [GPT-5-Codex]                 debugWalkFrame = walkFrame
05858 [GPT-5-Codex]                 if walkFrame == 0 and warriorWalk1 then
05859 [GPT-5-Codex]                     sprite = warriorWalk1
05860 [GPT-5-Codex]                     debugSpriteLabel = "L1"
05861 [GPT-5-Codex]                 elseif walkFrame == 1 and warriorWalk2 then
05862 [GPT-5-Codex]                     sprite = warriorWalk2
05863 [GPT-5-Codex]                     debugSpriteLabel = "L2"
05864 [GPT-5-Codex]                 elseif walkFrame == 2 and warriorWalk3 then
05865 [GPT-5-Codex]                     sprite = warriorWalk3
05866 [GPT-5-Codex]                     debugSpriteLabel = "L3"
05867 [GPT-5-Codex]                 else
05868 [GPT-5-Codex]                     sprite = warriorLeft  -- Fallback
05869 [GPT-5-Codex]                     debugSpriteLabel = "L0"
05870 [GPT-5-Codex]                 end
05871 [GPT-5-Codex]             else
05872 [GPT-5-Codex]                 sprite = warriorLeft
05873 [GPT-5-Codex]                 debugSpriteLabel = "L0"
05874 [GPT-5-Codex]             end
05875 [GPT-5-Codex]         else
05876 [GPT-5-Codex]             -- Right side view (view == 1) - show RIGHT-facing sprites
05877 [GPT-5-Codex]             if isMoving then
05878 [GPT-5-Codex]                 local frameCount = DEBUG_FORCE_WALK_FRAMES or ((warriorWalk3R and 3) or 2)
05879 [GPT-5-Codex]                 local walkFrame = math.floor(animTick / 7) % frameCount
05880 [GPT-5-Codex]                 debugWalkFrame = walkFrame
05881 [GPT-5-Codex]                 if walkFrame == 0 and warriorWalk1R then
05882 [GPT-5-Codex]                     sprite = warriorWalk1R
05883 [GPT-5-Codex]                     debugSpriteLabel = "R1"
05884 [GPT-5-Codex]                 elseif walkFrame == 1 and warriorWalk2R then
05885 [GPT-5-Codex]                     sprite = warriorWalk2R
05886 [GPT-5-Codex]                     debugSpriteLabel = "R2"
05887 [GPT-5-Codex]                 elseif walkFrame == 2 and warriorWalk3R then
05888 [GPT-5-Codex]                     sprite = warriorWalk3R
05889 [GPT-5-Codex]                     debugSpriteLabel = "R3"
05890 [GPT-5-Codex]                 else
05891 [GPT-5-Codex]                     sprite = warriorRight  -- Fallback
05892 [GPT-5-Codex]                     debugSpriteLabel = "R0"
05893 [GPT-5-Codex]                 end
05894 [GPT-5-Codex]             else
05895 [GPT-5-Codex]                 sprite = warriorRight
05896 [GPT-5-Codex]                 debugSpriteLabel = "R0"
05897 [GPT-5-Codex]             end
05898 [GPT-5-Codex]         end
05899 [GPT-5-Codex] 
05900 [GPT-5-Codex]         -- Draw sprite scaled based on distance
05901 [GPT-5-Codex]         if sprite and sprite.height then
05902 [GPT-5-Codex]             -- Calculate scale to fit desired height on screen
05903 [GPT-5-Codex]             local desiredHeight = size  -- size is based on distance
05904 [GPT-5-Codex]             local scale = safeDivide(desiredHeight, sprite.height, "renderScale")
05905 [GPT-5-Codex] 
05906 [GPT-5-Codex]             -- Calculate draw position (centered horizontally)
05907 [GPT-5-Codex]             local scaledWidth = sprite.width * scale
05908 [GPT-5-Codex]             local scaledHeight = sprite.height * scale
05909 [GPT-5-Codex]             local drawX = screenX - math.floor(scaledWidth / 2)
05910 [GPT-5-Codex] 
05911 [GPT-5-Codex]             -- Position sprite with feet on ground level
05912 [GPT-5-Codex]             -- Ground level = HORIZON + size (matches wall bottoms)
05913 [GPT-5-Codex]             local groundY = HORIZON + size
05914 [GPT-5-Codex]             if groundY > 240 then groundY = 240 end
05915 [GPT-5-Codex]             local drawY = groundY - math.floor(scaledHeight)
05916 [GPT-5-Codex] 
05917 [GPT-5-Codex]             if DEBUG_WALK_OFFSET and debugWalkFrame ~= nil then
05918 [GPT-5-Codex]                 if debugWalkFrame == 1 then
05919 [GPT-5-Codex]                     drawX = drawX + 6
05920 [GPT-5-Codex]                     drawY = drawY + 3
05921 [GPT-5-Codex]                 end
05922 [GPT-5-Codex]             end
05923 [GPT-5-Codex] 
05924 [GPT-5-Codex]             vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, flipFlag)
05925 [GPT-5-Codex] 
05926 [GPT-5-Codex]             if DEBUG_SHOW_WALK_INFO then
05927 [GPT-5-Codex]                 local info = "V:" .. tostring(view) .. " WF:" .. tostring(debugWalkFrame or -1) .. " S:" .. debugSpriteLabel
05928 [GPT-5-Codex]                 setFontCached(vmupro.text.FONT_TINY_6x8)
05929 [GPT-5-Codex]                 drawUiText(info, 5, 220, COLOR_WHITE, COLOR_BLACK)
05930 [GPT-5-Codex]             end
05931 [GPT-5-Codex] 
05932 [GPT-5-Codex]             -- Draw health bar above soldier if alive and has hp data
05933 [GPT-5-Codex]             if spriteData and spriteData.hp and spriteData.alive then
05934 [GPT-5-Codex]                 local barWidth = math.floor(scaledWidth * 0.8)
05935 [GPT-5-Codex]                 local barHeight = math.max(3, math.floor(4 / dist * 2))
05936 [GPT-5-Codex]                 local barX = drawX + math.floor((scaledWidth - barWidth) / 2)
05937 [GPT-5-Codex]                 local barY = drawY - barHeight - 2
05938 [GPT-5-Codex] 
05939 [GPT-5-Codex]                 -- Background (dark red)
05940 [GPT-5-Codex]                 vmupro.graphics.drawFillRect(barX, barY, barX + barWidth, barY + barHeight, COLOR_MAROON)
05941 [GPT-5-Codex] 
05942 [GPT-5-Codex]                 -- Health portion (bright red)
05943 [GPT-5-Codex]                 local healthWidth = math.floor(barWidth * (spriteData.hp / ENEMY_MAX_HP))
05944 [GPT-5-Codex]                 if healthWidth > 0 then
05945 [GPT-5-Codex]                     vmupro.graphics.drawFillRect(barX, barY, barX + healthWidth, barY + barHeight, COLOR_RED)
05946 [GPT-5-Codex]                 end
05947 [GPT-5-Codex]             end
05948 [GPT-5-Codex]         end
05949 [GPT-5-Codex] 
05950 [GPT-5-Codex]     elseif stype == 6 then
05951 [GPT-5-Codex]         -- Knight Guard using real sprites
05952 [GPT-5-Codex]         -- Determine view: 0=front, 1=right, 2=back, 3=left
05953 [GPT-5-Codex]         local view = 0
05954 [GPT-5-Codex]         if viewAngle then
05955 [GPT-5-Codex]             if viewAngle >= -8 and viewAngle <= 8 then view = 0
05956 [GPT-5-Codex]             elseif viewAngle > 8 and viewAngle < 24 then view = 3
05957 [GPT-5-Codex]             elseif viewAngle >= 24 or viewAngle <= -24 then view = 2
05958 [GPT-5-Codex]             else view = 1 end
05959 [GPT-5-Codex]         end
05960 [GPT-5-Codex] 
05961 [GPT-5-Codex]         -- Select appropriate sprite based on view
05962 [GPT-5-Codex]         local sprite = knightFront
05963 [GPT-5-Codex]         local flipFlag = vmupro.sprite.kImageUnflipped
05964 [GPT-5-Codex]         if view == 0 then
05965 [GPT-5-Codex]             sprite = knightFront
05966 [GPT-5-Codex]         elseif view == 2 then
05967 [GPT-5-Codex]             sprite = knightBack
05968 [GPT-5-Codex]         elseif view == 3 then
05969 [GPT-5-Codex]             sprite = knightLeft
05970 [GPT-5-Codex]         else
05971 [GPT-5-Codex]             sprite = knightRight
05972 [GPT-5-Codex]         end
05973 [GPT-5-Codex] 
05974 [GPT-5-Codex]         -- Draw sprite scaled based on distance
05975 [GPT-5-Codex]         if sprite and sprite.height then
05976 [GPT-5-Codex]             -- Calculate scale to fit desired height on screen
05977 [GPT-5-Codex]             local desiredHeight = size  -- size is based on distance
05978 [GPT-5-Codex]             local scale = safeDivide(desiredHeight, sprite.height, "renderScale")
05979 [GPT-5-Codex] 
05980 [GPT-5-Codex]             -- Calculate draw position (centered horizontally)
05981 [GPT-5-Codex]             local scaledWidth = sprite.width * scale
05982 [GPT-5-Codex]             local scaledHeight = sprite.height * scale
05983 [GPT-5-Codex]             local drawX = screenX - math.floor(scaledWidth / 2)
05984 [GPT-5-Codex] 
05985 [GPT-5-Codex]             -- Position sprite with feet on ground level
05986 [GPT-5-Codex]             local groundY = HORIZON + size
05987 [GPT-5-Codex]             if groundY > 240 then groundY = 240 end
05988 [GPT-5-Codex]             local drawY = groundY - math.floor(scaledHeight)
05989 [GPT-5-Codex] 
05990 [GPT-5-Codex]             vmupro.sprite.drawScaled(sprite, drawX, drawY, scale, scale, flipFlag)
05991 [GPT-5-Codex]         end
05992 [GPT-5-Codex] 
05993 [GPT-5-Codex]     elseif stype == 7 then
05994 [GPT-5-Codex]         -- Health vial pickup (uses potion sprite)
05995 [GPT-5-Codex]         if spriteData and spriteData.collected then
05996 [GPT-5-Codex]             return  -- Don't draw collected vials
05997 [GPT-5-Codex]         end
05998 [GPT-5-Codex] 
05999 [GPT-5-Codex]         if potionSprite and potionSprite.height then
06000 [GPT-5-Codex]             -- Scale potion to fit on ground
06001 [GPT-5-Codex]             local desiredHeight = size * 0.6  -- Smaller than characters
06002 [GPT-5-Codex]             local scale = desiredHeight / potionSprite.height
06003 [GPT-5-Codex] 
06004 [GPT-5-Codex]             local scaledWidth = potionSprite.width * scale
06005 [GPT-5-Codex]             local scaledHeight = potionSprite.height * scale
06006 [GPT-5-Codex]             local drawX = screenX - math.floor(scaledWidth / 2)
06007 [GPT-5-Codex] 
06008 [GPT-5-Codex]             -- Position on ground
06009 [GPT-5-Codex]             local groundY = HORIZON + size
06010 [GPT-5-Codex]             if groundY > 240 then groundY = 240 end
06011 [GPT-5-Codex]             local drawY = groundY - math.floor(scaledHeight)
06012 [GPT-5-Codex] 
06013 [GPT-5-Codex]             vmupro.sprite.drawScaled(potionSprite, drawX, drawY, scale, scale, vmupro.sprite.kImageUnflipped)
06014 [GPT-5-Codex]         end
06015 [GPT-5-Codex]     end
06016 [GPT-5-Codex] end
06017 [GPT-5-Codex] 
06018 [GPT-5-Codex] local function drawRoofBackdrop()
06019 [GPT-5-Codex]     local roofBottom = HORIZON - 1
06020 [GPT-5-Codex]     if roofBottom < 0 then
06021 [GPT-5-Codex]         return
06022 [GPT-5-Codex]     end
06023 [GPT-5-Codex] 
06024 [GPT-5-Codex]     -- Single-image ceiling over the full map roof.
06025 [GPT-5-Codex]     -- Map anchors are computed in camera space so this behaves like a world roof,
06026 [GPT-5-Codex]     -- not a static screen overlay.
06027 [GPT-5-Codex]     local roofTex = nil
06028 [GPT-5-Codex]     if not DEBUG_DISABLE_WALL_TEXTURE and not DEBUG_DISABLE_ROOF_TEXTURE then
06029 [GPT-5-Codex]         roofTex = wallRoof or wallBrick
06030 [GPT-5-Codex]     end
06031 [GPT-5-Codex]     if roofTex and validateSprite(roofTex, "drawRoofBackdrop") then
06032 [GPT-5-Codex]         local texW = roofTex.width or 128
06033 [GPT-5-Codex]         local texH = roofTex.height or 128
06034 [GPT-5-Codex]         if texW < 1 then texW = 1 end
06035 [GPT-5-Codex]         if texH < 1 then texH = 1 end
06036 [GPT-5-Codex] 
06037 [GPT-5-Codex]         local mapW = 16
06038 [GPT-5-Codex]         local mapH = 16
06039 [GPT-5-Codex]         if map and #map > 0 then
06040 [GPT-5-Codex]             mapH = #map
06041 [GPT-5-Codex]             if map[1] and #map[1] > 0 then
06042 [GPT-5-Codex]                 mapW = #map[1]
06043 [GPT-5-Codex]             end
06044 [GPT-5-Codex]         end
06045 [GPT-5-Codex]         if mapW < 1 then mapW = 16 end
06046 [GPT-5-Codex]         if mapH < 1 then mapH = 16 end
06047 [GPT-5-Codex] 
06048 [GPT-5-Codex]         -- Stretch one image across full map space (large stretch by design).
06049 [GPT-5-Codex]         local stretchPxPerTileX = 32
06050 [GPT-5-Codex]         local stretchPxPerTileY = 24
06051 [GPT-5-Codex]         local targetW = 240 + (mapW * stretchPxPerTileX)
06052 [GPT-5-Codex]         local targetH = (roofBottom + 1) + (mapH * stretchPxPerTileY)
06053 [GPT-5-Codex]         local panRangeX = targetW - 240
06054 [GPT-5-Codex]         local panRangeY = targetH - (roofBottom + 1)
06055 [GPT-5-Codex]         if panRangeX < 0 then panRangeX = 0 end
06056 [GPT-5-Codex]         if panRangeY < 0 then panRangeY = 0 end
06057 [GPT-5-Codex] 
06058 [GPT-5-Codex]         local ang = ((pdir or 0) % 64) * (renderCfg.twoPi / 64)
06059 [GPT-5-Codex]         local ca = math.cos(ang)
06060 [GPT-5-Codex]         local sa = math.sin(ang)
06061 [GPT-5-Codex] 
06062 [GPT-5-Codex]         -- Camera-space axes:
06063 [GPT-5-Codex]         -- forward = dot(world, viewDir), lateral = dot(world, rightDir)
06064 [GPT-5-Codex]         local function projectForward(x, y)
06065 [GPT-5-Codex]             return (x * ca) + (y * sa)
06066 [GPT-5-Codex]         end
06067 [GPT-5-Codex]         local function projectLateral(x, y)
06068 [GPT-5-Codex]             return (-x * sa) + (y * ca)
06069 [GPT-5-Codex]         end
06070 [GPT-5-Codex] 
06071 [GPT-5-Codex]         local c1x, c1y = 0, 0
06072 [GPT-5-Codex]         local c2x, c2y = mapW, 0
06073 [GPT-5-Codex]         local c3x, c3y = 0, mapH
06074 [GPT-5-Codex]         local c4x, c4y = mapW, mapH
06075 [GPT-5-Codex]         local f1, f2 = projectForward(c1x, c1y), projectForward(c2x, c2y)
06076 [GPT-5-Codex]         local f3, f4 = projectForward(c3x, c3y), projectForward(c4x, c4y)
06077 [GPT-5-Codex]         local l1, l2 = projectLateral(c1x, c1y), projectLateral(c2x, c2y)
06078 [GPT-5-Codex]         local l3, l4 = projectLateral(c3x, c3y), projectLateral(c4x, c4y)
06079 [GPT-5-Codex] 
06080 [GPT-5-Codex]         local minFwd = math.min(f1, f2, f3, f4)
06081 [GPT-5-Codex]         local maxFwd = math.max(f1, f2, f3, f4)
06082 [GPT-5-Codex]         local minLat = math.min(l1, l2, l3, l4)
06083 [GPT-5-Codex]         local maxLat = math.max(l1, l2, l3, l4)
06084 [GPT-5-Codex] 
06085 [GPT-5-Codex]         local curFwd = projectForward((px or 0), (py or 0))
06086 [GPT-5-Codex]         local curLat = projectLateral((px or 0), (py or 0))
06087 [GPT-5-Codex]         local fwdSpan = maxFwd - minFwd
06088 [GPT-5-Codex]         local latSpan = maxLat - minLat
06089 [GPT-5-Codex]         if fwdSpan < 0.001 then fwdSpan = 0.001 end
06090 [GPT-5-Codex]         if latSpan < 0.001 then latSpan = 0.001 end
06091 [GPT-5-Codex] 
06092 [GPT-5-Codex]         local nx = safeDivide((curLat - minLat), latSpan, "drawRoofBackdrop_nx")
06093 [GPT-5-Codex]         local ny = safeDivide((curFwd - minFwd), fwdSpan, "drawRoofBackdrop_ny")
06094 [GPT-5-Codex]         if nx < 0 then nx = 0 elseif nx > 1 then nx = 1 end
06095 [GPT-5-Codex]         if ny < 0 then ny = 0 elseif ny > 1 then ny = 1 end
06096 [GPT-5-Codex] 
06097 [GPT-5-Codex]         local drawX = -math.floor((nx * panRangeX) + 0.5)
06098 [GPT-5-Codex]         local drawY = -math.floor((ny * panRangeY) + 0.5)
06099 [GPT-5-Codex] 
06100 [GPT-5-Codex]         local scaleX = safeDivide(targetW, texW, "drawRoofBackdrop_scaleX")
06101 [GPT-5-Codex]         local scaleY = safeDivide(targetH, texH, "drawRoofBackdrop_scaleY")
06102 [GPT-5-Codex]         if safeScale(roofTex, scaleX, scaleY, "drawRoofBackdrop") then
06103 [GPT-5-Codex]             vmupro.sprite.drawScaled(roofTex, drawX, drawY, scaleX, scaleY, vmupro.sprite.kImageUnflipped)
06104 [GPT-5-Codex]         else
06105 [GPT-5-Codex]             vmupro.graphics.drawFillRect(0, 0, 239, roofBottom, COLOR_DARK_GRAY)
06106 [GPT-5-Codex]         end
06107 [GPT-5-Codex]     else
06108 [GPT-5-Codex]         vmupro.graphics.drawFillRect(0, 0, 239, roofBottom, COLOR_DARK_GRAY)
06109 [GPT-5-Codex]     end
06110 [GPT-5-Codex] 
06111 [GPT-5-Codex]     -- Keep a strong horizon seam for depth readability against fog.
06112 [GPT-5-Codex]     vmupro.graphics.drawLine(0, roofBottom, 239, roofBottom, COLOR_BLACK)
06113 [GPT-5-Codex] end
06114 [GPT-5-Codex] 
06115 [GPT-5-Codex] local function renderGameFrame()
06116 [GPT-5-Codex]     recoverPlayerFromWallPenetration()
06117 [GPT-5-Codex]     -- Keep world rendering live while menu is open for real-time tuning.
06118 [GPT-5-Codex]     local freezeMenuView = false
06119 [GPT-5-Codex]     if not freezeMenuView then
06120 [GPT-5-Codex]         -- Game rendering
06121 [GPT-5-Codex]         vmupro.graphics.clear(COLOR_CEILING)
06122 [GPT-5-Codex]         drawRoofBackdrop()
06123 [GPT-5-Codex]         -- Draw floor after roof so any sprite-scale bleed never reaches the floor.
06124 [GPT-5-Codex]         vmupro.graphics.drawFillRect(0, HORIZON, 240, VIEWPORT_H, COLOR_FLOOR)
06125 [GPT-5-Codex]         vmupro.graphics.drawFillRect(0, VIEWPORT_H, 240, 240, COLOR_BLACK)
06126 [GPT-5-Codex] 
06127 [GPT-5-Codex] 
06128 [GPT-5-Codex]         -- Single renderer runtime path: EXP-H only.
06129 [GPT-5-Codex]         lockRendererMode()
06130 [GPT-5-Codex]         renderWallsExperimentalHybrid()
06131 [GPT-5-Codex] 
06132 [GPT-5-Codex]     if not DEBUG_SKIP_SPRITES and not showMenu then
06133 [GPT-5-Codex]         if frameCount - spriteOrderCacheFrame >= 8 or #spriteOrderCache == 0 then
06134 [GPT-5-Codex]             local spriteOrder = {}
06135 [GPT-5-Codex]             local count = 0
06136 [GPT-5-Codex]             for i = 1, #sprites do
06137 [GPT-5-Codex]                 local s = sprites[i]
06138 [GPT-5-Codex]                 if not s then
06139 [GPT-5-Codex]                     goto continue_sprite_build
06140 [GPT-5-Codex]                 end
06141 [GPT-5-Codex]                 local skip = (DEBUG_DISABLE_ENEMIES and isEnemyType(s.t))
06142 [GPT-5-Codex]                     or (DEBUG_DISABLE_PROPS and isPropType(s.t))
06143 [GPT-5-Codex]                 if not skip then
06144 [GPT-5-Codex]                     local sdx, sdy = s.x - px, s.y - py
06145 [GPT-5-Codex]                     local distSq = sdx * sdx + sdy * sdy
06146 [GPT-5-Codex]                     local maxSq = SPRITE_MAX_DIST_SQ
06147 [GPT-5-Codex]                     if isEnemyType(s.t) then
06148 [GPT-5-Codex]                         maxSq = ENEMY_RENDER_DIST_SQ
06149 [GPT-5-Codex]                     elseif s.t == 7 then
06150 [GPT-5-Codex]                         maxSq = ITEM_RENDER_DIST_SQ
06151 [GPT-5-Codex]                     elseif isPropType(s.t) then
06152 [GPT-5-Codex]                         maxSq = PROP_RENDER_DIST_SQ
06153 [GPT-5-Codex]                     end
06154 [GPT-5-Codex]                     if distSq <= maxSq then
06155 [GPT-5-Codex]                         count = count + 1
06156 [GPT-5-Codex]                         spriteOrder[count] = {idx = i, dist = distSq}
06157 [GPT-5-Codex]                     end
06158 [GPT-5-Codex]                 end
06159 [GPT-5-Codex]                 ::continue_sprite_build::
06160 [GPT-5-Codex]             end
06161 [GPT-5-Codex]             if count > 1 then
06162 [GPT-5-Codex]                 table.sort(spriteOrder, function(a, b) return a.dist > b.dist end)
06163 [GPT-5-Codex]             end
06164 [GPT-5-Codex]             spriteOrderCache = spriteOrder
06165 [GPT-5-Codex]             spriteOrderCacheFrame = frameCount
06166 [GPT-5-Codex]         end
06167 [GPT-5-Codex] 
06168 [GPT-5-Codex]         for i = 1, #spriteOrderCache do
06169 [GPT-5-Codex]             local s = sprites[spriteOrderCache[i].idx]
06170 [GPT-5-Codex]             if not s then
06171 [GPT-5-Codex]                 goto continue_sprite
06172 [GPT-5-Codex]             end
06173 [GPT-5-Codex]             if DEBUG_DISABLE_ENEMIES and isEnemyType(s.t) then
06174 [GPT-5-Codex]                 goto continue_sprite
06175 [GPT-5-Codex]             end
06176 [GPT-5-Codex]             if DEBUG_DISABLE_PROPS and isPropType(s.t) then
06177 [GPT-5-Codex]                 goto continue_sprite
06178 [GPT-5-Codex]             end
06179 [GPT-5-Codex]             -- Skip dead soldiers
06180 [GPT-5-Codex]             if s.t == 5 and s.alive == false and not s.dying then
06181 [GPT-5-Codex]                 goto continue_sprite
06182 [GPT-5-Codex]             end
06183 [GPT-5-Codex]             local sdx, sdy = s.x - px, s.y - py
06184 [GPT-5-Codex]             local distSq = sdx * sdx + sdy * sdy
06185 [GPT-5-Codex]             local maxSq = SPRITE_MAX_DIST_SQ
06186 [GPT-5-Codex]             if isEnemyType(s.t) then
06187 [GPT-5-Codex]                 maxSq = ENEMY_RENDER_DIST_SQ
06188 [GPT-5-Codex]             elseif s.t == 7 then
06189 [GPT-5-Codex]                 maxSq = ITEM_RENDER_DIST_SQ
06190 [GPT-5-Codex]             elseif isPropType(s.t) then
06191 [GPT-5-Codex]                 maxSq = PROP_RENDER_DIST_SQ
06192 [GPT-5-Codex]             end
06193 [GPT-5-Codex]             if distSq <= maxSq then
06194 [GPT-5-Codex]                 local sdist = math.sqrt(distSq)
06195 [GPT-5-Codex]                 local visible = true
06196 [GPT-5-Codex]                 if sdist > SPRITE_VIS_DIST then
06197 [GPT-5-Codex]                     visible = false
06198 [GPT-5-Codex]                 else
06199 [GPT-5-Codex]                     visible = isVisible(s.x, s.y, s)
06200 [GPT-5-Codex]                 end
06201 [GPT-5-Codex]                 if sdist > 0.3 and visible then
06202 [GPT-5-Codex]                 local sAngle = 0
06203 [GPT-5-Codex]                 if sdx ~= 0 then
06204 [GPT-5-Codex]                     sAngle = math.atan(sdy / sdx)
06205 [GPT-5-Codex]                     if sdx < 0 then sAngle = sAngle + 3.14159 end
06206 [GPT-5-Codex]                 else
06207 [GPT-5-Codex]                     sAngle = sdy > 0 and 1.5708 or -1.5708
06208 [GPT-5-Codex]                 end
06209 [GPT-5-Codex]                 local sDir = math.floor(sAngle * 64 / 6.28318) % 64
06210 [GPT-5-Codex]                 local viewDiff = (sDir - pdir) % 64
06211 [GPT-5-Codex]                 if viewDiff > 32 then viewDiff = viewDiff - 64 end
06212 [GPT-5-Codex]                 if viewDiff >= -6 and viewDiff <= 6 then
06213 [GPT-5-Codex]                     if isExpRenderer() then
06214 [GPT-5-Codex]                         local dir = pdir % 64
06215 [GPT-5-Codex]                         local cosDir = cosTable[dir]
06216 [GPT-5-Codex]                         local sinDir = sinTable[dir]
06217 [GPT-5-Codex]                         local relX = (sdx * sinDir - sdy * cosDir)
06218 [GPT-5-Codex]                         local relY = (sdx * cosDir + sdy * sinDir)
06219 [GPT-5-Codex]                         if relY > 0.05 then
06220 [GPT-5-Codex]                             local sx = relX / relY
06221 [GPT-5-Codex]                             local screenX = math.floor(120 + sx * 120)
06222 [GPT-5-Codex]                             local occluded = false
06223 [GPT-5-Codex]                             for ox = -2, 2 do
06224 [GPT-5-Codex]                                 local cx = screenX + ox
06225 [GPT-5-Codex]                                 if cx >= 0 and cx <= 239 then
06226 [GPT-5-Codex]                                     local wallDist = expDepthBuf[cx]
06227 [GPT-5-Codex]                                     if wallDist and relY > wallDist then
06228 [GPT-5-Codex]                                         occluded = true
06229 [GPT-5-Codex]                                         break
06230 [GPT-5-Codex]                                     end
06231 [GPT-5-Codex]                                 end
06232 [GPT-5-Codex]                             end
06233 [GPT-5-Codex]                             if occluded then
06234 [GPT-5-Codex]                                 goto continue_sprite
06235 [GPT-5-Codex]                             end
06236 [GPT-5-Codex]                         end
06237 [GPT-5-Codex]                     end
06238 [GPT-5-Codex]                     -- Calculate view angle for guards (angle from guard's POV)
06239 [GPT-5-Codex]                     local guardViewAngle = nil
06240 [GPT-5-Codex]                     if (s.t == 5 or s.t == 6) and s.dir then
06241 [GPT-5-Codex]                         -- Angle player is approaching from relative to guard's facing
06242 [GPT-5-Codex]                         local approachDir = (sDir + 32) % 64  -- Opposite of sDir
06243 [GPT-5-Codex]                         guardViewAngle = (approachDir - s.dir) % 64
06244 [GPT-5-Codex]                         if guardViewAngle > 32 then guardViewAngle = guardViewAngle - 64 end
06245 [GPT-5-Codex]                     end
06246 [GPT-5-Codex]                     drawSprite(120 + viewDiff * 20, sdist, s.t, guardViewAngle, s.anim, s)
06247 [GPT-5-Codex]                 end
06248 [GPT-5-Codex]                 end
06249 [GPT-5-Codex]             end
06250 [GPT-5-Codex]             ::continue_sprite::
06251 [GPT-5-Codex]             end
06252 [GPT-5-Codex]         end
06253 [GPT-5-Codex] 
06254 [GPT-5-Codex]         if SHOW_MINIMAP and not showMenu then
06255 [GPT-5-Codex]         for my = 0, 15 do
06256 [GPT-5-Codex]             for mx = 0, 15 do
06257 [GPT-5-Codex]                 if map[my + 1][mx + 1] > 0 then
06258 [GPT-5-Codex]                     vmupro.graphics.drawFillRect(5 + mx * 4, 5 + my * 4, 8 + mx * 4, 8 + my * 4, COLOR_STONE_D)
06259 [GPT-5-Codex]                 end
06260 [GPT-5-Codex]             end
06261 [GPT-5-Codex]         end
06262 [GPT-5-Codex]         local ppx = 5 + math.floor(px * 4)
06263 [GPT-5-Codex]         local ppy = 5 + math.floor(py * 4)
06264 [GPT-5-Codex]         vmupro.graphics.drawFillRect(ppx - 1, ppy - 1, ppx + 1, ppy + 1, COLOR_RED)
06265 [GPT-5-Codex]         vmupro.graphics.drawLine(ppx, ppy, ppx + math.floor(cosTable[pdir % 64] * 4), ppy + math.floor(sinTable[pdir % 64] * 4), COLOR_YELLOW)
06266 [GPT-5-Codex]         end
06267 [GPT-5-Codex] 
06268 [GPT-5-Codex]         -- Draw attack sword swing (always, even if effects are disabled)
06269 [GPT-5-Codex]         if isAttacking > 0 and not showMenu then
06270 [GPT-5-Codex]         if #swordAttack > 0 then
06271 [GPT-5-Codex]             local total = (attackTotalFrames > 0) and attackTotalFrames or (#swordAttack * 2)
06272 [GPT-5-Codex]             local frameHold = math.max(1, math.floor(total / #swordAttack))
06273 [GPT-5-Codex]             local frameIndex = math.floor((total - isAttacking) / frameHold) + 1
06274 [GPT-5-Codex]             if frameIndex < 1 then frameIndex = 1 end
06275 [GPT-5-Codex]             if frameIndex > #swordAttack then frameIndex = #swordAttack end
06276 [GPT-5-Codex]             local sprite = swordAttack[frameIndex]
06277 [GPT-5-Codex]             if sprite then
06278 [GPT-5-Codex]                 local drawX = 140
06279 [GPT-5-Codex]                 local drawY = 240 - sprite.height + 30
06280 [GPT-5-Codex]                 vmupro.sprite.draw(sprite, drawX, drawY, vmupro.sprite.kImageUnflipped)
06281 [GPT-5-Codex]             end
06282 [GPT-5-Codex]         else
06283 [GPT-5-Codex]             local swingAngle = (10 - isAttacking) * 9  -- 0 to 90 degrees
06284 [GPT-5-Codex]             local swordLen = 80
06285 [GPT-5-Codex]             local swordX = 180 + math.floor(math.sin(swingAngle * 0.0174) * 40)
06286 [GPT-5-Codex]             local swordY = 180 - math.floor(math.cos(swingAngle * 0.0174) * 60)
06287 [GPT-5-Codex]             -- Sword blade
06288 [GPT-5-Codex]             vmupro.graphics.drawFillRect(swordX - 4, swordY - swordLen, swordX + 4, swordY, COLOR_LIGHT_GRAY)
06289 [GPT-5-Codex]             vmupro.graphics.drawFillRect(swordX - 2, swordY - swordLen - 10, swordX + 2, swordY - swordLen, COLOR_LIGHT_GRAY)
06290 [GPT-5-Codex]             -- Sword hilt
06291 [GPT-5-Codex]             vmupro.graphics.drawFillRect(swordX - 12, swordY - 4, swordX + 12, swordY + 4, COLOR_BROWN)
06292 [GPT-5-Codex]             vmupro.graphics.drawFillRect(swordX - 6, swordY, swordX + 6, swordY + 20, COLOR_DARK_BROWN)
06293 [GPT-5-Codex]         end
06294 [GPT-5-Codex]         end
06295 [GPT-5-Codex] 
06296 [GPT-5-Codex]         -- Draw block shield (animated raise)
06297 [GPT-5-Codex]         if blockAnim > 0 and not showMenu then
06298 [GPT-5-Codex]         local frameIndex = blockAnim
06299 [GPT-5-Codex]         if frameIndex < 1 then frameIndex = 1 end
06300 [GPT-5-Codex]         if frameIndex > #shieldRaise then frameIndex = #shieldRaise end
06301 [GPT-5-Codex]         local sprite = shieldRaise[frameIndex]
06302 [GPT-5-Codex]         if sprite then
06303 [GPT-5-Codex]             vmupro.sprite.draw(sprite, 0, 0, vmupro.sprite.kImageUnflipped)
06304 [GPT-5-Codex]         end
06305 [GPT-5-Codex]     end
06306 [GPT-5-Codex]     end
06307 [GPT-5-Codex] 
06308 [GPT-5-Codex]     -- Draw menu
06309 [GPT-5-Codex]     if showMenu then
06310 [GPT-5-Codex]         if inOptionsMenu then
06311 [GPT-5-Codex]             -- Options submenu
06312 [GPT-5-Codex]             drawUiPanel(40, 30, 200, 230, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
06313 [GPT-5-Codex]             drawUiPanel(45, 35, 195, 225, COLOR_DARK_GRAY, COLOR_GRAY)
06314 [GPT-5-Codex]             -- Title bar
06315 [GPT-5-Codex]             drawUiPanel(50, 40, 190, 60, COLOR_MAROON, COLOR_WHITE)
06316 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_SMALL)
06317 [GPT-5-Codex]             if inGameDebugMenu then
06318 [GPT-5-Codex]                 drawMenuText("DEBUG", 92, 44, COLOR_WHITE)
06319 [GPT-5-Codex]                 local items = buildDebugMenuItems()
06320 [GPT-5-Codex]                 local visibleCount = 10
06321 [GPT-5-Codex]                 local sel = titleDebugSelection
06322 [GPT-5-Codex]                 local startIndex = 1
06323 [GPT-5-Codex]                 if #items > visibleCount then
06324 [GPT-5-Codex]                     local half = math.floor(visibleCount / 2)
06325 [GPT-5-Codex]                     startIndex = sel - half
06326 [GPT-5-Codex]                     if startIndex < 1 then startIndex = 1 end
06327 [GPT-5-Codex]                     local maxStart = #items - visibleCount + 1
06328 [GPT-5-Codex]                     if startIndex > maxStart then startIndex = maxStart end
06329 [GPT-5-Codex]                 end
06330 [GPT-5-Codex]                 local endIndex = math.min(#items, startIndex + visibleCount - 1)
06331 [GPT-5-Codex]                 local drawRow = 0
06332 [GPT-5-Codex]                 for i = startIndex, endIndex do
06333 [GPT-5-Codex]                     local item = items[i]
06334 [GPT-5-Codex]                     local y = 74 + drawRow * 16
06335 [GPT-5-Codex]                     local textColor = COLOR_LIGHT_GRAY
06336 [GPT-5-Codex]                     local label = "  " .. item
06337 [GPT-5-Codex]                     if i == sel then
06338 [GPT-5-Codex]                         textColor = COLOR_WHITE
06339 [GPT-5-Codex]                         label = "> " .. item
06340 [GPT-5-Codex]                     end
06341 [GPT-5-Codex]                     setFontCached(vmupro.text.FONT_TINY_6x8)
06342 [GPT-5-Codex]                     drawMenuText(label, 54, y + 2, textColor)
06343 [GPT-5-Codex]                     drawRow = drawRow + 1
06344 [GPT-5-Codex]                 end
06345 [GPT-5-Codex]                 setFontCached(vmupro.text.FONT_TINY_6x8)
06346 [GPT-5-Codex]                 drawMenuText("L/R ADJUST", 54, 222, COLOR_WHITE)
06347 [GPT-5-Codex]             else
06348 [GPT-5-Codex]                 drawMenuText("OPTIONS", 86, 44, COLOR_WHITE)
06349 [GPT-5-Codex]                 -- Options items
06350 [GPT-5-Codex]                 local soundText = "SOUND: " .. (soundEnabled and "ON" or "OFF")
06351 [GPT-5-Codex]                 local healthText = "HEALTH%: " .. (showHealthPercent and "ON" or "OFF")
06352 [GPT-5-Codex]                 local enemiesText = "ENEMIES: " .. (DEBUG_DISABLE_ENEMIES and "OFF" or "ON")
06353 [GPT-5-Codex]                 local propsText = "PROPS: " .. (DEBUG_DISABLE_PROPS and "OFF" or "ON")
06354 [GPT-5-Codex]                 local texturesText = "TEXTURES: " .. (DEBUG_DISABLE_WALL_TEXTURE and "OFF" or "ON")
06355 [GPT-5-Codex]                 local fpsText = "FPS: " .. (showFpsOverlay and "ON" or "OFF")
06356 [GPT-5-Codex]                 local resText = "RES: " .. (LOW_RES_MODE == "fast" and "FAST" or "QUALITY")
06357 [GPT-5-Codex]                 local minimapText = "MINIMAP: " .. (SHOW_MINIMAP and "ON" or "OFF")
06358 [GPT-5-Codex]                 local renderText = "RENDER: EXP-H LOCK"
06359 [GPT-5-Codex]                 local debugText = "DEBUG"
06360 [GPT-5-Codex]                 local optItems = {soundText, healthText, enemiesText, propsText, texturesText, fpsText, resText, minimapText, renderText, debugText, "BACK"}
06361 [GPT-5-Codex]                 for i, item in ipairs(optItems) do
06362 [GPT-5-Codex]                     local y = 70 + (i - 1) * 15
06363 [GPT-5-Codex]                     local textColor = COLOR_LIGHT_GRAY
06364 [GPT-5-Codex]                     local label = "  " .. item
06365 [GPT-5-Codex]                     if i == optionsSelection then
06366 [GPT-5-Codex]                         textColor = COLOR_WHITE
06367 [GPT-5-Codex]                         label = "> " .. item
06368 [GPT-5-Codex]                     end
06369 [GPT-5-Codex]                     setFontCached(vmupro.text.FONT_SMALL)
06370 [GPT-5-Codex]                     drawMenuText(label, 54, y + 1, textColor)
06371 [GPT-5-Codex]                 end
06372 [GPT-5-Codex]             end
06373 [GPT-5-Codex]         elseif inSaveMenu then
06374 [GPT-5-Codex]             drawUiPanel(32, 42, 208, 234, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
06375 [GPT-5-Codex]             drawUiPanel(40, 50, 200, 72, COLOR_MAROON, COLOR_WHITE)
06376 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_SMALL)
06377 [GPT-5-Codex]             drawMenuText("SAVE GAME", 72, 55, COLOR_WHITE)
06378 [GPT-5-Codex]             for i = 1, SAVE_SLOT_COUNT do
06379 [GPT-5-Codex]                 local y = 82 + (i - 1) * 48
06380 [GPT-5-Codex]                 local textColor = COLOR_LIGHT_GRAY
06381 [GPT-5-Codex]                 if i == saveMenuSelection then
06382 [GPT-5-Codex]                     drawUiPanel(40, y, 200, y + 40, COLOR_MAROON, COLOR_WHITE)
06383 [GPT-5-Codex]                     textColor = COLOR_WHITE
06384 [GPT-5-Codex]                 end
06385 [GPT-5-Codex]                 local line1, line2 = getSaveSlotSummary(i)
06386 [GPT-5-Codex]                 setFontCached(vmupro.text.FONT_SMALL)
06387 [GPT-5-Codex]                 drawMenuText(line1, 48, y + 5, textColor)
06388 [GPT-5-Codex]                 setFontCached(vmupro.text.FONT_TINY_6x8)
06389 [GPT-5-Codex]                 drawMenuText(line2, 48, y + 23, textColor)
06390 [GPT-5-Codex]             end
06391 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_TINY_6x8)
06392 [GPT-5-Codex]             if saveMenuMessage and saveMenuMessage ~= "" and saveMenuMessageTimer > 0 then
06393 [GPT-5-Codex]                 drawMenuText(saveMenuMessage, 48, 224, COLOR_WHITE)
06394 [GPT-5-Codex]             else
06395 [GPT-5-Codex]                 drawMenuText("A/MODE SAVE  B BACK", 48, 224, COLOR_WHITE)
06396 [GPT-5-Codex]             end
06397 [GPT-5-Codex]         else
06398 [GPT-5-Codex]             -- Main pause menu
06399 [GPT-5-Codex]             drawUiPanel(50, 60, 190, 225, COLOR_DARK_GRAY, COLOR_LIGHT_GRAY)
06400 [GPT-5-Codex]             drawUiPanel(55, 65, 185, 220, COLOR_DARK_GRAY, COLOR_GRAY)
06401 [GPT-5-Codex]             -- Title bar
06402 [GPT-5-Codex]             drawUiPanel(60, 70, 180, 92, COLOR_MAROON, COLOR_WHITE)
06403 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_SMALL)
06404 [GPT-5-Codex]             drawMenuText("PAUSED", 88, 75, COLOR_WHITE)
06405 [GPT-5-Codex]             -- Menu items
06406 [GPT-5-Codex]             local items = {"RESUME", "SAVE GAME", "OPTIONS", "RESTART", "MENU", "QUIT"}
06407 [GPT-5-Codex]             for i, item in ipairs(items) do
06408 [GPT-5-Codex]                 local y = 95 + (i - 1) * 20
06409 [GPT-5-Codex]                 local textColor = COLOR_LIGHT_GRAY
06410 [GPT-5-Codex]                 local label = "  " .. item
06411 [GPT-5-Codex]                 if i == menuSelection then
06412 [GPT-5-Codex]                     textColor = COLOR_WHITE
06413 [GPT-5-Codex]                     label = "> " .. item
06414 [GPT-5-Codex]                 end
06415 [GPT-5-Codex]                 setFontCached(vmupro.text.FONT_SMALL)
06416 [GPT-5-Codex]                 drawMenuText(label, 78, y + 2, textColor)
06417 [GPT-5-Codex]             end
06418 [GPT-5-Codex]         end
06419 [GPT-5-Codex]     end
06420 [GPT-5-Codex] 
06421 [GPT-5-Codex]     -- Draw health UI (potion with liquid)
06422 [GPT-5-Codex]     drawHealthUI()
06423 [GPT-5-Codex]     if not showMenu then
06424 [GPT-5-Codex]         drawEnemiesRemainingUI()
06425 [GPT-5-Codex]     end
06426 [GPT-5-Codex] 
06427 [GPT-5-Codex]     -- Draw current level indicator
06428 [GPT-5-Codex]                 setFontCached(vmupro.text.FONT_SMALL)
06429 [GPT-5-Codex]                 drawUiText(getLevelLabel(currentLevel), 6, 228, COLOR_WHITE, COLOR_BLACK)
06430 [GPT-5-Codex]                 if showFpsOverlay and lastFps and lastFps > 0 then
06431 [GPT-5-Codex]                     local fpsText = string.format("FPS %.1f", lastFps)
06432 [GPT-5-Codex]                     drawUiText(fpsText, 6, 214, COLOR_WHITE, COLOR_BLACK)
06433 [GPT-5-Codex]                 end
06434 [GPT-5-Codex]                 if DEBUG_PERF_MONITOR then
06435 [GPT-5-Codex]                     drawPerfMonitorOverlay()
06436 [GPT-5-Codex]                 end
06437 [GPT-5-Codex]                 if DEBUG_SHOW_BLOCK and lastBlockEvent and (frameCount - lastBlockEvent.frame) < 60 then
06438 [GPT-5-Codex]                     local pct = math.floor((lastBlockEvent.pct or 0) * 100 + 0.5)
06439 [GPT-5-Codex]                     local msg = "BLOCK " .. tostring(pct) .. "% (-" .. tostring(lastBlockEvent.amount or 0) .. ")"
06440 [GPT-5-Codex]                     drawUiText(msg, 6, 202, COLOR_WHITE, COLOR_BLACK)
06441 [GPT-5-Codex]                 end
06442 [GPT-5-Codex] 
06443 [GPT-5-Codex]     if levelBannerTimer > 0 then
06444 [GPT-5-Codex]                     local bannerText = "LEVEL " .. getLevelLabel(currentLevel)
06445 [GPT-5-Codex]         local textColor = COLOR_WHITE
06446 [GPT-5-Codex]         if levelBannerTimer < 50 then
06447 [GPT-5-Codex]             textColor = COLOR_DARK_GRAY
06448 [GPT-5-Codex]         elseif levelBannerTimer < 100 then
06449 [GPT-5-Codex]             textColor = COLOR_LIGHT_GRAY
06450 [GPT-5-Codex]         end
06451 [GPT-5-Codex]         setFontCached(vmupro.text.FONT_SMALL)
06452 [GPT-5-Codex]         drawUiText(bannerText, 170, 5, textColor, COLOR_BLACK)
06453 [GPT-5-Codex]     end
06454 [GPT-5-Codex] 
06455 [GPT-5-Codex]     -- Draw game over screen if player died
06456 [GPT-5-Codex]     if gameState == STATE_GAME_OVER then
06457 [GPT-5-Codex]         drawGameOver()
06458 [GPT-5-Codex]     end
06459 [GPT-5-Codex] 
06460 [GPT-5-Codex]     -- Draw win screen if player won
06461 [GPT-5-Codex]     if gameState == STATE_WIN then
06462 [GPT-5-Codex]         drawWinScreen()
06463 [GPT-5-Codex]     end
06464 [GPT-5-Codex] end
06465 [GPT-5-Codex] 
06466 [GPT-5-Codex] local function consumeAudioSteps(elapsedUs, audioAccumulatorUs)
06467 [GPT-5-Codex]     if not audioSystemActive or not soundEnabled then
06468 [GPT-5-Codex]         return 0.0, 0
06469 [GPT-5-Codex]     end
06470 [GPT-5-Codex] 
06471 [GPT-5-Codex]     local dt = elapsedUs or AUDIO_UPDATE_STEP_US
06472 [GPT-5-Codex]     if dt < 0 then
06473 [GPT-5-Codex]         dt = AUDIO_UPDATE_STEP_US
06474 [GPT-5-Codex]     end
06475 [GPT-5-Codex]     if dt > 250000 then
06476 [GPT-5-Codex]         dt = 250000
06477 [GPT-5-Codex]     end
06478 [GPT-5-Codex] 
06479 [GPT-5-Codex]     local acc = (audioAccumulatorUs or 0) + dt
06480 [GPT-5-Codex]     local maxBacklog = AUDIO_UPDATE_STEP_US * (AUDIO_UPDATE_MAX_BACKLOG_STEPS or 3)
06481 [GPT-5-Codex]     if acc > maxBacklog then
06482 [GPT-5-Codex]         acc = maxBacklog
06483 [GPT-5-Codex]     end
06484 [GPT-5-Codex] 
06485 [GPT-5-Codex]     local steps = 0
06486 [GPT-5-Codex]     while acc >= AUDIO_UPDATE_STEP_US and steps < (AUDIO_UPDATE_MAX_STEPS or 3) do
06487 [GPT-5-Codex]         vmupro.sound.update()
06488 [GPT-5-Codex]         acc = acc - AUDIO_UPDATE_STEP_US
06489 [GPT-5-Codex]         steps = steps + 1
06490 [GPT-5-Codex]     end
06491 [GPT-5-Codex] 
06492 [GPT-5-Codex]     return acc, steps
06493 [GPT-5-Codex] end
06494 [GPT-5-Codex] 
06495 [GPT-5-Codex] local function runSimulationStep()
06496 [GPT-5-Codex]     simTickCount = simTickCount + 1
06497 [GPT-5-Codex]     if saveMenuMessageTimer and saveMenuMessageTimer > 0 then
06498 [GPT-5-Codex]         saveMenuMessageTimer = saveMenuMessageTimer - 1
06499 [GPT-5-Codex]     end
06500 [GPT-5-Codex] 
06501 [GPT-5-Codex]     if gameState == STATE_PLAYING and not showMenu then
06502 [GPT-5-Codex]         if levelBannerTimer > 0 then
06503 [GPT-5-Codex]             levelBannerTimer = levelBannerTimer - 1
06504 [GPT-5-Codex]         end
06505 [GPT-5-Codex]         if isAttacking > 0 then
06506 [GPT-5-Codex]             isAttacking = isAttacking - 1
06507 [GPT-5-Codex]         end
06508 [GPT-5-Codex]         updateSoldiers()
06509 [GPT-5-Codex]         updateDeathAnimations()
06510 [GPT-5-Codex]         if not DEBUG_DISABLE_EFFECTS then
06511 [GPT-5-Codex]             updateBloodEffects()
06512 [GPT-5-Codex]         end
06513 [GPT-5-Codex]         checkHealthPickups()
06514 [GPT-5-Codex]     elseif gameState == STATE_LOADING then
06515 [GPT-5-Codex]         loadingTimer = loadingTimer - 1
06516 [GPT-5-Codex]         if loadingTimer <= 0 then
06517 [GPT-5-Codex]             if pendingLevelStart then
06518 [GPT-5-Codex]                 startLevel(pendingLevelStart)
06519 [GPT-5-Codex]                 pendingLevelStart = nil
06520 [GPT-5-Codex]             else
06521 [GPT-5-Codex]                 gameState = STATE_TITLE
06522 [GPT-5-Codex]             end
06523 [GPT-5-Codex]         end
06524 [GPT-5-Codex]     elseif gameState == STATE_WIN then
06525 [GPT-5-Codex]         if winBannerTimer > 0 then
06526 [GPT-5-Codex]             winBannerTimer = winBannerTimer - 1
06527 [GPT-5-Codex]         end
06528 [GPT-5-Codex]         if winCooldown > 0 then
06529 [GPT-5-Codex]             winCooldown = winCooldown - 1
06530 [GPT-5-Codex]         end
06531 [GPT-5-Codex]     end
06532 [GPT-5-Codex] end
06533 [GPT-5-Codex] 
06534 [GPT-5-Codex] local function consumeSimulationSteps(elapsedUs, simAccumulatorUs)
06535 [GPT-5-Codex]     if gameState ~= STATE_PLAYING and gameState ~= STATE_LOADING and gameState ~= STATE_WIN then
06536 [GPT-5-Codex]         return 0.0, 0
06537 [GPT-5-Codex]     end
06538 [GPT-5-Codex] 
06539 [GPT-5-Codex]     local dt = elapsedUs or SIM_STEP_US
06540 [GPT-5-Codex]     if dt < 0 then
06541 [GPT-5-Codex]         dt = SIM_STEP_US
06542 [GPT-5-Codex]     end
06543 [GPT-5-Codex]     if dt > 250000 then
06544 [GPT-5-Codex]         dt = 250000
06545 [GPT-5-Codex]     end
06546 [GPT-5-Codex] 
06547 [GPT-5-Codex]     local acc = (simAccumulatorUs or 0) + dt
06548 [GPT-5-Codex]     local maxBacklog = SIM_STEP_US * (SIM_MAX_BACKLOG_STEPS or 4)
06549 [GPT-5-Codex]     if acc > maxBacklog then
06550 [GPT-5-Codex]         acc = maxBacklog
06551 [GPT-5-Codex]     end
06552 [GPT-5-Codex] 
06553 [GPT-5-Codex]     local steps = 0
06554 [GPT-5-Codex]     while acc >= SIM_STEP_US and steps < (SIM_MAX_STEPS_PER_FRAME or 4) do
06555 [GPT-5-Codex]         runSimulationStep()
06556 [GPT-5-Codex]         acc = acc - SIM_STEP_US
06557 [GPT-5-Codex]         steps = steps + 1
06558 [GPT-5-Codex]         if gameState == STATE_TITLE then
06559 [GPT-5-Codex]             acc = 0.0
06560 [GPT-5-Codex]             break
06561 [GPT-5-Codex]         end
06562 [GPT-5-Codex]     end
06563 [GPT-5-Codex] 
06564 [GPT-5-Codex]     return acc, steps
06565 [GPT-5-Codex] end
06566 [GPT-5-Codex] 
06567 [GPT-5-Codex] 
06568 [GPT-5-Codex] function AppMain()
06569 [GPT-5-Codex]     applyRuntimeLogLevel()
06570 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "A AppMain enter")
06571 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen local=" .. tostring(drawTitleScreen))
06572 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen global=" .. tostring(_G and _G.drawTitleScreen))
06573 [GPT-5-Codex]     if drawTitleScreenImpl then
06574 [GPT-5-Codex]         drawTitleScreen = drawTitleScreenImpl
06575 [GPT-5-Codex]         logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen rebound in AppMain")
06576 [GPT-5-Codex]     end
06577 [GPT-5-Codex]     enterTitle()
06578 [GPT-5-Codex]     logBoot(vmupro.system.LOG_ERROR, "B enterTitle done")
06579 [GPT-5-Codex]     syncDoubleBufferForState()
06580 [GPT-5-Codex]     local bootLoopLogged = false
06581 [GPT-5-Codex]     local bootLogEvery = 300
06582 [GPT-5-Codex]     local fpsWindowStartUs = (vmupro.system and vmupro.system.getTimeUs and vmupro.system.getTimeUs()) or 0
06583 [GPT-5-Codex]     local fpsFrames = 0
06584 [GPT-5-Codex]     local lastLoopUs = fpsWindowStartUs
06585 [GPT-5-Codex]     local simAccumulatorUs = 0.0
06586 [GPT-5-Codex]     local audioAccumulatorUs = 0.0
06587 [GPT-5-Codex]     local simStepsThisFrame = 0
06588 [GPT-5-Codex]     local audioStepsThisFrame = 0
06589 [GPT-5-Codex] 
06590 [GPT-5-Codex]     local targetFrameUs = 33333
06591 [GPT-5-Codex]     while app_running do
06592 [GPT-5-Codex]         local frameStartUs = (vmupro.system and vmupro.system.getTimeUs and vmupro.system.getTimeUs()) or 0
06593 [GPT-5-Codex]         local elapsedUs = SIM_STEP_US
06594 [GPT-5-Codex]         if lastLoopUs and lastLoopUs > 0 and frameStartUs > 0 then
06595 [GPT-5-Codex]             elapsedUs = frameStartUs - lastLoopUs
06596 [GPT-5-Codex]             if elapsedUs < 0 then
06597 [GPT-5-Codex]                 elapsedUs = SIM_STEP_US
06598 [GPT-5-Codex]             end
06599 [GPT-5-Codex]         end
06600 [GPT-5-Codex]         if elapsedUs > 250000 then
06601 [GPT-5-Codex]             elapsedUs = 250000
06602 [GPT-5-Codex]         end
06603 [GPT-5-Codex]         lastLoopUs = frameStartUs
06604 [GPT-5-Codex]         if not bootLoopLogged then
06605 [GPT-5-Codex]             bootLoopLogged = true
06606 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B1 loop start")
06607 [GPT-5-Codex]         end
06608 [GPT-5-Codex]         local inputSampleStartUs = nil
06609 [GPT-5-Codex]         if DEBUG_PERF_MONITOR and vmupro and vmupro.system and vmupro.system.getTimeUs then
06610 [GPT-5-Codex]             local sampleEvery = PERF_MONITOR_SAMPLE_EVERY or 12
06611 [GPT-5-Codex]             if sampleEvery < 1 then sampleEvery = 1 end
06612 [GPT-5-Codex]             if ((frameCount + 1) % sampleEvery) == 0 then
06613 [GPT-5-Codex]                 inputSampleStartUs = vmupro.system.getTimeUs()
06614 [GPT-5-Codex]             end
06615 [GPT-5-Codex]         end
06616 [GPT-5-Codex]         vmupro.input.read()
06617 [GPT-5-Codex]         lockRendererMode()
06618 [GPT-5-Codex]         if enableBootLogs and gameState == STATE_TITLE and bootLoopLogged and (frameCount % bootLogEvery == 0) then
06619 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B2 after input.read")
06620 [GPT-5-Codex]         end
06621 [GPT-5-Codex]         frameCount = frameCount + 1
06622 [GPT-5-Codex]         perfMonitorBeginFrame()
06623 [GPT-5-Codex]         local perfSectionClock = nil
06624 [GPT-5-Codex]         if PERF_MONITOR_ACTIVE_SAMPLE then
06625 [GPT-5-Codex]             perfSectionClock = perfNowUs
06626 [GPT-5-Codex]         end
06627 [GPT-5-Codex]         if inputSampleStartUs and perfSectionClock then
06628 [GPT-5-Codex]             local inputSampleEndUs = perfSectionClock()
06629 [GPT-5-Codex]             if inputSampleEndUs and inputSampleEndUs >= inputSampleStartUs then
06630 [GPT-5-Codex]                 PERF_MONITOR_SAMPLE_INPUT_US = inputSampleEndUs - inputSampleStartUs
06631 [GPT-5-Codex]             end
06632 [GPT-5-Codex]         end
06633 [GPT-5-Codex]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
06634 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B2.1 after frameCount")
06635 [GPT-5-Codex]         end
06636 [GPT-5-Codex]         fpsFrames = fpsFrames + 1
06637 [GPT-5-Codex]         if enableBootLogs and gameState == STATE_PLAYING and (frameCount % 120) == 0 then
06638 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, string.format("LIFE state=%d px=%.2f py=%.2f", gameState, px or -1, py or -1))
06639 [GPT-5-Codex]         end
06640 [GPT-5-Codex]         if vmupro.system and vmupro.system.getTimeUs then
06641 [GPT-5-Codex]             local nowUs = vmupro.system.getTimeUs()
06642 [GPT-5-Codex]             if fpsWindowStartUs == 0 then
06643 [GPT-5-Codex]                 fpsWindowStartUs = nowUs
06644 [GPT-5-Codex]                 fpsFrames = 0
06645 [GPT-5-Codex]             elseif (nowUs - fpsWindowStartUs) >= 1000000 then
06646 [GPT-5-Codex]                 local elapsed = nowUs - fpsWindowStartUs
06647 [GPT-5-Codex]                 local fps = (fpsFrames * 1000000) / elapsed
06648 [GPT-5-Codex]                 lastFps = fps
06649 [GPT-5-Codex]                 if enablePerfLogs then
06650 [GPT-5-Codex]                     logPerf(string.format("FPS %.1f", fps))
06651 [GPT-5-Codex]                 end
06652 [GPT-5-Codex]                 fpsWindowStartUs = nowUs
06653 [GPT-5-Codex]                 fpsFrames = 0
06654 [GPT-5-Codex]             end
06655 [GPT-5-Codex]         end
06656 [GPT-5-Codex] 
06657 [GPT-5-Codex]         local audioSectionStartUs = perfSectionClock and perfSectionClock()
06658 [GPT-5-Codex]         audioAccumulatorUs, audioStepsThisFrame = consumeAudioSteps(elapsedUs, audioAccumulatorUs)
06659 [GPT-5-Codex]         if audioSectionStartUs and perfSectionClock then
06660 [GPT-5-Codex]             local audioSectionEndUs = perfSectionClock()
06661 [GPT-5-Codex]             if audioSectionEndUs and audioSectionEndUs >= audioSectionStartUs then
06662 [GPT-5-Codex]                 PERF_MONITOR_SAMPLE_AUDIO_US = PERF_MONITOR_SAMPLE_AUDIO_US + (audioSectionEndUs - audioSectionStartUs)
06663 [GPT-5-Codex]             end
06664 [GPT-5-Codex]         end
06665 [GPT-5-Codex]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
06666 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B2.2 after audio update steps=" .. tostring(audioStepsThisFrame))
06667 [GPT-5-Codex]         end
06668 [GPT-5-Codex] 
06669 [GPT-5-Codex]         local simSectionStartUs = perfSectionClock and perfSectionClock()
06670 [GPT-5-Codex]         if gameState == STATE_TITLE then
06671 [GPT-5-Codex]             updateTitleMusic()
06672 [GPT-5-Codex]             simAccumulatorUs = 0.0
06673 [GPT-5-Codex]             simStepsThisFrame = 0
06674 [GPT-5-Codex]         else
06675 [GPT-5-Codex]             simAccumulatorUs, simStepsThisFrame = consumeSimulationSteps(elapsedUs, simAccumulatorUs)
06676 [GPT-5-Codex]         end
06677 [GPT-5-Codex]         if simSectionStartUs and perfSectionClock then
06678 [GPT-5-Codex]             local simSectionEndUs = perfSectionClock()
06679 [GPT-5-Codex]             if simSectionEndUs and simSectionEndUs >= simSectionStartUs then
06680 [GPT-5-Codex]                 PERF_MONITOR_SAMPLE_SIM_US = PERF_MONITOR_SAMPLE_SIM_US + (simSectionEndUs - simSectionStartUs)
06681 [GPT-5-Codex]             end
06682 [GPT-5-Codex]         end
06683 [GPT-5-Codex] 
06684 [GPT-5-Codex]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
06685 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B2.3 after playing block")
06686 [GPT-5-Codex]         end
06687 [GPT-5-Codex] 
06688 [GPT-5-Codex]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
06689 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B2.4 after loading block")
06690 [GPT-5-Codex]         end
06691 [GPT-5-Codex] 
06692 [GPT-5-Codex]         if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
06693 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B2.5 before title/menu pcall")
06694 [GPT-5-Codex]         end
06695 [GPT-5-Codex]         local logicSectionStartUs = perfSectionClock and perfSectionClock()
06696 [GPT-5-Codex]         local okTitle, errTitle = pcall(function()
06697 [GPT-5-Codex]             if enableBootLogs and gameState == STATE_TITLE and (frameCount % bootLogEvery == 0) then
06698 [GPT-5-Codex]                 logBoot(vmupro.system.LOG_ERROR, "B2.6 inside title/menu pcall")
06699 [GPT-5-Codex]             end
06700 [GPT-5-Codex]             -- Title screen handling
06701 [GPT-5-Codex]             if gameState == STATE_TITLE then
06702 [GPT-5-Codex]                 local prevTitleSelection = titleSelection
06703 [GPT-5-Codex]                 local prevTitleInClassSelect = titleInClassSelect
06704 [GPT-5-Codex]                 local prevTitleClassSelection = titleClassSelection
06705 [GPT-5-Codex]                 local prevTitleInLoadMenu = titleInLoadMenu
06706 [GPT-5-Codex]                 local prevTitleLoadSelection = titleLoadSelection
06707 [GPT-5-Codex]                 local prevTitleInOptions = titleInOptions
06708 [GPT-5-Codex]                 local prevTitleOptionsSelection = titleOptionsSelection
06709 [GPT-5-Codex]                 local prevTitleDebugSelection = titleDebugSelection
06710 [GPT-5-Codex]                 local prevTitleDebugPage = titleDebugPage
06711 [GPT-5-Codex]                 local prevSelectedLevel = selectedLevel
06712 [GPT-5-Codex]                 local prevSoundEnabled = soundEnabled
06713 [GPT-5-Codex]                 local prevShowHealthPercent = showHealthPercent
06714 [GPT-5-Codex]                 local prevEnableBootLogs = enableBootLogs
06715 [GPT-5-Codex]                 local prevDisableEnemies = DEBUG_DISABLE_ENEMIES
06716 [GPT-5-Codex]                 local prevDisableTextures = DEBUG_DISABLE_WALL_TEXTURE
06717 [GPT-5-Codex]                 local prevDisableProps = DEBUG_DISABLE_PROPS
06718 [GPT-5-Codex]                 local prevShowFpsOverlay = showFpsOverlay
06719 [GPT-5-Codex]                 local prevLowResMode = LOW_RES_MODE
06720 [GPT-5-Codex]                 local prevShowMinimap = SHOW_MINIMAP
06721 [GPT-5-Codex]                 local prevRendererMode = RENDERER_MODE
06722 [GPT-5-Codex]                 local prevMipmapEnabled = WALL_MIPMAP_ENABLED
06723 [GPT-5-Codex]                 local prevRayPreset = RAY_PRESET_INDEX
06724 [GPT-5-Codex]                 local prevDrawDist = EXP_TEX_MAX_DIST
06725 [GPT-5-Codex]                 local prevMip1 = WALL_MIPMAP_DIST1
06726 [GPT-5-Codex]                 local prevMip2 = WALL_MIPMAP_DIST2
06727 [GPT-5-Codex]                 local prevMip3 = WALL_MIPMAP_DIST3
06728 [GPT-5-Codex]                 local prevMip4 = WALL_MIPMAP_DIST4
06729 [GPT-5-Codex]                 local prevFogStart = FOG_START
06730 [GPT-5-Codex]                 local prevFogEnd = FOG_END
06731 [GPT-5-Codex]                 local prevFogCutoff = FOG_TEX_CUTOFF
06732 [GPT-5-Codex]                 local prevFogColor = FOG_COLOR
06733 [GPT-5-Codex]                 local prevFogDither = FOG_DITHER_SIZE
06734 [GPT-5-Codex]                 local prevFarTexOff = FAR_TEX_OFF_DIST
06735 [GPT-5-Codex]                 local prevMipLodEnabled = MIP_LOD_ENABLED
06736 [GPT-5-Codex]                 local prevDisableRoofTexture = DEBUG_DISABLE_ROOF_TEXTURE
06737 [GPT-5-Codex]                 local prevBlockDbg = DEBUG_SHOW_BLOCK
06738 [GPT-5-Codex]                 local prevAudioMix = AUDIO_UPDATE_TARGET_HZ
06739 [GPT-5-Codex]                 local prevUseFixedRaycast = USE_FIXED_RAYCAST
06740 [GPT-5-Codex]                 local prevForceFloatRaycast = DEBUG_FORCE_FLOAT_RAYCAST
06741 [GPT-5-Codex]                 local prevPerfMonitor = DEBUG_PERF_MONITOR
06742 [GPT-5-Codex]                 local prevDoubleBuffer = DEBUG_DOUBLE_BUFFER
06743 [GPT-5-Codex]                 local prevWall1Format = WALL1_FORMAT_INDEX
06744 [GPT-5-Codex]                 local prevWallKey = WALL_FORCE_COLORKEY_OVERRIDE
06745 [GPT-5-Codex]                 local prevWallProjection = WALL_PROJECTION_MODE
06746 [GPT-5-Codex]                 if titleInClassSelect then
06747 [GPT-5-Codex]                     local classCount = #getClassOrder()
06748 [GPT-5-Codex]                     if classCount < 1 then classCount = 1 end
06749 [GPT-5-Codex]                     if classCount > 3 then classCount = 3 end
06750 [GPT-5-Codex]                     if titleClassSelection < 1 then titleClassSelection = 1 end
06751 [GPT-5-Codex]                     if titleClassSelection > classCount then titleClassSelection = classCount end
06752 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.LEFT) or vmupro.input.pressed(vmupro.input.UP) then
06753 [GPT-5-Codex]                         titleClassSelection = titleClassSelection - 1
06754 [GPT-5-Codex]                         if titleClassSelection < 1 then titleClassSelection = classCount end
06755 [GPT-5-Codex]                     end
06756 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.RIGHT) or vmupro.input.pressed(vmupro.input.DOWN) then
06757 [GPT-5-Codex]                         titleClassSelection = titleClassSelection + 1
06758 [GPT-5-Codex]                         if titleClassSelection > classCount then titleClassSelection = 1 end
06759 [GPT-5-Codex]                     end
06760 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
06761 [GPT-5-Codex]                         local classId = getClassIdForSelection(titleClassSelection)
06762 [GPT-5-Codex]                         setCurrentClassId(classId)
06763 [GPT-5-Codex]                         titleInClassSelect = false
06764 [GPT-5-Codex]                         local selectedEntry = LEVEL_SELECT_LIST[selectedLevel]
06765 [GPT-5-Codex]                         if selectedEntry then
06766 [GPT-5-Codex]                             beginLoadLevel(selectedEntry.id)
06767 [GPT-5-Codex]                         end
06768 [GPT-5-Codex]                     end
06769 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.B) or vmupro.input.pressed(vmupro.input.POWER) then
06770 [GPT-5-Codex]                         titleInClassSelect = false
06771 [GPT-5-Codex]                     end
06772 [GPT-5-Codex]                 elseif titleInLoadMenu then
06773 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.UP) or vmupro.input.pressed(vmupro.input.LEFT) then
06774 [GPT-5-Codex]                         titleLoadSelection = titleLoadSelection - 1
06775 [GPT-5-Codex]                         if titleLoadSelection < 1 then titleLoadSelection = SAVE_SLOT_COUNT end
06776 [GPT-5-Codex]                     end
06777 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.DOWN) or vmupro.input.pressed(vmupro.input.RIGHT) then
06778 [GPT-5-Codex]                         titleLoadSelection = titleLoadSelection + 1
06779 [GPT-5-Codex]                         if titleLoadSelection > SAVE_SLOT_COUNT then titleLoadSelection = 1 end
06780 [GPT-5-Codex]                     end
06781 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
06782 [GPT-5-Codex]                         loadGameFromSlot(titleLoadSelection)
06783 [GPT-5-Codex]                     end
06784 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.B) or vmupro.input.pressed(vmupro.input.POWER) then
06785 [GPT-5-Codex]                         titleInLoadMenu = false
06786 [GPT-5-Codex]                     end
06787 [GPT-5-Codex]                 elseif titleInOptions then
06788 [GPT-5-Codex]                     if titleInDebug then
06789 [GPT-5-Codex]                         local dbgCount = getDebugMenuItemCount()
06790 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.UP) then
06791 [GPT-5-Codex]                             titleDebugSelection = titleDebugSelection - 1
06792 [GPT-5-Codex]                             if titleDebugSelection < 1 then titleDebugSelection = dbgCount end
06793 [GPT-5-Codex]                         end
06794 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.DOWN) then
06795 [GPT-5-Codex]                             titleDebugSelection = titleDebugSelection + 1
06796 [GPT-5-Codex]                             if titleDebugSelection > dbgCount then titleDebugSelection = 1 end
06797 [GPT-5-Codex]                         end
06798 [GPT-5-Codex]                         local titleAdjustDelta = getDebugAdjustDelta()
06799 [GPT-5-Codex]                         if titleAdjustDelta ~= 0 then
06800 [GPT-5-Codex]                             adjustDebugMenuSelection(titleDebugSelection, titleAdjustDelta, false)
06801 [GPT-5-Codex]                         end
06802 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
06803 [GPT-5-Codex]                             if applyDebugMenuSelection(titleDebugSelection) then
06804 [GPT-5-Codex]                                 titleInDebug = false
06805 [GPT-5-Codex]                                 titleNeedsRedraw = true
06806 [GPT-5-Codex]                             end
06807 [GPT-5-Codex]                         end
06808 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.B) or vmupro.input.pressed(vmupro.input.POWER) then
06809 [GPT-5-Codex]                             titleInDebug = false
06810 [GPT-5-Codex]                             titleNeedsRedraw = true
06811 [GPT-5-Codex]                         end
06812 [GPT-5-Codex]                     else
06813 [GPT-5-Codex]                         -- Title options submenu
06814 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.UP) then
06815 [GPT-5-Codex]                             titleOptionsSelection = titleOptionsSelection - 1
06816 [GPT-5-Codex]                             if titleOptionsSelection < 1 then titleOptionsSelection = 6 end
06817 [GPT-5-Codex]                         end
06818 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.DOWN) then
06819 [GPT-5-Codex]                             titleOptionsSelection = titleOptionsSelection + 1
06820 [GPT-5-Codex]                             if titleOptionsSelection > 6 then titleOptionsSelection = 1 end
06821 [GPT-5-Codex]                         end
06822 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
06823 [GPT-5-Codex]                             if titleOptionsSelection == 1 then
06824 [GPT-5-Codex]                                 selectedLevel = selectedLevel + 1
06825 [GPT-5-Codex]                                 if selectedLevel > LEVEL_SELECT_COUNT then selectedLevel = 1 end
06826 [GPT-5-Codex]                             elseif titleOptionsSelection == 2 then
06827 [GPT-5-Codex]                                 soundEnabled = not soundEnabled
06828 [GPT-5-Codex]                                 if soundEnabled then
06829 [GPT-5-Codex]                                     startTitleMusic()
06830 [GPT-5-Codex]                                 else
06831 [GPT-5-Codex]                                     stopGameplaySamples()
06832 [GPT-5-Codex]                                     stopTitleMusic()
06833 [GPT-5-Codex]                                 end
06834 [GPT-5-Codex]                             elseif titleOptionsSelection == 3 then
06835 [GPT-5-Codex]                                 showHealthPercent = not showHealthPercent
06836 [GPT-5-Codex]                             elseif titleOptionsSelection == 4 then
06837 [GPT-5-Codex]                                 lockRendererMode()
06838 [GPT-5-Codex]                             elseif titleOptionsSelection == 5 then
06839 [GPT-5-Codex]                                 titleInDebug = true
06840 [GPT-5-Codex]                                 titleDebugSelection = 1
06841 [GPT-5-Codex]                                 titleNeedsRedraw = true
06842 [GPT-5-Codex]                             elseif titleOptionsSelection == 6 then
06843 [GPT-5-Codex]                                 titleInOptions = false  -- Back
06844 [GPT-5-Codex]                                 titleNeedsRedraw = true
06845 [GPT-5-Codex]                             end
06846 [GPT-5-Codex]                         end
06847 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.B) or vmupro.input.pressed(vmupro.input.POWER) then
06848 [GPT-5-Codex]                             titleInOptions = false
06849 [GPT-5-Codex]                             titleNeedsRedraw = true
06850 [GPT-5-Codex]                         end
06851 [GPT-5-Codex]                     end
06852 [GPT-5-Codex]                 else
06853 [GPT-5-Codex]                     -- Title main menu
06854 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.UP) then
06855 [GPT-5-Codex]                         titleSelection = titleSelection - 1
06856 [GPT-5-Codex]                         if titleSelection < 1 then titleSelection = 4 end
06857 [GPT-5-Codex]                     end
06858 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.DOWN) then
06859 [GPT-5-Codex]                         titleSelection = titleSelection + 1
06860 [GPT-5-Codex]                         if titleSelection > 4 then titleSelection = 1 end
06861 [GPT-5-Codex]                     end
06862 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
06863 [GPT-5-Codex]                         if titleSelection == 1 then
06864 [GPT-5-Codex]                             titleInClassSelect = true
06865 [GPT-5-Codex]                             titleClassSelection = getClassSelectionIndexForId(getCurrentClassId())
06866 [GPT-5-Codex]                         elseif titleSelection == 2 then
06867 [GPT-5-Codex]                             loadSaveSlotsFromDisk()
06868 [GPT-5-Codex]                             titleInLoadMenu = true
06869 [GPT-5-Codex]                             titleLoadSelection = 1
06870 [GPT-5-Codex]                         elseif titleSelection == 3 then
06871 [GPT-5-Codex]                             titleInOptions = true
06872 [GPT-5-Codex]                             titleOptionsSelection = 1
06873 [GPT-5-Codex]                         elseif titleSelection == 4 then
06874 [GPT-5-Codex]                             quitApp("title exit")
06875 [GPT-5-Codex]                         end
06876 [GPT-5-Codex]                     end
06877 [GPT-5-Codex]                 end
06878 [GPT-5-Codex]                 if prevTitleSelection ~= titleSelection
06879 [GPT-5-Codex]                     or prevTitleInClassSelect ~= titleInClassSelect
06880 [GPT-5-Codex]                     or prevTitleClassSelection ~= titleClassSelection
06881 [GPT-5-Codex]                     or prevTitleInLoadMenu ~= titleInLoadMenu
06882 [GPT-5-Codex]                     or prevTitleLoadSelection ~= titleLoadSelection
06883 [GPT-5-Codex]                     or prevTitleInOptions ~= titleInOptions
06884 [GPT-5-Codex]                     or prevTitleOptionsSelection ~= titleOptionsSelection
06885 [GPT-5-Codex]                     or prevTitleDebugSelection ~= titleDebugSelection
06886 [GPT-5-Codex]                     or prevTitleDebugPage ~= titleDebugPage
06887 [GPT-5-Codex]                     or prevSelectedLevel ~= selectedLevel
06888 [GPT-5-Codex]                     or prevSoundEnabled ~= soundEnabled
06889 [GPT-5-Codex]                     or prevShowHealthPercent ~= showHealthPercent
06890 [GPT-5-Codex]                     or prevEnableBootLogs ~= enableBootLogs
06891 [GPT-5-Codex]                     or prevDisableEnemies ~= DEBUG_DISABLE_ENEMIES
06892 [GPT-5-Codex]                     or prevDisableTextures ~= DEBUG_DISABLE_WALL_TEXTURE
06893 [GPT-5-Codex]                     or prevDisableProps ~= DEBUG_DISABLE_PROPS
06894 [GPT-5-Codex]                     or prevShowFpsOverlay ~= showFpsOverlay
06895 [GPT-5-Codex]                     or prevLowResMode ~= LOW_RES_MODE
06896 [GPT-5-Codex]                     or prevShowMinimap ~= SHOW_MINIMAP
06897 [GPT-5-Codex]                     or prevRendererMode ~= RENDERER_MODE
06898 [GPT-5-Codex]                     or prevMipmapEnabled ~= WALL_MIPMAP_ENABLED
06899 [GPT-5-Codex]                     or prevRayPreset ~= RAY_PRESET_INDEX
06900 [GPT-5-Codex]                     or prevDrawDist ~= EXP_TEX_MAX_DIST
06901 [GPT-5-Codex]                     or prevMip1 ~= WALL_MIPMAP_DIST1
06902 [GPT-5-Codex]                     or prevMip2 ~= WALL_MIPMAP_DIST2
06903 [GPT-5-Codex]                     or prevMip3 ~= WALL_MIPMAP_DIST3
06904 [GPT-5-Codex]                     or prevMip4 ~= WALL_MIPMAP_DIST4
06905 [GPT-5-Codex]                     or prevFogStart ~= FOG_START
06906 [GPT-5-Codex]                     or prevFogEnd ~= FOG_END
06907 [GPT-5-Codex]                     or prevFogCutoff ~= FOG_TEX_CUTOFF
06908 [GPT-5-Codex]                     or prevFogColor ~= FOG_COLOR
06909 [GPT-5-Codex]                     or prevFogDither ~= FOG_DITHER_SIZE
06910 [GPT-5-Codex]                     or prevFarTexOff ~= FAR_TEX_OFF_DIST
06911 [GPT-5-Codex]                     or prevMipLodEnabled ~= MIP_LOD_ENABLED
06912 [GPT-5-Codex]                     or prevDisableRoofTexture ~= DEBUG_DISABLE_ROOF_TEXTURE
06913 [GPT-5-Codex]                     or prevBlockDbg ~= DEBUG_SHOW_BLOCK
06914 [GPT-5-Codex]                     or prevAudioMix ~= AUDIO_UPDATE_TARGET_HZ
06915 [GPT-5-Codex]                     or prevUseFixedRaycast ~= USE_FIXED_RAYCAST
06916 [GPT-5-Codex]                     or prevForceFloatRaycast ~= DEBUG_FORCE_FLOAT_RAYCAST
06917 [GPT-5-Codex]                     or prevPerfMonitor ~= DEBUG_PERF_MONITOR
06918 [GPT-5-Codex]                     or prevDoubleBuffer ~= DEBUG_DOUBLE_BUFFER
06919 [GPT-5-Codex]                     or prevWall1Format ~= WALL1_FORMAT_INDEX
06920 [GPT-5-Codex]                     or prevWallKey ~= WALL_FORCE_COLORKEY_OVERRIDE
06921 [GPT-5-Codex]                     or prevWallProjection ~= WALL_PROJECTION_MODE then
06922 [GPT-5-Codex]                     titleNeedsRedraw = true
06923 [GPT-5-Codex]                 end
06924 [GPT-5-Codex]             -- Game over handling
06925 [GPT-5-Codex]             elseif gameState == STATE_GAME_OVER then
06926 [GPT-5-Codex]                 if vmupro.input.pressed(vmupro.input.UP) then
06927 [GPT-5-Codex]                     gameOverSelection = gameOverSelection - 1
06928 [GPT-5-Codex]                     if gameOverSelection < 1 then gameOverSelection = 3 end
06929 [GPT-5-Codex]                 end
06930 [GPT-5-Codex]                 if vmupro.input.pressed(vmupro.input.DOWN) then
06931 [GPT-5-Codex]                     gameOverSelection = gameOverSelection + 1
06932 [GPT-5-Codex]                     if gameOverSelection > 3 then gameOverSelection = 1 end
06933 [GPT-5-Codex]                 end
06934 [GPT-5-Codex]                 if vmupro.input.pressed(vmupro.input.A) or vmupro.input.pressed(vmupro.input.MODE) then
06935 [GPT-5-Codex]                     if gameOverSelection == 1 then
06936 [GPT-5-Codex]                         beginLoadLevel(currentLevel)  -- Restart
06937 [GPT-5-Codex]                     elseif gameOverSelection == 2 then
06938 [GPT-5-Codex]                         -- Return to title menu
06939 [GPT-5-Codex]                         enterTitle()
06940 [GPT-5-Codex]                         gameOverSelection = 1
06941 [GPT-5-Codex]                     else
06942 [GPT-5-Codex]                         quitApp("pause quit")  -- Quit
06943 [GPT-5-Codex]                     end
06944 [GPT-5-Codex]                 end
06945 [GPT-5-Codex]             -- Win screen handling
06946 [GPT-5-Codex]             elseif gameState == STATE_WIN then
06947 [GPT-5-Codex]                 if winCooldown <= 0 and vmupro.input.pressed(vmupro.input.A) then
06948 [GPT-5-Codex]                     -- Advance to next level if available, otherwise return to title menu
06949 [GPT-5-Codex]                     if currentLevel < MAX_LEVEL then
06950 [GPT-5-Codex]                         beginLoadLevel(currentLevel + 1)
06951 [GPT-5-Codex]                     else
06952 [GPT-5-Codex]                         enterTitle()
06953 [GPT-5-Codex]                     end
06954 [GPT-5-Codex]                 end
06955 [GPT-5-Codex]             -- Menu handling
06956 [GPT-5-Codex]             elseif showMenu then
06957 [GPT-5-Codex]                 if inOptionsMenu then
06958 [GPT-5-Codex]                     -- Options submenu
06959 [GPT-5-Codex]                     if inGameDebugMenu then
06960 [GPT-5-Codex]                         local dbgCount = getDebugMenuItemCount()
06961 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.UP) then
06962 [GPT-5-Codex]                             titleDebugSelection = titleDebugSelection - 1
06963 [GPT-5-Codex]                             if titleDebugSelection < 1 then titleDebugSelection = dbgCount end
06964 [GPT-5-Codex]                         end
06965 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.DOWN) then
06966 [GPT-5-Codex]                             titleDebugSelection = titleDebugSelection + 1
06967 [GPT-5-Codex]                             if titleDebugSelection > dbgCount then titleDebugSelection = 1 end
06968 [GPT-5-Codex]                         end
06969 [GPT-5-Codex]                         local gameAdjustDelta = getDebugAdjustDelta()
06970 [GPT-5-Codex]                         if gameAdjustDelta ~= 0 then
06971 [GPT-5-Codex]                             adjustDebugMenuSelection(titleDebugSelection, gameAdjustDelta, false)
06972 [GPT-5-Codex]                         end
06973 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
06974 [GPT-5-Codex]                             if applyDebugMenuSelection(titleDebugSelection) then
06975 [GPT-5-Codex]                                 inGameDebugMenu = false
06976 [GPT-5-Codex]                                 titleNeedsRedraw = true
06977 [GPT-5-Codex]                             end
06978 [GPT-5-Codex]                         end
06979 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.POWER) or vmupro.input.pressed(vmupro.input.B) then
06980 [GPT-5-Codex]                             inGameDebugMenu = false
06981 [GPT-5-Codex]                             titleNeedsRedraw = true
06982 [GPT-5-Codex]                         end
06983 [GPT-5-Codex]                     else
06984 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.UP) then
06985 [GPT-5-Codex]                             optionsSelection = optionsSelection - 1
06986 [GPT-5-Codex]                             if optionsSelection < 1 then optionsSelection = 11 end
06987 [GPT-5-Codex]                         end
06988 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.DOWN) then
06989 [GPT-5-Codex]                             optionsSelection = optionsSelection + 1
06990 [GPT-5-Codex]                             if optionsSelection > 11 then optionsSelection = 1 end
06991 [GPT-5-Codex]                         end
06992 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
06993 [GPT-5-Codex]                             if optionsSelection == 1 then
06994 [GPT-5-Codex]                                 soundEnabled = not soundEnabled  -- Toggle sound
06995 [GPT-5-Codex]                                 if not soundEnabled then
06996 [GPT-5-Codex]                                     stopGameplaySamples()
06997 [GPT-5-Codex]                                     stopTitleMusic()
06998 [GPT-5-Codex]                                 end
06999 [GPT-5-Codex]                             elseif optionsSelection == 2 then
07000 [GPT-5-Codex]                                 showHealthPercent = not showHealthPercent  -- Toggle health %
07001 [GPT-5-Codex]                             elseif optionsSelection == 3 then
07002 [GPT-5-Codex]                                 DEBUG_DISABLE_ENEMIES = not DEBUG_DISABLE_ENEMIES
07003 [GPT-5-Codex]                                 spriteOrderCache = {}
07004 [GPT-5-Codex]                                 spriteOrderCacheFrame = -999
07005 [GPT-5-Codex]                             elseif optionsSelection == 4 then
07006 [GPT-5-Codex]                                 DEBUG_DISABLE_PROPS = not DEBUG_DISABLE_PROPS
07007 [GPT-5-Codex]                                 spriteOrderCache = {}
07008 [GPT-5-Codex]                                 spriteOrderCacheFrame = -999
07009 [GPT-5-Codex]                             elseif optionsSelection == 5 then
07010 [GPT-5-Codex]                                 DEBUG_DISABLE_WALL_TEXTURE = not DEBUG_DISABLE_WALL_TEXTURE
07011 [GPT-5-Codex]                                 if DEBUG_DISABLE_WALL_TEXTURE then
07012 [GPT-5-Codex]                                     unloadWallTextures()
07013 [GPT-5-Codex]                                 else
07014 [GPT-5-Codex]                                     loadWallTextures()
07015 [GPT-5-Codex]                                 end
07016 [GPT-5-Codex]                             elseif optionsSelection == 6 then
07017 [GPT-5-Codex]                                 showFpsOverlay = not showFpsOverlay
07018 [GPT-5-Codex]                             elseif optionsSelection == 7 then
07019 [GPT-5-Codex]                                 if LOW_RES_MODE == "fast" then
07020 [GPT-5-Codex]                                     LOW_RES_MODE = "quality"
07021 [GPT-5-Codex]                                 else
07022 [GPT-5-Codex]                                     LOW_RES_MODE = "fast"
07023 [GPT-5-Codex]                                 end
07024 [GPT-5-Codex]                             elseif optionsSelection == 8 then
07025 [GPT-5-Codex]                                 SHOW_MINIMAP = not SHOW_MINIMAP
07026 [GPT-5-Codex]                             elseif optionsSelection == 9 then
07027 [GPT-5-Codex]                                 lockRendererMode()
07028 [GPT-5-Codex]                             elseif optionsSelection == 10 then
07029 [GPT-5-Codex]                                 inGameDebugMenu = true
07030 [GPT-5-Codex]                                 titleDebugSelection = 1
07031 [GPT-5-Codex]                             elseif optionsSelection == 11 then
07032 [GPT-5-Codex]                                 inOptionsMenu = false  -- Back to main menu
07033 [GPT-5-Codex]                             end
07034 [GPT-5-Codex]                         end
07035 [GPT-5-Codex]                         if vmupro.input.pressed(vmupro.input.POWER) or vmupro.input.pressed(vmupro.input.B) then
07036 [GPT-5-Codex]                             inOptionsMenu = false  -- Back to main menu
07037 [GPT-5-Codex]                         end
07038 [GPT-5-Codex]                     end
07039 [GPT-5-Codex]                 elseif inSaveMenu then
07040 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.UP) then
07041 [GPT-5-Codex]                         saveMenuSelection = saveMenuSelection - 1
07042 [GPT-5-Codex]                         if saveMenuSelection < 1 then saveMenuSelection = SAVE_SLOT_COUNT end
07043 [GPT-5-Codex]                     end
07044 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.DOWN) then
07045 [GPT-5-Codex]                         saveMenuSelection = saveMenuSelection + 1
07046 [GPT-5-Codex]                         if saveMenuSelection > SAVE_SLOT_COUNT then saveMenuSelection = 1 end
07047 [GPT-5-Codex]                     end
07048 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
07049 [GPT-5-Codex]                         local okSave = false
07050 [GPT-5-Codex]                         okSave, _ = saveGameToSlot(saveMenuSelection)
07051 [GPT-5-Codex]                         if okSave then
07052 [GPT-5-Codex]                             saveMenuMessage = "SAVED TO SLOT " .. tostring(saveMenuSelection)
07053 [GPT-5-Codex]                         else
07054 [GPT-5-Codex]                             saveMenuMessage = "SAVE FAILED"
07055 [GPT-5-Codex]                         end
07056 [GPT-5-Codex]                         saveMenuMessageTimer = 90
07057 [GPT-5-Codex]                     end
07058 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.POWER) or vmupro.input.pressed(vmupro.input.B) then
07059 [GPT-5-Codex]                         inSaveMenu = false
07060 [GPT-5-Codex]                         saveMenuMessage = ""
07061 [GPT-5-Codex]                         saveMenuMessageTimer = 0
07062 [GPT-5-Codex]                     end
07063 [GPT-5-Codex]                 else
07064 [GPT-5-Codex]                     -- Main pause menu
07065 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.UP) then
07066 [GPT-5-Codex]                         menuSelection = menuSelection - 1
07067 [GPT-5-Codex]                         if menuSelection < 1 then menuSelection = 6 end
07068 [GPT-5-Codex]                     end
07069 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.DOWN) then
07070 [GPT-5-Codex]                         menuSelection = menuSelection + 1
07071 [GPT-5-Codex]                         if menuSelection > 6 then menuSelection = 1 end
07072 [GPT-5-Codex]                     end
07073 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.MODE) or vmupro.input.pressed(vmupro.input.A) then
07074 [GPT-5-Codex]                         if menuSelection == 1 then
07075 [GPT-5-Codex]                             showMenu = false  -- Resume
07076 [GPT-5-Codex]                         elseif menuSelection == 2 then
07077 [GPT-5-Codex]                             inSaveMenu = true
07078 [GPT-5-Codex]                             saveMenuSelection = 1
07079 [GPT-5-Codex]                             saveMenuMessage = ""
07080 [GPT-5-Codex]                             saveMenuMessageTimer = 0
07081 [GPT-5-Codex]                         elseif menuSelection == 3 then
07082 [GPT-5-Codex]                             inOptionsMenu = true  -- Enter options
07083 [GPT-5-Codex]                             optionsSelection = 1
07084 [GPT-5-Codex]                             inGameDebugMenu = false
07085 [GPT-5-Codex]                         elseif menuSelection == 4 then
07086 [GPT-5-Codex]                             -- Reset position and health
07087 [GPT-5-Codex]                             px, py, pdir = 2.5, 2.5, 0
07088 [GPT-5-Codex]                             lastSafeWallX = px
07089 [GPT-5-Codex]                             lastSafeWallY = py
07090 [GPT-5-Codex]                             playerHealth = MAX_HEALTH
07091 [GPT-5-Codex]                             showMenu = false
07092 [GPT-5-Codex]                         elseif menuSelection == 5 then
07093 [GPT-5-Codex]                             -- Return to title menu
07094 [GPT-5-Codex]                             showMenu = false
07095 [GPT-5-Codex]                             enterTitle()
07096 [GPT-5-Codex]                         elseif menuSelection == 6 then
07097 [GPT-5-Codex]                             quitApp("game over quit")  -- Quit
07098 [GPT-5-Codex]                         end
07099 [GPT-5-Codex]                     end
07100 [GPT-5-Codex]                     if vmupro.input.pressed(vmupro.input.POWER) then
07101 [GPT-5-Codex]                         showMenu = false  -- Close menu
07102 [GPT-5-Codex]                     end
07103 [GPT-5-Codex]                 end
07104 [GPT-5-Codex]             else
07105 [GPT-5-Codex]                 -- Normal gameplay controls
07106 [GPT-5-Codex]                 local controlSteps = simStepsThisFrame or 0
07107 [GPT-5-Codex]                 if controlSteps > 0 then
07108 [GPT-5-Codex]                     local moveStep = PLAYER_MOVE_SPEED_PER_SEC / SIM_TARGET_HZ
07109 [GPT-5-Codex]                     local strafeStep = PLAYER_STRAFE_SPEED_PER_SEC / SIM_TARGET_HZ
07110 [GPT-5-Codex]                     local turnPerStep = PLAYER_TURN_STEPS_PER_SEC / SIM_TARGET_HZ
07111 [GPT-5-Codex]                     local heldLeft = vmupro.input.held(vmupro.input.LEFT)
07112 [GPT-5-Codex]                     local heldRight = vmupro.input.held(vmupro.input.RIGHT)
07113 [GPT-5-Codex]                     local heldMode = vmupro.input.held(vmupro.input.MODE)
07114 [GPT-5-Codex]                     local heldUp = vmupro.input.held(vmupro.input.UP)
07115 [GPT-5-Codex]                     local heldDown = vmupro.input.held(vmupro.input.DOWN)
07116 [GPT-5-Codex]                     local heldA = vmupro.input.held(vmupro.input.A)
07117 [GPT-5-Codex]                     local heldB = vmupro.input.held(vmupro.input.B)
07118 [GPT-5-Codex]                     local pressedUp = vmupro.input.pressed(vmupro.input.UP)
07119 [GPT-5-Codex]                     local pressedPower = vmupro.input.pressed(vmupro.input.POWER)
07120 [GPT-5-Codex]                     local attackRange = PLAYER_ATTACK_RANGE or 0
07121 [GPT-5-Codex]                     local attackRangeSq = attackRange * attackRange
07122 [GPT-5-Codex]                     for simStep = 1, controlSteps do
07123 [GPT-5-Codex]                         if showMenu then break end
07124 [GPT-5-Codex] 
07125 [GPT-5-Codex]                         local turnInput = 0
07126 [GPT-5-Codex]                         if heldLeft then
07127 [GPT-5-Codex]                             turnInput = turnInput - 1
07128 [GPT-5-Codex]                         end
07129 [GPT-5-Codex]                         if heldRight then
07130 [GPT-5-Codex]                             turnInput = turnInput + 1
07131 [GPT-5-Codex]                         end
07132 [GPT-5-Codex]                         if turnInput ~= 0 then
07133 [GPT-5-Codex]                             turnStepAccumulator = turnStepAccumulator + (turnInput * turnPerStep)
07134 [GPT-5-Codex]                         end
07135 [GPT-5-Codex]                         while turnStepAccumulator <= -1.0 do
07136 [GPT-5-Codex]                             pdir = pdir - 1
07137 [GPT-5-Codex]                             if pdir < 0 then pdir = pdir + 64 end
07138 [GPT-5-Codex]                             turnStepAccumulator = turnStepAccumulator + 1.0
07139 [GPT-5-Codex]                         end
07140 [GPT-5-Codex]                         while turnStepAccumulator >= 1.0 do
07141 [GPT-5-Codex]                             pdir = pdir + 1
07142 [GPT-5-Codex]                             if pdir >= 64 then pdir = pdir - 64 end
07143 [GPT-5-Codex]                             turnStepAccumulator = turnStepAccumulator - 1.0
07144 [GPT-5-Codex]                         end
07145 [GPT-5-Codex] 
07146 [GPT-5-Codex]                         local idx = pdir % 64
07147 [GPT-5-Codex]                         local dx = cosTable[idx] * moveStep
07148 [GPT-5-Codex]                         local dy = sinTable[idx] * moveStep
07149 [GPT-5-Codex]                         local strafe_idx = (pdir + 16) % 64  -- 90 degrees right
07150 [GPT-5-Codex]                         local sdx = cosTable[strafe_idx] * strafeStep
07151 [GPT-5-Codex]                         local sdy = sinTable[strafe_idx] * strafeStep
07152 [GPT-5-Codex] 
07153 [GPT-5-Codex]                         local modeHeld = heldMode
07154 [GPT-5-Codex]                         local wasBlocking = isBlocking
07155 [GPT-5-Codex] 
07156 [GPT-5-Codex]                         if modeHeld then
07157 [GPT-5-Codex]                             if simStep == 1 and pressedUp and isAttacking == 0 then
07158 [GPT-5-Codex]                                 local attackFrames = #swordAttack
07159 [GPT-5-Codex]                                 attackTotalFrames = 9
07160 [GPT-5-Codex]                                 if attackFrames == 0 then
07161 [GPT-5-Codex]                                     attackTotalFrames = 10
07162 [GPT-5-Codex]                                 end
07163 [GPT-5-Codex]                                 isAttacking = attackTotalFrames
07164 [GPT-5-Codex] 
07165 [GPT-5-Codex]                                 local hitSomething = false
07166 [GPT-5-Codex]                                 for i = 1, #sprites do
07167 [GPT-5-Codex]                                     local s = sprites[i]
07168 [GPT-5-Codex]                                     if s.t == 5 and s.alive then
07169 [GPT-5-Codex]                                         local sdxHit = s.x - px
07170 [GPT-5-Codex]                                         local sdyHit = s.y - py
07171 [GPT-5-Codex]                                         local distSq = sdxHit * sdxHit + sdyHit * sdyHit
07172 [GPT-5-Codex]                                         if distSq < attackRangeSq then
07173 [GPT-5-Codex]                                             s.hp = s.hp - PLAYER_DAMAGE
07174 [GPT-5-Codex]                                             if not hitSomething then
07175 [GPT-5-Codex]                                                 hitSomething = true
07176 [GPT-5-Codex]                                                 if soundEnabled and swordHitSample then
07177 [GPT-5-Codex]                                                     vmupro.sound.sample.stop(swordHitSample)
07178 [GPT-5-Codex]                                                     vmupro.sound.sample.play(swordHitSample)
07179 [GPT-5-Codex]                                                     if enableBootLogs then safeLog("INFO", "Play sample: sword_swing_connect") end
07180 [GPT-5-Codex]                                                 end
07181 [GPT-5-Codex]                                             end
07182 [GPT-5-Codex]                                             if s.hp <= 0 then
07183 [GPT-5-Codex]                                                 killSoldier(s)
07184 [GPT-5-Codex]                                             end
07185 [GPT-5-Codex]                                         end
07186 [GPT-5-Codex]                                     end
07187 [GPT-5-Codex]                                 end
07188 [GPT-5-Codex]                                 if soundEnabled and (not hitSomething) and swordMissSample then
07189 [GPT-5-Codex]                                     vmupro.sound.sample.stop(swordMissSample)
07190 [GPT-5-Codex]                                     vmupro.sound.sample.play(swordMissSample)
07191 [GPT-5-Codex]                                     if enableBootLogs then safeLog("INFO", "Play sample: sword_miss") end
07192 [GPT-5-Codex]                                 end
07193 [GPT-5-Codex]                             end
07194 [GPT-5-Codex] 
07195 [GPT-5-Codex]                             isBlocking = heldDown
07196 [GPT-5-Codex]                         else
07197 [GPT-5-Codex]                             isBlocking = false
07198 [GPT-5-Codex] 
07199 [GPT-5-Codex]                             if heldUp then
07200 [GPT-5-Codex]                                 movePlayerWithSlide(dx, dy)
07201 [GPT-5-Codex]                             end
07202 [GPT-5-Codex] 
07203 [GPT-5-Codex]                             if heldDown then
07204 [GPT-5-Codex]                                 movePlayerWithSlide(-dx, -dy)
07205 [GPT-5-Codex]                             end
07206 [GPT-5-Codex] 
07207 [GPT-5-Codex]                         end
07208 [GPT-5-Codex] 
07209 [GPT-5-Codex]                         if isBlocking and not wasBlocking then
07210 [GPT-5-Codex]                             blockStartFrame = simTickCount
07211 [GPT-5-Codex]                         end
07212 [GPT-5-Codex]                         if isBlocking then
07213 [GPT-5-Codex]                             if blockAnim < (BLOCK_ANIM_FRAMES or 8) then
07214 [GPT-5-Codex]                                 blockAnim = blockAnim + 1
07215 [GPT-5-Codex]                             end
07216 [GPT-5-Codex]                         else
07217 [GPT-5-Codex]                             if blockAnim > 0 then
07218 [GPT-5-Codex]                                 blockAnim = blockAnim - 1
07219 [GPT-5-Codex]                             end
07220 [GPT-5-Codex]                         end
07221 [GPT-5-Codex] 
07222 [GPT-5-Codex]                         if heldA then
07223 [GPT-5-Codex]                             movePlayerWithSlide(-sdx, -sdy)
07224 [GPT-5-Codex]                         end
07225 [GPT-5-Codex] 
07226 [GPT-5-Codex]                         if heldB then
07227 [GPT-5-Codex]                             movePlayerWithSlide(sdx, sdy)
07228 [GPT-5-Codex]                         end
07229 [GPT-5-Codex] 
07230 [GPT-5-Codex]                         if simStep == 1 and pressedPower then
07231 [GPT-5-Codex]                             showMenu = true
07232 [GPT-5-Codex]                             menuSelection = 1
07233 [GPT-5-Codex]                             inOptionsMenu = false
07234 [GPT-5-Codex]                             inGameDebugMenu = false
07235 [GPT-5-Codex]                             inSaveMenu = false
07236 [GPT-5-Codex]                             saveMenuSelection = 1
07237 [GPT-5-Codex]                             saveMenuMessage = ""
07238 [GPT-5-Codex]                             saveMenuMessageTimer = 0
07239 [GPT-5-Codex]                             break
07240 [GPT-5-Codex]                         end
07241 [GPT-5-Codex]                     end
07242 [GPT-5-Codex]                 end
07243 [GPT-5-Codex]             end
07244 [GPT-5-Codex]         end)
07245 [GPT-5-Codex]         if logicSectionStartUs and perfSectionClock then
07246 [GPT-5-Codex]             local logicSectionEndUs = perfSectionClock()
07247 [GPT-5-Codex]             if logicSectionEndUs and logicSectionEndUs >= logicSectionStartUs then
07248 [GPT-5-Codex]                 PERF_MONITOR_SAMPLE_LOGIC_US = PERF_MONITOR_SAMPLE_LOGIC_US + (logicSectionEndUs - logicSectionStartUs)
07249 [GPT-5-Codex]             end
07250 [GPT-5-Codex]         end
07251 [GPT-5-Codex]         if (frameCount % bootLogEvery == 0) then
07252 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "B2.7 after title/menu pcall ok=" .. tostring(okTitle))
07253 [GPT-5-Codex]         end
07254 [GPT-5-Codex]         if not okTitle then
07255 [GPT-5-Codex]             logBoot(vmupro.system.LOG_ERROR, "title/menu error: " .. tostring(errTitle))
07256 [GPT-5-Codex]             quitApp("title/menu error: " .. tostring(errTitle))
07257 [GPT-5-Codex]         end
07258 [GPT-5-Codex] 
07259 [GPT-5-Codex]         -- Keep DBUF policy state-aware so title rendering never flips between stale buffers.
07260 [GPT-5-Codex]         syncDoubleBufferForState()
07261 [GPT-5-Codex] 
07262 [GPT-5-Codex]         -- Render based on game state
07263 [GPT-5-Codex]         local renderSectionStartUs = perfSectionClock and perfSectionClock()
07264 [GPT-5-Codex]         if gameState == STATE_LOADING then
07265 [GPT-5-Codex]             if loadingTimer == loadingMax then
07266 [GPT-5-Codex]                 loadingLog("LOAD render loading screen frame1")
07267 [GPT-5-Codex]             end
07268 [GPT-5-Codex]             vmupro.graphics.clear(COLOR_BLACK)
07269 [GPT-5-Codex]             vmupro.graphics.drawFillRect(40, 105, 200, 135, COLOR_DARK_GRAY)
07270 [GPT-5-Codex]             vmupro.graphics.drawFillRect(45, 110, 195, 130, COLOR_BLACK)
07271 [GPT-5-Codex]             local progress = 1.0 - (loadingTimer / loadingMax)
07272 [GPT-5-Codex]             if progress < 0 then progress = 0 end
07273 [GPT-5-Codex]             if progress > 1 then progress = 1 end
07274 [GPT-5-Codex]             local barW = math.floor(146 * progress)
07275 [GPT-5-Codex]             vmupro.graphics.drawFillRect(48, 113, 48 + barW, 127, COLOR_MAROON)
07276 [GPT-5-Codex]             setFontCached(vmupro.text.FONT_SMALL)
07277 [GPT-5-Codex]             drawUiText("LOADING", 95, 90, COLOR_WHITE, COLOR_BLACK)
07278 [GPT-5-Codex]         elseif gameState == STATE_TITLE then
07279 [GPT-5-Codex]             if titleNeedsRedraw then
07280 [GPT-5-Codex]                 logBoot(vmupro.system.LOG_ERROR, "B3 before drawTitleScreen")
07281 [GPT-5-Codex]                 local okTitleDraw, errTitleDraw = pcall(function()
07282 [GPT-5-Codex]                     if drawTitleScreen then
07283 [GPT-5-Codex]                         drawTitleScreen()
07284 [GPT-5-Codex]                     else
07285 [GPT-5-Codex]                         error("drawTitleScreen missing")
07286 [GPT-5-Codex]                     end
07287 [GPT-5-Codex]                 end)
07288 [GPT-5-Codex]                 if not okTitleDraw then
07289 [GPT-5-Codex]                     logBoot(vmupro.system.LOG_ERROR, "drawTitleScreen error: " .. tostring(errTitleDraw))
07290 [GPT-5-Codex]                     quitApp("drawTitleScreen error: " .. tostring(errTitleDraw))
07291 [GPT-5-Codex]                 end
07292 [GPT-5-Codex]                 titleNeedsRedraw = false
07293 [GPT-5-Codex]             end
07294 [GPT-5-Codex]         else
07295 [GPT-5-Codex]             local okRender, errRender = pcall(renderGameFrame)
07296 [GPT-5-Codex]             if not okRender then
07297 [GPT-5-Codex]                 logBoot(vmupro.system.LOG_ERROR, 'render error: ' .. tostring(errRender))
07298 [GPT-5-Codex]                 quitApp("render error: " .. tostring(errRender))
07299 [GPT-5-Codex]             end
07300 [GPT-5-Codex]         end  -- End of game rendering (else branch of title screen check)
07301 [GPT-5-Codex]         if renderSectionStartUs and perfSectionClock then
07302 [GPT-5-Codex]             local renderSectionEndUs = perfSectionClock()
07303 [GPT-5-Codex]             if renderSectionEndUs and renderSectionEndUs >= renderSectionStartUs then
07304 [GPT-5-Codex]                 PERF_MONITOR_SAMPLE_RENDER_US = PERF_MONITOR_SAMPLE_RENDER_US + (renderSectionEndUs - renderSectionStartUs)
07305 [GPT-5-Codex]             end
07306 [GPT-5-Codex]         end
07307 [GPT-5-Codex] 
07308 [GPT-5-Codex]         ::render_only::
07309 [GPT-5-Codex]         local presentSectionStartUs = perfSectionClock and perfSectionClock()
07310 [GPT-5-Codex]         presentFrame()
07311 [GPT-5-Codex]         if presentSectionStartUs and perfSectionClock then
07312 [GPT-5-Codex]             local presentSectionEndUs = perfSectionClock()
07313 [GPT-5-Codex]             if presentSectionEndUs and presentSectionEndUs >= presentSectionStartUs then
07314 [GPT-5-Codex]                 PERF_MONITOR_SAMPLE_PRESENT_US = PERF_MONITOR_SAMPLE_PRESENT_US + (presentSectionEndUs - presentSectionStartUs)
07315 [GPT-5-Codex]             end
07316 [GPT-5-Codex]         end
07317 [GPT-5-Codex]         if gameState == STATE_TITLE then
07318 [GPT-5-Codex]             targetFrameUs = 16667
07319 [GPT-5-Codex]         else
07320 [GPT-5-Codex]             if FPS_TARGET_MODE == "uncapped" then
07321 [GPT-5-Codex]                 targetFrameUs = 0
07322 [GPT-5-Codex]             elseif FPS_TARGET_MODE == "60" then
07323 [GPT-5-Codex]                 targetFrameUs = 16667
07324 [GPT-5-Codex]             elseif FPS_TARGET_MODE == "45" then
07325 [GPT-5-Codex]                 targetFrameUs = 22222
07326 [GPT-5-Codex]             elseif FPS_TARGET_MODE == "30" then
07327 [GPT-5-Codex]                 targetFrameUs = 33333
07328 [GPT-5-Codex]             elseif FPS_TARGET_MODE == "24" then
07329 [GPT-5-Codex]                 targetFrameUs = 41667
07330 [GPT-5-Codex]             else
07331 [GPT-5-Codex]                 targetFrameUs = 33333
07332 [GPT-5-Codex]             end
07333 [GPT-5-Codex]         end
07334 [GPT-5-Codex]         if vmupro.system and vmupro.system.getTimeUs then
07335 [GPT-5-Codex]             local frameEndUs = vmupro.system.getTimeUs()
07336 [GPT-5-Codex]             if frameStartUs > 0 and frameEndUs > frameStartUs then
07337 [GPT-5-Codex]                 local cpuElapsedUs = frameEndUs - frameStartUs
07338 [GPT-5-Codex]                 local remainingUs = targetFrameUs - cpuElapsedUs
07339 [GPT-5-Codex]                 if remainingUs > 0 and vmupro.system.delayMs then
07340 [GPT-5-Codex]                     local sleepSectionStartUs = perfSectionClock and perfSectionClock()
07341 [GPT-5-Codex]                     vmupro.system.delayMs(math.floor(remainingUs / 1000))
07342 [GPT-5-Codex]                     if sleepSectionStartUs and perfSectionClock then
07343 [GPT-5-Codex]                         local sleepSectionEndUs = perfSectionClock()
07344 [GPT-5-Codex]                         if sleepSectionEndUs and sleepSectionEndUs >= sleepSectionStartUs then
07345 [GPT-5-Codex]                             PERF_MONITOR_SAMPLE_SLEEP_US = PERF_MONITOR_SAMPLE_SLEEP_US + (sleepSectionEndUs - sleepSectionStartUs)
07346 [GPT-5-Codex]                         end
07347 [GPT-5-Codex]                     end
07348 [GPT-5-Codex]                 end
07349 [GPT-5-Codex]                 local perfNowUsAfterSleep = vmupro.system.getTimeUs()
07350 [GPT-5-Codex]                 perfMonitorEndFrame(cpuElapsedUs, perfNowUsAfterSleep)
07351 [GPT-5-Codex]             end
07352 [GPT-5-Codex]         end
07353 [GPT-5-Codex]     end
07354 [GPT-5-Codex] 
07355 [GPT-5-Codex]     -- Cleanup assets
07356 [GPT-5-Codex]     applyDoubleBufferMode(false)
07357 [GPT-5-Codex]     unloadLevelAudio()
07358 [GPT-5-Codex]     unloadLevelSprites()
07359 [GPT-5-Codex]     unloadMenuSprites()
07360 [GPT-5-Codex] 
07361 [GPT-5-Codex]     return 0
07362 [GPT-5-Codex] end
